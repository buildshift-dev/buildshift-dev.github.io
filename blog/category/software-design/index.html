
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Full Stack Developer specializing in AWS Serverless, Python, and modern development workflows">
      
      
        <meta name="author" content="buildshift.dev">
      
      
        <link rel="canonical" href="https://buildshift.dev/blog/category/software-design/">
      
      
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/images/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Software Design - buildshift.dev</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/css/buildshift.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-4SV8ZKYLT1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-4SV8ZKYLT1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-4SV8ZKYLT1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Fixed banner styling -->
  <style>
    body { padding-top: 40px !important; }
    .md-header { top: 40px !important; }
    .md-tabs { top: 40px !important; }
  </style>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#software-design" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
  <!-- Under Construction Announcement -->
  <div style="background: #000000; text-align: center; padding: 8px 0; position: fixed; top: 0; left: 0; right: 0; z-index: 9999; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 14px; font-weight: 500; color: #ffa500;">
      <i class="fas fa-hard-hat"></i>
      <span>...Under Construction...</span>
    </div>
  </div>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="buildshift.dev" class="md-header__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            buildshift.dev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Software Design
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link">
        
  
  
    
  
  buildshift.dev Blog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="buildshift.dev" class="md-nav__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    buildshift.dev
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    buildshift.dev Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="software-design">Software Design</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-08-02 19:55:00-04:00">Aug 2, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../architecture-evolution/" class="md-meta__link">Architecture Evolution</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="./" class="md-meta__link">Software Design</a></li>
        
        
          
          <li class="md-meta__item">
            
              20 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="evolving-your-architecture-patterns-for-growth"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/">Evolving Your Architecture: Patterns for Growth</a></h2>
<p>Software architecture isn't a one-time design decision—it's a living system that must evolve as your business grows, requirements change, and technology advances. The greatest architectural challenge isn't building the perfect system from day one; it's creating a foundation that can adapt and scale while maintaining code quality, team productivity, and system reliability.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates evolution-friendly patterns that have guided real-world applications from startup MVPs to enterprise-scale systems processing millions of requests daily. This isn't theoretical advice—it's battle-tested strategies for architectural evolution that preserve your investment while enabling growth.</p>
<h3 id="the-evolution-imperative"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#the-evolution-imperative">The Evolution Imperative</a></h3>
<p>I've watched too many promising startups hit the "architectural wall"—the moment when their initial system design becomes the limiting factor in their growth. The symptoms are always the same:</p>
<ul>
<li>New features take exponentially longer to implement</li>
<li>Simple changes require modifications across multiple systems</li>
<li>The development team spends more time fighting the architecture than building features</li>
<li>Scaling requires complete rewrites instead of incremental improvements</li>
<li>Technical debt compounds faster than business value creation</li>
</ul>
<p>A recent client experienced this perfectly. Their e-commerce platform started as a Flask monolith serving 100 orders per day. Eighteen months later, they were processing 10,000 orders daily, had grown from 3 to 25 engineers, and needed to support multiple sales channels. Their architecture had become their biggest constraint.</p>
<p>The solution wasn't a big bang rewrite—it was systematic evolution using Clean Architecture principles as the foundation for incremental transformation.</p>
<h3 id="the-clean-py-tool-arsenal-foundation-for-evolution"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#the-clean-py-tool-arsenal-foundation-for-evolution">The Clean-Py Tool Arsenal: Foundation for Evolution</a></h3>
<p>Before diving into evolution principles, let's examine how the <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> uses specific tools to maintain architectural cleanliness and enable smooth evolution. These tools aren't just development conveniences—they're the foundation that makes architectural evolution possible without code rot.</p>
<h4 id="strategic-tool-selection-in-clean-py"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#strategic-tool-selection-in-clean-py">Strategic Tool Selection in Clean-Py</a></h4>
<p>The repository demonstrates a carefully curated tool selection where each tool serves a specific purpose in maintaining architectural integrity:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="c1"># pyproject.toml - The single source of truth</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">ruff</span><span class="p">]</span>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="n">select</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>    <span class="s2">&quot;E&quot;</span><span class="p">,</span>   <span class="c1"># pycodestyle errors - enforces PEP 8</span>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>    <span class="s2">&quot;F&quot;</span><span class="p">,</span>   <span class="c1"># pyflakes - catches bugs early</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>    <span class="s2">&quot;I&quot;</span><span class="p">,</span>   <span class="c1"># isort - maintains import organization</span>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>    <span class="s2">&quot;B&quot;</span><span class="p">,</span>   <span class="c1"># flake8-bugbear - catches common mistakes</span>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>    <span class="s2">&quot;UP&quot;</span><span class="p">,</span>  <span class="c1"># pyupgrade - keeps code modern</span>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>    <span class="s2">&quot;SIM&quot;</span><span class="p">,</span> <span class="c1"># flake8-simplify - promotes cleaner patterns</span>
<a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>    <span class="s2">&quot;TCH&quot;</span><span class="p">,</span> <span class="c1"># flake8-type-checking - ensures proper typing</span>
<a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a><span class="p">]</span>
<a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>
<a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a><span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">mypy</span><span class="p">]</span>
<a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a><span class="n">strict</span> <span class="o">=</span> <span class="n">true</span>  <span class="c1"># Maximum type safety</span>
<a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a><span class="n">warn_unused_ignores</span> <span class="o">=</span> <span class="n">true</span>
<a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a><span class="n">disallow_untyped_defs</span> <span class="o">=</span> <span class="n">true</span>
<a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a>
<a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a><span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">black</span><span class="p">]</span>
<a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a><span class="n">line</span><span class="o">-</span><span class="n">length</span> <span class="o">=</span> <span class="mi">88</span>  <span class="c1"># Consistent formatting across the project</span>
<a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a>
<a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a><span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">pytest</span><span class="o">.</span><span class="n">ini_options</span><span class="p">]</span>
<a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a><span class="n">addopts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a><span class="s2">    --strict-markers</span>
<a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a><span class="s2">    --cov=src</span>
<a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a><span class="s2">    --cov-branch</span>
<a id="__codelineno-80-26" name="__codelineno-80-26" href="#__codelineno-80-26"></a><span class="s2">    --cov-report=term-missing</span>
<a id="__codelineno-80-27" name="__codelineno-80-27" href="#__codelineno-80-27"></a><span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>
<h4 id="how-tools-enable-clean-architecture"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#how-tools-enable-clean-architecture">How Tools Enable Clean Architecture</a></h4>
<h5 id="1-type-safety-with-mypy-and-pydantic"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#1-type-safety-with-mypy-and-pydantic">1. Type Safety with Mypy and Pydantic</a></h5>
<p>Clean-py leverages Python's type system to enforce architectural boundaries at the type level:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># src/domain/repositories/order_repository.py</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..value_objects.order_id</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderId</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderRepository</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Repository interface - domain layer defines the contract&quot;&quot;&quot;</span>
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Type hints enforce correct entity usage&quot;&quot;&quot;</span>
<a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>        <span class="k">pass</span>
<a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a>
<a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Value objects like OrderId prevent primitive obsession&quot;&quot;&quot;</span>
<a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a>        <span class="k">pass</span>
<a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a>
<a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a><span class="c1"># src/infrastructure/repositories/postgres_order_repository.py</span>
<a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
<a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.repositories.order_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderRepository</span>
<a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.value_objects.order_id</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderId</span>
<a id="__codelineno-81-26" name="__codelineno-81-26" href="#__codelineno-81-26"></a>
<a id="__codelineno-81-27" name="__codelineno-81-27" href="#__codelineno-81-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">PostgresOrderRepository</span><span class="p">(</span><span class="n">OrderRepository</span><span class="p">):</span>
<a id="__codelineno-81-28" name="__codelineno-81-28" href="#__codelineno-81-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Infrastructure implementation - must satisfy domain interface&quot;&quot;&quot;</span>
<a id="__codelineno-81-29" name="__codelineno-81-29" href="#__codelineno-81-29"></a>
<a id="__codelineno-81-30" name="__codelineno-81-30" href="#__codelineno-81-30"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">):</span>
<a id="__codelineno-81-31" name="__codelineno-81-31" href="#__codelineno-81-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
<a id="__codelineno-81-32" name="__codelineno-81-32" href="#__codelineno-81-32"></a>
<a id="__codelineno-81-33" name="__codelineno-81-33" href="#__codelineno-81-33"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-81-34" name="__codelineno-81-34" href="#__codelineno-81-34"></a>        <span class="c1"># Mypy ensures this returns Order, not OrderModel</span>
<a id="__codelineno-81-35" name="__codelineno-81-35" href="#__codelineno-81-35"></a>        <span class="n">order_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_model</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-81-36" name="__codelineno-81-36" href="#__codelineno-81-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">order_model</span><span class="p">)</span>
<a id="__codelineno-81-37" name="__codelineno-81-37" href="#__codelineno-81-37"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-81-38" name="__codelineno-81-38" href="#__codelineno-81-38"></a>        <span class="k">return</span> <span class="n">order</span>  <span class="c1"># Type safety enforced</span>
<a id="__codelineno-81-39" name="__codelineno-81-39" href="#__codelineno-81-39"></a>
<a id="__codelineno-81-40" name="__codelineno-81-40" href="#__codelineno-81-40"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-81-41" name="__codelineno-81-41" href="#__codelineno-81-41"></a>        <span class="c1"># OrderId value object prevents passing raw strings</span>
<a id="__codelineno-81-42" name="__codelineno-81-42" href="#__codelineno-81-42"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">OrderModel</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">order_id</span><span class="p">))</span>
<a id="__codelineno-81-43" name="__codelineno-81-43" href="#__codelineno-81-43"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_entity</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div>
<p>Mypy catches architectural violations at development time:
- Domain depending on infrastructure (import error)
- Wrong types crossing boundaries (type error)
- Missing interface implementations (abstract method error)</p>
<h5 id="2-code-organization-with-ruff-and-isort"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#2-code-organization-with-ruff-and-isort">2. Code Organization with Ruff and isort</a></h5>
<p>Ruff's comprehensive rule set maintains consistent code organization that reflects architectural boundaries:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="c1"># Ruff enforces import organization that reflects architecture</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="c1"># src/application/use_cases/create_order.py</span>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="c1"># Standard library imports</span>
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>
<a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a><span class="c1"># Third-party imports</span>
<a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a>
<a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a><span class="c1"># Domain imports (dependencies flow inward)</span>
<a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.repositories.order_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderRepository</span>
<a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.services.pricing_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">PricingService</span>
<a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a>
<a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a><span class="c1"># Application layer imports (same level)</span>
<a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..commands.create_order_command</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateOrderCommand</span>
<a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..events.order_created_event</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderCreatedEvent</span>
<a id="__codelineno-82-19" name="__codelineno-82-19" href="#__codelineno-82-19"></a>
<a id="__codelineno-82-20" name="__codelineno-82-20" href="#__codelineno-82-20"></a><span class="c1"># ❌ Ruff would flag this - application shouldn&#39;t import infrastructure</span>
<a id="__codelineno-82-21" name="__codelineno-82-21" href="#__codelineno-82-21"></a><span class="c1"># from src.infrastructure.database import get_session  # TCH004 error</span>
</code></pre></div>
<h5 id="3-consistent-formatting-with-black"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#3-consistent-formatting-with-black">3. Consistent Formatting with Black</a></h5>
<p>Black eliminates formatting debates, ensuring the codebase remains readable as it evolves:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="c1"># Before Black - inconsistent formatting obscures architecture</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="n">customer_id</span><span class="p">,</span><span class="n">items</span><span class="p">,</span>
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>                 <span class="n">shipping_address</span><span class="p">,</span><span class="n">billing_address</span><span class="p">,</span>
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>    <span class="n">payment_method</span><span class="p">):</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>    <span class="n">total</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">item</span><span class="o">.</span><span class="n">price</span><span class="o">*</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">])</span>
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>    <span class="n">order</span><span class="o">=</span><span class="n">Order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span><span class="n">customer_id</span><span class="p">,</span><span class="n">total</span><span class="p">)</span>
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>    <span class="k">return</span> <span class="n">order</span>
<a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>
<a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a><span class="c1"># After Black - clean, consistent, architectural intent is clear</span>
<a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span>
<a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">,</span>
<a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span>
<a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">],</span>
<a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">Address</span><span class="p">,</span>
<a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a>    <span class="n">billing_address</span><span class="p">:</span> <span class="n">Address</span><span class="p">,</span>
<a id="__codelineno-83-17" name="__codelineno-83-17" href="#__codelineno-83-17"></a>    <span class="n">payment_method</span><span class="p">:</span> <span class="n">PaymentMethod</span><span class="p">,</span>
<a id="__codelineno-83-18" name="__codelineno-83-18" href="#__codelineno-83-18"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-83-19" name="__codelineno-83-19" href="#__codelineno-83-19"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
<a id="__codelineno-83-20" name="__codelineno-83-20" href="#__codelineno-83-20"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-83-21" name="__codelineno-83-21" href="#__codelineno-83-21"></a>
<a id="__codelineno-83-22" name="__codelineno-83-22" href="#__codelineno-83-22"></a>    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">item</span><span class="o">.</span><span class="n">quantity</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
<a id="__codelineno-83-23" name="__codelineno-83-23" href="#__codelineno-83-23"></a>    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
<a id="__codelineno-83-24" name="__codelineno-83-24" href="#__codelineno-83-24"></a>    <span class="k">return</span> <span class="n">order</span>
</code></pre></div>
<h5 id="4-testing-infrastructure-with-pytest"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#4-testing-infrastructure-with-pytest">4. Testing Infrastructure with Pytest</a></h5>
<p>Clean-py's test structure mirrors the architecture, making it easy to test each layer independently:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c1"># tests/unit/domain/test_order.py</span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.value_objects.money</span><span class="w"> </span><span class="kn">import</span> <span class="n">Money</span>
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestOrder</span><span class="p">:</span>
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Domain tests - no infrastructure dependencies&quot;&quot;&quot;</span>
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a>
<a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_order_total_calculation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>        <span class="c1"># Pure domain logic testing</span>
<a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">)</span>
<a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a>        <span class="n">order</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id</span><span class="o">=</span><span class="s2">&quot;ABC&quot;</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="n">Money</span><span class="p">(</span><span class="mf">10.00</span><span class="p">))</span>
<a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a>
<a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a>        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">total</span> <span class="o">==</span> <span class="n">Money</span><span class="p">(</span><span class="mf">20.00</span><span class="p">)</span>
<a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a>
<a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_order_business_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">)</span>
<a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a>
<a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">DomainException</span><span class="p">):</span>
<a id="__codelineno-84-20" name="__codelineno-84-20" href="#__codelineno-84-20"></a>            <span class="n">order</span><span class="o">.</span><span class="n">confirm</span><span class="p">()</span>  <span class="c1"># Can&#39;t confirm empty order</span>
<a id="__codelineno-84-21" name="__codelineno-84-21" href="#__codelineno-84-21"></a>
<a id="__codelineno-84-22" name="__codelineno-84-22" href="#__codelineno-84-22"></a><span class="c1"># tests/integration/repositories/test_order_repository.py</span>
<a id="__codelineno-84-23" name="__codelineno-84-23" href="#__codelineno-84-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestOrderRepository</span><span class="p">:</span>
<a id="__codelineno-84-24" name="__codelineno-84-24" href="#__codelineno-84-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration tests - test infrastructure with real dependencies&quot;&quot;&quot;</span>
<a id="__codelineno-84-25" name="__codelineno-84-25" href="#__codelineno-84-25"></a>
<a id="__codelineno-84-26" name="__codelineno-84-26" href="#__codelineno-84-26"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-84-27" name="__codelineno-84-27" href="#__codelineno-84-27"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_save_and_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
<a id="__codelineno-84-28" name="__codelineno-84-28" href="#__codelineno-84-28"></a>        <span class="n">repo</span> <span class="o">=</span> <span class="n">PostgresOrderRepository</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>
<a id="__codelineno-84-29" name="__codelineno-84-29" href="#__codelineno-84-29"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">)</span>
<a id="__codelineno-84-30" name="__codelineno-84-30" href="#__codelineno-84-30"></a>
<a id="__codelineno-84-31" name="__codelineno-84-31" href="#__codelineno-84-31"></a>        <span class="n">saved</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-84-32" name="__codelineno-84-32" href="#__codelineno-84-32"></a>        <span class="n">retrieved</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">saved</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-84-33" name="__codelineno-84-33" href="#__codelineno-84-33"></a>
<a id="__codelineno-84-34" name="__codelineno-84-34" href="#__codelineno-84-34"></a>        <span class="k">assert</span> <span class="n">retrieved</span> <span class="o">==</span> <span class="n">saved</span>
</code></pre></div>
<h5 id="5-dependency-management-with-pip-tools"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#5-dependency-management-with-pip-tools">5. Dependency Management with pip-tools</a></h5>
<p>Clean-py uses pip-tools to maintain reproducible builds while allowing controlled evolution:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="c"># Makefile commands for dependency management</span>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">deps</span>-<span class="n">compile</span>
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="nf">deps-compile</span><span class="o">:</span><span class="w">  </span><span class="c">## Compile dependencies</span>
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="w">    </span>pip-compile<span class="w"> </span>pyproject.toml<span class="w"> </span>-o<span class="w"> </span>requirements.txt
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="w">    </span>pip-compile<span class="w"> </span>--extra<span class="w"> </span>dev<span class="w"> </span>pyproject.toml<span class="w"> </span>-o<span class="w"> </span>requirements-dev.txt
<a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a>
<a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">deps</span>-<span class="n">upgrade</span>
<a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="nf">deps-upgrade</span><span class="o">:</span><span class="w">  </span><span class="c">## Upgrade dependencies safely</span>
<a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="w">    </span>pip-compile<span class="w"> </span>--upgrade<span class="w"> </span>pyproject.toml<span class="w"> </span>-o<span class="w"> </span>requirements.txt
<a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a><span class="w">    </span>pip-compile<span class="w"> </span>--upgrade<span class="w"> </span>--extra<span class="w"> </span>dev<span class="w"> </span>pyproject.toml<span class="w"> </span>-o<span class="w"> </span>requirements-dev.txt
<a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a><span class="w">    </span>pip-sync<span class="w"> </span>requirements-dev.txt
<a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a><span class="w">    </span><span class="k">$(</span>MAKE<span class="k">)</span><span class="w"> </span><span class="nb">test</span><span class="w">  </span><span class="c1"># Verify nothing broke</span>
<a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a>
<a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">deps</span>-<span class="n">check</span>
<a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a><span class="nf">deps-check</span><span class="o">:</span><span class="w">  </span><span class="c">## Check for security vulnerabilities</span>
<a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a><span class="w">    </span>safety<span class="w"> </span>check
<a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a><span class="w">    </span>pip-audit
</code></pre></div>
<h4 id="makefile-the-unifying-interface"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#makefile-the-unifying-interface">Makefile: The Unifying Interface</a></h4>
<p>The Makefile provides a consistent interface that abstracts tool complexity:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="c"># Key make commands that maintain cleanliness</span>
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">check</span>
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="nf">check</span><span class="o">:</span><span class="w"> </span><span class="n">format</span> <span class="n">lint</span> <span class="n">type</span>-<span class="n">check</span> <span class="n">test</span>  <span class="c">## Run all checks</span>
<a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a>
<a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">format</span>
<a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="nf">format</span><span class="o">:</span><span class="w">  </span><span class="c">## Format code consistently</span>
<a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="w">    </span>black<span class="w"> </span>src<span class="w"> </span>tests
<a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="w">    </span>isort<span class="w"> </span>src<span class="w"> </span>tests
<a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a><span class="w">    </span>ruff<span class="w"> </span>check<span class="w"> </span>--fix<span class="w"> </span>src<span class="w"> </span>tests
<a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a>
<a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">lint</span>
<a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="nf">lint</span><span class="o">:</span><span class="w">  </span><span class="c">## Comprehensive linting</span>
<a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a><span class="w">    </span>ruff<span class="w"> </span>check<span class="w"> </span>src<span class="w"> </span>tests
<a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a><span class="w">    </span>pylint<span class="w"> </span>src<span class="w"> </span>--fail-under<span class="o">=</span><span class="m">8</span>.0
<a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a>
<a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">type</span>-<span class="n">check</span>
<a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a><span class="nf">type-check</span><span class="o">:</span><span class="w">  </span><span class="c">## Verify type safety</span>
<a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a><span class="w">    </span>mypy<span class="w"> </span>src<span class="w"> </span>--strict
<a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a><span class="w">    </span>pyright<span class="w"> </span>src
<a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a>
<a id="__codelineno-86-22" name="__codelineno-86-22" href="#__codelineno-86-22"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">test</span>
<a id="__codelineno-86-23" name="__codelineno-86-23" href="#__codelineno-86-23"></a><span class="nf">test</span><span class="o">:</span><span class="w">  </span><span class="c">## Run tests with coverage</span>
<a id="__codelineno-86-24" name="__codelineno-86-24" href="#__codelineno-86-24"></a><span class="w">    </span>pytest<span class="w"> </span>tests/unit<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-fail-under<span class="o">=</span><span class="m">80</span>
<a id="__codelineno-86-25" name="__codelineno-86-25" href="#__codelineno-86-25"></a><span class="w">    </span>pytest<span class="w"> </span>tests/integration
<a id="__codelineno-86-26" name="__codelineno-86-26" href="#__codelineno-86-26"></a>
<a id="__codelineno-86-27" name="__codelineno-86-27" href="#__codelineno-86-27"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">security</span>
<a id="__codelineno-86-28" name="__codelineno-86-28" href="#__codelineno-86-28"></a><span class="nf">security</span><span class="o">:</span><span class="w">  </span><span class="c">## Security scanning</span>
<a id="__codelineno-86-29" name="__codelineno-86-29" href="#__codelineno-86-29"></a><span class="w">    </span>bandit<span class="w"> </span>-r<span class="w"> </span>src<span class="w"> </span>-ll
<a id="__codelineno-86-30" name="__codelineno-86-30" href="#__codelineno-86-30"></a><span class="w">    </span>safety<span class="w"> </span>check
<a id="__codelineno-86-31" name="__codelineno-86-31" href="#__codelineno-86-31"></a><span class="w">    </span>pip-audit
<a id="__codelineno-86-32" name="__codelineno-86-32" href="#__codelineno-86-32"></a>
<a id="__codelineno-86-33" name="__codelineno-86-33" href="#__codelineno-86-33"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">complexity</span>
<a id="__codelineno-86-34" name="__codelineno-86-34" href="#__codelineno-86-34"></a><span class="nf">complexity</span><span class="o">:</span><span class="w">  </span><span class="c">## Monitor code complexity</span>
<a id="__codelineno-86-35" name="__codelineno-86-35" href="#__codelineno-86-35"></a><span class="w">    </span>radon<span class="w"> </span>cc<span class="w"> </span>src<span class="w"> </span>--min<span class="w"> </span>B<span class="w"> </span>--total-average
<a id="__codelineno-86-36" name="__codelineno-86-36" href="#__codelineno-86-36"></a><span class="w">    </span>radon<span class="w"> </span>mi<span class="w"> </span>src<span class="w"> </span>--min<span class="w"> </span>B
<a id="__codelineno-86-37" name="__codelineno-86-37" href="#__codelineno-86-37"></a>
<a id="__codelineno-86-38" name="__codelineno-86-38" href="#__codelineno-86-38"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">clean</span>-<span class="n">arch</span>-<span class="n">check</span>
<a id="__codelineno-86-39" name="__codelineno-86-39" href="#__codelineno-86-39"></a><span class="nf">clean-arch-check</span><span class="o">:</span><span class="w">  </span><span class="c">## Verify Clean Architecture rules</span>
<a id="__codelineno-86-40" name="__codelineno-86-40" href="#__codelineno-86-40"></a><span class="w">    </span>python<span class="w"> </span>scripts/check_architecture.py
</code></pre></div>
<h4 id="architecture-validation-scripts"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#architecture-validation-scripts">Architecture Validation Scripts</a></h4>
<p>Clean-py includes custom scripts that enforce architectural rules:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="c1"># scripts/check_architecture.py</span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span>
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">ArchitectureChecker</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates Clean Architecture dependency rules&quot;&quot;&quot;</span>
<a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>
<a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_file</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_layer</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a>
<a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check entire project for architectural violations&quot;&quot;&quot;</span>
<a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a>        <span class="k">for</span> <span class="n">py_file</span> <span class="ow">in</span> <span class="n">src_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">):</span>
<a id="__codelineno-87-18" name="__codelineno-87-18" href="#__codelineno-87-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">check_file</span><span class="p">(</span><span class="n">py_file</span><span class="p">)</span>
<a id="__codelineno-87-19" name="__codelineno-87-19" href="#__codelineno-87-19"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">violations</span>
<a id="__codelineno-87-20" name="__codelineno-87-20" href="#__codelineno-87-20"></a>
<a id="__codelineno-87-21" name="__codelineno-87-21" href="#__codelineno-87-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<a id="__codelineno-87-22" name="__codelineno-87-22" href="#__codelineno-87-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check single file for violations&quot;&quot;&quot;</span>
<a id="__codelineno-87-23" name="__codelineno-87-23" href="#__codelineno-87-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_file</span> <span class="o">=</span> <span class="n">file_path</span>
<a id="__codelineno-87-24" name="__codelineno-87-24" href="#__codelineno-87-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_layer</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-87-25" name="__codelineno-87-25" href="#__codelineno-87-25"></a>
<a id="__codelineno-87-26" name="__codelineno-87-26" href="#__codelineno-87-26"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-87-27" name="__codelineno-87-27" href="#__codelineno-87-27"></a>            <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<a id="__codelineno-87-28" name="__codelineno-87-28" href="#__codelineno-87-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<a id="__codelineno-87-29" name="__codelineno-87-29" href="#__codelineno-87-29"></a>
<a id="__codelineno-87-30" name="__codelineno-87-30" href="#__codelineno-87-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-87-31" name="__codelineno-87-31" href="#__codelineno-87-31"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check import statements for violations&quot;&quot;&quot;</span>
<a id="__codelineno-87-32" name="__codelineno-87-32" href="#__codelineno-87-32"></a>        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
<a id="__codelineno-87-33" name="__codelineno-87-33" href="#__codelineno-87-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_import</span><span class="p">(</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-87-34" name="__codelineno-87-34" href="#__codelineno-87-34"></a>
<a id="__codelineno-87-35" name="__codelineno-87-35" href="#__codelineno-87-35"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visit_ImportFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-87-36" name="__codelineno-87-36" href="#__codelineno-87-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check from-import statements for violations&quot;&quot;&quot;</span>
<a id="__codelineno-87-37" name="__codelineno-87-37" href="#__codelineno-87-37"></a>        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">:</span>
<a id="__codelineno-87-38" name="__codelineno-87-38" href="#__codelineno-87-38"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_import</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
<a id="__codelineno-87-39" name="__codelineno-87-39" href="#__codelineno-87-39"></a>
<a id="__codelineno-87-40" name="__codelineno-87-40" href="#__codelineno-87-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-87-41" name="__codelineno-87-41" href="#__codelineno-87-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine architectural layer from file path&quot;&quot;&quot;</span>
<a id="__codelineno-87-42" name="__codelineno-87-42" href="#__codelineno-87-42"></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">parts</span>
<a id="__codelineno-87-43" name="__codelineno-87-43" href="#__codelineno-87-43"></a>        <span class="k">if</span> <span class="s2">&quot;domain&quot;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
<a id="__codelineno-87-44" name="__codelineno-87-44" href="#__codelineno-87-44"></a>            <span class="k">return</span> <span class="s2">&quot;domain&quot;</span>
<a id="__codelineno-87-45" name="__codelineno-87-45" href="#__codelineno-87-45"></a>        <span class="k">elif</span> <span class="s2">&quot;application&quot;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
<a id="__codelineno-87-46" name="__codelineno-87-46" href="#__codelineno-87-46"></a>            <span class="k">return</span> <span class="s2">&quot;application&quot;</span>
<a id="__codelineno-87-47" name="__codelineno-87-47" href="#__codelineno-87-47"></a>        <span class="k">elif</span> <span class="s2">&quot;infrastructure&quot;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
<a id="__codelineno-87-48" name="__codelineno-87-48" href="#__codelineno-87-48"></a>            <span class="k">return</span> <span class="s2">&quot;infrastructure&quot;</span>
<a id="__codelineno-87-49" name="__codelineno-87-49" href="#__codelineno-87-49"></a>        <span class="k">elif</span> <span class="s2">&quot;presentation&quot;</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
<a id="__codelineno-87-50" name="__codelineno-87-50" href="#__codelineno-87-50"></a>            <span class="k">return</span> <span class="s2">&quot;presentation&quot;</span>
<a id="__codelineno-87-51" name="__codelineno-87-51" href="#__codelineno-87-51"></a>        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>
<a id="__codelineno-87-52" name="__codelineno-87-52" href="#__codelineno-87-52"></a>
<a id="__codelineno-87-53" name="__codelineno-87-53" href="#__codelineno-87-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-87-54" name="__codelineno-87-54" href="#__codelineno-87-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if import violates architectural rules&quot;&quot;&quot;</span>
<a id="__codelineno-87-55" name="__codelineno-87-55" href="#__codelineno-87-55"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">):</span>
<a id="__codelineno-87-56" name="__codelineno-87-56" href="#__codelineno-87-56"></a>            <span class="k">return</span>  <span class="c1"># External import, allowed</span>
<a id="__codelineno-87-57" name="__codelineno-87-57" href="#__codelineno-87-57"></a>
<a id="__codelineno-87-58" name="__codelineno-87-58" href="#__codelineno-87-58"></a>        <span class="n">imported_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_layer_from_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<a id="__codelineno-87-59" name="__codelineno-87-59" href="#__codelineno-87-59"></a>
<a id="__codelineno-87-60" name="__codelineno-87-60" href="#__codelineno-87-60"></a>        <span class="c1"># Check dependency rules</span>
<a id="__codelineno-87-61" name="__codelineno-87-61" href="#__codelineno-87-61"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_layer</span> <span class="o">==</span> <span class="s2">&quot;domain&quot;</span><span class="p">:</span>
<a id="__codelineno-87-62" name="__codelineno-87-62" href="#__codelineno-87-62"></a>            <span class="k">if</span> <span class="n">imported_layer</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="s2">&quot;infrastructure&quot;</span><span class="p">,</span> <span class="s2">&quot;presentation&quot;</span><span class="p">]:</span>
<a id="__codelineno-87-63" name="__codelineno-87-63" href="#__codelineno-87-63"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-87-64" name="__codelineno-87-64" href="#__codelineno-87-64"></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="si">}</span><span class="s2">: Domain layer importing from </span><span class="si">{</span><span class="n">imported_layer</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-87-65" name="__codelineno-87-65" href="#__codelineno-87-65"></a>                <span class="p">)</span>
<a id="__codelineno-87-66" name="__codelineno-87-66" href="#__codelineno-87-66"></a>
<a id="__codelineno-87-67" name="__codelineno-87-67" href="#__codelineno-87-67"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_layer</span> <span class="o">==</span> <span class="s2">&quot;application&quot;</span><span class="p">:</span>
<a id="__codelineno-87-68" name="__codelineno-87-68" href="#__codelineno-87-68"></a>            <span class="k">if</span> <span class="n">imported_layer</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;infrastructure&quot;</span><span class="p">,</span> <span class="s2">&quot;presentation&quot;</span><span class="p">]:</span>
<a id="__codelineno-87-69" name="__codelineno-87-69" href="#__codelineno-87-69"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-87-70" name="__codelineno-87-70" href="#__codelineno-87-70"></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="si">}</span><span class="s2">: Application layer importing from </span><span class="si">{</span><span class="n">imported_layer</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-87-71" name="__codelineno-87-71" href="#__codelineno-87-71"></a>                <span class="p">)</span>
<a id="__codelineno-87-72" name="__codelineno-87-72" href="#__codelineno-87-72"></a>
<a id="__codelineno-87-73" name="__codelineno-87-73" href="#__codelineno-87-73"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_layer</span> <span class="o">==</span> <span class="s2">&quot;infrastructure&quot;</span><span class="p">:</span>
<a id="__codelineno-87-74" name="__codelineno-87-74" href="#__codelineno-87-74"></a>            <span class="k">if</span> <span class="n">imported_layer</span> <span class="o">==</span> <span class="s2">&quot;presentation&quot;</span><span class="p">:</span>
<a id="__codelineno-87-75" name="__codelineno-87-75" href="#__codelineno-87-75"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-87-76" name="__codelineno-87-76" href="#__codelineno-87-76"></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="si">}</span><span class="s2">: Infrastructure layer importing from presentation&quot;</span>
<a id="__codelineno-87-77" name="__codelineno-87-77" href="#__codelineno-87-77"></a>                <span class="p">)</span>
<a id="__codelineno-87-78" name="__codelineno-87-78" href="#__codelineno-87-78"></a>
<a id="__codelineno-87-79" name="__codelineno-87-79" href="#__codelineno-87-79"></a><span class="c1"># Run in CI/CD</span>
<a id="__codelineno-87-80" name="__codelineno-87-80" href="#__codelineno-87-80"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-87-81" name="__codelineno-87-81" href="#__codelineno-87-81"></a>    <span class="n">checker</span> <span class="o">=</span> <span class="n">ArchitectureChecker</span><span class="p">()</span>
<a id="__codelineno-87-82" name="__codelineno-87-82" href="#__codelineno-87-82"></a>    <span class="n">violations</span> <span class="o">=</span> <span class="n">checker</span><span class="o">.</span><span class="n">check_project</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">))</span>
<a id="__codelineno-87-83" name="__codelineno-87-83" href="#__codelineno-87-83"></a>
<a id="__codelineno-87-84" name="__codelineno-87-84" href="#__codelineno-87-84"></a>    <span class="k">if</span> <span class="n">violations</span><span class="p">:</span>
<a id="__codelineno-87-85" name="__codelineno-87-85" href="#__codelineno-87-85"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Architecture violations found:&quot;</span><span class="p">)</span>
<a id="__codelineno-87-86" name="__codelineno-87-86" href="#__codelineno-87-86"></a>        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">violations</span><span class="p">:</span>
<a id="__codelineno-87-87" name="__codelineno-87-87" href="#__codelineno-87-87"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-87-88" name="__codelineno-87-88" href="#__codelineno-87-88"></a>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-87-89" name="__codelineno-87-89" href="#__codelineno-87-89"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-87-90" name="__codelineno-87-90" href="#__codelineno-87-90"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ No architecture violations found&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="how-these-tools-enable-evolution"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#how-these-tools-enable-evolution">How These Tools Enable Evolution</a></h4>
<p>The combination of these tools creates a safety net that makes architectural evolution possible:</p>
<ol>
<li><strong>Refactoring Confidence</strong>: Comprehensive type checking and tests mean you can refactor fearlessly</li>
<li><strong>Consistent Codebase</strong>: Formatting and linting tools ensure the codebase remains readable as it grows</li>
<li><strong>Architectural Integrity</strong>: Custom validation scripts prevent architectural drift</li>
<li><strong>Quick Feedback</strong>: Pre-commit hooks catch issues before they enter the repository</li>
<li><strong>Team Alignment</strong>: Shared tooling ensures everyone follows the same standards</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="c1"># .pre-commit-config.yaml - Automated quality gates</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="nt">repos</span><span class="p">:</span>
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/psf/black</span>
<a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">23.11.0</span>
<a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">black</span>
<a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a>
<a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/charliermarsh/ruff-pre-commit</span>
<a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.1.6</span>
<a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruff</span>
<a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">--fix</span><span class="p p-Indicator">]</span>
<a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a>
<a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/pre-commit/mirrors-mypy</span>
<a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.7.1</span>
<a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mypy</span>
<a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">--strict</span><span class="p p-Indicator">]</span>
<a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a>
<a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<a id="__codelineno-88-21" name="__codelineno-88-21" href="#__codelineno-88-21"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-88-22" name="__codelineno-88-22" href="#__codelineno-88-22"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clean-arch-check</span>
<a id="__codelineno-88-23" name="__codelineno-88-23" href="#__codelineno-88-23"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Clean Architecture Check</span>
<a id="__codelineno-88-24" name="__codelineno-88-24" href="#__codelineno-88-24"></a><span class="w">        </span><span class="nt">entry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python scripts/check_architecture.py</span>
<a id="__codelineno-88-25" name="__codelineno-88-25" href="#__codelineno-88-25"></a><span class="w">        </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system</span>
<a id="__codelineno-88-26" name="__codelineno-88-26" href="#__codelineno-88-26"></a><span class="w">        </span><span class="nt">pass_filenames</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-88-27" name="__codelineno-88-27" href="#__codelineno-88-27"></a>
<a id="__codelineno-88-28" name="__codelineno-88-28" href="#__codelineno-88-28"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">complexity-check</span>
<a id="__codelineno-88-29" name="__codelineno-88-29" href="#__codelineno-88-29"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Complexity Check</span>
<a id="__codelineno-88-30" name="__codelineno-88-30" href="#__codelineno-88-30"></a><span class="w">        </span><span class="nt">entry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">radon cc src --min C --no-assert</span>
<a id="__codelineno-88-31" name="__codelineno-88-31" href="#__codelineno-88-31"></a><span class="w">        </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system</span>
<a id="__codelineno-88-32" name="__codelineno-88-32" href="#__codelineno-88-32"></a><span class="w">        </span><span class="nt">pass_filenames</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<p>This tool infrastructure isn't overhead—it's what makes the clean-py architecture sustainable and evolvable. Each tool serves a specific purpose in maintaining the integrity of the Clean Architecture while enabling the flexibility needed for evolution.</p>
<h3 id="evolution-principles"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#evolution-principles">Evolution Principles</a></h3>
<p>With this tool foundation in place, successful architectural evolution follows consistent patterns:</p>
<h4 id="1-preserve-business-logic-investment"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#1-preserve-business-logic-investment">1. Preserve Business Logic Investment</a></h4>
<p>Your domain logic—the core business rules that differentiate your product—should remain stable even as infrastructure evolves. Clean Architecture's dependency inversion principle ensures business logic never depends on technical implementation details.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="c1"># Domain layer remains unchanged during evolution</span>
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderService</span><span class="p">:</span>
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_repository</span><span class="p">:</span> <span class="n">OrderRepository</span><span class="p">):</span>
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span> <span class="o">=</span> <span class="n">order_repository</span>
<a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a>
<a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">CreateOrderCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a>        <span class="c1"># Business logic never changes</span>
<a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a>            <span class="n">items</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">items</span><span class="p">,</span>
<a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a>            <span class="n">shipping_address</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">shipping_address</span>
<a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a>        <span class="p">)</span>
<a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a>
<a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a>        <span class="c1"># Validate business rules</span>
<a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_order_rules</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a>
<a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a>        <span class="c1"># Save through repository interface (implementation can evolve)</span>
<a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a>
<a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a><span class="c1"># Infrastructure evolves while business logic remains stable</span>
<a id="__codelineno-89-21" name="__codelineno-89-21" href="#__codelineno-89-21"></a><span class="c1"># Evolution 1: In-memory repository for testing</span>
<a id="__codelineno-89-22" name="__codelineno-89-22" href="#__codelineno-89-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">InMemoryOrderRepository</span><span class="p">(</span><span class="n">OrderRepository</span><span class="p">):</span>
<a id="__codelineno-89-23" name="__codelineno-89-23" href="#__codelineno-89-23"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-89-24" name="__codelineno-89-24" href="#__codelineno-89-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_orders</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-89-25" name="__codelineno-89-25" href="#__codelineno-89-25"></a>
<a id="__codelineno-89-26" name="__codelineno-89-26" href="#__codelineno-89-26"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-89-27" name="__codelineno-89-27" href="#__codelineno-89-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_orders</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
<a id="__codelineno-89-28" name="__codelineno-89-28" href="#__codelineno-89-28"></a>        <span class="k">return</span> <span class="n">order</span>
<a id="__codelineno-89-29" name="__codelineno-89-29" href="#__codelineno-89-29"></a>
<a id="__codelineno-89-30" name="__codelineno-89-30" href="#__codelineno-89-30"></a><span class="c1"># Evolution 2: SQL database for production</span>
<a id="__codelineno-89-31" name="__codelineno-89-31" href="#__codelineno-89-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">SQLOrderRepository</span><span class="p">(</span><span class="n">OrderRepository</span><span class="p">):</span>
<a id="__codelineno-89-32" name="__codelineno-89-32" href="#__codelineno-89-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
<a id="__codelineno-89-33" name="__codelineno-89-33" href="#__codelineno-89-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_session</span> <span class="o">=</span> <span class="n">db_session</span>
<a id="__codelineno-89-34" name="__codelineno-89-34" href="#__codelineno-89-34"></a>
<a id="__codelineno-89-35" name="__codelineno-89-35" href="#__codelineno-89-35"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-89-36" name="__codelineno-89-36" href="#__codelineno-89-36"></a>        <span class="c1"># SQL implementation</span>
<a id="__codelineno-89-37" name="__codelineno-89-37" href="#__codelineno-89-37"></a>        <span class="k">pass</span>
<a id="__codelineno-89-38" name="__codelineno-89-38" href="#__codelineno-89-38"></a>
<a id="__codelineno-89-39" name="__codelineno-89-39" href="#__codelineno-89-39"></a><span class="c1"># Evolution 3: Event-sourced repository for audit requirements</span>
<a id="__codelineno-89-40" name="__codelineno-89-40" href="#__codelineno-89-40"></a><span class="k">class</span><span class="w"> </span><span class="nc">EventSourcedOrderRepository</span><span class="p">(</span><span class="n">OrderRepository</span><span class="p">):</span>
<a id="__codelineno-89-41" name="__codelineno-89-41" href="#__codelineno-89-41"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_store</span><span class="p">):</span>
<a id="__codelineno-89-42" name="__codelineno-89-42" href="#__codelineno-89-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>
<a id="__codelineno-89-43" name="__codelineno-89-43" href="#__codelineno-89-43"></a>
<a id="__codelineno-89-44" name="__codelineno-89-44" href="#__codelineno-89-44"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-89-45" name="__codelineno-89-45" href="#__codelineno-89-45"></a>        <span class="c1"># Event sourcing implementation</span>
<a id="__codelineno-89-46" name="__codelineno-89-46" href="#__codelineno-89-46"></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">get_uncommitted_events</span><span class="p">()</span>
<a id="__codelineno-89-47" name="__codelineno-89-47" href="#__codelineno-89-47"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">append_events</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
<a id="__codelineno-89-48" name="__codelineno-89-48" href="#__codelineno-89-48"></a>        <span class="k">return</span> <span class="n">order</span>
</code></pre></div>
<h4 id="2-enable-incremental-migration"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#2-enable-incremental-migration">2. Enable Incremental Migration</a></h4>
<p>Rather than big-bang rewrites, successful evolution happens incrementally. The Strangler Fig pattern allows you to gradually replace system components while maintaining system functionality.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="c1"># Legacy system integration during transition</span>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">LegacyOrderService</span><span class="p">:</span>
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Legacy order service being gradually replaced&quot;&quot;&quot;</span>
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>
<a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>        <span class="c1"># Legacy implementation</span>
<a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>        <span class="k">pass</span>
<a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>
<a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">ModernOrderService</span><span class="p">:</span>
<a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;New Clean Architecture implementation&quot;&quot;&quot;</span>
<a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>
<a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_use_case</span><span class="p">:</span> <span class="n">CreateOrderUseCase</span><span class="p">):</span>
<a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_use_case</span> <span class="o">=</span> <span class="n">order_use_case</span>
<a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a>
<a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">CreateOrderCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-90-17" name="__codelineno-90-17" href="#__codelineno-90-17"></a>
<a id="__codelineno-90-18" name="__codelineno-90-18" href="#__codelineno-90-18"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderServiceRouter</span><span class="p">:</span>
<a id="__codelineno-90-19" name="__codelineno-90-19" href="#__codelineno-90-19"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Routes requests between legacy and modern implementations&quot;&quot;&quot;</span>
<a id="__codelineno-90-20" name="__codelineno-90-20" href="#__codelineno-90-20"></a>
<a id="__codelineno-90-21" name="__codelineno-90-21" href="#__codelineno-90-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-90-22" name="__codelineno-90-22" href="#__codelineno-90-22"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-90-23" name="__codelineno-90-23" href="#__codelineno-90-23"></a>        <span class="n">legacy_service</span><span class="p">:</span> <span class="n">LegacyOrderService</span><span class="p">,</span>
<a id="__codelineno-90-24" name="__codelineno-90-24" href="#__codelineno-90-24"></a>        <span class="n">modern_service</span><span class="p">:</span> <span class="n">ModernOrderService</span><span class="p">,</span>
<a id="__codelineno-90-25" name="__codelineno-90-25" href="#__codelineno-90-25"></a>        <span class="n">feature_flags</span><span class="p">:</span> <span class="n">FeatureFlags</span>
<a id="__codelineno-90-26" name="__codelineno-90-26" href="#__codelineno-90-26"></a>    <span class="p">):</span>
<a id="__codelineno-90-27" name="__codelineno-90-27" href="#__codelineno-90-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">legacy_service</span> <span class="o">=</span> <span class="n">legacy_service</span>
<a id="__codelineno-90-28" name="__codelineno-90-28" href="#__codelineno-90-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modern_service</span> <span class="o">=</span> <span class="n">modern_service</span>
<a id="__codelineno-90-29" name="__codelineno-90-29" href="#__codelineno-90-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span> <span class="o">=</span> <span class="n">feature_flags</span>
<a id="__codelineno-90-30" name="__codelineno-90-30" href="#__codelineno-90-30"></a>
<a id="__codelineno-90-31" name="__codelineno-90-31" href="#__codelineno-90-31"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-90-32" name="__codelineno-90-32" href="#__codelineno-90-32"></a>        <span class="c1"># Gradual migration based on feature flags</span>
<a id="__codelineno-90-33" name="__codelineno-90-33" href="#__codelineno-90-33"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">)</span>
<a id="__codelineno-90-34" name="__codelineno-90-34" href="#__codelineno-90-34"></a>
<a id="__codelineno-90-35" name="__codelineno-90-35" href="#__codelineno-90-35"></a>        <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_flags</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="s1">&#39;modern_order_service&#39;</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">):</span>
<a id="__codelineno-90-36" name="__codelineno-90-36" href="#__codelineno-90-36"></a>            <span class="c1"># Use modern implementation</span>
<a id="__codelineno-90-37" name="__codelineno-90-37" href="#__codelineno-90-37"></a>            <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_command</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-90-38" name="__codelineno-90-38" href="#__codelineno-90-38"></a>            <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">modern_service</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-90-39" name="__codelineno-90-39" href="#__codelineno-90-39"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_legacy_format</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-90-40" name="__codelineno-90-40" href="#__codelineno-90-40"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-90-41" name="__codelineno-90-41" href="#__codelineno-90-41"></a>            <span class="c1"># Fall back to legacy implementation</span>
<a id="__codelineno-90-42" name="__codelineno-90-42" href="#__codelineno-90-42"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy_service</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-90-43" name="__codelineno-90-43" href="#__codelineno-90-43"></a>
<a id="__codelineno-90-44" name="__codelineno-90-44" href="#__codelineno-90-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CreateOrderCommand</span><span class="p">:</span>
<a id="__codelineno-90-45" name="__codelineno-90-45" href="#__codelineno-90-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert legacy format to modern command&quot;&quot;&quot;</span>
<a id="__codelineno-90-46" name="__codelineno-90-46" href="#__codelineno-90-46"></a>        <span class="k">return</span> <span class="n">CreateOrderCommand</span><span class="p">(</span>
<a id="__codelineno-90-47" name="__codelineno-90-47" href="#__codelineno-90-47"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">],</span>
<a id="__codelineno-90-48" name="__codelineno-90-48" href="#__codelineno-90-48"></a>            <span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]],</span>
<a id="__codelineno-90-49" name="__codelineno-90-49" href="#__codelineno-90-49"></a>            <span class="n">shipping_address</span><span class="o">=</span><span class="n">Address</span><span class="p">(</span><span class="o">**</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;shipping_address&#39;</span><span class="p">])</span>
<a id="__codelineno-90-50" name="__codelineno-90-50" href="#__codelineno-90-50"></a>        <span class="p">)</span>
<a id="__codelineno-90-51" name="__codelineno-90-51" href="#__codelineno-90-51"></a>
<a id="__codelineno-90-52" name="__codelineno-90-52" href="#__codelineno-90-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_legacy_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-90-53" name="__codelineno-90-53" href="#__codelineno-90-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert modern order to legacy format&quot;&quot;&quot;</span>
<a id="__codelineno-90-54" name="__codelineno-90-54" href="#__codelineno-90-54"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-90-55" name="__codelineno-90-55" href="#__codelineno-90-55"></a>            <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-90-56" name="__codelineno-90-56" href="#__codelineno-90-56"></a>            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-90-57" name="__codelineno-90-57" href="#__codelineno-90-57"></a>            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
<a id="__codelineno-90-58" name="__codelineno-90-58" href="#__codelineno-90-58"></a>        <span class="p">}</span>
</code></pre></div>
<h4 id="3-anticipate-scale-requirements"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#3-anticipate-scale-requirements">3. Anticipate Scale Requirements</a></h4>
<p>Design interfaces and abstractions that can handle future scale requirements without requiring complete rewrites.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="c1"># Repository interface designed for scale evolution</span>
<a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span>
<a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>
<a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">ScalableOrderRepository</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Repository interface designed to evolve with scale requirements&quot;&quot;&quot;</span>
<a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a>
<a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save single order&quot;&quot;&quot;</span>
<a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a>        <span class="k">pass</span>
<a id="__codelineno-91-12" name="__codelineno-91-12" href="#__codelineno-91-12"></a>
<a id="__codelineno-91-13" name="__codelineno-91-13" href="#__codelineno-91-13"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-91-14" name="__codelineno-91-14" href="#__codelineno-91-14"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-91-15" name="__codelineno-91-15" href="#__codelineno-91-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch save for high-throughput scenarios&quot;&quot;&quot;</span>
<a id="__codelineno-91-16" name="__codelineno-91-16" href="#__codelineno-91-16"></a>        <span class="k">pass</span>
<a id="__codelineno-91-17" name="__codelineno-91-17" href="#__codelineno-91-17"></a>
<a id="__codelineno-91-18" name="__codelineno-91-18" href="#__codelineno-91-18"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-91-19" name="__codelineno-91-19" href="#__codelineno-91-19"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-91-20" name="__codelineno-91-20" href="#__codelineno-91-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get single order&quot;&quot;&quot;</span>
<a id="__codelineno-91-21" name="__codelineno-91-21" href="#__codelineno-91-21"></a>        <span class="k">pass</span>
<a id="__codelineno-91-22" name="__codelineno-91-22" href="#__codelineno-91-22"></a>
<a id="__codelineno-91-23" name="__codelineno-91-23" href="#__codelineno-91-23"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-91-24" name="__codelineno-91-24" href="#__codelineno-91-24"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_customer_id</span><span class="p">(</span>
<a id="__codelineno-91-25" name="__codelineno-91-25" href="#__codelineno-91-25"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-91-26" name="__codelineno-91-26" href="#__codelineno-91-26"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-91-27" name="__codelineno-91-27" href="#__codelineno-91-27"></a>        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-91-28" name="__codelineno-91-28" href="#__codelineno-91-28"></a>        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-91-29" name="__codelineno-91-29" href="#__codelineno-91-29"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-91-30" name="__codelineno-91-30" href="#__codelineno-91-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Paginated customer orders&quot;&quot;&quot;</span>
<a id="__codelineno-91-31" name="__codelineno-91-31" href="#__codelineno-91-31"></a>        <span class="k">pass</span>
<a id="__codelineno-91-32" name="__codelineno-91-32" href="#__codelineno-91-32"></a>
<a id="__codelineno-91-33" name="__codelineno-91-33" href="#__codelineno-91-33"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-91-34" name="__codelineno-91-34" href="#__codelineno-91-34"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">OrderSearchCriteria</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderSearchResult</span><span class="p">:</span>
<a id="__codelineno-91-35" name="__codelineno-91-35" href="#__codelineno-91-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Flexible search interface for complex queries&quot;&quot;&quot;</span>
<a id="__codelineno-91-36" name="__codelineno-91-36" href="#__codelineno-91-36"></a>        <span class="k">pass</span>
<a id="__codelineno-91-37" name="__codelineno-91-37" href="#__codelineno-91-37"></a>
<a id="__codelineno-91-38" name="__codelineno-91-38" href="#__codelineno-91-38"></a><span class="c1"># Evolution from simple to sophisticated implementations</span>
<a id="__codelineno-91-39" name="__codelineno-91-39" href="#__codelineno-91-39"></a><span class="k">class</span><span class="w"> </span><span class="nc">SimpleOrderRepository</span><span class="p">(</span><span class="n">ScalableOrderRepository</span><span class="p">):</span>
<a id="__codelineno-91-40" name="__codelineno-91-40" href="#__codelineno-91-40"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initial implementation for low scale&quot;&quot;&quot;</span>
<a id="__codelineno-91-41" name="__codelineno-91-41" href="#__codelineno-91-41"></a>
<a id="__codelineno-91-42" name="__codelineno-91-42" href="#__codelineno-91-42"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-91-43" name="__codelineno-91-43" href="#__codelineno-91-43"></a>        <span class="c1"># Simple loop for initial implementation</span>
<a id="__codelineno-91-44" name="__codelineno-91-44" href="#__codelineno-91-44"></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-91-45" name="__codelineno-91-45" href="#__codelineno-91-45"></a>        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-91-46" name="__codelineno-91-46" href="#__codelineno-91-46"></a>            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-91-47" name="__codelineno-91-47" href="#__codelineno-91-47"></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-91-48" name="__codelineno-91-48" href="#__codelineno-91-48"></a>        <span class="k">return</span> <span class="n">results</span>
<a id="__codelineno-91-49" name="__codelineno-91-49" href="#__codelineno-91-49"></a>
<a id="__codelineno-91-50" name="__codelineno-91-50" href="#__codelineno-91-50"></a><span class="k">class</span><span class="w"> </span><span class="nc">HighPerformanceOrderRepository</span><span class="p">(</span><span class="n">ScalableOrderRepository</span><span class="p">):</span>
<a id="__codelineno-91-51" name="__codelineno-91-51" href="#__codelineno-91-51"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Evolved implementation for high scale&quot;&quot;&quot;</span>
<a id="__codelineno-91-52" name="__codelineno-91-52" href="#__codelineno-91-52"></a>
<a id="__codelineno-91-53" name="__codelineno-91-53" href="#__codelineno-91-53"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orders</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-91-54" name="__codelineno-91-54" href="#__codelineno-91-54"></a>        <span class="c1"># Optimized batch operations</span>
<a id="__codelineno-91-55" name="__codelineno-91-55" href="#__codelineno-91-55"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-91-56" name="__codelineno-91-56" href="#__codelineno-91-56"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
<a id="__codelineno-91-57" name="__codelineno-91-57" href="#__codelineno-91-57"></a>
<a id="__codelineno-91-58" name="__codelineno-91-58" href="#__codelineno-91-58"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="n">OrderSearchCriteria</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderSearchResult</span><span class="p">:</span>
<a id="__codelineno-91-59" name="__codelineno-91-59" href="#__codelineno-91-59"></a>        <span class="c1"># Sophisticated search with caching and indexing</span>
<a id="__codelineno-91-60" name="__codelineno-91-60" href="#__codelineno-91-60"></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">cache_key</span><span class="p">()</span>
<a id="__codelineno-91-61" name="__codelineno-91-61" href="#__codelineno-91-61"></a>
<a id="__codelineno-91-62" name="__codelineno-91-62" href="#__codelineno-91-62"></a>        <span class="k">if</span> <span class="n">cached_result</span> <span class="o">:=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">):</span>
<a id="__codelineno-91-63" name="__codelineno-91-63" href="#__codelineno-91-63"></a>            <span class="k">return</span> <span class="n">cached_result</span>
<a id="__codelineno-91-64" name="__codelineno-91-64" href="#__codelineno-91-64"></a>
<a id="__codelineno-91-65" name="__codelineno-91-65" href="#__codelineno-91-65"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_search</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
<a id="__codelineno-91-66" name="__codelineno-91-66" href="#__codelineno-91-66"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<a id="__codelineno-91-67" name="__codelineno-91-67" href="#__codelineno-91-67"></a>        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<h3 id="evolutionary-patterns"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#evolutionary-patterns">Evolutionary Patterns</a></h3>
<h4 id="pattern-1-modular-monolith-to-microservices"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#pattern-1-modular-monolith-to-microservices">Pattern 1: Modular Monolith to Microservices</a></h4>
<p>Start with a well-structured monolith and evolve to microservices based on actual scaling needs, not theoretical benefits.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="c1"># Phase 1: Modular Monolith with Clear Boundaries</span>
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ECommerceApplication</span><span class="p">:</span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Modular monolith with clear service boundaries&quot;&quot;&quot;</span>
<a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a>
<a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a>        <span class="c1"># Each module is independently deployable logic</span>
<a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_service</span> <span class="o">=</span> <span class="n">OrderService</span><span class="p">()</span>
<a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span> <span class="o">=</span> <span class="n">InventoryService</span><span class="p">()</span>
<a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payment_service</span> <span class="o">=</span> <span class="n">PaymentService</span><span class="p">()</span>
<a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span> <span class="o">=</span> <span class="n">NotificationService</span><span class="p">()</span>
<a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a>
<a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_request</span><span class="p">:</span> <span class="n">CreateOrderRequest</span><span class="p">):</span>
<a id="__codelineno-92-13" name="__codelineno-92-13" href="#__codelineno-92-13"></a>        <span class="c1"># Cross-module coordination within single process</span>
<a id="__codelineno-92-14" name="__codelineno-92-14" href="#__codelineno-92-14"></a>        <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_service</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">order_request</span><span class="p">)</span>
<a id="__codelineno-92-15" name="__codelineno-92-15" href="#__codelineno-92-15"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">reserve_items</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-92-16" name="__codelineno-92-16" href="#__codelineno-92-16"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_service</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">payment_info</span><span class="p">)</span>
<a id="__codelineno-92-17" name="__codelineno-92-17" href="#__codelineno-92-17"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span><span class="o">.</span><span class="n">send_confirmation</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-92-18" name="__codelineno-92-18" href="#__codelineno-92-18"></a>        <span class="k">return</span> <span class="n">order</span>
<a id="__codelineno-92-19" name="__codelineno-92-19" href="#__codelineno-92-19"></a>
<a id="__codelineno-92-20" name="__codelineno-92-20" href="#__codelineno-92-20"></a><span class="c1"># Phase 2: Extract High-Value Services</span>
<a id="__codelineno-92-21" name="__codelineno-92-21" href="#__codelineno-92-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">DistributedOrderProcessor</span><span class="p">:</span>
<a id="__codelineno-92-22" name="__codelineno-92-22" href="#__codelineno-92-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Hybrid approach: some services extracted, others remain monolithic&quot;&quot;&quot;</span>
<a id="__codelineno-92-23" name="__codelineno-92-23" href="#__codelineno-92-23"></a>
<a id="__codelineno-92-24" name="__codelineno-92-24" href="#__codelineno-92-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-92-25" name="__codelineno-92-25" href="#__codelineno-92-25"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-92-26" name="__codelineno-92-26" href="#__codelineno-92-26"></a>        <span class="n">order_service</span><span class="p">:</span> <span class="n">OrderService</span><span class="p">,</span>  <span class="c1"># Still in monolith</span>
<a id="__codelineno-92-27" name="__codelineno-92-27" href="#__codelineno-92-27"></a>        <span class="n">inventory_service</span><span class="p">:</span> <span class="n">InventoryService</span><span class="p">,</span>  <span class="c1"># Still in monolith</span>
<a id="__codelineno-92-28" name="__codelineno-92-28" href="#__codelineno-92-28"></a>        <span class="n">payment_service</span><span class="p">:</span> <span class="n">PaymentServiceClient</span><span class="p">,</span>  <span class="c1"># Extracted microservice</span>
<a id="__codelineno-92-29" name="__codelineno-92-29" href="#__codelineno-92-29"></a>        <span class="n">notification_service</span><span class="p">:</span> <span class="n">NotificationServiceClient</span>  <span class="c1"># Extracted microservice</span>
<a id="__codelineno-92-30" name="__codelineno-92-30" href="#__codelineno-92-30"></a>    <span class="p">):</span>
<a id="__codelineno-92-31" name="__codelineno-92-31" href="#__codelineno-92-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_service</span> <span class="o">=</span> <span class="n">order_service</span>
<a id="__codelineno-92-32" name="__codelineno-92-32" href="#__codelineno-92-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span> <span class="o">=</span> <span class="n">inventory_service</span>
<a id="__codelineno-92-33" name="__codelineno-92-33" href="#__codelineno-92-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payment_service</span> <span class="o">=</span> <span class="n">payment_service</span>
<a id="__codelineno-92-34" name="__codelineno-92-34" href="#__codelineno-92-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span> <span class="o">=</span> <span class="n">notification_service</span>
<a id="__codelineno-92-35" name="__codelineno-92-35" href="#__codelineno-92-35"></a>
<a id="__codelineno-92-36" name="__codelineno-92-36" href="#__codelineno-92-36"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_request</span><span class="p">:</span> <span class="n">CreateOrderRequest</span><span class="p">):</span>
<a id="__codelineno-92-37" name="__codelineno-92-37" href="#__codelineno-92-37"></a>        <span class="c1"># Mixed local and remote calls</span>
<a id="__codelineno-92-38" name="__codelineno-92-38" href="#__codelineno-92-38"></a>        <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_service</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">order_request</span><span class="p">)</span>
<a id="__codelineno-92-39" name="__codelineno-92-39" href="#__codelineno-92-39"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">reserve_items</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-92-40" name="__codelineno-92-40" href="#__codelineno-92-40"></a>
<a id="__codelineno-92-41" name="__codelineno-92-41" href="#__codelineno-92-41"></a>        <span class="c1"># Remote service calls</span>
<a id="__codelineno-92-42" name="__codelineno-92-42" href="#__codelineno-92-42"></a>        <span class="n">payment_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_service</span><span class="o">.</span><span class="n">process_payment</span><span class="p">({</span>
<a id="__codelineno-92-43" name="__codelineno-92-43" href="#__codelineno-92-43"></a>            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="p">,</span>
<a id="__codelineno-92-44" name="__codelineno-92-44" href="#__codelineno-92-44"></a>            <span class="s1">&#39;payment_method&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">payment_method_id</span>
<a id="__codelineno-92-45" name="__codelineno-92-45" href="#__codelineno-92-45"></a>        <span class="p">})</span>
<a id="__codelineno-92-46" name="__codelineno-92-46" href="#__codelineno-92-46"></a>
<a id="__codelineno-92-47" name="__codelineno-92-47" href="#__codelineno-92-47"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">notification_service</span><span class="o">.</span><span class="n">send_confirmation</span><span class="p">({</span>
<a id="__codelineno-92-48" name="__codelineno-92-48" href="#__codelineno-92-48"></a>            <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-92-49" name="__codelineno-92-49" href="#__codelineno-92-49"></a>            <span class="s1">&#39;customer_email&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">customer_email</span>
<a id="__codelineno-92-50" name="__codelineno-92-50" href="#__codelineno-92-50"></a>        <span class="p">})</span>
<a id="__codelineno-92-51" name="__codelineno-92-51" href="#__codelineno-92-51"></a>
<a id="__codelineno-92-52" name="__codelineno-92-52" href="#__codelineno-92-52"></a>        <span class="k">return</span> <span class="n">order</span>
<a id="__codelineno-92-53" name="__codelineno-92-53" href="#__codelineno-92-53"></a>
<a id="__codelineno-92-54" name="__codelineno-92-54" href="#__codelineno-92-54"></a><span class="c1"># Phase 3: Full Microservices with Orchestration</span>
<a id="__codelineno-92-55" name="__codelineno-92-55" href="#__codelineno-92-55"></a><span class="k">class</span><span class="w"> </span><span class="nc">MicroservicesOrderProcessor</span><span class="p">:</span>
<a id="__codelineno-92-56" name="__codelineno-92-56" href="#__codelineno-92-56"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Full microservices architecture with proper orchestration&quot;&quot;&quot;</span>
<a id="__codelineno-92-57" name="__codelineno-92-57" href="#__codelineno-92-57"></a>
<a id="__codelineno-92-58" name="__codelineno-92-58" href="#__codelineno-92-58"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga_orchestrator</span><span class="p">:</span> <span class="n">SagaOrchestrator</span><span class="p">):</span>
<a id="__codelineno-92-59" name="__codelineno-92-59" href="#__codelineno-92-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">saga_orchestrator</span> <span class="o">=</span> <span class="n">saga_orchestrator</span>
<a id="__codelineno-92-60" name="__codelineno-92-60" href="#__codelineno-92-60"></a>
<a id="__codelineno-92-61" name="__codelineno-92-61" href="#__codelineno-92-61"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_request</span><span class="p">:</span> <span class="n">CreateOrderRequest</span><span class="p">):</span>
<a id="__codelineno-92-62" name="__codelineno-92-62" href="#__codelineno-92-62"></a>        <span class="c1"># Use saga pattern for distributed transaction management</span>
<a id="__codelineno-92-63" name="__codelineno-92-63" href="#__codelineno-92-63"></a>        <span class="n">saga</span> <span class="o">=</span> <span class="n">OrderProcessingSaga</span><span class="p">()</span>
<a id="__codelineno-92-64" name="__codelineno-92-64" href="#__codelineno-92-64"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">saga_orchestrator</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">saga</span><span class="p">,</span> <span class="n">order_request</span><span class="p">)</span>
<a id="__codelineno-92-65" name="__codelineno-92-65" href="#__codelineno-92-65"></a>
<a id="__codelineno-92-66" name="__codelineno-92-66" href="#__codelineno-92-66"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderProcessingSaga</span><span class="p">:</span>
<a id="__codelineno-92-67" name="__codelineno-92-67" href="#__codelineno-92-67"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Saga pattern for distributed order processing&quot;&quot;&quot;</span>
<a id="__codelineno-92-68" name="__codelineno-92-68" href="#__codelineno-92-68"></a>
<a id="__codelineno-92-69" name="__codelineno-92-69" href="#__codelineno-92-69"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-92-70" name="__codelineno-92-70" href="#__codelineno-92-70"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-92-71" name="__codelineno-92-71" href="#__codelineno-92-71"></a>            <span class="n">SagaStep</span><span class="p">(</span><span class="s1">&#39;create_order&#39;</span><span class="p">,</span> <span class="s1">&#39;cancel_order&#39;</span><span class="p">),</span>
<a id="__codelineno-92-72" name="__codelineno-92-72" href="#__codelineno-92-72"></a>            <span class="n">SagaStep</span><span class="p">(</span><span class="s1">&#39;reserve_inventory&#39;</span><span class="p">,</span> <span class="s1">&#39;release_inventory&#39;</span><span class="p">),</span>
<a id="__codelineno-92-73" name="__codelineno-92-73" href="#__codelineno-92-73"></a>            <span class="n">SagaStep</span><span class="p">(</span><span class="s1">&#39;process_payment&#39;</span><span class="p">,</span> <span class="s1">&#39;refund_payment&#39;</span><span class="p">),</span>
<a id="__codelineno-92-74" name="__codelineno-92-74" href="#__codelineno-92-74"></a>            <span class="n">SagaStep</span><span class="p">(</span><span class="s1">&#39;send_confirmation&#39;</span><span class="p">,</span> <span class="s1">&#39;send_cancellation&#39;</span><span class="p">)</span>
<a id="__codelineno-92-75" name="__codelineno-92-75" href="#__codelineno-92-75"></a>        <span class="p">]</span>
<a id="__codelineno-92-76" name="__codelineno-92-76" href="#__codelineno-92-76"></a>
<a id="__codelineno-92-77" name="__codelineno-92-77" href="#__codelineno-92-77"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">SagaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderResult</span><span class="p">:</span>
<a id="__codelineno-92-78" name="__codelineno-92-78" href="#__codelineno-92-78"></a>        <span class="n">completed_steps</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-92-79" name="__codelineno-92-79" href="#__codelineno-92-79"></a>
<a id="__codelineno-92-80" name="__codelineno-92-80" href="#__codelineno-92-80"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-92-81" name="__codelineno-92-81" href="#__codelineno-92-81"></a>            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
<a id="__codelineno-92-82" name="__codelineno-92-82" href="#__codelineno-92-82"></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">step</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-92-83" name="__codelineno-92-83" href="#__codelineno-92-83"></a>                <span class="n">completed_steps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">step</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
<a id="__codelineno-92-84" name="__codelineno-92-84" href="#__codelineno-92-84"></a>                <span class="n">context</span><span class="o">.</span><span class="n">add_result</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<a id="__codelineno-92-85" name="__codelineno-92-85" href="#__codelineno-92-85"></a>
<a id="__codelineno-92-86" name="__codelineno-92-86" href="#__codelineno-92-86"></a>            <span class="k">return</span> <span class="n">OrderResult</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-92-87" name="__codelineno-92-87" href="#__codelineno-92-87"></a>
<a id="__codelineno-92-88" name="__codelineno-92-88" href="#__codelineno-92-88"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-92-89" name="__codelineno-92-89" href="#__codelineno-92-89"></a>            <span class="c1"># Compensate completed steps in reverse order</span>
<a id="__codelineno-92-90" name="__codelineno-92-90" href="#__codelineno-92-90"></a>            <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">completed_steps</span><span class="p">):</span>
<a id="__codelineno-92-91" name="__codelineno-92-91" href="#__codelineno-92-91"></a>                <span class="k">await</span> <span class="n">step</span><span class="o">.</span><span class="n">compensate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<a id="__codelineno-92-92" name="__codelineno-92-92" href="#__codelineno-92-92"></a>
<a id="__codelineno-92-93" name="__codelineno-92-93" href="#__codelineno-92-93"></a>            <span class="k">return</span> <span class="n">OrderResult</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</code></pre></div>
<h4 id="pattern-2-data-architecture-evolution"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#pattern-2-data-architecture-evolution">Pattern 2: Data Architecture Evolution</a></h4>
<p>Data architecture often needs the most careful evolution, as data migration is risky and expensive.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="c1"># Evolution 1: Single Database with Domain Tables</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">SingleDatabaseRepository</span><span class="p">:</span>
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Traditional approach with domain-specific tables&quot;&quot;&quot;</span>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a>
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
<a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_session</span>
<a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a>
<a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>
<a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a>        <span class="c1"># Direct table mapping</span>
<a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a>        <span class="n">order_record</span> <span class="o">=</span> <span class="n">OrderRecord</span><span class="p">(</span>
<a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-93-12" name="__codelineno-93-12" href="#__codelineno-93-12"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-93-13" name="__codelineno-93-13" href="#__codelineno-93-13"></a>            <span class="n">status</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-93-14" name="__codelineno-93-14" href="#__codelineno-93-14"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span>
<a id="__codelineno-93-15" name="__codelineno-93-15" href="#__codelineno-93-15"></a>        <span class="p">)</span>
<a id="__codelineno-93-16" name="__codelineno-93-16" href="#__codelineno-93-16"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">order_record</span><span class="p">)</span>
<a id="__codelineno-93-17" name="__codelineno-93-17" href="#__codelineno-93-17"></a>
<a id="__codelineno-93-18" name="__codelineno-93-18" href="#__codelineno-93-18"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<a id="__codelineno-93-19" name="__codelineno-93-19" href="#__codelineno-93-19"></a>            <span class="n">item_record</span> <span class="o">=</span> <span class="n">OrderItemRecord</span><span class="p">(</span>
<a id="__codelineno-93-20" name="__codelineno-93-20" href="#__codelineno-93-20"></a>                <span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-93-21" name="__codelineno-93-21" href="#__codelineno-93-21"></a>                <span class="n">product_id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span>
<a id="__codelineno-93-22" name="__codelineno-93-22" href="#__codelineno-93-22"></a>                <span class="n">quantity</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-93-23" name="__codelineno-93-23" href="#__codelineno-93-23"></a>                <span class="n">unit_price</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span><span class="o">.</span><span class="n">amount</span>
<a id="__codelineno-93-24" name="__codelineno-93-24" href="#__codelineno-93-24"></a>            <span class="p">)</span>
<a id="__codelineno-93-25" name="__codelineno-93-25" href="#__codelineno-93-25"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">item_record</span><span class="p">)</span>
<a id="__codelineno-93-26" name="__codelineno-93-26" href="#__codelineno-93-26"></a>
<a id="__codelineno-93-27" name="__codelineno-93-27" href="#__codelineno-93-27"></a><span class="c1"># Evolution 2: Read/Write Separation (CQRS)</span>
<a id="__codelineno-93-28" name="__codelineno-93-28" href="#__codelineno-93-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">CQRSOrderRepository</span><span class="p">:</span>
<a id="__codelineno-93-29" name="__codelineno-93-29" href="#__codelineno-93-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Separate read and write models for better performance&quot;&quot;&quot;</span>
<a id="__codelineno-93-30" name="__codelineno-93-30" href="#__codelineno-93-30"></a>
<a id="__codelineno-93-31" name="__codelineno-93-31" href="#__codelineno-93-31"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_db</span><span class="p">,</span> <span class="n">read_db</span><span class="p">,</span> <span class="n">event_bus</span><span class="p">):</span>
<a id="__codelineno-93-32" name="__codelineno-93-32" href="#__codelineno-93-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">write_db</span> <span class="o">=</span> <span class="n">write_db</span>
<a id="__codelineno-93-33" name="__codelineno-93-33" href="#__codelineno-93-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">read_db</span> <span class="o">=</span> <span class="n">read_db</span>
<a id="__codelineno-93-34" name="__codelineno-93-34" href="#__codelineno-93-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span> <span class="o">=</span> <span class="n">event_bus</span>
<a id="__codelineno-93-35" name="__codelineno-93-35" href="#__codelineno-93-35"></a>
<a id="__codelineno-93-36" name="__codelineno-93-36" href="#__codelineno-93-36"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>
<a id="__codelineno-93-37" name="__codelineno-93-37" href="#__codelineno-93-37"></a>        <span class="c1"># Write to normalized tables</span>
<a id="__codelineno-93-38" name="__codelineno-93-38" href="#__codelineno-93-38"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_db</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-93-39" name="__codelineno-93-39" href="#__codelineno-93-39"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_order_aggregate</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-93-40" name="__codelineno-93-40" href="#__codelineno-93-40"></a>
<a id="__codelineno-93-41" name="__codelineno-93-41" href="#__codelineno-93-41"></a>        <span class="c1"># Publish event for read model update</span>
<a id="__codelineno-93-42" name="__codelineno-93-42" href="#__codelineno-93-42"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
<a id="__codelineno-93-43" name="__codelineno-93-43" href="#__codelineno-93-43"></a>            <span class="n">OrderCreatedEvent</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">order_data</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
<a id="__codelineno-93-44" name="__codelineno-93-44" href="#__codelineno-93-44"></a>        <span class="p">)</span>
<a id="__codelineno-93-45" name="__codelineno-93-45" href="#__codelineno-93-45"></a>
<a id="__codelineno-93-46" name="__codelineno-93-46" href="#__codelineno-93-46"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_order_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderSummary</span><span class="p">:</span>
<a id="__codelineno-93-47" name="__codelineno-93-47" href="#__codelineno-93-47"></a>        <span class="c1"># Read from denormalized view</span>
<a id="__codelineno-93-48" name="__codelineno-93-48" href="#__codelineno-93-48"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_db</span><span class="o">.</span><span class="n">get_order_summary</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-93-49" name="__codelineno-93-49" href="#__codelineno-93-49"></a>
<a id="__codelineno-93-50" name="__codelineno-93-50" href="#__codelineno-93-50"></a><span class="c1"># Evolution 3: Event Sourcing for Complete Auditability</span>
<a id="__codelineno-93-51" name="__codelineno-93-51" href="#__codelineno-93-51"></a><span class="k">class</span><span class="w"> </span><span class="nc">EventSourcedOrderRepository</span><span class="p">:</span>
<a id="__codelineno-93-52" name="__codelineno-93-52" href="#__codelineno-93-52"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Full event sourcing for complex business requirements&quot;&quot;&quot;</span>
<a id="__codelineno-93-53" name="__codelineno-93-53" href="#__codelineno-93-53"></a>
<a id="__codelineno-93-54" name="__codelineno-93-54" href="#__codelineno-93-54"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_store</span><span class="p">,</span> <span class="n">snapshot_store</span><span class="p">):</span>
<a id="__codelineno-93-55" name="__codelineno-93-55" href="#__codelineno-93-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>
<a id="__codelineno-93-56" name="__codelineno-93-56" href="#__codelineno-93-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_store</span> <span class="o">=</span> <span class="n">snapshot_store</span>
<a id="__codelineno-93-57" name="__codelineno-93-57" href="#__codelineno-93-57"></a>
<a id="__codelineno-93-58" name="__codelineno-93-58" href="#__codelineno-93-58"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>
<a id="__codelineno-93-59" name="__codelineno-93-59" href="#__codelineno-93-59"></a>        <span class="c1"># Save domain events</span>
<a id="__codelineno-93-60" name="__codelineno-93-60" href="#__codelineno-93-60"></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">get_uncommitted_events</span><span class="p">()</span>
<a id="__codelineno-93-61" name="__codelineno-93-61" href="#__codelineno-93-61"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">append_events</span><span class="p">(</span>
<a id="__codelineno-93-62" name="__codelineno-93-62" href="#__codelineno-93-62"></a>            <span class="n">stream_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-93-63" name="__codelineno-93-63" href="#__codelineno-93-63"></a>            <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">,</span>
<a id="__codelineno-93-64" name="__codelineno-93-64" href="#__codelineno-93-64"></a>            <span class="n">expected_version</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">version</span>
<a id="__codelineno-93-65" name="__codelineno-93-65" href="#__codelineno-93-65"></a>        <span class="p">)</span>
<a id="__codelineno-93-66" name="__codelineno-93-66" href="#__codelineno-93-66"></a>
<a id="__codelineno-93-67" name="__codelineno-93-67" href="#__codelineno-93-67"></a>        <span class="c1"># Update snapshot if needed</span>
<a id="__codelineno-93-68" name="__codelineno-93-68" href="#__codelineno-93-68"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Snapshot every 10 events</span>
<a id="__codelineno-93-69" name="__codelineno-93-69" href="#__codelineno-93-69"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_store</span><span class="o">.</span><span class="n">save_snapshot</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-93-70" name="__codelineno-93-70" href="#__codelineno-93-70"></a>
<a id="__codelineno-93-71" name="__codelineno-93-71" href="#__codelineno-93-71"></a>        <span class="n">order</span><span class="o">.</span><span class="n">mark_events_as_committed</span><span class="p">()</span>
<a id="__codelineno-93-72" name="__codelineno-93-72" href="#__codelineno-93-72"></a>
<a id="__codelineno-93-73" name="__codelineno-93-73" href="#__codelineno-93-73"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-93-74" name="__codelineno-93-74" href="#__codelineno-93-74"></a>        <span class="c1"># Try to load from snapshot first</span>
<a id="__codelineno-93-75" name="__codelineno-93-75" href="#__codelineno-93-75"></a>        <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_store</span><span class="o">.</span><span class="n">get_snapshot</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-93-76" name="__codelineno-93-76" href="#__codelineno-93-76"></a>
<a id="__codelineno-93-77" name="__codelineno-93-77" href="#__codelineno-93-77"></a>        <span class="k">if</span> <span class="n">snapshot</span><span class="p">:</span>
<a id="__codelineno-93-78" name="__codelineno-93-78" href="#__codelineno-93-78"></a>            <span class="n">order</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">order</span>
<a id="__codelineno-93-79" name="__codelineno-93-79" href="#__codelineno-93-79"></a>            <span class="n">from_version</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-93-80" name="__codelineno-93-80" href="#__codelineno-93-80"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-93-81" name="__codelineno-93-81" href="#__codelineno-93-81"></a>            <span class="n">order</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-93-82" name="__codelineno-93-82" href="#__codelineno-93-82"></a>            <span class="n">from_version</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-93-83" name="__codelineno-93-83" href="#__codelineno-93-83"></a>
<a id="__codelineno-93-84" name="__codelineno-93-84" href="#__codelineno-93-84"></a>        <span class="c1"># Apply events since snapshot</span>
<a id="__codelineno-93-85" name="__codelineno-93-85" href="#__codelineno-93-85"></a>        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">from_version</span><span class="p">)</span>
<a id="__codelineno-93-86" name="__codelineno-93-86" href="#__codelineno-93-86"></a>
<a id="__codelineno-93-87" name="__codelineno-93-87" href="#__codelineno-93-87"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span> <span class="ow">and</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-93-88" name="__codelineno-93-88" href="#__codelineno-93-88"></a>            <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">from_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-93-89" name="__codelineno-93-89" href="#__codelineno-93-89"></a>        <span class="k">elif</span> <span class="n">order</span> <span class="ow">and</span> <span class="n">events</span><span class="p">:</span>
<a id="__codelineno-93-90" name="__codelineno-93-90" href="#__codelineno-93-90"></a>            <span class="n">order</span><span class="o">.</span><span class="n">apply_events</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-93-91" name="__codelineno-93-91" href="#__codelineno-93-91"></a>
<a id="__codelineno-93-92" name="__codelineno-93-92" href="#__codelineno-93-92"></a>        <span class="k">return</span> <span class="n">order</span>
</code></pre></div>
<h4 id="pattern-3-api-evolution-strategies"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#pattern-3-api-evolution-strategies">Pattern 3: API Evolution Strategies</a></h4>
<p>APIs must evolve without breaking existing clients, requiring careful versioning and backward compatibility strategies.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="c1"># API Versioning Strategy</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a>
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">APIVersion</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a>    <span class="n">V1</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a>    <span class="n">V2</span> <span class="o">=</span> <span class="s2">&quot;2.0&quot;</span>
<a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>    <span class="n">V3</span> <span class="o">=</span> <span class="s2">&quot;3.0&quot;</span>
<a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a>
<a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a><span class="c1"># Version 1: Original API</span>
<a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderResponseV1</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-94-13" name="__codelineno-94-13" href="#__codelineno-94-13"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-94-14" name="__codelineno-94-14" href="#__codelineno-94-14"></a>    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-94-15" name="__codelineno-94-15" href="#__codelineno-94-15"></a>    <span class="n">total</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-94-16" name="__codelineno-94-16" href="#__codelineno-94-16"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<a id="__codelineno-94-17" name="__codelineno-94-17" href="#__codelineno-94-17"></a>
<a id="__codelineno-94-18" name="__codelineno-94-18" href="#__codelineno-94-18"></a><span class="c1"># Version 2: Enhanced with additional fields (backward compatible)</span>
<a id="__codelineno-94-19" name="__codelineno-94-19" href="#__codelineno-94-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderResponseV2</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-94-20" name="__codelineno-94-20" href="#__codelineno-94-20"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-94-21" name="__codelineno-94-21" href="#__codelineno-94-21"></a>    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-94-22" name="__codelineno-94-22" href="#__codelineno-94-22"></a>    <span class="n">total</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-94-23" name="__codelineno-94-23" href="#__codelineno-94-23"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">)</span>  <span class="c1"># New field with default</span>
<a id="__codelineno-94-24" name="__codelineno-94-24" href="#__codelineno-94-24"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<a id="__codelineno-94-25" name="__codelineno-94-25" href="#__codelineno-94-25"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># New optional field</span>
<a id="__codelineno-94-26" name="__codelineno-94-26" href="#__codelineno-94-26"></a>
<a id="__codelineno-94-27" name="__codelineno-94-27" href="#__codelineno-94-27"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-94-28" name="__codelineno-94-28" href="#__codelineno-94-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_v1</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v1_response</span><span class="p">:</span> <span class="n">OrderResponseV1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderResponseV2&#39;</span><span class="p">:</span>
<a id="__codelineno-94-29" name="__codelineno-94-29" href="#__codelineno-94-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert V1 response to V2 format&quot;&quot;&quot;</span>
<a id="__codelineno-94-30" name="__codelineno-94-30" href="#__codelineno-94-30"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-94-31" name="__codelineno-94-31" href="#__codelineno-94-31"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">v1_response</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-94-32" name="__codelineno-94-32" href="#__codelineno-94-32"></a>            <span class="n">status</span><span class="o">=</span><span class="n">v1_response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-94-33" name="__codelineno-94-33" href="#__codelineno-94-33"></a>            <span class="n">total</span><span class="o">=</span><span class="n">v1_response</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-94-34" name="__codelineno-94-34" href="#__codelineno-94-34"></a>            <span class="n">currency</span><span class="o">=</span><span class="s2">&quot;USD&quot;</span><span class="p">,</span>  <span class="c1"># Default for legacy data</span>
<a id="__codelineno-94-35" name="__codelineno-94-35" href="#__codelineno-94-35"></a>            <span class="n">items</span><span class="o">=</span><span class="n">v1_response</span><span class="o">.</span><span class="n">items</span>
<a id="__codelineno-94-36" name="__codelineno-94-36" href="#__codelineno-94-36"></a>        <span class="p">)</span>
<a id="__codelineno-94-37" name="__codelineno-94-37" href="#__codelineno-94-37"></a>
<a id="__codelineno-94-38" name="__codelineno-94-38" href="#__codelineno-94-38"></a><span class="c1"># Version 3: Breaking changes with new structure</span>
<a id="__codelineno-94-39" name="__codelineno-94-39" href="#__codelineno-94-39"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderResponseV3</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-94-40" name="__codelineno-94-40" href="#__codelineno-94-40"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Renamed field</span>
<a id="__codelineno-94-41" name="__codelineno-94-41" href="#__codelineno-94-41"></a>    <span class="n">order_status</span><span class="p">:</span> <span class="n">OrderStatus</span>  <span class="c1"># Changed to enum</span>
<a id="__codelineno-94-42" name="__codelineno-94-42" href="#__codelineno-94-42"></a>    <span class="n">pricing</span><span class="p">:</span> <span class="n">OrderPricing</span>  <span class="c1"># Nested object</span>
<a id="__codelineno-94-43" name="__codelineno-94-43" href="#__codelineno-94-43"></a>    <span class="n">line_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderLineItem</span><span class="p">]</span>  <span class="c1"># Structured items</span>
<a id="__codelineno-94-44" name="__codelineno-94-44" href="#__codelineno-94-44"></a>
<a id="__codelineno-94-45" name="__codelineno-94-45" href="#__codelineno-94-45"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-94-46" name="__codelineno-94-46" href="#__codelineno-94-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_v2</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v2_response</span><span class="p">:</span> <span class="n">OrderResponseV2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderResponseV3&#39;</span><span class="p">:</span>
<a id="__codelineno-94-47" name="__codelineno-94-47" href="#__codelineno-94-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert V2 response to V3 format&quot;&quot;&quot;</span>
<a id="__codelineno-94-48" name="__codelineno-94-48" href="#__codelineno-94-48"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-94-49" name="__codelineno-94-49" href="#__codelineno-94-49"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">v2_response</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-94-50" name="__codelineno-94-50" href="#__codelineno-94-50"></a>            <span class="n">order_status</span><span class="o">=</span><span class="n">OrderStatus</span><span class="p">(</span><span class="n">v2_response</span><span class="o">.</span><span class="n">status</span><span class="p">),</span>
<a id="__codelineno-94-51" name="__codelineno-94-51" href="#__codelineno-94-51"></a>            <span class="n">pricing</span><span class="o">=</span><span class="n">OrderPricing</span><span class="p">(</span>
<a id="__codelineno-94-52" name="__codelineno-94-52" href="#__codelineno-94-52"></a>                <span class="n">total</span><span class="o">=</span><span class="n">v2_response</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-94-53" name="__codelineno-94-53" href="#__codelineno-94-53"></a>                <span class="n">currency</span><span class="o">=</span><span class="n">v2_response</span><span class="o">.</span><span class="n">currency</span>
<a id="__codelineno-94-54" name="__codelineno-94-54" href="#__codelineno-94-54"></a>            <span class="p">),</span>
<a id="__codelineno-94-55" name="__codelineno-94-55" href="#__codelineno-94-55"></a>            <span class="n">line_items</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-94-56" name="__codelineno-94-56" href="#__codelineno-94-56"></a>                <span class="n">OrderLineItem</span><span class="p">(</span><span class="o">**</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v2_response</span><span class="o">.</span><span class="n">items</span>
<a id="__codelineno-94-57" name="__codelineno-94-57" href="#__codelineno-94-57"></a>            <span class="p">]</span>
<a id="__codelineno-94-58" name="__codelineno-94-58" href="#__codelineno-94-58"></a>        <span class="p">)</span>
<a id="__codelineno-94-59" name="__codelineno-94-59" href="#__codelineno-94-59"></a>
<a id="__codelineno-94-60" name="__codelineno-94-60" href="#__codelineno-94-60"></a><span class="k">class</span><span class="w"> </span><span class="nc">VersionedOrderController</span><span class="p">:</span>
<a id="__codelineno-94-61" name="__codelineno-94-61" href="#__codelineno-94-61"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Controller that supports multiple API versions&quot;&quot;&quot;</span>
<a id="__codelineno-94-62" name="__codelineno-94-62" href="#__codelineno-94-62"></a>
<a id="__codelineno-94-63" name="__codelineno-94-63" href="#__codelineno-94-63"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_service</span><span class="p">:</span> <span class="n">OrderService</span><span class="p">):</span>
<a id="__codelineno-94-64" name="__codelineno-94-64" href="#__codelineno-94-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_service</span> <span class="o">=</span> <span class="n">order_service</span>
<a id="__codelineno-94-65" name="__codelineno-94-65" href="#__codelineno-94-65"></a>
<a id="__codelineno-94-66" name="__codelineno-94-66" href="#__codelineno-94-66"></a>    <span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/orders/</span><span class="si">{order_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-94-67" name="__codelineno-94-67" href="#__codelineno-94-67"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_order</span><span class="p">(</span>
<a id="__codelineno-94-68" name="__codelineno-94-68" href="#__codelineno-94-68"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-94-69" name="__codelineno-94-69" href="#__codelineno-94-69"></a>        <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-94-70" name="__codelineno-94-70" href="#__codelineno-94-70"></a>        <span class="n">version</span><span class="p">:</span> <span class="n">APIVersion</span> <span class="o">=</span> <span class="n">APIVersion</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span>
<a id="__codelineno-94-71" name="__codelineno-94-71" href="#__codelineno-94-71"></a>        <span class="n">accept_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-94-72" name="__codelineno-94-72" href="#__codelineno-94-72"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">OrderResponseV1</span><span class="p">,</span> <span class="n">OrderResponseV2</span><span class="p">,</span> <span class="n">OrderResponseV3</span><span class="p">]:</span>
<a id="__codelineno-94-73" name="__codelineno-94-73" href="#__codelineno-94-73"></a>
<a id="__codelineno-94-74" name="__codelineno-94-74" href="#__codelineno-94-74"></a>        <span class="c1"># Determine version from header or parameter</span>
<a id="__codelineno-94-75" name="__codelineno-94-75" href="#__codelineno-94-75"></a>        <span class="n">requested_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_version</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">accept_version</span><span class="p">)</span>
<a id="__codelineno-94-76" name="__codelineno-94-76" href="#__codelineno-94-76"></a>
<a id="__codelineno-94-77" name="__codelineno-94-77" href="#__codelineno-94-77"></a>        <span class="c1"># Get order from service (version-agnostic)</span>
<a id="__codelineno-94-78" name="__codelineno-94-78" href="#__codelineno-94-78"></a>        <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_service</span><span class="o">.</span><span class="n">get_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-94-79" name="__codelineno-94-79" href="#__codelineno-94-79"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="p">:</span>
<a id="__codelineno-94-80" name="__codelineno-94-80" href="#__codelineno-94-80"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Order not found&quot;</span><span class="p">)</span>
<a id="__codelineno-94-81" name="__codelineno-94-81" href="#__codelineno-94-81"></a>
<a id="__codelineno-94-82" name="__codelineno-94-82" href="#__codelineno-94-82"></a>        <span class="c1"># Convert to appropriate response format</span>
<a id="__codelineno-94-83" name="__codelineno-94-83" href="#__codelineno-94-83"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_response</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">requested_version</span><span class="p">)</span>
<a id="__codelineno-94-84" name="__codelineno-94-84" href="#__codelineno-94-84"></a>
<a id="__codelineno-94-85" name="__codelineno-94-85" href="#__codelineno-94-85"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_determine_version</span><span class="p">(</span>
<a id="__codelineno-94-86" name="__codelineno-94-86" href="#__codelineno-94-86"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-94-87" name="__codelineno-94-87" href="#__codelineno-94-87"></a>        <span class="n">version_param</span><span class="p">:</span> <span class="n">APIVersion</span><span class="p">,</span> 
<a id="__codelineno-94-88" name="__codelineno-94-88" href="#__codelineno-94-88"></a>        <span class="n">accept_header</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-94-89" name="__codelineno-94-89" href="#__codelineno-94-89"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">APIVersion</span><span class="p">:</span>
<a id="__codelineno-94-90" name="__codelineno-94-90" href="#__codelineno-94-90"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine API version from various sources&quot;&quot;&quot;</span>
<a id="__codelineno-94-91" name="__codelineno-94-91" href="#__codelineno-94-91"></a>
<a id="__codelineno-94-92" name="__codelineno-94-92" href="#__codelineno-94-92"></a>        <span class="k">if</span> <span class="n">accept_header</span><span class="p">:</span>
<a id="__codelineno-94-93" name="__codelineno-94-93" href="#__codelineno-94-93"></a>            <span class="c1"># Parse from Accept header: application/json; version=2.0</span>
<a id="__codelineno-94-94" name="__codelineno-94-94" href="#__codelineno-94-94"></a>            <span class="k">if</span> <span class="s2">&quot;version=1.0&quot;</span> <span class="ow">in</span> <span class="n">accept_header</span><span class="p">:</span>
<a id="__codelineno-94-95" name="__codelineno-94-95" href="#__codelineno-94-95"></a>                <span class="k">return</span> <span class="n">APIVersion</span><span class="o">.</span><span class="n">V1</span>
<a id="__codelineno-94-96" name="__codelineno-94-96" href="#__codelineno-94-96"></a>            <span class="k">elif</span> <span class="s2">&quot;version=2.0&quot;</span> <span class="ow">in</span> <span class="n">accept_header</span><span class="p">:</span>
<a id="__codelineno-94-97" name="__codelineno-94-97" href="#__codelineno-94-97"></a>                <span class="k">return</span> <span class="n">APIVersion</span><span class="o">.</span><span class="n">V2</span>
<a id="__codelineno-94-98" name="__codelineno-94-98" href="#__codelineno-94-98"></a>            <span class="k">elif</span> <span class="s2">&quot;version=3.0&quot;</span> <span class="ow">in</span> <span class="n">accept_header</span><span class="p">:</span>
<a id="__codelineno-94-99" name="__codelineno-94-99" href="#__codelineno-94-99"></a>                <span class="k">return</span> <span class="n">APIVersion</span><span class="o">.</span><span class="n">V3</span>
<a id="__codelineno-94-100" name="__codelineno-94-100" href="#__codelineno-94-100"></a>
<a id="__codelineno-94-101" name="__codelineno-94-101" href="#__codelineno-94-101"></a>        <span class="k">return</span> <span class="n">version_param</span>
<a id="__codelineno-94-102" name="__codelineno-94-102" href="#__codelineno-94-102"></a>
<a id="__codelineno-94-103" name="__codelineno-94-103" href="#__codelineno-94-103"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_format_response</span><span class="p">(</span>
<a id="__codelineno-94-104" name="__codelineno-94-104" href="#__codelineno-94-104"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-94-105" name="__codelineno-94-105" href="#__codelineno-94-105"></a>        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span> 
<a id="__codelineno-94-106" name="__codelineno-94-106" href="#__codelineno-94-106"></a>        <span class="n">version</span><span class="p">:</span> <span class="n">APIVersion</span>
<a id="__codelineno-94-107" name="__codelineno-94-107" href="#__codelineno-94-107"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">OrderResponseV1</span><span class="p">,</span> <span class="n">OrderResponseV2</span><span class="p">,</span> <span class="n">OrderResponseV3</span><span class="p">]:</span>
<a id="__codelineno-94-108" name="__codelineno-94-108" href="#__codelineno-94-108"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format order response for requested API version&quot;&quot;&quot;</span>
<a id="__codelineno-94-109" name="__codelineno-94-109" href="#__codelineno-94-109"></a>
<a id="__codelineno-94-110" name="__codelineno-94-110" href="#__codelineno-94-110"></a>        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">APIVersion</span><span class="o">.</span><span class="n">V1</span><span class="p">:</span>
<a id="__codelineno-94-111" name="__codelineno-94-111" href="#__codelineno-94-111"></a>            <span class="k">return</span> <span class="n">OrderResponseV1</span><span class="p">(</span>
<a id="__codelineno-94-112" name="__codelineno-94-112" href="#__codelineno-94-112"></a>                <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-94-113" name="__codelineno-94-113" href="#__codelineno-94-113"></a>                <span class="n">status</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-94-114" name="__codelineno-94-114" href="#__codelineno-94-114"></a>                <span class="n">total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">),</span>
<a id="__codelineno-94-115" name="__codelineno-94-115" href="#__codelineno-94-115"></a>                <span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
<a id="__codelineno-94-116" name="__codelineno-94-116" href="#__codelineno-94-116"></a>            <span class="p">)</span>
<a id="__codelineno-94-117" name="__codelineno-94-117" href="#__codelineno-94-117"></a>
<a id="__codelineno-94-118" name="__codelineno-94-118" href="#__codelineno-94-118"></a>        <span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="n">APIVersion</span><span class="o">.</span><span class="n">V2</span><span class="p">:</span>
<a id="__codelineno-94-119" name="__codelineno-94-119" href="#__codelineno-94-119"></a>            <span class="k">return</span> <span class="n">OrderResponseV2</span><span class="p">(</span>
<a id="__codelineno-94-120" name="__codelineno-94-120" href="#__codelineno-94-120"></a>                <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-94-121" name="__codelineno-94-121" href="#__codelineno-94-121"></a>                <span class="n">status</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-94-122" name="__codelineno-94-122" href="#__codelineno-94-122"></a>                <span class="n">total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">),</span>
<a id="__codelineno-94-123" name="__codelineno-94-123" href="#__codelineno-94-123"></a>                <span class="n">currency</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
<a id="__codelineno-94-124" name="__codelineno-94-124" href="#__codelineno-94-124"></a>                <span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">],</span>
<a id="__codelineno-94-125" name="__codelineno-94-125" href="#__codelineno-94-125"></a>                <span class="n">shipping_address</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">shipping_address</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">shipping_address</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-94-126" name="__codelineno-94-126" href="#__codelineno-94-126"></a>            <span class="p">)</span>
<a id="__codelineno-94-127" name="__codelineno-94-127" href="#__codelineno-94-127"></a>
<a id="__codelineno-94-128" name="__codelineno-94-128" href="#__codelineno-94-128"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># V3</span>
<a id="__codelineno-94-129" name="__codelineno-94-129" href="#__codelineno-94-129"></a>            <span class="k">return</span> <span class="n">OrderResponseV3</span><span class="p">(</span>
<a id="__codelineno-94-130" name="__codelineno-94-130" href="#__codelineno-94-130"></a>                <span class="n">order_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-94-131" name="__codelineno-94-131" href="#__codelineno-94-131"></a>                <span class="n">order_status</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-94-132" name="__codelineno-94-132" href="#__codelineno-94-132"></a>                <span class="n">pricing</span><span class="o">=</span><span class="n">OrderPricing</span><span class="p">(</span>
<a id="__codelineno-94-133" name="__codelineno-94-133" href="#__codelineno-94-133"></a>                    <span class="n">total</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-94-134" name="__codelineno-94-134" href="#__codelineno-94-134"></a>                    <span class="n">currency</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">currency</span>
<a id="__codelineno-94-135" name="__codelineno-94-135" href="#__codelineno-94-135"></a>                <span class="p">),</span>
<a id="__codelineno-94-136" name="__codelineno-94-136" href="#__codelineno-94-136"></a>                <span class="n">line_items</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-94-137" name="__codelineno-94-137" href="#__codelineno-94-137"></a>                    <span class="n">OrderLineItem</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span>
<a id="__codelineno-94-138" name="__codelineno-94-138" href="#__codelineno-94-138"></a>                <span class="p">]</span>
<a id="__codelineno-94-139" name="__codelineno-94-139" href="#__codelineno-94-139"></a>            <span class="p">)</span>
</code></pre></div>
<h4 id="pattern-4-infrastructure-evolution"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#pattern-4-infrastructure-evolution">Pattern 4: Infrastructure Evolution</a></h4>
<p>Infrastructure should evolve to meet changing operational requirements without disrupting business logic.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="c1"># Evolution from simple to sophisticated infrastructure</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">InfrastructureEvolution</span><span class="p">:</span>
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>    <span class="c1"># Phase 1: Simple Deployment</span>
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SimpleDeployment</span><span class="p">:</span>
<a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Single server deployment for initial launch&quot;&quot;&quot;</span>
<a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a>
<a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">PostgreSQLDatabase</span><span class="p">(</span><span class="s2">&quot;localhost:5432&quot;</span><span class="p">)</span>
<a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">InMemoryCache</span><span class="p">()</span>
<a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">ConsoleLogger</span><span class="p">()</span>
<a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a>
<a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a>    <span class="c1"># Phase 2: Scalable Infrastructure</span>
<a id="__codelineno-95-14" name="__codelineno-95-14" href="#__codelineno-95-14"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">ScalableDeployment</span><span class="p">:</span>
<a id="__codelineno-95-15" name="__codelineno-95-15" href="#__codelineno-95-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Multi-server deployment with load balancing&quot;&quot;&quot;</span>
<a id="__codelineno-95-16" name="__codelineno-95-16" href="#__codelineno-95-16"></a>
<a id="__codelineno-95-17" name="__codelineno-95-17" href="#__codelineno-95-17"></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-95-18" name="__codelineno-95-18" href="#__codelineno-95-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">PostgreSQLCluster</span><span class="p">([</span>
<a id="__codelineno-95-19" name="__codelineno-95-19" href="#__codelineno-95-19"></a>                <span class="s2">&quot;db-primary:5432&quot;</span><span class="p">,</span>
<a id="__codelineno-95-20" name="__codelineno-95-20" href="#__codelineno-95-20"></a>                <span class="s2">&quot;db-replica-1:5432&quot;</span><span class="p">,</span> 
<a id="__codelineno-95-21" name="__codelineno-95-21" href="#__codelineno-95-21"></a>                <span class="s2">&quot;db-replica-2:5432&quot;</span>
<a id="__codelineno-95-22" name="__codelineno-95-22" href="#__codelineno-95-22"></a>            <span class="p">])</span>
<a id="__codelineno-95-23" name="__codelineno-95-23" href="#__codelineno-95-23"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">RedisCluster</span><span class="p">([</span>
<a id="__codelineno-95-24" name="__codelineno-95-24" href="#__codelineno-95-24"></a>                <span class="s2">&quot;redis-1:6379&quot;</span><span class="p">,</span>
<a id="__codelineno-95-25" name="__codelineno-95-25" href="#__codelineno-95-25"></a>                <span class="s2">&quot;redis-2:6379&quot;</span><span class="p">,</span>
<a id="__codelineno-95-26" name="__codelineno-95-26" href="#__codelineno-95-26"></a>                <span class="s2">&quot;redis-3:6379&quot;</span>
<a id="__codelineno-95-27" name="__codelineno-95-27" href="#__codelineno-95-27"></a>            <span class="p">])</span>
<a id="__codelineno-95-28" name="__codelineno-95-28" href="#__codelineno-95-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">StructuredLogger</span><span class="p">(</span>
<a id="__codelineno-95-29" name="__codelineno-95-29" href="#__codelineno-95-29"></a>                <span class="n">output</span><span class="o">=</span><span class="n">CloudWatchLogsHandler</span><span class="p">()</span>
<a id="__codelineno-95-30" name="__codelineno-95-30" href="#__codelineno-95-30"></a>            <span class="p">)</span>
<a id="__codelineno-95-31" name="__codelineno-95-31" href="#__codelineno-95-31"></a>
<a id="__codelineno-95-32" name="__codelineno-95-32" href="#__codelineno-95-32"></a>    <span class="c1"># Phase 3: Cloud-Native Infrastructure</span>
<a id="__codelineno-95-33" name="__codelineno-95-33" href="#__codelineno-95-33"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">CloudNativeDeployment</span><span class="p">:</span>
<a id="__codelineno-95-34" name="__codelineno-95-34" href="#__codelineno-95-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fully cloud-native with auto-scaling and monitoring&quot;&quot;&quot;</span>
<a id="__codelineno-95-35" name="__codelineno-95-35" href="#__codelineno-95-35"></a>
<a id="__codelineno-95-36" name="__codelineno-95-36" href="#__codelineno-95-36"></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-95-37" name="__codelineno-95-37" href="#__codelineno-95-37"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">AWSRDSProxy</span><span class="p">(</span>
<a id="__codelineno-95-38" name="__codelineno-95-38" href="#__codelineno-95-38"></a>                <span class="n">cluster_endpoint</span><span class="o">=</span><span class="s2">&quot;cluster.amazonaws.com&quot;</span><span class="p">,</span>
<a id="__codelineno-95-39" name="__codelineno-95-39" href="#__codelineno-95-39"></a>                <span class="n">read_replicas</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reader-1.amazonaws.com&quot;</span><span class="p">],</span>
<a id="__codelineno-95-40" name="__codelineno-95-40" href="#__codelineno-95-40"></a>                <span class="n">auto_scaling</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-95-41" name="__codelineno-95-41" href="#__codelineno-95-41"></a>            <span class="p">)</span>
<a id="__codelineno-95-42" name="__codelineno-95-42" href="#__codelineno-95-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">AWSElastiCache</span><span class="p">(</span>
<a id="__codelineno-95-43" name="__codelineno-95-43" href="#__codelineno-95-43"></a>                <span class="n">cluster_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-95-44" name="__codelineno-95-44" href="#__codelineno-95-44"></a>                <span class="n">auto_failover</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-95-45" name="__codelineno-95-45" href="#__codelineno-95-45"></a>            <span class="p">)</span>
<a id="__codelineno-95-46" name="__codelineno-95-46" href="#__codelineno-95-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">search</span> <span class="o">=</span> <span class="n">AWSElasticsearch</span><span class="p">(</span>
<a id="__codelineno-95-47" name="__codelineno-95-47" href="#__codelineno-95-47"></a>                <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;order-search-domain&quot;</span>
<a id="__codelineno-95-48" name="__codelineno-95-48" href="#__codelineno-95-48"></a>            <span class="p">)</span>
<a id="__codelineno-95-49" name="__codelineno-95-49" href="#__codelineno-95-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">AWSCloudWatchLogger</span><span class="p">(</span>
<a id="__codelineno-95-50" name="__codelineno-95-50" href="#__codelineno-95-50"></a>                <span class="n">log_group</span><span class="o">=</span><span class="s2">&quot;/aws/application/orders&quot;</span><span class="p">,</span>
<a id="__codelineno-95-51" name="__codelineno-95-51" href="#__codelineno-95-51"></a>                <span class="n">structured</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-95-52" name="__codelineno-95-52" href="#__codelineno-95-52"></a>                <span class="n">sampling_rate</span><span class="o">=</span><span class="mf">0.1</span>  <span class="c1"># Sample 10% of logs</span>
<a id="__codelineno-95-53" name="__codelineno-95-53" href="#__codelineno-95-53"></a>            <span class="p">)</span>
<a id="__codelineno-95-54" name="__codelineno-95-54" href="#__codelineno-95-54"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">AWSCloudWatchMetrics</span><span class="p">()</span>
<a id="__codelineno-95-55" name="__codelineno-95-55" href="#__codelineno-95-55"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tracing</span> <span class="o">=</span> <span class="n">AWSXRayTracing</span><span class="p">()</span>
<a id="__codelineno-95-56" name="__codelineno-95-56" href="#__codelineno-95-56"></a>
<a id="__codelineno-95-57" name="__codelineno-95-57" href="#__codelineno-95-57"></a><span class="c1"># Configuration-driven infrastructure selection</span>
<a id="__codelineno-95-58" name="__codelineno-95-58" href="#__codelineno-95-58"></a><span class="k">class</span><span class="w"> </span><span class="nc">InfrastructureFactory</span><span class="p">:</span>
<a id="__codelineno-95-59" name="__codelineno-95-59" href="#__codelineno-95-59"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory to create infrastructure based on environment configuration&quot;&quot;&quot;</span>
<a id="__codelineno-95-60" name="__codelineno-95-60" href="#__codelineno-95-60"></a>
<a id="__codelineno-95-61" name="__codelineno-95-61" href="#__codelineno-95-61"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-95-62" name="__codelineno-95-62" href="#__codelineno-95-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_infrastructure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">InfrastructureConfig</span><span class="p">):</span>
<a id="__codelineno-95-63" name="__codelineno-95-63" href="#__codelineno-95-63"></a>        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="s2">&quot;development&quot;</span><span class="p">:</span>
<a id="__codelineno-95-64" name="__codelineno-95-64" href="#__codelineno-95-64"></a>            <span class="k">return</span> <span class="n">InfrastructureEvolution</span><span class="o">.</span><span class="n">SimpleDeployment</span><span class="p">()</span>
<a id="__codelineno-95-65" name="__codelineno-95-65" href="#__codelineno-95-65"></a>        <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="s2">&quot;staging&quot;</span><span class="p">:</span>
<a id="__codelineno-95-66" name="__codelineno-95-66" href="#__codelineno-95-66"></a>            <span class="k">return</span> <span class="n">InfrastructureEvolution</span><span class="o">.</span><span class="n">ScalableDeployment</span><span class="p">()</span>
<a id="__codelineno-95-67" name="__codelineno-95-67" href="#__codelineno-95-67"></a>        <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span><span class="p">:</span>
<a id="__codelineno-95-68" name="__codelineno-95-68" href="#__codelineno-95-68"></a>            <span class="k">return</span> <span class="n">InfrastructureEvolution</span><span class="o">.</span><span class="n">CloudNativeDeployment</span><span class="p">()</span>
<a id="__codelineno-95-69" name="__codelineno-95-69" href="#__codelineno-95-69"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-95-70" name="__codelineno-95-70" href="#__codelineno-95-70"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown environment: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">environment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="managing-technical-debt-during-evolution"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#managing-technical-debt-during-evolution">Managing Technical Debt During Evolution</a></h3>
<p>Technical debt is inevitable during architectural evolution. The key is managing it strategically:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="c1"># Technical Debt Tracking and Management</span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a>
<a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">TechnicalDebtSeverity</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a>    <span class="n">LOW</span> <span class="o">=</span> <span class="s2">&quot;low&quot;</span>
<a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a>    <span class="n">MEDIUM</span> <span class="o">=</span> <span class="s2">&quot;medium&quot;</span>
<a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a>    <span class="n">HIGH</span> <span class="o">=</span> <span class="s2">&quot;high&quot;</span>
<a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a>    <span class="n">CRITICAL</span> <span class="o">=</span> <span class="s2">&quot;critical&quot;</span>
<a id="__codelineno-96-12" name="__codelineno-96-12" href="#__codelineno-96-12"></a>
<a id="__codelineno-96-13" name="__codelineno-96-13" href="#__codelineno-96-13"></a><span class="nd">@dataclass</span>
<a id="__codelineno-96-14" name="__codelineno-96-14" href="#__codelineno-96-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">TechnicalDebt</span><span class="p">:</span>
<a id="__codelineno-96-15" name="__codelineno-96-15" href="#__codelineno-96-15"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-96-16" name="__codelineno-96-16" href="#__codelineno-96-16"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-96-17" name="__codelineno-96-17" href="#__codelineno-96-17"></a>    <span class="n">severity</span><span class="p">:</span> <span class="n">TechnicalDebtSeverity</span>
<a id="__codelineno-96-18" name="__codelineno-96-18" href="#__codelineno-96-18"></a>    <span class="n">affected_components</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-96-19" name="__codelineno-96-19" href="#__codelineno-96-19"></a>    <span class="n">estimated_effort_days</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-96-20" name="__codelineno-96-20" href="#__codelineno-96-20"></a>    <span class="n">business_impact</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-96-21" name="__codelineno-96-21" href="#__codelineno-96-21"></a>    <span class="n">created_date</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-96-22" name="__codelineno-96-22" href="#__codelineno-96-22"></a>    <span class="n">target_resolution_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-96-23" name="__codelineno-96-23" href="#__codelineno-96-23"></a>
<a id="__codelineno-96-24" name="__codelineno-96-24" href="#__codelineno-96-24"></a><span class="k">class</span><span class="w"> </span><span class="nc">TechnicalDebtManager</span><span class="p">:</span>
<a id="__codelineno-96-25" name="__codelineno-96-25" href="#__codelineno-96-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages technical debt during architectural evolution&quot;&quot;&quot;</span>
<a id="__codelineno-96-26" name="__codelineno-96-26" href="#__codelineno-96-26"></a>
<a id="__codelineno-96-27" name="__codelineno-96-27" href="#__codelineno-96-27"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-96-28" name="__codelineno-96-28" href="#__codelineno-96-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debt_items</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TechnicalDebt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-96-29" name="__codelineno-96-29" href="#__codelineno-96-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resolution_strategies</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-96-30" name="__codelineno-96-30" href="#__codelineno-96-30"></a>
<a id="__codelineno-96-31" name="__codelineno-96-31" href="#__codelineno-96-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_debt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debt</span><span class="p">:</span> <span class="n">TechnicalDebt</span><span class="p">):</span>
<a id="__codelineno-96-32" name="__codelineno-96-32" href="#__codelineno-96-32"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add new technical debt item&quot;&quot;&quot;</span>
<a id="__codelineno-96-33" name="__codelineno-96-33" href="#__codelineno-96-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">debt_items</span><span class="p">[</span><span class="n">debt</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">debt</span>
<a id="__codelineno-96-34" name="__codelineno-96-34" href="#__codelineno-96-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_resolution</span><span class="p">(</span><span class="n">debt</span><span class="p">)</span>
<a id="__codelineno-96-35" name="__codelineno-96-35" href="#__codelineno-96-35"></a>
<a id="__codelineno-96-36" name="__codelineno-96-36" href="#__codelineno-96-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">prioritize_debt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TechnicalDebt</span><span class="p">]:</span>
<a id="__codelineno-96-37" name="__codelineno-96-37" href="#__codelineno-96-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prioritize debt items by business impact and severity&quot;&quot;&quot;</span>
<a id="__codelineno-96-38" name="__codelineno-96-38" href="#__codelineno-96-38"></a>        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
<a id="__codelineno-96-39" name="__codelineno-96-39" href="#__codelineno-96-39"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">debt_items</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
<a id="__codelineno-96-40" name="__codelineno-96-40" href="#__codelineno-96-40"></a>            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-96-41" name="__codelineno-96-41" href="#__codelineno-96-41"></a>                <span class="n">d</span><span class="o">.</span><span class="n">severity</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-96-42" name="__codelineno-96-42" href="#__codelineno-96-42"></a>                <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">affected_components</span><span class="p">),</span>
<a id="__codelineno-96-43" name="__codelineno-96-43" href="#__codelineno-96-43"></a>                <span class="n">d</span><span class="o">.</span><span class="n">estimated_effort_days</span>
<a id="__codelineno-96-44" name="__codelineno-96-44" href="#__codelineno-96-44"></a>            <span class="p">),</span>
<a id="__codelineno-96-45" name="__codelineno-96-45" href="#__codelineno-96-45"></a>            <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-96-46" name="__codelineno-96-46" href="#__codelineno-96-46"></a>        <span class="p">)</span>
<a id="__codelineno-96-47" name="__codelineno-96-47" href="#__codelineno-96-47"></a>
<a id="__codelineno-96-48" name="__codelineno-96-48" href="#__codelineno-96-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_migration_plan</span><span class="p">(</span>
<a id="__codelineno-96-49" name="__codelineno-96-49" href="#__codelineno-96-49"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-96-50" name="__codelineno-96-50" href="#__codelineno-96-50"></a>        <span class="n">target_architecture</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-96-51" name="__codelineno-96-51" href="#__codelineno-96-51"></a>        <span class="n">available_capacity_days</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-96-52" name="__codelineno-96-52" href="#__codelineno-96-52"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MigrationPlan</span><span class="p">:</span>
<a id="__codelineno-96-53" name="__codelineno-96-53" href="#__codelineno-96-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create plan to address debt while evolving architecture&quot;&quot;&quot;</span>
<a id="__codelineno-96-54" name="__codelineno-96-54" href="#__codelineno-96-54"></a>
<a id="__codelineno-96-55" name="__codelineno-96-55" href="#__codelineno-96-55"></a>        <span class="n">prioritized_debt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prioritize_debt</span><span class="p">()</span>
<a id="__codelineno-96-56" name="__codelineno-96-56" href="#__codelineno-96-56"></a>        <span class="n">plan</span> <span class="o">=</span> <span class="n">MigrationPlan</span><span class="p">(</span><span class="n">target_architecture</span><span class="p">)</span>
<a id="__codelineno-96-57" name="__codelineno-96-57" href="#__codelineno-96-57"></a>
<a id="__codelineno-96-58" name="__codelineno-96-58" href="#__codelineno-96-58"></a>        <span class="n">remaining_capacity</span> <span class="o">=</span> <span class="n">available_capacity_days</span>
<a id="__codelineno-96-59" name="__codelineno-96-59" href="#__codelineno-96-59"></a>
<a id="__codelineno-96-60" name="__codelineno-96-60" href="#__codelineno-96-60"></a>        <span class="k">for</span> <span class="n">debt_item</span> <span class="ow">in</span> <span class="n">prioritized_debt</span><span class="p">:</span>
<a id="__codelineno-96-61" name="__codelineno-96-61" href="#__codelineno-96-61"></a>            <span class="k">if</span> <span class="n">debt_item</span><span class="o">.</span><span class="n">estimated_effort_days</span> <span class="o">&lt;=</span> <span class="n">remaining_capacity</span><span class="p">:</span>
<a id="__codelineno-96-62" name="__codelineno-96-62" href="#__codelineno-96-62"></a>                <span class="n">plan</span><span class="o">.</span><span class="n">add_debt_resolution</span><span class="p">(</span><span class="n">debt_item</span><span class="p">)</span>
<a id="__codelineno-96-63" name="__codelineno-96-63" href="#__codelineno-96-63"></a>                <span class="n">remaining_capacity</span> <span class="o">-=</span> <span class="n">debt_item</span><span class="o">.</span><span class="n">estimated_effort_days</span>
<a id="__codelineno-96-64" name="__codelineno-96-64" href="#__codelineno-96-64"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-96-65" name="__codelineno-96-65" href="#__codelineno-96-65"></a>                <span class="n">plan</span><span class="o">.</span><span class="n">add_deferred_debt</span><span class="p">(</span><span class="n">debt_item</span><span class="p">)</span>
<a id="__codelineno-96-66" name="__codelineno-96-66" href="#__codelineno-96-66"></a>
<a id="__codelineno-96-67" name="__codelineno-96-67" href="#__codelineno-96-67"></a>        <span class="k">return</span> <span class="n">plan</span>
<a id="__codelineno-96-68" name="__codelineno-96-68" href="#__codelineno-96-68"></a>
<a id="__codelineno-96-69" name="__codelineno-96-69" href="#__codelineno-96-69"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_schedule_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debt</span><span class="p">:</span> <span class="n">TechnicalDebt</span><span class="p">):</span>
<a id="__codelineno-96-70" name="__codelineno-96-70" href="#__codelineno-96-70"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Schedule debt resolution based on severity&quot;&quot;&quot;</span>
<a id="__codelineno-96-71" name="__codelineno-96-71" href="#__codelineno-96-71"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-96-72" name="__codelineno-96-72" href="#__codelineno-96-72"></a>
<a id="__codelineno-96-73" name="__codelineno-96-73" href="#__codelineno-96-73"></a>        <span class="k">if</span> <span class="n">debt</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="n">TechnicalDebtSeverity</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">:</span>
<a id="__codelineno-96-74" name="__codelineno-96-74" href="#__codelineno-96-74"></a>            <span class="n">debt</span><span class="o">.</span><span class="n">target_resolution_date</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-96-75" name="__codelineno-96-75" href="#__codelineno-96-75"></a>        <span class="k">elif</span> <span class="n">debt</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="n">TechnicalDebtSeverity</span><span class="o">.</span><span class="n">HIGH</span><span class="p">:</span>
<a id="__codelineno-96-76" name="__codelineno-96-76" href="#__codelineno-96-76"></a>            <span class="n">debt</span><span class="o">.</span><span class="n">target_resolution_date</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-96-77" name="__codelineno-96-77" href="#__codelineno-96-77"></a>        <span class="k">elif</span> <span class="n">debt</span><span class="o">.</span><span class="n">severity</span> <span class="o">==</span> <span class="n">TechnicalDebtSeverity</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">:</span>
<a id="__codelineno-96-78" name="__codelineno-96-78" href="#__codelineno-96-78"></a>            <span class="n">debt</span><span class="o">.</span><span class="n">target_resolution_date</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<a id="__codelineno-96-79" name="__codelineno-96-79" href="#__codelineno-96-79"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-96-80" name="__codelineno-96-80" href="#__codelineno-96-80"></a>            <span class="n">debt</span><span class="o">.</span><span class="n">target_resolution_date</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">26</span><span class="p">)</span>
<a id="__codelineno-96-81" name="__codelineno-96-81" href="#__codelineno-96-81"></a>
<a id="__codelineno-96-82" name="__codelineno-96-82" href="#__codelineno-96-82"></a><span class="c1"># Example usage during evolution</span>
<a id="__codelineno-96-83" name="__codelineno-96-83" href="#__codelineno-96-83"></a><span class="k">def</span><span class="w"> </span><span class="nf">evolve_order_service</span><span class="p">():</span>
<a id="__codelineno-96-84" name="__codelineno-96-84" href="#__codelineno-96-84"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Example of managed evolution with debt tracking&quot;&quot;&quot;</span>
<a id="__codelineno-96-85" name="__codelineno-96-85" href="#__codelineno-96-85"></a>
<a id="__codelineno-96-86" name="__codelineno-96-86" href="#__codelineno-96-86"></a>    <span class="n">debt_manager</span> <span class="o">=</span> <span class="n">TechnicalDebtManager</span><span class="p">()</span>
<a id="__codelineno-96-87" name="__codelineno-96-87" href="#__codelineno-96-87"></a>
<a id="__codelineno-96-88" name="__codelineno-96-88" href="#__codelineno-96-88"></a>    <span class="c1"># Identify debt during evolution</span>
<a id="__codelineno-96-89" name="__codelineno-96-89" href="#__codelineno-96-89"></a>    <span class="n">debt_manager</span><span class="o">.</span><span class="n">add_debt</span><span class="p">(</span><span class="n">TechnicalDebt</span><span class="p">(</span>
<a id="__codelineno-96-90" name="__codelineno-96-90" href="#__codelineno-96-90"></a>        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;legacy-payment-integration&quot;</span><span class="p">,</span>
<a id="__codelineno-96-91" name="__codelineno-96-91" href="#__codelineno-96-91"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Legacy payment service uses synchronous calls without retries&quot;</span><span class="p">,</span>
<a id="__codelineno-96-92" name="__codelineno-96-92" href="#__codelineno-96-92"></a>        <span class="n">severity</span><span class="o">=</span><span class="n">TechnicalDebtSeverity</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
<a id="__codelineno-96-93" name="__codelineno-96-93" href="#__codelineno-96-93"></a>        <span class="n">affected_components</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;OrderService&quot;</span><span class="p">,</span> <span class="s2">&quot;PaymentService&quot;</span><span class="p">],</span>
<a id="__codelineno-96-94" name="__codelineno-96-94" href="#__codelineno-96-94"></a>        <span class="n">estimated_effort_days</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-96-95" name="__codelineno-96-95" href="#__codelineno-96-95"></a>        <span class="n">business_impact</span><span class="o">=</span><span class="s2">&quot;Payment failures cause order loss&quot;</span><span class="p">,</span>
<a id="__codelineno-96-96" name="__codelineno-96-96" href="#__codelineno-96-96"></a>        <span class="n">created_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-96-97" name="__codelineno-96-97" href="#__codelineno-96-97"></a>    <span class="p">))</span>
<a id="__codelineno-96-98" name="__codelineno-96-98" href="#__codelineno-96-98"></a>
<a id="__codelineno-96-99" name="__codelineno-96-99" href="#__codelineno-96-99"></a>    <span class="n">debt_manager</span><span class="o">.</span><span class="n">add_debt</span><span class="p">(</span><span class="n">TechnicalDebt</span><span class="p">(</span>
<a id="__codelineno-96-100" name="__codelineno-96-100" href="#__codelineno-96-100"></a>        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;missing-integration-tests&quot;</span><span class="p">,</span>
<a id="__codelineno-96-101" name="__codelineno-96-101" href="#__codelineno-96-101"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Order processing flow lacks comprehensive integration tests&quot;</span><span class="p">,</span>
<a id="__codelineno-96-102" name="__codelineno-96-102" href="#__codelineno-96-102"></a>        <span class="n">severity</span><span class="o">=</span><span class="n">TechnicalDebtSeverity</span><span class="o">.</span><span class="n">MEDIUM</span><span class="p">,</span>
<a id="__codelineno-96-103" name="__codelineno-96-103" href="#__codelineno-96-103"></a>        <span class="n">affected_components</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;OrderService&quot;</span><span class="p">,</span> <span class="s2">&quot;InventoryService&quot;</span><span class="p">,</span> <span class="s2">&quot;PaymentService&quot;</span><span class="p">],</span>
<a id="__codelineno-96-104" name="__codelineno-96-104" href="#__codelineno-96-104"></a>        <span class="n">estimated_effort_days</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<a id="__codelineno-96-105" name="__codelineno-96-105" href="#__codelineno-96-105"></a>        <span class="n">business_impact</span><span class="o">=</span><span class="s2">&quot;Deployment risk increases with each change&quot;</span><span class="p">,</span>
<a id="__codelineno-96-106" name="__codelineno-96-106" href="#__codelineno-96-106"></a>        <span class="n">created_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a id="__codelineno-96-107" name="__codelineno-96-107" href="#__codelineno-96-107"></a>    <span class="p">))</span>
<a id="__codelineno-96-108" name="__codelineno-96-108" href="#__codelineno-96-108"></a>
<a id="__codelineno-96-109" name="__codelineno-96-109" href="#__codelineno-96-109"></a>    <span class="c1"># Create migration plan</span>
<a id="__codelineno-96-110" name="__codelineno-96-110" href="#__codelineno-96-110"></a>    <span class="n">plan</span> <span class="o">=</span> <span class="n">debt_manager</span><span class="o">.</span><span class="n">create_migration_plan</span><span class="p">(</span>
<a id="__codelineno-96-111" name="__codelineno-96-111" href="#__codelineno-96-111"></a>        <span class="n">target_architecture</span><span class="o">=</span><span class="s2">&quot;microservices&quot;</span><span class="p">,</span>
<a id="__codelineno-96-112" name="__codelineno-96-112" href="#__codelineno-96-112"></a>        <span class="n">available_capacity_days</span><span class="o">=</span><span class="mi">20</span>
<a id="__codelineno-96-113" name="__codelineno-96-113" href="#__codelineno-96-113"></a>    <span class="p">)</span>
<a id="__codelineno-96-114" name="__codelineno-96-114" href="#__codelineno-96-114"></a>
<a id="__codelineno-96-115" name="__codelineno-96-115" href="#__codelineno-96-115"></a>    <span class="k">return</span> <span class="n">plan</span>
</code></pre></div>
<h3 id="evolution-monitoring-and-metrics"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#evolution-monitoring-and-metrics">Evolution Monitoring and Metrics</a></h3>
<p>Track the health of your architectural evolution with key metrics:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="c1"># Evolution Health Metrics</span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ArchitecturalMetrics</span><span class="p">:</span>
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metrics to track architectural evolution health&quot;&quot;&quot;</span>
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a>
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics_collector</span><span class="p">):</span>
<a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics_collector</span>
<a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a>
<a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track_coupling_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track coupling between components&quot;&quot;&quot;</span>
<a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a>
<a id="__codelineno-97-11" name="__codelineno-97-11" href="#__codelineno-97-11"></a>        <span class="c1"># Afferent coupling (incoming dependencies)</span>
<a id="__codelineno-97-12" name="__codelineno-97-12" href="#__codelineno-97-12"></a>        <span class="n">afferent_coupling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_afferent_coupling</span><span class="p">()</span>
<a id="__codelineno-97-13" name="__codelineno-97-13" href="#__codelineno-97-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">gauge</span><span class="p">(</span><span class="s2">&quot;architecture.afferent_coupling&quot;</span><span class="p">,</span> <span class="n">afferent_coupling</span><span class="p">)</span>
<a id="__codelineno-97-14" name="__codelineno-97-14" href="#__codelineno-97-14"></a>
<a id="__codelineno-97-15" name="__codelineno-97-15" href="#__codelineno-97-15"></a>        <span class="c1"># Efferent coupling (outgoing dependencies) </span>
<a id="__codelineno-97-16" name="__codelineno-97-16" href="#__codelineno-97-16"></a>        <span class="n">efferent_coupling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_efferent_coupling</span><span class="p">()</span>
<a id="__codelineno-97-17" name="__codelineno-97-17" href="#__codelineno-97-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">gauge</span><span class="p">(</span><span class="s2">&quot;architecture.efferent_coupling&quot;</span><span class="p">,</span> <span class="n">efferent_coupling</span><span class="p">)</span>
<a id="__codelineno-97-18" name="__codelineno-97-18" href="#__codelineno-97-18"></a>
<a id="__codelineno-97-19" name="__codelineno-97-19" href="#__codelineno-97-19"></a>        <span class="c1"># Instability (Efferent / (Afferent + Efferent))</span>
<a id="__codelineno-97-20" name="__codelineno-97-20" href="#__codelineno-97-20"></a>        <span class="n">total_coupling</span> <span class="o">=</span> <span class="n">afferent_coupling</span> <span class="o">+</span> <span class="n">efferent_coupling</span>
<a id="__codelineno-97-21" name="__codelineno-97-21" href="#__codelineno-97-21"></a>        <span class="n">instability</span> <span class="o">=</span> <span class="n">efferent_coupling</span> <span class="o">/</span> <span class="n">total_coupling</span> <span class="k">if</span> <span class="n">total_coupling</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-97-22" name="__codelineno-97-22" href="#__codelineno-97-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">gauge</span><span class="p">(</span><span class="s2">&quot;architecture.instability&quot;</span><span class="p">,</span> <span class="n">instability</span><span class="p">)</span>
<a id="__codelineno-97-23" name="__codelineno-97-23" href="#__codelineno-97-23"></a>
<a id="__codelineno-97-24" name="__codelineno-97-24" href="#__codelineno-97-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track_complexity_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-97-25" name="__codelineno-97-25" href="#__codelineno-97-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track code complexity trends&quot;&quot;&quot;</span>
<a id="__codelineno-97-26" name="__codelineno-97-26" href="#__codelineno-97-26"></a>
<a id="__codelineno-97-27" name="__codelineno-97-27" href="#__codelineno-97-27"></a>        <span class="c1"># Cyclomatic complexity</span>
<a id="__codelineno-97-28" name="__codelineno-97-28" href="#__codelineno-97-28"></a>        <span class="n">complexity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cyclomatic_complexity</span><span class="p">()</span>
<a id="__codelineno-97-29" name="__codelineno-97-29" href="#__codelineno-97-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">gauge</span><span class="p">(</span><span class="s2">&quot;architecture.cyclomatic_complexity&quot;</span><span class="p">,</span> <span class="n">complexity</span><span class="p">)</span>
<a id="__codelineno-97-30" name="__codelineno-97-30" href="#__codelineno-97-30"></a>
<a id="__codelineno-97-31" name="__codelineno-97-31" href="#__codelineno-97-31"></a>        <span class="c1"># Lines of code per component</span>
<a id="__codelineno-97-32" name="__codelineno-97-32" href="#__codelineno-97-32"></a>        <span class="n">loc_per_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_loc_per_component</span><span class="p">()</span>
<a id="__codelineno-97-33" name="__codelineno-97-33" href="#__codelineno-97-33"></a>        <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">loc_per_component</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-97-34" name="__codelineno-97-34" href="#__codelineno-97-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">gauge</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;architecture.loc.</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
<a id="__codelineno-97-35" name="__codelineno-97-35" href="#__codelineno-97-35"></a>
<a id="__codelineno-97-36" name="__codelineno-97-36" href="#__codelineno-97-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track_test_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-97-37" name="__codelineno-97-37" href="#__codelineno-97-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track test coverage by architectural layer&quot;&quot;&quot;</span>
<a id="__codelineno-97-38" name="__codelineno-97-38" href="#__codelineno-97-38"></a>
<a id="__codelineno-97-39" name="__codelineno-97-39" href="#__codelineno-97-39"></a>        <span class="n">coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_layer_coverage</span><span class="p">()</span>
<a id="__codelineno-97-40" name="__codelineno-97-40" href="#__codelineno-97-40"></a>        <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">percentage</span> <span class="ow">in</span> <span class="n">coverage</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-97-41" name="__codelineno-97-41" href="#__codelineno-97-41"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">gauge</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;architecture.test_coverage.</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">percentage</span><span class="p">)</span>
<a id="__codelineno-97-42" name="__codelineno-97-42" href="#__codelineno-97-42"></a>
<a id="__codelineno-97-43" name="__codelineno-97-43" href="#__codelineno-97-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track_deployment_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-97-44" name="__codelineno-97-44" href="#__codelineno-97-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track deployment and operational metrics&quot;&quot;&quot;</span>
<a id="__codelineno-97-45" name="__codelineno-97-45" href="#__codelineno-97-45"></a>
<a id="__codelineno-97-46" name="__codelineno-97-46" href="#__codelineno-97-46"></a>        <span class="c1"># Deployment frequency</span>
<a id="__codelineno-97-47" name="__codelineno-97-47" href="#__codelineno-97-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">counter</span><span class="p">(</span><span class="s2">&quot;architecture.deployments&quot;</span><span class="p">)</span>
<a id="__codelineno-97-48" name="__codelineno-97-48" href="#__codelineno-97-48"></a>
<a id="__codelineno-97-49" name="__codelineno-97-49" href="#__codelineno-97-49"></a>        <span class="c1"># Mean time to recovery</span>
<a id="__codelineno-97-50" name="__codelineno-97-50" href="#__codelineno-97-50"></a>        <span class="n">mttr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_mttr</span><span class="p">()</span>
<a id="__codelineno-97-51" name="__codelineno-97-51" href="#__codelineno-97-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">gauge</span><span class="p">(</span><span class="s2">&quot;architecture.mttr_minutes&quot;</span><span class="p">,</span> <span class="n">mttr</span><span class="p">)</span>
<a id="__codelineno-97-52" name="__codelineno-97-52" href="#__codelineno-97-52"></a>
<a id="__codelineno-97-53" name="__codelineno-97-53" href="#__codelineno-97-53"></a>        <span class="c1"># Change failure rate</span>
<a id="__codelineno-97-54" name="__codelineno-97-54" href="#__codelineno-97-54"></a>        <span class="n">failure_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_change_failure_rate</span><span class="p">()</span>
<a id="__codelineno-97-55" name="__codelineno-97-55" href="#__codelineno-97-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">gauge</span><span class="p">(</span><span class="s2">&quot;architecture.change_failure_rate&quot;</span><span class="p">,</span> <span class="n">failure_rate</span><span class="p">)</span>
<a id="__codelineno-97-56" name="__codelineno-97-56" href="#__codelineno-97-56"></a>
<a id="__codelineno-97-57" name="__codelineno-97-57" href="#__codelineno-97-57"></a><span class="k">class</span><span class="w"> </span><span class="nc">EvolutionDashboard</span><span class="p">:</span>
<a id="__codelineno-97-58" name="__codelineno-97-58" href="#__codelineno-97-58"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dashboard to visualize architectural evolution&quot;&quot;&quot;</span>
<a id="__codelineno-97-59" name="__codelineno-97-59" href="#__codelineno-97-59"></a>
<a id="__codelineno-97-60" name="__codelineno-97-60" href="#__codelineno-97-60"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metrics</span><span class="p">:</span> <span class="n">ArchitecturalMetrics</span><span class="p">):</span>
<a id="__codelineno-97-61" name="__codelineno-97-61" href="#__codelineno-97-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics</span>
<a id="__codelineno-97-62" name="__codelineno-97-62" href="#__codelineno-97-62"></a>
<a id="__codelineno-97-63" name="__codelineno-97-63" href="#__codelineno-97-63"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_health_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-97-64" name="__codelineno-97-64" href="#__codelineno-97-64"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate comprehensive architectural health report&quot;&quot;&quot;</span>
<a id="__codelineno-97-65" name="__codelineno-97-65" href="#__codelineno-97-65"></a>
<a id="__codelineno-97-66" name="__codelineno-97-66" href="#__codelineno-97-66"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-97-67" name="__codelineno-97-67" href="#__codelineno-97-67"></a>            <span class="s2">&quot;coupling&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-97-68" name="__codelineno-97-68" href="#__codelineno-97-68"></a>                <span class="s2">&quot;afferent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_latest</span><span class="p">(</span><span class="s2">&quot;architecture.afferent_coupling&quot;</span><span class="p">),</span>
<a id="__codelineno-97-69" name="__codelineno-97-69" href="#__codelineno-97-69"></a>                <span class="s2">&quot;efferent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_latest</span><span class="p">(</span><span class="s2">&quot;architecture.efferent_coupling&quot;</span><span class="p">),</span>
<a id="__codelineno-97-70" name="__codelineno-97-70" href="#__codelineno-97-70"></a>                <span class="s2">&quot;instability&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_latest</span><span class="p">(</span><span class="s2">&quot;architecture.instability&quot;</span><span class="p">)</span>
<a id="__codelineno-97-71" name="__codelineno-97-71" href="#__codelineno-97-71"></a>            <span class="p">},</span>
<a id="__codelineno-97-72" name="__codelineno-97-72" href="#__codelineno-97-72"></a>            <span class="s2">&quot;complexity&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-97-73" name="__codelineno-97-73" href="#__codelineno-97-73"></a>                <span class="s2">&quot;cyclomatic&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_latest</span><span class="p">(</span><span class="s2">&quot;architecture.cyclomatic_complexity&quot;</span><span class="p">),</span>
<a id="__codelineno-97-74" name="__codelineno-97-74" href="#__codelineno-97-74"></a>                <span class="s2">&quot;loc_trend&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_trend</span><span class="p">(</span><span class="s2">&quot;architecture.total_loc&quot;</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<a id="__codelineno-97-75" name="__codelineno-97-75" href="#__codelineno-97-75"></a>            <span class="p">},</span>
<a id="__codelineno-97-76" name="__codelineno-97-76" href="#__codelineno-97-76"></a>            <span class="s2">&quot;quality&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-97-77" name="__codelineno-97-77" href="#__codelineno-97-77"></a>                <span class="s2">&quot;test_coverage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_latest</span><span class="p">(</span><span class="s2">&quot;architecture.test_coverage.total&quot;</span><span class="p">),</span>
<a id="__codelineno-97-78" name="__codelineno-97-78" href="#__codelineno-97-78"></a>                <span class="s2">&quot;debt_ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_technical_debt_ratio</span><span class="p">()</span>
<a id="__codelineno-97-79" name="__codelineno-97-79" href="#__codelineno-97-79"></a>            <span class="p">},</span>
<a id="__codelineno-97-80" name="__codelineno-97-80" href="#__codelineno-97-80"></a>            <span class="s2">&quot;operational&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-97-81" name="__codelineno-97-81" href="#__codelineno-97-81"></a>                <span class="s2">&quot;deployment_frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_rate</span><span class="p">(</span><span class="s2">&quot;architecture.deployments&quot;</span><span class="p">),</span>
<a id="__codelineno-97-82" name="__codelineno-97-82" href="#__codelineno-97-82"></a>                <span class="s2">&quot;mttr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_latest</span><span class="p">(</span><span class="s2">&quot;architecture.mttr_minutes&quot;</span><span class="p">),</span>
<a id="__codelineno-97-83" name="__codelineno-97-83" href="#__codelineno-97-83"></a>                <span class="s2">&quot;change_failure_rate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get_latest</span><span class="p">(</span><span class="s2">&quot;architecture.change_failure_rate&quot;</span><span class="p">)</span>
<a id="__codelineno-97-84" name="__codelineno-97-84" href="#__codelineno-97-84"></a>            <span class="p">}</span>
<a id="__codelineno-97-85" name="__codelineno-97-85" href="#__codelineno-97-85"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="evolution-best-practices"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#evolution-best-practices">Evolution Best Practices</a></h3>
<h4 id="1-evolutionary-architecture-principles"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#1-evolutionary-architecture-principles">1. Evolutionary Architecture Principles</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="c1"># Fitness Functions for Architectural Evolution</span>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ArchitecturalFitnessFunction</span><span class="p">:</span>
<a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Automated tests that verify architectural characteristics&quot;&quot;&quot;</span>
<a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a>
<a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_dependency_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure dependencies flow toward the domain layer&quot;&quot;&quot;</span>
<a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a>        <span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a>
<a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a>        <span class="c1"># Check that infrastructure doesn&#39;t import domain</span>
<a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a>        <span class="n">domain_imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_imports_to_domain</span><span class="p">()</span>
<a id="__codelineno-98-11" name="__codelineno-98-11" href="#__codelineno-98-11"></a>        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">imports</span> <span class="ow">in</span> <span class="n">domain_imports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-98-12" name="__codelineno-98-12" href="#__codelineno-98-12"></a>            <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;infrastructure.&#39;</span><span class="p">):</span>
<a id="__codelineno-98-13" name="__codelineno-98-13" href="#__codelineno-98-13"></a>                <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Infrastructure module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> imports domain&quot;</span><span class="p">)</span>
<a id="__codelineno-98-14" name="__codelineno-98-14" href="#__codelineno-98-14"></a>
<a id="__codelineno-98-15" name="__codelineno-98-15" href="#__codelineno-98-15"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Dependency violations: </span><span class="si">{</span><span class="n">violations</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-98-16" name="__codelineno-98-16" href="#__codelineno-98-16"></a>
<a id="__codelineno-98-17" name="__codelineno-98-17" href="#__codelineno-98-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_database_abstraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-98-18" name="__codelineno-98-18" href="#__codelineno-98-18"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure business logic doesn&#39;t depend on specific database&quot;&quot;&quot;</span>
<a id="__codelineno-98-19" name="__codelineno-98-19" href="#__codelineno-98-19"></a>        <span class="n">business_modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_business_modules</span><span class="p">()</span>
<a id="__codelineno-98-20" name="__codelineno-98-20" href="#__codelineno-98-20"></a>        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">business_modules</span><span class="p">:</span>
<a id="__codelineno-98-21" name="__codelineno-98-21" href="#__codelineno-98-21"></a>            <span class="n">imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_module_imports</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<a id="__codelineno-98-22" name="__codelineno-98-22" href="#__codelineno-98-22"></a>            <span class="n">database_imports</span> <span class="o">=</span> <span class="p">[</span><span class="n">imp</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">imports</span> <span class="k">if</span> <span class="s1">&#39;sqlalchemy&#39;</span> <span class="ow">in</span> <span class="n">imp</span> <span class="ow">or</span> <span class="s1">&#39;django.db&#39;</span> <span class="ow">in</span> <span class="n">imp</span><span class="p">]</span>
<a id="__codelineno-98-23" name="__codelineno-98-23" href="#__codelineno-98-23"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">database_imports</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Business module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> has database dependencies&quot;</span>
<a id="__codelineno-98-24" name="__codelineno-98-24" href="#__codelineno-98-24"></a>
<a id="__codelineno-98-25" name="__codelineno-98-25" href="#__codelineno-98-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_external_service_abstraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-98-26" name="__codelineno-98-26" href="#__codelineno-98-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure business logic uses interfaces for external services&quot;&quot;&quot;</span>
<a id="__codelineno-98-27" name="__codelineno-98-27" href="#__codelineno-98-27"></a>        <span class="n">business_modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_business_modules</span><span class="p">()</span>
<a id="__codelineno-98-28" name="__codelineno-98-28" href="#__codelineno-98-28"></a>        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">business_modules</span><span class="p">:</span>
<a id="__codelineno-98-29" name="__codelineno-98-29" href="#__codelineno-98-29"></a>            <span class="n">imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_module_imports</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<a id="__codelineno-98-30" name="__codelineno-98-30" href="#__codelineno-98-30"></a>            <span class="n">external_imports</span> <span class="o">=</span> <span class="p">[</span><span class="n">imp</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">imports</span> <span class="k">if</span> <span class="s1">&#39;requests&#39;</span> <span class="ow">in</span> <span class="n">imp</span> <span class="ow">or</span> <span class="s1">&#39;boto3&#39;</span> <span class="ow">in</span> <span class="n">imp</span><span class="p">]</span>
<a id="__codelineno-98-31" name="__codelineno-98-31" href="#__codelineno-98-31"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">external_imports</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Business module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> has external service dependencies&quot;</span>
<a id="__codelineno-98-32" name="__codelineno-98-32" href="#__codelineno-98-32"></a>
<a id="__codelineno-98-33" name="__codelineno-98-33" href="#__codelineno-98-33"></a><span class="c1"># Integration with CI/CD</span>
<a id="__codelineno-98-34" name="__codelineno-98-34" href="#__codelineno-98-34"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_architectural_tests</span><span class="p">():</span>
<a id="__codelineno-98-35" name="__codelineno-98-35" href="#__codelineno-98-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Run architectural fitness functions in CI/CD pipeline&quot;&quot;&quot;</span>
<a id="__codelineno-98-36" name="__codelineno-98-36" href="#__codelineno-98-36"></a>    <span class="n">fitness</span> <span class="o">=</span> <span class="n">ArchitecturalFitnessFunction</span><span class="p">()</span>
<a id="__codelineno-98-37" name="__codelineno-98-37" href="#__codelineno-98-37"></a>
<a id="__codelineno-98-38" name="__codelineno-98-38" href="#__codelineno-98-38"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-98-39" name="__codelineno-98-39" href="#__codelineno-98-39"></a>        <span class="n">fitness</span><span class="o">.</span><span class="n">test_dependency_direction</span><span class="p">()</span>
<a id="__codelineno-98-40" name="__codelineno-98-40" href="#__codelineno-98-40"></a>        <span class="n">fitness</span><span class="o">.</span><span class="n">test_database_abstraction</span><span class="p">()</span>
<a id="__codelineno-98-41" name="__codelineno-98-41" href="#__codelineno-98-41"></a>        <span class="n">fitness</span><span class="o">.</span><span class="n">test_external_service_abstraction</span><span class="p">()</span>
<a id="__codelineno-98-42" name="__codelineno-98-42" href="#__codelineno-98-42"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ All architectural tests passed&quot;</span><span class="p">)</span>
<a id="__codelineno-98-43" name="__codelineno-98-43" href="#__codelineno-98-43"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-98-44" name="__codelineno-98-44" href="#__codelineno-98-44"></a>    <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-98-45" name="__codelineno-98-45" href="#__codelineno-98-45"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Architectural test failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-98-46" name="__codelineno-98-46" href="#__codelineno-98-46"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<h4 id="2-feature-toggle-strategy"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#2-feature-toggle-strategy">2. Feature Toggle Strategy</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="c1"># Feature Toggles for Safe Evolution</span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">FeatureToggleManager</span><span class="p">:</span>
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages feature toggles during architectural evolution&quot;&quot;&quot;</span>
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a>
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toggle_store</span><span class="p">):</span>
<a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_store</span> <span class="o">=</span> <span class="n">toggle_store</span>
<a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a>
<a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">is_enabled</span><span class="p">(</span>
<a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a>        <span class="n">feature</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-99-13" name="__codelineno-99-13" href="#__codelineno-99-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if feature is enabled for given context&quot;&quot;&quot;</span>
<a id="__codelineno-99-14" name="__codelineno-99-14" href="#__codelineno-99-14"></a>
<a id="__codelineno-99-15" name="__codelineno-99-15" href="#__codelineno-99-15"></a>        <span class="n">toggle</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_store</span><span class="o">.</span><span class="n">get_toggle</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
<a id="__codelineno-99-16" name="__codelineno-99-16" href="#__codelineno-99-16"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">toggle</span><span class="p">:</span>
<a id="__codelineno-99-17" name="__codelineno-99-17" href="#__codelineno-99-17"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-99-18" name="__codelineno-99-18" href="#__codelineno-99-18"></a>
<a id="__codelineno-99-19" name="__codelineno-99-19" href="#__codelineno-99-19"></a>        <span class="k">return</span> <span class="n">toggle</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">context</span> <span class="ow">or</span> <span class="p">{})</span>
<a id="__codelineno-99-20" name="__codelineno-99-20" href="#__codelineno-99-20"></a>
<a id="__codelineno-99-21" name="__codelineno-99-21" href="#__codelineno-99-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">EvolutionFeatureToggle</span><span class="p">:</span>
<a id="__codelineno-99-22" name="__codelineno-99-22" href="#__codelineno-99-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Specific toggle for architectural evolution features&quot;&quot;&quot;</span>
<a id="__codelineno-99-23" name="__codelineno-99-23" href="#__codelineno-99-23"></a>
<a id="__codelineno-99-24" name="__codelineno-99-24" href="#__codelineno-99-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rollout_percentage</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-99-25" name="__codelineno-99-25" href="#__codelineno-99-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-99-26" name="__codelineno-99-26" href="#__codelineno-99-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rollout_percentage</span> <span class="o">=</span> <span class="n">rollout_percentage</span>
<a id="__codelineno-99-27" name="__codelineno-99-27" href="#__codelineno-99-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enabled_users</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-99-28" name="__codelineno-99-28" href="#__codelineno-99-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enabled_tenants</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-99-29" name="__codelineno-99-29" href="#__codelineno-99-29"></a>
<a id="__codelineno-99-30" name="__codelineno-99-30" href="#__codelineno-99-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-99-31" name="__codelineno-99-31" href="#__codelineno-99-31"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate if toggle should be enabled for context&quot;&quot;&quot;</span>
<a id="__codelineno-99-32" name="__codelineno-99-32" href="#__codelineno-99-32"></a>
<a id="__codelineno-99-33" name="__codelineno-99-33" href="#__codelineno-99-33"></a>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
<a id="__codelineno-99-34" name="__codelineno-99-34" href="#__codelineno-99-34"></a>        <span class="n">tenant_id</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tenant_id&#39;</span><span class="p">)</span>
<a id="__codelineno-99-35" name="__codelineno-99-35" href="#__codelineno-99-35"></a>
<a id="__codelineno-99-36" name="__codelineno-99-36" href="#__codelineno-99-36"></a>        <span class="c1"># Explicit enable lists</span>
<a id="__codelineno-99-37" name="__codelineno-99-37" href="#__codelineno-99-37"></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_users</span><span class="p">:</span>
<a id="__codelineno-99-38" name="__codelineno-99-38" href="#__codelineno-99-38"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-99-39" name="__codelineno-99-39" href="#__codelineno-99-39"></a>        <span class="k">if</span> <span class="n">tenant_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_tenants</span><span class="p">:</span>
<a id="__codelineno-99-40" name="__codelineno-99-40" href="#__codelineno-99-40"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-99-41" name="__codelineno-99-41" href="#__codelineno-99-41"></a>
<a id="__codelineno-99-42" name="__codelineno-99-42" href="#__codelineno-99-42"></a>        <span class="c1"># Percentage rollout</span>
<a id="__codelineno-99-43" name="__codelineno-99-43" href="#__codelineno-99-43"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollout_percentage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-99-44" name="__codelineno-99-44" href="#__codelineno-99-44"></a>            <span class="n">hash_input</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tenant_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-99-45" name="__codelineno-99-45" href="#__codelineno-99-45"></a>            <span class="n">hash_value</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">hash_input</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span>
<a id="__codelineno-99-46" name="__codelineno-99-46" href="#__codelineno-99-46"></a>            <span class="k">return</span> <span class="n">hash_value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollout_percentage</span>
<a id="__codelineno-99-47" name="__codelineno-99-47" href="#__codelineno-99-47"></a>
<a id="__codelineno-99-48" name="__codelineno-99-48" href="#__codelineno-99-48"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-99-49" name="__codelineno-99-49" href="#__codelineno-99-49"></a>
<a id="__codelineno-99-50" name="__codelineno-99-50" href="#__codelineno-99-50"></a><span class="c1"># Usage in evolved architecture</span>
<a id="__codelineno-99-51" name="__codelineno-99-51" href="#__codelineno-99-51"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderServiceRouter</span><span class="p">:</span>
<a id="__codelineno-99-52" name="__codelineno-99-52" href="#__codelineno-99-52"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Routes between old and new implementations based on toggles&quot;&quot;&quot;</span>
<a id="__codelineno-99-53" name="__codelineno-99-53" href="#__codelineno-99-53"></a>
<a id="__codelineno-99-54" name="__codelineno-99-54" href="#__codelineno-99-54"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-99-55" name="__codelineno-99-55" href="#__codelineno-99-55"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-99-56" name="__codelineno-99-56" href="#__codelineno-99-56"></a>        <span class="n">legacy_service</span><span class="p">:</span> <span class="n">LegacyOrderService</span><span class="p">,</span>
<a id="__codelineno-99-57" name="__codelineno-99-57" href="#__codelineno-99-57"></a>        <span class="n">modern_service</span><span class="p">:</span> <span class="n">ModernOrderService</span><span class="p">,</span>
<a id="__codelineno-99-58" name="__codelineno-99-58" href="#__codelineno-99-58"></a>        <span class="n">toggle_manager</span><span class="p">:</span> <span class="n">FeatureToggleManager</span>
<a id="__codelineno-99-59" name="__codelineno-99-59" href="#__codelineno-99-59"></a>    <span class="p">):</span>
<a id="__codelineno-99-60" name="__codelineno-99-60" href="#__codelineno-99-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">legacy_service</span> <span class="o">=</span> <span class="n">legacy_service</span>
<a id="__codelineno-99-61" name="__codelineno-99-61" href="#__codelineno-99-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modern_service</span> <span class="o">=</span> <span class="n">modern_service</span>
<a id="__codelineno-99-62" name="__codelineno-99-62" href="#__codelineno-99-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">toggle_manager</span> <span class="o">=</span> <span class="n">toggle_manager</span>
<a id="__codelineno-99-63" name="__codelineno-99-63" href="#__codelineno-99-63"></a>
<a id="__codelineno-99-64" name="__codelineno-99-64" href="#__codelineno-99-64"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_request</span><span class="p">,</span> <span class="n">user_context</span><span class="p">):</span>
<a id="__codelineno-99-65" name="__codelineno-99-65" href="#__codelineno-99-65"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Route order creation based on feature toggles&quot;&quot;&quot;</span>
<a id="__codelineno-99-66" name="__codelineno-99-66" href="#__codelineno-99-66"></a>
<a id="__codelineno-99-67" name="__codelineno-99-67" href="#__codelineno-99-67"></a>        <span class="c1"># Check various evolution toggles</span>
<a id="__codelineno-99-68" name="__codelineno-99-68" href="#__codelineno-99-68"></a>        <span class="n">use_modern_service</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_manager</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span>
<a id="__codelineno-99-69" name="__codelineno-99-69" href="#__codelineno-99-69"></a>            <span class="s2">&quot;modern_order_service&quot;</span><span class="p">,</span>
<a id="__codelineno-99-70" name="__codelineno-99-70" href="#__codelineno-99-70"></a>            <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user_context</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="s1">&#39;tenant_id&#39;</span><span class="p">:</span> <span class="n">user_context</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">}</span>
<a id="__codelineno-99-71" name="__codelineno-99-71" href="#__codelineno-99-71"></a>        <span class="p">)</span>
<a id="__codelineno-99-72" name="__codelineno-99-72" href="#__codelineno-99-72"></a>
<a id="__codelineno-99-73" name="__codelineno-99-73" href="#__codelineno-99-73"></a>        <span class="n">use_event_sourcing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">toggle_manager</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span>
<a id="__codelineno-99-74" name="__codelineno-99-74" href="#__codelineno-99-74"></a>            <span class="s2">&quot;order_event_sourcing&quot;</span><span class="p">,</span>
<a id="__codelineno-99-75" name="__codelineno-99-75" href="#__codelineno-99-75"></a>            <span class="n">context</span><span class="o">=</span><span class="n">user_context</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<a id="__codelineno-99-76" name="__codelineno-99-76" href="#__codelineno-99-76"></a>        <span class="p">)</span>
<a id="__codelineno-99-77" name="__codelineno-99-77" href="#__codelineno-99-77"></a>
<a id="__codelineno-99-78" name="__codelineno-99-78" href="#__codelineno-99-78"></a>        <span class="k">if</span> <span class="n">use_modern_service</span><span class="p">:</span>
<a id="__codelineno-99-79" name="__codelineno-99-79" href="#__codelineno-99-79"></a>            <span class="k">if</span> <span class="n">use_event_sourcing</span><span class="p">:</span>
<a id="__codelineno-99-80" name="__codelineno-99-80" href="#__codelineno-99-80"></a>                <span class="c1"># Use fully evolved implementation</span>
<a id="__codelineno-99-81" name="__codelineno-99-81" href="#__codelineno-99-81"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">modern_service</span><span class="o">.</span><span class="n">create_order_with_events</span><span class="p">(</span><span class="n">order_request</span><span class="p">)</span>
<a id="__codelineno-99-82" name="__codelineno-99-82" href="#__codelineno-99-82"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-99-83" name="__codelineno-99-83" href="#__codelineno-99-83"></a>                <span class="c1"># Use modern service with traditional persistence</span>
<a id="__codelineno-99-84" name="__codelineno-99-84" href="#__codelineno-99-84"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">modern_service</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">order_request</span><span class="p">)</span>
<a id="__codelineno-99-85" name="__codelineno-99-85" href="#__codelineno-99-85"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-99-86" name="__codelineno-99-86" href="#__codelineno-99-86"></a>            <span class="c1"># Fall back to legacy implementation</span>
<a id="__codelineno-99-87" name="__codelineno-99-87" href="#__codelineno-99-87"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">legacy_service</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">order_request</span><span class="p">)</span>
</code></pre></div>
<h3 id="conclusion-evolution-as-a-competitive-advantage"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#conclusion-evolution-as-a-competitive-advantage">Conclusion: Evolution as a Competitive Advantage</a></h3>
<p>Architectural evolution isn't just about managing technical complexity—it's a competitive advantage that enables your business to adapt faster than competitors constrained by rigid architectures.</p>
<p><strong>Key principles for successful evolution:</strong></p>
<ol>
<li><strong>Business Logic Stability</strong>: Preserve your core business investments while infrastructure evolves</li>
<li><strong>Incremental Migration</strong>: Use patterns like Strangler Fig to evolve systems gradually</li>
<li><strong>Interface Design</strong>: Create abstractions that anticipate future scaling needs</li>
<li><strong>Debt Management</strong>: Track and strategically address technical debt</li>
<li><strong>Monitoring Evolution</strong>: Use metrics to ensure architectural changes improve system health</li>
<li><strong>Safety Mechanisms</strong>: Feature toggles and fitness functions provide guardrails during evolution</li>
</ol>
<p>The clean-py repository demonstrates these patterns in action, providing a foundation that can evolve from startup MVP to enterprise scale without requiring complete rewrites.</p>
<p>The companies that thrive long-term are those that build evolution into their DNA from day one. They understand that the first version of their architecture won't be the last, and they design for change rather than perfection.</p>
<p>Start with Clean Architecture principles, implement evolution-friendly patterns, and build systems that grow with your business rather than constraining it. Your future self—and your business—will thank you when you're scaling to millions of users instead of rewriting everything from scratch.</p>
<p>Architecture evolution is not just about technology—it's about building organizational capability to adapt and thrive in an uncertain future.</p>
<h3 id="references"><a class="toclink" href="../../2025/08/02/evolving-your-architecture---patterns-for-growth/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Evolution-ready architecture</li>
<li><a href="https://www.amazon.com/Building-Evolutionary-Architectures-Support-Constant/dp/1491986360">Building Evolutionary Architectures</a> - Evolutionary architecture patterns</li>
<li><a href="https://martinfowler.com/bliki/StranglerFigApplication.html">Strangler Fig Pattern</a> - Incremental migration strategy</li>
<li><a href="https://martinfowler.com/articles/feature-toggles.html">Feature Toggles</a> - Safe evolution techniques</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-05-22 19:15:00-04:00">May 22, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../clean-architecture/" class="md-meta__link">Clean Architecture</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="./" class="md-meta__link">Software Design</a></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="from-script-to-architecture-why-your-python-project-needs-structure"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/">From Script to Architecture: Why Your Python Project Needs Structure</a></h2>
<p>Every Python developer has been there. You start with a simple script to solve a problem. Maybe it's processing some data, automating a task, or building a quick API endpoint. The script grows. Features get added. Before you know it, you're staring at a 2,000-line file that nobody wants to touch, let alone understand.</p>
<p>I've witnessed this organic growth countless times in production systems. What starts as <code>app.py</code> becomes a tangled web of functions, global variables, and copy-pasted code blocks. The cost of adding new features skyrockets. Bugs become harder to track. Testing? Nearly impossible without running the entire application.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates how to avoid this trap from day one. It's not about over-engineering; it's about sustainable development practices that scale with your needs.</p>
<h3 id="the-real-cost-of-unstructured-code"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#the-real-cost-of-unstructured-code">The Real Cost of Unstructured Code</a></h3>
<p>Let me share a story from a recent consulting engagement. A startup had built their entire e-commerce platform in three Python files: <code>main.py</code>, <code>database.py</code>, and <code>utils.py</code>. The <code>main.py</code> alone was over 5,000 lines. Every developer on the team had a different understanding of how the system worked. Deployment was a prayer. Testing was manual.</p>
<p>When they needed to add a new payment provider, what should have been a two-day task turned into a three-week nightmare. The payment logic was scattered across all three files. Database transactions weren't properly managed. Error handling was inconsistent. The team eventually had to freeze feature development for two months to refactor the codebase.</p>
<p>This scenario plays out in companies every day. The hidden costs include:</p>
<ul>
<li><strong>Developer velocity decline</strong>: New features take exponentially longer to implement</li>
<li><strong>Knowledge silos</strong>: Only certain developers understand certain parts of the code</li>
<li><strong>Bug multiplication</strong>: Fixes in one area break functionality elsewhere</li>
<li><strong>Onboarding nightmare</strong>: New team members take months to become productive</li>
<li><strong>Testing impossibility</strong>: Automated testing becomes a pipe dream</li>
</ul>
<h3 id="recognizing-the-warning-signs"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#recognizing-the-warning-signs">Recognizing the Warning Signs</a></h3>
<p>Your Python project needs architectural attention when you notice these symptoms:</p>
<p><strong>Code Smells:</strong>
- Functions with more than 50 lines becoming common
- Global variables used for configuration and state
- Circular imports forcing creative import strategies
- Business logic mixed with database queries and API handlers
- Copy-pasted code blocks with slight variations
- Comments like "Don't touch this - it works somehow"</p>
<p><strong>Development Pain Points:</strong>
- Fear of refactoring because you might break something
- Merge conflicts on every pull request
- Inability to work on features in parallel
- Testing requires the entire application environment
- Debugging involves print statements throughout the code</p>
<p><strong>Operational Issues:</strong>
- Deployments require careful coordination
- Rolling back changes is risky or impossible
- Performance problems are hard to isolate
- Monitoring and logging are afterthoughts</p>
<h3 id="the-journey-from-script-to-architecture"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#the-journey-from-script-to-architecture">The Journey from Script to Architecture</a></h3>
<p>The transformation doesn't happen overnight, but it follows a predictable path. Here's how a typical Python project evolves, using our e-commerce platform as an example:</p>
<h4 id="stage-1-the-monolithic-script"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#stage-1-the-monolithic-script">Stage 1: The Monolithic Script</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># app.py - Everything in one place</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;shop.db&#39;</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">():</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM products WHERE active = 1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">products</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/order&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">():</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="c1"># 200 lines of order processing logic here</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="c1"># Including payment processing, inventory updates, emails...</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>This works for a prototype, but it's already showing problems. Database connections aren't managed properly. Business logic is mixed with HTTP handling. There's no separation of concerns.</p>
<h4 id="stage-2-basic-separation"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#stage-2-basic-separation">Stage 2: Basic Separation</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># models.py</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="c1"># database.py</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">Database</span><span class="p">:</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;shop.db&#39;</span><span class="p">)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM products WHERE active = 1&quot;</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="c1"># app.py</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Product</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">()</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">)</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">():</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>    <span class="n">products</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_products</span><span class="p">()</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
</code></pre></div>
<p>Better, but still problematic. The database layer knows about SQL. The models are anemic. The application layer is tightly coupled to Flask.</p>
<h4 id="stage-3-clean-architecture-introduction"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#stage-3-clean-architecture-introduction">Stage 3: Clean Architecture Introduction</a></h4>
<p>This is where the real transformation begins. Look at how the <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> structures the same functionality:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># src/domain/entities/product.py</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="nd">@dataclass</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">:</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="n">price</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">inventory_count</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">can_purchase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Business rule: Can we purchase this quantity?&quot;&quot;&quot;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_count</span> <span class="o">&gt;=</span> <span class="n">quantity</span> <span class="ow">and</span> <span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Business logic for price calculation&quot;&quot;&quot;</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_purchase</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot purchase </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="c1"># src/domain/repositories/product_repository.py</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProductRepository</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>        <span class="k">pass</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_products</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="k">pass</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="c1"># src/application/use_cases/get_products.py</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="k">class</span><span class="w"> </span><span class="nc">GetProductsUseCase</span><span class="p">:</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_repo</span><span class="p">:</span> <span class="n">ProductRepository</span><span class="p">):</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">product_repo</span> <span class="o">=</span> <span class="n">product_repo</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ProductDTO</span><span class="p">]:</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>        <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_repo</span><span class="o">.</span><span class="n">get_active_products</span><span class="p">()</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">ProductDTO</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">]</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="c1"># src/infrastructure/database/product_repository_impl.py</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProductRepositoryImpl</span><span class="p">(</span><span class="n">ProductRepository</span><span class="p">):</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">):</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_products</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>            <span class="n">select</span><span class="p">(</span><span class="n">ProductModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ProductModel</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>        <span class="p">)</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()]</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a><span class="c1"># src/presentation/api/products.py</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a><span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/products&quot;</span><span class="p">)</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">(</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>    <span class="n">use_case</span><span class="p">:</span> <span class="n">GetProductsUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_products_use_case</span><span class="p">)</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a><span class="p">):</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>    <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>    <span class="k">return</span> <span class="n">products</span>
</code></pre></div>
<p>Notice the dramatic differences:
- <strong>Domain layer</strong> contains business rules and entities
- <strong>Application layer</strong> orchestrates use cases
- <strong>Infrastructure layer</strong> handles technical details
- <strong>Presentation layer</strong> manages HTTP concerns
- Each layer has clear responsibilities and boundaries</p>
<h3 id="benefits-of-structured-architecture"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#benefits-of-structured-architecture">Benefits of Structured Architecture</a></h3>
<p>The investment in architecture pays dividends immediately:</p>
<h4 id="1-testability"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#1-testability">1. Testability</a></h4>
<p>Each layer can be tested in isolation. Domain logic doesn't need a database. Use cases can be tested with mock repositories. This leads to fast, reliable test suites.</p>
<h4 id="2-maintainability"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#2-maintainability">2. Maintainability</a></h4>
<p>When a bug report comes in, you know exactly where to look. Payment issue? Check the payment use case. Database problem? It's isolated to the repository layer.</p>
<h4 id="3-flexibility"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#3-flexibility">3. Flexibility</a></h4>
<p>Need to switch from PostgreSQL to MongoDB? Only the infrastructure layer changes. Want to add a GraphQL API alongside REST? Add it to the presentation layer without touching business logic.</p>
<h4 id="4-team-scalability"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#4-team-scalability">4. Team Scalability</a></h4>
<p>New developers can work on specific layers without understanding the entire system. Frontend developers focus on the presentation layer. Database experts optimize the infrastructure layer. Domain experts refine business rules.</p>
<h4 id="5-performance-optimization"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#5-performance-optimization">5. Performance Optimization</a></h4>
<p>With clear boundaries, performance bottlenecks are easier to identify and fix. You can cache at the appropriate layer, optimize database queries without touching business logic, and add async processing where it makes sense.</p>
<h3 id="the-path-forward"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#the-path-forward">The Path Forward</a></h3>
<p>Transitioning from script to architecture doesn't mean throwing away your existing code. It's about gradually introducing structure:</p>
<ol>
<li><strong>Start with the domain</strong>: Identify your core business entities and rules</li>
<li><strong>Extract use cases</strong>: Move business workflows into dedicated classes</li>
<li><strong>Abstract infrastructure</strong>: Hide database and external service details behind interfaces</li>
<li><strong>Separate presentation</strong>: Keep HTTP/API concerns in their own layer</li>
<li><strong>Add tests</strong>: Each refactoring step should be backed by tests</li>
</ol>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> provides a complete example of this architecture in action. It demonstrates patterns that work in production, from simple CRUD operations to complex business workflows.</p>
<h3 id="conclusion"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#conclusion">Conclusion</a></h3>
<p>The evolution from script to architecture is a journey every successful Python project must take. The question isn't whether you need structure, but when you'll introduce it. Starting with good architecture from day one isn't over-engineering; it's professional software development.</p>
<p>In the next post, we'll dive deep into setting up a Python project with modern tooling, going beyond simple requirements.txt files to create a professional development environment that supports your architectural goals.</p>
<p>Remember: Architecture isn't about complexity. It's about managing complexity. Your future self, your team, and your users will thank you for the investment.</p>
<h3 id="references-and-further-reading"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#references-and-further-reading">References and Further Reading</a></h3>
<h4 id="project-repository"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#project-repository">Project Repository</a></h4>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete implementation of Clean Architecture in Python</li>
<li><a href="https://github.com/buildshift-dev/clean-py/tree/main/docs">Project Documentation</a> - Detailed patterns and guides</li>
</ul>
<h4 id="books-and-articles"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#books-and-articles">Books and Articles</a></h4>
<ul>
<li><a href="https://www.amazon.com/Clean-Architecture-Craftsmans-Software-Structure/dp/0134494164">Clean Architecture by Robert C. Martin</a> - The definitive guide to Clean Architecture</li>
<li><a href="https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215">Domain-Driven Design by Eric Evans</a> - Essential reading for understanding domain modeling</li>
<li><a href="https://www.cosmicpython.com/">Architecture Patterns with Python</a> - Free online book on Python architecture patterns</li>
</ul>
<h4 id="python-resources"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#python-resources">Python Resources</a></h4>
<ul>
<li><a href="https://peps.python.org/pep-0008/">PEP 8 - Style Guide for Python Code</a> - Python coding conventions</li>
<li><a href="https://realpython.com/python-application-layouts/">Real Python - Application Layouts</a> - Guide to Python project structures</li>
<li><a href="https://packaging.python.org/">Python Packaging Guide</a> - Official Python packaging documentation</li>
</ul>
<h4 id="related-blog-posts-in-this-series"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#related-blog-posts-in-this-series">Related Blog Posts in This Series</a></h4>
<ul>
<li><a href="../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/">Setting Up a Python Project Like a Pro</a> - Modern Python project setup</li>
<li><a href="../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/">Domain-Driven Design in Python</a> - DDD patterns in Python</li>
<li><a href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/">Clean Architecture in Python</a> - Implementing Clean Architecture</li>
</ul>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 buildshift.dev
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/buildshift-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/your-profile" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/your-handle" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:contact@buildshift.dev" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l208 156a48 48 0 0 0 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 196v188c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V196L313.6 344.8c-34.1 25.6-81.1 25.6-115.2 0z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.path", "navigation.top", "search.highlight", "search.share", "search.suggest", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../assets/js/buildshift.js"></script>
      
    
  </body>
</html>