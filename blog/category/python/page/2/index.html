
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Full Stack Developer specializing in AWS Serverless, Python, and modern development workflows">
      
      
        <meta name="author" content="buildshift.dev">
      
      
        <link rel="canonical" href="https://buildshift.dev/blog/category/python/page/2/">
      
      
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../../assets/images/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Python - buildshift.dev</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/css/buildshift.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-4SV8ZKYLT1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-4SV8ZKYLT1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-4SV8ZKYLT1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Fixed banner styling -->
  <style>
    body { padding-top: 40px !important; }
    .md-header { top: 40px !important; }
    .md-tabs { top: 40px !important; }
  </style>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#python" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
  <!-- Under Construction Announcement -->
  <div style="background: #000000; text-align: center; padding: 8px 0; position: fixed; top: 0; left: 0; right: 0; z-index: 9999; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 14px; font-weight: 500; color: #ffa500;">
      <i class="fas fa-hard-hat"></i>
      <span>...Under Construction...</span>
    </div>
  </div>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="buildshift.dev" class="md-header__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            buildshift.dev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Python
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../" class="md-tabs__link">
        
  
  
    
  
  buildshift.dev Blog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="buildshift.dev" class="md-nav__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    buildshift.dev
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    buildshift.dev Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="python">Python</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-06-16 21:25:00-04:00">Jun 16, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../design-patterns/" class="md-meta__link">Design Patterns</a>, 
              <a href="../../" class="md-meta__link">Python</a>, 
              <a href="../../../clean-architecture/" class="md-meta__link">Clean Architecture</a></li>
        
        
          
          <li class="md-meta__item">
            
              12 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="factory-pattern-in-python-building-complex-objects-right"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/">Factory Pattern in Python: Building Complex Objects Right</a></h2>
<p>Object creation seems straightforward until it isn't. You start with simple constructors, then business rules creep in. Validation becomes complex. Initialization requires multiple steps. Dependencies need coordination. Before you know it, your codebase is littered with half-initialized objects, scattered validation logic, and creation code that breaks business rules.</p>
<p>I've debugged too many production issues caused by objects in invalid statesâ€”customers without required fields, orders with negative totals, aggregates missing domain events. The Factory Pattern solves these problems by centralizing object creation, ensuring consistency, and maintaining business invariants from the moment objects come into existence.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates factory patterns in Python that go beyond simple object construction. These patterns ensure your domain entities are born valid and remain consistent throughout their lifecycle.</p>
<h3 id="the-problem-with-direct-construction"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#the-problem-with-direct-construction">The Problem with Direct Construction</a></h3>
<p>Consider a typical Customer entity. At first glance, direct construction seems natural:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="c1"># Direct construction - seems simple</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>    <span class="nb">id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>    <span class="n">email</span><span class="o">=</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>    <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>    <span class="n">updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>    <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a>    <span class="n">preferences</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="p">)</span>
</code></pre></div>
<p>This approach breaks down quickly:</p>
<ol>
<li><strong>Validation scattered</strong>: Email format checking happens elsewhere</li>
<li><strong>Missing invariants</strong>: No business rule ensures required fields</li>
<li><strong>No domain events</strong>: Important business events aren't raised</li>
<li><strong>Inconsistent creation</strong>: Different parts of code create objects differently</li>
<li><strong>Complex initialization</strong>: Multi-step setup requirements aren't enforced</li>
</ol>
<p>Real-world creation gets messy:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="c1"># Real-world direct construction - error-prone</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_customer_endpoint</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>    <span class="c1"># Validation scattered throughout the code</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name required&quot;</span><span class="p">)</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid email&quot;</span><span class="p">)</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>    <span class="k">if</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email already exists&quot;</span><span class="p">)</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>    <span class="c1"># Easy to forget steps</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>        <span class="nb">id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>  <span class="c1"># What if we forget this?</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a>        <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a>        <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a>        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a>        <span class="n">updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>  <span class="c1"># Duplicate logic</span>
<a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a>        <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># What if business rules change?</span>
<a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a>        <span class="n">preferences</span><span class="o">=</span><span class="p">{},</span>  <span class="c1"># What if we need defaults?</span>
<a id="__codelineno-65-22" name="__codelineno-65-22" href="#__codelineno-65-22"></a>    <span class="p">)</span>
<a id="__codelineno-65-23" name="__codelineno-65-23" href="#__codelineno-65-23"></a>
<a id="__codelineno-65-24" name="__codelineno-65-24" href="#__codelineno-65-24"></a>    <span class="c1"># Domain events forgotten</span>
<a id="__codelineno-65-25" name="__codelineno-65-25" href="#__codelineno-65-25"></a>    <span class="c1"># Audit logging missing</span>
<a id="__codelineno-65-26" name="__codelineno-65-26" href="#__codelineno-65-26"></a>    <span class="c1"># Notification logic scattered</span>
<a id="__codelineno-65-27" name="__codelineno-65-27" href="#__codelineno-65-27"></a>
<a id="__codelineno-65-28" name="__codelineno-65-28" href="#__codelineno-65-28"></a>    <span class="k">return</span> <span class="n">customer</span>
</code></pre></div>
<h3 id="factory-methods-domain-centric-creation"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#factory-methods-domain-centric-creation">Factory Methods: Domain-Centric Creation</a></h3>
<p>Factory methods centralize creation logic within the domain entity. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates this pattern:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="c1"># src/domain/entities/customer.py</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="nd">@dataclass</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Customer aggregate root with enhanced value objects and domain events.&quot;&quot;&quot;</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Email</span>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>    <span class="n">address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>    <span class="n">phone</span><span class="p">:</span> <span class="n">PhoneNumber</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a>        <span class="bp">cls</span><span class="p">,</span>
<a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span>
<a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a>        <span class="n">address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a>        <span class="n">phone</span><span class="p">:</span> <span class="n">PhoneNumber</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a>        <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-66-25" name="__codelineno-66-25" href="#__codelineno-66-25"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Customer&quot;</span><span class="p">:</span>
<a id="__codelineno-66-26" name="__codelineno-66-26" href="#__codelineno-66-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Factory method to create a new customer with domain event.&quot;&quot;&quot;</span>
<a id="__codelineno-66-27" name="__codelineno-66-27" href="#__codelineno-66-27"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-66-28" name="__codelineno-66-28" href="#__codelineno-66-28"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-66-29" name="__codelineno-66-29" href="#__codelineno-66-29"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-66-30" name="__codelineno-66-30" href="#__codelineno-66-30"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-66-31" name="__codelineno-66-31" href="#__codelineno-66-31"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-66-32" name="__codelineno-66-32" href="#__codelineno-66-32"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-66-33" name="__codelineno-66-33" href="#__codelineno-66-33"></a>            <span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-66-34" name="__codelineno-66-34" href="#__codelineno-66-34"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-66-35" name="__codelineno-66-35" href="#__codelineno-66-35"></a>        <span class="p">)</span>
<a id="__codelineno-66-36" name="__codelineno-66-36" href="#__codelineno-66-36"></a>
<a id="__codelineno-66-37" name="__codelineno-66-37" href="#__codelineno-66-37"></a>        <span class="c1"># Raise domain event</span>
<a id="__codelineno-66-38" name="__codelineno-66-38" href="#__codelineno-66-38"></a>        <span class="n">customer</span><span class="o">.</span><span class="n">add_domain_event</span><span class="p">(</span>
<a id="__codelineno-66-39" name="__codelineno-66-39" href="#__codelineno-66-39"></a>            <span class="n">CustomerCreated</span><span class="p">(</span>
<a id="__codelineno-66-40" name="__codelineno-66-40" href="#__codelineno-66-40"></a>                <span class="n">event_id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-66-41" name="__codelineno-66-41" href="#__codelineno-66-41"></a>                <span class="n">occurred_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-66-42" name="__codelineno-66-42" href="#__codelineno-66-42"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-66-43" name="__codelineno-66-43" href="#__codelineno-66-43"></a>                <span class="n">customer_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-66-44" name="__codelineno-66-44" href="#__codelineno-66-44"></a>                <span class="n">customer_email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-66-45" name="__codelineno-66-45" href="#__codelineno-66-45"></a>            <span class="p">)</span>
<a id="__codelineno-66-46" name="__codelineno-66-46" href="#__codelineno-66-46"></a>        <span class="p">)</span>
<a id="__codelineno-66-47" name="__codelineno-66-47" href="#__codelineno-66-47"></a>
<a id="__codelineno-66-48" name="__codelineno-66-48" href="#__codelineno-66-48"></a>        <span class="k">return</span> <span class="n">customer</span>
</code></pre></div>
<p>The factory method provides several benefits:</p>
<ol>
<li><strong>Centralized validation</strong>: Business rules in one place</li>
<li><strong>Consistent domain events</strong>: Events raised automatically</li>
<li><strong>Immutable creation</strong>: Objects are born valid</li>
<li><strong>Clear intent</strong>: The method name expresses purpose</li>
<li><strong>Type safety</strong>: Value objects ensure parameter correctness</li>
</ol>
<p>Usage becomes clean and safe:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="c1"># Clean factory method usage</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_customer_use_case</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="n">CreateCustomerCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>    <span class="c1"># Value objects handle validation</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>  <span class="c1"># Validates format</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>    <span class="c1"># Business rule validation</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>    <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="n">customer_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a>    <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Customer with email </span><span class="si">{</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a>    <span class="c1"># Factory ensures consistency</span>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a>        <span class="n">name</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a>        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a>        <span class="n">preferences</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a>    <span class="p">)</span>
<a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a>
<a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a>    <span class="c1"># Object is guaranteed valid with events raised</span>
<a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">customer_repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
</code></pre></div>
<h3 id="order-factory-complex-business-logic"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#order-factory-complex-business-logic">Order Factory: Complex Business Logic</a></h3>
<p>Orders demonstrate more complex factory requirements. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> shows how to handle validation, business rules, and domain events:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># src/domain/entities/order.py</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="nd">@dataclass</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">(</span><span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Order aggregate root with enhanced value objects and domain events.&quot;&quot;&quot;</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>    <span class="n">total_amount</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>    <span class="n">status</span><span class="p">:</span> <span class="n">OrderStatus</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>    <span class="n">details</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_business_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate order business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">):</span>
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>            <span class="k">raise</span> <span class="n">BusinessRuleViolationError</span><span class="p">(</span>
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a>                <span class="s2">&quot;Order total amount must be greater than zero&quot;</span><span class="p">,</span>
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>                <span class="n">rule_name</span><span class="o">=</span><span class="s2">&quot;MinimumOrderAmount&quot;</span><span class="p">,</span>
<a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>            <span class="p">)</span>
<a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>
<a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a>        <span class="bp">cls</span><span class="p">,</span>
<a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a>        <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">,</span>
<a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span>
<a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a>        <span class="n">total_amount</span><span class="p">:</span> <span class="n">Money</span><span class="p">,</span>
<a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a>        <span class="n">details</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Order&quot;</span><span class="p">:</span>
<a id="__codelineno-68-30" name="__codelineno-68-30" href="#__codelineno-68-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Factory method to create a new order with domain event.&quot;&quot;&quot;</span>
<a id="__codelineno-68-31" name="__codelineno-68-31" href="#__codelineno-68-31"></a>        <span class="n">order</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-68-32" name="__codelineno-68-32" href="#__codelineno-68-32"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">order_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-68-33" name="__codelineno-68-33" href="#__codelineno-68-33"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-68-34" name="__codelineno-68-34" href="#__codelineno-68-34"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-68-35" name="__codelineno-68-35" href="#__codelineno-68-35"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">total_amount</span><span class="p">,</span>
<a id="__codelineno-68-36" name="__codelineno-68-36" href="#__codelineno-68-36"></a>            <span class="n">details</span><span class="o">=</span><span class="n">details</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-68-37" name="__codelineno-68-37" href="#__codelineno-68-37"></a>        <span class="p">)</span>
<a id="__codelineno-68-38" name="__codelineno-68-38" href="#__codelineno-68-38"></a>
<a id="__codelineno-68-39" name="__codelineno-68-39" href="#__codelineno-68-39"></a>        <span class="c1"># Raise domain event</span>
<a id="__codelineno-68-40" name="__codelineno-68-40" href="#__codelineno-68-40"></a>        <span class="n">order</span><span class="o">.</span><span class="n">add_domain_event</span><span class="p">(</span>
<a id="__codelineno-68-41" name="__codelineno-68-41" href="#__codelineno-68-41"></a>            <span class="n">OrderCreated</span><span class="p">(</span>
<a id="__codelineno-68-42" name="__codelineno-68-42" href="#__codelineno-68-42"></a>                <span class="n">event_id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-68-43" name="__codelineno-68-43" href="#__codelineno-68-43"></a>                <span class="n">occurred_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-68-44" name="__codelineno-68-44" href="#__codelineno-68-44"></a>                <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-68-45" name="__codelineno-68-45" href="#__codelineno-68-45"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-68-46" name="__codelineno-68-46" href="#__codelineno-68-46"></a>                <span class="n">total_amount</span><span class="o">=</span><span class="n">total_amount</span><span class="p">,</span>
<a id="__codelineno-68-47" name="__codelineno-68-47" href="#__codelineno-68-47"></a>            <span class="p">)</span>
<a id="__codelineno-68-48" name="__codelineno-68-48" href="#__codelineno-68-48"></a>        <span class="p">)</span>
<a id="__codelineno-68-49" name="__codelineno-68-49" href="#__codelineno-68-49"></a>
<a id="__codelineno-68-50" name="__codelineno-68-50" href="#__codelineno-68-50"></a>        <span class="k">return</span> <span class="n">order</span>
</code></pre></div>
<p>The Order factory demonstrates advanced patterns:</p>
<ul>
<li><strong>Automatic validation</strong>: <code>_validate_business_rules</code> runs on initialization</li>
<li><strong>Domain events</strong>: Important business events raised automatically</li>
<li><strong>Business rule enforcement</strong>: Minimum order amount validated</li>
<li><strong>Consistent state</strong>: Orders are always created in valid state</li>
</ul>
<h3 id="builder-pattern-for-complex-construction"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#builder-pattern-for-complex-construction">Builder Pattern for Complex Construction</a></h3>
<p>When object creation involves many optional parameters or complex setup, the Builder pattern provides a fluent interface:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderBuilder</span><span class="p">:</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Builder for creating complex orders with validation.&quot;&quot;&quot;</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OrderId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CustomerId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_billing_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_payment_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PaymentMethod</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_special_instructions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the order ID.&quot;&quot;&quot;</span>
<a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span> <span class="o">=</span> <span class="n">order_id</span>
<a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a>
<a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">for_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the customer ID.&quot;&quot;&quot;</span>
<a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span> <span class="o">=</span> <span class="n">customer_id</span>
<a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-69-27" name="__codelineno-69-27" href="#__codelineno-69-27"></a>
<a id="__codelineno-69-28" name="__codelineno-69-28" href="#__codelineno-69-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="n">ProductId</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-69-29" name="__codelineno-69-29" href="#__codelineno-69-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an item to the order.&quot;&quot;&quot;</span>
<a id="__codelineno-69-30" name="__codelineno-69-30" href="#__codelineno-69-30"></a>        <span class="k">if</span> <span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-69-31" name="__codelineno-69-31" href="#__codelineno-69-31"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Quantity must be positive&quot;</span><span class="p">)</span>
<a id="__codelineno-69-32" name="__codelineno-69-32" href="#__codelineno-69-32"></a>
<a id="__codelineno-69-33" name="__codelineno-69-33" href="#__codelineno-69-33"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">(</span>
<a id="__codelineno-69-34" name="__codelineno-69-34" href="#__codelineno-69-34"></a>            <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">,</span>
<a id="__codelineno-69-35" name="__codelineno-69-35" href="#__codelineno-69-35"></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-69-36" name="__codelineno-69-36" href="#__codelineno-69-36"></a>            <span class="n">unit_price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
<a id="__codelineno-69-37" name="__codelineno-69-37" href="#__codelineno-69-37"></a>        <span class="p">)</span>
<a id="__codelineno-69-38" name="__codelineno-69-38" href="#__codelineno-69-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<a id="__codelineno-69-39" name="__codelineno-69-39" href="#__codelineno-69-39"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-69-40" name="__codelineno-69-40" href="#__codelineno-69-40"></a>
<a id="__codelineno-69-41" name="__codelineno-69-41" href="#__codelineno-69-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_shipping_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-69-42" name="__codelineno-69-42" href="#__codelineno-69-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the shipping address.&quot;&quot;&quot;</span>
<a id="__codelineno-69-43" name="__codelineno-69-43" href="#__codelineno-69-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span> <span class="o">=</span> <span class="n">address</span>
<a id="__codelineno-69-44" name="__codelineno-69-44" href="#__codelineno-69-44"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-69-45" name="__codelineno-69-45" href="#__codelineno-69-45"></a>
<a id="__codelineno-69-46" name="__codelineno-69-46" href="#__codelineno-69-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_billing_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-69-47" name="__codelineno-69-47" href="#__codelineno-69-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the billing address.&quot;&quot;&quot;</span>
<a id="__codelineno-69-48" name="__codelineno-69-48" href="#__codelineno-69-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_billing_address</span> <span class="o">=</span> <span class="n">address</span>
<a id="__codelineno-69-49" name="__codelineno-69-49" href="#__codelineno-69-49"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-69-50" name="__codelineno-69-50" href="#__codelineno-69-50"></a>
<a id="__codelineno-69-51" name="__codelineno-69-51" href="#__codelineno-69-51"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_payment_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_method</span><span class="p">:</span> <span class="n">PaymentMethod</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-69-52" name="__codelineno-69-52" href="#__codelineno-69-52"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the payment method.&quot;&quot;&quot;</span>
<a id="__codelineno-69-53" name="__codelineno-69-53" href="#__codelineno-69-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_payment_method</span> <span class="o">=</span> <span class="n">payment_method</span>
<a id="__codelineno-69-54" name="__codelineno-69-54" href="#__codelineno-69-54"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-69-55" name="__codelineno-69-55" href="#__codelineno-69-55"></a>
<a id="__codelineno-69-56" name="__codelineno-69-56" href="#__codelineno-69-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_discount_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-69-57" name="__codelineno-69-57" href="#__codelineno-69-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a discount code.&quot;&quot;&quot;</span>
<a id="__codelineno-69-58" name="__codelineno-69-58" href="#__codelineno-69-58"></a>        <span class="k">if</span> <span class="n">code</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="p">:</span>
<a id="__codelineno-69-59" name="__codelineno-69-59" href="#__codelineno-69-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<a id="__codelineno-69-60" name="__codelineno-69-60" href="#__codelineno-69-60"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-69-61" name="__codelineno-69-61" href="#__codelineno-69-61"></a>
<a id="__codelineno-69-62" name="__codelineno-69-62" href="#__codelineno-69-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_special_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-69-63" name="__codelineno-69-63" href="#__codelineno-69-63"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add special instructions.&quot;&quot;&quot;</span>
<a id="__codelineno-69-64" name="__codelineno-69-64" href="#__codelineno-69-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_special_instructions</span> <span class="o">=</span> <span class="n">instructions</span>
<a id="__codelineno-69-65" name="__codelineno-69-65" href="#__codelineno-69-65"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-69-66" name="__codelineno-69-66" href="#__codelineno-69-66"></a>
<a id="__codelineno-69-67" name="__codelineno-69-67" href="#__codelineno-69-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-69-68" name="__codelineno-69-68" href="#__codelineno-69-68"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the order with validation.&quot;&quot;&quot;</span>
<a id="__codelineno-69-69" name="__codelineno-69-69" href="#__codelineno-69-69"></a>        <span class="c1"># Validate required fields</span>
<a id="__codelineno-69-70" name="__codelineno-69-70" href="#__codelineno-69-70"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span><span class="p">:</span>
<a id="__codelineno-69-71" name="__codelineno-69-71" href="#__codelineno-69-71"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Order ID is required&quot;</span><span class="p">)</span>
<a id="__codelineno-69-72" name="__codelineno-69-72" href="#__codelineno-69-72"></a>
<a id="__codelineno-69-73" name="__codelineno-69-73" href="#__codelineno-69-73"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span><span class="p">:</span>
<a id="__codelineno-69-74" name="__codelineno-69-74" href="#__codelineno-69-74"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Customer ID is required&quot;</span><span class="p">)</span>
<a id="__codelineno-69-75" name="__codelineno-69-75" href="#__codelineno-69-75"></a>
<a id="__codelineno-69-76" name="__codelineno-69-76" href="#__codelineno-69-76"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span>
<a id="__codelineno-69-77" name="__codelineno-69-77" href="#__codelineno-69-77"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Order must have at least one item&quot;</span><span class="p">)</span>
<a id="__codelineno-69-78" name="__codelineno-69-78" href="#__codelineno-69-78"></a>
<a id="__codelineno-69-79" name="__codelineno-69-79" href="#__codelineno-69-79"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="p">:</span>
<a id="__codelineno-69-80" name="__codelineno-69-80" href="#__codelineno-69-80"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shipping address is required&quot;</span><span class="p">)</span>
<a id="__codelineno-69-81" name="__codelineno-69-81" href="#__codelineno-69-81"></a>
<a id="__codelineno-69-82" name="__codelineno-69-82" href="#__codelineno-69-82"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_payment_method</span><span class="p">:</span>
<a id="__codelineno-69-83" name="__codelineno-69-83" href="#__codelineno-69-83"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Payment method is required&quot;</span><span class="p">)</span>
<a id="__codelineno-69-84" name="__codelineno-69-84" href="#__codelineno-69-84"></a>
<a id="__codelineno-69-85" name="__codelineno-69-85" href="#__codelineno-69-85"></a>        <span class="c1"># Calculate total</span>
<a id="__codelineno-69-86" name="__codelineno-69-86" href="#__codelineno-69-86"></a>        <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>
<a id="__codelineno-69-87" name="__codelineno-69-87" href="#__codelineno-69-87"></a>
<a id="__codelineno-69-88" name="__codelineno-69-88" href="#__codelineno-69-88"></a>        <span class="c1"># Apply discounts (simplified)</span>
<a id="__codelineno-69-89" name="__codelineno-69-89" href="#__codelineno-69-89"></a>        <span class="n">discount</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-69-90" name="__codelineno-69-90" href="#__codelineno-69-90"></a>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="p">:</span>
<a id="__codelineno-69-91" name="__codelineno-69-91" href="#__codelineno-69-91"></a>            <span class="n">discount</span> <span class="o">=</span> <span class="n">discount</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calculate_discount</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">subtotal</span><span class="p">))</span>
<a id="__codelineno-69-92" name="__codelineno-69-92" href="#__codelineno-69-92"></a>
<a id="__codelineno-69-93" name="__codelineno-69-93" href="#__codelineno-69-93"></a>        <span class="c1"># Calculate taxes and shipping</span>
<a id="__codelineno-69-94" name="__codelineno-69-94" href="#__codelineno-69-94"></a>        <span class="n">tax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_tax</span><span class="p">(</span><span class="n">subtotal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="p">)</span>
<a id="__codelineno-69-95" name="__codelineno-69-95" href="#__codelineno-69-95"></a>        <span class="n">shipping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_shipping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="p">)</span>
<a id="__codelineno-69-96" name="__codelineno-69-96" href="#__codelineno-69-96"></a>
<a id="__codelineno-69-97" name="__codelineno-69-97" href="#__codelineno-69-97"></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">discount</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tax</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">shipping</span><span class="p">)</span>
<a id="__codelineno-69-98" name="__codelineno-69-98" href="#__codelineno-69-98"></a>
<a id="__codelineno-69-99" name="__codelineno-69-99" href="#__codelineno-69-99"></a>        <span class="c1"># Build order details</span>
<a id="__codelineno-69-100" name="__codelineno-69-100" href="#__codelineno-69-100"></a>        <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-69-101" name="__codelineno-69-101" href="#__codelineno-69-101"></a>            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">],</span>
<a id="__codelineno-69-102" name="__codelineno-69-102" href="#__codelineno-69-102"></a>            <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
<a id="__codelineno-69-103" name="__codelineno-69-103" href="#__codelineno-69-103"></a>            <span class="s2">&quot;billing_address&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_billing_address</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_billing_address</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-69-104" name="__codelineno-69-104" href="#__codelineno-69-104"></a>            <span class="s2">&quot;payment_method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_payment_method</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
<a id="__codelineno-69-105" name="__codelineno-69-105" href="#__codelineno-69-105"></a>            <span class="s2">&quot;discount_codes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="p">,</span>
<a id="__codelineno-69-106" name="__codelineno-69-106" href="#__codelineno-69-106"></a>            <span class="s2">&quot;special_instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_instructions</span><span class="p">,</span>
<a id="__codelineno-69-107" name="__codelineno-69-107" href="#__codelineno-69-107"></a>            <span class="s2">&quot;subtotal&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">subtotal</span><span class="p">),</span>
<a id="__codelineno-69-108" name="__codelineno-69-108" href="#__codelineno-69-108"></a>            <span class="s2">&quot;discount&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">discount</span><span class="p">),</span>
<a id="__codelineno-69-109" name="__codelineno-69-109" href="#__codelineno-69-109"></a>            <span class="s2">&quot;tax&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">tax</span><span class="p">),</span>
<a id="__codelineno-69-110" name="__codelineno-69-110" href="#__codelineno-69-110"></a>            <span class="s2">&quot;shipping&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">shipping</span><span class="p">),</span>
<a id="__codelineno-69-111" name="__codelineno-69-111" href="#__codelineno-69-111"></a>        <span class="p">}</span>
<a id="__codelineno-69-112" name="__codelineno-69-112" href="#__codelineno-69-112"></a>
<a id="__codelineno-69-113" name="__codelineno-69-113" href="#__codelineno-69-113"></a>        <span class="c1"># Create order using factory method</span>
<a id="__codelineno-69-114" name="__codelineno-69-114" href="#__codelineno-69-114"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-69-115" name="__codelineno-69-115" href="#__codelineno-69-115"></a>            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span><span class="p">,</span>
<a id="__codelineno-69-116" name="__codelineno-69-116" href="#__codelineno-69-116"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span><span class="p">,</span>
<a id="__codelineno-69-117" name="__codelineno-69-117" href="#__codelineno-69-117"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-69-118" name="__codelineno-69-118" href="#__codelineno-69-118"></a>            <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
<a id="__codelineno-69-119" name="__codelineno-69-119" href="#__codelineno-69-119"></a>        <span class="p">)</span>
<a id="__codelineno-69-120" name="__codelineno-69-120" href="#__codelineno-69-120"></a>
<a id="__codelineno-69-121" name="__codelineno-69-121" href="#__codelineno-69-121"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subtotal</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-69-122" name="__codelineno-69-122" href="#__codelineno-69-122"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate discount for a code (simplified implementation).&quot;&quot;&quot;</span>
<a id="__codelineno-69-123" name="__codelineno-69-123" href="#__codelineno-69-123"></a>        <span class="c1"># In real implementation, this would query discount service</span>
<a id="__codelineno-69-124" name="__codelineno-69-124" href="#__codelineno-69-124"></a>        <span class="n">discount_rates</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-69-125" name="__codelineno-69-125" href="#__codelineno-69-125"></a>            <span class="s2">&quot;SAVE10&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.10&quot;</span><span class="p">),</span>
<a id="__codelineno-69-126" name="__codelineno-69-126" href="#__codelineno-69-126"></a>            <span class="s2">&quot;WELCOME&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.15&quot;</span><span class="p">),</span>
<a id="__codelineno-69-127" name="__codelineno-69-127" href="#__codelineno-69-127"></a>            <span class="s2">&quot;LOYALTY&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.05&quot;</span><span class="p">),</span>
<a id="__codelineno-69-128" name="__codelineno-69-128" href="#__codelineno-69-128"></a>        <span class="p">}</span>
<a id="__codelineno-69-129" name="__codelineno-69-129" href="#__codelineno-69-129"></a>
<a id="__codelineno-69-130" name="__codelineno-69-130" href="#__codelineno-69-130"></a>        <span class="n">rate</span> <span class="o">=</span> <span class="n">discount_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>
<a id="__codelineno-69-131" name="__codelineno-69-131" href="#__codelineno-69-131"></a>        <span class="k">return</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
<a id="__codelineno-69-132" name="__codelineno-69-132" href="#__codelineno-69-132"></a>
<a id="__codelineno-69-133" name="__codelineno-69-133" href="#__codelineno-69-133"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_tax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtotal</span><span class="p">:</span> <span class="n">Money</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-69-134" name="__codelineno-69-134" href="#__codelineno-69-134"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate tax based on shipping address.&quot;&quot;&quot;</span>
<a id="__codelineno-69-135" name="__codelineno-69-135" href="#__codelineno-69-135"></a>        <span class="c1"># Simplified tax calculation</span>
<a id="__codelineno-69-136" name="__codelineno-69-136" href="#__codelineno-69-136"></a>        <span class="n">tax_rates</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-69-137" name="__codelineno-69-137" href="#__codelineno-69-137"></a>            <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0875&quot;</span><span class="p">),</span>  <span class="c1"># California</span>
<a id="__codelineno-69-138" name="__codelineno-69-138" href="#__codelineno-69-138"></a>            <span class="s2">&quot;NY&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.08&quot;</span><span class="p">),</span>    <span class="c1"># New York</span>
<a id="__codelineno-69-139" name="__codelineno-69-139" href="#__codelineno-69-139"></a>            <span class="s2">&quot;TX&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0625&quot;</span><span class="p">),</span>  <span class="c1"># Texas</span>
<a id="__codelineno-69-140" name="__codelineno-69-140" href="#__codelineno-69-140"></a>        <span class="p">}</span>
<a id="__codelineno-69-141" name="__codelineno-69-141" href="#__codelineno-69-141"></a>
<a id="__codelineno-69-142" name="__codelineno-69-142" href="#__codelineno-69-142"></a>        <span class="n">rate</span> <span class="o">=</span> <span class="n">tax_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.05&quot;</span><span class="p">))</span>  <span class="c1"># Default 5%</span>
<a id="__codelineno-69-143" name="__codelineno-69-143" href="#__codelineno-69-143"></a>        <span class="k">return</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
<a id="__codelineno-69-144" name="__codelineno-69-144" href="#__codelineno-69-144"></a>
<a id="__codelineno-69-145" name="__codelineno-69-145" href="#__codelineno-69-145"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_shipping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">],</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-69-146" name="__codelineno-69-146" href="#__codelineno-69-146"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate shipping cost.&quot;&quot;&quot;</span>
<a id="__codelineno-69-147" name="__codelineno-69-147" href="#__codelineno-69-147"></a>        <span class="c1"># Simplified shipping calculation</span>
<a id="__codelineno-69-148" name="__codelineno-69-148" href="#__codelineno-69-148"></a>        <span class="n">base_shipping</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;9.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-69-149" name="__codelineno-69-149" href="#__codelineno-69-149"></a>
<a id="__codelineno-69-150" name="__codelineno-69-150" href="#__codelineno-69-150"></a>        <span class="c1"># Free shipping for orders over $100</span>
<a id="__codelineno-69-151" name="__codelineno-69-151" href="#__codelineno-69-151"></a>        <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
<a id="__codelineno-69-152" name="__codelineno-69-152" href="#__codelineno-69-152"></a>        <span class="k">if</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
<a id="__codelineno-69-153" name="__codelineno-69-153" href="#__codelineno-69-153"></a>            <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-69-154" name="__codelineno-69-154" href="#__codelineno-69-154"></a>
<a id="__codelineno-69-155" name="__codelineno-69-155" href="#__codelineno-69-155"></a>        <span class="c1"># International shipping</span>
<a id="__codelineno-69-156" name="__codelineno-69-156" href="#__codelineno-69-156"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="o">.</span><span class="n">is_us_address</span><span class="p">():</span>
<a id="__codelineno-69-157" name="__codelineno-69-157" href="#__codelineno-69-157"></a>            <span class="k">return</span> <span class="n">base_shipping</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-69-158" name="__codelineno-69-158" href="#__codelineno-69-158"></a>
<a id="__codelineno-69-159" name="__codelineno-69-159" href="#__codelineno-69-159"></a>        <span class="k">return</span> <span class="n">base_shipping</span>
<a id="__codelineno-69-160" name="__codelineno-69-160" href="#__codelineno-69-160"></a>
<a id="__codelineno-69-161" name="__codelineno-69-161" href="#__codelineno-69-161"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-69-162" name="__codelineno-69-162" href="#__codelineno-69-162"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderItem</span><span class="p">:</span>
<a id="__codelineno-69-163" name="__codelineno-69-163" href="#__codelineno-69-163"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Individual order item.&quot;&quot;&quot;</span>
<a id="__codelineno-69-164" name="__codelineno-69-164" href="#__codelineno-69-164"></a>
<a id="__codelineno-69-165" name="__codelineno-69-165" href="#__codelineno-69-165"></a>    <span class="n">product_id</span><span class="p">:</span> <span class="n">ProductId</span>
<a id="__codelineno-69-166" name="__codelineno-69-166" href="#__codelineno-69-166"></a>    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-69-167" name="__codelineno-69-167" href="#__codelineno-69-167"></a>    <span class="n">unit_price</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-69-168" name="__codelineno-69-168" href="#__codelineno-69-168"></a>
<a id="__codelineno-69-169" name="__codelineno-69-169" href="#__codelineno-69-169"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-69-170" name="__codelineno-69-170" href="#__codelineno-69-170"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate total price for this item.&quot;&quot;&quot;</span>
<a id="__codelineno-69-171" name="__codelineno-69-171" href="#__codelineno-69-171"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_price</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
<a id="__codelineno-69-172" name="__codelineno-69-172" href="#__codelineno-69-172"></a>
<a id="__codelineno-69-173" name="__codelineno-69-173" href="#__codelineno-69-173"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-69-174" name="__codelineno-69-174" href="#__codelineno-69-174"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to dictionary for serialization.&quot;&quot;&quot;</span>
<a id="__codelineno-69-175" name="__codelineno-69-175" href="#__codelineno-69-175"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-69-176" name="__codelineno-69-176" href="#__codelineno-69-176"></a>            <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_id</span><span class="p">),</span>
<a id="__codelineno-69-177" name="__codelineno-69-177" href="#__codelineno-69-177"></a>            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-69-178" name="__codelineno-69-178" href="#__codelineno-69-178"></a>            <span class="s2">&quot;unit_price&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_price</span><span class="p">),</span>
<a id="__codelineno-69-179" name="__codelineno-69-179" href="#__codelineno-69-179"></a>            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">()),</span>
<a id="__codelineno-69-180" name="__codelineno-69-180" href="#__codelineno-69-180"></a>        <span class="p">}</span>
</code></pre></div>
<p>The Builder pattern excels for complex creation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1"># Fluent order creation</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="n">order</span> <span class="o">=</span> <span class="p">(</span><span class="n">OrderBuilder</span><span class="p">()</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>    <span class="o">.</span><span class="n">with_id</span><span class="p">(</span><span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>    <span class="o">.</span><span class="n">for_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>    <span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;29.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">))</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>    <span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;49.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">))</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>    <span class="o">.</span><span class="n">with_shipping_address</span><span class="p">(</span><span class="n">shipping_address</span><span class="p">)</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>    <span class="o">.</span><span class="n">with_billing_address</span><span class="p">(</span><span class="n">billing_address</span><span class="p">)</span>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>    <span class="o">.</span><span class="n">with_payment_method</span><span class="p">(</span><span class="n">credit_card</span><span class="p">)</span>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>    <span class="o">.</span><span class="n">add_discount_code</span><span class="p">(</span><span class="s2">&quot;SAVE10&quot;</span><span class="p">)</span>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>    <span class="o">.</span><span class="n">with_special_instructions</span><span class="p">(</span><span class="s2">&quot;Leave at front door&quot;</span><span class="p">)</span>
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>    <span class="o">.</span><span class="n">build</span><span class="p">())</span>
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>
<a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a><span class="c1"># Order is guaranteed valid with all business rules applied</span>
<a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a><span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span>
<a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">get_domain_events</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># OrderCreated event</span>
</code></pre></div>
<h3 id="abstract-factory-for-families-of-objects"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#abstract-factory-for-families-of-objects">Abstract Factory for Families of Objects</a></h3>
<p>When you need to create related objects consistently, Abstract Factory provides a solution:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>    <span class="n">INDIVIDUAL</span> <span class="o">=</span> <span class="s2">&quot;individual&quot;</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>    <span class="n">BUSINESS</span> <span class="o">=</span> <span class="s2">&quot;business&quot;</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>    <span class="n">PREMIUM</span> <span class="o">=</span> <span class="s2">&quot;premium&quot;</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract factory for customer creation.&quot;&quot;&quot;</span>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> 
<a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a customer of the appropriate type.&quot;&quot;&quot;</span>
<a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a>        <span class="k">pass</span>
<a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a>
<a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_account_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccountSettings</span><span class="p">:</span>
<a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create account settings for the customer type.&quot;&quot;&quot;</span>
<a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a>        <span class="k">pass</span>
<a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a>
<a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_notification_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotificationPreferences</span><span class="p">:</span>
<a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create notification preferences for the customer type.&quot;&quot;&quot;</span>
<a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a>        <span class="k">pass</span>
<a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a>
<a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a><span class="k">class</span><span class="w"> </span><span class="nc">IndividualCustomerFactory</span><span class="p">(</span><span class="n">CustomerFactory</span><span class="p">):</span>
<a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for individual customers.&quot;&quot;&quot;</span>
<a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a>
<a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-71-37" name="__codelineno-71-37" href="#__codelineno-71-37"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-71-38" name="__codelineno-71-38" href="#__codelineno-71-38"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> 
<a id="__codelineno-71-39" name="__codelineno-71-39" href="#__codelineno-71-39"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-71-40" name="__codelineno-71-40" href="#__codelineno-71-40"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-71-41" name="__codelineno-71-41" href="#__codelineno-71-41"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-71-42" name="__codelineno-71-42" href="#__codelineno-71-42"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-71-43" name="__codelineno-71-43" href="#__codelineno-71-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an individual customer.&quot;&quot;&quot;</span>
<a id="__codelineno-71-44" name="__codelineno-71-44" href="#__codelineno-71-44"></a>        <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-71-45" name="__codelineno-71-45" href="#__codelineno-71-45"></a>            <span class="s2">&quot;customer_type&quot;</span><span class="p">:</span> <span class="s2">&quot;individual&quot;</span><span class="p">,</span>
<a id="__codelineno-71-46" name="__codelineno-71-46" href="#__codelineno-71-46"></a>            <span class="s2">&quot;marketing_emails&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-47" name="__codelineno-71-47" href="#__codelineno-71-47"></a>            <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-48" name="__codelineno-71-48" href="#__codelineno-71-48"></a>            <span class="s2">&quot;account_limit&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5000&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-71-49" name="__codelineno-71-49" href="#__codelineno-71-49"></a>        <span class="p">}</span>
<a id="__codelineno-71-50" name="__codelineno-71-50" href="#__codelineno-71-50"></a>        <span class="n">preferences</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-71-51" name="__codelineno-71-51" href="#__codelineno-71-51"></a>
<a id="__codelineno-71-52" name="__codelineno-71-52" href="#__codelineno-71-52"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-71-53" name="__codelineno-71-53" href="#__codelineno-71-53"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-71-54" name="__codelineno-71-54" href="#__codelineno-71-54"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-71-55" name="__codelineno-71-55" href="#__codelineno-71-55"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-71-56" name="__codelineno-71-56" href="#__codelineno-71-56"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-71-57" name="__codelineno-71-57" href="#__codelineno-71-57"></a>        <span class="p">)</span>
<a id="__codelineno-71-58" name="__codelineno-71-58" href="#__codelineno-71-58"></a>
<a id="__codelineno-71-59" name="__codelineno-71-59" href="#__codelineno-71-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_account_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccountSettings</span><span class="p">:</span>
<a id="__codelineno-71-60" name="__codelineno-71-60" href="#__codelineno-71-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create individual account settings.&quot;&quot;&quot;</span>
<a id="__codelineno-71-61" name="__codelineno-71-61" href="#__codelineno-71-61"></a>        <span class="k">return</span> <span class="n">AccountSettings</span><span class="p">(</span>
<a id="__codelineno-71-62" name="__codelineno-71-62" href="#__codelineno-71-62"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-71-63" name="__codelineno-71-63" href="#__codelineno-71-63"></a>            <span class="n">two_factor_required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-71-64" name="__codelineno-71-64" href="#__codelineno-71-64"></a>            <span class="n">session_timeout_minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-71-65" name="__codelineno-71-65" href="#__codelineno-71-65"></a>            <span class="n">password_expiry_days</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
<a id="__codelineno-71-66" name="__codelineno-71-66" href="#__codelineno-71-66"></a>        <span class="p">)</span>
<a id="__codelineno-71-67" name="__codelineno-71-67" href="#__codelineno-71-67"></a>
<a id="__codelineno-71-68" name="__codelineno-71-68" href="#__codelineno-71-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_notification_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotificationPreferences</span><span class="p">:</span>
<a id="__codelineno-71-69" name="__codelineno-71-69" href="#__codelineno-71-69"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create individual notification preferences.&quot;&quot;&quot;</span>
<a id="__codelineno-71-70" name="__codelineno-71-70" href="#__codelineno-71-70"></a>        <span class="k">return</span> <span class="n">NotificationPreferences</span><span class="p">(</span>
<a id="__codelineno-71-71" name="__codelineno-71-71" href="#__codelineno-71-71"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-71-72" name="__codelineno-71-72" href="#__codelineno-71-72"></a>            <span class="n">email_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-73" name="__codelineno-71-73" href="#__codelineno-71-73"></a>            <span class="n">sms_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-71-74" name="__codelineno-71-74" href="#__codelineno-71-74"></a>            <span class="n">push_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-75" name="__codelineno-71-75" href="#__codelineno-71-75"></a>            <span class="n">marketing_emails</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-76" name="__codelineno-71-76" href="#__codelineno-71-76"></a>        <span class="p">)</span>
<a id="__codelineno-71-77" name="__codelineno-71-77" href="#__codelineno-71-77"></a>
<a id="__codelineno-71-78" name="__codelineno-71-78" href="#__codelineno-71-78"></a><span class="k">class</span><span class="w"> </span><span class="nc">BusinessCustomerFactory</span><span class="p">(</span><span class="n">CustomerFactory</span><span class="p">):</span>
<a id="__codelineno-71-79" name="__codelineno-71-79" href="#__codelineno-71-79"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for business customers.&quot;&quot;&quot;</span>
<a id="__codelineno-71-80" name="__codelineno-71-80" href="#__codelineno-71-80"></a>
<a id="__codelineno-71-81" name="__codelineno-71-81" href="#__codelineno-71-81"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-71-82" name="__codelineno-71-82" href="#__codelineno-71-82"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-71-83" name="__codelineno-71-83" href="#__codelineno-71-83"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> 
<a id="__codelineno-71-84" name="__codelineno-71-84" href="#__codelineno-71-84"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-71-85" name="__codelineno-71-85" href="#__codelineno-71-85"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-71-86" name="__codelineno-71-86" href="#__codelineno-71-86"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-71-87" name="__codelineno-71-87" href="#__codelineno-71-87"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-71-88" name="__codelineno-71-88" href="#__codelineno-71-88"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a business customer.&quot;&quot;&quot;</span>
<a id="__codelineno-71-89" name="__codelineno-71-89" href="#__codelineno-71-89"></a>        <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-71-90" name="__codelineno-71-90" href="#__codelineno-71-90"></a>            <span class="s2">&quot;customer_type&quot;</span><span class="p">:</span> <span class="s2">&quot;business&quot;</span><span class="p">,</span>
<a id="__codelineno-71-91" name="__codelineno-71-91" href="#__codelineno-71-91"></a>            <span class="s2">&quot;marketing_emails&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-71-92" name="__codelineno-71-92" href="#__codelineno-71-92"></a>            <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-71-93" name="__codelineno-71-93" href="#__codelineno-71-93"></a>            <span class="s2">&quot;account_limit&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50000&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-71-94" name="__codelineno-71-94" href="#__codelineno-71-94"></a>            <span class="s2">&quot;tax_exempt&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tax_exempt&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-71-95" name="__codelineno-71-95" href="#__codelineno-71-95"></a>            <span class="s2">&quot;net_payment_terms&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payment_terms&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
<a id="__codelineno-71-96" name="__codelineno-71-96" href="#__codelineno-71-96"></a>        <span class="p">}</span>
<a id="__codelineno-71-97" name="__codelineno-71-97" href="#__codelineno-71-97"></a>        <span class="n">preferences</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-71-98" name="__codelineno-71-98" href="#__codelineno-71-98"></a>
<a id="__codelineno-71-99" name="__codelineno-71-99" href="#__codelineno-71-99"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-71-100" name="__codelineno-71-100" href="#__codelineno-71-100"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-71-101" name="__codelineno-71-101" href="#__codelineno-71-101"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-71-102" name="__codelineno-71-102" href="#__codelineno-71-102"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-71-103" name="__codelineno-71-103" href="#__codelineno-71-103"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-71-104" name="__codelineno-71-104" href="#__codelineno-71-104"></a>        <span class="p">)</span>
<a id="__codelineno-71-105" name="__codelineno-71-105" href="#__codelineno-71-105"></a>
<a id="__codelineno-71-106" name="__codelineno-71-106" href="#__codelineno-71-106"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_account_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccountSettings</span><span class="p">:</span>
<a id="__codelineno-71-107" name="__codelineno-71-107" href="#__codelineno-71-107"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create business account settings.&quot;&quot;&quot;</span>
<a id="__codelineno-71-108" name="__codelineno-71-108" href="#__codelineno-71-108"></a>        <span class="k">return</span> <span class="n">AccountSettings</span><span class="p">(</span>
<a id="__codelineno-71-109" name="__codelineno-71-109" href="#__codelineno-71-109"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-71-110" name="__codelineno-71-110" href="#__codelineno-71-110"></a>            <span class="n">two_factor_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-111" name="__codelineno-71-111" href="#__codelineno-71-111"></a>            <span class="n">session_timeout_minutes</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-71-112" name="__codelineno-71-112" href="#__codelineno-71-112"></a>            <span class="n">password_expiry_days</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-71-113" name="__codelineno-71-113" href="#__codelineno-71-113"></a>            <span class="n">ip_restrictions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-114" name="__codelineno-71-114" href="#__codelineno-71-114"></a>        <span class="p">)</span>
<a id="__codelineno-71-115" name="__codelineno-71-115" href="#__codelineno-71-115"></a>
<a id="__codelineno-71-116" name="__codelineno-71-116" href="#__codelineno-71-116"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_notification_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotificationPreferences</span><span class="p">:</span>
<a id="__codelineno-71-117" name="__codelineno-71-117" href="#__codelineno-71-117"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create business notification preferences.&quot;&quot;&quot;</span>
<a id="__codelineno-71-118" name="__codelineno-71-118" href="#__codelineno-71-118"></a>        <span class="k">return</span> <span class="n">NotificationPreferences</span><span class="p">(</span>
<a id="__codelineno-71-119" name="__codelineno-71-119" href="#__codelineno-71-119"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-71-120" name="__codelineno-71-120" href="#__codelineno-71-120"></a>            <span class="n">email_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-121" name="__codelineno-71-121" href="#__codelineno-71-121"></a>            <span class="n">sms_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-122" name="__codelineno-71-122" href="#__codelineno-71-122"></a>            <span class="n">push_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-71-123" name="__codelineno-71-123" href="#__codelineno-71-123"></a>            <span class="n">marketing_emails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-71-124" name="__codelineno-71-124" href="#__codelineno-71-124"></a>            <span class="n">billing_alerts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-125" name="__codelineno-71-125" href="#__codelineno-71-125"></a>            <span class="n">order_confirmations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-126" name="__codelineno-71-126" href="#__codelineno-71-126"></a>        <span class="p">)</span>
<a id="__codelineno-71-127" name="__codelineno-71-127" href="#__codelineno-71-127"></a>
<a id="__codelineno-71-128" name="__codelineno-71-128" href="#__codelineno-71-128"></a><span class="k">class</span><span class="w"> </span><span class="nc">PremiumCustomerFactory</span><span class="p">(</span><span class="n">CustomerFactory</span><span class="p">):</span>
<a id="__codelineno-71-129" name="__codelineno-71-129" href="#__codelineno-71-129"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for premium customers.&quot;&quot;&quot;</span>
<a id="__codelineno-71-130" name="__codelineno-71-130" href="#__codelineno-71-130"></a>
<a id="__codelineno-71-131" name="__codelineno-71-131" href="#__codelineno-71-131"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-71-132" name="__codelineno-71-132" href="#__codelineno-71-132"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-71-133" name="__codelineno-71-133" href="#__codelineno-71-133"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> 
<a id="__codelineno-71-134" name="__codelineno-71-134" href="#__codelineno-71-134"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-71-135" name="__codelineno-71-135" href="#__codelineno-71-135"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-71-136" name="__codelineno-71-136" href="#__codelineno-71-136"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-71-137" name="__codelineno-71-137" href="#__codelineno-71-137"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-71-138" name="__codelineno-71-138" href="#__codelineno-71-138"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a premium customer.&quot;&quot;&quot;</span>
<a id="__codelineno-71-139" name="__codelineno-71-139" href="#__codelineno-71-139"></a>        <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-71-140" name="__codelineno-71-140" href="#__codelineno-71-140"></a>            <span class="s2">&quot;customer_type&quot;</span><span class="p">:</span> <span class="s2">&quot;premium&quot;</span><span class="p">,</span>
<a id="__codelineno-71-141" name="__codelineno-71-141" href="#__codelineno-71-141"></a>            <span class="s2">&quot;marketing_emails&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-142" name="__codelineno-71-142" href="#__codelineno-71-142"></a>            <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-143" name="__codelineno-71-143" href="#__codelineno-71-143"></a>            <span class="s2">&quot;account_limit&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100000&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-71-144" name="__codelineno-71-144" href="#__codelineno-71-144"></a>            <span class="s2">&quot;concierge_service&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-145" name="__codelineno-71-145" href="#__codelineno-71-145"></a>            <span class="s2">&quot;priority_support&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-146" name="__codelineno-71-146" href="#__codelineno-71-146"></a>            <span class="s2">&quot;free_shipping&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-147" name="__codelineno-71-147" href="#__codelineno-71-147"></a>        <span class="p">}</span>
<a id="__codelineno-71-148" name="__codelineno-71-148" href="#__codelineno-71-148"></a>        <span class="n">preferences</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-71-149" name="__codelineno-71-149" href="#__codelineno-71-149"></a>
<a id="__codelineno-71-150" name="__codelineno-71-150" href="#__codelineno-71-150"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-71-151" name="__codelineno-71-151" href="#__codelineno-71-151"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-71-152" name="__codelineno-71-152" href="#__codelineno-71-152"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-71-153" name="__codelineno-71-153" href="#__codelineno-71-153"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-71-154" name="__codelineno-71-154" href="#__codelineno-71-154"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-71-155" name="__codelineno-71-155" href="#__codelineno-71-155"></a>        <span class="p">)</span>
<a id="__codelineno-71-156" name="__codelineno-71-156" href="#__codelineno-71-156"></a>
<a id="__codelineno-71-157" name="__codelineno-71-157" href="#__codelineno-71-157"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_account_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccountSettings</span><span class="p">:</span>
<a id="__codelineno-71-158" name="__codelineno-71-158" href="#__codelineno-71-158"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create premium account settings.&quot;&quot;&quot;</span>
<a id="__codelineno-71-159" name="__codelineno-71-159" href="#__codelineno-71-159"></a>        <span class="k">return</span> <span class="n">AccountSettings</span><span class="p">(</span>
<a id="__codelineno-71-160" name="__codelineno-71-160" href="#__codelineno-71-160"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-71-161" name="__codelineno-71-161" href="#__codelineno-71-161"></a>            <span class="n">two_factor_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-162" name="__codelineno-71-162" href="#__codelineno-71-162"></a>            <span class="n">session_timeout_minutes</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
<a id="__codelineno-71-163" name="__codelineno-71-163" href="#__codelineno-71-163"></a>            <span class="n">password_expiry_days</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-71-164" name="__codelineno-71-164" href="#__codelineno-71-164"></a>            <span class="n">dedicated_support</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-165" name="__codelineno-71-165" href="#__codelineno-71-165"></a>        <span class="p">)</span>
<a id="__codelineno-71-166" name="__codelineno-71-166" href="#__codelineno-71-166"></a>
<a id="__codelineno-71-167" name="__codelineno-71-167" href="#__codelineno-71-167"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_notification_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotificationPreferences</span><span class="p">:</span>
<a id="__codelineno-71-168" name="__codelineno-71-168" href="#__codelineno-71-168"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create premium notification preferences.&quot;&quot;&quot;</span>
<a id="__codelineno-71-169" name="__codelineno-71-169" href="#__codelineno-71-169"></a>        <span class="k">return</span> <span class="n">NotificationPreferences</span><span class="p">(</span>
<a id="__codelineno-71-170" name="__codelineno-71-170" href="#__codelineno-71-170"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-71-171" name="__codelineno-71-171" href="#__codelineno-71-171"></a>            <span class="n">email_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-172" name="__codelineno-71-172" href="#__codelineno-71-172"></a>            <span class="n">sms_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-173" name="__codelineno-71-173" href="#__codelineno-71-173"></a>            <span class="n">push_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-174" name="__codelineno-71-174" href="#__codelineno-71-174"></a>            <span class="n">marketing_emails</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-175" name="__codelineno-71-175" href="#__codelineno-71-175"></a>            <span class="n">vip_offers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-176" name="__codelineno-71-176" href="#__codelineno-71-176"></a>            <span class="n">personal_shopper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-71-177" name="__codelineno-71-177" href="#__codelineno-71-177"></a>        <span class="p">)</span>
<a id="__codelineno-71-178" name="__codelineno-71-178" href="#__codelineno-71-178"></a>
<a id="__codelineno-71-179" name="__codelineno-71-179" href="#__codelineno-71-179"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_customer_factory</span><span class="p">(</span><span class="n">customer_type</span><span class="p">:</span> <span class="n">CustomerType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-71-180" name="__codelineno-71-180" href="#__codelineno-71-180"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the appropriate factory for customer type.&quot;&quot;&quot;</span>
<a id="__codelineno-71-181" name="__codelineno-71-181" href="#__codelineno-71-181"></a>    <span class="n">factories</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-71-182" name="__codelineno-71-182" href="#__codelineno-71-182"></a>        <span class="n">CustomerType</span><span class="o">.</span><span class="n">INDIVIDUAL</span><span class="p">:</span> <span class="n">IndividualCustomerFactory</span><span class="p">(),</span>
<a id="__codelineno-71-183" name="__codelineno-71-183" href="#__codelineno-71-183"></a>        <span class="n">CustomerType</span><span class="o">.</span><span class="n">BUSINESS</span><span class="p">:</span> <span class="n">BusinessCustomerFactory</span><span class="p">(),</span>
<a id="__codelineno-71-184" name="__codelineno-71-184" href="#__codelineno-71-184"></a>        <span class="n">CustomerType</span><span class="o">.</span><span class="n">PREMIUM</span><span class="p">:</span> <span class="n">PremiumCustomerFactory</span><span class="p">(),</span>
<a id="__codelineno-71-185" name="__codelineno-71-185" href="#__codelineno-71-185"></a>    <span class="p">}</span>
<a id="__codelineno-71-186" name="__codelineno-71-186" href="#__codelineno-71-186"></a>    <span class="k">return</span> <span class="n">factories</span><span class="p">[</span><span class="n">customer_type</span><span class="p">]</span>
</code></pre></div>
<p>Usage ensures consistency across related objects:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="c1"># Consistent object family creation</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">onboard_new_customer</span><span class="p">(</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>    <span class="n">customer_type</span><span class="p">:</span> <span class="n">CustomerType</span><span class="p">,</span>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>    <span class="n">email_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>    <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Customer</span><span class="p">,</span> <span class="n">AccountSettings</span><span class="p">,</span> <span class="n">NotificationPreferences</span><span class="p">]:</span>
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Onboard a new customer with all related objects.&quot;&quot;&quot;</span>
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>    <span class="n">factory</span> <span class="o">=</span> <span class="n">get_customer_factory</span><span class="p">(</span><span class="n">customer_type</span><span class="p">)</span>
<a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>
<a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">email_str</span><span class="p">)</span>
<a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>
<a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>    <span class="c1"># Create related objects consistently</span>
<a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a>    <span class="n">account_settings</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_account_settings</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a>    <span class="n">notifications</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_notification_preferences</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a>
<a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a>    <span class="k">return</span> <span class="n">customer</span><span class="p">,</span> <span class="n">account_settings</span><span class="p">,</span> <span class="n">notifications</span>
<a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a>
<a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a><span class="c1"># All related objects have consistent configuration for the customer type</span>
<a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a><span class="n">individual_customer</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">preferences</span> <span class="o">=</span> <span class="n">onboard_new_customer</span><span class="p">(</span>
<a id="__codelineno-72-24" name="__codelineno-72-24" href="#__codelineno-72-24"></a>    <span class="n">CustomerType</span><span class="o">.</span><span class="n">INDIVIDUAL</span><span class="p">,</span>
<a id="__codelineno-72-25" name="__codelineno-72-25" href="#__codelineno-72-25"></a>    <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-72-26" name="__codelineno-72-26" href="#__codelineno-72-26"></a>    <span class="s2">&quot;john@example.com&quot;</span>
<a id="__codelineno-72-27" name="__codelineno-72-27" href="#__codelineno-72-27"></a><span class="p">)</span>
<a id="__codelineno-72-28" name="__codelineno-72-28" href="#__codelineno-72-28"></a>
<a id="__codelineno-72-29" name="__codelineno-72-29" href="#__codelineno-72-29"></a><span class="n">business_customer</span><span class="p">,</span> <span class="n">biz_settings</span><span class="p">,</span> <span class="n">biz_preferences</span> <span class="o">=</span> <span class="n">onboard_new_customer</span><span class="p">(</span>
<a id="__codelineno-72-30" name="__codelineno-72-30" href="#__codelineno-72-30"></a>    <span class="n">CustomerType</span><span class="o">.</span><span class="n">BUSINESS</span><span class="p">,</span>
<a id="__codelineno-72-31" name="__codelineno-72-31" href="#__codelineno-72-31"></a>    <span class="s2">&quot;Acme Corp&quot;</span><span class="p">,</span>
<a id="__codelineno-72-32" name="__codelineno-72-32" href="#__codelineno-72-32"></a>    <span class="s2">&quot;admin@acme.com&quot;</span><span class="p">,</span>
<a id="__codelineno-72-33" name="__codelineno-72-33" href="#__codelineno-72-33"></a>    <span class="n">tax_exempt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-72-34" name="__codelineno-72-34" href="#__codelineno-72-34"></a>    <span class="n">payment_terms</span><span class="o">=</span><span class="mi">60</span>
<a id="__codelineno-72-35" name="__codelineno-72-35" href="#__codelineno-72-35"></a><span class="p">)</span>
</code></pre></div>
<h3 id="testing-factory-patterns"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#testing-factory-patterns">Testing Factory Patterns</a></h3>
<p>Factory patterns make testing easier by centralizing creation logic:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c1"># tests/unit/domain/test_customer.py</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomer</span><span class="p">:</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_customer_creation_with_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating a customer using the factory method.&quot;&quot;&quot;</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>            <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">},</span>
<a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a>        <span class="p">)</span>
<a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>
<a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span>
<a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a>
<a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a>        <span class="c1"># Check domain events</span>
<a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">collect_domain_events</span><span class="p">()</span>
<a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">CustomerCreated</span><span class="p">)</span>
<a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a>        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a>        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">customer_name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a>
<a id="__codelineno-73-28" name="__codelineno-73-28" href="#__codelineno-73-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomerFactory</span><span class="p">:</span>
<a id="__codelineno-73-29" name="__codelineno-73-29" href="#__codelineno-73-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_individual_customer_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-73-30" name="__codelineno-73-30" href="#__codelineno-73-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test individual customer factory creates correct objects.&quot;&quot;&quot;</span>
<a id="__codelineno-73-31" name="__codelineno-73-31" href="#__codelineno-73-31"></a>        <span class="n">factory</span> <span class="o">=</span> <span class="n">IndividualCustomerFactory</span><span class="p">()</span>
<a id="__codelineno-73-32" name="__codelineno-73-32" href="#__codelineno-73-32"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-73-33" name="__codelineno-73-33" href="#__codelineno-73-33"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-73-34" name="__codelineno-73-34" href="#__codelineno-73-34"></a>
<a id="__codelineno-73-35" name="__codelineno-73-35" href="#__codelineno-73-35"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<a id="__codelineno-73-36" name="__codelineno-73-36" href="#__codelineno-73-36"></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_account_settings</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-73-37" name="__codelineno-73-37" href="#__codelineno-73-37"></a>        <span class="n">preferences</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_notification_preferences</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-73-38" name="__codelineno-73-38" href="#__codelineno-73-38"></a>
<a id="__codelineno-73-39" name="__codelineno-73-39" href="#__codelineno-73-39"></a>        <span class="c1"># Verify customer type-specific configuration</span>
<a id="__codelineno-73-40" name="__codelineno-73-40" href="#__codelineno-73-40"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s2">&quot;customer_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;individual&quot;</span>
<a id="__codelineno-73-41" name="__codelineno-73-41" href="#__codelineno-73-41"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s2">&quot;marketing_emails&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-73-42" name="__codelineno-73-42" href="#__codelineno-73-42"></a>        <span class="k">assert</span> <span class="n">settings</span><span class="o">.</span><span class="n">two_factor_required</span> <span class="o">==</span> <span class="kc">False</span>
<a id="__codelineno-73-43" name="__codelineno-73-43" href="#__codelineno-73-43"></a>        <span class="k">assert</span> <span class="n">preferences</span><span class="o">.</span><span class="n">marketing_emails</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-73-44" name="__codelineno-73-44" href="#__codelineno-73-44"></a>
<a id="__codelineno-73-45" name="__codelineno-73-45" href="#__codelineno-73-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_business_customer_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-73-46" name="__codelineno-73-46" href="#__codelineno-73-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test business customer factory creates correct objects.&quot;&quot;&quot;</span>
<a id="__codelineno-73-47" name="__codelineno-73-47" href="#__codelineno-73-47"></a>        <span class="n">factory</span> <span class="o">=</span> <span class="n">BusinessCustomerFactory</span><span class="p">()</span>
<a id="__codelineno-73-48" name="__codelineno-73-48" href="#__codelineno-73-48"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-73-49" name="__codelineno-73-49" href="#__codelineno-73-49"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;admin@business.com&quot;</span><span class="p">)</span>
<a id="__codelineno-73-50" name="__codelineno-73-50" href="#__codelineno-73-50"></a>
<a id="__codelineno-73-51" name="__codelineno-73-51" href="#__codelineno-73-51"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_customer</span><span class="p">(</span>
<a id="__codelineno-73-52" name="__codelineno-73-52" href="#__codelineno-73-52"></a>            <span class="n">customer_id</span><span class="p">,</span> 
<a id="__codelineno-73-53" name="__codelineno-73-53" href="#__codelineno-73-53"></a>            <span class="s2">&quot;Business Corp&quot;</span><span class="p">,</span> 
<a id="__codelineno-73-54" name="__codelineno-73-54" href="#__codelineno-73-54"></a>            <span class="n">email</span><span class="p">,</span>
<a id="__codelineno-73-55" name="__codelineno-73-55" href="#__codelineno-73-55"></a>            <span class="n">tax_exempt</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-73-56" name="__codelineno-73-56" href="#__codelineno-73-56"></a>        <span class="p">)</span>
<a id="__codelineno-73-57" name="__codelineno-73-57" href="#__codelineno-73-57"></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_account_settings</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-73-58" name="__codelineno-73-58" href="#__codelineno-73-58"></a>
<a id="__codelineno-73-59" name="__codelineno-73-59" href="#__codelineno-73-59"></a>        <span class="c1"># Verify business-specific configuration</span>
<a id="__codelineno-73-60" name="__codelineno-73-60" href="#__codelineno-73-60"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s2">&quot;customer_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;business&quot;</span>
<a id="__codelineno-73-61" name="__codelineno-73-61" href="#__codelineno-73-61"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s2">&quot;tax_exempt&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-73-62" name="__codelineno-73-62" href="#__codelineno-73-62"></a>        <span class="k">assert</span> <span class="n">settings</span><span class="o">.</span><span class="n">two_factor_required</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-73-63" name="__codelineno-73-63" href="#__codelineno-73-63"></a>        <span class="k">assert</span> <span class="n">settings</span><span class="o">.</span><span class="n">ip_restrictions</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-73-64" name="__codelineno-73-64" href="#__codelineno-73-64"></a>
<a id="__codelineno-73-65" name="__codelineno-73-65" href="#__codelineno-73-65"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestOrderBuilder</span><span class="p">:</span>
<a id="__codelineno-73-66" name="__codelineno-73-66" href="#__codelineno-73-66"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_order_builder_complete_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-73-67" name="__codelineno-73-67" href="#__codelineno-73-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test building a complete order.&quot;&quot;&quot;</span>
<a id="__codelineno-73-68" name="__codelineno-73-68" href="#__codelineno-73-68"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-73-69" name="__codelineno-73-69" href="#__codelineno-73-69"></a>        <span class="n">order_id</span> <span class="o">=</span> <span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-73-70" name="__codelineno-73-70" href="#__codelineno-73-70"></a>        <span class="n">product_id</span> <span class="o">=</span> <span class="n">ProductId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-73-71" name="__codelineno-73-71" href="#__codelineno-73-71"></a>
<a id="__codelineno-73-72" name="__codelineno-73-72" href="#__codelineno-73-72"></a>        <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span>
<a id="__codelineno-73-73" name="__codelineno-73-73" href="#__codelineno-73-73"></a>            <span class="n">street</span><span class="o">=</span><span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-73-74" name="__codelineno-73-74" href="#__codelineno-73-74"></a>            <span class="n">city</span><span class="o">=</span><span class="s2">&quot;Anytown&quot;</span><span class="p">,</span> 
<a id="__codelineno-73-75" name="__codelineno-73-75" href="#__codelineno-73-75"></a>            <span class="n">state</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span>
<a id="__codelineno-73-76" name="__codelineno-73-76" href="#__codelineno-73-76"></a>            <span class="n">postal_code</span><span class="o">=</span><span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<a id="__codelineno-73-77" name="__codelineno-73-77" href="#__codelineno-73-77"></a>            <span class="n">country</span><span class="o">=</span><span class="s2">&quot;USA&quot;</span>
<a id="__codelineno-73-78" name="__codelineno-73-78" href="#__codelineno-73-78"></a>        <span class="p">)</span>
<a id="__codelineno-73-79" name="__codelineno-73-79" href="#__codelineno-73-79"></a>
<a id="__codelineno-73-80" name="__codelineno-73-80" href="#__codelineno-73-80"></a>        <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">credit_card</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">)</span>
<a id="__codelineno-73-81" name="__codelineno-73-81" href="#__codelineno-73-81"></a>
<a id="__codelineno-73-82" name="__codelineno-73-82" href="#__codelineno-73-82"></a>        <span class="n">order</span> <span class="o">=</span> <span class="p">(</span><span class="n">OrderBuilder</span><span class="p">()</span>
<a id="__codelineno-73-83" name="__codelineno-73-83" href="#__codelineno-73-83"></a>            <span class="o">.</span><span class="n">with_id</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-73-84" name="__codelineno-73-84" href="#__codelineno-73-84"></a>            <span class="o">.</span><span class="n">for_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-73-85" name="__codelineno-73-85" href="#__codelineno-73-85"></a>            <span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;29.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">))</span>
<a id="__codelineno-73-86" name="__codelineno-73-86" href="#__codelineno-73-86"></a>            <span class="o">.</span><span class="n">with_shipping_address</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<a id="__codelineno-73-87" name="__codelineno-73-87" href="#__codelineno-73-87"></a>            <span class="o">.</span><span class="n">with_payment_method</span><span class="p">(</span><span class="n">payment_method</span><span class="p">)</span>
<a id="__codelineno-73-88" name="__codelineno-73-88" href="#__codelineno-73-88"></a>            <span class="o">.</span><span class="n">add_discount_code</span><span class="p">(</span><span class="s2">&quot;SAVE10&quot;</span><span class="p">)</span>
<a id="__codelineno-73-89" name="__codelineno-73-89" href="#__codelineno-73-89"></a>            <span class="o">.</span><span class="n">build</span><span class="p">())</span>
<a id="__codelineno-73-90" name="__codelineno-73-90" href="#__codelineno-73-90"></a>
<a id="__codelineno-73-91" name="__codelineno-73-91" href="#__codelineno-73-91"></a>        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_id</span>
<a id="__codelineno-73-92" name="__codelineno-73-92" href="#__codelineno-73-92"></a>        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-73-93" name="__codelineno-73-93" href="#__codelineno-73-93"></a>        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># Tax and shipping calculated</span>
<a id="__codelineno-73-94" name="__codelineno-73-94" href="#__codelineno-73-94"></a>        <span class="k">assert</span> <span class="s2">&quot;SAVE10&quot;</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;discount_codes&quot;</span><span class="p">]</span>
<a id="__codelineno-73-95" name="__codelineno-73-95" href="#__codelineno-73-95"></a>
<a id="__codelineno-73-96" name="__codelineno-73-96" href="#__codelineno-73-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_order_builder_validation_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-73-97" name="__codelineno-73-97" href="#__codelineno-73-97"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test builder validation catches errors.&quot;&quot;&quot;</span>
<a id="__codelineno-73-98" name="__codelineno-73-98" href="#__codelineno-73-98"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">OrderBuilder</span><span class="p">()</span>
<a id="__codelineno-73-99" name="__codelineno-73-99" href="#__codelineno-73-99"></a>
<a id="__codelineno-73-100" name="__codelineno-73-100" href="#__codelineno-73-100"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Order ID is required&quot;</span><span class="p">):</span>
<a id="__codelineno-73-101" name="__codelineno-73-101" href="#__codelineno-73-101"></a>            <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<a id="__codelineno-73-102" name="__codelineno-73-102" href="#__codelineno-73-102"></a>
<a id="__codelineno-73-103" name="__codelineno-73-103" href="#__codelineno-73-103"></a>        <span class="n">builder</span><span class="o">.</span><span class="n">with_id</span><span class="p">(</span><span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
<a id="__codelineno-73-104" name="__codelineno-73-104" href="#__codelineno-73-104"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Customer ID is required&quot;</span><span class="p">):</span>
<a id="__codelineno-73-105" name="__codelineno-73-105" href="#__codelineno-73-105"></a>            <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</code></pre></div>
<h3 id="factory-patterns-and-dependency-injection"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#factory-patterns-and-dependency-injection">Factory Patterns and Dependency Injection</a></h3>
<p>Factories work well with dependency injection for more complex scenarios:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerCreationService</span><span class="p">:</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Service that coordinates customer creation with external dependencies.&quot;&quot;&quot;</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>        <span class="n">customer_repo</span><span class="p">:</span> <span class="n">CustomerRepository</span><span class="p">,</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>        <span class="n">email_service</span><span class="p">:</span> <span class="n">EmailService</span><span class="p">,</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a>        <span class="n">audit_service</span><span class="p">:</span> <span class="n">AuditService</span><span class="p">,</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>        <span class="n">notification_service</span><span class="p">:</span> <span class="n">NotificationService</span><span class="p">,</span>
<a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a>    <span class="p">):</span>
<a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span> <span class="o">=</span> <span class="n">customer_repo</span>
<a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_email_service</span> <span class="o">=</span> <span class="n">email_service</span>
<a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_audit_service</span> <span class="o">=</span> <span class="n">audit_service</span>
<a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_notification_service</span> <span class="o">=</span> <span class="n">notification_service</span>
<a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a>
<a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a>        <span class="n">customer_type</span><span class="p">:</span> <span class="n">CustomerType</span><span class="p">,</span>
<a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a>        <span class="n">email_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create customer with all side effects.&quot;&quot;&quot;</span>
<a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a>
<a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a>        <span class="c1"># Validate email doesn&#39;t exist</span>
<a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a>        <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email_str</span><span class="p">)</span>
<a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a>        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
<a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Customer with email </span><span class="si">{</span><span class="n">email_str</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>
<a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a>
<a id="__codelineno-74-30" name="__codelineno-74-30" href="#__codelineno-74-30"></a>        <span class="c1"># Create customer using factory</span>
<a id="__codelineno-74-31" name="__codelineno-74-31" href="#__codelineno-74-31"></a>        <span class="n">factory</span> <span class="o">=</span> <span class="n">get_customer_factory</span><span class="p">(</span><span class="n">customer_type</span><span class="p">)</span>
<a id="__codelineno-74-32" name="__codelineno-74-32" href="#__codelineno-74-32"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-74-33" name="__codelineno-74-33" href="#__codelineno-74-33"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">email_str</span><span class="p">)</span>
<a id="__codelineno-74-34" name="__codelineno-74-34" href="#__codelineno-74-34"></a>
<a id="__codelineno-74-35" name="__codelineno-74-35" href="#__codelineno-74-35"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-74-36" name="__codelineno-74-36" href="#__codelineno-74-36"></a>
<a id="__codelineno-74-37" name="__codelineno-74-37" href="#__codelineno-74-37"></a>        <span class="c1"># Save to repository</span>
<a id="__codelineno-74-38" name="__codelineno-74-38" href="#__codelineno-74-38"></a>        <span class="n">saved_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-74-39" name="__codelineno-74-39" href="#__codelineno-74-39"></a>
<a id="__codelineno-74-40" name="__codelineno-74-40" href="#__codelineno-74-40"></a>        <span class="c1"># Side effects</span>
<a id="__codelineno-74-41" name="__codelineno-74-41" href="#__codelineno-74-41"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_audit_service</span><span class="o">.</span><span class="n">log_customer_creation</span><span class="p">(</span><span class="n">saved_customer</span><span class="p">)</span>
<a id="__codelineno-74-42" name="__codelineno-74-42" href="#__codelineno-74-42"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_email_service</span><span class="o">.</span><span class="n">send_welcome_email</span><span class="p">(</span><span class="n">saved_customer</span><span class="p">)</span>
<a id="__codelineno-74-43" name="__codelineno-74-43" href="#__codelineno-74-43"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notification_service</span><span class="o">.</span><span class="n">notify_customer_created</span><span class="p">(</span><span class="n">saved_customer</span><span class="p">)</span>
<a id="__codelineno-74-44" name="__codelineno-74-44" href="#__codelineno-74-44"></a>
<a id="__codelineno-74-45" name="__codelineno-74-45" href="#__codelineno-74-45"></a>        <span class="c1"># Process domain events</span>
<a id="__codelineno-74-46" name="__codelineno-74-46" href="#__codelineno-74-46"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">saved_customer</span><span class="o">.</span><span class="n">collect_domain_events</span><span class="p">():</span>
<a id="__codelineno-74-47" name="__codelineno-74-47" href="#__codelineno-74-47"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notification_service</span><span class="o">.</span><span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-74-48" name="__codelineno-74-48" href="#__codelineno-74-48"></a>
<a id="__codelineno-74-49" name="__codelineno-74-49" href="#__codelineno-74-49"></a>        <span class="k">return</span> <span class="n">saved_customer</span>
</code></pre></div>
<h3 id="common-factory-pattern-pitfalls"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#common-factory-pattern-pitfalls">Common Factory Pattern Pitfalls</a></h3>
<h4 id="1-factories-that-do-too-much"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#1-factories-that-do-too-much">1. Factories That Do Too Much</a></h4>
<p>Keep factories focused on object creation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1"># Bad - factory doing too much</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>  <span class="c1"># âŒ Side effect</span>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_analytics</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>  <span class="c1"># âŒ Not creation</span>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>        <span class="k">return</span> <span class="n">customer</span>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="c1"># Good - factory focused on creation</span>
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># âœ… Pure creation</span>
</code></pre></div>
<h4 id="2-inconsistent-validation"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#2-inconsistent-validation">2. Inconsistent Validation</a></h4>
<p>Ensure all factory methods apply the same validation rules:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="c1"># Bad - inconsistent validation</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderFactory</span><span class="p">:</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_online_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>        <span class="c1"># Different validation logic</span>
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>        <span class="k">pass</span>
<a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>
<a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_phone_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>        <span class="c1"># Different validation logic</span>
<a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a>        <span class="k">pass</span>
<a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a>
<a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a><span class="c1"># Good - consistent validation</span>
<a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderFactory</span><span class="p">:</span>
<a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_order_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a>        <span class="c1"># Shared validation logic</span>
<a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a>        <span class="k">pass</span>
<a id="__codelineno-76-16" name="__codelineno-76-16" href="#__codelineno-76-16"></a>
<a id="__codelineno-76-17" name="__codelineno-76-17" href="#__codelineno-76-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_online_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-76-18" name="__codelineno-76-18" href="#__codelineno-76-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_order_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-76-19" name="__codelineno-76-19" href="#__codelineno-76-19"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-76-20" name="__codelineno-76-20" href="#__codelineno-76-20"></a>
<a id="__codelineno-76-21" name="__codelineno-76-21" href="#__codelineno-76-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_phone_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-76-22" name="__codelineno-76-22" href="#__codelineno-76-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_order_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Same validation</span>
<a id="__codelineno-76-23" name="__codelineno-76-23" href="#__codelineno-76-23"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h4 id="3-tight-coupling-to-infrastructure"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#3-tight-coupling-to-infrastructure">3. Tight Coupling to Infrastructure</a></h4>
<p>Keep factories in the domain layer:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1"># Bad - factory coupled to infrastructure</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>        <span class="c1"># Direct database access</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>        <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>  <span class="c1"># âŒ Infrastructure coupling</span>
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email exists&quot;</span><span class="p">)</span>
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="c1"># Good - factory uses domain services</span>
<a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_repo</span><span class="p">:</span> <span class="n">CustomerRepository</span><span class="p">):</span>
<a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span> <span class="o">=</span> <span class="n">customer_repo</span>
<a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a>
<a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a>        <span class="c1"># Repository abstraction</span>
<a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a>        <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>
<a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email exists&quot;</span><span class="p">)</span>
<a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h3 id="advanced-factory-patterns"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#advanced-factory-patterns">Advanced Factory Patterns</a></h3>
<h4 id="factory-with-caching"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#factory-with-caching">Factory with Caching</a></h4>
<p>For expensive-to-create objects:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CachedCustomerFactory</span><span class="p">:</span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory with caching for expensive customer creation.&quot;&quot;&quot;</span>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Customer</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_or_get_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create customer or return cached instance.&quot;&quot;&quot;</span>
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>        <span class="k">if</span> <span class="n">email</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
<a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">email</span><span class="p">]</span>
<a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>
<a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a>            <span class="n">name</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
<a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a>            <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="p">{}),</span>
<a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a>        <span class="p">)</span>
<a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a>
<a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="o">=</span> <span class="n">customer</span>
<a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a>        <span class="k">return</span> <span class="n">customer</span>
</code></pre></div>
<h4 id="factory-with-strategy-pattern"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#factory-with-strategy-pattern">Factory with Strategy Pattern</a></h4>
<p>For different creation strategies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderCreationStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategy for order creation.&quot;&quot;&quot;</span>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">OrderData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create order using this strategy.&quot;&quot;&quot;</span>
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>        <span class="k">pass</span>
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">StandardOrderStrategy</span><span class="p">(</span><span class="n">OrderCreationStrategy</span><span class="p">):</span>
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard order creation strategy.&quot;&quot;&quot;</span>
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a>
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">OrderData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a>        <span class="p">)</span>
<a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>
<a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpressOrderStrategy</span><span class="p">(</span><span class="n">OrderCreationStrategy</span><span class="p">):</span>
<a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Express order creation with expedited processing.&quot;&quot;&quot;</span>
<a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a>
<a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">OrderData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a>        <span class="n">details</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;processing_priority&quot;</span><span class="p">:</span> <span class="s2">&quot;express&quot;</span><span class="p">,</span> <span class="s2">&quot;estimated_delivery&quot;</span><span class="p">:</span> <span class="s2">&quot;next_day&quot;</span><span class="p">}</span>
<a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a>
<a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-79-28" name="__codelineno-79-28" href="#__codelineno-79-28"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;15.00&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)),</span>  <span class="c1"># Express fee</span>
<a id="__codelineno-79-29" name="__codelineno-79-29" href="#__codelineno-79-29"></a>            <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
<a id="__codelineno-79-30" name="__codelineno-79-30" href="#__codelineno-79-30"></a>        <span class="p">)</span>
<a id="__codelineno-79-31" name="__codelineno-79-31" href="#__codelineno-79-31"></a>
<a id="__codelineno-79-32" name="__codelineno-79-32" href="#__codelineno-79-32"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderFactory</span><span class="p">:</span>
<a id="__codelineno-79-33" name="__codelineno-79-33" href="#__codelineno-79-33"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory using strategy pattern.&quot;&quot;&quot;</span>
<a id="__codelineno-79-34" name="__codelineno-79-34" href="#__codelineno-79-34"></a>
<a id="__codelineno-79-35" name="__codelineno-79-35" href="#__codelineno-79-35"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">OrderCreationStrategy</span><span class="p">):</span>
<a id="__codelineno-79-36" name="__codelineno-79-36" href="#__codelineno-79-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
<a id="__codelineno-79-37" name="__codelineno-79-37" href="#__codelineno-79-37"></a>
<a id="__codelineno-79-38" name="__codelineno-79-38" href="#__codelineno-79-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">OrderData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-79-39" name="__codelineno-79-39" href="#__codelineno-79-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create order using current strategy.&quot;&quot;&quot;</span>
<a id="__codelineno-79-40" name="__codelineno-79-40" href="#__codelineno-79-40"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#conclusion">Conclusion</a></h3>
<p>Factory patterns solve the fundamental problem of object creation in domain-rich applications. By centralizing creation logic, enforcing business rules, and ensuring consistency, factories prevent the bugs and maintenance headaches that come from scattered construction code.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates that Python's flexibility makes factory patterns both powerful and elegant. From simple factory methods on domain entities to complex abstract factories that create object families, these patterns ensure your objects are born valid and remain consistent throughout their lifecycle.</p>
<p>Key takeaways:</p>
<ul>
<li><strong>Factory Methods</strong>: Perfect for single entity creation with domain events</li>
<li><strong>Builder Pattern</strong>: Ideal for complex objects with many optional parameters</li>
<li><strong>Abstract Factory</strong>: Essential for creating families of related objects</li>
<li><strong>Domain Focus</strong>: Keep factories in the domain layer, not infrastructure</li>
<li><strong>Validation</strong>: Centralize business rules in factory methods</li>
<li><strong>Consistency</strong>: Ensure all creation paths follow the same rules</li>
</ul>
<p>In the next post, we'll explore Python Type Hints as your first line of defense against bugs, showing how modern Python's type system can catch errors at development time rather than in production.</p>
<h3 id="references"><a class="toclink" href="../../../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Factory pattern implementations</li>
<li><a href="https://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612">Gang of Four Design Patterns</a> - Original factory pattern concepts</li>
<li><a href="https://realpython.com/factory-method-python/">Python Factory Pattern Guide</a> - Practical Python factory examples</li>
<li><a href="https://martinfowler.com/bliki/DomainDrivenDesign.html">Domain-Driven Design</a> - Context for factory patterns in DDD</li>
</ul>
<p>Remember: Good factories don't just create objectsâ€”they create valid, consistent, and properly initialized objects that are ready to participate in your business domain from the moment they exist.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-06-12 20:10:00-04:00">Jun 12, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../clean-architecture/" class="md-meta__link">Clean Architecture</a>, 
              <a href="../../" class="md-meta__link">Python</a>, 
              <a href="../../../domain-driven-design/" class="md-meta__link">Domain-Driven Design</a></li>
        
        
          
          <li class="md-meta__item">
            
              13 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="value-objects-in-python-small-classes-big-impact"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/">Value Objects in Python: Small Classes, Big Impact</a></h2>
<p>String-typed everything. It's the bane of every Python developer's existence. You've seen it before:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a>    <span class="c1"># What happens if someone passes email as user_id?</span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a>    <span class="c1"># What if amount isn&#39;t a valid number?</span>
<a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a>    <span class="c1"># What if currency is &quot;banana&quot;?</span>
<a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a>    <span class="k">pass</span>
</code></pre></div>
<p>This is primitive obsessionâ€”using built-in types for domain concepts that deserve their own representation. It leads to bugs that slip past code review, runtime errors that should be compile-time errors, and business logic scattered throughout your codebase.</p>
<p>Value Objects solve this problem elegantly. They're small, immutable classes that represent domain concepts and encapsulate their validation and behavior. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates how Value Objects transform Python code from error-prone string manipulation into type-safe, expressive domain modeling.</p>
<h3 id="what-are-value-objects"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#what-are-value-objects">What Are Value Objects?</a></h3>
<p>Value Objects are objects without identityâ€”they're defined entirely by their attributes. Two Email objects with the same email address are considered equal, unlike entities where two Customer objects with the same name might be different people.</p>
<p>Eric Evans, in Domain-Driven Design, describes Value Objects as having these characteristics:</p>
<ul>
<li><strong>No identity</strong>: They're equal if their attributes are equal</li>
<li><strong>Immutable</strong>: Once created, they cannot be changed</li>
<li><strong>Side-effect free</strong>: Operations return new instances rather than modifying existing ones</li>
<li><strong>Replaceable</strong>: You can substitute one instance for another with the same value</li>
</ul>
<p>Here's a simple example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="c1"># Primitive obsession - error-prone</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">send_email</span><span class="p">(</span><span class="n">recipient_email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sender_email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a>    <span class="c1"># No validation, easy to mix up parameters</span>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">recipient_email</span><span class="p">:</span>  <span class="c1"># Basic validation scattered everywhere</span>
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid email&quot;</span><span class="p">)</span>
<a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a>    <span class="c1"># ... more code</span>
<a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a>
<a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a><span class="c1"># Value Object approach - type-safe and self-validating</span>
<a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">send_email</span><span class="p">(</span><span class="n">recipient</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span> <span class="n">sender</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Money</span><span class="p">):</span>
<a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a>    <span class="c1"># Parameters are guaranteed valid by their types</span>
<a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a>    <span class="c1"># Impossible to mix up recipient and sender</span>
<a id="__codelineno-93-12" name="__codelineno-93-12" href="#__codelineno-93-12"></a>    <span class="c1"># Business logic is centralized in the value objects</span>
</code></pre></div>
<h3 id="building-value-objects-in-python"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#building-value-objects-in-python">Building Value Objects in Python</a></h3>
<p>Python's <code>dataclass</code> decorator provides an excellent foundation for Value Objects. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> shows the pattern:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="c1"># src/shared_kernel/base/value_object.py</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ValueObject</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for value objects.&quot;&quot;&quot;</span>
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a>
<a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate after initialization.&quot;&quot;&quot;</span>
<a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
<a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a>
<a id="__codelineno-94-13" name="__codelineno-94-13" href="#__codelineno-94-13"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-94-14" name="__codelineno-94-14" href="#__codelineno-94-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-94-15" name="__codelineno-94-15" href="#__codelineno-94-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Override in subclasses to add validation logic.&quot;&quot;&quot;</span>
<a id="__codelineno-94-16" name="__codelineno-94-16" href="#__codelineno-94-16"></a>        <span class="o">...</span>
</code></pre></div>
<p>The <code>frozen=True</code> parameter makes the dataclass immutable. The <code>__post_init__</code> hook ensures validation runs after object creation. The abstract <code>validate</code> method forces subclasses to implement their business rules.</p>
<h3 id="email-beyond-string-validation"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#email-beyond-string-validation">Email: Beyond String Validation</a></h3>
<p>Email addresses appear everywhere in modern applications, but they're almost always represented as strings. This leads to validation code scattered throughout your application and bugs when invalid emails slip through:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="c1"># src/shared_kernel/value_objects/email.py</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..base.value_object</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValueObject</span>
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>
<a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Email</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Email address value object with validation.&quot;&quot;&quot;</span>
<a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a>
<a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a>
<a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate email format.&quot;&quot;&quot;</span>
<a id="__codelineno-95-14" name="__codelineno-95-14" href="#__codelineno-95-14"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-95-15" name="__codelineno-95-15" href="#__codelineno-95-15"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-95-16" name="__codelineno-95-16" href="#__codelineno-95-16"></a>
<a id="__codelineno-95-17" name="__codelineno-95-17" href="#__codelineno-95-17"></a>        <span class="c1"># Basic email validation regex</span>
<a id="__codelineno-95-18" name="__codelineno-95-18" href="#__codelineno-95-18"></a>        <span class="n">email_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&quot;</span>
<a id="__codelineno-95-19" name="__codelineno-95-19" href="#__codelineno-95-19"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">email_pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
<a id="__codelineno-95-20" name="__codelineno-95-20" href="#__codelineno-95-20"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid email format: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-95-21" name="__codelineno-95-21" href="#__codelineno-95-21"></a>
<a id="__codelineno-95-22" name="__codelineno-95-22" href="#__codelineno-95-22"></a>    <span class="nd">@property</span>
<a id="__codelineno-95-23" name="__codelineno-95-23" href="#__codelineno-95-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-95-24" name="__codelineno-95-24" href="#__codelineno-95-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the domain part of the email.&quot;&quot;&quot;</span>
<a id="__codelineno-95-25" name="__codelineno-95-25" href="#__codelineno-95-25"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-95-26" name="__codelineno-95-26" href="#__codelineno-95-26"></a>
<a id="__codelineno-95-27" name="__codelineno-95-27" href="#__codelineno-95-27"></a>    <span class="nd">@property</span>
<a id="__codelineno-95-28" name="__codelineno-95-28" href="#__codelineno-95-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">local_part</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-95-29" name="__codelineno-95-29" href="#__codelineno-95-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the local part of the email.&quot;&quot;&quot;</span>
<a id="__codelineno-95-30" name="__codelineno-95-30" href="#__codelineno-95-30"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-95-31" name="__codelineno-95-31" href="#__codelineno-95-31"></a>
<a id="__codelineno-95-32" name="__codelineno-95-32" href="#__codelineno-95-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_corporate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corporate_domains</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-95-33" name="__codelineno-95-33" href="#__codelineno-95-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this is a corporate email address.&quot;&quot;&quot;</span>
<a id="__codelineno-95-34" name="__codelineno-95-34" href="#__codelineno-95-34"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="ow">in</span> <span class="n">corporate_domains</span>
<a id="__codelineno-95-35" name="__codelineno-95-35" href="#__codelineno-95-35"></a>
<a id="__codelineno-95-36" name="__codelineno-95-36" href="#__codelineno-95-36"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-95-37" name="__codelineno-95-37" href="#__codelineno-95-37"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>
<p>Now email handling becomes type-safe and expressive:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="c1"># Before - error-prone</span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a>    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span><span class="p">:</span>  <span class="c1"># Duplicate validation everywhere</span>
<a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid email&quot;</span><span class="p">)</span>
<a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Business logic scattered</span>
<a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a>    <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">CORPORATE_DOMAINS</span><span class="p">:</span>
<a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a>        <span class="n">apply_corporate_settings</span><span class="p">()</span>
<a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a>
<a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a><span class="c1"># After - type-safe and expressive</span>
<a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">):</span>
<a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a>    <span class="c1"># Email is guaranteed valid by its type</span>
<a id="__codelineno-96-12" name="__codelineno-96-12" href="#__codelineno-96-12"></a>    <span class="k">if</span> <span class="n">email</span><span class="o">.</span><span class="n">is_corporate_email</span><span class="p">(</span><span class="n">CORPORATE_DOMAINS</span><span class="p">):</span>
<a id="__codelineno-96-13" name="__codelineno-96-13" href="#__codelineno-96-13"></a>        <span class="n">apply_corporate_settings</span><span class="p">()</span>
</code></pre></div>
<h3 id="money-getting-financial-math-right"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#money-getting-financial-math-right">Money: Getting Financial Math Right</a></h3>
<p>Money is notorious for causing bugs in software systems. Floating-point arithmetic is unsuitable for financial calculations, currency mismatches cause errors, and negative amounts often aren't caught until production.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="c1"># src/shared_kernel/value_objects/money.py</span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..base.value_object</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValueObject</span>
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a>
<a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Money</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Money value object with currency and amount.&quot;&quot;&quot;</span>
<a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a>
<a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a>    <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-97-11" name="__codelineno-97-11" href="#__codelineno-97-11"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-97-12" name="__codelineno-97-12" href="#__codelineno-97-12"></a>
<a id="__codelineno-97-13" name="__codelineno-97-13" href="#__codelineno-97-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-97-14" name="__codelineno-97-14" href="#__codelineno-97-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate money constraints.&quot;&quot;&quot;</span>
<a id="__codelineno-97-15" name="__codelineno-97-15" href="#__codelineno-97-15"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-97-16" name="__codelineno-97-16" href="#__codelineno-97-16"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Amount cannot be negative&quot;</span><span class="p">)</span>
<a id="__codelineno-97-17" name="__codelineno-97-17" href="#__codelineno-97-17"></a>
<a id="__codelineno-97-18" name="__codelineno-97-18" href="#__codelineno-97-18"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-97-19" name="__codelineno-97-19" href="#__codelineno-97-19"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Currency cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-97-20" name="__codelineno-97-20" href="#__codelineno-97-20"></a>
<a id="__codelineno-97-21" name="__codelineno-97-21" href="#__codelineno-97-21"></a>        <span class="c1"># Basic currency code validation (3 uppercase letters)</span>
<a id="__codelineno-97-22" name="__codelineno-97-22" href="#__codelineno-97-22"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
<a id="__codelineno-97-23" name="__codelineno-97-23" href="#__codelineno-97-23"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid currency code: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-97-24" name="__codelineno-97-24" href="#__codelineno-97-24"></a>
<a id="__codelineno-97-25" name="__codelineno-97-25" href="#__codelineno-97-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Money&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Money&quot;</span><span class="p">:</span>
<a id="__codelineno-97-26" name="__codelineno-97-26" href="#__codelineno-97-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add two money amounts (must have same currency).&quot;&quot;&quot;</span>
<a id="__codelineno-97-27" name="__codelineno-97-27" href="#__codelineno-97-27"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-97-28" name="__codelineno-97-28" href="#__codelineno-97-28"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-97-29" name="__codelineno-97-29" href="#__codelineno-97-29"></a>                <span class="sa">f</span><span class="s2">&quot;Cannot add different currencies: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-97-30" name="__codelineno-97-30" href="#__codelineno-97-30"></a>            <span class="p">)</span>
<a id="__codelineno-97-31" name="__codelineno-97-31" href="#__codelineno-97-31"></a>
<a id="__codelineno-97-32" name="__codelineno-97-32" href="#__codelineno-97-32"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-97-33" name="__codelineno-97-33" href="#__codelineno-97-33"></a>
<a id="__codelineno-97-34" name="__codelineno-97-34" href="#__codelineno-97-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Money&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Money&quot;</span><span class="p">:</span>
<a id="__codelineno-97-35" name="__codelineno-97-35" href="#__codelineno-97-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtract two money amounts (must have same currency).&quot;&quot;&quot;</span>
<a id="__codelineno-97-36" name="__codelineno-97-36" href="#__codelineno-97-36"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-97-37" name="__codelineno-97-37" href="#__codelineno-97-37"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-97-38" name="__codelineno-97-38" href="#__codelineno-97-38"></a>                <span class="sa">f</span><span class="s2">&quot;Cannot subtract different currencies: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-97-39" name="__codelineno-97-39" href="#__codelineno-97-39"></a>            <span class="p">)</span>
<a id="__codelineno-97-40" name="__codelineno-97-40" href="#__codelineno-97-40"></a>
<a id="__codelineno-97-41" name="__codelineno-97-41" href="#__codelineno-97-41"></a>        <span class="n">result_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">amount</span>
<a id="__codelineno-97-42" name="__codelineno-97-42" href="#__codelineno-97-42"></a>        <span class="k">if</span> <span class="n">result_amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-97-43" name="__codelineno-97-43" href="#__codelineno-97-43"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Subtraction would result in negative amount&quot;</span><span class="p">)</span>
<a id="__codelineno-97-44" name="__codelineno-97-44" href="#__codelineno-97-44"></a>
<a id="__codelineno-97-45" name="__codelineno-97-45" href="#__codelineno-97-45"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="n">result_amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-97-46" name="__codelineno-97-46" href="#__codelineno-97-46"></a>
<a id="__codelineno-97-47" name="__codelineno-97-47" href="#__codelineno-97-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Money&quot;</span><span class="p">:</span>
<a id="__codelineno-97-48" name="__codelineno-97-48" href="#__codelineno-97-48"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiply money by a factor.&quot;&quot;&quot;</span>
<a id="__codelineno-97-49" name="__codelineno-97-49" href="#__codelineno-97-49"></a>        <span class="k">if</span> <span class="n">factor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-97-50" name="__codelineno-97-50" href="#__codelineno-97-50"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Factor cannot be negative&quot;</span><span class="p">)</span>
<a id="__codelineno-97-51" name="__codelineno-97-51" href="#__codelineno-97-51"></a>
<a id="__codelineno-97-52" name="__codelineno-97-52" href="#__codelineno-97-52"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span>
<a id="__codelineno-97-53" name="__codelineno-97-53" href="#__codelineno-97-53"></a>            <span class="n">amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">factor</span><span class="p">)),</span> 
<a id="__codelineno-97-54" name="__codelineno-97-54" href="#__codelineno-97-54"></a>            <span class="n">currency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span>
<a id="__codelineno-97-55" name="__codelineno-97-55" href="#__codelineno-97-55"></a>        <span class="p">)</span>
<a id="__codelineno-97-56" name="__codelineno-97-56" href="#__codelineno-97-56"></a>
<a id="__codelineno-97-57" name="__codelineno-97-57" href="#__codelineno-97-57"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-97-58" name="__codelineno-97-58" href="#__codelineno-97-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the amount is zero.&quot;&quot;&quot;</span>
<a id="__codelineno-97-59" name="__codelineno-97-59" href="#__codelineno-97-59"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-97-60" name="__codelineno-97-60" href="#__codelineno-97-60"></a>
<a id="__codelineno-97-61" name="__codelineno-97-61" href="#__codelineno-97-61"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_positive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-97-62" name="__codelineno-97-62" href="#__codelineno-97-62"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the amount is positive.&quot;&quot;&quot;</span>
<a id="__codelineno-97-63" name="__codelineno-97-63" href="#__codelineno-97-63"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-97-64" name="__codelineno-97-64" href="#__codelineno-97-64"></a>
<a id="__codelineno-97-65" name="__codelineno-97-65" href="#__codelineno-97-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_display</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-97-66" name="__codelineno-97-66" href="#__codelineno-97-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format money for display.&quot;&quot;&quot;</span>
<a id="__codelineno-97-67" name="__codelineno-97-67" href="#__codelineno-97-67"></a>        <span class="n">currency_symbols</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-97-68" name="__codelineno-97-68" href="#__codelineno-97-68"></a>            <span class="s2">&quot;USD&quot;</span><span class="p">:</span> <span class="s2">&quot;$&quot;</span><span class="p">,</span>
<a id="__codelineno-97-69" name="__codelineno-97-69" href="#__codelineno-97-69"></a>            <span class="s2">&quot;EUR&quot;</span><span class="p">:</span> <span class="s2">&quot;â‚¬&quot;</span><span class="p">,</span> 
<a id="__codelineno-97-70" name="__codelineno-97-70" href="#__codelineno-97-70"></a>            <span class="s2">&quot;GBP&quot;</span><span class="p">:</span> <span class="s2">&quot;Â£&quot;</span><span class="p">,</span>
<a id="__codelineno-97-71" name="__codelineno-97-71" href="#__codelineno-97-71"></a>            <span class="s2">&quot;JPY&quot;</span><span class="p">:</span> <span class="s2">&quot;Â¥&quot;</span><span class="p">,</span>
<a id="__codelineno-97-72" name="__codelineno-97-72" href="#__codelineno-97-72"></a>        <span class="p">}</span>
<a id="__codelineno-97-73" name="__codelineno-97-73" href="#__codelineno-97-73"></a>
<a id="__codelineno-97-74" name="__codelineno-97-74" href="#__codelineno-97-74"></a>        <span class="n">symbol</span> <span class="o">=</span> <span class="n">currency_symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-97-75" name="__codelineno-97-75" href="#__codelineno-97-75"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-97-76" name="__codelineno-97-76" href="#__codelineno-97-76"></a>
<a id="__codelineno-97-77" name="__codelineno-97-77" href="#__codelineno-97-77"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-97-78" name="__codelineno-97-78" href="#__codelineno-97-78"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p>Money becomes much safer to work with:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="c1"># Before - floating point disasters waiting to happen</span>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
<a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a>    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Float precision issues</span>
<a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
<a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a>        <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">])</span>  <span class="c1"># String conversion can fail</span>
<a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a>        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])</span>
<a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a>        <span class="n">total</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>
<a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a>
<a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a>    <span class="k">if</span> <span class="s2">&quot;USD&quot;</span> <span class="o">!=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]:</span>  <span class="c1"># Currency mismatch caught too late</span>
<a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Currency mismatch&quot;</span><span class="p">)</span>
<a id="__codelineno-98-11" name="__codelineno-98-11" href="#__codelineno-98-11"></a>
<a id="__codelineno-98-12" name="__codelineno-98-12" href="#__codelineno-98-12"></a>    <span class="k">return</span> <span class="n">total</span>
<a id="__codelineno-98-13" name="__codelineno-98-13" href="#__codelineno-98-13"></a>
<a id="__codelineno-98-14" name="__codelineno-98-14" href="#__codelineno-98-14"></a><span class="c1"># After - precise and type-safe</span>
<a id="__codelineno-98-15" name="__codelineno-98-15" href="#__codelineno-98-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-98-16" name="__codelineno-98-16" href="#__codelineno-98-16"></a>    <span class="n">total</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-98-17" name="__codelineno-98-17" href="#__codelineno-98-17"></a>
<a id="__codelineno-98-18" name="__codelineno-98-18" href="#__codelineno-98-18"></a>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
<a id="__codelineno-98-19" name="__codelineno-98-19" href="#__codelineno-98-19"></a>        <span class="n">line_total</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
<a id="__codelineno-98-20" name="__codelineno-98-20" href="#__codelineno-98-20"></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_total</span><span class="p">)</span>  <span class="c1"># Currency validation automatic</span>
<a id="__codelineno-98-21" name="__codelineno-98-21" href="#__codelineno-98-21"></a>
<a id="__codelineno-98-22" name="__codelineno-98-22" href="#__codelineno-98-22"></a>    <span class="k">return</span> <span class="n">total</span>
</code></pre></div>
<h3 id="address-complex-data-with-business-logic"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#address-complex-data-with-business-logic">Address: Complex Data with Business Logic</a></h3>
<p>Addresses seem simple until you encounter international variations, validation requirements, and formatting needs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="c1"># src/shared_kernel/value_objects/address.py</span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..base.value_object</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValueObject</span>
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a>
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Physical address value object.&quot;&quot;&quot;</span>
<a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a>
<a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a>    <span class="n">street</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a>    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a>    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a>    <span class="n">postal_code</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-99-13" name="__codelineno-99-13" href="#__codelineno-99-13"></a>    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-99-14" name="__codelineno-99-14" href="#__codelineno-99-14"></a>    <span class="n">apartment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-99-15" name="__codelineno-99-15" href="#__codelineno-99-15"></a>
<a id="__codelineno-99-16" name="__codelineno-99-16" href="#__codelineno-99-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-99-17" name="__codelineno-99-17" href="#__codelineno-99-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate address fields.&quot;&quot;&quot;</span>
<a id="__codelineno-99-18" name="__codelineno-99-18" href="#__codelineno-99-18"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">street</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-99-19" name="__codelineno-99-19" href="#__codelineno-99-19"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Street cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-99-20" name="__codelineno-99-20" href="#__codelineno-99-20"></a>
<a id="__codelineno-99-21" name="__codelineno-99-21" href="#__codelineno-99-21"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-99-22" name="__codelineno-99-22" href="#__codelineno-99-22"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;City cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-99-23" name="__codelineno-99-23" href="#__codelineno-99-23"></a>
<a id="__codelineno-99-24" name="__codelineno-99-24" href="#__codelineno-99-24"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-99-25" name="__codelineno-99-25" href="#__codelineno-99-25"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;State cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-99-26" name="__codelineno-99-26" href="#__codelineno-99-26"></a>
<a id="__codelineno-99-27" name="__codelineno-99-27" href="#__codelineno-99-27"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-99-28" name="__codelineno-99-28" href="#__codelineno-99-28"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Postal code cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-99-29" name="__codelineno-99-29" href="#__codelineno-99-29"></a>
<a id="__codelineno-99-30" name="__codelineno-99-30" href="#__codelineno-99-30"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-99-31" name="__codelineno-99-31" href="#__codelineno-99-31"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Country cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-99-32" name="__codelineno-99-32" href="#__codelineno-99-32"></a>
<a id="__codelineno-99-33" name="__codelineno-99-33" href="#__codelineno-99-33"></a>        <span class="c1"># Basic postal code validation (flexible format)</span>
<a id="__codelineno-99-34" name="__codelineno-99-34" href="#__codelineno-99-34"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-99-35" name="__codelineno-99-35" href="#__codelineno-99-35"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Postal code too short&quot;</span><span class="p">)</span>
<a id="__codelineno-99-36" name="__codelineno-99-36" href="#__codelineno-99-36"></a>
<a id="__codelineno-99-37" name="__codelineno-99-37" href="#__codelineno-99-37"></a>    <span class="nd">@property</span>
<a id="__codelineno-99-38" name="__codelineno-99-38" href="#__codelineno-99-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">full_address</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-99-39" name="__codelineno-99-39" href="#__codelineno-99-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get formatted full address.&quot;&quot;&quot;</span>
<a id="__codelineno-99-40" name="__codelineno-99-40" href="#__codelineno-99-40"></a>        <span class="n">address_parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">street</span><span class="p">]</span>
<a id="__codelineno-99-41" name="__codelineno-99-41" href="#__codelineno-99-41"></a>
<a id="__codelineno-99-42" name="__codelineno-99-42" href="#__codelineno-99-42"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apartment</span><span class="p">:</span>
<a id="__codelineno-99-43" name="__codelineno-99-43" href="#__codelineno-99-43"></a>            <span class="n">address_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Apt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apartment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-99-44" name="__codelineno-99-44" href="#__codelineno-99-44"></a>
<a id="__codelineno-99-45" name="__codelineno-99-45" href="#__codelineno-99-45"></a>        <span class="n">address_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a id="__codelineno-99-46" name="__codelineno-99-46" href="#__codelineno-99-46"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
<a id="__codelineno-99-47" name="__codelineno-99-47" href="#__codelineno-99-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">country</span>
<a id="__codelineno-99-48" name="__codelineno-99-48" href="#__codelineno-99-48"></a>        <span class="p">])</span>
<a id="__codelineno-99-49" name="__codelineno-99-49" href="#__codelineno-99-49"></a>
<a id="__codelineno-99-50" name="__codelineno-99-50" href="#__codelineno-99-50"></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address_parts</span><span class="p">)</span>
<a id="__codelineno-99-51" name="__codelineno-99-51" href="#__codelineno-99-51"></a>
<a id="__codelineno-99-52" name="__codelineno-99-52" href="#__codelineno-99-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_us_address</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-99-53" name="__codelineno-99-53" href="#__codelineno-99-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this is a US address.&quot;&quot;&quot;</span>
<a id="__codelineno-99-54" name="__codelineno-99-54" href="#__codelineno-99-54"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="s2">&quot;USA&quot;</span><span class="p">,</span> <span class="s2">&quot;UNITED STATES&quot;</span><span class="p">]</span>
<a id="__codelineno-99-55" name="__codelineno-99-55" href="#__codelineno-99-55"></a>
<a id="__codelineno-99-56" name="__codelineno-99-56" href="#__codelineno-99-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_shipping_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-99-57" name="__codelineno-99-57" href="#__codelineno-99-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine shipping zone based on address.&quot;&quot;&quot;</span>
<a id="__codelineno-99-58" name="__codelineno-99-58" href="#__codelineno-99-58"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_us_address</span><span class="p">():</span>
<a id="__codelineno-99-59" name="__codelineno-99-59" href="#__codelineno-99-59"></a>            <span class="k">return</span> <span class="s2">&quot;domestic&quot;</span>
<a id="__codelineno-99-60" name="__codelineno-99-60" href="#__codelineno-99-60"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;CANADA&quot;</span><span class="p">]:</span>
<a id="__codelineno-99-61" name="__codelineno-99-61" href="#__codelineno-99-61"></a>            <span class="k">return</span> <span class="s2">&quot;north_america&quot;</span>
<a id="__codelineno-99-62" name="__codelineno-99-62" href="#__codelineno-99-62"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GB&quot;</span><span class="p">,</span> <span class="s2">&quot;FR&quot;</span><span class="p">,</span> <span class="s2">&quot;DE&quot;</span><span class="p">,</span> <span class="s2">&quot;IT&quot;</span><span class="p">,</span> <span class="s2">&quot;ES&quot;</span><span class="p">]:</span>
<a id="__codelineno-99-63" name="__codelineno-99-63" href="#__codelineno-99-63"></a>            <span class="k">return</span> <span class="s2">&quot;europe&quot;</span>
<a id="__codelineno-99-64" name="__codelineno-99-64" href="#__codelineno-99-64"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-99-65" name="__codelineno-99-65" href="#__codelineno-99-65"></a>            <span class="k">return</span> <span class="s2">&quot;international&quot;</span>
<a id="__codelineno-99-66" name="__codelineno-99-66" href="#__codelineno-99-66"></a>
<a id="__codelineno-99-67" name="__codelineno-99-67" href="#__codelineno-99-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-99-68" name="__codelineno-99-68" href="#__codelineno-99-68"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to dictionary for JSON serialization.&quot;&quot;&quot;</span>
<a id="__codelineno-99-69" name="__codelineno-99-69" href="#__codelineno-99-69"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-99-70" name="__codelineno-99-70" href="#__codelineno-99-70"></a>            <span class="s2">&quot;street&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">street</span><span class="p">,</span>
<a id="__codelineno-99-71" name="__codelineno-99-71" href="#__codelineno-99-71"></a>            <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="p">,</span>
<a id="__codelineno-99-72" name="__codelineno-99-72" href="#__codelineno-99-72"></a>            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-99-73" name="__codelineno-99-73" href="#__codelineno-99-73"></a>            <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="p">,</span>
<a id="__codelineno-99-74" name="__codelineno-99-74" href="#__codelineno-99-74"></a>            <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="p">,</span>
<a id="__codelineno-99-75" name="__codelineno-99-75" href="#__codelineno-99-75"></a>            <span class="s2">&quot;apartment&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">apartment</span><span class="p">,</span>
<a id="__codelineno-99-76" name="__codelineno-99-76" href="#__codelineno-99-76"></a>        <span class="p">}</span>
<a id="__codelineno-99-77" name="__codelineno-99-77" href="#__codelineno-99-77"></a>
<a id="__codelineno-99-78" name="__codelineno-99-78" href="#__codelineno-99-78"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-99-79" name="__codelineno-99-79" href="#__codelineno-99-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Address&quot;</span><span class="p">:</span>
<a id="__codelineno-99-80" name="__codelineno-99-80" href="#__codelineno-99-80"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create address from dictionary.&quot;&quot;&quot;</span>
<a id="__codelineno-99-81" name="__codelineno-99-81" href="#__codelineno-99-81"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-99-82" name="__codelineno-99-82" href="#__codelineno-99-82"></a>            <span class="n">street</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;street&quot;</span><span class="p">],</span>
<a id="__codelineno-99-83" name="__codelineno-99-83" href="#__codelineno-99-83"></a>            <span class="n">city</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">],</span>
<a id="__codelineno-99-84" name="__codelineno-99-84" href="#__codelineno-99-84"></a>            <span class="n">state</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">],</span>
<a id="__codelineno-99-85" name="__codelineno-99-85" href="#__codelineno-99-85"></a>            <span class="n">postal_code</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;postal_code&quot;</span><span class="p">],</span>
<a id="__codelineno-99-86" name="__codelineno-99-86" href="#__codelineno-99-86"></a>            <span class="n">country</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">],</span>
<a id="__codelineno-99-87" name="__codelineno-99-87" href="#__codelineno-99-87"></a>            <span class="n">apartment</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;apartment&quot;</span><span class="p">),</span>
<a id="__codelineno-99-88" name="__codelineno-99-88" href="#__codelineno-99-88"></a>        <span class="p">)</span>
<a id="__codelineno-99-89" name="__codelineno-99-89" href="#__codelineno-99-89"></a>
<a id="__codelineno-99-90" name="__codelineno-99-90" href="#__codelineno-99-90"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-99-91" name="__codelineno-99-91" href="#__codelineno-99-91"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_address</span>
</code></pre></div>
<p>Address becomes a first-class citizen with business logic:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="c1"># Before - address handling scattered everywhere</span>
<a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_shipping_cost</span><span class="p">(</span><span class="n">address_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a>    <span class="k">if</span> <span class="n">address_dict</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span><span class="p">:</span>
<a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a>        <span class="k">return</span> <span class="mf">5.99</span>
<a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a>    <span class="k">elif</span> <span class="n">address_dict</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;CANADA&quot;</span><span class="p">]:</span>
<a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a>        <span class="k">return</span> <span class="mf">12.99</span>
<a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a>        <span class="k">return</span> <span class="mf">24.99</span>
<a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a>
<a id="__codelineno-100-10" name="__codelineno-100-10" href="#__codelineno-100-10"></a><span class="c1"># After - address knows its own business rules</span>
<a id="__codelineno-100-11" name="__codelineno-100-11" href="#__codelineno-100-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_shipping_cost</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-100-12" name="__codelineno-100-12" href="#__codelineno-100-12"></a>    <span class="n">base_costs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-100-13" name="__codelineno-100-13" href="#__codelineno-100-13"></a>        <span class="s2">&quot;domestic&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-100-14" name="__codelineno-100-14" href="#__codelineno-100-14"></a>        <span class="s2">&quot;north_america&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;12.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-100-15" name="__codelineno-100-15" href="#__codelineno-100-15"></a>        <span class="s2">&quot;europe&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;19.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-100-16" name="__codelineno-100-16" href="#__codelineno-100-16"></a>        <span class="s2">&quot;international&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;24.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-100-17" name="__codelineno-100-17" href="#__codelineno-100-17"></a>    <span class="p">}</span>
<a id="__codelineno-100-18" name="__codelineno-100-18" href="#__codelineno-100-18"></a>
<a id="__codelineno-100-19" name="__codelineno-100-19" href="#__codelineno-100-19"></a>    <span class="n">zone</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span>
<a id="__codelineno-100-20" name="__codelineno-100-20" href="#__codelineno-100-20"></a>    <span class="k">return</span> <span class="n">base_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">base_costs</span><span class="p">[</span><span class="s2">&quot;international&quot;</span><span class="p">])</span>
</code></pre></div>
<h3 id="strongly-typed-identifiers"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#strongly-typed-identifiers">Strongly Typed Identifiers</a></h3>
<p>One of the most powerful applications of Value Objects is creating strongly typed identifiers. Instead of passing UUIDs as strings everywhere, create specific types:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="c1"># src/shared_kernel/types/identifiers.py</span>
<a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..base.value_object</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValueObject</span>
<a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a>
<a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerId</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Strongly typed customer identifier.&quot;&quot;&quot;</span>
<a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a>
<a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a>    <span class="n">value</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-101-11" name="__codelineno-101-11" href="#__codelineno-101-11"></a>
<a id="__codelineno-101-12" name="__codelineno-101-12" href="#__codelineno-101-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-101-13" name="__codelineno-101-13" href="#__codelineno-101-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate customer ID.&quot;&quot;&quot;</span>
<a id="__codelineno-101-14" name="__codelineno-101-14" href="#__codelineno-101-14"></a>        <span class="c1"># Type is guaranteed by annotation, no validation needed</span>
<a id="__codelineno-101-15" name="__codelineno-101-15" href="#__codelineno-101-15"></a>        <span class="k">pass</span>
<a id="__codelineno-101-16" name="__codelineno-101-16" href="#__codelineno-101-16"></a>
<a id="__codelineno-101-17" name="__codelineno-101-17" href="#__codelineno-101-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-101-18" name="__codelineno-101-18" href="#__codelineno-101-18"></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-101-19" name="__codelineno-101-19" href="#__codelineno-101-19"></a>
<a id="__codelineno-101-20" name="__codelineno-101-20" href="#__codelineno-101-20"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-101-21" name="__codelineno-101-21" href="#__codelineno-101-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderId</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-101-22" name="__codelineno-101-22" href="#__codelineno-101-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Strongly typed order identifier.&quot;&quot;&quot;</span>
<a id="__codelineno-101-23" name="__codelineno-101-23" href="#__codelineno-101-23"></a>
<a id="__codelineno-101-24" name="__codelineno-101-24" href="#__codelineno-101-24"></a>    <span class="n">value</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-101-25" name="__codelineno-101-25" href="#__codelineno-101-25"></a>
<a id="__codelineno-101-26" name="__codelineno-101-26" href="#__codelineno-101-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-101-27" name="__codelineno-101-27" href="#__codelineno-101-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate order ID.&quot;&quot;&quot;</span>
<a id="__codelineno-101-28" name="__codelineno-101-28" href="#__codelineno-101-28"></a>        <span class="k">pass</span>
<a id="__codelineno-101-29" name="__codelineno-101-29" href="#__codelineno-101-29"></a>
<a id="__codelineno-101-30" name="__codelineno-101-30" href="#__codelineno-101-30"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-101-31" name="__codelineno-101-31" href="#__codelineno-101-31"></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-101-32" name="__codelineno-101-32" href="#__codelineno-101-32"></a>
<a id="__codelineno-101-33" name="__codelineno-101-33" href="#__codelineno-101-33"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-101-34" name="__codelineno-101-34" href="#__codelineno-101-34"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProductId</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-101-35" name="__codelineno-101-35" href="#__codelineno-101-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Strongly typed product identifier.&quot;&quot;&quot;</span>
<a id="__codelineno-101-36" name="__codelineno-101-36" href="#__codelineno-101-36"></a>
<a id="__codelineno-101-37" name="__codelineno-101-37" href="#__codelineno-101-37"></a>    <span class="n">value</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-101-38" name="__codelineno-101-38" href="#__codelineno-101-38"></a>
<a id="__codelineno-101-39" name="__codelineno-101-39" href="#__codelineno-101-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-101-40" name="__codelineno-101-40" href="#__codelineno-101-40"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate product ID.&quot;&quot;&quot;</span>
<a id="__codelineno-101-41" name="__codelineno-101-41" href="#__codelineno-101-41"></a>        <span class="k">pass</span>
<a id="__codelineno-101-42" name="__codelineno-101-42" href="#__codelineno-101-42"></a>
<a id="__codelineno-101-43" name="__codelineno-101-43" href="#__codelineno-101-43"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-101-44" name="__codelineno-101-44" href="#__codelineno-101-44"></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
<p>Strongly typed identifiers prevent a class of bugs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="c1"># Before - easy to mix up parameters</span>
<a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer_order</span><span class="p">(</span><span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>    <span class="c1"># What happens if someone passes order_id as customer_id?</span>
<a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>    <span class="k">pass</span>
<a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a>
<a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a><span class="c1"># After - impossible to mix up parameters</span>
<a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer_order</span><span class="p">(</span><span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="n">ProductId</span><span class="p">):</span>
<a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a>    <span class="c1"># Type system catches parameter mismatches at development time</span>
<a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a>    <span class="k">pass</span>
</code></pre></div>
<h3 id="complex-value-objects-date-ranges"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#complex-value-objects-date-ranges">Complex Value Objects: Date Ranges</a></h3>
<p>Value Objects can represent complex concepts that combine multiple primitives:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span>
<a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a>
<a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">DateRange</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Value object representing a date range.&quot;&quot;&quot;</span>
<a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a>
<a id="__codelineno-103-9" name="__codelineno-103-9" href="#__codelineno-103-9"></a>    <span class="n">start_date</span><span class="p">:</span> <span class="n">date</span>
<a id="__codelineno-103-10" name="__codelineno-103-10" href="#__codelineno-103-10"></a>    <span class="n">end_date</span><span class="p">:</span> <span class="n">date</span>
<a id="__codelineno-103-11" name="__codelineno-103-11" href="#__codelineno-103-11"></a>
<a id="__codelineno-103-12" name="__codelineno-103-12" href="#__codelineno-103-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-103-13" name="__codelineno-103-13" href="#__codelineno-103-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate date range constraints.&quot;&quot;&quot;</span>
<a id="__codelineno-103-14" name="__codelineno-103-14" href="#__codelineno-103-14"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
<a id="__codelineno-103-15" name="__codelineno-103-15" href="#__codelineno-103-15"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Start date cannot be after end date&quot;</span><span class="p">)</span>
<a id="__codelineno-103-16" name="__codelineno-103-16" href="#__codelineno-103-16"></a>
<a id="__codelineno-103-17" name="__codelineno-103-17" href="#__codelineno-103-17"></a>    <span class="nd">@property</span>
<a id="__codelineno-103-18" name="__codelineno-103-18" href="#__codelineno-103-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
<a id="__codelineno-103-19" name="__codelineno-103-19" href="#__codelineno-103-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the duration of the date range.&quot;&quot;&quot;</span>
<a id="__codelineno-103-20" name="__codelineno-103-20" href="#__codelineno-103-20"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>
<a id="__codelineno-103-21" name="__codelineno-103-21" href="#__codelineno-103-21"></a>
<a id="__codelineno-103-22" name="__codelineno-103-22" href="#__codelineno-103-22"></a>    <span class="nd">@property</span>
<a id="__codelineno-103-23" name="__codelineno-103-23" href="#__codelineno-103-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">duration_days</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-103-24" name="__codelineno-103-24" href="#__codelineno-103-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get duration in days.&quot;&quot;&quot;</span>
<a id="__codelineno-103-25" name="__codelineno-103-25" href="#__codelineno-103-25"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">days</span>
<a id="__codelineno-103-26" name="__codelineno-103-26" href="#__codelineno-103-26"></a>
<a id="__codelineno-103-27" name="__codelineno-103-27" href="#__codelineno-103-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_date</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-103-28" name="__codelineno-103-28" href="#__codelineno-103-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a date falls within this range.&quot;&quot;&quot;</span>
<a id="__codelineno-103-29" name="__codelineno-103-29" href="#__codelineno-103-29"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">check_date</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span>
<a id="__codelineno-103-30" name="__codelineno-103-30" href="#__codelineno-103-30"></a>
<a id="__codelineno-103-31" name="__codelineno-103-31" href="#__codelineno-103-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;DateRange&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-103-32" name="__codelineno-103-32" href="#__codelineno-103-32"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this range overlaps with another.&quot;&quot;&quot;</span>
<a id="__codelineno-103-33" name="__codelineno-103-33" href="#__codelineno-103-33"></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">and</span> 
<a id="__codelineno-103-34" name="__codelineno-103-34" href="#__codelineno-103-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">&gt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>
<a id="__codelineno-103-35" name="__codelineno-103-35" href="#__codelineno-103-35"></a>
<a id="__codelineno-103-36" name="__codelineno-103-36" href="#__codelineno-103-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_weekend_only</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-103-37" name="__codelineno-103-37" href="#__codelineno-103-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if range contains only weekend days.&quot;&quot;&quot;</span>
<a id="__codelineno-103-38" name="__codelineno-103-38" href="#__codelineno-103-38"></a>        <span class="k">for</span> <span class="n">single_date</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_range</span><span class="p">():</span>
<a id="__codelineno-103-39" name="__codelineno-103-39" href="#__codelineno-103-39"></a>            <span class="k">if</span> <span class="n">single_date</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Monday is 0, Friday is 4</span>
<a id="__codelineno-103-40" name="__codelineno-103-40" href="#__codelineno-103-40"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-103-41" name="__codelineno-103-41" href="#__codelineno-103-41"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-103-42" name="__codelineno-103-42" href="#__codelineno-103-42"></a>
<a id="__codelineno-103-43" name="__codelineno-103-43" href="#__codelineno-103-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">date_range</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">date</span><span class="p">]:</span>
<a id="__codelineno-103-44" name="__codelineno-103-44" href="#__codelineno-103-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all dates in the range.&quot;&quot;&quot;</span>
<a id="__codelineno-103-45" name="__codelineno-103-45" href="#__codelineno-103-45"></a>        <span class="n">current_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>
<a id="__codelineno-103-46" name="__codelineno-103-46" href="#__codelineno-103-46"></a>        <span class="k">while</span> <span class="n">current_date</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
<a id="__codelineno-103-47" name="__codelineno-103-47" href="#__codelineno-103-47"></a>            <span class="k">yield</span> <span class="n">current_date</span>
<a id="__codelineno-103-48" name="__codelineno-103-48" href="#__codelineno-103-48"></a>            <span class="n">current_date</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-103-49" name="__codelineno-103-49" href="#__codelineno-103-49"></a>
<a id="__codelineno-103-50" name="__codelineno-103-50" href="#__codelineno-103-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">extend_by_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DateRange&quot;</span><span class="p">:</span>
<a id="__codelineno-103-51" name="__codelineno-103-51" href="#__codelineno-103-51"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new date range extended by the specified days.&quot;&quot;&quot;</span>
<a id="__codelineno-103-52" name="__codelineno-103-52" href="#__codelineno-103-52"></a>        <span class="k">return</span> <span class="n">DateRange</span><span class="p">(</span>
<a id="__codelineno-103-53" name="__codelineno-103-53" href="#__codelineno-103-53"></a>            <span class="n">start_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
<a id="__codelineno-103-54" name="__codelineno-103-54" href="#__codelineno-103-54"></a>            <span class="n">end_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
<a id="__codelineno-103-55" name="__codelineno-103-55" href="#__codelineno-103-55"></a>        <span class="p">)</span>
<a id="__codelineno-103-56" name="__codelineno-103-56" href="#__codelineno-103-56"></a>
<a id="__codelineno-103-57" name="__codelineno-103-57" href="#__codelineno-103-57"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-103-58" name="__codelineno-103-58" href="#__codelineno-103-58"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">for_month</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DateRange&quot;</span><span class="p">:</span>
<a id="__codelineno-103-59" name="__codelineno-103-59" href="#__codelineno-103-59"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a date range for an entire month.&quot;&quot;&quot;</span>
<a id="__codelineno-103-60" name="__codelineno-103-60" href="#__codelineno-103-60"></a>        <span class="n">start_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-103-61" name="__codelineno-103-61" href="#__codelineno-103-61"></a>        <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
<a id="__codelineno-103-62" name="__codelineno-103-62" href="#__codelineno-103-62"></a>            <span class="n">end_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-103-63" name="__codelineno-103-63" href="#__codelineno-103-63"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-103-64" name="__codelineno-103-64" href="#__codelineno-103-64"></a>            <span class="n">end_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-103-65" name="__codelineno-103-65" href="#__codelineno-103-65"></a>
<a id="__codelineno-103-66" name="__codelineno-103-66" href="#__codelineno-103-66"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-103-67" name="__codelineno-103-67" href="#__codelineno-103-67"></a>
<a id="__codelineno-103-68" name="__codelineno-103-68" href="#__codelineno-103-68"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-103-69" name="__codelineno-103-69" href="#__codelineno-103-69"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="value-objects-in-business-logic"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#value-objects-in-business-logic">Value Objects in Business Logic</a></h3>
<p>Value Objects shine when they encapsulate business rules. Consider a discount system:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Discount</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Discount value object with business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a>
<a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a>    <span class="n">percentage</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a>    <span class="n">min_amount</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a>    <span class="n">max_discount</span><span class="p">:</span> <span class="n">Money</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a>
<a id="__codelineno-104-9" name="__codelineno-104-9" href="#__codelineno-104-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-104-10" name="__codelineno-104-10" href="#__codelineno-104-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate discount constraints.&quot;&quot;&quot;</span>
<a id="__codelineno-104-11" name="__codelineno-104-11" href="#__codelineno-104-11"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
<a id="__codelineno-104-12" name="__codelineno-104-12" href="#__codelineno-104-12"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Discount percentage must be between 0 and 100&quot;</span><span class="p">)</span>
<a id="__codelineno-104-13" name="__codelineno-104-13" href="#__codelineno-104-13"></a>
<a id="__codelineno-104-14" name="__codelineno-104-14" href="#__codelineno-104-14"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-104-15" name="__codelineno-104-15" href="#__codelineno-104-15"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Minimum amount cannot be negative&quot;</span><span class="p">)</span>
<a id="__codelineno-104-16" name="__codelineno-104-16" href="#__codelineno-104-16"></a>
<a id="__codelineno-104-17" name="__codelineno-104-17" href="#__codelineno-104-17"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-104-18" name="__codelineno-104-18" href="#__codelineno-104-18"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum discount must be positive&quot;</span><span class="p">)</span>
<a id="__codelineno-104-19" name="__codelineno-104-19" href="#__codelineno-104-19"></a>
<a id="__codelineno-104-20" name="__codelineno-104-20" href="#__codelineno-104-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">applies_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_total</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-104-21" name="__codelineno-104-21" href="#__codelineno-104-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if discount applies to an order total.&quot;&quot;&quot;</span>
<a id="__codelineno-104-22" name="__codelineno-104-22" href="#__codelineno-104-22"></a>        <span class="k">if</span> <span class="n">order_total</span><span class="o">.</span><span class="n">currency</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-104-23" name="__codelineno-104-23" href="#__codelineno-104-23"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-104-24" name="__codelineno-104-24" href="#__codelineno-104-24"></a>        <span class="k">return</span> <span class="n">order_total</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="o">.</span><span class="n">amount</span>
<a id="__codelineno-104-25" name="__codelineno-104-25" href="#__codelineno-104-25"></a>
<a id="__codelineno-104-26" name="__codelineno-104-26" href="#__codelineno-104-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_discount_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_total</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-104-27" name="__codelineno-104-27" href="#__codelineno-104-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the discount amount for an order.&quot;&quot;&quot;</span>
<a id="__codelineno-104-28" name="__codelineno-104-28" href="#__codelineno-104-28"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">applies_to</span><span class="p">(</span><span class="n">order_total</span><span class="p">):</span>
<a id="__codelineno-104-29" name="__codelineno-104-29" href="#__codelineno-104-29"></a>            <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="n">order_total</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-104-30" name="__codelineno-104-30" href="#__codelineno-104-30"></a>
<a id="__codelineno-104-31" name="__codelineno-104-31" href="#__codelineno-104-31"></a>        <span class="n">discount_amount</span> <span class="o">=</span> <span class="n">order_total</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">percentage</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-104-32" name="__codelineno-104-32" href="#__codelineno-104-32"></a>
<a id="__codelineno-104-33" name="__codelineno-104-33" href="#__codelineno-104-33"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span> <span class="ow">and</span> <span class="n">discount_amount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span><span class="o">.</span><span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-104-34" name="__codelineno-104-34" href="#__codelineno-104-34"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span>
<a id="__codelineno-104-35" name="__codelineno-104-35" href="#__codelineno-104-35"></a>
<a id="__codelineno-104-36" name="__codelineno-104-36" href="#__codelineno-104-36"></a>        <span class="k">return</span> <span class="n">discount_amount</span>
<a id="__codelineno-104-37" name="__codelineno-104-37" href="#__codelineno-104-37"></a>
<a id="__codelineno-104-38" name="__codelineno-104-38" href="#__codelineno-104-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_total</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-104-39" name="__codelineno-104-39" href="#__codelineno-104-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply discount to an order total.&quot;&quot;&quot;</span>
<a id="__codelineno-104-40" name="__codelineno-104-40" href="#__codelineno-104-40"></a>        <span class="n">discount_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_discount_amount</span><span class="p">(</span><span class="n">order_total</span><span class="p">)</span>
<a id="__codelineno-104-41" name="__codelineno-104-41" href="#__codelineno-104-41"></a>        <span class="k">return</span> <span class="n">order_total</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">discount_amount</span><span class="p">)</span>
<a id="__codelineno-104-42" name="__codelineno-104-42" href="#__codelineno-104-42"></a>
<a id="__codelineno-104-43" name="__codelineno-104-43" href="#__codelineno-104-43"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-104-44" name="__codelineno-104-44" href="#__codelineno-104-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">percentage_discount</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">percentage</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">min_amount</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Discount&quot;</span><span class="p">:</span>
<a id="__codelineno-104-45" name="__codelineno-104-45" href="#__codelineno-104-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a percentage discount.&quot;&quot;&quot;</span>
<a id="__codelineno-104-46" name="__codelineno-104-46" href="#__codelineno-104-46"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-104-47" name="__codelineno-104-47" href="#__codelineno-104-47"></a>            <span class="n">percentage</span><span class="o">=</span><span class="n">percentage</span><span class="p">,</span>
<a id="__codelineno-104-48" name="__codelineno-104-48" href="#__codelineno-104-48"></a>            <span class="n">min_amount</span><span class="o">=</span><span class="n">min_amount</span><span class="p">,</span>
<a id="__codelineno-104-49" name="__codelineno-104-49" href="#__codelineno-104-49"></a>            <span class="n">max_discount</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-104-50" name="__codelineno-104-50" href="#__codelineno-104-50"></a>        <span class="p">)</span>
<a id="__codelineno-104-51" name="__codelineno-104-51" href="#__codelineno-104-51"></a>
<a id="__codelineno-104-52" name="__codelineno-104-52" href="#__codelineno-104-52"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-104-53" name="__codelineno-104-53" href="#__codelineno-104-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">capped_discount</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">percentage</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">min_amount</span><span class="p">:</span> <span class="n">Money</span><span class="p">,</span> <span class="n">max_discount</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Discount&quot;</span><span class="p">:</span>
<a id="__codelineno-104-54" name="__codelineno-104-54" href="#__codelineno-104-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a capped percentage discount.&quot;&quot;&quot;</span>
<a id="__codelineno-104-55" name="__codelineno-104-55" href="#__codelineno-104-55"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-104-56" name="__codelineno-104-56" href="#__codelineno-104-56"></a>            <span class="n">percentage</span><span class="o">=</span><span class="n">percentage</span><span class="p">,</span>
<a id="__codelineno-104-57" name="__codelineno-104-57" href="#__codelineno-104-57"></a>            <span class="n">min_amount</span><span class="o">=</span><span class="n">min_amount</span><span class="p">,</span>
<a id="__codelineno-104-58" name="__codelineno-104-58" href="#__codelineno-104-58"></a>            <span class="n">max_discount</span><span class="o">=</span><span class="n">max_discount</span>
<a id="__codelineno-104-59" name="__codelineno-104-59" href="#__codelineno-104-59"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="testing-value-objects"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#testing-value-objects">Testing Value Objects</a></h3>
<p>Value Objects are inherently easy to test because they have no dependencies and are purely functional:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="c1"># tests/unit/shared_kernel/test_value_objects.py</span>
<a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel.value_objects</span><span class="w"> </span><span class="kn">import</span> <span class="n">Money</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">Address</span>
<a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a>
<a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestMoney</span><span class="p">:</span>
<a id="__codelineno-105-7" name="__codelineno-105-7" href="#__codelineno-105-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_valid_money</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-8" name="__codelineno-105-8" href="#__codelineno-105-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating valid money object.&quot;&quot;&quot;</span>
<a id="__codelineno-105-9" name="__codelineno-105-9" href="#__codelineno-105-9"></a>        <span class="n">money</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-105-10" name="__codelineno-105-10" href="#__codelineno-105-10"></a>        <span class="k">assert</span> <span class="n">money</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">)</span>
<a id="__codelineno-105-11" name="__codelineno-105-11" href="#__codelineno-105-11"></a>        <span class="k">assert</span> <span class="n">money</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;USD&quot;</span>
<a id="__codelineno-105-12" name="__codelineno-105-12" href="#__codelineno-105-12"></a>
<a id="__codelineno-105-13" name="__codelineno-105-13" href="#__codelineno-105-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_negative_amount_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-14" name="__codelineno-105-14" href="#__codelineno-105-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that negative amounts raise validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-105-15" name="__codelineno-105-15" href="#__codelineno-105-15"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Amount cannot be negative&quot;</span><span class="p">):</span>
<a id="__codelineno-105-16" name="__codelineno-105-16" href="#__codelineno-105-16"></a>            <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-105-17" name="__codelineno-105-17" href="#__codelineno-105-17"></a>
<a id="__codelineno-105-18" name="__codelineno-105-18" href="#__codelineno-105-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_currency_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-19" name="__codelineno-105-19" href="#__codelineno-105-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that invalid currency codes raise validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-105-20" name="__codelineno-105-20" href="#__codelineno-105-20"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid currency code&quot;</span><span class="p">):</span>
<a id="__codelineno-105-21" name="__codelineno-105-21" href="#__codelineno-105-21"></a>            <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;usd&quot;</span><span class="p">)</span>  <span class="c1"># lowercase</span>
<a id="__codelineno-105-22" name="__codelineno-105-22" href="#__codelineno-105-22"></a>
<a id="__codelineno-105-23" name="__codelineno-105-23" href="#__codelineno-105-23"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid currency code&quot;</span><span class="p">):</span>
<a id="__codelineno-105-24" name="__codelineno-105-24" href="#__codelineno-105-24"></a>            <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USDD&quot;</span><span class="p">)</span>  <span class="c1"># too long</span>
<a id="__codelineno-105-25" name="__codelineno-105-25" href="#__codelineno-105-25"></a>
<a id="__codelineno-105-26" name="__codelineno-105-26" href="#__codelineno-105-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_add_same_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-27" name="__codelineno-105-27" href="#__codelineno-105-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test adding money with same currency.&quot;&quot;&quot;</span>
<a id="__codelineno-105-28" name="__codelineno-105-28" href="#__codelineno-105-28"></a>        <span class="n">money1</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-105-29" name="__codelineno-105-29" href="#__codelineno-105-29"></a>        <span class="n">money2</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.25&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-105-30" name="__codelineno-105-30" href="#__codelineno-105-30"></a>
<a id="__codelineno-105-31" name="__codelineno-105-31" href="#__codelineno-105-31"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">money1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">money2</span><span class="p">)</span>
<a id="__codelineno-105-32" name="__codelineno-105-32" href="#__codelineno-105-32"></a>
<a id="__codelineno-105-33" name="__codelineno-105-33" href="#__codelineno-105-33"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;15.75&quot;</span><span class="p">)</span>
<a id="__codelineno-105-34" name="__codelineno-105-34" href="#__codelineno-105-34"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;USD&quot;</span>
<a id="__codelineno-105-35" name="__codelineno-105-35" href="#__codelineno-105-35"></a>
<a id="__codelineno-105-36" name="__codelineno-105-36" href="#__codelineno-105-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_add_different_currencies_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-37" name="__codelineno-105-37" href="#__codelineno-105-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that adding different currencies raises error.&quot;&quot;&quot;</span>
<a id="__codelineno-105-38" name="__codelineno-105-38" href="#__codelineno-105-38"></a>        <span class="n">usd_money</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-105-39" name="__codelineno-105-39" href="#__codelineno-105-39"></a>        <span class="n">eur_money</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.25&quot;</span><span class="p">),</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span>
<a id="__codelineno-105-40" name="__codelineno-105-40" href="#__codelineno-105-40"></a>
<a id="__codelineno-105-41" name="__codelineno-105-41" href="#__codelineno-105-41"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Cannot add different currencies&quot;</span><span class="p">):</span>
<a id="__codelineno-105-42" name="__codelineno-105-42" href="#__codelineno-105-42"></a>            <span class="n">usd_money</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eur_money</span><span class="p">)</span>
<a id="__codelineno-105-43" name="__codelineno-105-43" href="#__codelineno-105-43"></a>
<a id="__codelineno-105-44" name="__codelineno-105-44" href="#__codelineno-105-44"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestEmail</span><span class="p">:</span>
<a id="__codelineno-105-45" name="__codelineno-105-45" href="#__codelineno-105-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_valid_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-46" name="__codelineno-105-46" href="#__codelineno-105-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating valid email object.&quot;&quot;&quot;</span>
<a id="__codelineno-105-47" name="__codelineno-105-47" href="#__codelineno-105-47"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-105-48" name="__codelineno-105-48" href="#__codelineno-105-48"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;test@example.com&quot;</span>
<a id="__codelineno-105-49" name="__codelineno-105-49" href="#__codelineno-105-49"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;example.com&quot;</span>
<a id="__codelineno-105-50" name="__codelineno-105-50" href="#__codelineno-105-50"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">local_part</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span>
<a id="__codelineno-105-51" name="__codelineno-105-51" href="#__codelineno-105-51"></a>
<a id="__codelineno-105-52" name="__codelineno-105-52" href="#__codelineno-105-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_email_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-53" name="__codelineno-105-53" href="#__codelineno-105-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that invalid email formats raise validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-105-54" name="__codelineno-105-54" href="#__codelineno-105-54"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">):</span>
<a id="__codelineno-105-55" name="__codelineno-105-55" href="#__codelineno-105-55"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;invalid-email&quot;</span><span class="p">)</span>
<a id="__codelineno-105-56" name="__codelineno-105-56" href="#__codelineno-105-56"></a>
<a id="__codelineno-105-57" name="__codelineno-105-57" href="#__codelineno-105-57"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">):</span>
<a id="__codelineno-105-58" name="__codelineno-105-58" href="#__codelineno-105-58"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-105-59" name="__codelineno-105-59" href="#__codelineno-105-59"></a>
<a id="__codelineno-105-60" name="__codelineno-105-60" href="#__codelineno-105-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_empty_email_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-61" name="__codelineno-105-61" href="#__codelineno-105-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that empty email raises validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-105-62" name="__codelineno-105-62" href="#__codelineno-105-62"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Email cannot be empty&quot;</span><span class="p">):</span>
<a id="__codelineno-105-63" name="__codelineno-105-63" href="#__codelineno-105-63"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-105-64" name="__codelineno-105-64" href="#__codelineno-105-64"></a>
<a id="__codelineno-105-65" name="__codelineno-105-65" href="#__codelineno-105-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_is_corporate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-66" name="__codelineno-105-66" href="#__codelineno-105-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test corporate email detection.&quot;&quot;&quot;</span>
<a id="__codelineno-105-67" name="__codelineno-105-67" href="#__codelineno-105-67"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@company.com&quot;</span><span class="p">)</span>
<a id="__codelineno-105-68" name="__codelineno-105-68" href="#__codelineno-105-68"></a>        <span class="n">corporate_domains</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;company.com&quot;</span><span class="p">,</span> <span class="s2">&quot;corporation.org&quot;</span><span class="p">}</span>
<a id="__codelineno-105-69" name="__codelineno-105-69" href="#__codelineno-105-69"></a>
<a id="__codelineno-105-70" name="__codelineno-105-70" href="#__codelineno-105-70"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">is_corporate_email</span><span class="p">(</span><span class="n">corporate_domains</span><span class="p">)</span>
<a id="__codelineno-105-71" name="__codelineno-105-71" href="#__codelineno-105-71"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="n">email</span><span class="o">.</span><span class="n">is_corporate_email</span><span class="p">({</span><span class="s2">&quot;other.com&quot;</span><span class="p">})</span>
<a id="__codelineno-105-72" name="__codelineno-105-72" href="#__codelineno-105-72"></a>
<a id="__codelineno-105-73" name="__codelineno-105-73" href="#__codelineno-105-73"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestAddress</span><span class="p">:</span>
<a id="__codelineno-105-74" name="__codelineno-105-74" href="#__codelineno-105-74"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_valid_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-75" name="__codelineno-105-75" href="#__codelineno-105-75"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating valid address object.&quot;&quot;&quot;</span>
<a id="__codelineno-105-76" name="__codelineno-105-76" href="#__codelineno-105-76"></a>        <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span>
<a id="__codelineno-105-77" name="__codelineno-105-77" href="#__codelineno-105-77"></a>            <span class="n">street</span><span class="o">=</span><span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-105-78" name="__codelineno-105-78" href="#__codelineno-105-78"></a>            <span class="n">city</span><span class="o">=</span><span class="s2">&quot;Anytown&quot;</span><span class="p">,</span>
<a id="__codelineno-105-79" name="__codelineno-105-79" href="#__codelineno-105-79"></a>            <span class="n">state</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span>
<a id="__codelineno-105-80" name="__codelineno-105-80" href="#__codelineno-105-80"></a>            <span class="n">postal_code</span><span class="o">=</span><span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<a id="__codelineno-105-81" name="__codelineno-105-81" href="#__codelineno-105-81"></a>            <span class="n">country</span><span class="o">=</span><span class="s2">&quot;USA&quot;</span>
<a id="__codelineno-105-82" name="__codelineno-105-82" href="#__codelineno-105-82"></a>        <span class="p">)</span>
<a id="__codelineno-105-83" name="__codelineno-105-83" href="#__codelineno-105-83"></a>
<a id="__codelineno-105-84" name="__codelineno-105-84" href="#__codelineno-105-84"></a>        <span class="k">assert</span> <span class="s2">&quot;123 Main St&quot;</span> <span class="ow">in</span> <span class="n">address</span><span class="o">.</span><span class="n">full_address</span>
<a id="__codelineno-105-85" name="__codelineno-105-85" href="#__codelineno-105-85"></a>        <span class="k">assert</span> <span class="n">address</span><span class="o">.</span><span class="n">is_us_address</span><span class="p">()</span>
<a id="__codelineno-105-86" name="__codelineno-105-86" href="#__codelineno-105-86"></a>        <span class="k">assert</span> <span class="n">address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;domestic&quot;</span>
<a id="__codelineno-105-87" name="__codelineno-105-87" href="#__codelineno-105-87"></a>
<a id="__codelineno-105-88" name="__codelineno-105-88" href="#__codelineno-105-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_empty_street_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-89" name="__codelineno-105-89" href="#__codelineno-105-89"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that empty street raises validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-105-90" name="__codelineno-105-90" href="#__codelineno-105-90"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Street cannot be empty&quot;</span><span class="p">):</span>
<a id="__codelineno-105-91" name="__codelineno-105-91" href="#__codelineno-105-91"></a>            <span class="n">Address</span><span class="p">(</span>
<a id="__codelineno-105-92" name="__codelineno-105-92" href="#__codelineno-105-92"></a>                <span class="n">street</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-105-93" name="__codelineno-105-93" href="#__codelineno-105-93"></a>                <span class="n">city</span><span class="o">=</span><span class="s2">&quot;Anytown&quot;</span><span class="p">,</span>
<a id="__codelineno-105-94" name="__codelineno-105-94" href="#__codelineno-105-94"></a>                <span class="n">state</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span>
<a id="__codelineno-105-95" name="__codelineno-105-95" href="#__codelineno-105-95"></a>                <span class="n">postal_code</span><span class="o">=</span><span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<a id="__codelineno-105-96" name="__codelineno-105-96" href="#__codelineno-105-96"></a>                <span class="n">country</span><span class="o">=</span><span class="s2">&quot;USA&quot;</span>
<a id="__codelineno-105-97" name="__codelineno-105-97" href="#__codelineno-105-97"></a>            <span class="p">)</span>
<a id="__codelineno-105-98" name="__codelineno-105-98" href="#__codelineno-105-98"></a>
<a id="__codelineno-105-99" name="__codelineno-105-99" href="#__codelineno-105-99"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_shipping_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-105-100" name="__codelineno-105-100" href="#__codelineno-105-100"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test shipping zone determination.&quot;&quot;&quot;</span>
<a id="__codelineno-105-101" name="__codelineno-105-101" href="#__codelineno-105-101"></a>        <span class="n">us_address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span> <span class="s2">&quot;Anytown&quot;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;12345&quot;</span><span class="p">,</span> <span class="s2">&quot;USA&quot;</span><span class="p">)</span>
<a id="__codelineno-105-102" name="__codelineno-105-102" href="#__codelineno-105-102"></a>        <span class="n">ca_address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;456 Maple Ave&quot;</span><span class="p">,</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="s2">&quot;ON&quot;</span><span class="p">,</span> <span class="s2">&quot;M1M1M1&quot;</span><span class="p">,</span> <span class="s2">&quot;CANADA&quot;</span><span class="p">)</span>
<a id="__codelineno-105-103" name="__codelineno-105-103" href="#__codelineno-105-103"></a>        <span class="n">uk_address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;789 High St&quot;</span><span class="p">,</span> <span class="s2">&quot;London&quot;</span><span class="p">,</span> <span class="s2">&quot;ENG&quot;</span><span class="p">,</span> <span class="s2">&quot;SW1A 1AA&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">)</span>
<a id="__codelineno-105-104" name="__codelineno-105-104" href="#__codelineno-105-104"></a>
<a id="__codelineno-105-105" name="__codelineno-105-105" href="#__codelineno-105-105"></a>        <span class="k">assert</span> <span class="n">us_address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;domestic&quot;</span>
<a id="__codelineno-105-106" name="__codelineno-105-106" href="#__codelineno-105-106"></a>        <span class="k">assert</span> <span class="n">ca_address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;north_america&quot;</span>
<a id="__codelineno-105-107" name="__codelineno-105-107" href="#__codelineno-105-107"></a>        <span class="k">assert</span> <span class="n">uk_address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;europe&quot;</span>
</code></pre></div>
<h3 id="value-objects-and-persistence"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#value-objects-and-persistence">Value Objects and Persistence</a></h3>
<p>Value Objects need special handling when persisting to databases. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> shows how to handle this with SQLAlchemy:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="c1"># src/infrastructure/database/models/customer_model.py</span>
<a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">DateTime</span>
<a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>
<a id="__codelineno-106-4" name="__codelineno-106-4" href="#__codelineno-106-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-106-5" name="__codelineno-106-5" href="#__codelineno-106-5"></a>
<a id="__codelineno-106-6" name="__codelineno-106-6" href="#__codelineno-106-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Address</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">Money</span>
<a id="__codelineno-106-7" name="__codelineno-106-7" href="#__codelineno-106-7"></a>
<a id="__codelineno-106-8" name="__codelineno-106-8" href="#__codelineno-106-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-106-9" name="__codelineno-106-9" href="#__codelineno-106-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;SQLAlchemy model for customer persistence.&quot;&quot;&quot;</span>
<a id="__codelineno-106-10" name="__codelineno-106-10" href="#__codelineno-106-10"></a>
<a id="__codelineno-106-11" name="__codelineno-106-11" href="#__codelineno-106-11"></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customers&quot;</span>
<a id="__codelineno-106-12" name="__codelineno-106-12" href="#__codelineno-106-12"></a>
<a id="__codelineno-106-13" name="__codelineno-106-13" href="#__codelineno-106-13"></a>    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-106-14" name="__codelineno-106-14" href="#__codelineno-106-14"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-106-15" name="__codelineno-106-15" href="#__codelineno-106-15"></a>    <span class="n">address_data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-106-16" name="__codelineno-106-16" href="#__codelineno-106-16"></a>        <span class="n">JSON</span><span class="p">,</span> 
<a id="__codelineno-106-17" name="__codelineno-106-17" href="#__codelineno-106-17"></a>        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-106-18" name="__codelineno-106-18" href="#__codelineno-106-18"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;address&quot;</span>
<a id="__codelineno-106-19" name="__codelineno-106-19" href="#__codelineno-106-19"></a>    <span class="p">)</span>
<a id="__codelineno-106-20" name="__codelineno-106-20" href="#__codelineno-106-20"></a>
<a id="__codelineno-106-21" name="__codelineno-106-21" href="#__codelineno-106-21"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-106-22" name="__codelineno-106-22" href="#__codelineno-106-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CustomerModel&quot;</span><span class="p">:</span>
<a id="__codelineno-106-23" name="__codelineno-106-23" href="#__codelineno-106-23"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert domain entity to database model.&quot;&quot;&quot;</span>
<a id="__codelineno-106-24" name="__codelineno-106-24" href="#__codelineno-106-24"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-106-25" name="__codelineno-106-25" href="#__codelineno-106-25"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-106-26" name="__codelineno-106-26" href="#__codelineno-106-26"></a>            <span class="n">name</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-106-27" name="__codelineno-106-27" href="#__codelineno-106-27"></a>            <span class="n">email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>  <span class="c1"># Convert Email to string</span>
<a id="__codelineno-106-28" name="__codelineno-106-28" href="#__codelineno-106-28"></a>            <span class="n">address_data</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">customer</span><span class="o">.</span><span class="n">address</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-106-29" name="__codelineno-106-29" href="#__codelineno-106-29"></a>            <span class="c1"># ... other fields</span>
<a id="__codelineno-106-30" name="__codelineno-106-30" href="#__codelineno-106-30"></a>        <span class="p">)</span>
<a id="__codelineno-106-31" name="__codelineno-106-31" href="#__codelineno-106-31"></a>
<a id="__codelineno-106-32" name="__codelineno-106-32" href="#__codelineno-106-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-106-33" name="__codelineno-106-33" href="#__codelineno-106-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert database model to domain entity.&quot;&quot;&quot;</span>
<a id="__codelineno-106-34" name="__codelineno-106-34" href="#__codelineno-106-34"></a>        <span class="n">address</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-106-35" name="__codelineno-106-35" href="#__codelineno-106-35"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_data</span><span class="p">:</span>
<a id="__codelineno-106-36" name="__codelineno-106-36" href="#__codelineno-106-36"></a>            <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_data</span><span class="p">)</span>
<a id="__codelineno-106-37" name="__codelineno-106-37" href="#__codelineno-106-37"></a>
<a id="__codelineno-106-38" name="__codelineno-106-38" href="#__codelineno-106-38"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-106-39" name="__codelineno-106-39" href="#__codelineno-106-39"></a>            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-106-40" name="__codelineno-106-40" href="#__codelineno-106-40"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-106-41" name="__codelineno-106-41" href="#__codelineno-106-41"></a>            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-106-42" name="__codelineno-106-42" href="#__codelineno-106-42"></a>            <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>  <span class="c1"># Convert string back to Email</span>
<a id="__codelineno-106-43" name="__codelineno-106-43" href="#__codelineno-106-43"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-106-44" name="__codelineno-106-44" href="#__codelineno-106-44"></a>            <span class="c1"># ... other fields</span>
<a id="__codelineno-106-45" name="__codelineno-106-45" href="#__codelineno-106-45"></a>        <span class="p">)</span>
</code></pre></div>
<p>For JSON APIs, you need similar conversion:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="c1"># src/presentation/schemas/customer_schemas.py</span>
<a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">validator</span>
<a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a>
<a id="__codelineno-107-5" name="__codelineno-107-5" href="#__codelineno-107-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-107-6" name="__codelineno-107-6" href="#__codelineno-107-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request model for creating a customer.&quot;&quot;&quot;</span>
<a id="__codelineno-107-7" name="__codelineno-107-7" href="#__codelineno-107-7"></a>
<a id="__codelineno-107-8" name="__codelineno-107-8" href="#__codelineno-107-8"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-107-9" name="__codelineno-107-9" href="#__codelineno-107-9"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>  <span class="c1"># Pydantic validates email format</span>
<a id="__codelineno-107-10" name="__codelineno-107-10" href="#__codelineno-107-10"></a>    <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-107-11" name="__codelineno-107-11" href="#__codelineno-107-11"></a>
<a id="__codelineno-107-12" name="__codelineno-107-12" href="#__codelineno-107-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_domain_command</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CreateCustomerCommand</span><span class="p">:</span>
<a id="__codelineno-107-13" name="__codelineno-107-13" href="#__codelineno-107-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert API request to domain command.&quot;&quot;&quot;</span>
<a id="__codelineno-107-14" name="__codelineno-107-14" href="#__codelineno-107-14"></a>        <span class="k">return</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-107-15" name="__codelineno-107-15" href="#__codelineno-107-15"></a>            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-107-16" name="__codelineno-107-16" href="#__codelineno-107-16"></a>            <span class="n">email</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>  <span class="c1"># Will be converted to Email value object in use case</span>
<a id="__codelineno-107-17" name="__codelineno-107-17" href="#__codelineno-107-17"></a>            <span class="n">address_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-107-18" name="__codelineno-107-18" href="#__codelineno-107-18"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="common-pitfalls-and-solutions"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#common-pitfalls-and-solutions">Common Pitfalls and Solutions</a></h3>
<h4 id="1-overuse-of-value-objects"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#1-overuse-of-value-objects">1. Overuse of Value Objects</a></h4>
<p>Not every concept needs a Value Object. Use them when:
- The concept has validation rules
- The concept has behavior
- You want type safety
- The concept appears frequently in your domain</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="c1"># Probably overkill</span>
<a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">FirstName</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-108-4" name="__codelineno-108-4" href="#__codelineno-108-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
<a id="__codelineno-108-5" name="__codelineno-108-5" href="#__codelineno-108-5"></a>
<a id="__codelineno-108-6" name="__codelineno-108-6" href="#__codelineno-108-6"></a><span class="c1"># Better - just use str if there&#39;s no special behavior</span>
<a id="__codelineno-108-7" name="__codelineno-108-7" href="#__codelineno-108-7"></a><span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>
<h4 id="2-mutable-value-objects"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#2-mutable-value-objects">2. Mutable Value Objects</a></h4>
<p>Value Objects must be immutable. Use <code>frozen=True</code> in dataclasses:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a><span class="c1"># Bad - mutable value object</span>
<a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a><span class="nd">@dataclass</span>
<a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Money</span><span class="p">:</span>
<a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a>    <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-109-5" name="__codelineno-109-5" href="#__codelineno-109-5"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-109-6" name="__codelineno-109-6" href="#__codelineno-109-6"></a>
<a id="__codelineno-109-7" name="__codelineno-109-7" href="#__codelineno-109-7"></a><span class="c1"># Good - immutable value object</span>
<a id="__codelineno-109-8" name="__codelineno-109-8" href="#__codelineno-109-8"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-109-9" name="__codelineno-109-9" href="#__codelineno-109-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Money</span><span class="p">:</span>
<a id="__codelineno-109-10" name="__codelineno-109-10" href="#__codelineno-109-10"></a>    <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-109-11" name="__codelineno-109-11" href="#__codelineno-109-11"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>
<h4 id="3-value-objects-with-identity"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#3-value-objects-with-identity">3. Value Objects with Identity</a></h4>
<p>If it has identity, it's not a Value Objectâ€”it's an Entity:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="c1"># Bad - UserAccount is an entity, not a value object</span>
<a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserAccount</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a>    <span class="n">account_id</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># This gives it identity!</span>
<a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a>    <span class="n">balance</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a>
<a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a><span class="c1"># Good - separate entity from value objects</span>
<a id="__codelineno-110-8" name="__codelineno-110-8" href="#__codelineno-110-8"></a><span class="nd">@dataclass</span>
<a id="__codelineno-110-9" name="__codelineno-110-9" href="#__codelineno-110-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserAccount</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
<a id="__codelineno-110-10" name="__codelineno-110-10" href="#__codelineno-110-10"></a>    <span class="n">account_id</span><span class="p">:</span> <span class="n">AccountId</span>
<a id="__codelineno-110-11" name="__codelineno-110-11" href="#__codelineno-110-11"></a>    <span class="n">balance</span><span class="p">:</span> <span class="n">Money</span>  <span class="c1"># Money is the value object</span>
</code></pre></div>
<h4 id="4-side-effects-in-value-objects"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#4-side-effects-in-value-objects">4. Side Effects in Value Objects</a></h4>
<p>Value Objects should be side-effect free:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="c1"># Bad - side effects in value object</span>
<a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Email</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a>
<a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">send_welcome_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># âŒ Side effect!</span>
<a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a>        <span class="n">email_service</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a>
<a id="__codelineno-111-9" name="__codelineno-111-9" href="#__codelineno-111-9"></a><span class="c1"># Good - pure value object</span>
<a id="__codelineno-111-10" name="__codelineno-111-10" href="#__codelineno-111-10"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-111-11" name="__codelineno-111-11" href="#__codelineno-111-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">Email</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-111-12" name="__codelineno-111-12" href="#__codelineno-111-12"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-111-13" name="__codelineno-111-13" href="#__codelineno-111-13"></a>
<a id="__codelineno-111-14" name="__codelineno-111-14" href="#__codelineno-111-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  <span class="c1"># âœ… Pure function</span>
<a id="__codelineno-111-15" name="__codelineno-111-15" href="#__codelineno-111-15"></a>        <span class="k">return</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>
<h3 id="value-objects-in-domain-events"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#value-objects-in-domain-events">Value Objects in Domain Events</a></h3>
<p>Value Objects work excellently in domain events:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderPlaced</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Domain event when an order is placed.&quot;&quot;&quot;</span>
<a id="__codelineno-112-4" name="__codelineno-112-4" href="#__codelineno-112-4"></a>
<a id="__codelineno-112-5" name="__codelineno-112-5" href="#__codelineno-112-5"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span>
<a id="__codelineno-112-6" name="__codelineno-112-6" href="#__codelineno-112-6"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-112-7" name="__codelineno-112-7" href="#__codelineno-112-7"></a>    <span class="n">order_total</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-112-8" name="__codelineno-112-8" href="#__codelineno-112-8"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">Address</span>
<a id="__codelineno-112-9" name="__codelineno-112-9" href="#__codelineno-112-9"></a>    <span class="n">billing_address</span><span class="p">:</span> <span class="n">Address</span>
<a id="__codelineno-112-10" name="__codelineno-112-10" href="#__codelineno-112-10"></a>    <span class="n">order_date</span><span class="p">:</span> <span class="n">date</span>
<a id="__codelineno-112-11" name="__codelineno-112-11" href="#__codelineno-112-11"></a>
<a id="__codelineno-112-12" name="__codelineno-112-12" href="#__codelineno-112-12"></a>    <span class="c1"># All properties are value objects or primitives</span>
<a id="__codelineno-112-13" name="__codelineno-112-13" href="#__codelineno-112-13"></a>    <span class="c1"># Event is immutable and self-contained</span>
</code></pre></div>
<h3 id="performance-considerations"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#performance-considerations">Performance Considerations</a></h3>
<p>Value Objects are generally lightweight, but consider these patterns for high-performance scenarios:</p>
<h4 id="flyweight-pattern-for-common-values"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#flyweight-pattern-for-common-values">Flyweight Pattern for Common Values</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="c1"># For frequently used values, consider flyweight pattern</span>
<a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Money</span><span class="p">:</span>
<a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a>    <span class="n">_instances</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a>
<a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">:</span>
<a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
<a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-113-10" name="__codelineno-113-10" href="#__codelineno-113-10"></a>
<a id="__codelineno-113-11" name="__codelineno-113-11" href="#__codelineno-113-11"></a><span class="c1"># Common values are shared</span>
<a id="__codelineno-113-12" name="__codelineno-113-12" href="#__codelineno-113-12"></a><span class="n">zero_usd</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-113-13" name="__codelineno-113-13" href="#__codelineno-113-13"></a><span class="n">another_zero</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-113-14" name="__codelineno-113-14" href="#__codelineno-113-14"></a><span class="k">assert</span> <span class="n">zero_usd</span> <span class="ow">is</span> <span class="n">another_zero</span>  <span class="c1"># Same instance</span>
</code></pre></div>
<h4 id="lazy-validation"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#lazy-validation">Lazy Validation</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Email</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-114-3" name="__codelineno-114-3" href="#__codelineno-114-3"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-114-4" name="__codelineno-114-4" href="#__codelineno-114-4"></a>    <span class="n">_validated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-114-5" name="__codelineno-114-5" href="#__codelineno-114-5"></a>
<a id="__codelineno-114-6" name="__codelineno-114-6" href="#__codelineno-114-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-114-7" name="__codelineno-114-7" href="#__codelineno-114-7"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validated</span><span class="p">:</span>
<a id="__codelineno-114-8" name="__codelineno-114-8" href="#__codelineno-114-8"></a>            <span class="k">return</span>
<a id="__codelineno-114-9" name="__codelineno-114-9" href="#__codelineno-114-9"></a>
<a id="__codelineno-114-10" name="__codelineno-114-10" href="#__codelineno-114-10"></a>        <span class="c1"># Expensive validation logic here</span>
<a id="__codelineno-114-11" name="__codelineno-114-11" href="#__codelineno-114-11"></a>        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_validated&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#conclusion">Conclusion</a></h3>
<p>Value Objects are small classes that make a big impact on code quality. They eliminate primitive obsession, centralize validation logic, and make your domain model more expressive. By representing domain concepts as first-class objects rather than primitive types, you create code that is:</p>
<ul>
<li><strong>Type-safe</strong>: The compiler catches parameter mix-ups</li>
<li><strong>Self-validating</strong>: Invalid states are impossible</li>
<li><strong>Expressive</strong>: Code reads like business language</li>
<li><strong>Testable</strong>: Pure functions with no dependencies</li>
<li><strong>Maintainable</strong>: Business logic is centralized</li>
</ul>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates these patterns in production-ready code. Start with the most problematic primitives in your codebaseâ€”usually strings that represent emails, identifiers, or money amounts. Replace them with Value Objects and watch your bugs disappear.</p>
<p>In the next post, we'll explore the Factory Pattern in Python, showing how to create complex objects and aggregates while maintaining business invariants and handling validation elegantly.</p>
<h3 id="references"><a class="toclink" href="../../../../2025/06/12/value-objects-in-python---small-classes-big-impact/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete Value Object implementations</li>
<li><a href="https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215">Domain-Driven Design Book</a> - Eric Evans' original DDD concepts</li>
<li><a href="https://docs.python.org/3/library/dataclasses.html">Python Dataclasses</a> - Official dataclasses documentation</li>
<li><a href="https://pydantic.dev/">Pydantic Documentation</a> - Validation and serialization library</li>
</ul>
<p>Remember: Value Objects are about expressing intent. When you see a string that represents something specific in your domain, that's a Value Object waiting to be born.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-06-08 19:20:00-04:00">Jun 8, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../clean-architecture/" class="md-meta__link">Clean Architecture</a>, 
              <a href="../../" class="md-meta__link">Python</a>, 
              <a href="../../../software-architecture/" class="md-meta__link">Software Architecture</a></li>
        
        
          
          <li class="md-meta__item">
            
              13 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="clean-architecture-in-python-keeping-your-business-logic-pure"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/">Clean Architecture in Python: Keeping Your Business Logic Pure</a></h2>
<p>Software architecture is like city planning. Without proper zoning, you end up with industrial waste flowing into residential areas and traffic jams everywhere. Clean Architecture provides that zoning system for your codebase, creating clear boundaries between business logic and technical infrastructure.</p>
<p>I've spent years untangling codebases where database queries were mixed with HTTP handling, business rules were scattered across controllers, and changing a database table required touching dozens of files. Clean Architecture changed how I think about software designâ€”not as technical layers, but as concentric circles with business logic at the center.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates Clean Architecture principles in Python, showing how to structure applications that are testable, maintainable, and independent of frameworks. This isn't about academic purity; it's about practical patterns that make your code easier to understand, change, and scale.</p>
<h3 id="understanding-clean-architecture"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#understanding-clean-architecture">Understanding Clean Architecture</a></h3>
<p>Robert Martin introduced Clean Architecture as a way to create software that is:</p>
<ul>
<li><strong>Independent of frameworks</strong>: Your business logic doesn't depend on FastAPI, Django, or any other framework</li>
<li><strong>Testable</strong>: Business rules can be tested without UI, database, or external services</li>
<li><strong>Independent of UI</strong>: The same business logic works with web APIs, command-line interfaces, or desktop applications</li>
<li><strong>Independent of database</strong>: Your business logic doesn't care whether you use PostgreSQL, MongoDB, or in-memory storage</li>
<li><strong>Independent of external agencies</strong>: Business rules don't know about third-party services</li>
</ul>
<p>The key insight is <strong>dependency inversion</strong>. Instead of high-level business logic depending on low-level technical details, both depend on abstractions. The result is software where the most important codeâ€”your business logicâ€”has no external dependencies.</p>
<h3 id="the-concentric-circles"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#the-concentric-circles">The Concentric Circles</a></h3>
<p>Clean Architecture organizes code into concentric circles:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>â”‚           Infrastructure            â”‚  â† Frameworks, databases, web servers
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a>â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>â”‚  â”‚        Presentation         â”‚    â”‚  â† Controllers, REST APIs, CLI
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>â”‚  â”‚  â”‚     Application     â”‚    â”‚    â”‚  â† Use cases, application services
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚    â”‚
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>â”‚  â”‚  â”‚  â”‚   Domain    â”‚    â”‚    â”‚    â”‚  â† Entities, value objects, business rules
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚    â”‚
<a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
<a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a>â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
<a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>
<p>Dependencies point inward. The domain layer has no dependencies. The application layer depends only on the domain. The presentation layer can depend on application and domain, but not infrastructure. Infrastructure can depend on everything but is injected through interfaces.</p>
<h3 id="domain-layer-pure-business-logic"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#domain-layer-pure-business-logic">Domain Layer: Pure Business Logic</a></h3>
<p>The domain layer contains your business entities, value objects, and rules. It has zero dependencies on external libraries or frameworks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># src/domain/entities/customer.py</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTC</span><span class="p">,</span> <span class="n">datetime</span>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">uuid4</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>    <span class="n">Address</span><span class="p">,</span>
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>    <span class="n">AggregateRoot</span><span class="p">,</span> 
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>    <span class="n">CustomerId</span><span class="p">,</span>
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>    <span class="n">DomainEvent</span><span class="p">,</span>
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>    <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>    <span class="n">PhoneNumber</span><span class="p">,</span>
<a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a><span class="p">)</span>
<a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a>
<a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerCreated</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Domain event raised when a customer is created.&quot;&quot;&quot;</span>
<a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a>
<a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a>    <span class="n">event_id</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a>    <span class="n">occurred_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a>    <span class="n">customer_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a>    <span class="n">customer_email</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a>
<a id="__codelineno-81-26" name="__codelineno-81-26" href="#__codelineno-81-26"></a><span class="nd">@dataclass</span>
<a id="__codelineno-81-27" name="__codelineno-81-27" href="#__codelineno-81-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-81-28" name="__codelineno-81-28" href="#__codelineno-81-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Customer aggregate root with enhanced value objects and domain events.&quot;&quot;&quot;</span>
<a id="__codelineno-81-29" name="__codelineno-81-29" href="#__codelineno-81-29"></a>
<a id="__codelineno-81-30" name="__codelineno-81-30" href="#__codelineno-81-30"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-81-31" name="__codelineno-81-31" href="#__codelineno-81-31"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-81-32" name="__codelineno-81-32" href="#__codelineno-81-32"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Email</span>
<a id="__codelineno-81-33" name="__codelineno-81-33" href="#__codelineno-81-33"></a>    <span class="n">address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-81-34" name="__codelineno-81-34" href="#__codelineno-81-34"></a>    <span class="n">phone</span><span class="p">:</span> <span class="n">PhoneNumber</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-81-35" name="__codelineno-81-35" href="#__codelineno-81-35"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-81-36" name="__codelineno-81-36" href="#__codelineno-81-36"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-81-37" name="__codelineno-81-37" href="#__codelineno-81-37"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-81-38" name="__codelineno-81-38" href="#__codelineno-81-38"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-81-39" name="__codelineno-81-39" href="#__codelineno-81-39"></a>
<a id="__codelineno-81-40" name="__codelineno-81-40" href="#__codelineno-81-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-81-41" name="__codelineno-81-41" href="#__codelineno-81-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the aggregate and validate business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-81-42" name="__codelineno-81-42" href="#__codelineno-81-42"></a>        <span class="c1"># Set the entity ID from customer_id for base Entity class</span>
<a id="__codelineno-81-43" name="__codelineno-81-43" href="#__codelineno-81-43"></a>        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-81-44" name="__codelineno-81-44" href="#__codelineno-81-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_business_rules</span><span class="p">()</span>
<a id="__codelineno-81-45" name="__codelineno-81-45" href="#__codelineno-81-45"></a>
<a id="__codelineno-81-46" name="__codelineno-81-46" href="#__codelineno-81-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_business_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-81-47" name="__codelineno-81-47" href="#__codelineno-81-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate customer business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-81-48" name="__codelineno-81-48" href="#__codelineno-81-48"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-81-49" name="__codelineno-81-49" href="#__codelineno-81-49"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Customer name cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-81-50" name="__codelineno-81-50" href="#__codelineno-81-50"></a>        <span class="c1"># Email validation is handled by the Email value object</span>
<a id="__codelineno-81-51" name="__codelineno-81-51" href="#__codelineno-81-51"></a>
<a id="__codelineno-81-52" name="__codelineno-81-52" href="#__codelineno-81-52"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-81-53" name="__codelineno-81-53" href="#__codelineno-81-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<a id="__codelineno-81-54" name="__codelineno-81-54" href="#__codelineno-81-54"></a>        <span class="bp">cls</span><span class="p">,</span>
<a id="__codelineno-81-55" name="__codelineno-81-55" href="#__codelineno-81-55"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span>
<a id="__codelineno-81-56" name="__codelineno-81-56" href="#__codelineno-81-56"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-81-57" name="__codelineno-81-57" href="#__codelineno-81-57"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-81-58" name="__codelineno-81-58" href="#__codelineno-81-58"></a>        <span class="n">address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-81-59" name="__codelineno-81-59" href="#__codelineno-81-59"></a>        <span class="n">phone</span><span class="p">:</span> <span class="n">PhoneNumber</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-81-60" name="__codelineno-81-60" href="#__codelineno-81-60"></a>        <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-81-61" name="__codelineno-81-61" href="#__codelineno-81-61"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Customer&quot;</span><span class="p">:</span>
<a id="__codelineno-81-62" name="__codelineno-81-62" href="#__codelineno-81-62"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Factory method to create a new customer with domain event.&quot;&quot;&quot;</span>
<a id="__codelineno-81-63" name="__codelineno-81-63" href="#__codelineno-81-63"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-81-64" name="__codelineno-81-64" href="#__codelineno-81-64"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-81-65" name="__codelineno-81-65" href="#__codelineno-81-65"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-81-66" name="__codelineno-81-66" href="#__codelineno-81-66"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-81-67" name="__codelineno-81-67" href="#__codelineno-81-67"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-81-68" name="__codelineno-81-68" href="#__codelineno-81-68"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-81-69" name="__codelineno-81-69" href="#__codelineno-81-69"></a>            <span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-81-70" name="__codelineno-81-70" href="#__codelineno-81-70"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-81-71" name="__codelineno-81-71" href="#__codelineno-81-71"></a>        <span class="p">)</span>
<a id="__codelineno-81-72" name="__codelineno-81-72" href="#__codelineno-81-72"></a>
<a id="__codelineno-81-73" name="__codelineno-81-73" href="#__codelineno-81-73"></a>        <span class="c1"># Raise domain event</span>
<a id="__codelineno-81-74" name="__codelineno-81-74" href="#__codelineno-81-74"></a>        <span class="n">customer</span><span class="o">.</span><span class="n">add_domain_event</span><span class="p">(</span>
<a id="__codelineno-81-75" name="__codelineno-81-75" href="#__codelineno-81-75"></a>            <span class="n">CustomerCreated</span><span class="p">(</span>
<a id="__codelineno-81-76" name="__codelineno-81-76" href="#__codelineno-81-76"></a>                <span class="n">event_id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-81-77" name="__codelineno-81-77" href="#__codelineno-81-77"></a>                <span class="n">occurred_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-81-78" name="__codelineno-81-78" href="#__codelineno-81-78"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-81-79" name="__codelineno-81-79" href="#__codelineno-81-79"></a>                <span class="n">customer_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-81-80" name="__codelineno-81-80" href="#__codelineno-81-80"></a>                <span class="n">customer_email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-81-81" name="__codelineno-81-81" href="#__codelineno-81-81"></a>            <span class="p">)</span>
<a id="__codelineno-81-82" name="__codelineno-81-82" href="#__codelineno-81-82"></a>        <span class="p">)</span>
<a id="__codelineno-81-83" name="__codelineno-81-83" href="#__codelineno-81-83"></a>
<a id="__codelineno-81-84" name="__codelineno-81-84" href="#__codelineno-81-84"></a>        <span class="k">return</span> <span class="n">customer</span>
<a id="__codelineno-81-85" name="__codelineno-81-85" href="#__codelineno-81-85"></a>
<a id="__codelineno-81-86" name="__codelineno-81-86" href="#__codelineno-81-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Manual deactivation&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Customer&quot;</span><span class="p">:</span>
<a id="__codelineno-81-87" name="__codelineno-81-87" href="#__codelineno-81-87"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Deactivate the customer and raise domain event.&quot;&quot;&quot;</span>
<a id="__codelineno-81-88" name="__codelineno-81-88" href="#__codelineno-81-88"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
<a id="__codelineno-81-89" name="__codelineno-81-89" href="#__codelineno-81-89"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Customer is already deactivated&quot;</span><span class="p">)</span>
<a id="__codelineno-81-90" name="__codelineno-81-90" href="#__codelineno-81-90"></a>
<a id="__codelineno-81-91" name="__codelineno-81-91" href="#__codelineno-81-91"></a>        <span class="n">deactivated_customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-81-92" name="__codelineno-81-92" href="#__codelineno-81-92"></a>            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-81-93" name="__codelineno-81-93" href="#__codelineno-81-93"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-81-94" name="__codelineno-81-94" href="#__codelineno-81-94"></a>            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-81-95" name="__codelineno-81-95" href="#__codelineno-81-95"></a>            <span class="n">email</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-81-96" name="__codelineno-81-96" href="#__codelineno-81-96"></a>            <span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-81-97" name="__codelineno-81-97" href="#__codelineno-81-97"></a>            <span class="n">phone</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-81-98" name="__codelineno-81-98" href="#__codelineno-81-98"></a>            <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-81-99" name="__codelineno-81-99" href="#__codelineno-81-99"></a>            <span class="n">preferences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-81-100" name="__codelineno-81-100" href="#__codelineno-81-100"></a>            <span class="n">created_at</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-81-101" name="__codelineno-81-101" href="#__codelineno-81-101"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-81-102" name="__codelineno-81-102" href="#__codelineno-81-102"></a>        <span class="p">)</span>
<a id="__codelineno-81-103" name="__codelineno-81-103" href="#__codelineno-81-103"></a>
<a id="__codelineno-81-104" name="__codelineno-81-104" href="#__codelineno-81-104"></a>        <span class="c1"># Copy domain events and add deactivation event</span>
<a id="__codelineno-81-105" name="__codelineno-81-105" href="#__codelineno-81-105"></a>        <span class="n">deactivated_customer</span><span class="o">.</span><span class="n">_domain_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_events</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-81-106" name="__codelineno-81-106" href="#__codelineno-81-106"></a>        <span class="n">deactivated_customer</span><span class="o">.</span><span class="n">add_domain_event</span><span class="p">(</span>
<a id="__codelineno-81-107" name="__codelineno-81-107" href="#__codelineno-81-107"></a>            <span class="n">CustomerDeactivated</span><span class="p">(</span>
<a id="__codelineno-81-108" name="__codelineno-81-108" href="#__codelineno-81-108"></a>                <span class="n">event_id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-81-109" name="__codelineno-81-109" href="#__codelineno-81-109"></a>                <span class="n">occurred_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-81-110" name="__codelineno-81-110" href="#__codelineno-81-110"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-81-111" name="__codelineno-81-111" href="#__codelineno-81-111"></a>                <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
<a id="__codelineno-81-112" name="__codelineno-81-112" href="#__codelineno-81-112"></a>            <span class="p">)</span>
<a id="__codelineno-81-113" name="__codelineno-81-113" href="#__codelineno-81-113"></a>        <span class="p">)</span>
<a id="__codelineno-81-114" name="__codelineno-81-114" href="#__codelineno-81-114"></a>
<a id="__codelineno-81-115" name="__codelineno-81-115" href="#__codelineno-81-115"></a>        <span class="k">return</span> <span class="n">deactivated_customer</span>
</code></pre></div>
<p>Notice several key characteristics:</p>
<ol>
<li><strong>Pure business logic</strong>: No imports from FastAPI, SQLAlchemy, or other frameworks</li>
<li><strong>Rich domain model</strong>: The entity contains behavior, not just data</li>
<li><strong>Value objects</strong>: Email, Address, and CustomerId provide type safety and validation</li>
<li><strong>Domain events</strong>: Business events are raised when important things happen</li>
<li><strong>Immutability</strong>: Operations return new instances rather than modifying state</li>
</ol>
<p>The domain also defines repository interfaces:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="c1"># src/domain/repositories/customer_repository.py</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span>
<a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>
<a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerRepository</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract repository for customer persistence.&quot;&quot;&quot;</span>
<a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a>
<a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a customer and return the saved instance.&quot;&quot;&quot;</span>
<a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a>        <span class="k">pass</span>
<a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a>
<a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-82-19" name="__codelineno-82-19" href="#__codelineno-82-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a customer by their ID.&quot;&quot;&quot;</span>
<a id="__codelineno-82-20" name="__codelineno-82-20" href="#__codelineno-82-20"></a>        <span class="k">pass</span>
<a id="__codelineno-82-21" name="__codelineno-82-21" href="#__codelineno-82-21"></a>
<a id="__codelineno-82-22" name="__codelineno-82-22" href="#__codelineno-82-22"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-82-23" name="__codelineno-82-23" href="#__codelineno-82-23"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_by_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-82-24" name="__codelineno-82-24" href="#__codelineno-82-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a customer by their email address.&quot;&quot;&quot;</span>
<a id="__codelineno-82-25" name="__codelineno-82-25" href="#__codelineno-82-25"></a>        <span class="k">pass</span>
<a id="__codelineno-82-26" name="__codelineno-82-26" href="#__codelineno-82-26"></a>
<a id="__codelineno-82-27" name="__codelineno-82-27" href="#__codelineno-82-27"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-82-28" name="__codelineno-82-28" href="#__codelineno-82-28"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_all_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-82-29" name="__codelineno-82-29" href="#__codelineno-82-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all active customers.&quot;&quot;&quot;</span>
<a id="__codelineno-82-30" name="__codelineno-82-30" href="#__codelineno-82-30"></a>        <span class="k">pass</span>
<a id="__codelineno-82-31" name="__codelineno-82-31" href="#__codelineno-82-31"></a>
<a id="__codelineno-82-32" name="__codelineno-82-32" href="#__codelineno-82-32"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-82-33" name="__codelineno-82-33" href="#__codelineno-82-33"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-82-34" name="__codelineno-82-34" href="#__codelineno-82-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a customer by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-82-35" name="__codelineno-82-35" href="#__codelineno-82-35"></a>        <span class="k">pass</span>
</code></pre></div>
<p>These interfaces define what the domain needs from the outside world without coupling to specific implementations. The domain layer declares its needs; other layers fulfill them.</p>
<h3 id="application-layer-orchestrating-business-logic"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#application-layer-orchestrating-business-logic">Application Layer: Orchestrating Business Logic</a></h3>
<p>The application layer contains use casesâ€”the workflows your application supports. It depends on the domain layer but remains independent of infrastructure:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="c1"># src/application/use_cases/commands/create_customer.py</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.repositories.customer_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerRepository</span>
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span>
<a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>
<a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a><span class="nd">@dataclass</span>
<a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerCommand</span><span class="p">:</span>
<a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a>
<a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerUseCase</span><span class="p">:</span>
<a id="__codelineno-83-17" name="__codelineno-83-17" href="#__codelineno-83-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_repository</span><span class="p">:</span> <span class="n">CustomerRepository</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-83-18" name="__codelineno-83-18" href="#__codelineno-83-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span> <span class="o">=</span> <span class="n">customer_repository</span>
<a id="__codelineno-83-19" name="__codelineno-83-19" href="#__codelineno-83-19"></a>
<a id="__codelineno-83-20" name="__codelineno-83-20" href="#__codelineno-83-20"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">CreateCustomerCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-83-21" name="__codelineno-83-21" href="#__codelineno-83-21"></a>        <span class="c1"># Check if customer with email already exists</span>
<a id="__codelineno-83-22" name="__codelineno-83-22" href="#__codelineno-83-22"></a>        <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-83-23" name="__codelineno-83-23" href="#__codelineno-83-23"></a>        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
<a id="__codelineno-83-24" name="__codelineno-83-24" href="#__codelineno-83-24"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Customer with email </span><span class="si">{</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>
<a id="__codelineno-83-25" name="__codelineno-83-25" href="#__codelineno-83-25"></a>
<a id="__codelineno-83-26" name="__codelineno-83-26" href="#__codelineno-83-26"></a>        <span class="c1"># Create new customer using factory method</span>
<a id="__codelineno-83-27" name="__codelineno-83-27" href="#__codelineno-83-27"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-83-28" name="__codelineno-83-28" href="#__codelineno-83-28"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-83-29" name="__codelineno-83-29" href="#__codelineno-83-29"></a>
<a id="__codelineno-83-30" name="__codelineno-83-30" href="#__codelineno-83-30"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-83-31" name="__codelineno-83-31" href="#__codelineno-83-31"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-83-32" name="__codelineno-83-32" href="#__codelineno-83-32"></a>            <span class="n">name</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-83-33" name="__codelineno-83-33" href="#__codelineno-83-33"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-83-34" name="__codelineno-83-34" href="#__codelineno-83-34"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">preferences</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-83-35" name="__codelineno-83-35" href="#__codelineno-83-35"></a>        <span class="p">)</span>
<a id="__codelineno-83-36" name="__codelineno-83-36" href="#__codelineno-83-36"></a>
<a id="__codelineno-83-37" name="__codelineno-83-37" href="#__codelineno-83-37"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
</code></pre></div>
<p>The use case:</p>
<ol>
<li><strong>Validates business rules</strong>: Checks for duplicate emails</li>
<li><strong>Orchestrates domain operations</strong>: Uses the Customer factory method</li>
<li><strong>Depends on abstractions</strong>: Uses the CustomerRepository interface</li>
<li><strong>Remains pure</strong>: No HTTP, database, or framework concerns</li>
</ol>
<p>Query use cases follow similar patterns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c1"># src/application/use_cases/queries/search_customers.py</span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.repositories.customer_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerRepository</span>
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="nd">@dataclass</span>
<a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">SearchCustomersQuery</span><span class="p">:</span>
<a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>    <span class="n">name_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a>    <span class="n">email_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a>    <span class="n">active_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a>
<a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">SearchCustomersUseCase</span><span class="p">:</span>
<a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_repository</span><span class="p">:</span> <span class="n">CustomerRepository</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span> <span class="o">=</span> <span class="n">customer_repository</span>
<a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a>
<a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">SearchCustomersQuery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a>        <span class="c1"># This is simplified - in a real app, you&#39;d have more sophisticated</span>
<a id="__codelineno-84-20" name="__codelineno-84-20" href="#__codelineno-84-20"></a>        <span class="c1"># search capabilities in your repository</span>
<a id="__codelineno-84-21" name="__codelineno-84-21" href="#__codelineno-84-21"></a>        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">active_only</span><span class="p">:</span>
<a id="__codelineno-84-22" name="__codelineno-84-22" href="#__codelineno-84-22"></a>            <span class="n">customers</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_all_active</span><span class="p">()</span>
<a id="__codelineno-84-23" name="__codelineno-84-23" href="#__codelineno-84-23"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-84-24" name="__codelineno-84-24" href="#__codelineno-84-24"></a>            <span class="n">customers</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_all</span><span class="p">()</span>
<a id="__codelineno-84-25" name="__codelineno-84-25" href="#__codelineno-84-25"></a>
<a id="__codelineno-84-26" name="__codelineno-84-26" href="#__codelineno-84-26"></a>        <span class="c1"># Apply filters</span>
<a id="__codelineno-84-27" name="__codelineno-84-27" href="#__codelineno-84-27"></a>        <span class="n">filtered_customers</span> <span class="o">=</span> <span class="n">customers</span>
<a id="__codelineno-84-28" name="__codelineno-84-28" href="#__codelineno-84-28"></a>        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">name_filter</span><span class="p">:</span>
<a id="__codelineno-84-29" name="__codelineno-84-29" href="#__codelineno-84-29"></a>            <span class="n">filtered_customers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-84-30" name="__codelineno-84-30" href="#__codelineno-84-30"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">filtered_customers</span> 
<a id="__codelineno-84-31" name="__codelineno-84-31" href="#__codelineno-84-31"></a>                <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">name_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-84-32" name="__codelineno-84-32" href="#__codelineno-84-32"></a>            <span class="p">]</span>
<a id="__codelineno-84-33" name="__codelineno-84-33" href="#__codelineno-84-33"></a>
<a id="__codelineno-84-34" name="__codelineno-84-34" href="#__codelineno-84-34"></a>        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">email_filter</span><span class="p">:</span>
<a id="__codelineno-84-35" name="__codelineno-84-35" href="#__codelineno-84-35"></a>            <span class="n">filtered_customers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-84-36" name="__codelineno-84-36" href="#__codelineno-84-36"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">filtered_customers</span> 
<a id="__codelineno-84-37" name="__codelineno-84-37" href="#__codelineno-84-37"></a>                <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">email_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-84-38" name="__codelineno-84-38" href="#__codelineno-84-38"></a>            <span class="p">]</span>
<a id="__codelineno-84-39" name="__codelineno-84-39" href="#__codelineno-84-39"></a>
<a id="__codelineno-84-40" name="__codelineno-84-40" href="#__codelineno-84-40"></a>        <span class="k">return</span> <span class="n">filtered_customers</span>
</code></pre></div>
<h3 id="infrastructure-layer-technical-implementation-details"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#infrastructure-layer-technical-implementation-details">Infrastructure Layer: Technical Implementation Details</a></h3>
<p>The infrastructure layer implements the interfaces defined by inner layers. It handles databases, external APIs, file systems, and other technical concerns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="c1"># src/infrastructure/database/repositories/customer_repository_impl.py</span>
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a>
<a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span>
<a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
<a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a>
<a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.repositories.customer_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerRepository</span>
<a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.models.customer_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerModel</span>
<a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span>
<a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a>
<a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerRepositoryImpl</span><span class="p">(</span><span class="n">CustomerRepository</span><span class="p">):</span>
<a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;SQLAlchemy implementation of CustomerRepository.&quot;&quot;&quot;</span>
<a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a>
<a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>
<a id="__codelineno-85-18" name="__codelineno-85-18" href="#__codelineno-85-18"></a>
<a id="__codelineno-85-19" name="__codelineno-85-19" href="#__codelineno-85-19"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-85-20" name="__codelineno-85-20" href="#__codelineno-85-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a customer to the database.&quot;&quot;&quot;</span>
<a id="__codelineno-85-21" name="__codelineno-85-21" href="#__codelineno-85-21"></a>        <span class="c1"># Convert domain entity to database model</span>
<a id="__codelineno-85-22" name="__codelineno-85-22" href="#__codelineno-85-22"></a>        <span class="n">customer_model</span> <span class="o">=</span> <span class="n">CustomerModel</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-85-23" name="__codelineno-85-23" href="#__codelineno-85-23"></a>
<a id="__codelineno-85-24" name="__codelineno-85-24" href="#__codelineno-85-24"></a>        <span class="c1"># Check if this is an existing customer</span>
<a id="__codelineno-85-25" name="__codelineno-85-25" href="#__codelineno-85-25"></a>        <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">,</span> <span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-85-26" name="__codelineno-85-26" href="#__codelineno-85-26"></a>        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
<a id="__codelineno-85-27" name="__codelineno-85-27" href="#__codelineno-85-27"></a>            <span class="c1"># Update existing model</span>
<a id="__codelineno-85-28" name="__codelineno-85-28" href="#__codelineno-85-28"></a>            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">customer_model</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-85-29" name="__codelineno-85-29" href="#__codelineno-85-29"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
<a id="__codelineno-85-30" name="__codelineno-85-30" href="#__codelineno-85-30"></a>                    <span class="nb">setattr</span><span class="p">(</span><span class="n">existing</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-85-31" name="__codelineno-85-31" href="#__codelineno-85-31"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-85-32" name="__codelineno-85-32" href="#__codelineno-85-32"></a>            <span class="c1"># Add new model</span>
<a id="__codelineno-85-33" name="__codelineno-85-33" href="#__codelineno-85-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">customer_model</span><span class="p">)</span>
<a id="__codelineno-85-34" name="__codelineno-85-34" href="#__codelineno-85-34"></a>
<a id="__codelineno-85-35" name="__codelineno-85-35" href="#__codelineno-85-35"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-85-36" name="__codelineno-85-36" href="#__codelineno-85-36"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">customer_model</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span> <span class="k">else</span> <span class="n">existing</span><span class="p">)</span>
<a id="__codelineno-85-37" name="__codelineno-85-37" href="#__codelineno-85-37"></a>
<a id="__codelineno-85-38" name="__codelineno-85-38" href="#__codelineno-85-38"></a>        <span class="c1"># Convert back to domain entity</span>
<a id="__codelineno-85-39" name="__codelineno-85-39" href="#__codelineno-85-39"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">customer_model</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span> <span class="k">else</span> <span class="n">existing</span><span class="p">)</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span>
<a id="__codelineno-85-40" name="__codelineno-85-40" href="#__codelineno-85-40"></a>
<a id="__codelineno-85-41" name="__codelineno-85-41" href="#__codelineno-85-41"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-85-42" name="__codelineno-85-42" href="#__codelineno-85-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find customer by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-85-43" name="__codelineno-85-43" href="#__codelineno-85-43"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-85-44" name="__codelineno-85-44" href="#__codelineno-85-44"></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-85-45" name="__codelineno-85-45" href="#__codelineno-85-45"></a>
<a id="__codelineno-85-46" name="__codelineno-85-46" href="#__codelineno-85-46"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_by_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-85-47" name="__codelineno-85-47" href="#__codelineno-85-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find customer by email.&quot;&quot;&quot;</span>
<a id="__codelineno-85-48" name="__codelineno-85-48" href="#__codelineno-85-48"></a>        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">CustomerModel</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span>
<a id="__codelineno-85-49" name="__codelineno-85-49" href="#__codelineno-85-49"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<a id="__codelineno-85-50" name="__codelineno-85-50" href="#__codelineno-85-50"></a>        <span class="n">customer_model</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
<a id="__codelineno-85-51" name="__codelineno-85-51" href="#__codelineno-85-51"></a>        <span class="k">return</span> <span class="n">customer_model</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span> <span class="k">if</span> <span class="n">customer_model</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-85-52" name="__codelineno-85-52" href="#__codelineno-85-52"></a>
<a id="__codelineno-85-53" name="__codelineno-85-53" href="#__codelineno-85-53"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_all_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-85-54" name="__codelineno-85-54" href="#__codelineno-85-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all active customers.&quot;&quot;&quot;</span>
<a id="__codelineno-85-55" name="__codelineno-85-55" href="#__codelineno-85-55"></a>        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">CustomerModel</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-85-56" name="__codelineno-85-56" href="#__codelineno-85-56"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<a id="__codelineno-85-57" name="__codelineno-85-57" href="#__codelineno-85-57"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()]</span>
<a id="__codelineno-85-58" name="__codelineno-85-58" href="#__codelineno-85-58"></a>
<a id="__codelineno-85-59" name="__codelineno-85-59" href="#__codelineno-85-59"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-85-60" name="__codelineno-85-60" href="#__codelineno-85-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete customer by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-85-61" name="__codelineno-85-61" href="#__codelineno-85-61"></a>        <span class="n">customer_model</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-85-62" name="__codelineno-85-62" href="#__codelineno-85-62"></a>        <span class="k">if</span> <span class="n">customer_model</span><span class="p">:</span>
<a id="__codelineno-85-63" name="__codelineno-85-63" href="#__codelineno-85-63"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">customer_model</span><span class="p">)</span>
<a id="__codelineno-85-64" name="__codelineno-85-64" href="#__codelineno-85-64"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p>The database model handles the mapping between domain entities and database tables:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="c1"># src/infrastructure/database/models/customer_model.py</span>
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a>
<a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Text</span>
<a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects.postgresql</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span> <span class="k">as</span> <span class="n">PostgresUUID</span>
<a id="__codelineno-86-9" name="__codelineno-86-9" href="#__codelineno-86-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>
<a id="__codelineno-86-10" name="__codelineno-86-10" href="#__codelineno-86-10"></a>
<a id="__codelineno-86-11" name="__codelineno-86-11" href="#__codelineno-86-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-86-12" name="__codelineno-86-12" href="#__codelineno-86-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.models.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-86-13" name="__codelineno-86-13" href="#__codelineno-86-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Address</span><span class="p">,</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">PhoneNumber</span>
<a id="__codelineno-86-14" name="__codelineno-86-14" href="#__codelineno-86-14"></a>
<a id="__codelineno-86-15" name="__codelineno-86-15" href="#__codelineno-86-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-86-16" name="__codelineno-86-16" href="#__codelineno-86-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;SQLAlchemy model for customer persistence.&quot;&quot;&quot;</span>
<a id="__codelineno-86-17" name="__codelineno-86-17" href="#__codelineno-86-17"></a>
<a id="__codelineno-86-18" name="__codelineno-86-18" href="#__codelineno-86-18"></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customers&quot;</span>
<a id="__codelineno-86-19" name="__codelineno-86-19" href="#__codelineno-86-19"></a>
<a id="__codelineno-86-20" name="__codelineno-86-20" href="#__codelineno-86-20"></a>    <span class="nb">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-86-21" name="__codelineno-86-21" href="#__codelineno-86-21"></a>        <span class="n">PostgresUUID</span><span class="p">(</span><span class="n">as_uuid</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> 
<a id="__codelineno-86-22" name="__codelineno-86-22" href="#__codelineno-86-22"></a>        <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-86-23" name="__codelineno-86-23" href="#__codelineno-86-23"></a>    <span class="p">)</span>
<a id="__codelineno-86-24" name="__codelineno-86-24" href="#__codelineno-86-24"></a>    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-86-25" name="__codelineno-86-25" href="#__codelineno-86-25"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-86-26" name="__codelineno-86-26" href="#__codelineno-86-26"></a>    <span class="n">address_data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-86-27" name="__codelineno-86-27" href="#__codelineno-86-27"></a>        <span class="n">JSON</span><span class="p">,</span> 
<a id="__codelineno-86-28" name="__codelineno-86-28" href="#__codelineno-86-28"></a>        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-86-29" name="__codelineno-86-29" href="#__codelineno-86-29"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;address&quot;</span>
<a id="__codelineno-86-30" name="__codelineno-86-30" href="#__codelineno-86-30"></a>    <span class="p">)</span>
<a id="__codelineno-86-31" name="__codelineno-86-31" href="#__codelineno-86-31"></a>    <span class="n">phone_data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-86-32" name="__codelineno-86-32" href="#__codelineno-86-32"></a>        <span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> 
<a id="__codelineno-86-33" name="__codelineno-86-33" href="#__codelineno-86-33"></a>        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-86-34" name="__codelineno-86-34" href="#__codelineno-86-34"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;phone&quot;</span>
<a id="__codelineno-86-35" name="__codelineno-86-35" href="#__codelineno-86-35"></a>    <span class="p">)</span>
<a id="__codelineno-86-36" name="__codelineno-86-36" href="#__codelineno-86-36"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-86-37" name="__codelineno-86-37" href="#__codelineno-86-37"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-86-38" name="__codelineno-86-38" href="#__codelineno-86-38"></a>        <span class="n">JSON</span><span class="p">,</span> 
<a id="__codelineno-86-39" name="__codelineno-86-39" href="#__codelineno-86-39"></a>        <span class="n">default</span><span class="o">=</span><span class="nb">dict</span>
<a id="__codelineno-86-40" name="__codelineno-86-40" href="#__codelineno-86-40"></a>    <span class="p">)</span>
<a id="__codelineno-86-41" name="__codelineno-86-41" href="#__codelineno-86-41"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-86-42" name="__codelineno-86-42" href="#__codelineno-86-42"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-86-43" name="__codelineno-86-43" href="#__codelineno-86-43"></a>
<a id="__codelineno-86-44" name="__codelineno-86-44" href="#__codelineno-86-44"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-86-45" name="__codelineno-86-45" href="#__codelineno-86-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CustomerModel&quot;</span><span class="p">:</span>
<a id="__codelineno-86-46" name="__codelineno-86-46" href="#__codelineno-86-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert domain entity to database model.&quot;&quot;&quot;</span>
<a id="__codelineno-86-47" name="__codelineno-86-47" href="#__codelineno-86-47"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-86-48" name="__codelineno-86-48" href="#__codelineno-86-48"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-86-49" name="__codelineno-86-49" href="#__codelineno-86-49"></a>            <span class="n">name</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-86-50" name="__codelineno-86-50" href="#__codelineno-86-50"></a>            <span class="n">email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-86-51" name="__codelineno-86-51" href="#__codelineno-86-51"></a>            <span class="n">address_data</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">customer</span><span class="o">.</span><span class="n">address</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-86-52" name="__codelineno-86-52" href="#__codelineno-86-52"></a>            <span class="n">phone_data</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">phone</span><span class="p">)</span> <span class="k">if</span> <span class="n">customer</span><span class="o">.</span><span class="n">phone</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-86-53" name="__codelineno-86-53" href="#__codelineno-86-53"></a>            <span class="n">is_active</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span>
<a id="__codelineno-86-54" name="__codelineno-86-54" href="#__codelineno-86-54"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-86-55" name="__codelineno-86-55" href="#__codelineno-86-55"></a>            <span class="n">created_at</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-86-56" name="__codelineno-86-56" href="#__codelineno-86-56"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<a id="__codelineno-86-57" name="__codelineno-86-57" href="#__codelineno-86-57"></a>        <span class="p">)</span>
<a id="__codelineno-86-58" name="__codelineno-86-58" href="#__codelineno-86-58"></a>
<a id="__codelineno-86-59" name="__codelineno-86-59" href="#__codelineno-86-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-86-60" name="__codelineno-86-60" href="#__codelineno-86-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert database model to domain entity.&quot;&quot;&quot;</span>
<a id="__codelineno-86-61" name="__codelineno-86-61" href="#__codelineno-86-61"></a>        <span class="n">address</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-86-62" name="__codelineno-86-62" href="#__codelineno-86-62"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_data</span><span class="p">:</span>
<a id="__codelineno-86-63" name="__codelineno-86-63" href="#__codelineno-86-63"></a>            <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_data</span><span class="p">)</span>
<a id="__codelineno-86-64" name="__codelineno-86-64" href="#__codelineno-86-64"></a>
<a id="__codelineno-86-65" name="__codelineno-86-65" href="#__codelineno-86-65"></a>        <span class="n">phone</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-86-66" name="__codelineno-86-66" href="#__codelineno-86-66"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phone_data</span><span class="p">:</span>
<a id="__codelineno-86-67" name="__codelineno-86-67" href="#__codelineno-86-67"></a>            <span class="n">phone</span> <span class="o">=</span> <span class="n">PhoneNumber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phone_data</span><span class="p">)</span>
<a id="__codelineno-86-68" name="__codelineno-86-68" href="#__codelineno-86-68"></a>
<a id="__codelineno-86-69" name="__codelineno-86-69" href="#__codelineno-86-69"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-86-70" name="__codelineno-86-70" href="#__codelineno-86-70"></a>            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-86-71" name="__codelineno-86-71" href="#__codelineno-86-71"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-86-72" name="__codelineno-86-72" href="#__codelineno-86-72"></a>            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-86-73" name="__codelineno-86-73" href="#__codelineno-86-73"></a>            <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-86-74" name="__codelineno-86-74" href="#__codelineno-86-74"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-86-75" name="__codelineno-86-75" href="#__codelineno-86-75"></a>            <span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-86-76" name="__codelineno-86-76" href="#__codelineno-86-76"></a>            <span class="n">is_active</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span>
<a id="__codelineno-86-77" name="__codelineno-86-77" href="#__codelineno-86-77"></a>            <span class="n">preferences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-86-78" name="__codelineno-86-78" href="#__codelineno-86-78"></a>            <span class="n">created_at</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-86-79" name="__codelineno-86-79" href="#__codelineno-86-79"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<a id="__codelineno-86-80" name="__codelineno-86-80" href="#__codelineno-86-80"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="presentation-layer-external-interface"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#presentation-layer-external-interface">Presentation Layer: External Interface</a></h3>
<p>The presentation layer handles external communicationâ€”HTTP APIs, command-line interfaces, message queues. It depends on inner layers but remains focused on protocol concerns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="c1"># src/presentation/api/v1/customers.py</span>
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>
<a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a>
<a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.application.use_cases.commands.create_customer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>    <span class="n">CreateCustomerCommand</span><span class="p">,</span>
<a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a>    <span class="n">CreateCustomerUseCase</span><span class="p">,</span>
<a id="__codelineno-87-11" name="__codelineno-87-11" href="#__codelineno-87-11"></a><span class="p">)</span>
<a id="__codelineno-87-12" name="__codelineno-87-12" href="#__codelineno-87-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.application.use_cases.queries.search_customers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-87-13" name="__codelineno-87-13" href="#__codelineno-87-13"></a>    <span class="n">SearchCustomersQuery</span><span class="p">,</span>
<a id="__codelineno-87-14" name="__codelineno-87-14" href="#__codelineno-87-14"></a>    <span class="n">SearchCustomersUseCase</span><span class="p">,</span>
<a id="__codelineno-87-15" name="__codelineno-87-15" href="#__codelineno-87-15"></a><span class="p">)</span>
<a id="__codelineno-87-16" name="__codelineno-87-16" href="#__codelineno-87-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.presentation.schemas.customer_schemas</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-87-17" name="__codelineno-87-17" href="#__codelineno-87-17"></a>    <span class="n">CreateCustomerRequest</span><span class="p">,</span>
<a id="__codelineno-87-18" name="__codelineno-87-18" href="#__codelineno-87-18"></a>    <span class="n">CustomerResponse</span><span class="p">,</span>
<a id="__codelineno-87-19" name="__codelineno-87-19" href="#__codelineno-87-19"></a><span class="p">)</span>
<a id="__codelineno-87-20" name="__codelineno-87-20" href="#__codelineno-87-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.presentation.repositories</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_customer_repository</span>
<a id="__codelineno-87-21" name="__codelineno-87-21" href="#__codelineno-87-21"></a>
<a id="__codelineno-87-22" name="__codelineno-87-22" href="#__codelineno-87-22"></a><span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1/customers&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customers&quot;</span><span class="p">])</span>
<a id="__codelineno-87-23" name="__codelineno-87-23" href="#__codelineno-87-23"></a>
<a id="__codelineno-87-24" name="__codelineno-87-24" href="#__codelineno-87-24"></a><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">CustomerResponse</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
<a id="__codelineno-87-25" name="__codelineno-87-25" href="#__codelineno-87-25"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-87-26" name="__codelineno-87-26" href="#__codelineno-87-26"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">CreateCustomerRequest</span><span class="p">,</span>
<a id="__codelineno-87-27" name="__codelineno-87-27" href="#__codelineno-87-27"></a>    <span class="n">customer_repo</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">),</span>
<a id="__codelineno-87-28" name="__codelineno-87-28" href="#__codelineno-87-28"></a><span class="p">):</span>
<a id="__codelineno-87-29" name="__codelineno-87-29" href="#__codelineno-87-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new customer.&quot;&quot;&quot;</span>
<a id="__codelineno-87-30" name="__codelineno-87-30" href="#__codelineno-87-30"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">customer_repo</span><span class="p">)</span>
<a id="__codelineno-87-31" name="__codelineno-87-31" href="#__codelineno-87-31"></a>    <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-87-32" name="__codelineno-87-32" href="#__codelineno-87-32"></a>        <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-87-33" name="__codelineno-87-33" href="#__codelineno-87-33"></a>        <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-87-34" name="__codelineno-87-34" href="#__codelineno-87-34"></a>        <span class="n">preferences</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-87-35" name="__codelineno-87-35" href="#__codelineno-87-35"></a>    <span class="p">)</span>
<a id="__codelineno-87-36" name="__codelineno-87-36" href="#__codelineno-87-36"></a>
<a id="__codelineno-87-37" name="__codelineno-87-37" href="#__codelineno-87-37"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-87-38" name="__codelineno-87-38" href="#__codelineno-87-38"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-87-39" name="__codelineno-87-39" href="#__codelineno-87-39"></a>        <span class="k">return</span> <span class="n">CustomerResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-87-40" name="__codelineno-87-40" href="#__codelineno-87-40"></a>    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-87-41" name="__codelineno-87-41" href="#__codelineno-87-41"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-87-42" name="__codelineno-87-42" href="#__codelineno-87-42"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
<a id="__codelineno-87-43" name="__codelineno-87-43" href="#__codelineno-87-43"></a>            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-87-44" name="__codelineno-87-44" href="#__codelineno-87-44"></a>        <span class="p">)</span>
<a id="__codelineno-87-45" name="__codelineno-87-45" href="#__codelineno-87-45"></a>
<a id="__codelineno-87-46" name="__codelineno-87-46" href="#__codelineno-87-46"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">CustomerResponse</span><span class="p">])</span>
<a id="__codelineno-87-47" name="__codelineno-87-47" href="#__codelineno-87-47"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_customers</span><span class="p">(</span>
<a id="__codelineno-87-48" name="__codelineno-87-48" href="#__codelineno-87-48"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-87-49" name="__codelineno-87-49" href="#__codelineno-87-49"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-87-50" name="__codelineno-87-50" href="#__codelineno-87-50"></a>    <span class="n">active_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-87-51" name="__codelineno-87-51" href="#__codelineno-87-51"></a>    <span class="n">customer_repo</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">),</span>
<a id="__codelineno-87-52" name="__codelineno-87-52" href="#__codelineno-87-52"></a><span class="p">):</span>
<a id="__codelineno-87-53" name="__codelineno-87-53" href="#__codelineno-87-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Search customers.&quot;&quot;&quot;</span>
<a id="__codelineno-87-54" name="__codelineno-87-54" href="#__codelineno-87-54"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">SearchCustomersUseCase</span><span class="p">(</span><span class="n">customer_repo</span><span class="p">)</span>
<a id="__codelineno-87-55" name="__codelineno-87-55" href="#__codelineno-87-55"></a>    <span class="n">query</span> <span class="o">=</span> <span class="n">SearchCustomersQuery</span><span class="p">(</span>
<a id="__codelineno-87-56" name="__codelineno-87-56" href="#__codelineno-87-56"></a>        <span class="n">name_filter</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-87-57" name="__codelineno-87-57" href="#__codelineno-87-57"></a>        <span class="n">email_filter</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-87-58" name="__codelineno-87-58" href="#__codelineno-87-58"></a>        <span class="n">active_only</span><span class="o">=</span><span class="n">active_only</span><span class="p">,</span>
<a id="__codelineno-87-59" name="__codelineno-87-59" href="#__codelineno-87-59"></a>    <span class="p">)</span>
<a id="__codelineno-87-60" name="__codelineno-87-60" href="#__codelineno-87-60"></a>
<a id="__codelineno-87-61" name="__codelineno-87-61" href="#__codelineno-87-61"></a>    <span class="n">customers</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-87-62" name="__codelineno-87-62" href="#__codelineno-87-62"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">CustomerResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">customers</span><span class="p">]</span>
<a id="__codelineno-87-63" name="__codelineno-87-63" href="#__codelineno-87-63"></a>
<a id="__codelineno-87-64" name="__codelineno-87-64" href="#__codelineno-87-64"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">{customer_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">CustomerResponse</span><span class="p">)</span>
<a id="__codelineno-87-65" name="__codelineno-87-65" href="#__codelineno-87-65"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_customer</span><span class="p">(</span>
<a id="__codelineno-87-66" name="__codelineno-87-66" href="#__codelineno-87-66"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
<a id="__codelineno-87-67" name="__codelineno-87-67" href="#__codelineno-87-67"></a>    <span class="n">customer_repo</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">),</span>
<a id="__codelineno-87-68" name="__codelineno-87-68" href="#__codelineno-87-68"></a><span class="p">):</span>
<a id="__codelineno-87-69" name="__codelineno-87-69" href="#__codelineno-87-69"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get customer by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-87-70" name="__codelineno-87-70" href="#__codelineno-87-70"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span>
<a id="__codelineno-87-71" name="__codelineno-87-71" href="#__codelineno-87-71"></a>
<a id="__codelineno-87-72" name="__codelineno-87-72" href="#__codelineno-87-72"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">customer_repo</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">CustomerId</span><span class="p">(</span><span class="n">customer_id</span><span class="p">))</span>
<a id="__codelineno-87-73" name="__codelineno-87-73" href="#__codelineno-87-73"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">customer</span><span class="p">:</span>
<a id="__codelineno-87-74" name="__codelineno-87-74" href="#__codelineno-87-74"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-87-75" name="__codelineno-87-75" href="#__codelineno-87-75"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
<a id="__codelineno-87-76" name="__codelineno-87-76" href="#__codelineno-87-76"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Customer not found&quot;</span><span class="p">,</span>
<a id="__codelineno-87-77" name="__codelineno-87-77" href="#__codelineno-87-77"></a>        <span class="p">)</span>
<a id="__codelineno-87-78" name="__codelineno-87-78" href="#__codelineno-87-78"></a>
<a id="__codelineno-87-79" name="__codelineno-87-79" href="#__codelineno-87-79"></a>    <span class="k">return</span> <span class="n">CustomerResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
</code></pre></div>
<p>The presentation layer uses DTOs (Data Transfer Objects) to handle external data representation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="c1"># src/presentation/schemas/customer_schemas.py</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>
<a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>
<a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a>
<a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a>
<a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request model for creating a customer.&quot;&quot;&quot;</span>
<a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a>
<a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Customer name&quot;</span><span class="p">)</span>
<a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Customer email address&quot;</span><span class="p">)</span>
<a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
<a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
<a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Customer preferences as key-value pairs&quot;</span>
<a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a>    <span class="p">)</span>
<a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a>
<a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-88-21" name="__codelineno-88-21" href="#__codelineno-88-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Response model for customer data.&quot;&quot;&quot;</span>
<a id="__codelineno-88-22" name="__codelineno-88-22" href="#__codelineno-88-22"></a>
<a id="__codelineno-88-23" name="__codelineno-88-23" href="#__codelineno-88-23"></a>    <span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-88-24" name="__codelineno-88-24" href="#__codelineno-88-24"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-88-25" name="__codelineno-88-25" href="#__codelineno-88-25"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-88-26" name="__codelineno-88-26" href="#__codelineno-88-26"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-88-27" name="__codelineno-88-27" href="#__codelineno-88-27"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-88-28" name="__codelineno-88-28" href="#__codelineno-88-28"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-88-29" name="__codelineno-88-29" href="#__codelineno-88-29"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-88-30" name="__codelineno-88-30" href="#__codelineno-88-30"></a>
<a id="__codelineno-88-31" name="__codelineno-88-31" href="#__codelineno-88-31"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-88-32" name="__codelineno-88-32" href="#__codelineno-88-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CustomerResponse&quot;</span><span class="p">:</span>
<a id="__codelineno-88-33" name="__codelineno-88-33" href="#__codelineno-88-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert domain entity to response model.&quot;&quot;&quot;</span>
<a id="__codelineno-88-34" name="__codelineno-88-34" href="#__codelineno-88-34"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-88-35" name="__codelineno-88-35" href="#__codelineno-88-35"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-88-36" name="__codelineno-88-36" href="#__codelineno-88-36"></a>            <span class="n">name</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-88-37" name="__codelineno-88-37" href="#__codelineno-88-37"></a>            <span class="n">email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-88-38" name="__codelineno-88-38" href="#__codelineno-88-38"></a>            <span class="n">is_active</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span>
<a id="__codelineno-88-39" name="__codelineno-88-39" href="#__codelineno-88-39"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-88-40" name="__codelineno-88-40" href="#__codelineno-88-40"></a>            <span class="n">created_at</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-88-41" name="__codelineno-88-41" href="#__codelineno-88-41"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<a id="__codelineno-88-42" name="__codelineno-88-42" href="#__codelineno-88-42"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="dependency-injection-and-wiring"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#dependency-injection-and-wiring">Dependency Injection and Wiring</a></h3>
<p>Clean Architecture requires careful dependency injection. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> shows how to wire dependencies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="c1"># src/presentation/repositories.py</span>
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.repositories.customer_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerRepository</span>
<a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.repositories.customer_repository_impl</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a>    <span class="n">CustomerRepositoryImpl</span><span class="p">,</span>
<a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a><span class="p">)</span>
<a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_async_session</span>
<a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a>
<a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a><span class="nd">@lru_cache</span><span class="p">()</span>
<a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_customer_repository</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">CustomerRepository</span><span class="p">:</span>
<a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get customer repository instance.&quot;&quot;&quot;</span>
<a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">get_async_session</span><span class="p">()</span>
<a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a>    <span class="k">return</span> <span class="n">CustomerRepositoryImpl</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</code></pre></div>
<p>In production systems, you'd use a proper dependency injection container like <code>dependency-injector</code> or <code>punq</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="c1"># Example with dependency-injector</span>
<a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dependency_injector</span><span class="w"> </span><span class="kn">import</span> <span class="n">containers</span><span class="p">,</span> <span class="n">providers</span>
<a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dependency_injector.wiring</span><span class="w"> </span><span class="kn">import</span> <span class="n">Provide</span><span class="p">,</span> <span class="n">inject</span>
<a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>
<a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Container</span><span class="p">(</span><span class="n">containers</span><span class="o">.</span><span class="n">DeclarativeContainer</span><span class="p">):</span>
<a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>    <span class="c1"># Configuration</span>
<a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Configuration</span><span class="p">()</span>
<a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>
<a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>    <span class="c1"># Database</span>
<a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a>    <span class="n">database</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Singleton</span><span class="p">(</span>
<a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>        <span class="n">Database</span><span class="p">,</span>
<a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a>        <span class="n">db_url</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>    <span class="p">)</span>
<a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a>
<a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a>    <span class="c1"># Repositories</span>
<a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a>    <span class="n">customer_repository</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span>
<a id="__codelineno-90-17" name="__codelineno-90-17" href="#__codelineno-90-17"></a>        <span class="n">CustomerRepositoryImpl</span><span class="p">,</span>
<a id="__codelineno-90-18" name="__codelineno-90-18" href="#__codelineno-90-18"></a>        <span class="n">session</span><span class="o">=</span><span class="n">database</span><span class="o">.</span><span class="n">provided</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
<a id="__codelineno-90-19" name="__codelineno-90-19" href="#__codelineno-90-19"></a>    <span class="p">)</span>
<a id="__codelineno-90-20" name="__codelineno-90-20" href="#__codelineno-90-20"></a>
<a id="__codelineno-90-21" name="__codelineno-90-21" href="#__codelineno-90-21"></a>    <span class="c1"># Use cases</span>
<a id="__codelineno-90-22" name="__codelineno-90-22" href="#__codelineno-90-22"></a>    <span class="n">create_customer_use_case</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span>
<a id="__codelineno-90-23" name="__codelineno-90-23" href="#__codelineno-90-23"></a>        <span class="n">CreateCustomerUseCase</span><span class="p">,</span>
<a id="__codelineno-90-24" name="__codelineno-90-24" href="#__codelineno-90-24"></a>        <span class="n">customer_repository</span><span class="o">=</span><span class="n">customer_repository</span><span class="p">,</span>
<a id="__codelineno-90-25" name="__codelineno-90-25" href="#__codelineno-90-25"></a>    <span class="p">)</span>
<a id="__codelineno-90-26" name="__codelineno-90-26" href="#__codelineno-90-26"></a>
<a id="__codelineno-90-27" name="__codelineno-90-27" href="#__codelineno-90-27"></a><span class="nd">@inject</span>
<a id="__codelineno-90-28" name="__codelineno-90-28" href="#__codelineno-90-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_customer_endpoint</span><span class="p">(</span>
<a id="__codelineno-90-29" name="__codelineno-90-29" href="#__codelineno-90-29"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">CreateCustomerRequest</span><span class="p">,</span>
<a id="__codelineno-90-30" name="__codelineno-90-30" href="#__codelineno-90-30"></a>    <span class="n">use_case</span><span class="p">:</span> <span class="n">CreateCustomerUseCase</span> <span class="o">=</span> <span class="n">Provide</span><span class="p">[</span><span class="n">Container</span><span class="o">.</span><span class="n">create_customer_use_case</span><span class="p">],</span>
<a id="__codelineno-90-31" name="__codelineno-90-31" href="#__codelineno-90-31"></a><span class="p">):</span>
<a id="__codelineno-90-32" name="__codelineno-90-32" href="#__codelineno-90-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create customer endpoint with injected dependencies.&quot;&quot;&quot;</span>
<a id="__codelineno-90-33" name="__codelineno-90-33" href="#__codelineno-90-33"></a>    <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-90-34" name="__codelineno-90-34" href="#__codelineno-90-34"></a>        <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-90-35" name="__codelineno-90-35" href="#__codelineno-90-35"></a>        <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-90-36" name="__codelineno-90-36" href="#__codelineno-90-36"></a>        <span class="n">preferences</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-90-37" name="__codelineno-90-37" href="#__codelineno-90-37"></a>    <span class="p">)</span>
<a id="__codelineno-90-38" name="__codelineno-90-38" href="#__codelineno-90-38"></a>    <span class="k">return</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</code></pre></div>
<h3 id="testing-clean-architecture"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#testing-clean-architecture">Testing Clean Architecture</a></h3>
<p>The beauty of Clean Architecture reveals itself in testing. Each layer can be tested independently:</p>
<h4 id="domain-layer-testing"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#domain-layer-testing">Domain Layer Testing</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="c1"># tests/unit/domain/test_customer.py</span>
<a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span>
<a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a>
<a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_customer_creation</span><span class="p">():</span>
<a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test customer creation with domain events.&quot;&quot;&quot;</span>
<a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a>    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">()</span>
<a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a>
<a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-91-12" name="__codelineno-91-12" href="#__codelineno-91-12"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-91-13" name="__codelineno-91-13" href="#__codelineno-91-13"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-91-14" name="__codelineno-91-14" href="#__codelineno-91-14"></a>        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-91-15" name="__codelineno-91-15" href="#__codelineno-91-15"></a>        <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">},</span>
<a id="__codelineno-91-16" name="__codelineno-91-16" href="#__codelineno-91-16"></a>    <span class="p">)</span>
<a id="__codelineno-91-17" name="__codelineno-91-17" href="#__codelineno-91-17"></a>
<a id="__codelineno-91-18" name="__codelineno-91-18" href="#__codelineno-91-18"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-91-19" name="__codelineno-91-19" href="#__codelineno-91-19"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span>
<a id="__codelineno-91-20" name="__codelineno-91-20" href="#__codelineno-91-20"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">is_active</span>
<a id="__codelineno-91-21" name="__codelineno-91-21" href="#__codelineno-91-21"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">get_domain_events</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-91-22" name="__codelineno-91-22" href="#__codelineno-91-22"></a>
<a id="__codelineno-91-23" name="__codelineno-91-23" href="#__codelineno-91-23"></a>    <span class="n">event</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">get_domain_events</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-91-24" name="__codelineno-91-24" href="#__codelineno-91-24"></a>    <span class="k">assert</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-91-25" name="__codelineno-91-25" href="#__codelineno-91-25"></a>
<a id="__codelineno-91-26" name="__codelineno-91-26" href="#__codelineno-91-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_customer_deactivation</span><span class="p">():</span>
<a id="__codelineno-91-27" name="__codelineno-91-27" href="#__codelineno-91-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test customer deactivation business rule.&quot;&quot;&quot;</span>
<a id="__codelineno-91-28" name="__codelineno-91-28" href="#__codelineno-91-28"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-91-29" name="__codelineno-91-29" href="#__codelineno-91-29"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-91-30" name="__codelineno-91-30" href="#__codelineno-91-30"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span> 
<a id="__codelineno-91-31" name="__codelineno-91-31" href="#__codelineno-91-31"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-91-32" name="__codelineno-91-32" href="#__codelineno-91-32"></a>    <span class="p">)</span>
<a id="__codelineno-91-33" name="__codelineno-91-33" href="#__codelineno-91-33"></a>
<a id="__codelineno-91-34" name="__codelineno-91-34" href="#__codelineno-91-34"></a>    <span class="n">deactivated</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">deactivate</span><span class="p">(</span><span class="s2">&quot;Account closed&quot;</span><span class="p">)</span>
<a id="__codelineno-91-35" name="__codelineno-91-35" href="#__codelineno-91-35"></a>
<a id="__codelineno-91-36" name="__codelineno-91-36" href="#__codelineno-91-36"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">deactivated</span><span class="o">.</span><span class="n">is_active</span>
<a id="__codelineno-91-37" name="__codelineno-91-37" href="#__codelineno-91-37"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">deactivated</span><span class="o">.</span><span class="n">get_domain_events</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># Created + Deactivated</span>
</code></pre></div>
<h4 id="application-layer-testing"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#application-layer-testing">Application Layer Testing</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="c1"># tests/unit/application/test_create_customer.py</span>
<a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncMock</span>
<a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a>
<a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.application.use_cases.commands.create_customer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a>    <span class="n">CreateCustomerCommand</span><span class="p">,</span>
<a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a>    <span class="n">CreateCustomerUseCase</span><span class="p">,</span>
<a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a><span class="p">)</span>
<a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span>
<a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a>
<a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-92-13" name="__codelineno-92-13" href="#__codelineno-92-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">mock_customer_repository</span><span class="p">():</span>
<a id="__codelineno-92-14" name="__codelineno-92-14" href="#__codelineno-92-14"></a>    <span class="k">return</span> <span class="n">AsyncMock</span><span class="p">()</span>
<a id="__codelineno-92-15" name="__codelineno-92-15" href="#__codelineno-92-15"></a>
<a id="__codelineno-92-16" name="__codelineno-92-16" href="#__codelineno-92-16"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-92-17" name="__codelineno-92-17" href="#__codelineno-92-17"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer_success</span><span class="p">(</span><span class="n">mock_customer_repository</span><span class="p">):</span>
<a id="__codelineno-92-18" name="__codelineno-92-18" href="#__codelineno-92-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful customer creation.&quot;&quot;&quot;</span>
<a id="__codelineno-92-19" name="__codelineno-92-19" href="#__codelineno-92-19"></a>    <span class="c1"># Arrange</span>
<a id="__codelineno-92-20" name="__codelineno-92-20" href="#__codelineno-92-20"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-92-21" name="__codelineno-92-21" href="#__codelineno-92-21"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-92-22" name="__codelineno-92-22" href="#__codelineno-92-22"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-92-23" name="__codelineno-92-23" href="#__codelineno-92-23"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-92-24" name="__codelineno-92-24" href="#__codelineno-92-24"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-92-25" name="__codelineno-92-25" href="#__codelineno-92-25"></a>    <span class="p">)</span>
<a id="__codelineno-92-26" name="__codelineno-92-26" href="#__codelineno-92-26"></a>
<a id="__codelineno-92-27" name="__codelineno-92-27" href="#__codelineno-92-27"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">mock_customer_repository</span><span class="p">)</span>
<a id="__codelineno-92-28" name="__codelineno-92-28" href="#__codelineno-92-28"></a>    <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-92-29" name="__codelineno-92-29" href="#__codelineno-92-29"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-92-30" name="__codelineno-92-30" href="#__codelineno-92-30"></a>        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-92-31" name="__codelineno-92-31" href="#__codelineno-92-31"></a>        <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">},</span>
<a id="__codelineno-92-32" name="__codelineno-92-32" href="#__codelineno-92-32"></a>    <span class="p">)</span>
<a id="__codelineno-92-33" name="__codelineno-92-33" href="#__codelineno-92-33"></a>
<a id="__codelineno-92-34" name="__codelineno-92-34" href="#__codelineno-92-34"></a>    <span class="c1"># Act</span>
<a id="__codelineno-92-35" name="__codelineno-92-35" href="#__codelineno-92-35"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-92-36" name="__codelineno-92-36" href="#__codelineno-92-36"></a>
<a id="__codelineno-92-37" name="__codelineno-92-37" href="#__codelineno-92-37"></a>    <span class="c1"># Assert</span>
<a id="__codelineno-92-38" name="__codelineno-92-38" href="#__codelineno-92-38"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-92-39" name="__codelineno-92-39" href="#__codelineno-92-39"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-92-40" name="__codelineno-92-40" href="#__codelineno-92-40"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-92-41" name="__codelineno-92-41" href="#__codelineno-92-41"></a>
<a id="__codelineno-92-42" name="__codelineno-92-42" href="#__codelineno-92-42"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-92-43" name="__codelineno-92-43" href="#__codelineno-92-43"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer_duplicate_email</span><span class="p">(</span><span class="n">mock_customer_repository</span><span class="p">):</span>
<a id="__codelineno-92-44" name="__codelineno-92-44" href="#__codelineno-92-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test creating customer with duplicate email raises error.&quot;&quot;&quot;</span>
<a id="__codelineno-92-45" name="__codelineno-92-45" href="#__codelineno-92-45"></a>    <span class="c1"># Arrange</span>
<a id="__codelineno-92-46" name="__codelineno-92-46" href="#__codelineno-92-46"></a>    <span class="n">existing_customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-92-47" name="__codelineno-92-47" href="#__codelineno-92-47"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-92-48" name="__codelineno-92-48" href="#__codelineno-92-48"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Existing&quot;</span><span class="p">,</span>
<a id="__codelineno-92-49" name="__codelineno-92-49" href="#__codelineno-92-49"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-92-50" name="__codelineno-92-50" href="#__codelineno-92-50"></a>    <span class="p">)</span>
<a id="__codelineno-92-51" name="__codelineno-92-51" href="#__codelineno-92-51"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">existing_customer</span>
<a id="__codelineno-92-52" name="__codelineno-92-52" href="#__codelineno-92-52"></a>
<a id="__codelineno-92-53" name="__codelineno-92-53" href="#__codelineno-92-53"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">mock_customer_repository</span><span class="p">)</span>
<a id="__codelineno-92-54" name="__codelineno-92-54" href="#__codelineno-92-54"></a>    <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-92-55" name="__codelineno-92-55" href="#__codelineno-92-55"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-92-56" name="__codelineno-92-56" href="#__codelineno-92-56"></a>        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-92-57" name="__codelineno-92-57" href="#__codelineno-92-57"></a>    <span class="p">)</span>
<a id="__codelineno-92-58" name="__codelineno-92-58" href="#__codelineno-92-58"></a>
<a id="__codelineno-92-59" name="__codelineno-92-59" href="#__codelineno-92-59"></a>    <span class="c1"># Act &amp; Assert</span>
<a id="__codelineno-92-60" name="__codelineno-92-60" href="#__codelineno-92-60"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Customer with email .* already exists&quot;</span><span class="p">):</span>
<a id="__codelineno-92-61" name="__codelineno-92-61" href="#__codelineno-92-61"></a>        <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</code></pre></div>
<h4 id="integration-testing"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#integration-testing">Integration Testing</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="c1"># tests/integration/test_customer_repository.py</span>
<a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_async_engine</span><span class="p">,</span> <span class="n">async_sessionmaker</span>
<a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a>
<a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.repositories.customer_repository_impl</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a>    <span class="n">CustomerRepositoryImpl</span><span class="p">,</span>
<a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a><span class="p">)</span>
<a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span>
<a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a>
<a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-93-12" name="__codelineno-93-12" href="#__codelineno-93-12"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">repository</span><span class="p">():</span>
<a id="__codelineno-93-13" name="__codelineno-93-13" href="#__codelineno-93-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create repository with in-memory database.&quot;&quot;&quot;</span>
<a id="__codelineno-93-14" name="__codelineno-93-14" href="#__codelineno-93-14"></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="s2">&quot;sqlite+aiosqlite:///:memory:&quot;</span><span class="p">)</span>
<a id="__codelineno-93-15" name="__codelineno-93-15" href="#__codelineno-93-15"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-93-16" name="__codelineno-93-16" href="#__codelineno-93-16"></a>        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">BaseModel</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>
<a id="__codelineno-93-17" name="__codelineno-93-17" href="#__codelineno-93-17"></a>
<a id="__codelineno-93-18" name="__codelineno-93-18" href="#__codelineno-93-18"></a>    <span class="n">async_session</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-93-19" name="__codelineno-93-19" href="#__codelineno-93-19"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">async_session</span><span class="p">()</span>
<a id="__codelineno-93-20" name="__codelineno-93-20" href="#__codelineno-93-20"></a>
<a id="__codelineno-93-21" name="__codelineno-93-21" href="#__codelineno-93-21"></a>    <span class="k">yield</span> <span class="n">CustomerRepositoryImpl</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<a id="__codelineno-93-22" name="__codelineno-93-22" href="#__codelineno-93-22"></a>
<a id="__codelineno-93-23" name="__codelineno-93-23" href="#__codelineno-93-23"></a>    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-93-24" name="__codelineno-93-24" href="#__codelineno-93-24"></a>    <span class="k">await</span> <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
<a id="__codelineno-93-25" name="__codelineno-93-25" href="#__codelineno-93-25"></a>
<a id="__codelineno-93-26" name="__codelineno-93-26" href="#__codelineno-93-26"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-93-27" name="__codelineno-93-27" href="#__codelineno-93-27"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_save_and_find_customer</span><span class="p">(</span><span class="n">repository</span><span class="p">):</span>
<a id="__codelineno-93-28" name="__codelineno-93-28" href="#__codelineno-93-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test saving and finding a customer.&quot;&quot;&quot;</span>
<a id="__codelineno-93-29" name="__codelineno-93-29" href="#__codelineno-93-29"></a>    <span class="c1"># Arrange</span>
<a id="__codelineno-93-30" name="__codelineno-93-30" href="#__codelineno-93-30"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-93-31" name="__codelineno-93-31" href="#__codelineno-93-31"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-93-32" name="__codelineno-93-32" href="#__codelineno-93-32"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-93-33" name="__codelineno-93-33" href="#__codelineno-93-33"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-93-34" name="__codelineno-93-34" href="#__codelineno-93-34"></a>    <span class="p">)</span>
<a id="__codelineno-93-35" name="__codelineno-93-35" href="#__codelineno-93-35"></a>
<a id="__codelineno-93-36" name="__codelineno-93-36" href="#__codelineno-93-36"></a>    <span class="c1"># Act</span>
<a id="__codelineno-93-37" name="__codelineno-93-37" href="#__codelineno-93-37"></a>    <span class="n">saved_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-93-38" name="__codelineno-93-38" href="#__codelineno-93-38"></a>    <span class="n">found_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-93-39" name="__codelineno-93-39" href="#__codelineno-93-39"></a>
<a id="__codelineno-93-40" name="__codelineno-93-40" href="#__codelineno-93-40"></a>    <span class="c1"># Assert</span>
<a id="__codelineno-93-41" name="__codelineno-93-41" href="#__codelineno-93-41"></a>    <span class="k">assert</span> <span class="n">saved_customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-93-42" name="__codelineno-93-42" href="#__codelineno-93-42"></a>    <span class="k">assert</span> <span class="n">found_customer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-93-43" name="__codelineno-93-43" href="#__codelineno-93-43"></a>    <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-93-44" name="__codelineno-93-44" href="#__codelineno-93-44"></a>    <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="benefits-of-clean-architecture"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#benefits-of-clean-architecture">Benefits of Clean Architecture</a></h3>
<p>The investment in Clean Architecture pays dividends:</p>
<h4 id="1-framework-independence"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#1-framework-independence">1. Framework Independence</a></h4>
<p>Your business logic isn't tied to FastAPI, Django, or any framework. Switching from FastAPI to Django only requires changes in the presentation layer:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="c1"># Django views using the same use cases</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">django.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">View</span>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a>        <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">())</span>
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a>        <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>            <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a>            <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
<a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a>        <span class="p">)</span>
<a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-94-13" name="__codelineno-94-13" href="#__codelineno-94-13"></a>        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">CustomerSerializer</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<h4 id="2-database-independence"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#2-database-independence">2. Database Independence</a></h4>
<p>Switching from PostgreSQL to MongoDB only requires implementing new repositories:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="c1"># MongoDB repository implementation</span>
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">MongoCustomerRepository</span><span class="p">(</span><span class="n">CustomerRepository</span><span class="p">):</span>
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>
<a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a>        <span class="n">document</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a>            <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a>            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a>            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a>            <span class="c1"># ... other fields</span>
<a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a>        <span class="p">}</span>
<a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span>
<a id="__codelineno-95-14" name="__codelineno-95-14" href="#__codelineno-95-14"></a>            <span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)},</span> 
<a id="__codelineno-95-15" name="__codelineno-95-15" href="#__codelineno-95-15"></a>            <span class="n">document</span><span class="p">,</span> 
<a id="__codelineno-95-16" name="__codelineno-95-16" href="#__codelineno-95-16"></a>            <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-95-17" name="__codelineno-95-17" href="#__codelineno-95-17"></a>        <span class="p">)</span>
<a id="__codelineno-95-18" name="__codelineno-95-18" href="#__codelineno-95-18"></a>        <span class="k">return</span> <span class="n">customer</span>
</code></pre></div>
<h4 id="3-testability"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#3-testability">3. Testability</a></h4>
<p>Business logic can be tested without external dependencies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_complex_business_rule</span><span class="p">():</span>
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test complex business logic in isolation.&quot;&quot;&quot;</span>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a>    <span class="c1"># No database, no HTTP, no external services required</span>
<a id="__codelineno-96-4" name="__codelineno-96-4" href="#__codelineno-96-4"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-96-5" name="__codelineno-96-5" href="#__codelineno-96-5"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-96-6" name="__codelineno-96-6" href="#__codelineno-96-6"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-96-7" name="__codelineno-96-7" href="#__codelineno-96-7"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-96-8" name="__codelineno-96-8" href="#__codelineno-96-8"></a>    <span class="p">)</span>
<a id="__codelineno-96-9" name="__codelineno-96-9" href="#__codelineno-96-9"></a>
<a id="__codelineno-96-10" name="__codelineno-96-10" href="#__codelineno-96-10"></a>    <span class="c1"># Test business rules directly</span>
<a id="__codelineno-96-11" name="__codelineno-96-11" href="#__codelineno-96-11"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">can_place_order</span><span class="p">()</span>
<a id="__codelineno-96-12" name="__codelineno-96-12" href="#__codelineno-96-12"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">calculate_loyalty_discount</span><span class="p">()</span> <span class="o">==</span> <span class="n">Money</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<h4 id="4-multiple-interfaces"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#4-multiple-interfaces">4. Multiple Interfaces</a></h4>
<p>The same business logic can support multiple interfaces:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="c1"># REST API</span>
<a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/customers&quot;</span><span class="p">)</span>
<a id="__codelineno-97-3" name="__codelineno-97-3" href="#__codelineno-97-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer_rest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">CreateCustomerRequest</span><span class="p">):</span>
<a id="__codelineno-97-4" name="__codelineno-97-4" href="#__codelineno-97-4"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">())</span>
<a id="__codelineno-97-5" name="__codelineno-97-5" href="#__codelineno-97-5"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CreateCustomerCommand</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-97-6" name="__codelineno-97-6" href="#__codelineno-97-6"></a>
<a id="__codelineno-97-7" name="__codelineno-97-7" href="#__codelineno-97-7"></a><span class="c1"># GraphQL API  </span>
<a id="__codelineno-97-8" name="__codelineno-97-8" href="#__codelineno-97-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer_graphql</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<a id="__codelineno-97-9" name="__codelineno-97-9" href="#__codelineno-97-9"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">())</span>
<a id="__codelineno-97-10" name="__codelineno-97-10" href="#__codelineno-97-10"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CreateCustomerCommand</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-97-11" name="__codelineno-97-11" href="#__codelineno-97-11"></a>
<a id="__codelineno-97-12" name="__codelineno-97-12" href="#__codelineno-97-12"></a><span class="c1"># CLI Command</span>
<a id="__codelineno-97-13" name="__codelineno-97-13" href="#__codelineno-97-13"></a><span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<a id="__codelineno-97-14" name="__codelineno-97-14" href="#__codelineno-97-14"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">)</span>
<a id="__codelineno-97-15" name="__codelineno-97-15" href="#__codelineno-97-15"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--email&#39;</span><span class="p">)</span>
<a id="__codelineno-97-16" name="__codelineno-97-16" href="#__codelineno-97-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_customer_cli</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-97-17" name="__codelineno-97-17" href="#__codelineno-97-17"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">())</span>
<a id="__codelineno-97-18" name="__codelineno-97-18" href="#__codelineno-97-18"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CreateCustomerCommand</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">))</span>
<a id="__codelineno-97-19" name="__codelineno-97-19" href="#__codelineno-97-19"></a>    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created customer: </span><span class="si">{</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="common-pitfalls-and-solutions"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#common-pitfalls-and-solutions">Common Pitfalls and Solutions</a></h3>
<h4 id="1-over-engineering-simple-applications"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#1-over-engineering-simple-applications">1. Over-Engineering Simple Applications</a></h4>
<p>Not every application needs Clean Architecture. For simple CRUD applications, it might be overkill. Use it when:</p>
<ul>
<li>Business logic is complex</li>
<li>Multiple teams work on the codebase</li>
<li>You need to support multiple interfaces</li>
<li>The application will evolve significantly over time</li>
</ul>
<h4 id="2-leaky-abstractions"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#2-leaky-abstractions">2. Leaky Abstractions</a></h4>
<p>Domain entities shouldn't know about infrastructure concerns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="c1"># Bad - domain entity knowing about HTTP</span>
<a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">:</span>
<a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># âŒ HTTP concern in domain</span>
<a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a>
<a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a><span class="c1"># Good - infrastructure handles serialization</span>
<a id="__codelineno-98-7" name="__codelineno-98-7" href="#__codelineno-98-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerResponse</span><span class="p">:</span>
<a id="__codelineno-98-8" name="__codelineno-98-8" href="#__codelineno-98-8"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-98-9" name="__codelineno-98-9" href="#__codelineno-98-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CustomerResponse&quot;</span><span class="p">:</span>
<a id="__codelineno-98-10" name="__codelineno-98-10" href="#__codelineno-98-10"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h4 id="3-anemic-domain-models"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#3-anemic-domain-models">3. Anemic Domain Models</a></h4>
<p>Don't create entities that are just data containers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="c1"># Bad - anemic model</span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">:</span>
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a>
<a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerService</span><span class="p">:</span>
<a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">):</span>  <span class="c1"># âŒ Logic outside entity</span>
<a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
<a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name required&quot;</span><span class="p">)</span>
<a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a>
<a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a><span class="c1"># Good - rich domain model</span>
<a id="__codelineno-99-13" name="__codelineno-99-13" href="#__codelineno-99-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">:</span>
<a id="__codelineno-99-14" name="__codelineno-99-14" href="#__codelineno-99-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-99-15" name="__codelineno-99-15" href="#__codelineno-99-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>  <span class="c1"># âœ… Validation in entity</span>
<a id="__codelineno-99-16" name="__codelineno-99-16" href="#__codelineno-99-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-99-17" name="__codelineno-99-17" href="#__codelineno-99-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<a id="__codelineno-99-18" name="__codelineno-99-18" href="#__codelineno-99-18"></a>
<a id="__codelineno-99-19" name="__codelineno-99-19" href="#__codelineno-99-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-99-20" name="__codelineno-99-20" href="#__codelineno-99-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-99-21" name="__codelineno-99-21" href="#__codelineno-99-21"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name required&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#conclusion">Conclusion</a></h3>
<p>Clean Architecture isn't about following rules blindlyâ€”it's about creating software that reflects your business domain clearly and remains adaptable to change. By organizing code into concentric circles with dependencies pointing inward, you create applications that are testable, maintainable, and independent of technical details.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates these principles in practice, showing how Python's features support Clean Architecture naturally. The key is starting with your business logic and building outward, not starting with the database or framework and working in.</p>
<p>In the next post, we'll dive deep into Value Objectsâ€”those small but powerful classes that make your domain model more expressive and your code more reliable. We'll see how they eliminate primitive obsession and create type-safe domain boundaries.</p>
<h3 id="references"><a class="toclink" href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#references">References</a></h3>
<ul>
<li><a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Clean Architecture Book</a> - Uncle Bob's original Clean Architecture concept</li>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete Clean Architecture implementation</li>
<li><a href="https://martinfowler.com/bliki/DomainDrivenDesign.html">Domain-Driven Design</a> - Martin Fowler's DDD overview</li>
<li><a href="https://alistair.cockburn.us/hexagonal-architecture/">Hexagonal Architecture</a> - Alistair Cockburn's original concept</li>
</ul>
<p>Remember: Clean Architecture isn't about complexityâ€”it's about managing complexity in the right places.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-06-02 18:45:00-04:00">Jun 2, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../domain-driven-design/" class="md-meta__link">Domain-Driven Design</a>, 
              <a href="../../" class="md-meta__link">Python</a>, 
              <a href="../../../software-architecture/" class="md-meta__link">Software Architecture</a></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="domain-driven-design-in-python-more-than-just-folders"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/">Domain-Driven Design in Python: More Than Just Folders</a></h2>
<p>Domain-Driven Design changed how I write software. Not because it gave me new technical patterns, but because it taught me to think differently about code. Instead of starting with database schemas or API endpoints, I now start with the business problem.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates DDD in action, showing how Python's features naturally support domain modeling. This isn't about forcing Java patterns into Pythonâ€”it's about leveraging Python's strengths to express business concepts clearly.</p>
<h3 id="understanding-domain-driven-design"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#understanding-domain-driven-design">Understanding Domain-Driven Design</a></h3>
<p>Eric Evans introduced Domain-Driven Design in his seminal book, but the core idea is simple: software should reflect the business it serves. The code should speak the same language as domain experts. When a business person describes a process, developers should be able to point to corresponding code that mirrors that description.</p>
<p>I learned this lesson the hard way. Early in my career, I built an inventory management system where the code was full of technical terms: <code>record</code>, <code>data_object</code>, <code>manager</code>, <code>processor</code>. When bugs arose, conversations with warehouse managers were painful translations between their world and mine. We were speaking different languages about the same system.</p>
<h3 id="the-ubiquitous-language"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#the-ubiquitous-language">The Ubiquitous Language</a></h3>
<p>The foundation of DDD is establishing a common language between developers and domain experts. This isn't just documentationâ€”it's the actual names used in code.</p>
<p>Consider an e-commerce system. The business talks about:
- Customers placing orders
- Orders containing products
- Inventory tracking stock levels
- Payments processing transactions</p>
<p>Your code should mirror this exactly:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1"># Bad - Technical language</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserRecord</span><span class="p">:</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TransactionObject</span><span class="p">:</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>        <span class="k">pass</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="c1"># Good - Business language</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">:</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">place_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">products</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Product</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>        <span class="k">pass</span>
</code></pre></div>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates this throughout. Look at the domain layerâ€”every class name, method, and variable reflects business terminology.</p>
<h3 id="identifying-bounded-contexts"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#identifying-bounded-contexts">Identifying Bounded Contexts</a></h3>
<p>Real businesses aren't monoliths, and neither should your domain model be. Bounded contexts are boundaries within which a particular model applies. The same real-world concept might have different meanings in different contexts.</p>
<p>Take the concept of "Product":
- <strong>Catalog Context</strong>: Products have descriptions, images, categories
- <strong>Inventory Context</strong>: Products have stock levels, warehouse locations
- <strong>Pricing Context</strong>: Products have prices, discounts, tax rates
- <strong>Shipping Context</strong>: Products have weight, dimensions, hazmat flags</p>
<p>Trying to create one "Product" class for all contexts leads to a bloated, confusing model. Instead, each context has its own representation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># src/catalog/domain/product.py</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="nd">@dataclass</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">CatalogProduct</span><span class="p">:</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    <span class="nb">id</span><span class="p">:</span> <span class="n">ProductId</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>    <span class="n">images</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ProductImage</span><span class="p">]</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>    <span class="n">categories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Category</span><span class="p">]</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_description</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Description too short&quot;</span><span class="p">)</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">new_description</span>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="c1"># src/inventory/domain/product.py</span>
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="nd">@dataclass</span>
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">InventoryProduct</span><span class="p">:</span>
<a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a>    <span class="n">sku</span><span class="p">:</span> <span class="n">SKU</span>
<a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a>    <span class="n">quantity_on_hand</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a>    <span class="n">reorder_point</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a>    <span class="n">warehouse_location</span><span class="p">:</span> <span class="n">Location</span>
<a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a>
<a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">needs_reorder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity_on_hand</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reorder_point</span>
<a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a>
<a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">receive_shipment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a>        <span class="k">if</span> <span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-37-28" name="__codelineno-37-28" href="#__codelineno-37-28"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Quantity must be positive&quot;</span><span class="p">)</span>
<a id="__codelineno-37-29" name="__codelineno-37-29" href="#__codelineno-37-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">quantity_on_hand</span> <span class="o">+=</span> <span class="n">quantity</span>
<a id="__codelineno-37-30" name="__codelineno-37-30" href="#__codelineno-37-30"></a>
<a id="__codelineno-37-31" name="__codelineno-37-31" href="#__codelineno-37-31"></a><span class="c1"># src/pricing/domain/product.py</span>
<a id="__codelineno-37-32" name="__codelineno-37-32" href="#__codelineno-37-32"></a><span class="nd">@dataclass</span>
<a id="__codelineno-37-33" name="__codelineno-37-33" href="#__codelineno-37-33"></a><span class="k">class</span><span class="w"> </span><span class="nc">PricedProduct</span><span class="p">:</span>
<a id="__codelineno-37-34" name="__codelineno-37-34" href="#__codelineno-37-34"></a>    <span class="nb">id</span><span class="p">:</span> <span class="n">ProductId</span>
<a id="__codelineno-37-35" name="__codelineno-37-35" href="#__codelineno-37-35"></a>    <span class="n">base_price</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-37-36" name="__codelineno-37-36" href="#__codelineno-37-36"></a>    <span class="n">tax_category</span><span class="p">:</span> <span class="n">TaxCategory</span>
<a id="__codelineno-37-37" name="__codelineno-37-37" href="#__codelineno-37-37"></a>    <span class="n">active_discounts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Discount</span><span class="p">]</span>
<a id="__codelineno-37-38" name="__codelineno-37-38" href="#__codelineno-37-38"></a>
<a id="__codelineno-37-39" name="__codelineno-37-39" href="#__codelineno-37-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-37-40" name="__codelineno-37-40" href="#__codelineno-37-40"></a>        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_price</span> <span class="o">*</span> <span class="n">quantity</span>
<a id="__codelineno-37-41" name="__codelineno-37-41" href="#__codelineno-37-41"></a>        <span class="k">for</span> <span class="n">discount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_discounts</span><span class="p">:</span>
<a id="__codelineno-37-42" name="__codelineno-37-42" href="#__codelineno-37-42"></a>            <span class="k">if</span> <span class="n">discount</span><span class="o">.</span><span class="n">applies_to</span><span class="p">(</span><span class="n">customer</span><span class="p">):</span>
<a id="__codelineno-37-43" name="__codelineno-37-43" href="#__codelineno-37-43"></a>                <span class="n">price</span> <span class="o">=</span> <span class="n">discount</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
<a id="__codelineno-37-44" name="__codelineno-37-44" href="#__codelineno-37-44"></a>        <span class="k">return</span> <span class="n">price</span>
</code></pre></div>
<p>Each model is focused and cohesive. The catalog team can work on product descriptions without worrying about inventory. The pricing team can adjust discount logic without touching shipping calculations.</p>
<h3 id="building-rich-domain-models"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#building-rich-domain-models">Building Rich Domain Models</a></h3>
<p>Python developers often create anemic modelsâ€”data containers with no behavior. DDD advocates for rich models that encapsulate both data and business logic.</p>
<p>Here's an anemic model:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1"># Anemic - Just data, no behavior</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="nd">@dataclass</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">:</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>    <span class="n">total</span><span class="p">:</span> <span class="nb">float</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="c1"># Business logic scattered in services</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderService</span><span class="p">:</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>        <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>        <span class="n">order</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;shipped&#39;</span><span class="p">:</span>
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot cancel shipped order&quot;</span><span class="p">)</span>
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>        <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
</code></pre></div>
<p>Here's a rich domain model:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="c1"># Rich model - Encapsulates business logic</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">:</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">):</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">order_id</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer</span> <span class="o">=</span> <span class="n">customer</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_created_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">:</span> <span class="n">Product</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add item to order with business rule validation.&quot;&quot;&quot;</span>
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">!=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">:</span>
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="s2">&quot;Cannot modify confirmed order&quot;</span><span class="p">)</span>
<a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a>
<a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a>        <span class="k">if</span> <span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="s2">&quot;Quantity must be positive&quot;</span><span class="p">)</span>
<a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a>
<a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">product</span><span class="o">.</span><span class="n">is_available</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>
<a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient stock for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a>
<a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a>        <span class="c1"># Check for existing item</span>
<a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a>        <span class="n">existing_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_item</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a>        <span class="k">if</span> <span class="n">existing_item</span><span class="p">:</span>
<a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a>            <span class="n">existing_item</span><span class="o">.</span><span class="n">increase_quantity</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>
<a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OrderItem</span><span class="p">(</span><span class="n">product</span><span class="p">,</span> <span class="n">quantity</span><span class="p">))</span>
<a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a>
<a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_record_event</span><span class="p">(</span>
<a id="__codelineno-39-30" name="__codelineno-39-30" href="#__codelineno-39-30"></a>            <span class="n">ItemAddedToOrder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>
<a id="__codelineno-39-31" name="__codelineno-39-31" href="#__codelineno-39-31"></a>        <span class="p">)</span>
<a id="__codelineno-39-32" name="__codelineno-39-32" href="#__codelineno-39-32"></a>
<a id="__codelineno-39-33" name="__codelineno-39-33" href="#__codelineno-39-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">remove_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="n">ProductId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-39-34" name="__codelineno-39-34" href="#__codelineno-39-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove item from order.&quot;&quot;&quot;</span>
<a id="__codelineno-39-35" name="__codelineno-39-35" href="#__codelineno-39-35"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">!=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">:</span>
<a id="__codelineno-39-36" name="__codelineno-39-36" href="#__codelineno-39-36"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="s2">&quot;Cannot modify confirmed order&quot;</span><span class="p">)</span>
<a id="__codelineno-39-37" name="__codelineno-39-37" href="#__codelineno-39-37"></a>
<a id="__codelineno-39-38" name="__codelineno-39-38" href="#__codelineno-39-38"></a>        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_item</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span>
<a id="__codelineno-39-39" name="__codelineno-39-39" href="#__codelineno-39-39"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
<a id="__codelineno-39-40" name="__codelineno-39-40" href="#__codelineno-39-40"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Product </span><span class="si">{</span><span class="n">product_id</span><span class="si">}</span><span class="s2"> not in order&quot;</span><span class="p">)</span>
<a id="__codelineno-39-41" name="__codelineno-39-41" href="#__codelineno-39-41"></a>
<a id="__codelineno-39-42" name="__codelineno-39-42" href="#__codelineno-39-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<a id="__codelineno-39-43" name="__codelineno-39-43" href="#__codelineno-39-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_record_event</span><span class="p">(</span><span class="n">ItemRemovedFromOrder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">product_id</span><span class="p">))</span>
<a id="__codelineno-39-44" name="__codelineno-39-44" href="#__codelineno-39-44"></a>
<a id="__codelineno-39-45" name="__codelineno-39-45" href="#__codelineno-39-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-39-46" name="__codelineno-39-46" href="#__codelineno-39-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Confirm order and validate business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-39-47" name="__codelineno-39-47" href="#__codelineno-39-47"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">!=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span><span class="p">:</span>
<a id="__codelineno-39-48" name="__codelineno-39-48" href="#__codelineno-39-48"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="s2">&quot;Order already confirmed&quot;</span><span class="p">)</span>
<a id="__codelineno-39-49" name="__codelineno-39-49" href="#__codelineno-39-49"></a>
<a id="__codelineno-39-50" name="__codelineno-39-50" href="#__codelineno-39-50"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span>
<a id="__codelineno-39-51" name="__codelineno-39-51" href="#__codelineno-39-51"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="s2">&quot;Cannot confirm empty order&quot;</span><span class="p">)</span>
<a id="__codelineno-39-52" name="__codelineno-39-52" href="#__codelineno-39-52"></a>
<a id="__codelineno-39-53" name="__codelineno-39-53" href="#__codelineno-39-53"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">Money</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Currency</span><span class="o">.</span><span class="n">USD</span><span class="p">):</span>
<a id="__codelineno-39-54" name="__codelineno-39-54" href="#__codelineno-39-54"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="s2">&quot;Minimum order amount is $10&quot;</span><span class="p">)</span>
<a id="__codelineno-39-55" name="__codelineno-39-55" href="#__codelineno-39-55"></a>
<a id="__codelineno-39-56" name="__codelineno-39-56" href="#__codelineno-39-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CONFIRMED</span>
<a id="__codelineno-39-57" name="__codelineno-39-57" href="#__codelineno-39-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_record_event</span><span class="p">(</span><span class="n">OrderConfirmed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">()))</span>
<a id="__codelineno-39-58" name="__codelineno-39-58" href="#__codelineno-39-58"></a>
<a id="__codelineno-39-59" name="__codelineno-39-59" href="#__codelineno-39-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-39-60" name="__codelineno-39-60" href="#__codelineno-39-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel order if allowed by business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-39-61" name="__codelineno-39-61" href="#__codelineno-39-61"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">SHIPPED</span><span class="p">:</span>
<a id="__codelineno-39-62" name="__codelineno-39-62" href="#__codelineno-39-62"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="s2">&quot;Cannot cancel shipped order&quot;</span><span class="p">)</span>
<a id="__codelineno-39-63" name="__codelineno-39-63" href="#__codelineno-39-63"></a>
<a id="__codelineno-39-64" name="__codelineno-39-64" href="#__codelineno-39-64"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">DELIVERED</span><span class="p">:</span>
<a id="__codelineno-39-65" name="__codelineno-39-65" href="#__codelineno-39-65"></a>            <span class="k">raise</span> <span class="n">OrderException</span><span class="p">(</span><span class="s2">&quot;Cannot cancel delivered order&quot;</span><span class="p">)</span>
<a id="__codelineno-39-66" name="__codelineno-39-66" href="#__codelineno-39-66"></a>
<a id="__codelineno-39-67" name="__codelineno-39-67" href="#__codelineno-39-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELLED</span>
<a id="__codelineno-39-68" name="__codelineno-39-68" href="#__codelineno-39-68"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_record_event</span><span class="p">(</span><span class="n">OrderCancelled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
<a id="__codelineno-39-69" name="__codelineno-39-69" href="#__codelineno-39-69"></a>
<a id="__codelineno-39-70" name="__codelineno-39-70" href="#__codelineno-39-70"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-39-71" name="__codelineno-39-71" href="#__codelineno-39-71"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate order total with business logic.&quot;&quot;&quot;</span>
<a id="__codelineno-39-72" name="__codelineno-39-72" href="#__codelineno-39-72"></a>        <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">calculate_subtotal</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>
<a id="__codelineno-39-73" name="__codelineno-39-73" href="#__codelineno-39-73"></a>
<a id="__codelineno-39-74" name="__codelineno-39-74" href="#__codelineno-39-74"></a>        <span class="c1"># Apply customer-specific discounts</span>
<a id="__codelineno-39-75" name="__codelineno-39-75" href="#__codelineno-39-75"></a>        <span class="n">discount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer</span><span class="o">.</span><span class="n">calculate_discount</span><span class="p">(</span><span class="n">subtotal</span><span class="p">)</span>
<a id="__codelineno-39-76" name="__codelineno-39-76" href="#__codelineno-39-76"></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">-</span> <span class="n">discount</span>
<a id="__codelineno-39-77" name="__codelineno-39-77" href="#__codelineno-39-77"></a>
<a id="__codelineno-39-78" name="__codelineno-39-78" href="#__codelineno-39-78"></a>        <span class="c1"># Apply shipping</span>
<a id="__codelineno-39-79" name="__codelineno-39-79" href="#__codelineno-39-79"></a>        <span class="n">shipping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_shipping</span><span class="p">()</span>
<a id="__codelineno-39-80" name="__codelineno-39-80" href="#__codelineno-39-80"></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">total</span> <span class="o">+</span> <span class="n">shipping</span>
<a id="__codelineno-39-81" name="__codelineno-39-81" href="#__codelineno-39-81"></a>
<a id="__codelineno-39-82" name="__codelineno-39-82" href="#__codelineno-39-82"></a>        <span class="k">return</span> <span class="n">total</span>
<a id="__codelineno-39-83" name="__codelineno-39-83" href="#__codelineno-39-83"></a>
<a id="__codelineno-39-84" name="__codelineno-39-84" href="#__codelineno-39-84"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_shipping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-39-85" name="__codelineno-39-85" href="#__codelineno-39-85"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate shipping based on business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-39-86" name="__codelineno-39-86" href="#__codelineno-39-86"></a>        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">item</span><span class="o">.</span><span class="n">quantity</span> 
<a id="__codelineno-39-87" name="__codelineno-39-87" href="#__codelineno-39-87"></a>                          <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>
<a id="__codelineno-39-88" name="__codelineno-39-88" href="#__codelineno-39-88"></a>
<a id="__codelineno-39-89" name="__codelineno-39-89" href="#__codelineno-39-89"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Money</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">Currency</span><span class="o">.</span><span class="n">USD</span><span class="p">):</span>
<a id="__codelineno-39-90" name="__codelineno-39-90" href="#__codelineno-39-90"></a>            <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Currency</span><span class="o">.</span><span class="n">USD</span><span class="p">)</span>  <span class="c1"># Free shipping over $100</span>
<a id="__codelineno-39-91" name="__codelineno-39-91" href="#__codelineno-39-91"></a>
<a id="__codelineno-39-92" name="__codelineno-39-92" href="#__codelineno-39-92"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer</span><span class="o">.</span><span class="n">is_premium</span><span class="p">():</span>
<a id="__codelineno-39-93" name="__codelineno-39-93" href="#__codelineno-39-93"></a>            <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">Currency</span><span class="o">.</span><span class="n">USD</span><span class="p">)</span>  <span class="c1"># Flat rate for premium</span>
<a id="__codelineno-39-94" name="__codelineno-39-94" href="#__codelineno-39-94"></a>
<a id="__codelineno-39-95" name="__codelineno-39-95" href="#__codelineno-39-95"></a>        <span class="c1"># Standard shipping calculation</span>
<a id="__codelineno-39-96" name="__codelineno-39-96" href="#__codelineno-39-96"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="p">(</span><span class="n">total_weight</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">Currency</span><span class="o">.</span><span class="n">USD</span><span class="p">)</span>
<a id="__codelineno-39-97" name="__codelineno-39-97" href="#__codelineno-39-97"></a>
<a id="__codelineno-39-98" name="__codelineno-39-98" href="#__codelineno-39-98"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_find_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="n">ProductId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">]:</span>
<a id="__codelineno-39-99" name="__codelineno-39-99" href="#__codelineno-39-99"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find item in order by product ID.&quot;&quot;&quot;</span>
<a id="__codelineno-39-100" name="__codelineno-39-100" href="#__codelineno-39-100"></a>        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> 
<a id="__codelineno-39-101" name="__codelineno-39-101" href="#__codelineno-39-101"></a>                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">product_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-39-102" name="__codelineno-39-102" href="#__codelineno-39-102"></a>
<a id="__codelineno-39-103" name="__codelineno-39-103" href="#__codelineno-39-103"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_record_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">DomainEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-39-104" name="__codelineno-39-104" href="#__codelineno-39-104"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Record domain event for eventual publishing.&quot;&quot;&quot;</span>
<a id="__codelineno-39-105" name="__codelineno-39-105" href="#__codelineno-39-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div>
<p>This rich model:
- Encapsulates all order-related business rules
- Maintains invariants (can't have negative quantities, can't modify shipped orders)
- Speaks the business language (confirm, cancel, add_item)
- Records domain events for cross-aggregate communication</p>
<h3 id="aggregates-and-consistency-boundaries"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#aggregates-and-consistency-boundaries">Aggregates and Consistency Boundaries</a></h3>
<p>Aggregates are clusters of domain objects that we treat as a unit for data changes. They define transaction boundaries and ensure consistency.</p>
<p>The Order aggregate includes Order and OrderItem entities:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">:</span>  <span class="c1"># Aggregate Root</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">):</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">order_id</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer</span> <span class="o">=</span> <span class="n">customer</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Part of aggregate</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>        <span class="c1"># ...</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">:</span> <span class="n">Product</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>        <span class="c1"># All modifications go through the aggregate root</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>        <span class="c1"># This ensures consistency</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>        <span class="k">pass</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderItem</span><span class="p">:</span>  <span class="c1"># Entity within aggregate</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">:</span> <span class="n">Product</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">product</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_price_at_order</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">current_price</span><span class="p">()</span>
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a>
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_subtotal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a>        <span class="c1"># Uses price at time of order, not current price</span>
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_price_at_order</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>
</code></pre></div>
<p>Key aggregate principles:
1. <strong>Reference by ID</strong>: Aggregates reference other aggregates only by ID
2. <strong>Single Transaction</strong>: Changes to an aggregate happen in a single transaction
3. <strong>Eventual Consistency</strong>: Consistency between aggregates is eventual, not immediate
4. <strong>Small Aggregates</strong>: Keep aggregates small for better performance</p>
<h3 id="value-objects-immutable-building-blocks"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#value-objects-immutable-building-blocks">Value Objects: Immutable Building Blocks</a></h3>
<p>Value objects represent concepts that have no identityâ€”they're defined entirely by their attributes. Python's dataclasses and named tuples are perfect for this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">replace</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Currency</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>    <span class="n">USD</span> <span class="o">=</span> <span class="s2">&quot;USD&quot;</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>    <span class="n">EUR</span> <span class="o">=</span> <span class="s2">&quot;EUR&quot;</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>    <span class="n">GBP</span> <span class="o">=</span> <span class="s2">&quot;GBP&quot;</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">Money</span><span class="p">:</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>    <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>    <span class="n">currency</span><span class="p">:</span> <span class="n">Currency</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Money cannot be negative&quot;</span><span class="p">)</span>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Money&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Money&#39;</span><span class="p">:</span>
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot add different currencies&quot;</span><span class="p">)</span>
<a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a>
<a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;Money&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Money&#39;</span><span class="p">:</span>
<a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot subtract different currencies&quot;</span><span class="p">)</span>
<a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a>
<a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Money&#39;</span><span class="p">:</span>
<a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">multiplier</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a>
<a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">convert_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_currency</span><span class="p">:</span> <span class="n">Currency</span><span class="p">,</span> <span class="n">rate</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Money&#39;</span><span class="p">:</span>
<a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to another currency.&quot;&quot;&quot;</span>
<a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="n">target_currency</span><span class="p">:</span>
<a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a>            <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">rate</span><span class="p">,</span> <span class="n">target_currency</span><span class="p">)</span>
<a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a>
<a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format for display.&quot;&quot;&quot;</span>
<a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a>        <span class="n">symbols</span> <span class="o">=</span> <span class="p">{</span><span class="n">Currency</span><span class="o">.</span><span class="n">USD</span><span class="p">:</span> <span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="n">Currency</span><span class="o">.</span><span class="n">EUR</span><span class="p">:</span> <span class="s2">&quot;â‚¬&quot;</span><span class="p">,</span> <span class="n">Currency</span><span class="o">.</span><span class="n">GBP</span><span class="p">:</span> <span class="s2">&quot;Â£&quot;</span><span class="p">}</span>
<a id="__codelineno-41-41" name="__codelineno-41-41" href="#__codelineno-41-41"></a>        <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-41-42" name="__codelineno-41-42" href="#__codelineno-41-42"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-41-43" name="__codelineno-41-43" href="#__codelineno-41-43"></a>
<a id="__codelineno-41-44" name="__codelineno-41-44" href="#__codelineno-41-44"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-41-45" name="__codelineno-41-45" href="#__codelineno-41-45"></a><span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">:</span>
<a id="__codelineno-41-46" name="__codelineno-41-46" href="#__codelineno-41-46"></a>    <span class="n">street</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-41-47" name="__codelineno-41-47" href="#__codelineno-41-47"></a>    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-41-48" name="__codelineno-41-48" href="#__codelineno-41-48"></a>    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-41-49" name="__codelineno-41-49" href="#__codelineno-41-49"></a>    <span class="n">postal_code</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-41-50" name="__codelineno-41-50" href="#__codelineno-41-50"></a>    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-41-51" name="__codelineno-41-51" href="#__codelineno-41-51"></a>
<a id="__codelineno-41-52" name="__codelineno-41-52" href="#__codelineno-41-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-41-53" name="__codelineno-41-53" href="#__codelineno-41-53"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">street</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="p">]):</span>
<a id="__codelineno-41-54" name="__codelineno-41-54" href="#__codelineno-41-54"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Address requires street, city, postal code, and country&quot;</span><span class="p">)</span>
<a id="__codelineno-41-55" name="__codelineno-41-55" href="#__codelineno-41-55"></a>
<a id="__codelineno-41-56" name="__codelineno-41-56" href="#__codelineno-41-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_for_shipping</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-41-57" name="__codelineno-41-57" href="#__codelineno-41-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format address for shipping label.&quot;&quot;&quot;</span>
<a id="__codelineno-41-58" name="__codelineno-41-58" href="#__codelineno-41-58"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">street</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-41-59" name="__codelineno-41-59" href="#__codelineno-41-59"></a>
<a id="__codelineno-41-60" name="__codelineno-41-60" href="#__codelineno-41-60"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-41-61" name="__codelineno-41-61" href="#__codelineno-41-61"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmailAddress</span><span class="p">:</span>
<a id="__codelineno-41-62" name="__codelineno-41-62" href="#__codelineno-41-62"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-41-63" name="__codelineno-41-63" href="#__codelineno-41-63"></a>
<a id="__codelineno-41-64" name="__codelineno-41-64" href="#__codelineno-41-64"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-41-65" name="__codelineno-41-65" href="#__codelineno-41-65"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid_email</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
<a id="__codelineno-41-66" name="__codelineno-41-66" href="#__codelineno-41-66"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid email address: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-41-67" name="__codelineno-41-67" href="#__codelineno-41-67"></a>
<a id="__codelineno-41-68" name="__codelineno-41-68" href="#__codelineno-41-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_valid_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-41-69" name="__codelineno-41-69" href="#__codelineno-41-69"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-41-70" name="__codelineno-41-70" href="#__codelineno-41-70"></a>        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>
<a id="__codelineno-41-71" name="__codelineno-41-71" href="#__codelineno-41-71"></a>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
<a id="__codelineno-41-72" name="__codelineno-41-72" href="#__codelineno-41-72"></a>
<a id="__codelineno-41-73" name="__codelineno-41-73" href="#__codelineno-41-73"></a>    <span class="nd">@property</span>
<a id="__codelineno-41-74" name="__codelineno-41-74" href="#__codelineno-41-74"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-41-75" name="__codelineno-41-75" href="#__codelineno-41-75"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-41-76" name="__codelineno-41-76" href="#__codelineno-41-76"></a>
<a id="__codelineno-41-77" name="__codelineno-41-77" href="#__codelineno-41-77"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-41-78" name="__codelineno-41-78" href="#__codelineno-41-78"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>
<p>Value objects provide:
- Type safety (can't accidentally pass a string where Money is expected)
- Business logic encapsulation (Money knows how to add itself)
- Immutability (prevents accidental mutations)
- Self-validation (invalid states are impossible)</p>
<h3 id="domain-services"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#domain-services">Domain Services</a></h3>
<p>Sometimes business logic doesn't naturally fit within an entity or value object. Domain services handle these cases:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PricingService</span><span class="p">:</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Domain service for complex pricing calculations.&quot;&quot;&quot;</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_order_total</span><span class="p">(</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>        <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">,</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>        <span class="n">promotions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Promotion</span><span class="p">],</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>        <span class="n">tax_calculator</span><span class="p">:</span> <span class="n">TaxCalculator</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate total with all applicable discounts and taxes.&quot;&quot;&quot;</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>        <span class="n">subtotal</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">calculate_subtotal</span><span class="p">()</span>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>        <span class="c1"># Apply promotions</span>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>        <span class="k">for</span> <span class="n">promotion</span> <span class="ow">in</span> <span class="n">promotions</span><span class="p">:</span>
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>            <span class="k">if</span> <span class="n">promotion</span><span class="o">.</span><span class="n">applies_to</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">customer</span><span class="p">):</span>
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>                <span class="n">subtotal</span> <span class="o">=</span> <span class="n">promotion</span><span class="o">.</span><span class="n">apply_discount</span><span class="p">(</span><span class="n">subtotal</span><span class="p">)</span>
<a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a>
<a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a>        <span class="c1"># Apply customer loyalty discount</span>
<a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a>        <span class="k">if</span> <span class="n">customer</span><span class="o">.</span><span class="n">loyalty_tier</span> <span class="o">==</span> <span class="n">LoyaltyTier</span><span class="o">.</span><span class="n">GOLD</span><span class="p">:</span>
<a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a>            <span class="n">subtotal</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.9&#39;</span><span class="p">)</span>  <span class="c1"># 10% off</span>
<a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a>        <span class="k">elif</span> <span class="n">customer</span><span class="o">.</span><span class="n">loyalty_tier</span> <span class="o">==</span> <span class="n">LoyaltyTier</span><span class="o">.</span><span class="n">SILVER</span><span class="p">:</span>
<a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a>            <span class="n">subtotal</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.95&#39;</span><span class="p">)</span>  <span class="c1"># 5% off</span>
<a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a>
<a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a>        <span class="c1"># Calculate tax</span>
<a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a>        <span class="n">tax</span> <span class="o">=</span> <span class="n">tax_calculator</span><span class="o">.</span><span class="n">calculate_tax</span><span class="p">(</span><span class="n">subtotal</span><span class="p">,</span> <span class="n">customer</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a>
<a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a>        <span class="c1"># Add shipping</span>
<a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a>        <span class="n">shipping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_shipping</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a>
<a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a>        <span class="k">return</span> <span class="n">subtotal</span> <span class="o">+</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">shipping</span>
<a id="__codelineno-42-33" name="__codelineno-42-33" href="#__codelineno-42-33"></a>
<a id="__codelineno-42-34" name="__codelineno-42-34" href="#__codelineno-42-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_shipping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-42-35" name="__codelineno-42-35" href="#__codelineno-42-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Complex shipping calculation logic.&quot;&quot;&quot;</span>
<a id="__codelineno-42-36" name="__codelineno-42-36" href="#__codelineno-42-36"></a>        <span class="c1"># Business logic that involves multiple aggregates</span>
<a id="__codelineno-42-37" name="__codelineno-42-37" href="#__codelineno-42-37"></a>        <span class="k">pass</span>
<a id="__codelineno-42-38" name="__codelineno-42-38" href="#__codelineno-42-38"></a>
<a id="__codelineno-42-39" name="__codelineno-42-39" href="#__codelineno-42-39"></a><span class="k">class</span><span class="w"> </span><span class="nc">InventoryAllocationService</span><span class="p">:</span>
<a id="__codelineno-42-40" name="__codelineno-42-40" href="#__codelineno-42-40"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Domain service for inventory allocation.&quot;&quot;&quot;</span>
<a id="__codelineno-42-41" name="__codelineno-42-41" href="#__codelineno-42-41"></a>
<a id="__codelineno-42-42" name="__codelineno-42-42" href="#__codelineno-42-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">allocate_inventory</span><span class="p">(</span>
<a id="__codelineno-42-43" name="__codelineno-42-43" href="#__codelineno-42-43"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-42-44" name="__codelineno-42-44" href="#__codelineno-42-44"></a>        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
<a id="__codelineno-42-45" name="__codelineno-42-45" href="#__codelineno-42-45"></a>        <span class="n">warehouses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Warehouse</span><span class="p">]</span>
<a id="__codelineno-42-46" name="__codelineno-42-46" href="#__codelineno-42-46"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AllocationResult</span><span class="p">:</span>
<a id="__codelineno-42-47" name="__codelineno-42-47" href="#__codelineno-42-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Allocate inventory from multiple warehouses.&quot;&quot;&quot;</span>
<a id="__codelineno-42-48" name="__codelineno-42-48" href="#__codelineno-42-48"></a>
<a id="__codelineno-42-49" name="__codelineno-42-49" href="#__codelineno-42-49"></a>        <span class="n">allocations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-42-50" name="__codelineno-42-50" href="#__codelineno-42-50"></a>        <span class="n">remaining_items</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">get_items</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-42-51" name="__codelineno-42-51" href="#__codelineno-42-51"></a>
<a id="__codelineno-42-52" name="__codelineno-42-52" href="#__codelineno-42-52"></a>        <span class="c1"># Sort warehouses by proximity to customer</span>
<a id="__codelineno-42-53" name="__codelineno-42-53" href="#__codelineno-42-53"></a>        <span class="n">sorted_warehouses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sort_by_proximity</span><span class="p">(</span>
<a id="__codelineno-42-54" name="__codelineno-42-54" href="#__codelineno-42-54"></a>            <span class="n">warehouses</span><span class="p">,</span> 
<a id="__codelineno-42-55" name="__codelineno-42-55" href="#__codelineno-42-55"></a>            <span class="n">order</span><span class="o">.</span><span class="n">shipping_address</span>
<a id="__codelineno-42-56" name="__codelineno-42-56" href="#__codelineno-42-56"></a>        <span class="p">)</span>
<a id="__codelineno-42-57" name="__codelineno-42-57" href="#__codelineno-42-57"></a>
<a id="__codelineno-42-58" name="__codelineno-42-58" href="#__codelineno-42-58"></a>        <span class="k">for</span> <span class="n">warehouse</span> <span class="ow">in</span> <span class="n">sorted_warehouses</span><span class="p">:</span>
<a id="__codelineno-42-59" name="__codelineno-42-59" href="#__codelineno-42-59"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">remaining_items</span><span class="p">:</span>
<a id="__codelineno-42-60" name="__codelineno-42-60" href="#__codelineno-42-60"></a>                <span class="k">break</span>
<a id="__codelineno-42-61" name="__codelineno-42-61" href="#__codelineno-42-61"></a>
<a id="__codelineno-42-62" name="__codelineno-42-62" href="#__codelineno-42-62"></a>            <span class="n">warehouse_allocations</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-42-63" name="__codelineno-42-63" href="#__codelineno-42-63"></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">remaining_items</span><span class="p">[:]:</span>
<a id="__codelineno-42-64" name="__codelineno-42-64" href="#__codelineno-42-64"></a>                <span class="n">available</span> <span class="o">=</span> <span class="n">warehouse</span><span class="o">.</span><span class="n">check_availability</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
<a id="__codelineno-42-65" name="__codelineno-42-65" href="#__codelineno-42-65"></a>                <span class="k">if</span> <span class="n">available</span> <span class="o">&gt;=</span> <span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">:</span>
<a id="__codelineno-42-66" name="__codelineno-42-66" href="#__codelineno-42-66"></a>                    <span class="n">warehouse_allocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-42-67" name="__codelineno-42-67" href="#__codelineno-42-67"></a>                        <span class="n">Allocation</span><span class="p">(</span><span class="n">warehouse</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
<a id="__codelineno-42-68" name="__codelineno-42-68" href="#__codelineno-42-68"></a>                    <span class="p">)</span>
<a id="__codelineno-42-69" name="__codelineno-42-69" href="#__codelineno-42-69"></a>                    <span class="n">remaining_items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<a id="__codelineno-42-70" name="__codelineno-42-70" href="#__codelineno-42-70"></a>                <span class="k">elif</span> <span class="n">available</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-42-71" name="__codelineno-42-71" href="#__codelineno-42-71"></a>                    <span class="n">warehouse_allocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-42-72" name="__codelineno-42-72" href="#__codelineno-42-72"></a>                        <span class="n">Allocation</span><span class="p">(</span><span class="n">warehouse</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="p">,</span> <span class="n">available</span><span class="p">)</span>
<a id="__codelineno-42-73" name="__codelineno-42-73" href="#__codelineno-42-73"></a>                    <span class="p">)</span>
<a id="__codelineno-42-74" name="__codelineno-42-74" href="#__codelineno-42-74"></a>                    <span class="n">item</span><span class="o">.</span><span class="n">quantity</span> <span class="o">-=</span> <span class="n">available</span>
<a id="__codelineno-42-75" name="__codelineno-42-75" href="#__codelineno-42-75"></a>
<a id="__codelineno-42-76" name="__codelineno-42-76" href="#__codelineno-42-76"></a>            <span class="k">if</span> <span class="n">warehouse_allocations</span><span class="p">:</span>
<a id="__codelineno-42-77" name="__codelineno-42-77" href="#__codelineno-42-77"></a>                <span class="n">allocations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">warehouse_allocations</span><span class="p">)</span>
<a id="__codelineno-42-78" name="__codelineno-42-78" href="#__codelineno-42-78"></a>
<a id="__codelineno-42-79" name="__codelineno-42-79" href="#__codelineno-42-79"></a>        <span class="k">if</span> <span class="n">remaining_items</span><span class="p">:</span>
<a id="__codelineno-42-80" name="__codelineno-42-80" href="#__codelineno-42-80"></a>            <span class="k">raise</span> <span class="n">InsufficientInventoryException</span><span class="p">(</span><span class="n">remaining_items</span><span class="p">)</span>
<a id="__codelineno-42-81" name="__codelineno-42-81" href="#__codelineno-42-81"></a>
<a id="__codelineno-42-82" name="__codelineno-42-82" href="#__codelineno-42-82"></a>        <span class="k">return</span> <span class="n">AllocationResult</span><span class="p">(</span><span class="n">allocations</span><span class="p">)</span>
</code></pre></div>
<h3 id="domain-events"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#domain-events">Domain Events</a></h3>
<p>Domain events capture things that happen in the business domain. They enable loose coupling between aggregates and bounded contexts:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="nd">@dataclass</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">DomainEvent</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for domain events.&quot;&quot;&quot;</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>    <span class="n">occurred_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurred_at</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">occurred_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a>
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="nd">@dataclass</span>
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderPlaced</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span>
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>    <span class="n">total</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>
<a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a><span class="nd">@dataclass</span>
<a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">PaymentProcessed</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a>    <span class="n">payment_id</span><span class="p">:</span> <span class="n">PaymentId</span>
<a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span>
<a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a>    <span class="n">amount</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a>    <span class="n">payment_method</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a>
<a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a><span class="nd">@dataclass</span>
<a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">InventoryReserved</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span>
<a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a>    <span class="n">reservations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a>
<a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a><span class="nd">@dataclass</span>
<a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderShipped</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span>
<a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a>    <span class="n">tracking_number</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a>    <span class="n">carrier</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a>    <span class="n">estimated_delivery</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a>
<a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a><span class="c1"># Event handlers in different bounded contexts</span>
<a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a><span class="k">class</span><span class="w"> </span><span class="nc">InventoryEventHandler</span><span class="p">:</span>
<a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reserve inventory when order is placed.&quot;&quot;&quot;</span>
<a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a>        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a>
<a id="__codelineno-43-46" name="__codelineno-43-46" href="#__codelineno-43-46"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<a id="__codelineno-43-47" name="__codelineno-43-47" href="#__codelineno-43-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span>
<a id="__codelineno-43-48" name="__codelineno-43-48" href="#__codelineno-43-48"></a>                <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">sku</span><span class="p">,</span>
<a id="__codelineno-43-49" name="__codelineno-43-49" href="#__codelineno-43-49"></a>                <span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-43-50" name="__codelineno-43-50" href="#__codelineno-43-50"></a>                <span class="n">event</span><span class="o">.</span><span class="n">order_id</span>
<a id="__codelineno-43-51" name="__codelineno-43-51" href="#__codelineno-43-51"></a>            <span class="p">)</span>
<a id="__codelineno-43-52" name="__codelineno-43-52" href="#__codelineno-43-52"></a>
<a id="__codelineno-43-53" name="__codelineno-43-53" href="#__codelineno-43-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
<a id="__codelineno-43-54" name="__codelineno-43-54" href="#__codelineno-43-54"></a>            <span class="n">InventoryReserved</span><span class="p">(</span>
<a id="__codelineno-43-55" name="__codelineno-43-55" href="#__codelineno-43-55"></a>                <span class="n">order_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-43-56" name="__codelineno-43-56" href="#__codelineno-43-56"></a>                <span class="n">reservations</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<a id="__codelineno-43-57" name="__codelineno-43-57" href="#__codelineno-43-57"></a>            <span class="p">)</span>
<a id="__codelineno-43-58" name="__codelineno-43-58" href="#__codelineno-43-58"></a>        <span class="p">)</span>
<a id="__codelineno-43-59" name="__codelineno-43-59" href="#__codelineno-43-59"></a>
<a id="__codelineno-43-60" name="__codelineno-43-60" href="#__codelineno-43-60"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmailEventHandler</span><span class="p">:</span>
<a id="__codelineno-43-61" name="__codelineno-43-61" href="#__codelineno-43-61"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-43-62" name="__codelineno-43-62" href="#__codelineno-43-62"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Send confirmation email when order is placed.&quot;&quot;&quot;</span>
<a id="__codelineno-43-63" name="__codelineno-43-63" href="#__codelineno-43-63"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_repository</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-43-64" name="__codelineno-43-64" href="#__codelineno-43-64"></a>        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-43-65" name="__codelineno-43-65" href="#__codelineno-43-65"></a>
<a id="__codelineno-43-66" name="__codelineno-43-66" href="#__codelineno-43-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email_service</span><span class="o">.</span><span class="n">send_order_confirmation</span><span class="p">(</span>
<a id="__codelineno-43-67" name="__codelineno-43-67" href="#__codelineno-43-67"></a>            <span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-43-68" name="__codelineno-43-68" href="#__codelineno-43-68"></a>            <span class="n">order</span>
<a id="__codelineno-43-69" name="__codelineno-43-69" href="#__codelineno-43-69"></a>        <span class="p">)</span>
<a id="__codelineno-43-70" name="__codelineno-43-70" href="#__codelineno-43-70"></a>
<a id="__codelineno-43-71" name="__codelineno-43-71" href="#__codelineno-43-71"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_order_shipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderShipped</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-43-72" name="__codelineno-43-72" href="#__codelineno-43-72"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Send shipping notification.&quot;&quot;&quot;</span>
<a id="__codelineno-43-73" name="__codelineno-43-73" href="#__codelineno-43-73"></a>        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-43-74" name="__codelineno-43-74" href="#__codelineno-43-74"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_repository</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-43-75" name="__codelineno-43-75" href="#__codelineno-43-75"></a>
<a id="__codelineno-43-76" name="__codelineno-43-76" href="#__codelineno-43-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email_service</span><span class="o">.</span><span class="n">send_shipping_notification</span><span class="p">(</span>
<a id="__codelineno-43-77" name="__codelineno-43-77" href="#__codelineno-43-77"></a>            <span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-43-78" name="__codelineno-43-78" href="#__codelineno-43-78"></a>            <span class="n">event</span><span class="o">.</span><span class="n">tracking_number</span><span class="p">,</span>
<a id="__codelineno-43-79" name="__codelineno-43-79" href="#__codelineno-43-79"></a>            <span class="n">event</span><span class="o">.</span><span class="n">carrier</span><span class="p">,</span>
<a id="__codelineno-43-80" name="__codelineno-43-80" href="#__codelineno-43-80"></a>            <span class="n">event</span><span class="o">.</span><span class="n">estimated_delivery</span>
<a id="__codelineno-43-81" name="__codelineno-43-81" href="#__codelineno-43-81"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="implementing-ddd-in-python-projects"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#implementing-ddd-in-python-projects">Implementing DDD in Python Projects</a></h3>
<p>Here's how to structure a DDD Python project:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>src/
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>â”œâ”€â”€ shared_kernel/          # Shared value objects and utilities
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>â”‚   â”œâ”€â”€ __init__.py
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>â”‚   â”œâ”€â”€ money.py
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>â”‚   â”œâ”€â”€ address.py
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>â”‚   â””â”€â”€ identifiers.py
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>â”‚
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>â”œâ”€â”€ catalog/                # Catalog bounded context
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>â”‚   â”œâ”€â”€ domain/
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>â”‚   â”‚   â”œâ”€â”€ product.py
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>â”‚   â”‚   â”œâ”€â”€ category.py
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>â”‚   â”‚   â””â”€â”€ events.py
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>â”‚   â”œâ”€â”€ application/
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>â”‚   â”‚   â””â”€â”€ services.py
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>â”‚   â””â”€â”€ infrastructure/
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>â”‚       â””â”€â”€ repositories.py
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>â”‚
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>â”œâ”€â”€ ordering/               # Ordering bounded context
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>â”‚   â”œâ”€â”€ domain/
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>â”‚   â”‚   â”œâ”€â”€ order.py
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>â”‚   â”‚   â”œâ”€â”€ customer.py
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>â”‚   â”‚   â””â”€â”€ events.py
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>â”‚   â”œâ”€â”€ application/
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>â”‚   â”‚   â””â”€â”€ services.py
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>â”‚   â””â”€â”€ infrastructure/
<a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>â”‚       â””â”€â”€ repositories.py
<a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a>â”‚
<a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>â””â”€â”€ inventory/              # Inventory bounded context
<a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a>    â”œâ”€â”€ domain/
<a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>    â”‚   â”œâ”€â”€ warehouse.py
<a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a>    â”‚   â”œâ”€â”€ stock.py
<a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a>    â”‚   â””â”€â”€ events.py
<a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>    â”œâ”€â”€ application/
<a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a>    â”‚   â””â”€â”€ services.py
<a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a>    â””â”€â”€ infrastructure/
<a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>        â””â”€â”€ repositories.py
</code></pre></div>
<h3 id="common-ddd-pitfalls-in-python"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#common-ddd-pitfalls-in-python">Common DDD Pitfalls in Python</a></h3>
<ol>
<li><strong>Over-using inheritance</strong>: Favor composition over inheritance</li>
<li><strong>Anemic models</strong>: Don't separate data from behavior</li>
<li><strong>Large aggregates</strong>: Keep aggregates small and focused</li>
<li><strong>Ignoring bounded contexts</strong>: Don't try to create one model for everything</li>
<li><strong>Direct aggregate references</strong>: Reference by ID, not object reference</li>
<li><strong>Skipping value objects</strong>: Use value objects for concepts without identity</li>
</ol>
<h3 id="conclusion"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#conclusion">Conclusion</a></h3>
<p>Domain-Driven Design isn't about following rigid rules or copying Java patterns. It's about creating code that reflects your business domain accurately. Python's flexibility makes it an excellent language for DDDâ€”dataclasses for value objects, ABC for interfaces, type hints for clarity.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> shows these patterns in action. Study how the domain layer captures business logic, how aggregates maintain consistency, and how events enable communication between bounded contexts.</p>
<p>In the next post, we'll explore Clean Architecture, showing how to organize these domain models into a maintainable, testable application structure. We'll see how DDD and Clean Architecture complement each other to create robust, business-focused applications.</p>
<p>Remember: The goal isn't to use every DDD pattern. It's to model your domain in a way that makes the complex simple and the implicit explicit.</p>
<h3 id="references"><a class="toclink" href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - DDD patterns in Python</li>
<li><a href="https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215">Domain-Driven Design by Eric Evans</a> - The original DDD book</li>
<li><a href="https://docs.python.org/3/library/dataclasses.html">Python Dataclasses</a> - Perfect for value objects</li>
<li><a href="https://www.amazon.com/Implementing-Domain-Driven-Design-Vaughn-Vernon/dp/0321834577">Implementing DDD by Vaughn Vernon</a> - Practical DDD guidance</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-05-25 20:30:00-04:00">May 25, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../" class="md-meta__link">Python</a>, 
              <a href="../../../project-setup/" class="md-meta__link">Project Setup</a>, 
              <a href="../../../development-workflow/" class="md-meta__link">Development Workflow</a></li>
        
        
          
          <li class="md-meta__item">
            
              9 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="setting-up-a-python-project-like-a-pro-beyond-requirementstxt"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/">Setting Up a Python Project Like a Pro: Beyond requirements.txt</a></h2>
<p>The difference between a hobby project and a production-ready application often comes down to the boring stuff: project setup, dependency management, and development workflows. I've seen too many Python projects fail not because of bad code, but because of poor project infrastructure.</p>
<p>When I review Python projects, I can immediately tell which ones will scale and which ones will become maintenance nightmares. The secret isn't in the application codeâ€”it's in the foundation. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates what a professional Python setup looks like in practice.</p>
<p>Let's build a Python project setup that your future self will thank you for.</p>
<h3 id="the-problem-with-traditional-python-setup"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#the-problem-with-traditional-python-setup">The Problem with Traditional Python Setup</a></h3>
<p>Most Python tutorials teach you to create a <code>requirements.txt</code> file and call it a day. This approach works for simple scripts, but it falls apart quickly in real projects:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="c1"># The traditional way</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>pip<span class="w"> </span>install<span class="w"> </span>flask<span class="w"> </span>sqlalchemy<span class="w"> </span>pytest
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>pip<span class="w"> </span>freeze<span class="w"> </span>&gt;<span class="w"> </span>requirements.txt
</code></pre></div>
<p>This creates several problems:
- No separation between development and production dependencies
- Version conflicts between projects on the same machine
- Dependency resolution happens at install time, not declaration time
- No metadata about the project itself
- No standard way to run common tasks</p>
<p>I once inherited a project with a 200-line <code>requirements.txt</code> file. Nobody knew which dependencies were actually needed. Updating any package was a game of Russian roulette. The development setup instructions were a 3-page Word document that was always out of date.</p>
<h3 id="modern-python-project-structure"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#modern-python-project-structure">Modern Python Project Structure</a></h3>
<p>Here's what a professional Python project structure looks like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>clean-py/
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>â”œâ”€â”€ src/
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>â”‚   â””â”€â”€ clean_py/
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>â”‚       â”œâ”€â”€ __init__.py
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>â”‚       â”œâ”€â”€ domain/
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>â”‚       â”œâ”€â”€ application/
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>â”‚       â”œâ”€â”€ infrastructure/
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>â”‚       â””â”€â”€ presentation/
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>â”œâ”€â”€ tests/
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>â”‚   â”œâ”€â”€ unit/
<a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>â”‚   â”œâ”€â”€ integration/
<a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>â”‚   â””â”€â”€ e2e/
<a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a>â”œâ”€â”€ docs/
<a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>â”œâ”€â”€ scripts/
<a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a>â”œâ”€â”€ .github/
<a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a>â”‚   â””â”€â”€ workflows/
<a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a>â”œâ”€â”€ pyproject.toml
<a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a>â”œâ”€â”€ Makefile
<a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a>â”œâ”€â”€ .pre-commit-config.yaml
<a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a>â”œâ”€â”€ .gitignore
<a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a>â”œâ”€â”€ .env.example
<a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a>â””â”€â”€ README.md
</code></pre></div>
<p>Each component serves a specific purpose. Let's explore the critical ones.</p>
<h3 id="pyprojecttoml-the-modern-way"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#pyprojecttoml-the-modern-way">pyproject.toml: The Modern Way</a></h3>
<p>The <code>pyproject.toml</code> file is Python's answer to <code>package.json</code> in Node.js or <code>Cargo.toml</code> in Rust. It centralizes project configuration, dependencies, and metadata:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="k">[build-system]</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="n">requires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;setuptools&gt;=68.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;wheel&quot;</span><span class="p">]</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="n">build-backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;setuptools.build_meta&quot;</span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a><span class="k">[project]</span>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;clean-py&quot;</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Production-ready Python microservice with Clean Architecture&quot;</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a><span class="n">readme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;README.md&quot;</span>
<a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a><span class="n">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=3.11&quot;</span>
<a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a><span class="n">license</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">text</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;MIT&quot;</span><span class="p">}</span>
<a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a><span class="n">authors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[{</span><span class="n">name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;Your Name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;you@example.com&quot;</span><span class="p">}]</span>
<a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a><span class="n">keywords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;clean-architecture&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ddd&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;microservice&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;fastapi&quot;</span><span class="p">]</span>
<a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a><span class="n">classifiers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a><span class="w">    </span><span class="s2">&quot;Development Status :: 4 - Beta&quot;</span><span class="p">,</span>
<a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a><span class="w">    </span><span class="s2">&quot;Intended Audience :: Developers&quot;</span><span class="p">,</span>
<a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a><span class="w">    </span><span class="s2">&quot;License :: OSI Approved :: MIT License&quot;</span><span class="p">,</span>
<a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a><span class="w">    </span><span class="s2">&quot;Programming Language :: Python :: 3.11&quot;</span><span class="p">,</span>
<a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a><span class="w">    </span><span class="s2">&quot;Programming Language :: Python :: 3.12&quot;</span><span class="p">,</span>
<a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a><span class="p">]</span>
<a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a>
<a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a><span class="w">    </span><span class="s2">&quot;fastapi&gt;=0.104.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a><span class="w">    </span><span class="s2">&quot;uvicorn[standard]&gt;=0.24.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a><span class="w">    </span><span class="s2">&quot;sqlalchemy&gt;=2.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a><span class="w">    </span><span class="s2">&quot;asyncpg&gt;=0.29.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a><span class="w">    </span><span class="s2">&quot;pydantic&gt;=2.5.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a><span class="w">    </span><span class="s2">&quot;pydantic-settings&gt;=2.1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a><span class="w">    </span><span class="s2">&quot;python-jose[cryptography]&gt;=3.3.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-30" name="__codelineno-74-30" href="#__codelineno-74-30"></a><span class="w">    </span><span class="s2">&quot;passlib[bcrypt]&gt;=1.7.4&quot;</span><span class="p">,</span>
<a id="__codelineno-74-31" name="__codelineno-74-31" href="#__codelineno-74-31"></a><span class="w">    </span><span class="s2">&quot;python-multipart&gt;=0.0.6&quot;</span><span class="p">,</span>
<a id="__codelineno-74-32" name="__codelineno-74-32" href="#__codelineno-74-32"></a><span class="w">    </span><span class="s2">&quot;httpx&gt;=0.25.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-33" name="__codelineno-74-33" href="#__codelineno-74-33"></a><span class="w">    </span><span class="s2">&quot;redis&gt;=5.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-34" name="__codelineno-74-34" href="#__codelineno-74-34"></a><span class="w">    </span><span class="s2">&quot;structlog&gt;=23.2.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-35" name="__codelineno-74-35" href="#__codelineno-74-35"></a><span class="w">    </span><span class="s2">&quot;python-json-logger&gt;=2.0.7&quot;</span><span class="p">,</span>
<a id="__codelineno-74-36" name="__codelineno-74-36" href="#__codelineno-74-36"></a><span class="p">]</span>
<a id="__codelineno-74-37" name="__codelineno-74-37" href="#__codelineno-74-37"></a>
<a id="__codelineno-74-38" name="__codelineno-74-38" href="#__codelineno-74-38"></a><span class="k">[project.optional-dependencies]</span>
<a id="__codelineno-74-39" name="__codelineno-74-39" href="#__codelineno-74-39"></a><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-74-40" name="__codelineno-74-40" href="#__codelineno-74-40"></a><span class="w">    </span><span class="s2">&quot;pytest&gt;=7.4.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-41" name="__codelineno-74-41" href="#__codelineno-74-41"></a><span class="w">    </span><span class="s2">&quot;pytest-asyncio&gt;=0.21.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-42" name="__codelineno-74-42" href="#__codelineno-74-42"></a><span class="w">    </span><span class="s2">&quot;pytest-cov&gt;=4.1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-43" name="__codelineno-74-43" href="#__codelineno-74-43"></a><span class="w">    </span><span class="s2">&quot;pytest-env&gt;=1.1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-44" name="__codelineno-74-44" href="#__codelineno-74-44"></a><span class="w">    </span><span class="s2">&quot;pytest-mock&gt;=3.12.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-45" name="__codelineno-74-45" href="#__codelineno-74-45"></a><span class="w">    </span><span class="s2">&quot;black&gt;=23.11.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-46" name="__codelineno-74-46" href="#__codelineno-74-46"></a><span class="w">    </span><span class="s2">&quot;ruff&gt;=0.1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-47" name="__codelineno-74-47" href="#__codelineno-74-47"></a><span class="w">    </span><span class="s2">&quot;mypy&gt;=1.7.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-48" name="__codelineno-74-48" href="#__codelineno-74-48"></a><span class="w">    </span><span class="s2">&quot;pre-commit&gt;=3.5.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-49" name="__codelineno-74-49" href="#__codelineno-74-49"></a><span class="w">    </span><span class="s2">&quot;ipython&gt;=8.17.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-50" name="__codelineno-74-50" href="#__codelineno-74-50"></a><span class="w">    </span><span class="s2">&quot;ipdb&gt;=0.13.13&quot;</span><span class="p">,</span>
<a id="__codelineno-74-51" name="__codelineno-74-51" href="#__codelineno-74-51"></a><span class="w">    </span><span class="s2">&quot;factory-boy&gt;=3.3.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-52" name="__codelineno-74-52" href="#__codelineno-74-52"></a><span class="w">    </span><span class="s2">&quot;faker&gt;=20.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-53" name="__codelineno-74-53" href="#__codelineno-74-53"></a><span class="p">]</span>
<a id="__codelineno-74-54" name="__codelineno-74-54" href="#__codelineno-74-54"></a>
<a id="__codelineno-74-55" name="__codelineno-74-55" href="#__codelineno-74-55"></a><span class="n">aws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-74-56" name="__codelineno-74-56" href="#__codelineno-74-56"></a><span class="w">    </span><span class="s2">&quot;boto3&gt;=1.29.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-57" name="__codelineno-74-57" href="#__codelineno-74-57"></a><span class="w">    </span><span class="s2">&quot;watchtower&gt;=3.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-74-58" name="__codelineno-74-58" href="#__codelineno-74-58"></a><span class="p">]</span>
<a id="__codelineno-74-59" name="__codelineno-74-59" href="#__codelineno-74-59"></a>
<a id="__codelineno-74-60" name="__codelineno-74-60" href="#__codelineno-74-60"></a><span class="k">[project.urls]</span>
<a id="__codelineno-74-61" name="__codelineno-74-61" href="#__codelineno-74-61"></a><span class="n">Homepage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://github.com/buildshift-dev/clean-py&quot;</span>
<a id="__codelineno-74-62" name="__codelineno-74-62" href="#__codelineno-74-62"></a><span class="n">Documentation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://github.com/buildshift-dev/clean-py/docs&quot;</span>
<a id="__codelineno-74-63" name="__codelineno-74-63" href="#__codelineno-74-63"></a><span class="n">Repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://github.com/buildshift-dev/clean-py&quot;</span>
<a id="__codelineno-74-64" name="__codelineno-74-64" href="#__codelineno-74-64"></a><span class="n">Issues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://github.com/buildshift-dev/clean-py/issues&quot;</span>
<a id="__codelineno-74-65" name="__codelineno-74-65" href="#__codelineno-74-65"></a>
<a id="__codelineno-74-66" name="__codelineno-74-66" href="#__codelineno-74-66"></a><span class="k">[tool.setuptools.packages.find]</span>
<a id="__codelineno-74-67" name="__codelineno-74-67" href="#__codelineno-74-67"></a><span class="n">where</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span>
<a id="__codelineno-74-68" name="__codelineno-74-68" href="#__codelineno-74-68"></a>
<a id="__codelineno-74-69" name="__codelineno-74-69" href="#__codelineno-74-69"></a><span class="k">[tool.setuptools.package-data]</span>
<a id="__codelineno-74-70" name="__codelineno-74-70" href="#__codelineno-74-70"></a><span class="s2">&quot;*&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*.yaml&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*.yml&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*.json&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*.txt&quot;</span><span class="p">]</span>
<a id="__codelineno-74-71" name="__codelineno-74-71" href="#__codelineno-74-71"></a>
<a id="__codelineno-74-72" name="__codelineno-74-72" href="#__codelineno-74-72"></a><span class="k">[tool.black]</span>
<a id="__codelineno-74-73" name="__codelineno-74-73" href="#__codelineno-74-73"></a><span class="n">line-length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">88</span>
<a id="__codelineno-74-74" name="__codelineno-74-74" href="#__codelineno-74-74"></a><span class="n">target-version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;py311&#39;</span><span class="p">]</span>
<a id="__codelineno-74-75" name="__codelineno-74-75" href="#__codelineno-74-75"></a><span class="n">include</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;\.pyi?$&#39;</span>
<a id="__codelineno-74-76" name="__codelineno-74-76" href="#__codelineno-74-76"></a>
<a id="__codelineno-74-77" name="__codelineno-74-77" href="#__codelineno-74-77"></a><span class="k">[tool.ruff]</span>
<a id="__codelineno-74-78" name="__codelineno-74-78" href="#__codelineno-74-78"></a><span class="n">target-version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;py311&quot;</span>
<a id="__codelineno-74-79" name="__codelineno-74-79" href="#__codelineno-74-79"></a><span class="n">line-length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">88</span>
<a id="__codelineno-74-80" name="__codelineno-74-80" href="#__codelineno-74-80"></a><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-74-81" name="__codelineno-74-81" href="#__codelineno-74-81"></a><span class="w">    </span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># pycodestyle errors</span>
<a id="__codelineno-74-82" name="__codelineno-74-82" href="#__codelineno-74-82"></a><span class="w">    </span><span class="s2">&quot;W&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># pycodestyle warnings</span>
<a id="__codelineno-74-83" name="__codelineno-74-83" href="#__codelineno-74-83"></a><span class="w">    </span><span class="s2">&quot;F&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># pyflakes</span>
<a id="__codelineno-74-84" name="__codelineno-74-84" href="#__codelineno-74-84"></a><span class="w">    </span><span class="s2">&quot;I&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># isort</span>
<a id="__codelineno-74-85" name="__codelineno-74-85" href="#__codelineno-74-85"></a><span class="w">    </span><span class="s2">&quot;B&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># flake8-bugbear</span>
<a id="__codelineno-74-86" name="__codelineno-74-86" href="#__codelineno-74-86"></a><span class="w">    </span><span class="s2">&quot;C4&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># flake8-comprehensions</span>
<a id="__codelineno-74-87" name="__codelineno-74-87" href="#__codelineno-74-87"></a><span class="w">    </span><span class="s2">&quot;UP&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># pyupgrade</span>
<a id="__codelineno-74-88" name="__codelineno-74-88" href="#__codelineno-74-88"></a><span class="w">    </span><span class="s2">&quot;ARG&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># flake8-unused-arguments</span>
<a id="__codelineno-74-89" name="__codelineno-74-89" href="#__codelineno-74-89"></a><span class="w">    </span><span class="s2">&quot;SIM&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># flake8-simplify</span>
<a id="__codelineno-74-90" name="__codelineno-74-90" href="#__codelineno-74-90"></a><span class="p">]</span>
<a id="__codelineno-74-91" name="__codelineno-74-91" href="#__codelineno-74-91"></a><span class="n">ignore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-74-92" name="__codelineno-74-92" href="#__codelineno-74-92"></a><span class="w">    </span><span class="s2">&quot;E501&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># line too long (handled by black)</span>
<a id="__codelineno-74-93" name="__codelineno-74-93" href="#__codelineno-74-93"></a><span class="w">    </span><span class="s2">&quot;B008&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># do not perform function calls in argument defaults</span>
<a id="__codelineno-74-94" name="__codelineno-74-94" href="#__codelineno-74-94"></a><span class="w">    </span><span class="s2">&quot;C901&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># too complex</span>
<a id="__codelineno-74-95" name="__codelineno-74-95" href="#__codelineno-74-95"></a><span class="p">]</span>
<a id="__codelineno-74-96" name="__codelineno-74-96" href="#__codelineno-74-96"></a>
<a id="__codelineno-74-97" name="__codelineno-74-97" href="#__codelineno-74-97"></a><span class="k">[tool.mypy]</span>
<a id="__codelineno-74-98" name="__codelineno-74-98" href="#__codelineno-74-98"></a><span class="n">python_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;3.11&quot;</span>
<a id="__codelineno-74-99" name="__codelineno-74-99" href="#__codelineno-74-99"></a><span class="n">warn_return_any</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-74-100" name="__codelineno-74-100" href="#__codelineno-74-100"></a><span class="n">warn_unused_configs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-74-101" name="__codelineno-74-101" href="#__codelineno-74-101"></a><span class="n">disallow_untyped_defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-74-102" name="__codelineno-74-102" href="#__codelineno-74-102"></a><span class="n">disallow_any_unimported</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<a id="__codelineno-74-103" name="__codelineno-74-103" href="#__codelineno-74-103"></a><span class="n">no_implicit_optional</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-74-104" name="__codelineno-74-104" href="#__codelineno-74-104"></a><span class="n">check_untyped_defs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-74-105" name="__codelineno-74-105" href="#__codelineno-74-105"></a><span class="n">show_error_codes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-74-106" name="__codelineno-74-106" href="#__codelineno-74-106"></a><span class="n">warn_unused_ignores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<a id="__codelineno-74-107" name="__codelineno-74-107" href="#__codelineno-74-107"></a>
<a id="__codelineno-74-108" name="__codelineno-74-108" href="#__codelineno-74-108"></a><span class="k">[tool.pytest.ini_options]</span>
<a id="__codelineno-74-109" name="__codelineno-74-109" href="#__codelineno-74-109"></a><span class="n">minversion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;7.0&quot;</span>
<a id="__codelineno-74-110" name="__codelineno-74-110" href="#__codelineno-74-110"></a><span class="n">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;tests&quot;</span><span class="p">]</span>
<a id="__codelineno-74-111" name="__codelineno-74-111" href="#__codelineno-74-111"></a><span class="n">python_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;test_*.py&quot;</span>
<a id="__codelineno-74-112" name="__codelineno-74-112" href="#__codelineno-74-112"></a><span class="n">python_classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Test*&quot;</span>
<a id="__codelineno-74-113" name="__codelineno-74-113" href="#__codelineno-74-113"></a><span class="n">python_functions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;test_*&quot;</span>
<a id="__codelineno-74-114" name="__codelineno-74-114" href="#__codelineno-74-114"></a><span class="n">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-115" name="__codelineno-74-115" href="#__codelineno-74-115"></a><span class="s2">    --strict-markers</span>
<a id="__codelineno-74-116" name="__codelineno-74-116" href="#__codelineno-74-116"></a><span class="s2">    --tb=short</span>
<a id="__codelineno-74-117" name="__codelineno-74-117" href="#__codelineno-74-117"></a><span class="s2">    --cov=src</span>
<a id="__codelineno-74-118" name="__codelineno-74-118" href="#__codelineno-74-118"></a><span class="s2">    --cov-branch</span>
<a id="__codelineno-74-119" name="__codelineno-74-119" href="#__codelineno-74-119"></a><span class="s2">    --cov-report=term-missing</span>
<a id="__codelineno-74-120" name="__codelineno-74-120" href="#__codelineno-74-120"></a><span class="s2">    --cov-report=html</span>
<a id="__codelineno-74-121" name="__codelineno-74-121" href="#__codelineno-74-121"></a><span class="s2">    --cov-report=xml</span>
<a id="__codelineno-74-122" name="__codelineno-74-122" href="#__codelineno-74-122"></a><span class="s2">    --no-cov-on-fail</span>
<a id="__codelineno-74-123" name="__codelineno-74-123" href="#__codelineno-74-123"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-74-124" name="__codelineno-74-124" href="#__codelineno-74-124"></a><span class="n">asyncio_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
<a id="__codelineno-74-125" name="__codelineno-74-125" href="#__codelineno-74-125"></a>
<a id="__codelineno-74-126" name="__codelineno-74-126" href="#__codelineno-74-126"></a><span class="k">[tool.coverage.run]</span>
<a id="__codelineno-74-127" name="__codelineno-74-127" href="#__codelineno-74-127"></a><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span>
<a id="__codelineno-74-128" name="__codelineno-74-128" href="#__codelineno-74-128"></a><span class="n">omit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*/tests/*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*/test_*.py&quot;</span><span class="p">]</span>
<a id="__codelineno-74-129" name="__codelineno-74-129" href="#__codelineno-74-129"></a>
<a id="__codelineno-74-130" name="__codelineno-74-130" href="#__codelineno-74-130"></a><span class="k">[tool.coverage.report]</span>
<a id="__codelineno-74-131" name="__codelineno-74-131" href="#__codelineno-74-131"></a><span class="n">exclude_lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-74-132" name="__codelineno-74-132" href="#__codelineno-74-132"></a><span class="w">    </span><span class="s2">&quot;pragma: no cover&quot;</span><span class="p">,</span>
<a id="__codelineno-74-133" name="__codelineno-74-133" href="#__codelineno-74-133"></a><span class="w">    </span><span class="s2">&quot;def __repr__&quot;</span><span class="p">,</span>
<a id="__codelineno-74-134" name="__codelineno-74-134" href="#__codelineno-74-134"></a><span class="w">    </span><span class="s2">&quot;raise AssertionError&quot;</span><span class="p">,</span>
<a id="__codelineno-74-135" name="__codelineno-74-135" href="#__codelineno-74-135"></a><span class="w">    </span><span class="s2">&quot;raise NotImplementedError&quot;</span><span class="p">,</span>
<a id="__codelineno-74-136" name="__codelineno-74-136" href="#__codelineno-74-136"></a><span class="w">    </span><span class="s2">&quot;if __name__ == .__main__.:&quot;</span><span class="p">,</span>
<a id="__codelineno-74-137" name="__codelineno-74-137" href="#__codelineno-74-137"></a><span class="w">    </span><span class="s2">&quot;if TYPE_CHECKING:&quot;</span><span class="p">,</span>
<a id="__codelineno-74-138" name="__codelineno-74-138" href="#__codelineno-74-138"></a><span class="p">]</span>
</code></pre></div>
<p>This single file replaces multiple configuration files and provides:
- Project metadata and description
- Production and development dependencies
- Tool configurations (Black, Ruff, MyPy, Pytest, Coverage)
- Build system configuration</p>
<h3 id="makefile-cross-platform-task-automation"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#makefile-cross-platform-task-automation">Makefile: Cross-Platform Task Automation</a></h3>
<p>While Python has various task runners, Make remains the most universal. Here's a production-ready Makefile:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">help</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="nf">help</span><span class="o">:</span><span class="w"> </span><span class="c">## Show this help message</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="w">    </span>@echo<span class="w"> </span><span class="s2">&quot;Usage: make [target]&quot;</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="w">    </span>@echo<span class="w"> </span><span class="s2">&quot;&quot;</span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="w">    </span>@echo<span class="w"> </span><span class="s2">&quot;Available targets:&quot;</span>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="w">    </span>@grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;^[a-zA-Z_-]+:.*?## .*$$&#39;</span><span class="w"> </span><span class="k">$(</span>MAKEFILE_LIST<span class="k">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;BEGIN {FS = &quot;:.*?## &quot;}; {printf &quot;  %-20s %s\n&quot;, $$1, $$2}&#39;</span>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">install</span>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="nf">install</span><span class="o">:</span><span class="w"> </span><span class="c">## Install project in development mode</span>
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="w">    </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[dev]&quot;</span>
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="w">    </span>pre-commit<span class="w"> </span>install
<a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>
<a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">install</span>-<span class="n">prod</span>
<a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a><span class="nf">install-prod</span><span class="o">:</span><span class="w"> </span><span class="c">## Install production dependencies only</span>
<a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a><span class="w">    </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
<a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a>
<a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">update</span>
<a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a><span class="nf">update</span><span class="o">:</span><span class="w"> </span><span class="c">## Update dependencies to latest versions</span>
<a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a><span class="w">    </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip<span class="w"> </span>setuptools<span class="w"> </span>wheel
<a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a><span class="w">    </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[dev]&quot;</span>
<a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a>
<a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">format</span>
<a id="__codelineno-75-23" name="__codelineno-75-23" href="#__codelineno-75-23"></a><span class="nf">format</span><span class="o">:</span><span class="w"> </span><span class="c">## Format code with black and ruff</span>
<a id="__codelineno-75-24" name="__codelineno-75-24" href="#__codelineno-75-24"></a><span class="w">    </span>black<span class="w"> </span>src<span class="w"> </span>tests
<a id="__codelineno-75-25" name="__codelineno-75-25" href="#__codelineno-75-25"></a><span class="w">    </span>ruff<span class="w"> </span>check<span class="w"> </span>--fix<span class="w"> </span>src<span class="w"> </span>tests
<a id="__codelineno-75-26" name="__codelineno-75-26" href="#__codelineno-75-26"></a>
<a id="__codelineno-75-27" name="__codelineno-75-27" href="#__codelineno-75-27"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">lint</span>
<a id="__codelineno-75-28" name="__codelineno-75-28" href="#__codelineno-75-28"></a><span class="nf">lint</span><span class="o">:</span><span class="w"> </span><span class="c">## Run all linting checks</span>
<a id="__codelineno-75-29" name="__codelineno-75-29" href="#__codelineno-75-29"></a><span class="w">    </span>black<span class="w"> </span>--check<span class="w"> </span>src<span class="w"> </span>tests
<a id="__codelineno-75-30" name="__codelineno-75-30" href="#__codelineno-75-30"></a><span class="w">    </span>ruff<span class="w"> </span>check<span class="w"> </span>src<span class="w"> </span>tests
<a id="__codelineno-75-31" name="__codelineno-75-31" href="#__codelineno-75-31"></a><span class="w">    </span>mypy<span class="w"> </span>src
<a id="__codelineno-75-32" name="__codelineno-75-32" href="#__codelineno-75-32"></a>
<a id="__codelineno-75-33" name="__codelineno-75-33" href="#__codelineno-75-33"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">test</span>
<a id="__codelineno-75-34" name="__codelineno-75-34" href="#__codelineno-75-34"></a><span class="nf">test</span><span class="o">:</span><span class="w"> </span><span class="c">## Run unit tests</span>
<a id="__codelineno-75-35" name="__codelineno-75-35" href="#__codelineno-75-35"></a><span class="w">    </span>pytest<span class="w"> </span>tests/unit<span class="w"> </span>-v
<a id="__codelineno-75-36" name="__codelineno-75-36" href="#__codelineno-75-36"></a>
<a id="__codelineno-75-37" name="__codelineno-75-37" href="#__codelineno-75-37"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">test</span>-<span class="n">integration</span>
<a id="__codelineno-75-38" name="__codelineno-75-38" href="#__codelineno-75-38"></a><span class="nf">test-integration</span><span class="o">:</span><span class="w"> </span><span class="c">## Run integration tests</span>
<a id="__codelineno-75-39" name="__codelineno-75-39" href="#__codelineno-75-39"></a><span class="w">    </span>pytest<span class="w"> </span>tests/integration<span class="w"> </span>-v
<a id="__codelineno-75-40" name="__codelineno-75-40" href="#__codelineno-75-40"></a>
<a id="__codelineno-75-41" name="__codelineno-75-41" href="#__codelineno-75-41"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">test</span>-<span class="n">all</span>
<a id="__codelineno-75-42" name="__codelineno-75-42" href="#__codelineno-75-42"></a><span class="nf">test-all</span><span class="o">:</span><span class="w"> </span><span class="c">## Run all tests with coverage</span>
<a id="__codelineno-75-43" name="__codelineno-75-43" href="#__codelineno-75-43"></a><span class="w">    </span>pytest<span class="w"> </span>tests<span class="w"> </span>-v<span class="w"> </span>--cov<span class="o">=</span>src<span class="w"> </span>--cov-report<span class="o">=</span>term-missing
<a id="__codelineno-75-44" name="__codelineno-75-44" href="#__codelineno-75-44"></a>
<a id="__codelineno-75-45" name="__codelineno-75-45" href="#__codelineno-75-45"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">test</span>-<span class="n">watch</span>
<a id="__codelineno-75-46" name="__codelineno-75-46" href="#__codelineno-75-46"></a><span class="nf">test-watch</span><span class="o">:</span><span class="w"> </span><span class="c">## Run tests in watch mode</span>
<a id="__codelineno-75-47" name="__codelineno-75-47" href="#__codelineno-75-47"></a><span class="w">    </span>ptw<span class="w"> </span>tests<span class="w"> </span>--<span class="w"> </span>-v
<a id="__codelineno-75-48" name="__codelineno-75-48" href="#__codelineno-75-48"></a>
<a id="__codelineno-75-49" name="__codelineno-75-49" href="#__codelineno-75-49"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">clean</span>
<a id="__codelineno-75-50" name="__codelineno-75-50" href="#__codelineno-75-50"></a><span class="nf">clean</span><span class="o">:</span><span class="w"> </span><span class="c">## Clean up generated files</span>
<a id="__codelineno-75-51" name="__codelineno-75-51" href="#__codelineno-75-51"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>dist<span class="w"> </span>build<span class="w"> </span>*.egg-info
<a id="__codelineno-75-52" name="__codelineno-75-52" href="#__codelineno-75-52"></a><span class="w">    </span>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-name<span class="w"> </span>__pycache__<span class="w"> </span>-exec<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span><span class="o">{}</span><span class="w"> </span>+
<a id="__codelineno-75-53" name="__codelineno-75-53" href="#__codelineno-75-53"></a><span class="w">    </span>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.pyc&quot;</span><span class="w"> </span>-delete
<a id="__codelineno-75-54" name="__codelineno-75-54" href="#__codelineno-75-54"></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>.coverage<span class="w"> </span>htmlcov<span class="w"> </span>.pytest_cache<span class="w"> </span>.mypy_cache<span class="w"> </span>.ruff_cache
<a id="__codelineno-75-55" name="__codelineno-75-55" href="#__codelineno-75-55"></a>
<a id="__codelineno-75-56" name="__codelineno-75-56" href="#__codelineno-75-56"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">build</span>
<a id="__codelineno-75-57" name="__codelineno-75-57" href="#__codelineno-75-57"></a><span class="nf">build</span><span class="o">:</span><span class="w"> </span><span class="n">clean</span> <span class="c">## Build distribution packages</span>
<a id="__codelineno-75-58" name="__codelineno-75-58" href="#__codelineno-75-58"></a><span class="w">    </span>python<span class="w"> </span>-m<span class="w"> </span>build
<a id="__codelineno-75-59" name="__codelineno-75-59" href="#__codelineno-75-59"></a>
<a id="__codelineno-75-60" name="__codelineno-75-60" href="#__codelineno-75-60"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">docker</span>-<span class="n">build</span>
<a id="__codelineno-75-61" name="__codelineno-75-61" href="#__codelineno-75-61"></a><span class="nf">docker-build</span><span class="o">:</span><span class="w"> </span><span class="c">## Build Docker image</span>
<a id="__codelineno-75-62" name="__codelineno-75-62" href="#__codelineno-75-62"></a><span class="w">    </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>clean-py:latest<span class="w"> </span>.
<a id="__codelineno-75-63" name="__codelineno-75-63" href="#__codelineno-75-63"></a>
<a id="__codelineno-75-64" name="__codelineno-75-64" href="#__codelineno-75-64"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">docker</span>-<span class="n">run</span>
<a id="__codelineno-75-65" name="__codelineno-75-65" href="#__codelineno-75-65"></a><span class="nf">docker-run</span><span class="o">:</span><span class="w"> </span><span class="c">## Run application in Docker</span>
<a id="__codelineno-75-66" name="__codelineno-75-66" href="#__codelineno-75-66"></a><span class="w">    </span>docker-compose<span class="w"> </span>up
<a id="__codelineno-75-67" name="__codelineno-75-67" href="#__codelineno-75-67"></a>
<a id="__codelineno-75-68" name="__codelineno-75-68" href="#__codelineno-75-68"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">db</span>-<span class="n">upgrade</span>
<a id="__codelineno-75-69" name="__codelineno-75-69" href="#__codelineno-75-69"></a><span class="nf">db-upgrade</span><span class="o">:</span><span class="w"> </span><span class="c">## Apply database migrations</span>
<a id="__codelineno-75-70" name="__codelineno-75-70" href="#__codelineno-75-70"></a><span class="w">    </span>alembic<span class="w"> </span>upgrade<span class="w"> </span>head
<a id="__codelineno-75-71" name="__codelineno-75-71" href="#__codelineno-75-71"></a>
<a id="__codelineno-75-72" name="__codelineno-75-72" href="#__codelineno-75-72"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">db</span>-<span class="n">migrate</span>
<a id="__codelineno-75-73" name="__codelineno-75-73" href="#__codelineno-75-73"></a><span class="nf">db-migrate</span><span class="o">:</span><span class="w"> </span><span class="c">## Create new migration</span>
<a id="__codelineno-75-74" name="__codelineno-75-74" href="#__codelineno-75-74"></a><span class="w">    </span>alembic<span class="w"> </span>revision<span class="w"> </span>--autogenerate<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>message<span class="k">)</span><span class="s2">&quot;</span>
<a id="__codelineno-75-75" name="__codelineno-75-75" href="#__codelineno-75-75"></a>
<a id="__codelineno-75-76" name="__codelineno-75-76" href="#__codelineno-75-76"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">run</span>
<a id="__codelineno-75-77" name="__codelineno-75-77" href="#__codelineno-75-77"></a><span class="nf">run</span><span class="o">:</span><span class="w"> </span><span class="c">## Run the application locally</span>
<a id="__codelineno-75-78" name="__codelineno-75-78" href="#__codelineno-75-78"></a><span class="w">    </span>uvicorn<span class="w"> </span>src.clean_py.presentation.api.main:app<span class="w"> </span>--reload<span class="w"> </span>--port<span class="w"> </span><span class="m">8000</span>
<a id="__codelineno-75-79" name="__codelineno-75-79" href="#__codelineno-75-79"></a>
<a id="__codelineno-75-80" name="__codelineno-75-80" href="#__codelineno-75-80"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">run</span>-<span class="n">prod</span>
<a id="__codelineno-75-81" name="__codelineno-75-81" href="#__codelineno-75-81"></a><span class="nf">run-prod</span><span class="o">:</span><span class="w"> </span><span class="c">## Run the application in production mode</span>
<a id="__codelineno-75-82" name="__codelineno-75-82" href="#__codelineno-75-82"></a><span class="w">    </span>uvicorn<span class="w"> </span>src.clean_py.presentation.api.main:app<span class="w"> </span>--host<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span>--port<span class="w"> </span><span class="m">8000</span><span class="w"> </span>--workers<span class="w"> </span><span class="m">4</span>
<a id="__codelineno-75-83" name="__codelineno-75-83" href="#__codelineno-75-83"></a>
<a id="__codelineno-75-84" name="__codelineno-75-84" href="#__codelineno-75-84"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">security</span>-<span class="n">check</span>
<a id="__codelineno-75-85" name="__codelineno-75-85" href="#__codelineno-75-85"></a><span class="nf">security-check</span><span class="o">:</span><span class="w"> </span><span class="c">## Run security checks</span>
<a id="__codelineno-75-86" name="__codelineno-75-86" href="#__codelineno-75-86"></a><span class="w">    </span>pip-audit
<a id="__codelineno-75-87" name="__codelineno-75-87" href="#__codelineno-75-87"></a><span class="w">    </span>bandit<span class="w"> </span>-r<span class="w"> </span>src
<a id="__codelineno-75-88" name="__codelineno-75-88" href="#__codelineno-75-88"></a><span class="w">    </span>safety<span class="w"> </span>check
<a id="__codelineno-75-89" name="__codelineno-75-89" href="#__codelineno-75-89"></a>
<a id="__codelineno-75-90" name="__codelineno-75-90" href="#__codelineno-75-90"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">docs</span>
<a id="__codelineno-75-91" name="__codelineno-75-91" href="#__codelineno-75-91"></a><span class="nf">docs</span><span class="o">:</span><span class="w"> </span><span class="c">## Generate documentation</span>
<a id="__codelineno-75-92" name="__codelineno-75-92" href="#__codelineno-75-92"></a><span class="w">    </span>mkdocs<span class="w"> </span>build
<a id="__codelineno-75-93" name="__codelineno-75-93" href="#__codelineno-75-93"></a>
<a id="__codelineno-75-94" name="__codelineno-75-94" href="#__codelineno-75-94"></a><span class="nf">.PHONY</span><span class="o">:</span><span class="w"> </span><span class="n">docs</span>-<span class="n">serve</span>
<a id="__codelineno-75-95" name="__codelineno-75-95" href="#__codelineno-75-95"></a><span class="nf">docs-serve</span><span class="o">:</span><span class="w"> </span><span class="c">## Serve documentation locally</span>
<a id="__codelineno-75-96" name="__codelineno-75-96" href="#__codelineno-75-96"></a><span class="w">    </span>mkdocs<span class="w"> </span>serve
</code></pre></div>
<p>Now developers can run consistent commands regardless of their environment:
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>make<span class="w"> </span>install<span class="w">        </span><span class="c1"># Setup development environment</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>make<span class="w"> </span><span class="nb">test</span><span class="w">          </span><span class="c1"># Run tests</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>make<span class="w"> </span>lint<span class="w">          </span><span class="c1"># Check code quality</span>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>make<span class="w"> </span>run<span class="w">           </span><span class="c1"># Start the application</span>
</code></pre></div></p>
<h3 id="pre-commit-hooks-quality-gates-at-commit-time"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#pre-commit-hooks-quality-gates-at-commit-time">Pre-commit Hooks: Quality Gates at Commit Time</a></h3>
<p>Pre-commit hooks catch issues before they enter your repository. Here's a comprehensive configuration:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1"># .pre-commit-config.yaml</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="nt">default_language_version</span><span class="p">:</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="w">  </span><span class="nt">python</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.11</span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="nt">repos</span><span class="p">:</span>
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/pre-commit/pre-commit-hooks</span>
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.5.0</span>
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trailing-whitespace</span>
<a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">end-of-file-fixer</span>
<a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-yaml</span>
<a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-json</span>
<a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-toml</span>
<a id="__codelineno-77-14" name="__codelineno-77-14" href="#__codelineno-77-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-added-large-files</span>
<a id="__codelineno-77-15" name="__codelineno-77-15" href="#__codelineno-77-15"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;--maxkb=1000&#39;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-77-16" name="__codelineno-77-16" href="#__codelineno-77-16"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-case-conflict</span>
<a id="__codelineno-77-17" name="__codelineno-77-17" href="#__codelineno-77-17"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-merge-conflict</span>
<a id="__codelineno-77-18" name="__codelineno-77-18" href="#__codelineno-77-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">detect-private-key</span>
<a id="__codelineno-77-19" name="__codelineno-77-19" href="#__codelineno-77-19"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">debug-statements</span>
<a id="__codelineno-77-20" name="__codelineno-77-20" href="#__codelineno-77-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mixed-line-ending</span>
<a id="__codelineno-77-21" name="__codelineno-77-21" href="#__codelineno-77-21"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;--fix=lf&#39;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-77-22" name="__codelineno-77-22" href="#__codelineno-77-22"></a>
<a id="__codelineno-77-23" name="__codelineno-77-23" href="#__codelineno-77-23"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/psf/black</span>
<a id="__codelineno-77-24" name="__codelineno-77-24" href="#__codelineno-77-24"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">23.11.0</span>
<a id="__codelineno-77-25" name="__codelineno-77-25" href="#__codelineno-77-25"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-77-26" name="__codelineno-77-26" href="#__codelineno-77-26"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">black</span>
<a id="__codelineno-77-27" name="__codelineno-77-27" href="#__codelineno-77-27"></a><span class="w">        </span><span class="nt">language_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.11</span>
<a id="__codelineno-77-28" name="__codelineno-77-28" href="#__codelineno-77-28"></a>
<a id="__codelineno-77-29" name="__codelineno-77-29" href="#__codelineno-77-29"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/charliermarsh/ruff-pre-commit</span>
<a id="__codelineno-77-30" name="__codelineno-77-30" href="#__codelineno-77-30"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.1.6</span>
<a id="__codelineno-77-31" name="__codelineno-77-31" href="#__codelineno-77-31"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-77-32" name="__codelineno-77-32" href="#__codelineno-77-32"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ruff</span>
<a id="__codelineno-77-33" name="__codelineno-77-33" href="#__codelineno-77-33"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">--fix</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">--exit-non-zero-on-fix</span><span class="p p-Indicator">]</span>
<a id="__codelineno-77-34" name="__codelineno-77-34" href="#__codelineno-77-34"></a>
<a id="__codelineno-77-35" name="__codelineno-77-35" href="#__codelineno-77-35"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/pre-commit/mirrors-mypy</span>
<a id="__codelineno-77-36" name="__codelineno-77-36" href="#__codelineno-77-36"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1.7.1</span>
<a id="__codelineno-77-37" name="__codelineno-77-37" href="#__codelineno-77-37"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-77-38" name="__codelineno-77-38" href="#__codelineno-77-38"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mypy</span>
<a id="__codelineno-77-39" name="__codelineno-77-39" href="#__codelineno-77-39"></a><span class="w">        </span><span class="nt">additional_dependencies</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">types-all</span><span class="p p-Indicator">]</span>
<a id="__codelineno-77-40" name="__codelineno-77-40" href="#__codelineno-77-40"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">--strict</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">--ignore-missing-imports</span><span class="p p-Indicator">]</span>
<a id="__codelineno-77-41" name="__codelineno-77-41" href="#__codelineno-77-41"></a>
<a id="__codelineno-77-42" name="__codelineno-77-42" href="#__codelineno-77-42"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/PyCQA/bandit</span>
<a id="__codelineno-77-43" name="__codelineno-77-43" href="#__codelineno-77-43"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.7.5</span>
<a id="__codelineno-77-44" name="__codelineno-77-44" href="#__codelineno-77-44"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-77-45" name="__codelineno-77-45" href="#__codelineno-77-45"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bandit</span>
<a id="__codelineno-77-46" name="__codelineno-77-46" href="#__codelineno-77-46"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;-r&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;src&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-ll&#39;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-77-47" name="__codelineno-77-47" href="#__codelineno-77-47"></a><span class="w">        </span><span class="nt">exclude</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tests/</span>
<a id="__codelineno-77-48" name="__codelineno-77-48" href="#__codelineno-77-48"></a>
<a id="__codelineno-77-49" name="__codelineno-77-49" href="#__codelineno-77-49"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/pycqa/isort</span>
<a id="__codelineno-77-50" name="__codelineno-77-50" href="#__codelineno-77-50"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.12.0</span>
<a id="__codelineno-77-51" name="__codelineno-77-51" href="#__codelineno-77-51"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-77-52" name="__codelineno-77-52" href="#__codelineno-77-52"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">isort</span>
<a id="__codelineno-77-53" name="__codelineno-77-53" href="#__codelineno-77-53"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;--profile&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;black&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-77-54" name="__codelineno-77-54" href="#__codelineno-77-54"></a>
<a id="__codelineno-77-55" name="__codelineno-77-55" href="#__codelineno-77-55"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/asottile/pyupgrade</span>
<a id="__codelineno-77-56" name="__codelineno-77-56" href="#__codelineno-77-56"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v3.15.0</span>
<a id="__codelineno-77-57" name="__codelineno-77-57" href="#__codelineno-77-57"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-77-58" name="__codelineno-77-58" href="#__codelineno-77-58"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pyupgrade</span>
<a id="__codelineno-77-59" name="__codelineno-77-59" href="#__codelineno-77-59"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">--py311-plus</span><span class="p p-Indicator">]</span>
<a id="__codelineno-77-60" name="__codelineno-77-60" href="#__codelineno-77-60"></a>
<a id="__codelineno-77-61" name="__codelineno-77-61" href="#__codelineno-77-61"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<a id="__codelineno-77-62" name="__codelineno-77-62" href="#__codelineno-77-62"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-77-63" name="__codelineno-77-63" href="#__codelineno-77-63"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest-check</span>
<a id="__codelineno-77-64" name="__codelineno-77-64" href="#__codelineno-77-64"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest-check</span>
<a id="__codelineno-77-65" name="__codelineno-77-65" href="#__codelineno-77-65"></a><span class="w">        </span><span class="nt">entry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest</span>
<a id="__codelineno-77-66" name="__codelineno-77-66" href="#__codelineno-77-66"></a><span class="w">        </span><span class="nt">language</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system</span>
<a id="__codelineno-77-67" name="__codelineno-77-67" href="#__codelineno-77-67"></a><span class="w">        </span><span class="nt">pass_filenames</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-77-68" name="__codelineno-77-68" href="#__codelineno-77-68"></a><span class="w">        </span><span class="nt">always_run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-77-69" name="__codelineno-77-69" href="#__codelineno-77-69"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">tests/unit</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">--tb=short</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">-q</span><span class="p p-Indicator">]</span>
</code></pre></div>
<p>Install pre-commit hooks with:
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>pre-commit<span class="w"> </span>install
</code></pre></div></p>
<p>Now every commit automatically:
- Formats code with Black
- Checks for linting issues with Ruff
- Verifies type hints with MyPy
- Scans for security issues with Bandit
- Runs unit tests
- Fixes common issues (trailing whitespace, line endings)</p>
<h3 id="environment-management"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#environment-management">Environment Management</a></h3>
<p>Professional projects separate configuration from code. Here's how to handle environments properly:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="c1"># .env.example</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="c1"># Application</span>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="nv">APP_NAME</span><span class="o">=</span>clean-py
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="nv">APP_ENV</span><span class="o">=</span>development
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="nv">DEBUG</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="nv">LOG_LEVEL</span><span class="o">=</span>DEBUG
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="c1"># Database</span>
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a><span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql+asyncpg://user:password@localhost:5432/cleanpy
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a><span class="nv">DATABASE_POOL_SIZE</span><span class="o">=</span><span class="m">20</span>
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a><span class="nv">DATABASE_MAX_OVERFLOW</span><span class="o">=</span><span class="m">10</span>
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a><span class="c1"># Redis</span>
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a><span class="nv">REDIS_URL</span><span class="o">=</span>redis://localhost:6379/0
<a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>
<a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a><span class="c1"># Security</span>
<a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a><span class="nv">SECRET_KEY</span><span class="o">=</span>your-secret-key-here-change-in-production
<a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a><span class="nv">JWT_ALGORITHM</span><span class="o">=</span>HS256
<a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a><span class="nv">JWT_EXPIRATION_MINUTES</span><span class="o">=</span><span class="m">30</span>
<a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a>
<a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a><span class="c1"># AWS (Production)</span>
<a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a><span class="nv">AWS_REGION</span><span class="o">=</span>us-east-1
<a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>
<a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>
<a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a>
<a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a><span class="c1"># External Services</span>
<a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a><span class="nv">PAYMENT_API_KEY</span><span class="o">=</span>
<a id="__codelineno-79-28" name="__codelineno-79-28" href="#__codelineno-79-28"></a><span class="nv">EMAIL_SERVICE_API_KEY</span><span class="o">=</span>
</code></pre></div>
<p>Use <code>pydantic-settings</code> for type-safe configuration:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="c1"># src/clean_py/infrastructure/config.py</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span><span class="p">,</span> <span class="n">SettingsConfigDict</span>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>    <span class="n">model_config</span> <span class="o">=</span> <span class="n">SettingsConfigDict</span><span class="p">(</span>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>        <span class="n">env_file</span><span class="o">=</span><span class="s2">&quot;.env&quot;</span><span class="p">,</span>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>        <span class="n">env_file_encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>        <span class="n">case_sensitive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>    <span class="p">)</span>
<a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a>
<a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>    <span class="c1"># Application</span>
<a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a>    <span class="n">app_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;clean-py&quot;</span>
<a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a>    <span class="n">app_env</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;development&quot;</span>
<a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a>    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a>    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span>
<a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a>
<a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a>    <span class="c1"># Database</span>
<a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a>    <span class="n">database_url</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a>    <span class="n">database_pool_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
<a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a>    <span class="n">database_max_overflow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a>
<a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a>    <span class="c1"># Redis</span>
<a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a>    <span class="n">redis_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;redis://localhost:6379/0&quot;</span>
<a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a>
<a id="__codelineno-80-26" name="__codelineno-80-26" href="#__codelineno-80-26"></a>    <span class="c1"># Security</span>
<a id="__codelineno-80-27" name="__codelineno-80-27" href="#__codelineno-80-27"></a>    <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-80-28" name="__codelineno-80-28" href="#__codelineno-80-28"></a>    <span class="n">jwt_algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span>
<a id="__codelineno-80-29" name="__codelineno-80-29" href="#__codelineno-80-29"></a>    <span class="n">jwt_expiration_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>
<a id="__codelineno-80-30" name="__codelineno-80-30" href="#__codelineno-80-30"></a>
<a id="__codelineno-80-31" name="__codelineno-80-31" href="#__codelineno-80-31"></a>    <span class="c1"># AWS</span>
<a id="__codelineno-80-32" name="__codelineno-80-32" href="#__codelineno-80-32"></a>    <span class="n">aws_region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;us-east-1&quot;</span>
<a id="__codelineno-80-33" name="__codelineno-80-33" href="#__codelineno-80-33"></a>    <span class="n">aws_access_key_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-80-34" name="__codelineno-80-34" href="#__codelineno-80-34"></a>    <span class="n">aws_secret_access_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-80-35" name="__codelineno-80-35" href="#__codelineno-80-35"></a>
<a id="__codelineno-80-36" name="__codelineno-80-36" href="#__codelineno-80-36"></a>    <span class="nd">@property</span>
<a id="__codelineno-80-37" name="__codelineno-80-37" href="#__codelineno-80-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_production</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-80-38" name="__codelineno-80-38" href="#__codelineno-80-38"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_env</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span>
<a id="__codelineno-80-39" name="__codelineno-80-39" href="#__codelineno-80-39"></a>
<a id="__codelineno-80-40" name="__codelineno-80-40" href="#__codelineno-80-40"></a>    <span class="nd">@property</span>
<a id="__codelineno-80-41" name="__codelineno-80-41" href="#__codelineno-80-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_development</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-80-42" name="__codelineno-80-42" href="#__codelineno-80-42"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_env</span> <span class="o">==</span> <span class="s2">&quot;development&quot;</span>
<a id="__codelineno-80-43" name="__codelineno-80-43" href="#__codelineno-80-43"></a>
<a id="__codelineno-80-44" name="__codelineno-80-44" href="#__codelineno-80-44"></a><span class="nd">@lru_cache</span><span class="p">()</span>
<a id="__codelineno-80-45" name="__codelineno-80-45" href="#__codelineno-80-45"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_settings</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Settings</span><span class="p">:</span>
<a id="__codelineno-80-46" name="__codelineno-80-46" href="#__codelineno-80-46"></a>    <span class="k">return</span> <span class="n">Settings</span><span class="p">()</span>
</code></pre></div>
<h3 id="dependency-management-best-practices"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#dependency-management-best-practices">Dependency Management Best Practices</a></h3>
<p>Managing dependencies properly prevents many production issues:</p>
<h4 id="1-pin-direct-dependencies-not-transitive-ones"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#1-pin-direct-dependencies-not-transitive-ones">1. Pin Direct Dependencies, Not Transitive Ones</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># Good - pin direct dependencies with minimum versions</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="w">    </span><span class="s2">&quot;fastapi&gt;=0.104.0&quot;</span><span class="p">,</span>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="w">    </span><span class="s2">&quot;sqlalchemy&gt;=2.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="p">]</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="c1"># Bad - pinning exact versions of everything</span>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="w">    </span><span class="s2">&quot;fastapi==0.104.1&quot;</span><span class="p">,</span>
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a><span class="w">    </span><span class="s2">&quot;sqlalchemy==2.0.23&quot;</span><span class="p">,</span>
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a><span class="w">    </span><span class="s2">&quot;starlette==0.27.0&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># This is a fastapi dependency</span>
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a><span class="p">]</span>
</code></pre></div>
<h4 id="2-separate-production-and-development-dependencies"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#2-separate-production-and-development-dependencies">2. Separate Production and Development Dependencies</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="c1"># Install for development</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[dev]&quot;</span>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a>
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="c1"># Install for production</span>
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a>
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a><span class="c1"># Install with specific extras</span>
<a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[aws,monitoring]&quot;</span>
</code></pre></div>
<h4 id="3-use-lock-files-for-reproducible-builds"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#3-use-lock-files-for-reproducible-builds">3. Use Lock Files for Reproducible Builds</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="c1"># Generate lock file</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>pip<span class="w"> </span>freeze<span class="w"> </span>&gt;<span class="w"> </span>requirements-lock.txt
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="c1"># Or use pip-tools</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>pip-compile<span class="w"> </span>pyproject.toml<span class="w"> </span>-o<span class="w"> </span>requirements.txt
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>pip-compile<span class="w"> </span>--extra<span class="w"> </span>dev<span class="w"> </span>pyproject.toml<span class="w"> </span>-o<span class="w"> </span>requirements-dev.txt
</code></pre></div>
<h4 id="4-regular-dependency-updates"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#4-regular-dependency-updates">4. Regular Dependency Updates</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="c1"># Check for outdated packages</span>
<a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>pip<span class="w"> </span>list<span class="w"> </span>--outdated
<a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>
<a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="c1"># Update all packages</span>
<a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[dev]&quot;</span>
<a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>
<a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="c1"># Security audit</span>
<a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a>pip-audit
<a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>safety<span class="w"> </span>check
</code></pre></div>
<h3 id="virtual-environment-management"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#virtual-environment-management">Virtual Environment Management</a></h3>
<p>Always use virtual environments. Here are the modern approaches:</p>
<h4 id="using-venv-built-in"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#using-venv-built-in">Using venv (Built-in)</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>python<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>.venv
<a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="nb">source</span><span class="w"> </span>.venv/bin/activate<span class="w">  </span><span class="c1"># Unix/MacOS</span>
<a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a>.venv<span class="se">\S</span>cripts<span class="se">\a</span>ctivate<span class="w">     </span><span class="c1"># Windows</span>
</code></pre></div>
<h4 id="using-pyenv-pyenv-virtualenv"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#using-pyenv-pyenv-virtualenv">Using pyenv + pyenv-virtualenv</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>pyenv<span class="w"> </span>install<span class="w"> </span><span class="m">3</span>.11.6
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>pyenv<span class="w"> </span>virtualenv<span class="w"> </span><span class="m">3</span>.11.6<span class="w"> </span>clean-py
<a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a>pyenv<span class="w"> </span><span class="nb">local</span><span class="w"> </span>clean-py
</code></pre></div>
<h4 id="using-poetry-alternative"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#using-poetry-alternative">Using Poetry (Alternative)</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>poetry<span class="w"> </span>new<span class="w"> </span>clean-py
<a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>poetry<span class="w"> </span>add<span class="w"> </span>fastapi<span class="w"> </span>sqlalchemy
<a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>poetry<span class="w"> </span>install
<a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>poetry<span class="w"> </span>shell
</code></pre></div>
<h3 id="continuous-integration-setup"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#continuous-integration-setup">Continuous Integration Setup</a></h3>
<p>Your project setup should include CI/CD from day one:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="c1"># .github/workflows/ci.yml</span>
<a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CI</span>
<a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>
<a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a><span class="nt">on</span><span class="p">:</span>
<a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a><span class="w">  </span><span class="nt">push</span><span class="p">:</span>
<a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">develop</span><span class="p p-Indicator">]</span>
<a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a><span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>
<a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">main</span><span class="p p-Indicator">]</span>
<a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a>
<a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="nt">jobs</span><span class="p">:</span>
<a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a><span class="w">  </span><span class="nt">test</span><span class="p">:</span>
<a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a><span class="w">    </span><span class="nt">strategy</span><span class="p">:</span>
<a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a><span class="w">      </span><span class="nt">matrix</span><span class="p">:</span>
<a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a><span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;3.11&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;3.12&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a>
<a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a><span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v4</span>
<a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a>
<a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python</span>
<a id="__codelineno-88-21" name="__codelineno-88-21" href="#__codelineno-88-21"></a><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<a id="__codelineno-88-22" name="__codelineno-88-22" href="#__codelineno-88-22"></a><span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<a id="__codelineno-88-23" name="__codelineno-88-23" href="#__codelineno-88-23"></a><span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ matrix.python-version }}</span>
<a id="__codelineno-88-24" name="__codelineno-88-24" href="#__codelineno-88-24"></a>
<a id="__codelineno-88-25" name="__codelineno-88-25" href="#__codelineno-88-25"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cache dependencies</span>
<a id="__codelineno-88-26" name="__codelineno-88-26" href="#__codelineno-88-26"></a><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/cache@v3</span>
<a id="__codelineno-88-27" name="__codelineno-88-27" href="#__codelineno-88-27"></a><span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<a id="__codelineno-88-28" name="__codelineno-88-28" href="#__codelineno-88-28"></a><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.cache/pip</span>
<a id="__codelineno-88-29" name="__codelineno-88-29" href="#__codelineno-88-29"></a><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ runner.os }}-pip-${{ hashFiles(&#39;pyproject.toml&#39;) }}</span>
<a id="__codelineno-88-30" name="__codelineno-88-30" href="#__codelineno-88-30"></a>
<a id="__codelineno-88-31" name="__codelineno-88-31" href="#__codelineno-88-31"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<a id="__codelineno-88-32" name="__codelineno-88-32" href="#__codelineno-88-32"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-88-33" name="__codelineno-88-33" href="#__codelineno-88-33"></a><span class="w">          </span><span class="no">python -m pip install --upgrade pip</span>
<a id="__codelineno-88-34" name="__codelineno-88-34" href="#__codelineno-88-34"></a><span class="w">          </span><span class="no">pip install -e &quot;.[dev]&quot;</span>
<a id="__codelineno-88-35" name="__codelineno-88-35" href="#__codelineno-88-35"></a>
<a id="__codelineno-88-36" name="__codelineno-88-36" href="#__codelineno-88-36"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run linting</span>
<a id="__codelineno-88-37" name="__codelineno-88-37" href="#__codelineno-88-37"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make lint</span>
<a id="__codelineno-88-38" name="__codelineno-88-38" href="#__codelineno-88-38"></a>
<a id="__codelineno-88-39" name="__codelineno-88-39" href="#__codelineno-88-39"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run tests</span>
<a id="__codelineno-88-40" name="__codelineno-88-40" href="#__codelineno-88-40"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">make test-all</span>
<a id="__codelineno-88-41" name="__codelineno-88-41" href="#__codelineno-88-41"></a>
<a id="__codelineno-88-42" name="__codelineno-88-42" href="#__codelineno-88-42"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload coverage</span>
<a id="__codelineno-88-43" name="__codelineno-88-43" href="#__codelineno-88-43"></a><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov/codecov-action@v3</span>
<a id="__codelineno-88-44" name="__codelineno-88-44" href="#__codelineno-88-44"></a><span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<a id="__codelineno-88-45" name="__codelineno-88-45" href="#__codelineno-88-45"></a><span class="w">          </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./coverage.xml</span>
</code></pre></div>
<h3 id="project-documentation"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#project-documentation">Project Documentation</a></h3>
<p>Good setup includes documentation structure:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="gh"># README.md</span>
<a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>
<a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="gh"># Clean-Py: Production-Ready Python Microservice</span>
<a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>
<a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a>[<span class="nt">![CI</span>](<span class="na">https://github.com/buildshift-dev/clean-py/actions/workflows/ci.yml/badge.svg</span>)](https://github.com/buildshift-dev/clean-py/actions)
<a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a>[<span class="nt">![Coverage</span>](<span class="na">https://codecov.io/gh/buildshift-dev/clean-py/branch/main/graph/badge.svg</span>)](https://codecov.io/gh/buildshift-dev/clean-py)
<a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a>[<span class="nt">![Python Version</span>](<span class="na">https://img.shields.io/badge/python-3.11%2B-blue</span>)](https://www.python.org/downloads/)
<a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a>
<a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a><span class="gu">## Quick Start</span>
<a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a>
<a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a><span class="gu">### Prerequisites</span>
<a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a><span class="k">-</span><span class="w"> </span>Python 3.11+
<a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a><span class="k">-</span><span class="w"> </span>PostgreSQL 14+
<a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a><span class="k">-</span><span class="w"> </span>Redis 6+
<a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a>
<a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a><span class="gu">### Installation</span>
<a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a>\`\`\`bash
<a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a><span class="gh"># Clone the repository</span>
<a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a>git clone https://github.com/buildshift-dev/clean-py.git
<a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a>cd clean-py
<a id="__codelineno-89-21" name="__codelineno-89-21" href="#__codelineno-89-21"></a>
<a id="__codelineno-89-22" name="__codelineno-89-22" href="#__codelineno-89-22"></a><span class="gh"># Create virtual environment</span>
<a id="__codelineno-89-23" name="__codelineno-89-23" href="#__codelineno-89-23"></a>python -m venv .venv
<a id="__codelineno-89-24" name="__codelineno-89-24" href="#__codelineno-89-24"></a>source .venv/bin/activate
<a id="__codelineno-89-25" name="__codelineno-89-25" href="#__codelineno-89-25"></a>
<a id="__codelineno-89-26" name="__codelineno-89-26" href="#__codelineno-89-26"></a><span class="gh"># Install dependencies</span>
<a id="__codelineno-89-27" name="__codelineno-89-27" href="#__codelineno-89-27"></a>make install
<a id="__codelineno-89-28" name="__codelineno-89-28" href="#__codelineno-89-28"></a>
<a id="__codelineno-89-29" name="__codelineno-89-29" href="#__codelineno-89-29"></a><span class="gh"># Copy environment variables</span>
<a id="__codelineno-89-30" name="__codelineno-89-30" href="#__codelineno-89-30"></a>cp .env.example .env
<a id="__codelineno-89-31" name="__codelineno-89-31" href="#__codelineno-89-31"></a>
<a id="__codelineno-89-32" name="__codelineno-89-32" href="#__codelineno-89-32"></a><span class="gh"># Run migrations</span>
<a id="__codelineno-89-33" name="__codelineno-89-33" href="#__codelineno-89-33"></a>make db-upgrade
<a id="__codelineno-89-34" name="__codelineno-89-34" href="#__codelineno-89-34"></a>
<a id="__codelineno-89-35" name="__codelineno-89-35" href="#__codelineno-89-35"></a><span class="gh"># Start the application</span>
<a id="__codelineno-89-36" name="__codelineno-89-36" href="#__codelineno-89-36"></a>make run
<a id="__codelineno-89-37" name="__codelineno-89-37" href="#__codelineno-89-37"></a>\`\`\`
<a id="__codelineno-89-38" name="__codelineno-89-38" href="#__codelineno-89-38"></a>
<a id="__codelineno-89-39" name="__codelineno-89-39" href="#__codelineno-89-39"></a><span class="gu">### Development</span>
<a id="__codelineno-89-40" name="__codelineno-89-40" href="#__codelineno-89-40"></a>\`\`\`bash
<a id="__codelineno-89-41" name="__codelineno-89-41" href="#__codelineno-89-41"></a><span class="gh"># Run tests</span>
<a id="__codelineno-89-42" name="__codelineno-89-42" href="#__codelineno-89-42"></a>make test
<a id="__codelineno-89-43" name="__codelineno-89-43" href="#__codelineno-89-43"></a>
<a id="__codelineno-89-44" name="__codelineno-89-44" href="#__codelineno-89-44"></a><span class="gh"># Format code</span>
<a id="__codelineno-89-45" name="__codelineno-89-45" href="#__codelineno-89-45"></a>make format
<a id="__codelineno-89-46" name="__codelineno-89-46" href="#__codelineno-89-46"></a>
<a id="__codelineno-89-47" name="__codelineno-89-47" href="#__codelineno-89-47"></a><span class="gh"># Run linting</span>
<a id="__codelineno-89-48" name="__codelineno-89-48" href="#__codelineno-89-48"></a>make lint
<a id="__codelineno-89-49" name="__codelineno-89-49" href="#__codelineno-89-49"></a>
<a id="__codelineno-89-50" name="__codelineno-89-50" href="#__codelineno-89-50"></a><span class="gh"># Build Docker image</span>
<a id="__codelineno-89-51" name="__codelineno-89-51" href="#__codelineno-89-51"></a>make docker-build
<a id="__codelineno-89-52" name="__codelineno-89-52" href="#__codelineno-89-52"></a>\`\`\`
<a id="__codelineno-89-53" name="__codelineno-89-53" href="#__codelineno-89-53"></a>
<a id="__codelineno-89-54" name="__codelineno-89-54" href="#__codelineno-89-54"></a><span class="gu">## Project Structure</span>
<a id="__codelineno-89-55" name="__codelineno-89-55" href="#__codelineno-89-55"></a>\`\`\`
<a id="__codelineno-89-56" name="__codelineno-89-56" href="#__codelineno-89-56"></a>src/clean_py/
<a id="__codelineno-89-57" name="__codelineno-89-57" href="#__codelineno-89-57"></a>â”œâ”€â”€ domain/          # Business logic and entities
<a id="__codelineno-89-58" name="__codelineno-89-58" href="#__codelineno-89-58"></a>â”œâ”€â”€ application/     # Use cases and application services  
<a id="__codelineno-89-59" name="__codelineno-89-59" href="#__codelineno-89-59"></a>â”œâ”€â”€ infrastructure/  # External services and persistence
<a id="__codelineno-89-60" name="__codelineno-89-60" href="#__codelineno-89-60"></a>â””â”€â”€ presentation/    # API and UI layers
<a id="__codelineno-89-61" name="__codelineno-89-61" href="#__codelineno-89-61"></a>\`\`\`
<a id="__codelineno-89-62" name="__codelineno-89-62" href="#__codelineno-89-62"></a>
<a id="__codelineno-89-63" name="__codelineno-89-63" href="#__codelineno-89-63"></a><span class="gu">## Contributing</span>
<a id="__codelineno-89-64" name="__codelineno-89-64" href="#__codelineno-89-64"></a>See [<span class="nt">CONTRIBUTING.md</span>](<span class="na">CONTRIBUTING.md</span>) for development guidelines.
<a id="__codelineno-89-65" name="__codelineno-89-65" href="#__codelineno-89-65"></a>
<a id="__codelineno-89-66" name="__codelineno-89-66" href="#__codelineno-89-66"></a><span class="gu">## License</span>
<a id="__codelineno-89-67" name="__codelineno-89-67" href="#__codelineno-89-67"></a>MIT License - see [<span class="nt">LICENSE</span>](<span class="na">LICENSE</span>) for details.
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#conclusion">Conclusion</a></h3>
<p>Professional Python project setup is about more than just organizing files. It's about creating a foundation that supports your team's productivity, maintains code quality, and scales with your application's growth.</p>
<p>The setup we've covered hereâ€”from <code>pyproject.toml</code> to pre-commit hooks to Makefilesâ€”might seem like overkill for a small project. But these patterns pay dividends as your project grows. They're the difference between a project that's a joy to work on and one that everyone avoids.</p>
<p>In the next post, we'll explore Domain-Driven Design in Python, showing how to model complex business logic in a way that's both powerful and maintainable. We'll see how proper project setup enables architectural patterns that would be impossible in a poorly structured codebase.</p>
<p>Start with the right foundation. Your future self and your team will thank you.</p>
<h3 id="references"><a class="toclink" href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete project setup example</li>
<li><a href="https://peps.python.org/pep-0621/">PEP 621 - pyproject.toml</a> - Modern Python project metadata</li>
<li><a href="https://pre-commit.com/">Pre-commit Framework</a> - Git hooks for code quality</li>
<li><a href="https://docs.astral.sh/ruff/">Ruff Documentation</a> - Fast Python linter and formatter</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-05-22 19:15:00-04:00">May 22, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../clean-architecture/" class="md-meta__link">Clean Architecture</a>, 
              <a href="../../" class="md-meta__link">Python</a>, 
              <a href="../../../software-design/" class="md-meta__link">Software Design</a></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="from-script-to-architecture-why-your-python-project-needs-structure"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/">From Script to Architecture: Why Your Python Project Needs Structure</a></h2>
<p>Every Python developer has been there. You start with a simple script to solve a problem. Maybe it's processing some data, automating a task, or building a quick API endpoint. The script grows. Features get added. Before you know it, you're staring at a 2,000-line file that nobody wants to touch, let alone understand.</p>
<p>I've witnessed this organic growth countless times in production systems. What starts as <code>app.py</code> becomes a tangled web of functions, global variables, and copy-pasted code blocks. The cost of adding new features skyrockets. Bugs become harder to track. Testing? Nearly impossible without running the entire application.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates how to avoid this trap from day one. It's not about over-engineering; it's about sustainable development practices that scale with your needs.</p>
<h3 id="the-real-cost-of-unstructured-code"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#the-real-cost-of-unstructured-code">The Real Cost of Unstructured Code</a></h3>
<p>Let me share a story from a recent consulting engagement. A startup had built their entire e-commerce platform in three Python files: <code>main.py</code>, <code>database.py</code>, and <code>utils.py</code>. The <code>main.py</code> alone was over 5,000 lines. Every developer on the team had a different understanding of how the system worked. Deployment was a prayer. Testing was manual.</p>
<p>When they needed to add a new payment provider, what should have been a two-day task turned into a three-week nightmare. The payment logic was scattered across all three files. Database transactions weren't properly managed. Error handling was inconsistent. The team eventually had to freeze feature development for two months to refactor the codebase.</p>
<p>This scenario plays out in companies every day. The hidden costs include:</p>
<ul>
<li><strong>Developer velocity decline</strong>: New features take exponentially longer to implement</li>
<li><strong>Knowledge silos</strong>: Only certain developers understand certain parts of the code</li>
<li><strong>Bug multiplication</strong>: Fixes in one area break functionality elsewhere</li>
<li><strong>Onboarding nightmare</strong>: New team members take months to become productive</li>
<li><strong>Testing impossibility</strong>: Automated testing becomes a pipe dream</li>
</ul>
<h3 id="recognizing-the-warning-signs"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#recognizing-the-warning-signs">Recognizing the Warning Signs</a></h3>
<p>Your Python project needs architectural attention when you notice these symptoms:</p>
<p><strong>Code Smells:</strong>
- Functions with more than 50 lines becoming common
- Global variables used for configuration and state
- Circular imports forcing creative import strategies
- Business logic mixed with database queries and API handlers
- Copy-pasted code blocks with slight variations
- Comments like "Don't touch this - it works somehow"</p>
<p><strong>Development Pain Points:</strong>
- Fear of refactoring because you might break something
- Merge conflicts on every pull request
- Inability to work on features in parallel
- Testing requires the entire application environment
- Debugging involves print statements throughout the code</p>
<p><strong>Operational Issues:</strong>
- Deployments require careful coordination
- Rolling back changes is risky or impossible
- Performance problems are hard to isolate
- Monitoring and logging are afterthoughts</p>
<h3 id="the-journey-from-script-to-architecture"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#the-journey-from-script-to-architecture">The Journey from Script to Architecture</a></h3>
<p>The transformation doesn't happen overnight, but it follows a predictable path. Here's how a typical Python project evolves, using our e-commerce platform as an example:</p>
<h4 id="stage-1-the-monolithic-script"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#stage-1-the-monolithic-script">Stage 1: The Monolithic Script</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># app.py - Everything in one place</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;shop.db&#39;</span><span class="p">)</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">)</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">():</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM products WHERE active = 1&quot;</span><span class="p">)</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="n">products</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/order&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">():</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>    <span class="c1"># 200 lines of order processing logic here</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    <span class="c1"># Including payment processing, inventory updates, emails...</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>This works for a prototype, but it's already showing problems. Database connections aren't managed properly. Business logic is mixed with HTTP handling. There's no separation of concerns.</p>
<h4 id="stage-2-basic-separation"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#stage-2-basic-separation">Stage 2: Basic Separation</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># models.py</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="c1"># database.py</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">Database</span><span class="p">:</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;shop.db&#39;</span><span class="p">)</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM products WHERE active = 1&quot;</span><span class="p">)</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="c1"># app.py</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Product</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">()</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">)</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">():</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>    <span class="n">products</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_products</span><span class="p">()</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
</code></pre></div>
<p>Better, but still problematic. The database layer knows about SQL. The models are anemic. The application layer is tightly coupled to Flask.</p>
<h4 id="stage-3-clean-architecture-introduction"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#stage-3-clean-architecture-introduction">Stage 3: Clean Architecture Introduction</a></h4>
<p>This is where the real transformation begins. Look at how the <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> structures the same functionality:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># src/domain/entities/product.py</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="nd">@dataclass</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">:</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="n">price</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="n">inventory_count</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">can_purchase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Business rule: Can we purchase this quantity?&quot;&quot;&quot;</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_count</span> <span class="o">&gt;=</span> <span class="n">quantity</span> <span class="ow">and</span> <span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Business logic for price calculation&quot;&quot;&quot;</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_purchase</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot purchase </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="c1"># src/domain/repositories/product_repository.py</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProductRepository</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>        <span class="k">pass</span>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_products</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>        <span class="k">pass</span>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a><span class="c1"># src/application/use_cases/get_products.py</span>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a><span class="k">class</span><span class="w"> </span><span class="nc">GetProductsUseCase</span><span class="p">:</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_repo</span><span class="p">:</span> <span class="n">ProductRepository</span><span class="p">):</span>
<a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">product_repo</span> <span class="o">=</span> <span class="n">product_repo</span>
<a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>
<a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ProductDTO</span><span class="p">]:</span>
<a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a>        <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_repo</span><span class="o">.</span><span class="n">get_active_products</span><span class="p">()</span>
<a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">ProductDTO</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">]</span>
<a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a>
<a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a><span class="c1"># src/infrastructure/database/product_repository_impl.py</span>
<a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
<a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a>
<a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProductRepositoryImpl</span><span class="p">(</span><span class="n">ProductRepository</span><span class="p">):</span>
<a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">):</span>
<a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
<a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a>
<a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_products</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
<a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a>            <span class="n">select</span><span class="p">(</span><span class="n">ProductModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ProductModel</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a>        <span class="p">)</span>
<a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()]</span>
<a id="__codelineno-14-58" name="__codelineno-14-58" href="#__codelineno-14-58"></a>
<a id="__codelineno-14-59" name="__codelineno-14-59" href="#__codelineno-14-59"></a><span class="c1"># src/presentation/api/products.py</span>
<a id="__codelineno-14-60" name="__codelineno-14-60" href="#__codelineno-14-60"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span>
<a id="__codelineno-14-61" name="__codelineno-14-61" href="#__codelineno-14-61"></a>
<a id="__codelineno-14-62" name="__codelineno-14-62" href="#__codelineno-14-62"></a><span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>
<a id="__codelineno-14-63" name="__codelineno-14-63" href="#__codelineno-14-63"></a>
<a id="__codelineno-14-64" name="__codelineno-14-64" href="#__codelineno-14-64"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/products&quot;</span><span class="p">)</span>
<a id="__codelineno-14-65" name="__codelineno-14-65" href="#__codelineno-14-65"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">(</span>
<a id="__codelineno-14-66" name="__codelineno-14-66" href="#__codelineno-14-66"></a>    <span class="n">use_case</span><span class="p">:</span> <span class="n">GetProductsUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_products_use_case</span><span class="p">)</span>
<a id="__codelineno-14-67" name="__codelineno-14-67" href="#__codelineno-14-67"></a><span class="p">):</span>
<a id="__codelineno-14-68" name="__codelineno-14-68" href="#__codelineno-14-68"></a>    <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<a id="__codelineno-14-69" name="__codelineno-14-69" href="#__codelineno-14-69"></a>    <span class="k">return</span> <span class="n">products</span>
</code></pre></div>
<p>Notice the dramatic differences:
- <strong>Domain layer</strong> contains business rules and entities
- <strong>Application layer</strong> orchestrates use cases
- <strong>Infrastructure layer</strong> handles technical details
- <strong>Presentation layer</strong> manages HTTP concerns
- Each layer has clear responsibilities and boundaries</p>
<h3 id="benefits-of-structured-architecture"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#benefits-of-structured-architecture">Benefits of Structured Architecture</a></h3>
<p>The investment in architecture pays dividends immediately:</p>
<h4 id="1-testability"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#1-testability">1. Testability</a></h4>
<p>Each layer can be tested in isolation. Domain logic doesn't need a database. Use cases can be tested with mock repositories. This leads to fast, reliable test suites.</p>
<h4 id="2-maintainability"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#2-maintainability">2. Maintainability</a></h4>
<p>When a bug report comes in, you know exactly where to look. Payment issue? Check the payment use case. Database problem? It's isolated to the repository layer.</p>
<h4 id="3-flexibility"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#3-flexibility">3. Flexibility</a></h4>
<p>Need to switch from PostgreSQL to MongoDB? Only the infrastructure layer changes. Want to add a GraphQL API alongside REST? Add it to the presentation layer without touching business logic.</p>
<h4 id="4-team-scalability"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#4-team-scalability">4. Team Scalability</a></h4>
<p>New developers can work on specific layers without understanding the entire system. Frontend developers focus on the presentation layer. Database experts optimize the infrastructure layer. Domain experts refine business rules.</p>
<h4 id="5-performance-optimization"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#5-performance-optimization">5. Performance Optimization</a></h4>
<p>With clear boundaries, performance bottlenecks are easier to identify and fix. You can cache at the appropriate layer, optimize database queries without touching business logic, and add async processing where it makes sense.</p>
<h3 id="the-path-forward"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#the-path-forward">The Path Forward</a></h3>
<p>Transitioning from script to architecture doesn't mean throwing away your existing code. It's about gradually introducing structure:</p>
<ol>
<li><strong>Start with the domain</strong>: Identify your core business entities and rules</li>
<li><strong>Extract use cases</strong>: Move business workflows into dedicated classes</li>
<li><strong>Abstract infrastructure</strong>: Hide database and external service details behind interfaces</li>
<li><strong>Separate presentation</strong>: Keep HTTP/API concerns in their own layer</li>
<li><strong>Add tests</strong>: Each refactoring step should be backed by tests</li>
</ol>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> provides a complete example of this architecture in action. It demonstrates patterns that work in production, from simple CRUD operations to complex business workflows.</p>
<h3 id="conclusion"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#conclusion">Conclusion</a></h3>
<p>The evolution from script to architecture is a journey every successful Python project must take. The question isn't whether you need structure, but when you'll introduce it. Starting with good architecture from day one isn't over-engineering; it's professional software development.</p>
<p>In the next post, we'll dive deep into setting up a Python project with modern tooling, going beyond simple requirements.txt files to create a professional development environment that supports your architectural goals.</p>
<p>Remember: Architecture isn't about complexity. It's about managing complexity. Your future self, your team, and your users will thank you for the investment.</p>
<h3 id="references-and-further-reading"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#references-and-further-reading">References and Further Reading</a></h3>
<h4 id="project-repository"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#project-repository">Project Repository</a></h4>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete implementation of Clean Architecture in Python</li>
<li><a href="https://github.com/buildshift-dev/clean-py/tree/main/docs">Project Documentation</a> - Detailed patterns and guides</li>
</ul>
<h4 id="books-and-articles"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#books-and-articles">Books and Articles</a></h4>
<ul>
<li><a href="https://www.amazon.com/Clean-Architecture-Craftsmans-Software-Structure/dp/0134494164">Clean Architecture by Robert C. Martin</a> - The definitive guide to Clean Architecture</li>
<li><a href="https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215">Domain-Driven Design by Eric Evans</a> - Essential reading for understanding domain modeling</li>
<li><a href="https://www.cosmicpython.com/">Architecture Patterns with Python</a> - Free online book on Python architecture patterns</li>
</ul>
<h4 id="python-resources"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#python-resources">Python Resources</a></h4>
<ul>
<li><a href="https://peps.python.org/pep-0008/">PEP 8 - Style Guide for Python Code</a> - Python coding conventions</li>
<li><a href="https://realpython.com/python-application-layouts/">Real Python - Application Layouts</a> - Guide to Python project structures</li>
<li><a href="https://packaging.python.org/">Python Packaging Guide</a> - Official Python packaging documentation</li>
</ul>
<h4 id="related-blog-posts-in-this-series"><a class="toclink" href="../../../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#related-blog-posts-in-this-series">Related Blog Posts in This Series</a></h4>
<ul>
<li><a href="../../../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/">Setting Up a Python Project Like a Pro</a> - Modern Python project setup</li>
<li><a href="../../../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/">Domain-Driven Design in Python</a> - DDD patterns in Python</li>
<li><a href="../../../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/">Clean Architecture in Python</a> - Implementing Clean Architecture</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-05-20 18:00:00-04:00">May 20, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../../../announcements/" class="md-meta__link">Announcements</a>, 
              <a href="../../../serverless/" class="md-meta__link">Serverless</a>, 
              <a href="../../" class="md-meta__link">Python</a></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="welcome-to-buildshiftdev"><a class="toclink" href="../../../../2025/05/20/welcome-to-buildshiftdev/">Welcome to buildshift.dev</a></h2>
<p>Welcome to the BuildShift development blog! I'm excited to share this new platform where I'll be documenting my journey in serverless architecture, Python development, and the various open-source projects that make up the BuildShift ecosystem.</p>

    
      <nav class="md-post__action">
        <a href="../../../../2025/05/20/welcome-to-buildshiftdev/">
          Continue reading
        </a>
      </nav>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <span class="md-pagination__current">2</span>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 buildshift.dev
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/buildshift-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/your-profile" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/your-handle" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:contact@buildshift.dev" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l208 156a48 48 0 0 0 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 196v188c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V196L313.6 344.8c-34.1 25.6-81.1 25.6-115.2 0z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.path", "navigation.top", "search.highlight", "search.share", "search.suggest", "content.code.copy", "content.code.annotate"], "search": "../../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../../../assets/js/buildshift.js"></script>
      
    
  </body>
</html>