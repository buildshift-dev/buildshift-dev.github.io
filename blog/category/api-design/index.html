
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Full Stack Developer specializing in AWS Serverless, Python, and modern development workflows">
      
      
        <meta name="author" content="buildshift.dev">
      
      
        <link rel="canonical" href="https://buildshift.dev/blog/category/api-design/">
      
      
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/images/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>API Design - buildshift.dev</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/css/buildshift.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-4SV8ZKYLT1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-4SV8ZKYLT1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-4SV8ZKYLT1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Fixed banner styling -->
  <style>
    body { padding-top: 40px !important; }
    .md-header { top: 40px !important; }
    .md-tabs { top: 40px !important; }
  </style>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-design" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
  <!-- Under Construction Announcement -->
  <div style="background: #000000; text-align: center; padding: 8px 0; position: fixed; top: 0; left: 0; right: 0; z-index: 9999; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 14px; font-weight: 500; color: #ffa500;">
      <i class="fas fa-hard-hat"></i>
      <span>...Under Construction...</span>
    </div>
  </div>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="buildshift.dev" class="md-header__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            buildshift.dev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Design
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link">
        
  
  
    
  
  buildshift.dev Blog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="buildshift.dev" class="md-nav__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    buildshift.dev
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    buildshift.dev Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="api-design">API Design</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-07-16 18:25:00-04:00">Jul 16, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../fastapi/" class="md-meta__link">FastAPI</a>, 
              <a href="../clean-architecture/" class="md-meta__link">Clean Architecture</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="./" class="md-meta__link">API Design</a></li>
        
        
          
          <li class="md-meta__item">
            
              14 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="fastapi-clean-architecture-a-match-made-in-heaven"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/">FastAPI + Clean Architecture: A Match Made in Heaven</a></h2>
<p>FastAPI has revolutionized Python web development with its modern approach to API design, automatic documentation, and exceptional performance. But many developers treat it as just another web framework, missing the opportunity to leverage its unique features within a Clean Architecture approach. The combination of FastAPI's dependency injection, type safety, and automatic validation with Clean Architecture's separation of concerns creates a powerful foundation for scalable applications.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates how FastAPI and Clean Architecture complement each other perfectly. This isn't just about using FastAPI as a web server—it's about leveraging its design philosophy to reinforce architectural boundaries and create truly maintainable systems.</p>
<h3 id="why-fastapi-and-clean-architecture-work-so-well-together"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#why-fastapi-and-clean-architecture-work-so-well-together">Why FastAPI and Clean Architecture Work So Well Together</a></h3>
<p>I've built REST APIs with Flask, Django REST Framework, and FastAPI. While each has its strengths, FastAPI's design philosophy aligns uniquely well with Clean Architecture principles:</p>
<p><strong>Type Safety</strong>: FastAPI's reliance on Python type hints enforces contracts between layers, making dependency inversion explicit and checkable.</p>
<p><strong>Dependency Injection</strong>: FastAPI's dependency system naturally implements the dependency inversion principle, making testing and mocking straightforward.</p>
<p><strong>Automatic Validation</strong>: Pydantic integration handles input validation at the presentation layer, keeping domain logic pure.</p>
<p><strong>Documentation Generation</strong>: OpenAPI documentation stays in sync with implementation, reducing maintenance overhead.</p>
<p><strong>Performance</strong>: ASGI foundation provides the performance needed for production systems without sacrificing development velocity.</p>
<p>A recent project demonstrated this perfectly. We migrated a Django REST Framework API with 50+ endpoints to FastAPI with Clean Architecture. The result: 40% performance improvement, 60% reduction in test execution time, and dramatically improved code maintainability. The architectural boundaries became self-enforcing through FastAPI's type system.</p>
<h3 id="clean-architecture-layers-with-fastapi"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#clean-architecture-layers-with-fastapi">Clean Architecture Layers with FastAPI</a></h3>
<p>Let's examine how FastAPI components map to Clean Architecture layers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>│                    Presentation Layer                       │
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>│  • FastAPI routers   • Request/Response models             │  
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>│  • Middleware        • Exception handlers                  │
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>│  • Dependency injection for controllers                    │
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>                                │
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>│                    Application Layer                        │
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>│  • Use case classes  • Command/Query handlers              │
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>│  • Service interfaces                                      │
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>│  • FastAPI dependencies for use case injection             │
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a>                                │
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>│                     Domain Layer                            │
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a>│  • Entities          • Value objects                       │
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a>│  • Domain services   • Repository interfaces               │
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a>│  • Business rules    • Domain events                       │
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a>                                │
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a>│                  Infrastructure Layer                       │
<a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a>│  • Repository implementations                               │
<a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a>│  • Database models   • External service clients            │
<a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a>│  • FastAPI dependencies for infrastructure injection       │
<a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a>└─────────────────────────────────────────────────────────────┘
</code></pre></div>
<p>This layering provides natural separation of concerns while leveraging FastAPI's strengths at each layer.</p>
<h3 id="presentation-layer-implementation"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#presentation-layer-implementation">Presentation Layer Implementation</a></h3>
<h4 id="router-organization"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#router-organization">Router Organization</a></h4>
<p>The clean-py repository organizes FastAPI routers by domain aggregate, maintaining clean boundaries:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="c1"># src/presentation/routers/orders.py</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..dependencies</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_order_service</span><span class="p">,</span> <span class="n">get_current_user</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateOrderRequest</span><span class="p">,</span> <span class="n">UpdateOrderRequest</span>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..models.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderResponse</span><span class="p">,</span> <span class="n">OrderListResponse</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...application.use_cases.orders</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>    <span class="n">CreateOrderUseCase</span><span class="p">,</span>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>    <span class="n">GetOrderUseCase</span><span class="p">,</span>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>    <span class="n">ListOrdersUseCase</span><span class="p">,</span>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a>    <span class="n">UpdateOrderUseCase</span>
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="p">)</span>
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.entities.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a><span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/orders&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;orders&quot;</span><span class="p">])</span>
<a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>
<a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">OrderResponse</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
<a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span>
<a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">CreateOrderRequest</span><span class="p">,</span>
<a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">),</span>
<a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>    <span class="n">create_order_use_case</span><span class="p">:</span> <span class="n">CreateOrderUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()</span>
<a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderResponse</span><span class="p">:</span>
<a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new order for the authenticated user.&quot;&quot;&quot;</span>
<a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a>
<a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a>        <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_order_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a>            <span class="n">order_data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
<a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a>            <span class="n">requesting_user</span><span class="o">=</span><span class="n">current_user</span>
<a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a>        <span class="p">)</span>
<a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a>        <span class="k">return</span> <span class="n">OrderResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a>
<a id="__codelineno-61-34" name="__codelineno-61-34" href="#__codelineno-61-34"></a>    <span class="k">except</span> <span class="n">OrderCreationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-61-35" name="__codelineno-61-35" href="#__codelineno-61-35"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-61-36" name="__codelineno-61-36" href="#__codelineno-61-36"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
<a id="__codelineno-61-37" name="__codelineno-61-37" href="#__codelineno-61-37"></a>            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-61-38" name="__codelineno-61-38" href="#__codelineno-61-38"></a>        <span class="p">)</span>
<a id="__codelineno-61-39" name="__codelineno-61-39" href="#__codelineno-61-39"></a>    <span class="k">except</span> <span class="n">InsufficientPermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-61-40" name="__codelineno-61-40" href="#__codelineno-61-40"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-61-41" name="__codelineno-61-41" href="#__codelineno-61-41"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
<a id="__codelineno-61-42" name="__codelineno-61-42" href="#__codelineno-61-42"></a>            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-61-43" name="__codelineno-61-43" href="#__codelineno-61-43"></a>        <span class="p">)</span>
<a id="__codelineno-61-44" name="__codelineno-61-44" href="#__codelineno-61-44"></a>
<a id="__codelineno-61-45" name="__codelineno-61-45" href="#__codelineno-61-45"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">{order_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">OrderResponse</span><span class="p">)</span>
<a id="__codelineno-61-46" name="__codelineno-61-46" href="#__codelineno-61-46"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_order</span><span class="p">(</span>
<a id="__codelineno-61-47" name="__codelineno-61-47" href="#__codelineno-61-47"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-61-48" name="__codelineno-61-48" href="#__codelineno-61-48"></a>    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">),</span>
<a id="__codelineno-61-49" name="__codelineno-61-49" href="#__codelineno-61-49"></a>    <span class="n">get_order_use_case</span><span class="p">:</span> <span class="n">GetOrderUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()</span>
<a id="__codelineno-61-50" name="__codelineno-61-50" href="#__codelineno-61-50"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderResponse</span><span class="p">:</span>
<a id="__codelineno-61-51" name="__codelineno-61-51" href="#__codelineno-61-51"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a specific order by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-61-52" name="__codelineno-61-52" href="#__codelineno-61-52"></a>
<a id="__codelineno-61-53" name="__codelineno-61-53" href="#__codelineno-61-53"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-61-54" name="__codelineno-61-54" href="#__codelineno-61-54"></a>        <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_order_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-61-55" name="__codelineno-61-55" href="#__codelineno-61-55"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-61-56" name="__codelineno-61-56" href="#__codelineno-61-56"></a>            <span class="n">requesting_user</span><span class="o">=</span><span class="n">current_user</span>
<a id="__codelineno-61-57" name="__codelineno-61-57" href="#__codelineno-61-57"></a>        <span class="p">)</span>
<a id="__codelineno-61-58" name="__codelineno-61-58" href="#__codelineno-61-58"></a>        <span class="k">return</span> <span class="n">OrderResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-61-59" name="__codelineno-61-59" href="#__codelineno-61-59"></a>
<a id="__codelineno-61-60" name="__codelineno-61-60" href="#__codelineno-61-60"></a>    <span class="k">except</span> <span class="n">OrderNotFoundError</span><span class="p">:</span>
<a id="__codelineno-61-61" name="__codelineno-61-61" href="#__codelineno-61-61"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-61-62" name="__codelineno-61-62" href="#__codelineno-61-62"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
<a id="__codelineno-61-63" name="__codelineno-61-63" href="#__codelineno-61-63"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Order not found&quot;</span>
<a id="__codelineno-61-64" name="__codelineno-61-64" href="#__codelineno-61-64"></a>        <span class="p">)</span>
<a id="__codelineno-61-65" name="__codelineno-61-65" href="#__codelineno-61-65"></a>
<a id="__codelineno-61-66" name="__codelineno-61-66" href="#__codelineno-61-66"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">OrderListResponse</span><span class="p">)</span>
<a id="__codelineno-61-67" name="__codelineno-61-67" href="#__codelineno-61-67"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_orders</span><span class="p">(</span>
<a id="__codelineno-61-68" name="__codelineno-61-68" href="#__codelineno-61-68"></a>    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-61-69" name="__codelineno-61-69" href="#__codelineno-61-69"></a>    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-61-70" name="__codelineno-61-70" href="#__codelineno-61-70"></a>    <span class="n">status_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-61-71" name="__codelineno-61-71" href="#__codelineno-61-71"></a>    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">),</span>
<a id="__codelineno-61-72" name="__codelineno-61-72" href="#__codelineno-61-72"></a>    <span class="n">list_orders_use_case</span><span class="p">:</span> <span class="n">ListOrdersUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()</span>
<a id="__codelineno-61-73" name="__codelineno-61-73" href="#__codelineno-61-73"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderListResponse</span><span class="p">:</span>
<a id="__codelineno-61-74" name="__codelineno-61-74" href="#__codelineno-61-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;List orders for the authenticated user.&quot;&quot;&quot;</span>
<a id="__codelineno-61-75" name="__codelineno-61-75" href="#__codelineno-61-75"></a>
<a id="__codelineno-61-76" name="__codelineno-61-76" href="#__codelineno-61-76"></a>    <span class="n">orders</span> <span class="o">=</span> <span class="k">await</span> <span class="n">list_orders_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-61-77" name="__codelineno-61-77" href="#__codelineno-61-77"></a>        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-61-78" name="__codelineno-61-78" href="#__codelineno-61-78"></a>        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
<a id="__codelineno-61-79" name="__codelineno-61-79" href="#__codelineno-61-79"></a>        <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
<a id="__codelineno-61-80" name="__codelineno-61-80" href="#__codelineno-61-80"></a>        <span class="n">status_filter</span><span class="o">=</span><span class="n">status_filter</span><span class="p">,</span>
<a id="__codelineno-61-81" name="__codelineno-61-81" href="#__codelineno-61-81"></a>        <span class="n">requesting_user</span><span class="o">=</span><span class="n">current_user</span>
<a id="__codelineno-61-82" name="__codelineno-61-82" href="#__codelineno-61-82"></a>    <span class="p">)</span>
<a id="__codelineno-61-83" name="__codelineno-61-83" href="#__codelineno-61-83"></a>
<a id="__codelineno-61-84" name="__codelineno-61-84" href="#__codelineno-61-84"></a>    <span class="k">return</span> <span class="n">OrderListResponse</span><span class="p">(</span>
<a id="__codelineno-61-85" name="__codelineno-61-85" href="#__codelineno-61-85"></a>        <span class="n">orders</span><span class="o">=</span><span class="p">[</span><span class="n">OrderResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="o">.</span><span class="n">items</span><span class="p">],</span>
<a id="__codelineno-61-86" name="__codelineno-61-86" href="#__codelineno-61-86"></a>        <span class="n">total</span><span class="o">=</span><span class="n">orders</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-61-87" name="__codelineno-61-87" href="#__codelineno-61-87"></a>        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
<a id="__codelineno-61-88" name="__codelineno-61-88" href="#__codelineno-61-88"></a>        <span class="n">offset</span><span class="o">=</span><span class="n">offset</span>
<a id="__codelineno-61-89" name="__codelineno-61-89" href="#__codelineno-61-89"></a>    <span class="p">)</span>
</code></pre></div>
<h4 id="requestresponse-models"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#requestresponse-models">Request/Response Models</a></h4>
<p>Pydantic models define the presentation layer contract, separate from domain entities:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c1"># src/presentation/models/requests.py</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderItemRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Product identifier&quot;</span><span class="p">)</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Item quantity&quot;</span><span class="p">)</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>    <span class="n">unit_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Decimal</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Override unit price&quot;</span><span class="p">)</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">)</span>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_unit_price</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unit price must be positive&#39;</span><span class="p">)</span>
<a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>        <span class="k">return</span> <span class="n">v</span>
<a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a>
<a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a><span class="k">class</span><span class="w"> </span><span class="nc">AddressRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a>    <span class="n">street_address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a>    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a>    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a>    <span class="n">postal_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a>    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a>
<a id="__codelineno-62-25" name="__codelineno-62-25" href="#__codelineno-62-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateOrderRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-62-26" name="__codelineno-62-26" href="#__codelineno-62-26"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItemRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_items</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-62-27" name="__codelineno-62-27" href="#__codelineno-62-27"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">AddressRequest</span>
<a id="__codelineno-62-28" name="__codelineno-62-28" href="#__codelineno-62-28"></a>    <span class="n">billing_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AddressRequest</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-62-29" name="__codelineno-62-29" href="#__codelineno-62-29"></a>    <span class="n">payment_method_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Payment method identifier&quot;</span><span class="p">)</span>
<a id="__codelineno-62-30" name="__codelineno-62-30" href="#__codelineno-62-30"></a>    <span class="n">discount_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-62-31" name="__codelineno-62-31" href="#__codelineno-62-31"></a>    <span class="n">special_instructions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<a id="__codelineno-62-32" name="__codelineno-62-32" href="#__codelineno-62-32"></a>
<a id="__codelineno-62-33" name="__codelineno-62-33" href="#__codelineno-62-33"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">)</span>
<a id="__codelineno-62-34" name="__codelineno-62-34" href="#__codelineno-62-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_items</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<a id="__codelineno-62-35" name="__codelineno-62-35" href="#__codelineno-62-35"></a>        <span class="c1"># Business validation at presentation layer</span>
<a id="__codelineno-62-36" name="__codelineno-62-36" href="#__codelineno-62-36"></a>        <span class="n">product_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">product_id</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
<a id="__codelineno-62-37" name="__codelineno-62-37" href="#__codelineno-62-37"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">product_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">product_ids</span><span class="p">)):</span>
<a id="__codelineno-62-38" name="__codelineno-62-38" href="#__codelineno-62-38"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Duplicate products not allowed&#39;</span><span class="p">)</span>
<a id="__codelineno-62-39" name="__codelineno-62-39" href="#__codelineno-62-39"></a>        <span class="k">return</span> <span class="n">items</span>
<a id="__codelineno-62-40" name="__codelineno-62-40" href="#__codelineno-62-40"></a>
<a id="__codelineno-62-41" name="__codelineno-62-41" href="#__codelineno-62-41"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<a id="__codelineno-62-42" name="__codelineno-62-42" href="#__codelineno-62-42"></a>        <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-62-43" name="__codelineno-62-43" href="#__codelineno-62-43"></a>            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-62-44" name="__codelineno-62-44" href="#__codelineno-62-44"></a>                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-62-45" name="__codelineno-62-45" href="#__codelineno-62-45"></a>                    <span class="p">{</span>
<a id="__codelineno-62-46" name="__codelineno-62-46" href="#__codelineno-62-46"></a>                        <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod_123&quot;</span><span class="p">,</span>
<a id="__codelineno-62-47" name="__codelineno-62-47" href="#__codelineno-62-47"></a>                        <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-62-48" name="__codelineno-62-48" href="#__codelineno-62-48"></a>                        <span class="s2">&quot;unit_price&quot;</span><span class="p">:</span> <span class="mf">29.99</span>
<a id="__codelineno-62-49" name="__codelineno-62-49" href="#__codelineno-62-49"></a>                    <span class="p">}</span>
<a id="__codelineno-62-50" name="__codelineno-62-50" href="#__codelineno-62-50"></a>                <span class="p">],</span>
<a id="__codelineno-62-51" name="__codelineno-62-51" href="#__codelineno-62-51"></a>                <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-62-52" name="__codelineno-62-52" href="#__codelineno-62-52"></a>                    <span class="s2">&quot;street_address&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-62-53" name="__codelineno-62-53" href="#__codelineno-62-53"></a>                    <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Seattle&quot;</span><span class="p">,</span>
<a id="__codelineno-62-54" name="__codelineno-62-54" href="#__codelineno-62-54"></a>                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;WA&quot;</span><span class="p">,</span> 
<a id="__codelineno-62-55" name="__codelineno-62-55" href="#__codelineno-62-55"></a>                    <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;98101&quot;</span><span class="p">,</span>
<a id="__codelineno-62-56" name="__codelineno-62-56" href="#__codelineno-62-56"></a>                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span>
<a id="__codelineno-62-57" name="__codelineno-62-57" href="#__codelineno-62-57"></a>                <span class="p">},</span>
<a id="__codelineno-62-58" name="__codelineno-62-58" href="#__codelineno-62-58"></a>                <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm_456&quot;</span><span class="p">,</span>
<a id="__codelineno-62-59" name="__codelineno-62-59" href="#__codelineno-62-59"></a>                <span class="s2">&quot;discount_code&quot;</span><span class="p">:</span> <span class="s2">&quot;SAVE10&quot;</span>
<a id="__codelineno-62-60" name="__codelineno-62-60" href="#__codelineno-62-60"></a>            <span class="p">}</span>
<a id="__codelineno-62-61" name="__codelineno-62-61" href="#__codelineno-62-61"></a>        <span class="p">}</span>
<a id="__codelineno-62-62" name="__codelineno-62-62" href="#__codelineno-62-62"></a>
<a id="__codelineno-62-63" name="__codelineno-62-63" href="#__codelineno-62-63"></a><span class="c1"># src/presentation/models/responses.py</span>
<a id="__codelineno-62-64" name="__codelineno-62-64" href="#__codelineno-62-64"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<a id="__codelineno-62-65" name="__codelineno-62-65" href="#__codelineno-62-65"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-62-66" name="__codelineno-62-66" href="#__codelineno-62-66"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-62-67" name="__codelineno-62-67" href="#__codelineno-62-67"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-62-68" name="__codelineno-62-68" href="#__codelineno-62-68"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-62-69" name="__codelineno-62-69" href="#__codelineno-62-69"></a>
<a id="__codelineno-62-70" name="__codelineno-62-70" href="#__codelineno-62-70"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-62-71" name="__codelineno-62-71" href="#__codelineno-62-71"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.value_objects.money</span><span class="w"> </span><span class="kn">import</span> <span class="n">Money</span>
<a id="__codelineno-62-72" name="__codelineno-62-72" href="#__codelineno-62-72"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.value_objects.address</span><span class="w"> </span><span class="kn">import</span> <span class="n">Address</span>
<a id="__codelineno-62-73" name="__codelineno-62-73" href="#__codelineno-62-73"></a>
<a id="__codelineno-62-74" name="__codelineno-62-74" href="#__codelineno-62-74"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-62-75" name="__codelineno-62-75" href="#__codelineno-62-75"></a>    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
<a id="__codelineno-62-76" name="__codelineno-62-76" href="#__codelineno-62-76"></a>    <span class="n">CONFIRMED</span> <span class="o">=</span> <span class="s2">&quot;confirmed&quot;</span>
<a id="__codelineno-62-77" name="__codelineno-62-77" href="#__codelineno-62-77"></a>    <span class="n">SHIPPED</span> <span class="o">=</span> <span class="s2">&quot;shipped&quot;</span>
<a id="__codelineno-62-78" name="__codelineno-62-78" href="#__codelineno-62-78"></a>    <span class="n">DELIVERED</span> <span class="o">=</span> <span class="s2">&quot;delivered&quot;</span>
<a id="__codelineno-62-79" name="__codelineno-62-79" href="#__codelineno-62-79"></a>    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
<a id="__codelineno-62-80" name="__codelineno-62-80" href="#__codelineno-62-80"></a>
<a id="__codelineno-62-81" name="__codelineno-62-81" href="#__codelineno-62-81"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderItemResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-62-82" name="__codelineno-62-82" href="#__codelineno-62-82"></a>    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-62-83" name="__codelineno-62-83" href="#__codelineno-62-83"></a>    <span class="n">product_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-62-84" name="__codelineno-62-84" href="#__codelineno-62-84"></a>    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-62-85" name="__codelineno-62-85" href="#__codelineno-62-85"></a>    <span class="n">unit_price</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-62-86" name="__codelineno-62-86" href="#__codelineno-62-86"></a>    <span class="n">total_price</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-62-87" name="__codelineno-62-87" href="#__codelineno-62-87"></a>
<a id="__codelineno-62-88" name="__codelineno-62-88" href="#__codelineno-62-88"></a><span class="k">class</span><span class="w"> </span><span class="nc">AddressResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-62-89" name="__codelineno-62-89" href="#__codelineno-62-89"></a>    <span class="n">street_address</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-62-90" name="__codelineno-62-90" href="#__codelineno-62-90"></a>    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-62-91" name="__codelineno-62-91" href="#__codelineno-62-91"></a>    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-62-92" name="__codelineno-62-92" href="#__codelineno-62-92"></a>    <span class="n">postal_code</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-62-93" name="__codelineno-62-93" href="#__codelineno-62-93"></a>    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-62-94" name="__codelineno-62-94" href="#__codelineno-62-94"></a>
<a id="__codelineno-62-95" name="__codelineno-62-95" href="#__codelineno-62-95"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-62-96" name="__codelineno-62-96" href="#__codelineno-62-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AddressResponse&#39;</span><span class="p">:</span>
<a id="__codelineno-62-97" name="__codelineno-62-97" href="#__codelineno-62-97"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-62-98" name="__codelineno-62-98" href="#__codelineno-62-98"></a>            <span class="n">street_address</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">street_address</span><span class="p">,</span>
<a id="__codelineno-62-99" name="__codelineno-62-99" href="#__codelineno-62-99"></a>            <span class="n">city</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">city</span><span class="p">,</span>
<a id="__codelineno-62-100" name="__codelineno-62-100" href="#__codelineno-62-100"></a>            <span class="n">state</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-62-101" name="__codelineno-62-101" href="#__codelineno-62-101"></a>            <span class="n">postal_code</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">postal_code</span><span class="p">,</span>
<a id="__codelineno-62-102" name="__codelineno-62-102" href="#__codelineno-62-102"></a>            <span class="n">country</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">country</span>
<a id="__codelineno-62-103" name="__codelineno-62-103" href="#__codelineno-62-103"></a>        <span class="p">)</span>
<a id="__codelineno-62-104" name="__codelineno-62-104" href="#__codelineno-62-104"></a>
<a id="__codelineno-62-105" name="__codelineno-62-105" href="#__codelineno-62-105"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-62-106" name="__codelineno-62-106" href="#__codelineno-62-106"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-62-107" name="__codelineno-62-107" href="#__codelineno-62-107"></a>    <span class="n">status</span><span class="p">:</span> <span class="n">OrderStatus</span>
<a id="__codelineno-62-108" name="__codelineno-62-108" href="#__codelineno-62-108"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItemResponse</span><span class="p">]</span>
<a id="__codelineno-62-109" name="__codelineno-62-109" href="#__codelineno-62-109"></a>    <span class="n">subtotal</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-62-110" name="__codelineno-62-110" href="#__codelineno-62-110"></a>    <span class="n">tax_amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-62-111" name="__codelineno-62-111" href="#__codelineno-62-111"></a>    <span class="n">shipping_cost</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-62-112" name="__codelineno-62-112" href="#__codelineno-62-112"></a>    <span class="n">discount_amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-62-113" name="__codelineno-62-113" href="#__codelineno-62-113"></a>    <span class="n">total_amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-62-114" name="__codelineno-62-114" href="#__codelineno-62-114"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-62-115" name="__codelineno-62-115" href="#__codelineno-62-115"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">AddressResponse</span>
<a id="__codelineno-62-116" name="__codelineno-62-116" href="#__codelineno-62-116"></a>    <span class="n">billing_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AddressResponse</span><span class="p">]</span>
<a id="__codelineno-62-117" name="__codelineno-62-117" href="#__codelineno-62-117"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-62-118" name="__codelineno-62-118" href="#__codelineno-62-118"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-62-119" name="__codelineno-62-119" href="#__codelineno-62-119"></a>
<a id="__codelineno-62-120" name="__codelineno-62-120" href="#__codelineno-62-120"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-62-121" name="__codelineno-62-121" href="#__codelineno-62-121"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderResponse&#39;</span><span class="p">:</span>
<a id="__codelineno-62-122" name="__codelineno-62-122" href="#__codelineno-62-122"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert domain entity to response model&quot;&quot;&quot;</span>
<a id="__codelineno-62-123" name="__codelineno-62-123" href="#__codelineno-62-123"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-62-124" name="__codelineno-62-124" href="#__codelineno-62-124"></a>            <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-62-125" name="__codelineno-62-125" href="#__codelineno-62-125"></a>            <span class="n">status</span><span class="o">=</span><span class="n">OrderStatus</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
<a id="__codelineno-62-126" name="__codelineno-62-126" href="#__codelineno-62-126"></a>            <span class="n">items</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-62-127" name="__codelineno-62-127" href="#__codelineno-62-127"></a>                <span class="n">OrderItemResponse</span><span class="p">(</span>
<a id="__codelineno-62-128" name="__codelineno-62-128" href="#__codelineno-62-128"></a>                    <span class="n">product_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">product_id</span><span class="p">),</span>
<a id="__codelineno-62-129" name="__codelineno-62-129" href="#__codelineno-62-129"></a>                    <span class="n">product_name</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">product_name</span><span class="p">,</span>
<a id="__codelineno-62-130" name="__codelineno-62-130" href="#__codelineno-62-130"></a>                    <span class="n">quantity</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-62-131" name="__codelineno-62-131" href="#__codelineno-62-131"></a>                    <span class="n">unit_price</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-62-132" name="__codelineno-62-132" href="#__codelineno-62-132"></a>                    <span class="n">total_price</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">total_price</span><span class="o">.</span><span class="n">amount</span>
<a id="__codelineno-62-133" name="__codelineno-62-133" href="#__codelineno-62-133"></a>                <span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span>
<a id="__codelineno-62-134" name="__codelineno-62-134" href="#__codelineno-62-134"></a>            <span class="p">],</span>
<a id="__codelineno-62-135" name="__codelineno-62-135" href="#__codelineno-62-135"></a>            <span class="n">subtotal</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">subtotal</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-62-136" name="__codelineno-62-136" href="#__codelineno-62-136"></a>            <span class="n">tax_amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">tax_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-62-137" name="__codelineno-62-137" href="#__codelineno-62-137"></a>            <span class="n">shipping_cost</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">shipping_cost</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-62-138" name="__codelineno-62-138" href="#__codelineno-62-138"></a>            <span class="n">discount_amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">discount_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-62-139" name="__codelineno-62-139" href="#__codelineno-62-139"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-62-140" name="__codelineno-62-140" href="#__codelineno-62-140"></a>            <span class="n">currency</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
<a id="__codelineno-62-141" name="__codelineno-62-141" href="#__codelineno-62-141"></a>            <span class="n">shipping_address</span><span class="o">=</span><span class="n">AddressResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">shipping_address</span><span class="p">),</span>
<a id="__codelineno-62-142" name="__codelineno-62-142" href="#__codelineno-62-142"></a>            <span class="n">billing_address</span><span class="o">=</span><span class="n">AddressResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">billing_address</span><span class="p">)</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">billing_address</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-62-143" name="__codelineno-62-143" href="#__codelineno-62-143"></a>            <span class="n">created_at</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-62-144" name="__codelineno-62-144" href="#__codelineno-62-144"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">updated_at</span>
<a id="__codelineno-62-145" name="__codelineno-62-145" href="#__codelineno-62-145"></a>        <span class="p">)</span>
<a id="__codelineno-62-146" name="__codelineno-62-146" href="#__codelineno-62-146"></a>
<a id="__codelineno-62-147" name="__codelineno-62-147" href="#__codelineno-62-147"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<a id="__codelineno-62-148" name="__codelineno-62-148" href="#__codelineno-62-148"></a>        <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-62-149" name="__codelineno-62-149" href="#__codelineno-62-149"></a>            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-62-150" name="__codelineno-62-150" href="#__codelineno-62-150"></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;ord_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-62-151" name="__codelineno-62-151" href="#__codelineno-62-151"></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;confirmed&quot;</span><span class="p">,</span>
<a id="__codelineno-62-152" name="__codelineno-62-152" href="#__codelineno-62-152"></a>                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-62-153" name="__codelineno-62-153" href="#__codelineno-62-153"></a>                    <span class="p">{</span>
<a id="__codelineno-62-154" name="__codelineno-62-154" href="#__codelineno-62-154"></a>                        <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod_123&quot;</span><span class="p">,</span>
<a id="__codelineno-62-155" name="__codelineno-62-155" href="#__codelineno-62-155"></a>                        <span class="s2">&quot;product_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Premium Widget&quot;</span><span class="p">,</span>
<a id="__codelineno-62-156" name="__codelineno-62-156" href="#__codelineno-62-156"></a>                        <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-62-157" name="__codelineno-62-157" href="#__codelineno-62-157"></a>                        <span class="s2">&quot;unit_price&quot;</span><span class="p">:</span> <span class="mf">29.99</span><span class="p">,</span>
<a id="__codelineno-62-158" name="__codelineno-62-158" href="#__codelineno-62-158"></a>                        <span class="s2">&quot;total_price&quot;</span><span class="p">:</span> <span class="mf">59.98</span>
<a id="__codelineno-62-159" name="__codelineno-62-159" href="#__codelineno-62-159"></a>                    <span class="p">}</span>
<a id="__codelineno-62-160" name="__codelineno-62-160" href="#__codelineno-62-160"></a>                <span class="p">],</span>
<a id="__codelineno-62-161" name="__codelineno-62-161" href="#__codelineno-62-161"></a>                <span class="s2">&quot;subtotal&quot;</span><span class="p">:</span> <span class="mf">59.98</span><span class="p">,</span>
<a id="__codelineno-62-162" name="__codelineno-62-162" href="#__codelineno-62-162"></a>                <span class="s2">&quot;tax_amount&quot;</span><span class="p">:</span> <span class="mf">4.80</span><span class="p">,</span>
<a id="__codelineno-62-163" name="__codelineno-62-163" href="#__codelineno-62-163"></a>                <span class="s2">&quot;shipping_cost&quot;</span><span class="p">:</span> <span class="mf">9.99</span><span class="p">,</span>
<a id="__codelineno-62-164" name="__codelineno-62-164" href="#__codelineno-62-164"></a>                <span class="s2">&quot;discount_amount&quot;</span><span class="p">:</span> <span class="mf">6.00</span><span class="p">,</span>
<a id="__codelineno-62-165" name="__codelineno-62-165" href="#__codelineno-62-165"></a>                <span class="s2">&quot;total_amount&quot;</span><span class="p">:</span> <span class="mf">68.77</span><span class="p">,</span>
<a id="__codelineno-62-166" name="__codelineno-62-166" href="#__codelineno-62-166"></a>                <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span>
<a id="__codelineno-62-167" name="__codelineno-62-167" href="#__codelineno-62-167"></a>            <span class="p">}</span>
<a id="__codelineno-62-168" name="__codelineno-62-168" href="#__codelineno-62-168"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="dependency-injection-for-clean-architecture"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#dependency-injection-for-clean-architecture">Dependency Injection for Clean Architecture</a></h3>
<p>FastAPI's dependency system beautifully implements dependency inversion:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="c1"># src/presentation/dependencies.py</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="c1"># Infrastructure dependencies</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_database</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Database</span><span class="p">:</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get database connection&quot;&quot;&quot;</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>    <span class="k">return</span> <span class="n">Database</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_redis</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Redis</span><span class="p">:</span>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get Redis client&quot;&quot;&quot;</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>    <span class="k">return</span> <span class="n">Redis</span><span class="p">(</span><span class="n">REDIS_URL</span><span class="p">)</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a>
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_event_bus</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">EventBus</span><span class="p">:</span>
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get event bus for domain events&quot;&quot;&quot;</span>
<a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>    <span class="k">return</span> <span class="n">EventBus</span><span class="p">()</span>
<a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a>
<a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a><span class="c1"># Repository dependencies</span>
<a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_order_repository</span><span class="p">(</span>
<a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderRepository</span><span class="p">:</span>
<a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get order repository implementation&quot;&quot;&quot;</span>
<a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a>    <span class="k">return</span> <span class="n">SQLOrderRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a>
<a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_product_repository</span><span class="p">(</span>
<a id="__codelineno-63-26" name="__codelineno-63-26" href="#__codelineno-63-26"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<a id="__codelineno-63-27" name="__codelineno-63-27" href="#__codelineno-63-27"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProductRepository</span><span class="p">:</span>
<a id="__codelineno-63-28" name="__codelineno-63-28" href="#__codelineno-63-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get product repository implementation&quot;&quot;&quot;</span>
<a id="__codelineno-63-29" name="__codelineno-63-29" href="#__codelineno-63-29"></a>    <span class="k">return</span> <span class="n">SQLProductRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<a id="__codelineno-63-30" name="__codelineno-63-30" href="#__codelineno-63-30"></a>
<a id="__codelineno-63-31" name="__codelineno-63-31" href="#__codelineno-63-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_repository</span><span class="p">(</span>
<a id="__codelineno-63-32" name="__codelineno-63-32" href="#__codelineno-63-32"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<a id="__codelineno-63-33" name="__codelineno-63-33" href="#__codelineno-63-33"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserRepository</span><span class="p">:</span>
<a id="__codelineno-63-34" name="__codelineno-63-34" href="#__codelineno-63-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get user repository implementation&quot;&quot;&quot;</span>
<a id="__codelineno-63-35" name="__codelineno-63-35" href="#__codelineno-63-35"></a>    <span class="k">return</span> <span class="n">SQLUserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<a id="__codelineno-63-36" name="__codelineno-63-36" href="#__codelineno-63-36"></a>
<a id="__codelineno-63-37" name="__codelineno-63-37" href="#__codelineno-63-37"></a><span class="c1"># Service dependencies</span>
<a id="__codelineno-63-38" name="__codelineno-63-38" href="#__codelineno-63-38"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_payment_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PaymentService</span><span class="p">:</span>
<a id="__codelineno-63-39" name="__codelineno-63-39" href="#__codelineno-63-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get payment service implementation&quot;&quot;&quot;</span>
<a id="__codelineno-63-40" name="__codelineno-63-40" href="#__codelineno-63-40"></a>    <span class="k">return</span> <span class="n">StripePaymentService</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_API_KEY</span><span class="p">)</span>
<a id="__codelineno-63-41" name="__codelineno-63-41" href="#__codelineno-63-41"></a>
<a id="__codelineno-63-42" name="__codelineno-63-42" href="#__codelineno-63-42"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_inventory_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">InventoryService</span><span class="p">:</span>
<a id="__codelineno-63-43" name="__codelineno-63-43" href="#__codelineno-63-43"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get inventory service implementation&quot;&quot;&quot;</span>
<a id="__codelineno-63-44" name="__codelineno-63-44" href="#__codelineno-63-44"></a>    <span class="k">return</span> <span class="n">InventoryService</span><span class="p">()</span>
<a id="__codelineno-63-45" name="__codelineno-63-45" href="#__codelineno-63-45"></a>
<a id="__codelineno-63-46" name="__codelineno-63-46" href="#__codelineno-63-46"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_notification_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">NotificationService</span><span class="p">:</span>
<a id="__codelineno-63-47" name="__codelineno-63-47" href="#__codelineno-63-47"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get notification service implementation&quot;&quot;&quot;</span>
<a id="__codelineno-63-48" name="__codelineno-63-48" href="#__codelineno-63-48"></a>    <span class="k">return</span> <span class="n">EmailNotificationService</span><span class="p">()</span>
<a id="__codelineno-63-49" name="__codelineno-63-49" href="#__codelineno-63-49"></a>
<a id="__codelineno-63-50" name="__codelineno-63-50" href="#__codelineno-63-50"></a><span class="c1"># Use case dependencies</span>
<a id="__codelineno-63-51" name="__codelineno-63-51" href="#__codelineno-63-51"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_create_order_use_case</span><span class="p">(</span>
<a id="__codelineno-63-52" name="__codelineno-63-52" href="#__codelineno-63-52"></a>    <span class="n">order_repo</span><span class="p">:</span> <span class="n">OrderRepository</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_order_repository</span><span class="p">),</span>
<a id="__codelineno-63-53" name="__codelineno-63-53" href="#__codelineno-63-53"></a>    <span class="n">product_repo</span><span class="p">:</span> <span class="n">ProductRepository</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_product_repository</span><span class="p">),</span>
<a id="__codelineno-63-54" name="__codelineno-63-54" href="#__codelineno-63-54"></a>    <span class="n">payment_service</span><span class="p">:</span> <span class="n">PaymentService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_payment_service</span><span class="p">),</span>
<a id="__codelineno-63-55" name="__codelineno-63-55" href="#__codelineno-63-55"></a>    <span class="n">inventory_service</span><span class="p">:</span> <span class="n">InventoryService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_inventory_service</span><span class="p">),</span>
<a id="__codelineno-63-56" name="__codelineno-63-56" href="#__codelineno-63-56"></a>    <span class="n">event_bus</span><span class="p">:</span> <span class="n">EventBus</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_event_bus</span><span class="p">)</span>
<a id="__codelineno-63-57" name="__codelineno-63-57" href="#__codelineno-63-57"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CreateOrderUseCase</span><span class="p">:</span>
<a id="__codelineno-63-58" name="__codelineno-63-58" href="#__codelineno-63-58"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get create order use case with all dependencies&quot;&quot;&quot;</span>
<a id="__codelineno-63-59" name="__codelineno-63-59" href="#__codelineno-63-59"></a>    <span class="k">return</span> <span class="n">CreateOrderUseCase</span><span class="p">(</span>
<a id="__codelineno-63-60" name="__codelineno-63-60" href="#__codelineno-63-60"></a>        <span class="n">order_repository</span><span class="o">=</span><span class="n">order_repo</span><span class="p">,</span>
<a id="__codelineno-63-61" name="__codelineno-63-61" href="#__codelineno-63-61"></a>        <span class="n">product_repository</span><span class="o">=</span><span class="n">product_repo</span><span class="p">,</span>
<a id="__codelineno-63-62" name="__codelineno-63-62" href="#__codelineno-63-62"></a>        <span class="n">payment_service</span><span class="o">=</span><span class="n">payment_service</span><span class="p">,</span>
<a id="__codelineno-63-63" name="__codelineno-63-63" href="#__codelineno-63-63"></a>        <span class="n">inventory_service</span><span class="o">=</span><span class="n">inventory_service</span><span class="p">,</span>
<a id="__codelineno-63-64" name="__codelineno-63-64" href="#__codelineno-63-64"></a>        <span class="n">event_bus</span><span class="o">=</span><span class="n">event_bus</span>
<a id="__codelineno-63-65" name="__codelineno-63-65" href="#__codelineno-63-65"></a>    <span class="p">)</span>
<a id="__codelineno-63-66" name="__codelineno-63-66" href="#__codelineno-63-66"></a>
<a id="__codelineno-63-67" name="__codelineno-63-67" href="#__codelineno-63-67"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_order_service</span><span class="p">(</span>
<a id="__codelineno-63-68" name="__codelineno-63-68" href="#__codelineno-63-68"></a>    <span class="n">order_repo</span><span class="p">:</span> <span class="n">OrderRepository</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_order_repository</span><span class="p">),</span>
<a id="__codelineno-63-69" name="__codelineno-63-69" href="#__codelineno-63-69"></a>    <span class="n">event_bus</span><span class="p">:</span> <span class="n">EventBus</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_event_bus</span><span class="p">)</span>
<a id="__codelineno-63-70" name="__codelineno-63-70" href="#__codelineno-63-70"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderService</span><span class="p">:</span>
<a id="__codelineno-63-71" name="__codelineno-63-71" href="#__codelineno-63-71"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get order service with dependencies&quot;&quot;&quot;</span>
<a id="__codelineno-63-72" name="__codelineno-63-72" href="#__codelineno-63-72"></a>    <span class="k">return</span> <span class="n">OrderService</span><span class="p">(</span>
<a id="__codelineno-63-73" name="__codelineno-63-73" href="#__codelineno-63-73"></a>        <span class="n">order_repository</span><span class="o">=</span><span class="n">order_repo</span><span class="p">,</span>
<a id="__codelineno-63-74" name="__codelineno-63-74" href="#__codelineno-63-74"></a>        <span class="n">event_bus</span><span class="o">=</span><span class="n">event_bus</span>
<a id="__codelineno-63-75" name="__codelineno-63-75" href="#__codelineno-63-75"></a>    <span class="p">)</span>
<a id="__codelineno-63-76" name="__codelineno-63-76" href="#__codelineno-63-76"></a>
<a id="__codelineno-63-77" name="__codelineno-63-77" href="#__codelineno-63-77"></a><span class="c1"># Authentication dependencies</span>
<a id="__codelineno-63-78" name="__codelineno-63-78" href="#__codelineno-63-78"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
<a id="__codelineno-63-79" name="__codelineno-63-79" href="#__codelineno-63-79"></a>    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">),</span>
<a id="__codelineno-63-80" name="__codelineno-63-80" href="#__codelineno-63-80"></a>    <span class="n">user_repo</span><span class="p">:</span> <span class="n">UserRepository</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_user_repository</span><span class="p">)</span>
<a id="__codelineno-63-81" name="__codelineno-63-81" href="#__codelineno-63-81"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
<a id="__codelineno-63-82" name="__codelineno-63-82" href="#__codelineno-63-82"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get currently authenticated user&quot;&quot;&quot;</span>
<a id="__codelineno-63-83" name="__codelineno-63-83" href="#__codelineno-63-83"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-63-84" name="__codelineno-63-84" href="#__codelineno-63-84"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
<a id="__codelineno-63-85" name="__codelineno-63-85" href="#__codelineno-63-85"></a>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
<a id="__codelineno-63-86" name="__codelineno-63-86" href="#__codelineno-63-86"></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-63-87" name="__codelineno-63-87" href="#__codelineno-63-87"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-63-88" name="__codelineno-63-88" href="#__codelineno-63-88"></a>                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
<a id="__codelineno-63-89" name="__codelineno-63-89" href="#__codelineno-63-89"></a>                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid authentication credentials&quot;</span>
<a id="__codelineno-63-90" name="__codelineno-63-90" href="#__codelineno-63-90"></a>            <span class="p">)</span>
<a id="__codelineno-63-91" name="__codelineno-63-91" href="#__codelineno-63-91"></a>    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
<a id="__codelineno-63-92" name="__codelineno-63-92" href="#__codelineno-63-92"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-63-93" name="__codelineno-63-93" href="#__codelineno-63-93"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
<a id="__codelineno-63-94" name="__codelineno-63-94" href="#__codelineno-63-94"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid authentication credentials&quot;</span>
<a id="__codelineno-63-95" name="__codelineno-63-95" href="#__codelineno-63-95"></a>        <span class="p">)</span>
<a id="__codelineno-63-96" name="__codelineno-63-96" href="#__codelineno-63-96"></a>
<a id="__codelineno-63-97" name="__codelineno-63-97" href="#__codelineno-63-97"></a>    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_repo</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-63-98" name="__codelineno-63-98" href="#__codelineno-63-98"></a>    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-63-99" name="__codelineno-63-99" href="#__codelineno-63-99"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-63-100" name="__codelineno-63-100" href="#__codelineno-63-100"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
<a id="__codelineno-63-101" name="__codelineno-63-101" href="#__codelineno-63-101"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span>
<a id="__codelineno-63-102" name="__codelineno-63-102" href="#__codelineno-63-102"></a>        <span class="p">)</span>
<a id="__codelineno-63-103" name="__codelineno-63-103" href="#__codelineno-63-103"></a>    <span class="k">return</span> <span class="n">user</span>
<a id="__codelineno-63-104" name="__codelineno-63-104" href="#__codelineno-63-104"></a>
<a id="__codelineno-63-105" name="__codelineno-63-105" href="#__codelineno-63-105"></a><span class="c1"># Type aliases for cleaner code</span>
<a id="__codelineno-63-106" name="__codelineno-63-106" href="#__codelineno-63-106"></a><span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]</span>
<a id="__codelineno-63-107" name="__codelineno-63-107" href="#__codelineno-63-107"></a><span class="n">CreateOrderUseCaseDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">CreateOrderUseCase</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_create_order_use_case</span><span class="p">)]</span>
</code></pre></div>
<h3 id="application-layer-integration"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#application-layer-integration">Application Layer Integration</a></h3>
<p>The application layer contains use cases that orchestrate business operations:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="c1"># src/application/use_cases/orders/create_order.py</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.entities.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.repositories.order_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderRepository</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.repositories.product_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProductRepository</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.services.payment_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentService</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.services.inventory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InventoryService</span>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...infrastructure.events.event_bus</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventBus</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.events.order_events</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderCreatedEvent</span>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="nd">@dataclass</span>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateOrderCommand</span><span class="p">:</span>
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a>    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a>    <span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a>    <span class="n">billing_address</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a>    <span class="n">payment_method_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a>    <span class="n">discount_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a>
<a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateOrderUseCase</span><span class="p">:</span>
<a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a>        <span class="n">order_repository</span><span class="p">:</span> <span class="n">OrderRepository</span><span class="p">,</span>
<a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a>        <span class="n">product_repository</span><span class="p">:</span> <span class="n">ProductRepository</span><span class="p">,</span>
<a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a>        <span class="n">payment_service</span><span class="p">:</span> <span class="n">PaymentService</span><span class="p">,</span>
<a id="__codelineno-64-29" name="__codelineno-64-29" href="#__codelineno-64-29"></a>        <span class="n">inventory_service</span><span class="p">:</span> <span class="n">InventoryService</span><span class="p">,</span>
<a id="__codelineno-64-30" name="__codelineno-64-30" href="#__codelineno-64-30"></a>        <span class="n">event_bus</span><span class="p">:</span> <span class="n">EventBus</span>
<a id="__codelineno-64-31" name="__codelineno-64-31" href="#__codelineno-64-31"></a>    <span class="p">):</span>
<a id="__codelineno-64-32" name="__codelineno-64-32" href="#__codelineno-64-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span> <span class="o">=</span> <span class="n">order_repository</span>
<a id="__codelineno-64-33" name="__codelineno-64-33" href="#__codelineno-64-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">product_repository</span> <span class="o">=</span> <span class="n">product_repository</span>
<a id="__codelineno-64-34" name="__codelineno-64-34" href="#__codelineno-64-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payment_service</span> <span class="o">=</span> <span class="n">payment_service</span>
<a id="__codelineno-64-35" name="__codelineno-64-35" href="#__codelineno-64-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span> <span class="o">=</span> <span class="n">inventory_service</span>
<a id="__codelineno-64-36" name="__codelineno-64-36" href="#__codelineno-64-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span> <span class="o">=</span> <span class="n">event_bus</span>
<a id="__codelineno-64-37" name="__codelineno-64-37" href="#__codelineno-64-37"></a>
<a id="__codelineno-64-38" name="__codelineno-64-38" href="#__codelineno-64-38"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-64-39" name="__codelineno-64-39" href="#__codelineno-64-39"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-64-40" name="__codelineno-64-40" href="#__codelineno-64-40"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-64-41" name="__codelineno-64-41" href="#__codelineno-64-41"></a>        <span class="n">order_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-64-42" name="__codelineno-64-42" href="#__codelineno-64-42"></a>        <span class="n">requesting_user</span><span class="p">:</span> <span class="n">User</span>
<a id="__codelineno-64-43" name="__codelineno-64-43" href="#__codelineno-64-43"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-64-44" name="__codelineno-64-44" href="#__codelineno-64-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute order creation use case&quot;&quot;&quot;</span>
<a id="__codelineno-64-45" name="__codelineno-64-45" href="#__codelineno-64-45"></a>
<a id="__codelineno-64-46" name="__codelineno-64-46" href="#__codelineno-64-46"></a>        <span class="c1"># Authorization check</span>
<a id="__codelineno-64-47" name="__codelineno-64-47" href="#__codelineno-64-47"></a>        <span class="k">if</span> <span class="n">requesting_user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">requesting_user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
<a id="__codelineno-64-48" name="__codelineno-64-48" href="#__codelineno-64-48"></a>            <span class="k">raise</span> <span class="n">InsufficientPermissionError</span><span class="p">(</span><span class="s2">&quot;Cannot create order for another user&quot;</span><span class="p">)</span>
<a id="__codelineno-64-49" name="__codelineno-64-49" href="#__codelineno-64-49"></a>
<a id="__codelineno-64-50" name="__codelineno-64-50" href="#__codelineno-64-50"></a>        <span class="c1"># Validate products exist and have sufficient inventory</span>
<a id="__codelineno-64-51" name="__codelineno-64-51" href="#__codelineno-64-51"></a>        <span class="n">product_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]]</span>
<a id="__codelineno-64-52" name="__codelineno-64-52" href="#__codelineno-64-52"></a>        <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_repository</span><span class="o">.</span><span class="n">get_by_ids</span><span class="p">(</span><span class="n">product_ids</span><span class="p">)</span>
<a id="__codelineno-64-53" name="__codelineno-64-53" href="#__codelineno-64-53"></a>
<a id="__codelineno-64-54" name="__codelineno-64-54" href="#__codelineno-64-54"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">product_ids</span><span class="p">):</span>
<a id="__codelineno-64-55" name="__codelineno-64-55" href="#__codelineno-64-55"></a>            <span class="n">missing_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">product_ids</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">}</span>
<a id="__codelineno-64-56" name="__codelineno-64-56" href="#__codelineno-64-56"></a>            <span class="k">raise</span> <span class="n">ProductNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Products not found: </span><span class="si">{</span><span class="n">missing_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-64-57" name="__codelineno-64-57" href="#__codelineno-64-57"></a>
<a id="__codelineno-64-58" name="__codelineno-64-58" href="#__codelineno-64-58"></a>        <span class="c1"># Check inventory</span>
<a id="__codelineno-64-59" name="__codelineno-64-59" href="#__codelineno-64-59"></a>        <span class="k">for</span> <span class="n">item_data</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
<a id="__codelineno-64-60" name="__codelineno-64-60" href="#__codelineno-64-60"></a>            <span class="n">product</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">item_data</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">])</span>
<a id="__codelineno-64-61" name="__codelineno-64-61" href="#__codelineno-64-61"></a>            <span class="n">available</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">check_availability</span><span class="p">(</span>
<a id="__codelineno-64-62" name="__codelineno-64-62" href="#__codelineno-64-62"></a>                <span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
<a id="__codelineno-64-63" name="__codelineno-64-63" href="#__codelineno-64-63"></a>                <span class="n">item_data</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
<a id="__codelineno-64-64" name="__codelineno-64-64" href="#__codelineno-64-64"></a>            <span class="p">)</span>
<a id="__codelineno-64-65" name="__codelineno-64-65" href="#__codelineno-64-65"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">available</span><span class="p">:</span>
<a id="__codelineno-64-66" name="__codelineno-64-66" href="#__codelineno-64-66"></a>                <span class="k">raise</span> <span class="n">InsufficientInventoryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient inventory for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-64-67" name="__codelineno-64-67" href="#__codelineno-64-67"></a>
<a id="__codelineno-64-68" name="__codelineno-64-68" href="#__codelineno-64-68"></a>        <span class="c1"># Create order domain entity</span>
<a id="__codelineno-64-69" name="__codelineno-64-69" href="#__codelineno-64-69"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-64-70" name="__codelineno-64-70" href="#__codelineno-64-70"></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-64-71" name="__codelineno-64-71" href="#__codelineno-64-71"></a>            <span class="n">items_data</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">],</span>
<a id="__codelineno-64-72" name="__codelineno-64-72" href="#__codelineno-64-72"></a>            <span class="n">products</span><span class="o">=</span><span class="n">products</span><span class="p">,</span>
<a id="__codelineno-64-73" name="__codelineno-64-73" href="#__codelineno-64-73"></a>            <span class="n">shipping_address</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;shipping_address&#39;</span><span class="p">],</span>
<a id="__codelineno-64-74" name="__codelineno-64-74" href="#__codelineno-64-74"></a>            <span class="n">billing_address</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;billing_address&#39;</span><span class="p">),</span>
<a id="__codelineno-64-75" name="__codelineno-64-75" href="#__codelineno-64-75"></a>            <span class="n">payment_method_id</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;payment_method_id&#39;</span><span class="p">],</span>
<a id="__codelineno-64-76" name="__codelineno-64-76" href="#__codelineno-64-76"></a>            <span class="n">discount_code</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discount_code&#39;</span><span class="p">)</span>
<a id="__codelineno-64-77" name="__codelineno-64-77" href="#__codelineno-64-77"></a>        <span class="p">)</span>
<a id="__codelineno-64-78" name="__codelineno-64-78" href="#__codelineno-64-78"></a>
<a id="__codelineno-64-79" name="__codelineno-64-79" href="#__codelineno-64-79"></a>        <span class="c1"># Reserve inventory</span>
<a id="__codelineno-64-80" name="__codelineno-64-80" href="#__codelineno-64-80"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<a id="__codelineno-64-81" name="__codelineno-64-81" href="#__codelineno-64-81"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">reserve_inventory</span><span class="p">(</span>
<a id="__codelineno-64-82" name="__codelineno-64-82" href="#__codelineno-64-82"></a>                <span class="n">item</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span>
<a id="__codelineno-64-83" name="__codelineno-64-83" href="#__codelineno-64-83"></a>                <span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-64-84" name="__codelineno-64-84" href="#__codelineno-64-84"></a>                <span class="n">order</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-64-85" name="__codelineno-64-85" href="#__codelineno-64-85"></a>            <span class="p">)</span>
<a id="__codelineno-64-86" name="__codelineno-64-86" href="#__codelineno-64-86"></a>
<a id="__codelineno-64-87" name="__codelineno-64-87" href="#__codelineno-64-87"></a>        <span class="c1"># Process payment</span>
<a id="__codelineno-64-88" name="__codelineno-64-88" href="#__codelineno-64-88"></a>        <span class="n">payment_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_service</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
<a id="__codelineno-64-89" name="__codelineno-64-89" href="#__codelineno-64-89"></a>            <span class="n">amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="p">,</span>
<a id="__codelineno-64-90" name="__codelineno-64-90" href="#__codelineno-64-90"></a>            <span class="n">payment_method_id</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;payment_method_id&#39;</span><span class="p">],</span>
<a id="__codelineno-64-91" name="__codelineno-64-91" href="#__codelineno-64-91"></a>            <span class="n">order_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-64-92" name="__codelineno-64-92" href="#__codelineno-64-92"></a>        <span class="p">)</span>
<a id="__codelineno-64-93" name="__codelineno-64-93" href="#__codelineno-64-93"></a>
<a id="__codelineno-64-94" name="__codelineno-64-94" href="#__codelineno-64-94"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">payment_result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
<a id="__codelineno-64-95" name="__codelineno-64-95" href="#__codelineno-64-95"></a>            <span class="c1"># Release reserved inventory</span>
<a id="__codelineno-64-96" name="__codelineno-64-96" href="#__codelineno-64-96"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release_inventory</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-64-97" name="__codelineno-64-97" href="#__codelineno-64-97"></a>            <span class="k">raise</span> <span class="n">PaymentProcessingError</span><span class="p">(</span><span class="n">payment_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
<a id="__codelineno-64-98" name="__codelineno-64-98" href="#__codelineno-64-98"></a>
<a id="__codelineno-64-99" name="__codelineno-64-99" href="#__codelineno-64-99"></a>        <span class="c1"># Save order</span>
<a id="__codelineno-64-100" name="__codelineno-64-100" href="#__codelineno-64-100"></a>        <span class="n">saved_order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-64-101" name="__codelineno-64-101" href="#__codelineno-64-101"></a>
<a id="__codelineno-64-102" name="__codelineno-64-102" href="#__codelineno-64-102"></a>        <span class="c1"># Publish domain event</span>
<a id="__codelineno-64-103" name="__codelineno-64-103" href="#__codelineno-64-103"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
<a id="__codelineno-64-104" name="__codelineno-64-104" href="#__codelineno-64-104"></a>            <span class="n">OrderCreatedEvent</span><span class="p">(</span>
<a id="__codelineno-64-105" name="__codelineno-64-105" href="#__codelineno-64-105"></a>                <span class="n">order_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">saved_order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-64-106" name="__codelineno-64-106" href="#__codelineno-64-106"></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">saved_order</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-64-107" name="__codelineno-64-107" href="#__codelineno-64-107"></a>                <span class="n">total_amount</span><span class="o">=</span><span class="n">saved_order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-64-108" name="__codelineno-64-108" href="#__codelineno-64-108"></a>                <span class="n">currency</span><span class="o">=</span><span class="n">saved_order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">currency</span>
<a id="__codelineno-64-109" name="__codelineno-64-109" href="#__codelineno-64-109"></a>            <span class="p">)</span>
<a id="__codelineno-64-110" name="__codelineno-64-110" href="#__codelineno-64-110"></a>        <span class="p">)</span>
<a id="__codelineno-64-111" name="__codelineno-64-111" href="#__codelineno-64-111"></a>
<a id="__codelineno-64-112" name="__codelineno-64-112" href="#__codelineno-64-112"></a>        <span class="k">return</span> <span class="n">saved_order</span>
<a id="__codelineno-64-113" name="__codelineno-64-113" href="#__codelineno-64-113"></a>
<a id="__codelineno-64-114" name="__codelineno-64-114" href="#__codelineno-64-114"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_release_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>
<a id="__codelineno-64-115" name="__codelineno-64-115" href="#__codelineno-64-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Release reserved inventory in case of failure&quot;&quot;&quot;</span>
<a id="__codelineno-64-116" name="__codelineno-64-116" href="#__codelineno-64-116"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<a id="__codelineno-64-117" name="__codelineno-64-117" href="#__codelineno-64-117"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-64-118" name="__codelineno-64-118" href="#__codelineno-64-118"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">release_reservation</span><span class="p">(</span>
<a id="__codelineno-64-119" name="__codelineno-64-119" href="#__codelineno-64-119"></a>                    <span class="n">item</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span>
<a id="__codelineno-64-120" name="__codelineno-64-120" href="#__codelineno-64-120"></a>                    <span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-64-121" name="__codelineno-64-121" href="#__codelineno-64-121"></a>                    <span class="n">order</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-64-122" name="__codelineno-64-122" href="#__codelineno-64-122"></a>                <span class="p">)</span>
<a id="__codelineno-64-123" name="__codelineno-64-123" href="#__codelineno-64-123"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-64-124" name="__codelineno-64-124" href="#__codelineno-64-124"></a>                <span class="c1"># Log but don&#39;t fail the operation</span>
<a id="__codelineno-64-125" name="__codelineno-64-125" href="#__codelineno-64-125"></a>                <span class="k">pass</span>
</code></pre></div>
<h3 id="middleware-and-error-handling"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#middleware-and-error-handling">Middleware and Error Handling</a></h3>
<p>FastAPI middleware integrates cleanly with Clean Architecture concerns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="c1"># src/presentation/middleware/logging_middleware.py</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...infrastructure.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">RequestLoggingMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>        <span class="c1"># Generate correlation ID</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a>        <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>        <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">correlation_id</span> <span class="o">=</span> <span class="n">correlation_id</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a>        <span class="c1"># Log request</span>
<a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a>            <span class="s2">&quot;Request started&quot;</span><span class="p">,</span>
<a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-22" name="__codelineno-65-22" href="#__codelineno-65-22"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-65-23" name="__codelineno-65-23" href="#__codelineno-65-23"></a>                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
<a id="__codelineno-65-24" name="__codelineno-65-24" href="#__codelineno-65-24"></a>                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
<a id="__codelineno-65-25" name="__codelineno-65-25" href="#__codelineno-65-25"></a>                <span class="s2">&quot;client_ip&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
<a id="__codelineno-65-26" name="__codelineno-65-26" href="#__codelineno-65-26"></a>                <span class="s2">&quot;user_agent&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">),</span>
<a id="__codelineno-65-27" name="__codelineno-65-27" href="#__codelineno-65-27"></a>                <span class="s2">&quot;content_length&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">)</span>
<a id="__codelineno-65-28" name="__codelineno-65-28" href="#__codelineno-65-28"></a>            <span class="p">}</span>
<a id="__codelineno-65-29" name="__codelineno-65-29" href="#__codelineno-65-29"></a>        <span class="p">)</span>
<a id="__codelineno-65-30" name="__codelineno-65-30" href="#__codelineno-65-30"></a>
<a id="__codelineno-65-31" name="__codelineno-65-31" href="#__codelineno-65-31"></a>        <span class="c1"># Process request</span>
<a id="__codelineno-65-32" name="__codelineno-65-32" href="#__codelineno-65-32"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-65-33" name="__codelineno-65-33" href="#__codelineno-65-33"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-65-34" name="__codelineno-65-34" href="#__codelineno-65-34"></a>            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-65-35" name="__codelineno-65-35" href="#__codelineno-65-35"></a>
<a id="__codelineno-65-36" name="__codelineno-65-36" href="#__codelineno-65-36"></a>            <span class="c1"># Log response</span>
<a id="__codelineno-65-37" name="__codelineno-65-37" href="#__codelineno-65-37"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-65-38" name="__codelineno-65-38" href="#__codelineno-65-38"></a>                <span class="s2">&quot;Request completed&quot;</span><span class="p">,</span>
<a id="__codelineno-65-39" name="__codelineno-65-39" href="#__codelineno-65-39"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-40" name="__codelineno-65-40" href="#__codelineno-65-40"></a>                    <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-65-41" name="__codelineno-65-41" href="#__codelineno-65-41"></a>                    <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
<a id="__codelineno-65-42" name="__codelineno-65-42" href="#__codelineno-65-42"></a>                    <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-65-43" name="__codelineno-65-43" href="#__codelineno-65-43"></a>                    <span class="s2">&quot;response_size&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">)</span>
<a id="__codelineno-65-44" name="__codelineno-65-44" href="#__codelineno-65-44"></a>                <span class="p">}</span>
<a id="__codelineno-65-45" name="__codelineno-65-45" href="#__codelineno-65-45"></a>            <span class="p">)</span>
<a id="__codelineno-65-46" name="__codelineno-65-46" href="#__codelineno-65-46"></a>
<a id="__codelineno-65-47" name="__codelineno-65-47" href="#__codelineno-65-47"></a>            <span class="c1"># Add correlation ID to response headers</span>
<a id="__codelineno-65-48" name="__codelineno-65-48" href="#__codelineno-65-48"></a>            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Correlation-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlation_id</span>
<a id="__codelineno-65-49" name="__codelineno-65-49" href="#__codelineno-65-49"></a>            <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-65-50" name="__codelineno-65-50" href="#__codelineno-65-50"></a>
<a id="__codelineno-65-51" name="__codelineno-65-51" href="#__codelineno-65-51"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-65-52" name="__codelineno-65-52" href="#__codelineno-65-52"></a>            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-65-53" name="__codelineno-65-53" href="#__codelineno-65-53"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-65-54" name="__codelineno-65-54" href="#__codelineno-65-54"></a>                <span class="s2">&quot;Request failed&quot;</span><span class="p">,</span>
<a id="__codelineno-65-55" name="__codelineno-65-55" href="#__codelineno-65-55"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-56" name="__codelineno-65-56" href="#__codelineno-65-56"></a>                    <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-65-57" name="__codelineno-65-57" href="#__codelineno-65-57"></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-65-58" name="__codelineno-65-58" href="#__codelineno-65-58"></a>                    <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-65-59" name="__codelineno-65-59" href="#__codelineno-65-59"></a>                    <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-65-60" name="__codelineno-65-60" href="#__codelineno-65-60"></a>                <span class="p">},</span>
<a id="__codelineno-65-61" name="__codelineno-65-61" href="#__codelineno-65-61"></a>                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-65-62" name="__codelineno-65-62" href="#__codelineno-65-62"></a>            <span class="p">)</span>
<a id="__codelineno-65-63" name="__codelineno-65-63" href="#__codelineno-65-63"></a>            <span class="k">raise</span>
<a id="__codelineno-65-64" name="__codelineno-65-64" href="#__codelineno-65-64"></a>
<a id="__codelineno-65-65" name="__codelineno-65-65" href="#__codelineno-65-65"></a><span class="c1"># src/presentation/middleware/exception_handlers.py</span>
<a id="__codelineno-65-66" name="__codelineno-65-66" href="#__codelineno-65-66"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span>
<a id="__codelineno-65-67" name="__codelineno-65-67" href="#__codelineno-65-67"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<a id="__codelineno-65-68" name="__codelineno-65-68" href="#__codelineno-65-68"></a><span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<a id="__codelineno-65-69" name="__codelineno-65-69" href="#__codelineno-65-69"></a>
<a id="__codelineno-65-70" name="__codelineno-65-70" href="#__codelineno-65-70"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-65-71" name="__codelineno-65-71" href="#__codelineno-65-71"></a>    <span class="n">DomainException</span><span class="p">,</span>
<a id="__codelineno-65-72" name="__codelineno-65-72" href="#__codelineno-65-72"></a>    <span class="n">OrderNotFoundError</span><span class="p">,</span>
<a id="__codelineno-65-73" name="__codelineno-65-73" href="#__codelineno-65-73"></a>    <span class="n">InsufficientInventoryError</span><span class="p">,</span>
<a id="__codelineno-65-74" name="__codelineno-65-74" href="#__codelineno-65-74"></a>    <span class="n">PaymentProcessingError</span>
<a id="__codelineno-65-75" name="__codelineno-65-75" href="#__codelineno-65-75"></a><span class="p">)</span>
<a id="__codelineno-65-76" name="__codelineno-65-76" href="#__codelineno-65-76"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...infrastructure.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<a id="__codelineno-65-77" name="__codelineno-65-77" href="#__codelineno-65-77"></a>
<a id="__codelineno-65-78" name="__codelineno-65-78" href="#__codelineno-65-78"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-65-79" name="__codelineno-65-79" href="#__codelineno-65-79"></a>
<a id="__codelineno-65-80" name="__codelineno-65-80" href="#__codelineno-65-80"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">domain_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">DomainException</span><span class="p">):</span>
<a id="__codelineno-65-81" name="__codelineno-65-81" href="#__codelineno-65-81"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle domain-specific exceptions&quot;&quot;&quot;</span>
<a id="__codelineno-65-82" name="__codelineno-65-82" href="#__codelineno-65-82"></a>    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;correlation_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<a id="__codelineno-65-83" name="__codelineno-65-83" href="#__codelineno-65-83"></a>
<a id="__codelineno-65-84" name="__codelineno-65-84" href="#__codelineno-65-84"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-65-85" name="__codelineno-65-85" href="#__codelineno-65-85"></a>        <span class="s2">&quot;Domain exception occurred&quot;</span><span class="p">,</span>
<a id="__codelineno-65-86" name="__codelineno-65-86" href="#__codelineno-65-86"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-87" name="__codelineno-65-87" href="#__codelineno-65-87"></a>            <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-65-88" name="__codelineno-65-88" href="#__codelineno-65-88"></a>            <span class="s2">&quot;exception_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-65-89" name="__codelineno-65-89" href="#__codelineno-65-89"></a>            <span class="s2">&quot;exception_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
<a id="__codelineno-65-90" name="__codelineno-65-90" href="#__codelineno-65-90"></a>            <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
<a id="__codelineno-65-91" name="__codelineno-65-91" href="#__codelineno-65-91"></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span>
<a id="__codelineno-65-92" name="__codelineno-65-92" href="#__codelineno-65-92"></a>        <span class="p">}</span>
<a id="__codelineno-65-93" name="__codelineno-65-93" href="#__codelineno-65-93"></a>    <span class="p">)</span>
<a id="__codelineno-65-94" name="__codelineno-65-94" href="#__codelineno-65-94"></a>
<a id="__codelineno-65-95" name="__codelineno-65-95" href="#__codelineno-65-95"></a>    <span class="c1"># Map domain exceptions to HTTP status codes</span>
<a id="__codelineno-65-96" name="__codelineno-65-96" href="#__codelineno-65-96"></a>    <span class="n">status_code_mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-65-97" name="__codelineno-65-97" href="#__codelineno-65-97"></a>        <span class="n">OrderNotFoundError</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span>
<a id="__codelineno-65-98" name="__codelineno-65-98" href="#__codelineno-65-98"></a>        <span class="n">InsufficientInventoryError</span><span class="p">:</span> <span class="mi">409</span><span class="p">,</span>
<a id="__codelineno-65-99" name="__codelineno-65-99" href="#__codelineno-65-99"></a>        <span class="n">PaymentProcessingError</span><span class="p">:</span> <span class="mi">402</span><span class="p">,</span>
<a id="__codelineno-65-100" name="__codelineno-65-100" href="#__codelineno-65-100"></a>    <span class="p">}</span>
<a id="__codelineno-65-101" name="__codelineno-65-101" href="#__codelineno-65-101"></a>
<a id="__codelineno-65-102" name="__codelineno-65-102" href="#__codelineno-65-102"></a>    <span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>
<a id="__codelineno-65-103" name="__codelineno-65-103" href="#__codelineno-65-103"></a>
<a id="__codelineno-65-104" name="__codelineno-65-104" href="#__codelineno-65-104"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
<a id="__codelineno-65-105" name="__codelineno-65-105" href="#__codelineno-65-105"></a>        <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span>
<a id="__codelineno-65-106" name="__codelineno-65-106" href="#__codelineno-65-106"></a>        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-107" name="__codelineno-65-107" href="#__codelineno-65-107"></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-65-108" name="__codelineno-65-108" href="#__codelineno-65-108"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-65-109" name="__codelineno-65-109" href="#__codelineno-65-109"></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
<a id="__codelineno-65-110" name="__codelineno-65-110" href="#__codelineno-65-110"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span>
<a id="__codelineno-65-111" name="__codelineno-65-111" href="#__codelineno-65-111"></a>            <span class="p">}</span>
<a id="__codelineno-65-112" name="__codelineno-65-112" href="#__codelineno-65-112"></a>        <span class="p">}</span>
<a id="__codelineno-65-113" name="__codelineno-65-113" href="#__codelineno-65-113"></a>    <span class="p">)</span>
<a id="__codelineno-65-114" name="__codelineno-65-114" href="#__codelineno-65-114"></a>
<a id="__codelineno-65-115" name="__codelineno-65-115" href="#__codelineno-65-115"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validation_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">ValidationError</span><span class="p">):</span>
<a id="__codelineno-65-116" name="__codelineno-65-116" href="#__codelineno-65-116"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle validation errors from Pydantic&quot;&quot;&quot;</span>
<a id="__codelineno-65-117" name="__codelineno-65-117" href="#__codelineno-65-117"></a>    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;correlation_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<a id="__codelineno-65-118" name="__codelineno-65-118" href="#__codelineno-65-118"></a>
<a id="__codelineno-65-119" name="__codelineno-65-119" href="#__codelineno-65-119"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-65-120" name="__codelineno-65-120" href="#__codelineno-65-120"></a>        <span class="s2">&quot;Validation error occurred&quot;</span><span class="p">,</span>
<a id="__codelineno-65-121" name="__codelineno-65-121" href="#__codelineno-65-121"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-122" name="__codelineno-65-122" href="#__codelineno-65-122"></a>            <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-65-123" name="__codelineno-65-123" href="#__codelineno-65-123"></a>            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">(),</span>
<a id="__codelineno-65-124" name="__codelineno-65-124" href="#__codelineno-65-124"></a>            <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
<a id="__codelineno-65-125" name="__codelineno-65-125" href="#__codelineno-65-125"></a>        <span class="p">}</span>
<a id="__codelineno-65-126" name="__codelineno-65-126" href="#__codelineno-65-126"></a>    <span class="p">)</span>
<a id="__codelineno-65-127" name="__codelineno-65-127" href="#__codelineno-65-127"></a>
<a id="__codelineno-65-128" name="__codelineno-65-128" href="#__codelineno-65-128"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
<a id="__codelineno-65-129" name="__codelineno-65-129" href="#__codelineno-65-129"></a>        <span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span>
<a id="__codelineno-65-130" name="__codelineno-65-130" href="#__codelineno-65-130"></a>        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-131" name="__codelineno-65-131" href="#__codelineno-65-131"></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-65-132" name="__codelineno-65-132" href="#__codelineno-65-132"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ValidationError&quot;</span><span class="p">,</span>
<a id="__codelineno-65-133" name="__codelineno-65-133" href="#__codelineno-65-133"></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Request validation failed&quot;</span><span class="p">,</span>
<a id="__codelineno-65-134" name="__codelineno-65-134" href="#__codelineno-65-134"></a>                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">(),</span>
<a id="__codelineno-65-135" name="__codelineno-65-135" href="#__codelineno-65-135"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span>
<a id="__codelineno-65-136" name="__codelineno-65-136" href="#__codelineno-65-136"></a>            <span class="p">}</span>
<a id="__codelineno-65-137" name="__codelineno-65-137" href="#__codelineno-65-137"></a>        <span class="p">}</span>
<a id="__codelineno-65-138" name="__codelineno-65-138" href="#__codelineno-65-138"></a>    <span class="p">)</span>
<a id="__codelineno-65-139" name="__codelineno-65-139" href="#__codelineno-65-139"></a>
<a id="__codelineno-65-140" name="__codelineno-65-140" href="#__codelineno-65-140"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">http_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">HTTPException</span><span class="p">):</span>
<a id="__codelineno-65-141" name="__codelineno-65-141" href="#__codelineno-65-141"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle FastAPI HTTP exceptions&quot;&quot;&quot;</span>
<a id="__codelineno-65-142" name="__codelineno-65-142" href="#__codelineno-65-142"></a>    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;correlation_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<a id="__codelineno-65-143" name="__codelineno-65-143" href="#__codelineno-65-143"></a>
<a id="__codelineno-65-144" name="__codelineno-65-144" href="#__codelineno-65-144"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
<a id="__codelineno-65-145" name="__codelineno-65-145" href="#__codelineno-65-145"></a>        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
<a id="__codelineno-65-146" name="__codelineno-65-146" href="#__codelineno-65-146"></a>        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-147" name="__codelineno-65-147" href="#__codelineno-65-147"></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-65-148" name="__codelineno-65-148" href="#__codelineno-65-148"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTPException&quot;</span><span class="p">,</span>
<a id="__codelineno-65-149" name="__codelineno-65-149" href="#__codelineno-65-149"></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span>
<a id="__codelineno-65-150" name="__codelineno-65-150" href="#__codelineno-65-150"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span>
<a id="__codelineno-65-151" name="__codelineno-65-151" href="#__codelineno-65-151"></a>            <span class="p">}</span>
<a id="__codelineno-65-152" name="__codelineno-65-152" href="#__codelineno-65-152"></a>        <span class="p">}</span>
<a id="__codelineno-65-153" name="__codelineno-65-153" href="#__codelineno-65-153"></a>    <span class="p">)</span>
<a id="__codelineno-65-154" name="__codelineno-65-154" href="#__codelineno-65-154"></a>
<a id="__codelineno-65-155" name="__codelineno-65-155" href="#__codelineno-65-155"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">internal_server_error_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-65-156" name="__codelineno-65-156" href="#__codelineno-65-156"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle unexpected server errors&quot;&quot;&quot;</span>
<a id="__codelineno-65-157" name="__codelineno-65-157" href="#__codelineno-65-157"></a>    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;correlation_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<a id="__codelineno-65-158" name="__codelineno-65-158" href="#__codelineno-65-158"></a>
<a id="__codelineno-65-159" name="__codelineno-65-159" href="#__codelineno-65-159"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-65-160" name="__codelineno-65-160" href="#__codelineno-65-160"></a>        <span class="s2">&quot;Unexpected server error&quot;</span><span class="p">,</span>
<a id="__codelineno-65-161" name="__codelineno-65-161" href="#__codelineno-65-161"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-162" name="__codelineno-65-162" href="#__codelineno-65-162"></a>            <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-65-163" name="__codelineno-65-163" href="#__codelineno-65-163"></a>            <span class="s2">&quot;exception_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-65-164" name="__codelineno-65-164" href="#__codelineno-65-164"></a>            <span class="s2">&quot;exception_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
<a id="__codelineno-65-165" name="__codelineno-65-165" href="#__codelineno-65-165"></a>            <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
<a id="__codelineno-65-166" name="__codelineno-65-166" href="#__codelineno-65-166"></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
<a id="__codelineno-65-167" name="__codelineno-65-167" href="#__codelineno-65-167"></a>            <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
<a id="__codelineno-65-168" name="__codelineno-65-168" href="#__codelineno-65-168"></a>        <span class="p">}</span>
<a id="__codelineno-65-169" name="__codelineno-65-169" href="#__codelineno-65-169"></a>    <span class="p">)</span>
<a id="__codelineno-65-170" name="__codelineno-65-170" href="#__codelineno-65-170"></a>
<a id="__codelineno-65-171" name="__codelineno-65-171" href="#__codelineno-65-171"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
<a id="__codelineno-65-172" name="__codelineno-65-172" href="#__codelineno-65-172"></a>        <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
<a id="__codelineno-65-173" name="__codelineno-65-173" href="#__codelineno-65-173"></a>        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-65-174" name="__codelineno-65-174" href="#__codelineno-65-174"></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-65-175" name="__codelineno-65-175" href="#__codelineno-65-175"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InternalServerError&quot;</span><span class="p">,</span>
<a id="__codelineno-65-176" name="__codelineno-65-176" href="#__codelineno-65-176"></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;An unexpected error occurred&quot;</span><span class="p">,</span>
<a id="__codelineno-65-177" name="__codelineno-65-177" href="#__codelineno-65-177"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span>
<a id="__codelineno-65-178" name="__codelineno-65-178" href="#__codelineno-65-178"></a>            <span class="p">}</span>
<a id="__codelineno-65-179" name="__codelineno-65-179" href="#__codelineno-65-179"></a>        <span class="p">}</span>
<a id="__codelineno-65-180" name="__codelineno-65-180" href="#__codelineno-65-180"></a>    <span class="p">)</span>
</code></pre></div>
<h3 id="application-factory-pattern"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#application-factory-pattern">Application Factory Pattern</a></h3>
<p>The application factory pattern provides clean initialization:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="c1"># src/presentation/main.py</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.routers</span><span class="w"> </span><span class="kn">import</span> <span class="n">orders</span><span class="p">,</span> <span class="n">products</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">auth</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.middleware.logging_middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestLoggingMiddleware</span>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.middleware.exception_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>    <span class="n">domain_exception_handler</span><span class="p">,</span>
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>    <span class="n">validation_exception_handler</span><span class="p">,</span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>    <span class="n">http_exception_handler</span><span class="p">,</span>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>    <span class="n">internal_server_error_handler</span>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="p">)</span>
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..domain.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DomainException</span>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..infrastructure.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">configure_logging</span>
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..infrastructure.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_database</span>
<a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a>
<a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a><span class="nd">@asynccontextmanager</span>
<a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Application lifespan manager&quot;&quot;&quot;</span>
<a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a>    <span class="c1"># Startup</span>
<a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a>    <span class="n">configure_logging</span><span class="p">()</span>
<a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a>    <span class="k">await</span> <span class="n">initialize_database</span><span class="p">()</span>
<a id="__codelineno-66-25" name="__codelineno-66-25" href="#__codelineno-66-25"></a>
<a id="__codelineno-66-26" name="__codelineno-66-26" href="#__codelineno-66-26"></a>    <span class="k">yield</span>
<a id="__codelineno-66-27" name="__codelineno-66-27" href="#__codelineno-66-27"></a>
<a id="__codelineno-66-28" name="__codelineno-66-28" href="#__codelineno-66-28"></a>    <span class="c1"># Shutdown</span>
<a id="__codelineno-66-29" name="__codelineno-66-29" href="#__codelineno-66-29"></a>    <span class="k">await</span> <span class="n">cleanup_resources</span><span class="p">()</span>
<a id="__codelineno-66-30" name="__codelineno-66-30" href="#__codelineno-66-30"></a>
<a id="__codelineno-66-31" name="__codelineno-66-31" href="#__codelineno-66-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_application</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FastAPI</span><span class="p">:</span>
<a id="__codelineno-66-32" name="__codelineno-66-32" href="#__codelineno-66-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Application factory function&quot;&quot;&quot;</span>
<a id="__codelineno-66-33" name="__codelineno-66-33" href="#__codelineno-66-33"></a>
<a id="__codelineno-66-34" name="__codelineno-66-34" href="#__codelineno-66-34"></a>    <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
<a id="__codelineno-66-35" name="__codelineno-66-35" href="#__codelineno-66-35"></a>        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clean Architecture E-commerce API&quot;</span><span class="p">,</span>
<a id="__codelineno-66-36" name="__codelineno-66-36" href="#__codelineno-66-36"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Production-ready e-commerce API built with Clean Architecture principles&quot;</span><span class="p">,</span>
<a id="__codelineno-66-37" name="__codelineno-66-37" href="#__codelineno-66-37"></a>        <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-66-38" name="__codelineno-66-38" href="#__codelineno-66-38"></a>        <span class="n">docs_url</span><span class="o">=</span><span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
<a id="__codelineno-66-39" name="__codelineno-66-39" href="#__codelineno-66-39"></a>        <span class="n">redoc_url</span><span class="o">=</span><span class="s2">&quot;/redoc&quot;</span><span class="p">,</span>
<a id="__codelineno-66-40" name="__codelineno-66-40" href="#__codelineno-66-40"></a>        <span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span>
<a id="__codelineno-66-41" name="__codelineno-66-41" href="#__codelineno-66-41"></a>    <span class="p">)</span>
<a id="__codelineno-66-42" name="__codelineno-66-42" href="#__codelineno-66-42"></a>
<a id="__codelineno-66-43" name="__codelineno-66-43" href="#__codelineno-66-43"></a>    <span class="c1"># Add CORS middleware</span>
<a id="__codelineno-66-44" name="__codelineno-66-44" href="#__codelineno-66-44"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
<a id="__codelineno-66-45" name="__codelineno-66-45" href="#__codelineno-66-45"></a>        <span class="n">CORSMiddleware</span><span class="p">,</span>
<a id="__codelineno-66-46" name="__codelineno-66-46" href="#__codelineno-66-46"></a>        <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;https://yourapp.com&quot;</span><span class="p">,</span> <span class="s2">&quot;https://admin.yourapp.com&quot;</span><span class="p">],</span>
<a id="__codelineno-66-47" name="__codelineno-66-47" href="#__codelineno-66-47"></a>        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-66-48" name="__codelineno-66-48" href="#__codelineno-66-48"></a>        <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">],</span>
<a id="__codelineno-66-49" name="__codelineno-66-49" href="#__codelineno-66-49"></a>        <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<a id="__codelineno-66-50" name="__codelineno-66-50" href="#__codelineno-66-50"></a>    <span class="p">)</span>
<a id="__codelineno-66-51" name="__codelineno-66-51" href="#__codelineno-66-51"></a>
<a id="__codelineno-66-52" name="__codelineno-66-52" href="#__codelineno-66-52"></a>    <span class="c1"># Add custom middleware</span>
<a id="__codelineno-66-53" name="__codelineno-66-53" href="#__codelineno-66-53"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">RequestLoggingMiddleware</span><span class="p">)</span>
<a id="__codelineno-66-54" name="__codelineno-66-54" href="#__codelineno-66-54"></a>
<a id="__codelineno-66-55" name="__codelineno-66-55" href="#__codelineno-66-55"></a>    <span class="c1"># Register exception handlers</span>
<a id="__codelineno-66-56" name="__codelineno-66-56" href="#__codelineno-66-56"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">DomainException</span><span class="p">,</span> <span class="n">domain_exception_handler</span><span class="p">)</span>
<a id="__codelineno-66-57" name="__codelineno-66-57" href="#__codelineno-66-57"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="n">validation_exception_handler</span><span class="p">)</span>
<a id="__codelineno-66-58" name="__codelineno-66-58" href="#__codelineno-66-58"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">,</span> <span class="n">http_exception_handler</span><span class="p">)</span>
<a id="__codelineno-66-59" name="__codelineno-66-59" href="#__codelineno-66-59"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">internal_server_error_handler</span><span class="p">)</span>
<a id="__codelineno-66-60" name="__codelineno-66-60" href="#__codelineno-66-60"></a>
<a id="__codelineno-66-61" name="__codelineno-66-61" href="#__codelineno-66-61"></a>    <span class="c1"># Include routers</span>
<a id="__codelineno-66-62" name="__codelineno-66-62" href="#__codelineno-66-62"></a>    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
<a id="__codelineno-66-63" name="__codelineno-66-63" href="#__codelineno-66-63"></a>    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
<a id="__codelineno-66-64" name="__codelineno-66-64" href="#__codelineno-66-64"></a>    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">products</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
<a id="__codelineno-66-65" name="__codelineno-66-65" href="#__codelineno-66-65"></a>    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
<a id="__codelineno-66-66" name="__codelineno-66-66" href="#__codelineno-66-66"></a>
<a id="__codelineno-66-67" name="__codelineno-66-67" href="#__codelineno-66-67"></a>    <span class="c1"># Health check endpoint</span>
<a id="__codelineno-66-68" name="__codelineno-66-68" href="#__codelineno-66-68"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
<a id="__codelineno-66-69" name="__codelineno-66-69" href="#__codelineno-66-69"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<a id="__codelineno-66-70" name="__codelineno-66-70" href="#__codelineno-66-70"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">}</span>
<a id="__codelineno-66-71" name="__codelineno-66-71" href="#__codelineno-66-71"></a>
<a id="__codelineno-66-72" name="__codelineno-66-72" href="#__codelineno-66-72"></a>    <span class="k">return</span> <span class="n">app</span>
<a id="__codelineno-66-73" name="__codelineno-66-73" href="#__codelineno-66-73"></a>
<a id="__codelineno-66-74" name="__codelineno-66-74" href="#__codelineno-66-74"></a><span class="c1"># Create application instance</span>
<a id="__codelineno-66-75" name="__codelineno-66-75" href="#__codelineno-66-75"></a><span class="n">app</span> <span class="o">=</span> <span class="n">create_application</span><span class="p">()</span>
<a id="__codelineno-66-76" name="__codelineno-66-76" href="#__codelineno-66-76"></a>
<a id="__codelineno-66-77" name="__codelineno-66-77" href="#__codelineno-66-77"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-66-78" name="__codelineno-66-78" href="#__codelineno-66-78"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-66-79" name="__codelineno-66-79" href="#__codelineno-66-79"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div>
<h3 id="testing-fastapi-with-clean-architecture"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#testing-fastapi-with-clean-architecture">Testing FastAPI with Clean Architecture</a></h3>
<p>The combination enables comprehensive testing at all levels:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="c1"># tests/presentation/test_orders_api.py</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">AsyncMock</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.presentation.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.application.use_cases.orders.create_order</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateOrderUseCase</span>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a>    <span class="k">return</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a>
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">mock_create_order_use_case</span><span class="p">():</span>
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a>    <span class="k">return</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">CreateOrderUseCase</span><span class="p">)</span>
<a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a>
<a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">mock_user</span><span class="p">():</span>
<a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a>    <span class="k">return</span> <span class="n">User</span><span class="p">(</span>
<a id="__codelineno-67-22" name="__codelineno-67-22" href="#__codelineno-67-22"></a>        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
<a id="__codelineno-67-23" name="__codelineno-67-23" href="#__codelineno-67-23"></a>        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-67-24" name="__codelineno-67-24" href="#__codelineno-67-24"></a>        <span class="n">first_name</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span>
<a id="__codelineno-67-25" name="__codelineno-67-25" href="#__codelineno-67-25"></a>        <span class="n">last_name</span><span class="o">=</span><span class="s2">&quot;User&quot;</span><span class="p">,</span>
<a id="__codelineno-67-26" name="__codelineno-67-26" href="#__codelineno-67-26"></a>        <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-67-27" name="__codelineno-67-27" href="#__codelineno-67-27"></a>    <span class="p">)</span>
<a id="__codelineno-67-28" name="__codelineno-67-28" href="#__codelineno-67-28"></a>
<a id="__codelineno-67-29" name="__codelineno-67-29" href="#__codelineno-67-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestOrdersAPI</span><span class="p">:</span>
<a id="__codelineno-67-30" name="__codelineno-67-30" href="#__codelineno-67-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_order_success</span><span class="p">(</span>
<a id="__codelineno-67-31" name="__codelineno-67-31" href="#__codelineno-67-31"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-67-32" name="__codelineno-67-32" href="#__codelineno-67-32"></a>        <span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">,</span> 
<a id="__codelineno-67-33" name="__codelineno-67-33" href="#__codelineno-67-33"></a>        <span class="n">mock_create_order_use_case</span><span class="p">:</span> <span class="n">Mock</span><span class="p">,</span>
<a id="__codelineno-67-34" name="__codelineno-67-34" href="#__codelineno-67-34"></a>        <span class="n">mock_user</span><span class="p">:</span> <span class="n">User</span>
<a id="__codelineno-67-35" name="__codelineno-67-35" href="#__codelineno-67-35"></a>    <span class="p">):</span>
<a id="__codelineno-67-36" name="__codelineno-67-36" href="#__codelineno-67-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test successful order creation&quot;&quot;&quot;</span>
<a id="__codelineno-67-37" name="__codelineno-67-37" href="#__codelineno-67-37"></a>
<a id="__codelineno-67-38" name="__codelineno-67-38" href="#__codelineno-67-38"></a>        <span class="c1"># Mock dependencies</span>
<a id="__codelineno-67-39" name="__codelineno-67-39" href="#__codelineno-67-39"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_create_order_use_case</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_create_order_use_case</span>
<a id="__codelineno-67-40" name="__codelineno-67-40" href="#__codelineno-67-40"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_current_user</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_user</span>
<a id="__codelineno-67-41" name="__codelineno-67-41" href="#__codelineno-67-41"></a>
<a id="__codelineno-67-42" name="__codelineno-67-42" href="#__codelineno-67-42"></a>        <span class="c1"># Mock use case response</span>
<a id="__codelineno-67-43" name="__codelineno-67-43" href="#__codelineno-67-43"></a>        <span class="n">expected_order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-67-44" name="__codelineno-67-44" href="#__codelineno-67-44"></a>            <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
<a id="__codelineno-67-45" name="__codelineno-67-45" href="#__codelineno-67-45"></a>            <span class="n">items_data</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod123&quot;</span><span class="p">,</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
<a id="__codelineno-67-46" name="__codelineno-67-46" href="#__codelineno-67-46"></a>            <span class="n">products</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-67-47" name="__codelineno-67-47" href="#__codelineno-67-47"></a>            <span class="n">shipping_address</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;street&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Main St&quot;</span><span class="p">},</span>
<a id="__codelineno-67-48" name="__codelineno-67-48" href="#__codelineno-67-48"></a>            <span class="n">payment_method_id</span><span class="o">=</span><span class="s2">&quot;pm123&quot;</span>
<a id="__codelineno-67-49" name="__codelineno-67-49" href="#__codelineno-67-49"></a>        <span class="p">)</span>
<a id="__codelineno-67-50" name="__codelineno-67-50" href="#__codelineno-67-50"></a>        <span class="n">mock_create_order_use_case</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">expected_order</span><span class="p">)</span>
<a id="__codelineno-67-51" name="__codelineno-67-51" href="#__codelineno-67-51"></a>
<a id="__codelineno-67-52" name="__codelineno-67-52" href="#__codelineno-67-52"></a>        <span class="c1"># Make request</span>
<a id="__codelineno-67-53" name="__codelineno-67-53" href="#__codelineno-67-53"></a>        <span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-67-54" name="__codelineno-67-54" href="#__codelineno-67-54"></a>            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod123&quot;</span><span class="p">,</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
<a id="__codelineno-67-55" name="__codelineno-67-55" href="#__codelineno-67-55"></a>            <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-67-56" name="__codelineno-67-56" href="#__codelineno-67-56"></a>                <span class="s2">&quot;street_address&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-67-57" name="__codelineno-67-57" href="#__codelineno-67-57"></a>                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Seattle&quot;</span><span class="p">,</span>
<a id="__codelineno-67-58" name="__codelineno-67-58" href="#__codelineno-67-58"></a>                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;WA&quot;</span><span class="p">,</span>
<a id="__codelineno-67-59" name="__codelineno-67-59" href="#__codelineno-67-59"></a>                <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;98101&quot;</span><span class="p">,</span>
<a id="__codelineno-67-60" name="__codelineno-67-60" href="#__codelineno-67-60"></a>                <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span>
<a id="__codelineno-67-61" name="__codelineno-67-61" href="#__codelineno-67-61"></a>            <span class="p">},</span>
<a id="__codelineno-67-62" name="__codelineno-67-62" href="#__codelineno-67-62"></a>            <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm123&quot;</span>
<a id="__codelineno-67-63" name="__codelineno-67-63" href="#__codelineno-67-63"></a>        <span class="p">}</span>
<a id="__codelineno-67-64" name="__codelineno-67-64" href="#__codelineno-67-64"></a>
<a id="__codelineno-67-65" name="__codelineno-67-65" href="#__codelineno-67-65"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/orders/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">request_data</span><span class="p">)</span>
<a id="__codelineno-67-66" name="__codelineno-67-66" href="#__codelineno-67-66"></a>
<a id="__codelineno-67-67" name="__codelineno-67-67" href="#__codelineno-67-67"></a>        <span class="c1"># Assertions</span>
<a id="__codelineno-67-68" name="__codelineno-67-68" href="#__codelineno-67-68"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<a id="__codelineno-67-69" name="__codelineno-67-69" href="#__codelineno-67-69"></a>        <span class="n">response_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-67-70" name="__codelineno-67-70" href="#__codelineno-67-70"></a>        <span class="k">assert</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_order</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-67-71" name="__codelineno-67-71" href="#__codelineno-67-71"></a>        <span class="k">assert</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span>
<a id="__codelineno-67-72" name="__codelineno-67-72" href="#__codelineno-67-72"></a>
<a id="__codelineno-67-73" name="__codelineno-67-73" href="#__codelineno-67-73"></a>        <span class="c1"># Verify use case was called correctly</span>
<a id="__codelineno-67-74" name="__codelineno-67-74" href="#__codelineno-67-74"></a>        <span class="n">mock_create_order_use_case</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-67-75" name="__codelineno-67-75" href="#__codelineno-67-75"></a>
<a id="__codelineno-67-76" name="__codelineno-67-76" href="#__codelineno-67-76"></a>        <span class="c1"># Clean up</span>
<a id="__codelineno-67-77" name="__codelineno-67-77" href="#__codelineno-67-77"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-67-78" name="__codelineno-67-78" href="#__codelineno-67-78"></a>
<a id="__codelineno-67-79" name="__codelineno-67-79" href="#__codelineno-67-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_order_validation_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">,</span> <span class="n">mock_user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span>
<a id="__codelineno-67-80" name="__codelineno-67-80" href="#__codelineno-67-80"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test order creation with validation errors&quot;&quot;&quot;</span>
<a id="__codelineno-67-81" name="__codelineno-67-81" href="#__codelineno-67-81"></a>
<a id="__codelineno-67-82" name="__codelineno-67-82" href="#__codelineno-67-82"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_current_user</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_user</span>
<a id="__codelineno-67-83" name="__codelineno-67-83" href="#__codelineno-67-83"></a>
<a id="__codelineno-67-84" name="__codelineno-67-84" href="#__codelineno-67-84"></a>        <span class="c1"># Invalid request data (missing required fields)</span>
<a id="__codelineno-67-85" name="__codelineno-67-85" href="#__codelineno-67-85"></a>        <span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-67-86" name="__codelineno-67-86" href="#__codelineno-67-86"></a>            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Empty items should fail validation</span>
<a id="__codelineno-67-87" name="__codelineno-67-87" href="#__codelineno-67-87"></a>            <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm123&quot;</span>
<a id="__codelineno-67-88" name="__codelineno-67-88" href="#__codelineno-67-88"></a>        <span class="p">}</span>
<a id="__codelineno-67-89" name="__codelineno-67-89" href="#__codelineno-67-89"></a>
<a id="__codelineno-67-90" name="__codelineno-67-90" href="#__codelineno-67-90"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/orders/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">request_data</span><span class="p">)</span>
<a id="__codelineno-67-91" name="__codelineno-67-91" href="#__codelineno-67-91"></a>
<a id="__codelineno-67-92" name="__codelineno-67-92" href="#__codelineno-67-92"></a>        <span class="c1"># Assertions</span>
<a id="__codelineno-67-93" name="__codelineno-67-93" href="#__codelineno-67-93"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
<a id="__codelineno-67-94" name="__codelineno-67-94" href="#__codelineno-67-94"></a>        <span class="n">response_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-67-95" name="__codelineno-67-95" href="#__codelineno-67-95"></a>        <span class="k">assert</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response_data</span>
<a id="__codelineno-67-96" name="__codelineno-67-96" href="#__codelineno-67-96"></a>        <span class="k">assert</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ValidationError&quot;</span>
<a id="__codelineno-67-97" name="__codelineno-67-97" href="#__codelineno-67-97"></a>
<a id="__codelineno-67-98" name="__codelineno-67-98" href="#__codelineno-67-98"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-67-99" name="__codelineno-67-99" href="#__codelineno-67-99"></a>
<a id="__codelineno-67-100" name="__codelineno-67-100" href="#__codelineno-67-100"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_order_domain_exception</span><span class="p">(</span>
<a id="__codelineno-67-101" name="__codelineno-67-101" href="#__codelineno-67-101"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-67-102" name="__codelineno-67-102" href="#__codelineno-67-102"></a>        <span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">,</span> 
<a id="__codelineno-67-103" name="__codelineno-67-103" href="#__codelineno-67-103"></a>        <span class="n">mock_create_order_use_case</span><span class="p">:</span> <span class="n">Mock</span><span class="p">,</span>
<a id="__codelineno-67-104" name="__codelineno-67-104" href="#__codelineno-67-104"></a>        <span class="n">mock_user</span><span class="p">:</span> <span class="n">User</span>
<a id="__codelineno-67-105" name="__codelineno-67-105" href="#__codelineno-67-105"></a>    <span class="p">):</span>
<a id="__codelineno-67-106" name="__codelineno-67-106" href="#__codelineno-67-106"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test order creation with domain exception&quot;&quot;&quot;</span>
<a id="__codelineno-67-107" name="__codelineno-67-107" href="#__codelineno-67-107"></a>
<a id="__codelineno-67-108" name="__codelineno-67-108" href="#__codelineno-67-108"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_create_order_use_case</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_create_order_use_case</span>
<a id="__codelineno-67-109" name="__codelineno-67-109" href="#__codelineno-67-109"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_current_user</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_user</span>
<a id="__codelineno-67-110" name="__codelineno-67-110" href="#__codelineno-67-110"></a>
<a id="__codelineno-67-111" name="__codelineno-67-111" href="#__codelineno-67-111"></a>        <span class="c1"># Mock use case to raise domain exception</span>
<a id="__codelineno-67-112" name="__codelineno-67-112" href="#__codelineno-67-112"></a>        <span class="n">mock_create_order_use_case</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">(</span>
<a id="__codelineno-67-113" name="__codelineno-67-113" href="#__codelineno-67-113"></a>            <span class="n">side_effect</span><span class="o">=</span><span class="n">InsufficientInventoryError</span><span class="p">(</span><span class="s2">&quot;Product out of stock&quot;</span><span class="p">)</span>
<a id="__codelineno-67-114" name="__codelineno-67-114" href="#__codelineno-67-114"></a>        <span class="p">)</span>
<a id="__codelineno-67-115" name="__codelineno-67-115" href="#__codelineno-67-115"></a>
<a id="__codelineno-67-116" name="__codelineno-67-116" href="#__codelineno-67-116"></a>        <span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-67-117" name="__codelineno-67-117" href="#__codelineno-67-117"></a>            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod123&quot;</span><span class="p">,</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
<a id="__codelineno-67-118" name="__codelineno-67-118" href="#__codelineno-67-118"></a>            <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-67-119" name="__codelineno-67-119" href="#__codelineno-67-119"></a>                <span class="s2">&quot;street_address&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-67-120" name="__codelineno-67-120" href="#__codelineno-67-120"></a>                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Seattle&quot;</span><span class="p">,</span>
<a id="__codelineno-67-121" name="__codelineno-67-121" href="#__codelineno-67-121"></a>                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;WA&quot;</span><span class="p">,</span>
<a id="__codelineno-67-122" name="__codelineno-67-122" href="#__codelineno-67-122"></a>                <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;98101&quot;</span><span class="p">,</span>
<a id="__codelineno-67-123" name="__codelineno-67-123" href="#__codelineno-67-123"></a>                <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span>
<a id="__codelineno-67-124" name="__codelineno-67-124" href="#__codelineno-67-124"></a>            <span class="p">},</span>
<a id="__codelineno-67-125" name="__codelineno-67-125" href="#__codelineno-67-125"></a>            <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm123&quot;</span>
<a id="__codelineno-67-126" name="__codelineno-67-126" href="#__codelineno-67-126"></a>        <span class="p">}</span>
<a id="__codelineno-67-127" name="__codelineno-67-127" href="#__codelineno-67-127"></a>
<a id="__codelineno-67-128" name="__codelineno-67-128" href="#__codelineno-67-128"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/orders/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">request_data</span><span class="p">)</span>
<a id="__codelineno-67-129" name="__codelineno-67-129" href="#__codelineno-67-129"></a>
<a id="__codelineno-67-130" name="__codelineno-67-130" href="#__codelineno-67-130"></a>        <span class="c1"># Assertions</span>
<a id="__codelineno-67-131" name="__codelineno-67-131" href="#__codelineno-67-131"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span>  <span class="c1"># Conflict for insufficient inventory</span>
<a id="__codelineno-67-132" name="__codelineno-67-132" href="#__codelineno-67-132"></a>        <span class="n">response_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-67-133" name="__codelineno-67-133" href="#__codelineno-67-133"></a>        <span class="k">assert</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;InsufficientInventoryError&quot;</span>
<a id="__codelineno-67-134" name="__codelineno-67-134" href="#__codelineno-67-134"></a>        <span class="k">assert</span> <span class="s2">&quot;Product out of stock&quot;</span> <span class="ow">in</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
<a id="__codelineno-67-135" name="__codelineno-67-135" href="#__codelineno-67-135"></a>
<a id="__codelineno-67-136" name="__codelineno-67-136" href="#__codelineno-67-136"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-67-137" name="__codelineno-67-137" href="#__codelineno-67-137"></a>
<a id="__codelineno-67-138" name="__codelineno-67-138" href="#__codelineno-67-138"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_order_unauthorized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">):</span>
<a id="__codelineno-67-139" name="__codelineno-67-139" href="#__codelineno-67-139"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test getting order without authentication&quot;&quot;&quot;</span>
<a id="__codelineno-67-140" name="__codelineno-67-140" href="#__codelineno-67-140"></a>
<a id="__codelineno-67-141" name="__codelineno-67-141" href="#__codelineno-67-141"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/orders/order123&quot;</span><span class="p">)</span>
<a id="__codelineno-67-142" name="__codelineno-67-142" href="#__codelineno-67-142"></a>
<a id="__codelineno-67-143" name="__codelineno-67-143" href="#__codelineno-67-143"></a>        <span class="c1"># Should return 401 Unauthorized</span>
<a id="__codelineno-67-144" name="__codelineno-67-144" href="#__codelineno-67-144"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
<a id="__codelineno-67-145" name="__codelineno-67-145" href="#__codelineno-67-145"></a>
<a id="__codelineno-67-146" name="__codelineno-67-146" href="#__codelineno-67-146"></a><span class="c1"># tests/integration/test_order_flow.py</span>
<a id="__codelineno-67-147" name="__codelineno-67-147" href="#__codelineno-67-147"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-67-148" name="__codelineno-67-148" href="#__codelineno-67-148"></a><span class="kn">from</span><span class="w"> </span><span class="nn">httpx</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span>
<a id="__codelineno-67-149" name="__codelineno-67-149" href="#__codelineno-67-149"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-67-150" name="__codelineno-67-150" href="#__codelineno-67-150"></a>
<a id="__codelineno-67-151" name="__codelineno-67-151" href="#__codelineno-67-151"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tests.fixtures.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">test_database</span>
<a id="__codelineno-67-152" name="__codelineno-67-152" href="#__codelineno-67-152"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tests.fixtures.test_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_test_user</span><span class="p">,</span> <span class="n">create_test_products</span>
<a id="__codelineno-67-153" name="__codelineno-67-153" href="#__codelineno-67-153"></a>
<a id="__codelineno-67-154" name="__codelineno-67-154" href="#__codelineno-67-154"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-67-155" name="__codelineno-67-155" href="#__codelineno-67-155"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestOrderFlowIntegration</span><span class="p">:</span>
<a id="__codelineno-67-156" name="__codelineno-67-156" href="#__codelineno-67-156"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_complete_order_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">test_database</span><span class="p">):</span>
<a id="__codelineno-67-157" name="__codelineno-67-157" href="#__codelineno-67-157"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test complete order creation flow with real database&quot;&quot;&quot;</span>
<a id="__codelineno-67-158" name="__codelineno-67-158" href="#__codelineno-67-158"></a>
<a id="__codelineno-67-159" name="__codelineno-67-159" href="#__codelineno-67-159"></a>        <span class="c1"># Setup test data</span>
<a id="__codelineno-67-160" name="__codelineno-67-160" href="#__codelineno-67-160"></a>        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_test_user</span><span class="p">()</span>
<a id="__codelineno-67-161" name="__codelineno-67-161" href="#__codelineno-67-161"></a>        <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_test_products</span><span class="p">()</span>
<a id="__codelineno-67-162" name="__codelineno-67-162" href="#__codelineno-67-162"></a>
<a id="__codelineno-67-163" name="__codelineno-67-163" href="#__codelineno-67-163"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncClient</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://test&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-67-164" name="__codelineno-67-164" href="#__codelineno-67-164"></a>            <span class="c1"># Login to get token</span>
<a id="__codelineno-67-165" name="__codelineno-67-165" href="#__codelineno-67-165"></a>            <span class="n">login_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-67-166" name="__codelineno-67-166" href="#__codelineno-67-166"></a>                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-67-167" name="__codelineno-67-167" href="#__codelineno-67-167"></a>                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;testpassword&quot;</span>
<a id="__codelineno-67-168" name="__codelineno-67-168" href="#__codelineno-67-168"></a>            <span class="p">})</span>
<a id="__codelineno-67-169" name="__codelineno-67-169" href="#__codelineno-67-169"></a>            <span class="k">assert</span> <span class="n">login_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-67-170" name="__codelineno-67-170" href="#__codelineno-67-170"></a>            <span class="n">token</span> <span class="o">=</span> <span class="n">login_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
<a id="__codelineno-67-171" name="__codelineno-67-171" href="#__codelineno-67-171"></a>
<a id="__codelineno-67-172" name="__codelineno-67-172" href="#__codelineno-67-172"></a>            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-67-173" name="__codelineno-67-173" href="#__codelineno-67-173"></a>
<a id="__codelineno-67-174" name="__codelineno-67-174" href="#__codelineno-67-174"></a>            <span class="c1"># Create order</span>
<a id="__codelineno-67-175" name="__codelineno-67-175" href="#__codelineno-67-175"></a>            <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-67-176" name="__codelineno-67-176" href="#__codelineno-67-176"></a>                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-67-177" name="__codelineno-67-177" href="#__codelineno-67-177"></a>                    <span class="p">{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">products</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
<a id="__codelineno-67-178" name="__codelineno-67-178" href="#__codelineno-67-178"></a>                    <span class="p">{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">products</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-67-179" name="__codelineno-67-179" href="#__codelineno-67-179"></a>                <span class="p">],</span>
<a id="__codelineno-67-180" name="__codelineno-67-180" href="#__codelineno-67-180"></a>                <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-67-181" name="__codelineno-67-181" href="#__codelineno-67-181"></a>                    <span class="s2">&quot;street_address&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Test St&quot;</span><span class="p">,</span>
<a id="__codelineno-67-182" name="__codelineno-67-182" href="#__codelineno-67-182"></a>                    <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Test City&quot;</span><span class="p">,</span>
<a id="__codelineno-67-183" name="__codelineno-67-183" href="#__codelineno-67-183"></a>                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;TS&quot;</span><span class="p">,</span>
<a id="__codelineno-67-184" name="__codelineno-67-184" href="#__codelineno-67-184"></a>                    <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<a id="__codelineno-67-185" name="__codelineno-67-185" href="#__codelineno-67-185"></a>                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span>
<a id="__codelineno-67-186" name="__codelineno-67-186" href="#__codelineno-67-186"></a>                <span class="p">},</span>
<a id="__codelineno-67-187" name="__codelineno-67-187" href="#__codelineno-67-187"></a>                <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm_test123&quot;</span>
<a id="__codelineno-67-188" name="__codelineno-67-188" href="#__codelineno-67-188"></a>            <span class="p">}</span>
<a id="__codelineno-67-189" name="__codelineno-67-189" href="#__codelineno-67-189"></a>
<a id="__codelineno-67-190" name="__codelineno-67-190" href="#__codelineno-67-190"></a>            <span class="n">create_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-67-191" name="__codelineno-67-191" href="#__codelineno-67-191"></a>                <span class="s2">&quot;/api/v1/orders/&quot;</span><span class="p">,</span>
<a id="__codelineno-67-192" name="__codelineno-67-192" href="#__codelineno-67-192"></a>                <span class="n">json</span><span class="o">=</span><span class="n">order_data</span><span class="p">,</span>
<a id="__codelineno-67-193" name="__codelineno-67-193" href="#__codelineno-67-193"></a>                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
<a id="__codelineno-67-194" name="__codelineno-67-194" href="#__codelineno-67-194"></a>            <span class="p">)</span>
<a id="__codelineno-67-195" name="__codelineno-67-195" href="#__codelineno-67-195"></a>
<a id="__codelineno-67-196" name="__codelineno-67-196" href="#__codelineno-67-196"></a>            <span class="k">assert</span> <span class="n">create_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<a id="__codelineno-67-197" name="__codelineno-67-197" href="#__codelineno-67-197"></a>            <span class="n">order</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-67-198" name="__codelineno-67-198" href="#__codelineno-67-198"></a>            <span class="k">assert</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span>
<a id="__codelineno-67-199" name="__codelineno-67-199" href="#__codelineno-67-199"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
<a id="__codelineno-67-200" name="__codelineno-67-200" href="#__codelineno-67-200"></a>
<a id="__codelineno-67-201" name="__codelineno-67-201" href="#__codelineno-67-201"></a>            <span class="c1"># Get order</span>
<a id="__codelineno-67-202" name="__codelineno-67-202" href="#__codelineno-67-202"></a>            <span class="n">get_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-67-203" name="__codelineno-67-203" href="#__codelineno-67-203"></a>                <span class="sa">f</span><span class="s2">&quot;/api/v1/orders/</span><span class="si">{</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-67-204" name="__codelineno-67-204" href="#__codelineno-67-204"></a>                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
<a id="__codelineno-67-205" name="__codelineno-67-205" href="#__codelineno-67-205"></a>            <span class="p">)</span>
<a id="__codelineno-67-206" name="__codelineno-67-206" href="#__codelineno-67-206"></a>
<a id="__codelineno-67-207" name="__codelineno-67-207" href="#__codelineno-67-207"></a>            <span class="k">assert</span> <span class="n">get_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-67-208" name="__codelineno-67-208" href="#__codelineno-67-208"></a>            <span class="n">retrieved_order</span> <span class="o">=</span> <span class="n">get_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-67-209" name="__codelineno-67-209" href="#__codelineno-67-209"></a>            <span class="k">assert</span> <span class="n">retrieved_order</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<a id="__codelineno-67-210" name="__codelineno-67-210" href="#__codelineno-67-210"></a>            <span class="k">assert</span> <span class="n">retrieved_order</span><span class="p">[</span><span class="s2">&quot;total_amount&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>
<h3 id="performance-optimization"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#performance-optimization">Performance Optimization</a></h3>
<p>FastAPI and Clean Architecture together enable several performance optimizations:</p>
<h4 id="asyncawait-throughout-the-stack"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#asyncawait-throughout-the-stack">Async/Await Throughout the Stack</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c1"># All layers support async operations</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">AsyncOrderRepository</span><span class="p">:</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>            <span class="c1"># Database operations</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>            <span class="k">pass</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>        <span class="c1"># Async database query</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>        <span class="k">pass</span>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateOrderUseCase</span><span class="p">:</span>
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">CreateOrderCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>        <span class="c1"># All operations are async</span>
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>        <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_repository</span><span class="o">.</span><span class="n">get_by_ids</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">product_ids</span><span class="p">)</span>
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a>        <span class="n">inventory_check</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">check_availability</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">OrderCreatedEvent</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>
<a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/orders&quot;</span><span class="p">)</span>
<a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span>
<a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">CreateOrderRequest</span><span class="p">,</span>
<a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a>    <span class="n">use_case</span><span class="p">:</span> <span class="n">CreateOrderUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()</span>
<a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a><span class="p">):</span>
<a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a>    <span class="c1"># End-to-end async</span>
<a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h4 id="dependency-injection-optimization"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#dependency-injection-optimization">Dependency Injection Optimization</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1"># Singleton services for performance</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="nd">@lru_cache</span><span class="p">()</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_payment_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PaymentService</span><span class="p">:</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Cached singleton payment service&quot;&quot;&quot;</span>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a>    <span class="k">return</span> <span class="n">StripePaymentService</span><span class="p">()</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="c1"># Connection pooling</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_database</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Database</span><span class="p">:</span>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get database with connection pooling&quot;&quot;&quot;</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a>    <span class="k">return</span> <span class="n">Database</span><span class="o">.</span><span class="n">get_pool</span><span class="p">()</span>
</code></pre></div>
<h3 id="production-deployment-patterns"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#production-deployment-patterns">Production Deployment Patterns</a></h3>
<h4 id="health-checks-and-monitoring"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#health-checks-and-monitoring">Health Checks and Monitoring</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">(</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>    <span class="n">redis</span><span class="p">:</span> <span class="n">Redis</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_redis</span><span class="p">)</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="p">):</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Comprehensive health check&quot;&quot;&quot;</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>    <span class="n">health_status</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;checks&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>    <span class="c1"># Database check</span>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT 1&quot;</span><span class="p">)</span>
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">][</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">][</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;unhealthy: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unhealthy&quot;</span>
<a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a>
<a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a>    <span class="c1"># Redis check</span>
<a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a>        <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
<a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">][</span><span class="s2">&quot;redis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
<a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">][</span><span class="s2">&quot;redis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;unhealthy: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unhealthy&quot;</span>
<a id="__codelineno-70-24" name="__codelineno-70-24" href="#__codelineno-70-24"></a>
<a id="__codelineno-70-25" name="__codelineno-70-25" href="#__codelineno-70-25"></a>    <span class="k">return</span> <span class="n">health_status</span>
<a id="__codelineno-70-26" name="__codelineno-70-26" href="#__codelineno-70-26"></a>
<a id="__codelineno-70-27" name="__codelineno-70-27" href="#__codelineno-70-27"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/metrics&quot;</span><span class="p">)</span>
<a id="__codelineno-70-28" name="__codelineno-70-28" href="#__codelineno-70-28"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">metrics</span><span class="p">():</span>
<a id="__codelineno-70-29" name="__codelineno-70-29" href="#__codelineno-70-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Application metrics for monitoring&quot;&quot;&quot;</span>
<a id="__codelineno-70-30" name="__codelineno-70-30" href="#__codelineno-70-30"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-70-31" name="__codelineno-70-31" href="#__codelineno-70-31"></a>        <span class="s2">&quot;orders_created_total&quot;</span><span class="p">:</span> <span class="n">order_metrics</span><span class="o">.</span><span class="n">created_total</span><span class="p">,</span>
<a id="__codelineno-70-32" name="__codelineno-70-32" href="#__codelineno-70-32"></a>        <span class="s2">&quot;orders_failed_total&quot;</span><span class="p">:</span> <span class="n">order_metrics</span><span class="o">.</span><span class="n">failed_total</span><span class="p">,</span>
<a id="__codelineno-70-33" name="__codelineno-70-33" href="#__codelineno-70-33"></a>        <span class="s2">&quot;active_connections&quot;</span><span class="p">:</span> <span class="n">db_pool</span><span class="o">.</span><span class="n">active_connections</span><span class="p">,</span>
<a id="__codelineno-70-34" name="__codelineno-70-34" href="#__codelineno-70-34"></a>        <span class="s2">&quot;memory_usage&quot;</span><span class="p">:</span> <span class="n">get_memory_usage</span><span class="p">()</span>
<a id="__codelineno-70-35" name="__codelineno-70-35" href="#__codelineno-70-35"></a>    <span class="p">}</span>
</code></pre></div>
<h4 id="graceful-shutdown"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#graceful-shutdown">Graceful Shutdown</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="nd">@asynccontextmanager</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>    <span class="c1"># Startup</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting application&quot;</span><span class="p">)</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>    <span class="k">await</span> <span class="n">initialize_database</span><span class="p">()</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>    <span class="k">await</span> <span class="n">initialize_redis</span><span class="p">()</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>    <span class="k">yield</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>    <span class="c1"># Shutdown</span>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shutting down application&quot;</span><span class="p">)</span>
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a>    <span class="k">await</span> <span class="n">cleanup_database</span><span class="p">()</span>
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>    <span class="k">await</span> <span class="n">cleanup_redis</span><span class="p">()</span>
<a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Application shutdown complete&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#conclusion">Conclusion</a></h3>
<p>FastAPI and Clean Architecture form a powerful combination that leverages the strengths of both approaches. FastAPI's type safety, dependency injection, and automatic validation reinforce Clean Architecture's separation of concerns and dependency inversion principles.</p>
<p>The key benefits of this combination:</p>
<ol>
<li><strong>Type Safety</strong>: Python type hints provide compile-time verification of architectural boundaries</li>
<li><strong>Dependency Injection</strong>: Natural implementation of dependency inversion principle</li>
<li><strong>Automatic Validation</strong>: Pydantic handles presentation layer validation, keeping domain logic pure</li>
<li><strong>Performance</strong>: ASGI foundation provides production-ready performance</li>
<li><strong>Documentation</strong>: OpenAPI generation stays synchronized with implementation</li>
<li><strong>Testing</strong>: Dependency injection enables comprehensive testing at all levels</li>
</ol>
<p>The clean-py repository demonstrates these patterns in production-ready code. The result is a system that's both architecturally sound and performant, with clear separation of concerns and comprehensive testing capabilities.</p>
<h3 id="references"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - FastAPI with Clean Architecture</li>
<li><a href="https://fastapi.tiangolo.com/">FastAPI Documentation</a> - Official FastAPI guide</li>
<li><a href="https://docs.pydantic.dev/">Pydantic Documentation</a> - Data validation library</li>
<li><a href="https://fastapi.tiangolo.com/tutorial/dependencies/">Dependency Injection in FastAPI</a> - Official dependency guide</li>
</ul>
<p>Start with Clean Architecture principles, leverage FastAPI's unique features to reinforce those boundaries, and build systems that scale both in performance and maintainability. The combination of these approaches creates applications that are truly built to last.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 buildshift.dev
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/buildshift-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/your-profile" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/your-handle" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:contact@buildshift.dev" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l208 156a48 48 0 0 0 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 196v188c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V196L313.6 344.8c-34.1 25.6-81.1 25.6-115.2 0z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.path", "navigation.top", "search.highlight", "search.share", "search.suggest", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../assets/js/buildshift.js"></script>
      
    
  </body>
</html>