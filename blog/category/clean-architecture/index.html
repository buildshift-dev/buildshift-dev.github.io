
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Full Stack Developer specializing in AWS Serverless, Python, and modern development workflows">
      
      
        <meta name="author" content="buildshift.dev">
      
      
        <link rel="canonical" href="https://buildshift.dev/blog/category/clean-architecture/">
      
      
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/images/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Clean Architecture - buildshift.dev</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/css/buildshift.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-4SV8ZKYLT1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-4SV8ZKYLT1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-4SV8ZKYLT1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Fixed banner styling -->
  <style>
    body { padding-top: 40px !important; }
    .md-header { top: 40px !important; }
    .md-tabs { top: 40px !important; }
  </style>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#clean-architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
  <!-- Under Construction Announcement -->
  <div style="background: #000000; text-align: center; padding: 8px 0; position: fixed; top: 0; left: 0; right: 0; z-index: 9999; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 14px; font-weight: 500; color: #ffa500;">
      <i class="fas fa-hard-hat"></i>
      <span>...Under Construction...</span>
    </div>
  </div>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="buildshift.dev" class="md-header__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            buildshift.dev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Clean Architecture
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link">
        
  
  
    
  
  buildshift.dev Blog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="buildshift.dev" class="md-nav__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    buildshift.dev
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    buildshift.dev Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="clean-architecture">Clean Architecture</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-07-16 18:25:00-04:00">Jul 16, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../fastapi/" class="md-meta__link">FastAPI</a>, 
              <a href="./" class="md-meta__link">Clean Architecture</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="../api-design/" class="md-meta__link">API Design</a></li>
        
        
          
          <li class="md-meta__item">
            
              14 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="fastapi-clean-architecture-a-match-made-in-heaven"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/">FastAPI + Clean Architecture: A Match Made in Heaven</a></h2>
<p>FastAPI has revolutionized Python web development with its modern approach to API design, automatic documentation, and exceptional performance. But many developers treat it as just another web framework, missing the opportunity to leverage its unique features within a Clean Architecture approach. The combination of FastAPI's dependency injection, type safety, and automatic validation with Clean Architecture's separation of concerns creates a powerful foundation for scalable applications.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates how FastAPI and Clean Architecture complement each other perfectly. This isn't just about using FastAPI as a web server—it's about leveraging its design philosophy to reinforce architectural boundaries and create truly maintainable systems.</p>
<h3 id="why-fastapi-and-clean-architecture-work-so-well-together"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#why-fastapi-and-clean-architecture-work-so-well-together">Why FastAPI and Clean Architecture Work So Well Together</a></h3>
<p>I've built REST APIs with Flask, Django REST Framework, and FastAPI. While each has its strengths, FastAPI's design philosophy aligns uniquely well with Clean Architecture principles:</p>
<p><strong>Type Safety</strong>: FastAPI's reliance on Python type hints enforces contracts between layers, making dependency inversion explicit and checkable.</p>
<p><strong>Dependency Injection</strong>: FastAPI's dependency system naturally implements the dependency inversion principle, making testing and mocking straightforward.</p>
<p><strong>Automatic Validation</strong>: Pydantic integration handles input validation at the presentation layer, keeping domain logic pure.</p>
<p><strong>Documentation Generation</strong>: OpenAPI documentation stays in sync with implementation, reducing maintenance overhead.</p>
<p><strong>Performance</strong>: ASGI foundation provides the performance needed for production systems without sacrificing development velocity.</p>
<p>A recent project demonstrated this perfectly. We migrated a Django REST Framework API with 50+ endpoints to FastAPI with Clean Architecture. The result: 40% performance improvement, 60% reduction in test execution time, and dramatically improved code maintainability. The architectural boundaries became self-enforcing through FastAPI's type system.</p>
<h3 id="clean-architecture-layers-with-fastapi"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#clean-architecture-layers-with-fastapi">Clean Architecture Layers with FastAPI</a></h3>
<p>Let's examine how FastAPI components map to Clean Architecture layers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>│                    Presentation Layer                       │
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>│  • FastAPI routers   • Request/Response models             │  
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>│  • Middleware        • Exception handlers                  │
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>│  • Dependency injection for controllers                    │
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>                                │
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>│                    Application Layer                        │
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>│  • Use case classes  • Command/Query handlers              │
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>│  • Service interfaces                                      │
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>│  • FastAPI dependencies for use case injection             │
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a>                                │
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>│                     Domain Layer                            │
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>│  • Entities          • Value objects                       │
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>│  • Domain services   • Repository interfaces               │
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>│  • Business rules    • Domain events                       │
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a>                                │
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>│                  Infrastructure Layer                       │
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>│  • Repository implementations                               │
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a>│  • Database models   • External service clients            │
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a>│  • FastAPI dependencies for infrastructure injection       │
<a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a>└─────────────────────────────────────────────────────────────┘
</code></pre></div>
<p>This layering provides natural separation of concerns while leveraging FastAPI's strengths at each layer.</p>
<h3 id="presentation-layer-implementation"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#presentation-layer-implementation">Presentation Layer Implementation</a></h3>
<h4 id="router-organization"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#router-organization">Router Organization</a></h4>
<p>The clean-py repository organizes FastAPI routers by domain aggregate, maintaining clean boundaries:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1"># src/presentation/routers/orders.py</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..dependencies</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_order_service</span><span class="p">,</span> <span class="n">get_current_user</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateOrderRequest</span><span class="p">,</span> <span class="n">UpdateOrderRequest</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..models.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderResponse</span><span class="p">,</span> <span class="n">OrderListResponse</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...application.use_cases.orders</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>    <span class="n">CreateOrderUseCase</span><span class="p">,</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>    <span class="n">GetOrderUseCase</span><span class="p">,</span>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>    <span class="n">ListOrdersUseCase</span><span class="p">,</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a>    <span class="n">UpdateOrderUseCase</span>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="p">)</span>
<a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.entities.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a>
<a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/orders&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;orders&quot;</span><span class="p">])</span>
<a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>
<a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">OrderResponse</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
<a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span>
<a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">CreateOrderRequest</span><span class="p">,</span>
<a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a>    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">),</span>
<a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a>    <span class="n">create_order_use_case</span><span class="p">:</span> <span class="n">CreateOrderUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()</span>
<a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderResponse</span><span class="p">:</span>
<a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new order for the authenticated user.&quot;&quot;&quot;</span>
<a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a>
<a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a>        <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_order_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a>            <span class="n">order_data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
<a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a>            <span class="n">requesting_user</span><span class="o">=</span><span class="n">current_user</span>
<a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a>        <span class="p">)</span>
<a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a>        <span class="k">return</span> <span class="n">OrderResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a>
<a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a>    <span class="k">except</span> <span class="n">OrderCreationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
<a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a>            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a>        <span class="p">)</span>
<a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a>    <span class="k">except</span> <span class="n">InsufficientPermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
<a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a>            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a>        <span class="p">)</span>
<a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a>
<a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">{order_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">OrderResponse</span><span class="p">)</span>
<a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_order</span><span class="p">(</span>
<a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a>    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">),</span>
<a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a>    <span class="n">get_order_use_case</span><span class="p">:</span> <span class="n">GetOrderUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()</span>
<a id="__codelineno-49-50" name="__codelineno-49-50" href="#__codelineno-49-50"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderResponse</span><span class="p">:</span>
<a id="__codelineno-49-51" name="__codelineno-49-51" href="#__codelineno-49-51"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a specific order by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-49-52" name="__codelineno-49-52" href="#__codelineno-49-52"></a>
<a id="__codelineno-49-53" name="__codelineno-49-53" href="#__codelineno-49-53"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-49-54" name="__codelineno-49-54" href="#__codelineno-49-54"></a>        <span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_order_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-49-55" name="__codelineno-49-55" href="#__codelineno-49-55"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-49-56" name="__codelineno-49-56" href="#__codelineno-49-56"></a>            <span class="n">requesting_user</span><span class="o">=</span><span class="n">current_user</span>
<a id="__codelineno-49-57" name="__codelineno-49-57" href="#__codelineno-49-57"></a>        <span class="p">)</span>
<a id="__codelineno-49-58" name="__codelineno-49-58" href="#__codelineno-49-58"></a>        <span class="k">return</span> <span class="n">OrderResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-49-59" name="__codelineno-49-59" href="#__codelineno-49-59"></a>
<a id="__codelineno-49-60" name="__codelineno-49-60" href="#__codelineno-49-60"></a>    <span class="k">except</span> <span class="n">OrderNotFoundError</span><span class="p">:</span>
<a id="__codelineno-49-61" name="__codelineno-49-61" href="#__codelineno-49-61"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-49-62" name="__codelineno-49-62" href="#__codelineno-49-62"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
<a id="__codelineno-49-63" name="__codelineno-49-63" href="#__codelineno-49-63"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Order not found&quot;</span>
<a id="__codelineno-49-64" name="__codelineno-49-64" href="#__codelineno-49-64"></a>        <span class="p">)</span>
<a id="__codelineno-49-65" name="__codelineno-49-65" href="#__codelineno-49-65"></a>
<a id="__codelineno-49-66" name="__codelineno-49-66" href="#__codelineno-49-66"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">OrderListResponse</span><span class="p">)</span>
<a id="__codelineno-49-67" name="__codelineno-49-67" href="#__codelineno-49-67"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_orders</span><span class="p">(</span>
<a id="__codelineno-49-68" name="__codelineno-49-68" href="#__codelineno-49-68"></a>    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
<a id="__codelineno-49-69" name="__codelineno-49-69" href="#__codelineno-49-69"></a>    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-49-70" name="__codelineno-49-70" href="#__codelineno-49-70"></a>    <span class="n">status_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-49-71" name="__codelineno-49-71" href="#__codelineno-49-71"></a>    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">),</span>
<a id="__codelineno-49-72" name="__codelineno-49-72" href="#__codelineno-49-72"></a>    <span class="n">list_orders_use_case</span><span class="p">:</span> <span class="n">ListOrdersUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()</span>
<a id="__codelineno-49-73" name="__codelineno-49-73" href="#__codelineno-49-73"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderListResponse</span><span class="p">:</span>
<a id="__codelineno-49-74" name="__codelineno-49-74" href="#__codelineno-49-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;List orders for the authenticated user.&quot;&quot;&quot;</span>
<a id="__codelineno-49-75" name="__codelineno-49-75" href="#__codelineno-49-75"></a>
<a id="__codelineno-49-76" name="__codelineno-49-76" href="#__codelineno-49-76"></a>    <span class="n">orders</span> <span class="o">=</span> <span class="k">await</span> <span class="n">list_orders_use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-49-77" name="__codelineno-49-77" href="#__codelineno-49-77"></a>        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-49-78" name="__codelineno-49-78" href="#__codelineno-49-78"></a>        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
<a id="__codelineno-49-79" name="__codelineno-49-79" href="#__codelineno-49-79"></a>        <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
<a id="__codelineno-49-80" name="__codelineno-49-80" href="#__codelineno-49-80"></a>        <span class="n">status_filter</span><span class="o">=</span><span class="n">status_filter</span><span class="p">,</span>
<a id="__codelineno-49-81" name="__codelineno-49-81" href="#__codelineno-49-81"></a>        <span class="n">requesting_user</span><span class="o">=</span><span class="n">current_user</span>
<a id="__codelineno-49-82" name="__codelineno-49-82" href="#__codelineno-49-82"></a>    <span class="p">)</span>
<a id="__codelineno-49-83" name="__codelineno-49-83" href="#__codelineno-49-83"></a>
<a id="__codelineno-49-84" name="__codelineno-49-84" href="#__codelineno-49-84"></a>    <span class="k">return</span> <span class="n">OrderListResponse</span><span class="p">(</span>
<a id="__codelineno-49-85" name="__codelineno-49-85" href="#__codelineno-49-85"></a>        <span class="n">orders</span><span class="o">=</span><span class="p">[</span><span class="n">OrderResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="o">.</span><span class="n">items</span><span class="p">],</span>
<a id="__codelineno-49-86" name="__codelineno-49-86" href="#__codelineno-49-86"></a>        <span class="n">total</span><span class="o">=</span><span class="n">orders</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-49-87" name="__codelineno-49-87" href="#__codelineno-49-87"></a>        <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
<a id="__codelineno-49-88" name="__codelineno-49-88" href="#__codelineno-49-88"></a>        <span class="n">offset</span><span class="o">=</span><span class="n">offset</span>
<a id="__codelineno-49-89" name="__codelineno-49-89" href="#__codelineno-49-89"></a>    <span class="p">)</span>
</code></pre></div>
<h4 id="requestresponse-models"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#requestresponse-models">Request/Response Models</a></h4>
<p>Pydantic models define the presentation layer contract, separate from domain entities:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># src/presentation/models/requests.py</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderItemRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Product identifier&quot;</span><span class="p">)</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Item quantity&quot;</span><span class="p">)</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>    <span class="n">unit_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Decimal</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Override unit price&quot;</span><span class="p">)</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;unit_price&#39;</span><span class="p">)</span>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_unit_price</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a>        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unit price must be positive&#39;</span><span class="p">)</span>
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a>        <span class="k">return</span> <span class="n">v</span>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a>
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a><span class="k">class</span><span class="w"> </span><span class="nc">AddressRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a>    <span class="n">street_address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
<a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a>    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a>    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a>    <span class="n">postal_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-50-23" name="__codelineno-50-23" href="#__codelineno-50-23"></a>    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-50-24" name="__codelineno-50-24" href="#__codelineno-50-24"></a>
<a id="__codelineno-50-25" name="__codelineno-50-25" href="#__codelineno-50-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateOrderRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-50-26" name="__codelineno-50-26" href="#__codelineno-50-26"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItemRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_items</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-50-27" name="__codelineno-50-27" href="#__codelineno-50-27"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">AddressRequest</span>
<a id="__codelineno-50-28" name="__codelineno-50-28" href="#__codelineno-50-28"></a>    <span class="n">billing_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AddressRequest</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-50-29" name="__codelineno-50-29" href="#__codelineno-50-29"></a>    <span class="n">payment_method_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Payment method identifier&quot;</span><span class="p">)</span>
<a id="__codelineno-50-30" name="__codelineno-50-30" href="#__codelineno-50-30"></a>    <span class="n">discount_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-50-31" name="__codelineno-50-31" href="#__codelineno-50-31"></a>    <span class="n">special_instructions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<a id="__codelineno-50-32" name="__codelineno-50-32" href="#__codelineno-50-32"></a>
<a id="__codelineno-50-33" name="__codelineno-50-33" href="#__codelineno-50-33"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">)</span>
<a id="__codelineno-50-34" name="__codelineno-50-34" href="#__codelineno-50-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_items</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<a id="__codelineno-50-35" name="__codelineno-50-35" href="#__codelineno-50-35"></a>        <span class="c1"># Business validation at presentation layer</span>
<a id="__codelineno-50-36" name="__codelineno-50-36" href="#__codelineno-50-36"></a>        <span class="n">product_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">product_id</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
<a id="__codelineno-50-37" name="__codelineno-50-37" href="#__codelineno-50-37"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">product_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">product_ids</span><span class="p">)):</span>
<a id="__codelineno-50-38" name="__codelineno-50-38" href="#__codelineno-50-38"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Duplicate products not allowed&#39;</span><span class="p">)</span>
<a id="__codelineno-50-39" name="__codelineno-50-39" href="#__codelineno-50-39"></a>        <span class="k">return</span> <span class="n">items</span>
<a id="__codelineno-50-40" name="__codelineno-50-40" href="#__codelineno-50-40"></a>
<a id="__codelineno-50-41" name="__codelineno-50-41" href="#__codelineno-50-41"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<a id="__codelineno-50-42" name="__codelineno-50-42" href="#__codelineno-50-42"></a>        <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-50-43" name="__codelineno-50-43" href="#__codelineno-50-43"></a>            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-50-44" name="__codelineno-50-44" href="#__codelineno-50-44"></a>                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-50-45" name="__codelineno-50-45" href="#__codelineno-50-45"></a>                    <span class="p">{</span>
<a id="__codelineno-50-46" name="__codelineno-50-46" href="#__codelineno-50-46"></a>                        <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod_123&quot;</span><span class="p">,</span>
<a id="__codelineno-50-47" name="__codelineno-50-47" href="#__codelineno-50-47"></a>                        <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-50-48" name="__codelineno-50-48" href="#__codelineno-50-48"></a>                        <span class="s2">&quot;unit_price&quot;</span><span class="p">:</span> <span class="mf">29.99</span>
<a id="__codelineno-50-49" name="__codelineno-50-49" href="#__codelineno-50-49"></a>                    <span class="p">}</span>
<a id="__codelineno-50-50" name="__codelineno-50-50" href="#__codelineno-50-50"></a>                <span class="p">],</span>
<a id="__codelineno-50-51" name="__codelineno-50-51" href="#__codelineno-50-51"></a>                <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-50-52" name="__codelineno-50-52" href="#__codelineno-50-52"></a>                    <span class="s2">&quot;street_address&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-50-53" name="__codelineno-50-53" href="#__codelineno-50-53"></a>                    <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Seattle&quot;</span><span class="p">,</span>
<a id="__codelineno-50-54" name="__codelineno-50-54" href="#__codelineno-50-54"></a>                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;WA&quot;</span><span class="p">,</span> 
<a id="__codelineno-50-55" name="__codelineno-50-55" href="#__codelineno-50-55"></a>                    <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;98101&quot;</span><span class="p">,</span>
<a id="__codelineno-50-56" name="__codelineno-50-56" href="#__codelineno-50-56"></a>                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span>
<a id="__codelineno-50-57" name="__codelineno-50-57" href="#__codelineno-50-57"></a>                <span class="p">},</span>
<a id="__codelineno-50-58" name="__codelineno-50-58" href="#__codelineno-50-58"></a>                <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm_456&quot;</span><span class="p">,</span>
<a id="__codelineno-50-59" name="__codelineno-50-59" href="#__codelineno-50-59"></a>                <span class="s2">&quot;discount_code&quot;</span><span class="p">:</span> <span class="s2">&quot;SAVE10&quot;</span>
<a id="__codelineno-50-60" name="__codelineno-50-60" href="#__codelineno-50-60"></a>            <span class="p">}</span>
<a id="__codelineno-50-61" name="__codelineno-50-61" href="#__codelineno-50-61"></a>        <span class="p">}</span>
<a id="__codelineno-50-62" name="__codelineno-50-62" href="#__codelineno-50-62"></a>
<a id="__codelineno-50-63" name="__codelineno-50-63" href="#__codelineno-50-63"></a><span class="c1"># src/presentation/models/responses.py</span>
<a id="__codelineno-50-64" name="__codelineno-50-64" href="#__codelineno-50-64"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
<a id="__codelineno-50-65" name="__codelineno-50-65" href="#__codelineno-50-65"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-50-66" name="__codelineno-50-66" href="#__codelineno-50-66"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-50-67" name="__codelineno-50-67" href="#__codelineno-50-67"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-50-68" name="__codelineno-50-68" href="#__codelineno-50-68"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-50-69" name="__codelineno-50-69" href="#__codelineno-50-69"></a>
<a id="__codelineno-50-70" name="__codelineno-50-70" href="#__codelineno-50-70"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-50-71" name="__codelineno-50-71" href="#__codelineno-50-71"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.value_objects.money</span><span class="w"> </span><span class="kn">import</span> <span class="n">Money</span>
<a id="__codelineno-50-72" name="__codelineno-50-72" href="#__codelineno-50-72"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.value_objects.address</span><span class="w"> </span><span class="kn">import</span> <span class="n">Address</span>
<a id="__codelineno-50-73" name="__codelineno-50-73" href="#__codelineno-50-73"></a>
<a id="__codelineno-50-74" name="__codelineno-50-74" href="#__codelineno-50-74"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-50-75" name="__codelineno-50-75" href="#__codelineno-50-75"></a>    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
<a id="__codelineno-50-76" name="__codelineno-50-76" href="#__codelineno-50-76"></a>    <span class="n">CONFIRMED</span> <span class="o">=</span> <span class="s2">&quot;confirmed&quot;</span>
<a id="__codelineno-50-77" name="__codelineno-50-77" href="#__codelineno-50-77"></a>    <span class="n">SHIPPED</span> <span class="o">=</span> <span class="s2">&quot;shipped&quot;</span>
<a id="__codelineno-50-78" name="__codelineno-50-78" href="#__codelineno-50-78"></a>    <span class="n">DELIVERED</span> <span class="o">=</span> <span class="s2">&quot;delivered&quot;</span>
<a id="__codelineno-50-79" name="__codelineno-50-79" href="#__codelineno-50-79"></a>    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
<a id="__codelineno-50-80" name="__codelineno-50-80" href="#__codelineno-50-80"></a>
<a id="__codelineno-50-81" name="__codelineno-50-81" href="#__codelineno-50-81"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderItemResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-50-82" name="__codelineno-50-82" href="#__codelineno-50-82"></a>    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-50-83" name="__codelineno-50-83" href="#__codelineno-50-83"></a>    <span class="n">product_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-50-84" name="__codelineno-50-84" href="#__codelineno-50-84"></a>    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-50-85" name="__codelineno-50-85" href="#__codelineno-50-85"></a>    <span class="n">unit_price</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-50-86" name="__codelineno-50-86" href="#__codelineno-50-86"></a>    <span class="n">total_price</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-50-87" name="__codelineno-50-87" href="#__codelineno-50-87"></a>
<a id="__codelineno-50-88" name="__codelineno-50-88" href="#__codelineno-50-88"></a><span class="k">class</span><span class="w"> </span><span class="nc">AddressResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-50-89" name="__codelineno-50-89" href="#__codelineno-50-89"></a>    <span class="n">street_address</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-50-90" name="__codelineno-50-90" href="#__codelineno-50-90"></a>    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-50-91" name="__codelineno-50-91" href="#__codelineno-50-91"></a>    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-50-92" name="__codelineno-50-92" href="#__codelineno-50-92"></a>    <span class="n">postal_code</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-50-93" name="__codelineno-50-93" href="#__codelineno-50-93"></a>    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-50-94" name="__codelineno-50-94" href="#__codelineno-50-94"></a>
<a id="__codelineno-50-95" name="__codelineno-50-95" href="#__codelineno-50-95"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-50-96" name="__codelineno-50-96" href="#__codelineno-50-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AddressResponse&#39;</span><span class="p">:</span>
<a id="__codelineno-50-97" name="__codelineno-50-97" href="#__codelineno-50-97"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-50-98" name="__codelineno-50-98" href="#__codelineno-50-98"></a>            <span class="n">street_address</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">street_address</span><span class="p">,</span>
<a id="__codelineno-50-99" name="__codelineno-50-99" href="#__codelineno-50-99"></a>            <span class="n">city</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">city</span><span class="p">,</span>
<a id="__codelineno-50-100" name="__codelineno-50-100" href="#__codelineno-50-100"></a>            <span class="n">state</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-50-101" name="__codelineno-50-101" href="#__codelineno-50-101"></a>            <span class="n">postal_code</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">postal_code</span><span class="p">,</span>
<a id="__codelineno-50-102" name="__codelineno-50-102" href="#__codelineno-50-102"></a>            <span class="n">country</span><span class="o">=</span><span class="n">address</span><span class="o">.</span><span class="n">country</span>
<a id="__codelineno-50-103" name="__codelineno-50-103" href="#__codelineno-50-103"></a>        <span class="p">)</span>
<a id="__codelineno-50-104" name="__codelineno-50-104" href="#__codelineno-50-104"></a>
<a id="__codelineno-50-105" name="__codelineno-50-105" href="#__codelineno-50-105"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-50-106" name="__codelineno-50-106" href="#__codelineno-50-106"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-50-107" name="__codelineno-50-107" href="#__codelineno-50-107"></a>    <span class="n">status</span><span class="p">:</span> <span class="n">OrderStatus</span>
<a id="__codelineno-50-108" name="__codelineno-50-108" href="#__codelineno-50-108"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItemResponse</span><span class="p">]</span>
<a id="__codelineno-50-109" name="__codelineno-50-109" href="#__codelineno-50-109"></a>    <span class="n">subtotal</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-50-110" name="__codelineno-50-110" href="#__codelineno-50-110"></a>    <span class="n">tax_amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-50-111" name="__codelineno-50-111" href="#__codelineno-50-111"></a>    <span class="n">shipping_cost</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-50-112" name="__codelineno-50-112" href="#__codelineno-50-112"></a>    <span class="n">discount_amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-50-113" name="__codelineno-50-113" href="#__codelineno-50-113"></a>    <span class="n">total_amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-50-114" name="__codelineno-50-114" href="#__codelineno-50-114"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-50-115" name="__codelineno-50-115" href="#__codelineno-50-115"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">AddressResponse</span>
<a id="__codelineno-50-116" name="__codelineno-50-116" href="#__codelineno-50-116"></a>    <span class="n">billing_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AddressResponse</span><span class="p">]</span>
<a id="__codelineno-50-117" name="__codelineno-50-117" href="#__codelineno-50-117"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-50-118" name="__codelineno-50-118" href="#__codelineno-50-118"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-50-119" name="__codelineno-50-119" href="#__codelineno-50-119"></a>
<a id="__codelineno-50-120" name="__codelineno-50-120" href="#__codelineno-50-120"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-50-121" name="__codelineno-50-121" href="#__codelineno-50-121"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;OrderResponse&#39;</span><span class="p">:</span>
<a id="__codelineno-50-122" name="__codelineno-50-122" href="#__codelineno-50-122"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert domain entity to response model&quot;&quot;&quot;</span>
<a id="__codelineno-50-123" name="__codelineno-50-123" href="#__codelineno-50-123"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-50-124" name="__codelineno-50-124" href="#__codelineno-50-124"></a>            <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-50-125" name="__codelineno-50-125" href="#__codelineno-50-125"></a>            <span class="n">status</span><span class="o">=</span><span class="n">OrderStatus</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
<a id="__codelineno-50-126" name="__codelineno-50-126" href="#__codelineno-50-126"></a>            <span class="n">items</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-50-127" name="__codelineno-50-127" href="#__codelineno-50-127"></a>                <span class="n">OrderItemResponse</span><span class="p">(</span>
<a id="__codelineno-50-128" name="__codelineno-50-128" href="#__codelineno-50-128"></a>                    <span class="n">product_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">product_id</span><span class="p">),</span>
<a id="__codelineno-50-129" name="__codelineno-50-129" href="#__codelineno-50-129"></a>                    <span class="n">product_name</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">product_name</span><span class="p">,</span>
<a id="__codelineno-50-130" name="__codelineno-50-130" href="#__codelineno-50-130"></a>                    <span class="n">quantity</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-50-131" name="__codelineno-50-131" href="#__codelineno-50-131"></a>                    <span class="n">unit_price</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">unit_price</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-50-132" name="__codelineno-50-132" href="#__codelineno-50-132"></a>                    <span class="n">total_price</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">total_price</span><span class="o">.</span><span class="n">amount</span>
<a id="__codelineno-50-133" name="__codelineno-50-133" href="#__codelineno-50-133"></a>                <span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span>
<a id="__codelineno-50-134" name="__codelineno-50-134" href="#__codelineno-50-134"></a>            <span class="p">],</span>
<a id="__codelineno-50-135" name="__codelineno-50-135" href="#__codelineno-50-135"></a>            <span class="n">subtotal</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">subtotal</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-50-136" name="__codelineno-50-136" href="#__codelineno-50-136"></a>            <span class="n">tax_amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">tax_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-50-137" name="__codelineno-50-137" href="#__codelineno-50-137"></a>            <span class="n">shipping_cost</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">shipping_cost</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-50-138" name="__codelineno-50-138" href="#__codelineno-50-138"></a>            <span class="n">discount_amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">discount_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-50-139" name="__codelineno-50-139" href="#__codelineno-50-139"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-50-140" name="__codelineno-50-140" href="#__codelineno-50-140"></a>            <span class="n">currency</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
<a id="__codelineno-50-141" name="__codelineno-50-141" href="#__codelineno-50-141"></a>            <span class="n">shipping_address</span><span class="o">=</span><span class="n">AddressResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">shipping_address</span><span class="p">),</span>
<a id="__codelineno-50-142" name="__codelineno-50-142" href="#__codelineno-50-142"></a>            <span class="n">billing_address</span><span class="o">=</span><span class="n">AddressResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">billing_address</span><span class="p">)</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">billing_address</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-50-143" name="__codelineno-50-143" href="#__codelineno-50-143"></a>            <span class="n">created_at</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-50-144" name="__codelineno-50-144" href="#__codelineno-50-144"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">updated_at</span>
<a id="__codelineno-50-145" name="__codelineno-50-145" href="#__codelineno-50-145"></a>        <span class="p">)</span>
<a id="__codelineno-50-146" name="__codelineno-50-146" href="#__codelineno-50-146"></a>
<a id="__codelineno-50-147" name="__codelineno-50-147" href="#__codelineno-50-147"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
<a id="__codelineno-50-148" name="__codelineno-50-148" href="#__codelineno-50-148"></a>        <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-50-149" name="__codelineno-50-149" href="#__codelineno-50-149"></a>            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-50-150" name="__codelineno-50-150" href="#__codelineno-50-150"></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;ord_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-50-151" name="__codelineno-50-151" href="#__codelineno-50-151"></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;confirmed&quot;</span><span class="p">,</span>
<a id="__codelineno-50-152" name="__codelineno-50-152" href="#__codelineno-50-152"></a>                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-50-153" name="__codelineno-50-153" href="#__codelineno-50-153"></a>                    <span class="p">{</span>
<a id="__codelineno-50-154" name="__codelineno-50-154" href="#__codelineno-50-154"></a>                        <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod_123&quot;</span><span class="p">,</span>
<a id="__codelineno-50-155" name="__codelineno-50-155" href="#__codelineno-50-155"></a>                        <span class="s2">&quot;product_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Premium Widget&quot;</span><span class="p">,</span>
<a id="__codelineno-50-156" name="__codelineno-50-156" href="#__codelineno-50-156"></a>                        <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-50-157" name="__codelineno-50-157" href="#__codelineno-50-157"></a>                        <span class="s2">&quot;unit_price&quot;</span><span class="p">:</span> <span class="mf">29.99</span><span class="p">,</span>
<a id="__codelineno-50-158" name="__codelineno-50-158" href="#__codelineno-50-158"></a>                        <span class="s2">&quot;total_price&quot;</span><span class="p">:</span> <span class="mf">59.98</span>
<a id="__codelineno-50-159" name="__codelineno-50-159" href="#__codelineno-50-159"></a>                    <span class="p">}</span>
<a id="__codelineno-50-160" name="__codelineno-50-160" href="#__codelineno-50-160"></a>                <span class="p">],</span>
<a id="__codelineno-50-161" name="__codelineno-50-161" href="#__codelineno-50-161"></a>                <span class="s2">&quot;subtotal&quot;</span><span class="p">:</span> <span class="mf">59.98</span><span class="p">,</span>
<a id="__codelineno-50-162" name="__codelineno-50-162" href="#__codelineno-50-162"></a>                <span class="s2">&quot;tax_amount&quot;</span><span class="p">:</span> <span class="mf">4.80</span><span class="p">,</span>
<a id="__codelineno-50-163" name="__codelineno-50-163" href="#__codelineno-50-163"></a>                <span class="s2">&quot;shipping_cost&quot;</span><span class="p">:</span> <span class="mf">9.99</span><span class="p">,</span>
<a id="__codelineno-50-164" name="__codelineno-50-164" href="#__codelineno-50-164"></a>                <span class="s2">&quot;discount_amount&quot;</span><span class="p">:</span> <span class="mf">6.00</span><span class="p">,</span>
<a id="__codelineno-50-165" name="__codelineno-50-165" href="#__codelineno-50-165"></a>                <span class="s2">&quot;total_amount&quot;</span><span class="p">:</span> <span class="mf">68.77</span><span class="p">,</span>
<a id="__codelineno-50-166" name="__codelineno-50-166" href="#__codelineno-50-166"></a>                <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span>
<a id="__codelineno-50-167" name="__codelineno-50-167" href="#__codelineno-50-167"></a>            <span class="p">}</span>
<a id="__codelineno-50-168" name="__codelineno-50-168" href="#__codelineno-50-168"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="dependency-injection-for-clean-architecture"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#dependency-injection-for-clean-architecture">Dependency Injection for Clean Architecture</a></h3>
<p>FastAPI's dependency system beautifully implements dependency inversion:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1"># src/presentation/dependencies.py</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="c1"># Infrastructure dependencies</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_database</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Database</span><span class="p">:</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get database connection&quot;&quot;&quot;</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>    <span class="k">return</span> <span class="n">Database</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_redis</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Redis</span><span class="p">:</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get Redis client&quot;&quot;&quot;</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>    <span class="k">return</span> <span class="n">Redis</span><span class="p">(</span><span class="n">REDIS_URL</span><span class="p">)</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_event_bus</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">EventBus</span><span class="p">:</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get event bus for domain events&quot;&quot;&quot;</span>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>    <span class="k">return</span> <span class="n">EventBus</span><span class="p">()</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="c1"># Repository dependencies</span>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_order_repository</span><span class="p">(</span>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderRepository</span><span class="p">:</span>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get order repository implementation&quot;&quot;&quot;</span>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a>    <span class="k">return</span> <span class="n">SQLOrderRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a>
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_product_repository</span><span class="p">(</span>
<a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProductRepository</span><span class="p">:</span>
<a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get product repository implementation&quot;&quot;&quot;</span>
<a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a>    <span class="k">return</span> <span class="n">SQLProductRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a>
<a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_user_repository</span><span class="p">(</span>
<a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)</span>
<a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserRepository</span><span class="p">:</span>
<a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get user repository implementation&quot;&quot;&quot;</span>
<a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a>    <span class="k">return</span> <span class="n">SQLUserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a>
<a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a><span class="c1"># Service dependencies</span>
<a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_payment_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PaymentService</span><span class="p">:</span>
<a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get payment service implementation&quot;&quot;&quot;</span>
<a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a>    <span class="k">return</span> <span class="n">StripePaymentService</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">STRIPE_API_KEY</span><span class="p">)</span>
<a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a>
<a id="__codelineno-51-42" name="__codelineno-51-42" href="#__codelineno-51-42"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_inventory_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">InventoryService</span><span class="p">:</span>
<a id="__codelineno-51-43" name="__codelineno-51-43" href="#__codelineno-51-43"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get inventory service implementation&quot;&quot;&quot;</span>
<a id="__codelineno-51-44" name="__codelineno-51-44" href="#__codelineno-51-44"></a>    <span class="k">return</span> <span class="n">InventoryService</span><span class="p">()</span>
<a id="__codelineno-51-45" name="__codelineno-51-45" href="#__codelineno-51-45"></a>
<a id="__codelineno-51-46" name="__codelineno-51-46" href="#__codelineno-51-46"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_notification_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">NotificationService</span><span class="p">:</span>
<a id="__codelineno-51-47" name="__codelineno-51-47" href="#__codelineno-51-47"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get notification service implementation&quot;&quot;&quot;</span>
<a id="__codelineno-51-48" name="__codelineno-51-48" href="#__codelineno-51-48"></a>    <span class="k">return</span> <span class="n">EmailNotificationService</span><span class="p">()</span>
<a id="__codelineno-51-49" name="__codelineno-51-49" href="#__codelineno-51-49"></a>
<a id="__codelineno-51-50" name="__codelineno-51-50" href="#__codelineno-51-50"></a><span class="c1"># Use case dependencies</span>
<a id="__codelineno-51-51" name="__codelineno-51-51" href="#__codelineno-51-51"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_create_order_use_case</span><span class="p">(</span>
<a id="__codelineno-51-52" name="__codelineno-51-52" href="#__codelineno-51-52"></a>    <span class="n">order_repo</span><span class="p">:</span> <span class="n">OrderRepository</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_order_repository</span><span class="p">),</span>
<a id="__codelineno-51-53" name="__codelineno-51-53" href="#__codelineno-51-53"></a>    <span class="n">product_repo</span><span class="p">:</span> <span class="n">ProductRepository</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_product_repository</span><span class="p">),</span>
<a id="__codelineno-51-54" name="__codelineno-51-54" href="#__codelineno-51-54"></a>    <span class="n">payment_service</span><span class="p">:</span> <span class="n">PaymentService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_payment_service</span><span class="p">),</span>
<a id="__codelineno-51-55" name="__codelineno-51-55" href="#__codelineno-51-55"></a>    <span class="n">inventory_service</span><span class="p">:</span> <span class="n">InventoryService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_inventory_service</span><span class="p">),</span>
<a id="__codelineno-51-56" name="__codelineno-51-56" href="#__codelineno-51-56"></a>    <span class="n">event_bus</span><span class="p">:</span> <span class="n">EventBus</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_event_bus</span><span class="p">)</span>
<a id="__codelineno-51-57" name="__codelineno-51-57" href="#__codelineno-51-57"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CreateOrderUseCase</span><span class="p">:</span>
<a id="__codelineno-51-58" name="__codelineno-51-58" href="#__codelineno-51-58"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get create order use case with all dependencies&quot;&quot;&quot;</span>
<a id="__codelineno-51-59" name="__codelineno-51-59" href="#__codelineno-51-59"></a>    <span class="k">return</span> <span class="n">CreateOrderUseCase</span><span class="p">(</span>
<a id="__codelineno-51-60" name="__codelineno-51-60" href="#__codelineno-51-60"></a>        <span class="n">order_repository</span><span class="o">=</span><span class="n">order_repo</span><span class="p">,</span>
<a id="__codelineno-51-61" name="__codelineno-51-61" href="#__codelineno-51-61"></a>        <span class="n">product_repository</span><span class="o">=</span><span class="n">product_repo</span><span class="p">,</span>
<a id="__codelineno-51-62" name="__codelineno-51-62" href="#__codelineno-51-62"></a>        <span class="n">payment_service</span><span class="o">=</span><span class="n">payment_service</span><span class="p">,</span>
<a id="__codelineno-51-63" name="__codelineno-51-63" href="#__codelineno-51-63"></a>        <span class="n">inventory_service</span><span class="o">=</span><span class="n">inventory_service</span><span class="p">,</span>
<a id="__codelineno-51-64" name="__codelineno-51-64" href="#__codelineno-51-64"></a>        <span class="n">event_bus</span><span class="o">=</span><span class="n">event_bus</span>
<a id="__codelineno-51-65" name="__codelineno-51-65" href="#__codelineno-51-65"></a>    <span class="p">)</span>
<a id="__codelineno-51-66" name="__codelineno-51-66" href="#__codelineno-51-66"></a>
<a id="__codelineno-51-67" name="__codelineno-51-67" href="#__codelineno-51-67"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_order_service</span><span class="p">(</span>
<a id="__codelineno-51-68" name="__codelineno-51-68" href="#__codelineno-51-68"></a>    <span class="n">order_repo</span><span class="p">:</span> <span class="n">OrderRepository</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_order_repository</span><span class="p">),</span>
<a id="__codelineno-51-69" name="__codelineno-51-69" href="#__codelineno-51-69"></a>    <span class="n">event_bus</span><span class="p">:</span> <span class="n">EventBus</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_event_bus</span><span class="p">)</span>
<a id="__codelineno-51-70" name="__codelineno-51-70" href="#__codelineno-51-70"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderService</span><span class="p">:</span>
<a id="__codelineno-51-71" name="__codelineno-51-71" href="#__codelineno-51-71"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get order service with dependencies&quot;&quot;&quot;</span>
<a id="__codelineno-51-72" name="__codelineno-51-72" href="#__codelineno-51-72"></a>    <span class="k">return</span> <span class="n">OrderService</span><span class="p">(</span>
<a id="__codelineno-51-73" name="__codelineno-51-73" href="#__codelineno-51-73"></a>        <span class="n">order_repository</span><span class="o">=</span><span class="n">order_repo</span><span class="p">,</span>
<a id="__codelineno-51-74" name="__codelineno-51-74" href="#__codelineno-51-74"></a>        <span class="n">event_bus</span><span class="o">=</span><span class="n">event_bus</span>
<a id="__codelineno-51-75" name="__codelineno-51-75" href="#__codelineno-51-75"></a>    <span class="p">)</span>
<a id="__codelineno-51-76" name="__codelineno-51-76" href="#__codelineno-51-76"></a>
<a id="__codelineno-51-77" name="__codelineno-51-77" href="#__codelineno-51-77"></a><span class="c1"># Authentication dependencies</span>
<a id="__codelineno-51-78" name="__codelineno-51-78" href="#__codelineno-51-78"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
<a id="__codelineno-51-79" name="__codelineno-51-79" href="#__codelineno-51-79"></a>    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">oauth2_scheme</span><span class="p">),</span>
<a id="__codelineno-51-80" name="__codelineno-51-80" href="#__codelineno-51-80"></a>    <span class="n">user_repo</span><span class="p">:</span> <span class="n">UserRepository</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_user_repository</span><span class="p">)</span>
<a id="__codelineno-51-81" name="__codelineno-51-81" href="#__codelineno-51-81"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">User</span><span class="p">:</span>
<a id="__codelineno-51-82" name="__codelineno-51-82" href="#__codelineno-51-82"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get currently authenticated user&quot;&quot;&quot;</span>
<a id="__codelineno-51-83" name="__codelineno-51-83" href="#__codelineno-51-83"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-51-84" name="__codelineno-51-84" href="#__codelineno-51-84"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">ALGORITHM</span><span class="p">])</span>
<a id="__codelineno-51-85" name="__codelineno-51-85" href="#__codelineno-51-85"></a>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
<a id="__codelineno-51-86" name="__codelineno-51-86" href="#__codelineno-51-86"></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-51-87" name="__codelineno-51-87" href="#__codelineno-51-87"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-51-88" name="__codelineno-51-88" href="#__codelineno-51-88"></a>                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
<a id="__codelineno-51-89" name="__codelineno-51-89" href="#__codelineno-51-89"></a>                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid authentication credentials&quot;</span>
<a id="__codelineno-51-90" name="__codelineno-51-90" href="#__codelineno-51-90"></a>            <span class="p">)</span>
<a id="__codelineno-51-91" name="__codelineno-51-91" href="#__codelineno-51-91"></a>    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
<a id="__codelineno-51-92" name="__codelineno-51-92" href="#__codelineno-51-92"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-51-93" name="__codelineno-51-93" href="#__codelineno-51-93"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
<a id="__codelineno-51-94" name="__codelineno-51-94" href="#__codelineno-51-94"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid authentication credentials&quot;</span>
<a id="__codelineno-51-95" name="__codelineno-51-95" href="#__codelineno-51-95"></a>        <span class="p">)</span>
<a id="__codelineno-51-96" name="__codelineno-51-96" href="#__codelineno-51-96"></a>
<a id="__codelineno-51-97" name="__codelineno-51-97" href="#__codelineno-51-97"></a>    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">user_repo</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-51-98" name="__codelineno-51-98" href="#__codelineno-51-98"></a>    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-51-99" name="__codelineno-51-99" href="#__codelineno-51-99"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-51-100" name="__codelineno-51-100" href="#__codelineno-51-100"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
<a id="__codelineno-51-101" name="__codelineno-51-101" href="#__codelineno-51-101"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;User not found&quot;</span>
<a id="__codelineno-51-102" name="__codelineno-51-102" href="#__codelineno-51-102"></a>        <span class="p">)</span>
<a id="__codelineno-51-103" name="__codelineno-51-103" href="#__codelineno-51-103"></a>    <span class="k">return</span> <span class="n">user</span>
<a id="__codelineno-51-104" name="__codelineno-51-104" href="#__codelineno-51-104"></a>
<a id="__codelineno-51-105" name="__codelineno-51-105" href="#__codelineno-51-105"></a><span class="c1"># Type aliases for cleaner code</span>
<a id="__codelineno-51-106" name="__codelineno-51-106" href="#__codelineno-51-106"></a><span class="n">CurrentUser</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)]</span>
<a id="__codelineno-51-107" name="__codelineno-51-107" href="#__codelineno-51-107"></a><span class="n">CreateOrderUseCaseDep</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">CreateOrderUseCase</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_create_order_use_case</span><span class="p">)]</span>
</code></pre></div>
<h3 id="application-layer-integration"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#application-layer-integration">Application Layer Integration</a></h3>
<p>The application layer contains use cases that orchestrate business operations:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1"># src/application/use_cases/orders/create_order.py</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.entities.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.repositories.order_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderRepository</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.repositories.product_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProductRepository</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.services.payment_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">PaymentService</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.services.inventory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InventoryService</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...infrastructure.events.event_bus</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventBus</span>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.events.order_events</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderCreatedEvent</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="nd">@dataclass</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateOrderCommand</span><span class="p">:</span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a>    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a>    <span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a>    <span class="n">billing_address</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a>    <span class="n">payment_method_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a>    <span class="n">discount_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a>
<a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateOrderUseCase</span><span class="p">:</span>
<a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a>        <span class="n">order_repository</span><span class="p">:</span> <span class="n">OrderRepository</span><span class="p">,</span>
<a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a>        <span class="n">product_repository</span><span class="p">:</span> <span class="n">ProductRepository</span><span class="p">,</span>
<a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a>        <span class="n">payment_service</span><span class="p">:</span> <span class="n">PaymentService</span><span class="p">,</span>
<a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a>        <span class="n">inventory_service</span><span class="p">:</span> <span class="n">InventoryService</span><span class="p">,</span>
<a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a>        <span class="n">event_bus</span><span class="p">:</span> <span class="n">EventBus</span>
<a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a>    <span class="p">):</span>
<a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span> <span class="o">=</span> <span class="n">order_repository</span>
<a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">product_repository</span> <span class="o">=</span> <span class="n">product_repository</span>
<a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">payment_service</span> <span class="o">=</span> <span class="n">payment_service</span>
<a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span> <span class="o">=</span> <span class="n">inventory_service</span>
<a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span> <span class="o">=</span> <span class="n">event_bus</span>
<a id="__codelineno-52-37" name="__codelineno-52-37" href="#__codelineno-52-37"></a>
<a id="__codelineno-52-38" name="__codelineno-52-38" href="#__codelineno-52-38"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<a id="__codelineno-52-39" name="__codelineno-52-39" href="#__codelineno-52-39"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-52-40" name="__codelineno-52-40" href="#__codelineno-52-40"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-52-41" name="__codelineno-52-41" href="#__codelineno-52-41"></a>        <span class="n">order_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-52-42" name="__codelineno-52-42" href="#__codelineno-52-42"></a>        <span class="n">requesting_user</span><span class="p">:</span> <span class="n">User</span>
<a id="__codelineno-52-43" name="__codelineno-52-43" href="#__codelineno-52-43"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-52-44" name="__codelineno-52-44" href="#__codelineno-52-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute order creation use case&quot;&quot;&quot;</span>
<a id="__codelineno-52-45" name="__codelineno-52-45" href="#__codelineno-52-45"></a>
<a id="__codelineno-52-46" name="__codelineno-52-46" href="#__codelineno-52-46"></a>        <span class="c1"># Authorization check</span>
<a id="__codelineno-52-47" name="__codelineno-52-47" href="#__codelineno-52-47"></a>        <span class="k">if</span> <span class="n">requesting_user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">requesting_user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
<a id="__codelineno-52-48" name="__codelineno-52-48" href="#__codelineno-52-48"></a>            <span class="k">raise</span> <span class="n">InsufficientPermissionError</span><span class="p">(</span><span class="s2">&quot;Cannot create order for another user&quot;</span><span class="p">)</span>
<a id="__codelineno-52-49" name="__codelineno-52-49" href="#__codelineno-52-49"></a>
<a id="__codelineno-52-50" name="__codelineno-52-50" href="#__codelineno-52-50"></a>        <span class="c1"># Validate products exist and have sufficient inventory</span>
<a id="__codelineno-52-51" name="__codelineno-52-51" href="#__codelineno-52-51"></a>        <span class="n">product_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]]</span>
<a id="__codelineno-52-52" name="__codelineno-52-52" href="#__codelineno-52-52"></a>        <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_repository</span><span class="o">.</span><span class="n">get_by_ids</span><span class="p">(</span><span class="n">product_ids</span><span class="p">)</span>
<a id="__codelineno-52-53" name="__codelineno-52-53" href="#__codelineno-52-53"></a>
<a id="__codelineno-52-54" name="__codelineno-52-54" href="#__codelineno-52-54"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">product_ids</span><span class="p">):</span>
<a id="__codelineno-52-55" name="__codelineno-52-55" href="#__codelineno-52-55"></a>            <span class="n">missing_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">product_ids</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">}</span>
<a id="__codelineno-52-56" name="__codelineno-52-56" href="#__codelineno-52-56"></a>            <span class="k">raise</span> <span class="n">ProductNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Products not found: </span><span class="si">{</span><span class="n">missing_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-52-57" name="__codelineno-52-57" href="#__codelineno-52-57"></a>
<a id="__codelineno-52-58" name="__codelineno-52-58" href="#__codelineno-52-58"></a>        <span class="c1"># Check inventory</span>
<a id="__codelineno-52-59" name="__codelineno-52-59" href="#__codelineno-52-59"></a>        <span class="k">for</span> <span class="n">item_data</span> <span class="ow">in</span> <span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]:</span>
<a id="__codelineno-52-60" name="__codelineno-52-60" href="#__codelineno-52-60"></a>            <span class="n">product</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">item_data</span><span class="p">[</span><span class="s1">&#39;product_id&#39;</span><span class="p">])</span>
<a id="__codelineno-52-61" name="__codelineno-52-61" href="#__codelineno-52-61"></a>            <span class="n">available</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">check_availability</span><span class="p">(</span>
<a id="__codelineno-52-62" name="__codelineno-52-62" href="#__codelineno-52-62"></a>                <span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
<a id="__codelineno-52-63" name="__codelineno-52-63" href="#__codelineno-52-63"></a>                <span class="n">item_data</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
<a id="__codelineno-52-64" name="__codelineno-52-64" href="#__codelineno-52-64"></a>            <span class="p">)</span>
<a id="__codelineno-52-65" name="__codelineno-52-65" href="#__codelineno-52-65"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">available</span><span class="p">:</span>
<a id="__codelineno-52-66" name="__codelineno-52-66" href="#__codelineno-52-66"></a>                <span class="k">raise</span> <span class="n">InsufficientInventoryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient inventory for </span><span class="si">{</span><span class="n">product</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-52-67" name="__codelineno-52-67" href="#__codelineno-52-67"></a>
<a id="__codelineno-52-68" name="__codelineno-52-68" href="#__codelineno-52-68"></a>        <span class="c1"># Create order domain entity</span>
<a id="__codelineno-52-69" name="__codelineno-52-69" href="#__codelineno-52-69"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-52-70" name="__codelineno-52-70" href="#__codelineno-52-70"></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-52-71" name="__codelineno-52-71" href="#__codelineno-52-71"></a>            <span class="n">items_data</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">],</span>
<a id="__codelineno-52-72" name="__codelineno-52-72" href="#__codelineno-52-72"></a>            <span class="n">products</span><span class="o">=</span><span class="n">products</span><span class="p">,</span>
<a id="__codelineno-52-73" name="__codelineno-52-73" href="#__codelineno-52-73"></a>            <span class="n">shipping_address</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;shipping_address&#39;</span><span class="p">],</span>
<a id="__codelineno-52-74" name="__codelineno-52-74" href="#__codelineno-52-74"></a>            <span class="n">billing_address</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;billing_address&#39;</span><span class="p">),</span>
<a id="__codelineno-52-75" name="__codelineno-52-75" href="#__codelineno-52-75"></a>            <span class="n">payment_method_id</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;payment_method_id&#39;</span><span class="p">],</span>
<a id="__codelineno-52-76" name="__codelineno-52-76" href="#__codelineno-52-76"></a>            <span class="n">discount_code</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discount_code&#39;</span><span class="p">)</span>
<a id="__codelineno-52-77" name="__codelineno-52-77" href="#__codelineno-52-77"></a>        <span class="p">)</span>
<a id="__codelineno-52-78" name="__codelineno-52-78" href="#__codelineno-52-78"></a>
<a id="__codelineno-52-79" name="__codelineno-52-79" href="#__codelineno-52-79"></a>        <span class="c1"># Reserve inventory</span>
<a id="__codelineno-52-80" name="__codelineno-52-80" href="#__codelineno-52-80"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<a id="__codelineno-52-81" name="__codelineno-52-81" href="#__codelineno-52-81"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">reserve_inventory</span><span class="p">(</span>
<a id="__codelineno-52-82" name="__codelineno-52-82" href="#__codelineno-52-82"></a>                <span class="n">item</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span>
<a id="__codelineno-52-83" name="__codelineno-52-83" href="#__codelineno-52-83"></a>                <span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-52-84" name="__codelineno-52-84" href="#__codelineno-52-84"></a>                <span class="n">order</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-52-85" name="__codelineno-52-85" href="#__codelineno-52-85"></a>            <span class="p">)</span>
<a id="__codelineno-52-86" name="__codelineno-52-86" href="#__codelineno-52-86"></a>
<a id="__codelineno-52-87" name="__codelineno-52-87" href="#__codelineno-52-87"></a>        <span class="c1"># Process payment</span>
<a id="__codelineno-52-88" name="__codelineno-52-88" href="#__codelineno-52-88"></a>        <span class="n">payment_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">payment_service</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span>
<a id="__codelineno-52-89" name="__codelineno-52-89" href="#__codelineno-52-89"></a>            <span class="n">amount</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="p">,</span>
<a id="__codelineno-52-90" name="__codelineno-52-90" href="#__codelineno-52-90"></a>            <span class="n">payment_method_id</span><span class="o">=</span><span class="n">order_data</span><span class="p">[</span><span class="s1">&#39;payment_method_id&#39;</span><span class="p">],</span>
<a id="__codelineno-52-91" name="__codelineno-52-91" href="#__codelineno-52-91"></a>            <span class="n">order_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-52-92" name="__codelineno-52-92" href="#__codelineno-52-92"></a>        <span class="p">)</span>
<a id="__codelineno-52-93" name="__codelineno-52-93" href="#__codelineno-52-93"></a>
<a id="__codelineno-52-94" name="__codelineno-52-94" href="#__codelineno-52-94"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">payment_result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
<a id="__codelineno-52-95" name="__codelineno-52-95" href="#__codelineno-52-95"></a>            <span class="c1"># Release reserved inventory</span>
<a id="__codelineno-52-96" name="__codelineno-52-96" href="#__codelineno-52-96"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release_inventory</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-52-97" name="__codelineno-52-97" href="#__codelineno-52-97"></a>            <span class="k">raise</span> <span class="n">PaymentProcessingError</span><span class="p">(</span><span class="n">payment_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
<a id="__codelineno-52-98" name="__codelineno-52-98" href="#__codelineno-52-98"></a>
<a id="__codelineno-52-99" name="__codelineno-52-99" href="#__codelineno-52-99"></a>        <span class="c1"># Save order</span>
<a id="__codelineno-52-100" name="__codelineno-52-100" href="#__codelineno-52-100"></a>        <span class="n">saved_order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-52-101" name="__codelineno-52-101" href="#__codelineno-52-101"></a>
<a id="__codelineno-52-102" name="__codelineno-52-102" href="#__codelineno-52-102"></a>        <span class="c1"># Publish domain event</span>
<a id="__codelineno-52-103" name="__codelineno-52-103" href="#__codelineno-52-103"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
<a id="__codelineno-52-104" name="__codelineno-52-104" href="#__codelineno-52-104"></a>            <span class="n">OrderCreatedEvent</span><span class="p">(</span>
<a id="__codelineno-52-105" name="__codelineno-52-105" href="#__codelineno-52-105"></a>                <span class="n">order_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">saved_order</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-52-106" name="__codelineno-52-106" href="#__codelineno-52-106"></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">saved_order</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-52-107" name="__codelineno-52-107" href="#__codelineno-52-107"></a>                <span class="n">total_amount</span><span class="o">=</span><span class="n">saved_order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
<a id="__codelineno-52-108" name="__codelineno-52-108" href="#__codelineno-52-108"></a>                <span class="n">currency</span><span class="o">=</span><span class="n">saved_order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">currency</span>
<a id="__codelineno-52-109" name="__codelineno-52-109" href="#__codelineno-52-109"></a>            <span class="p">)</span>
<a id="__codelineno-52-110" name="__codelineno-52-110" href="#__codelineno-52-110"></a>        <span class="p">)</span>
<a id="__codelineno-52-111" name="__codelineno-52-111" href="#__codelineno-52-111"></a>
<a id="__codelineno-52-112" name="__codelineno-52-112" href="#__codelineno-52-112"></a>        <span class="k">return</span> <span class="n">saved_order</span>
<a id="__codelineno-52-113" name="__codelineno-52-113" href="#__codelineno-52-113"></a>
<a id="__codelineno-52-114" name="__codelineno-52-114" href="#__codelineno-52-114"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_release_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>
<a id="__codelineno-52-115" name="__codelineno-52-115" href="#__codelineno-52-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Release reserved inventory in case of failure&quot;&quot;&quot;</span>
<a id="__codelineno-52-116" name="__codelineno-52-116" href="#__codelineno-52-116"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
<a id="__codelineno-52-117" name="__codelineno-52-117" href="#__codelineno-52-117"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-52-118" name="__codelineno-52-118" href="#__codelineno-52-118"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">release_reservation</span><span class="p">(</span>
<a id="__codelineno-52-119" name="__codelineno-52-119" href="#__codelineno-52-119"></a>                    <span class="n">item</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span>
<a id="__codelineno-52-120" name="__codelineno-52-120" href="#__codelineno-52-120"></a>                    <span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-52-121" name="__codelineno-52-121" href="#__codelineno-52-121"></a>                    <span class="n">order</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-52-122" name="__codelineno-52-122" href="#__codelineno-52-122"></a>                <span class="p">)</span>
<a id="__codelineno-52-123" name="__codelineno-52-123" href="#__codelineno-52-123"></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-52-124" name="__codelineno-52-124" href="#__codelineno-52-124"></a>                <span class="c1"># Log but don&#39;t fail the operation</span>
<a id="__codelineno-52-125" name="__codelineno-52-125" href="#__codelineno-52-125"></a>                <span class="k">pass</span>
</code></pre></div>
<h3 id="middleware-and-error-handling"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#middleware-and-error-handling">Middleware and Error Handling</a></h3>
<p>FastAPI middleware integrates cleanly with Clean Architecture concerns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1"># src/presentation/middleware/logging_middleware.py</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...infrastructure.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">RequestLoggingMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>        <span class="c1"># Generate correlation ID</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>        <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>        <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">correlation_id</span> <span class="o">=</span> <span class="n">correlation_id</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>        <span class="c1"># Log request</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>            <span class="s2">&quot;Request started&quot;</span><span class="p">,</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a>                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a>                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
<a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a>                <span class="s2">&quot;client_ip&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
<a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a>                <span class="s2">&quot;user_agent&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">),</span>
<a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a>                <span class="s2">&quot;content_length&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">)</span>
<a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a>            <span class="p">}</span>
<a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a>        <span class="p">)</span>
<a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a>
<a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a>        <span class="c1"># Process request</span>
<a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a>            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a>
<a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a>            <span class="c1"># Log response</span>
<a id="__codelineno-53-37" name="__codelineno-53-37" href="#__codelineno-53-37"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-53-38" name="__codelineno-53-38" href="#__codelineno-53-38"></a>                <span class="s2">&quot;Request completed&quot;</span><span class="p">,</span>
<a id="__codelineno-53-39" name="__codelineno-53-39" href="#__codelineno-53-39"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-40" name="__codelineno-53-40" href="#__codelineno-53-40"></a>                    <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-53-41" name="__codelineno-53-41" href="#__codelineno-53-41"></a>                    <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
<a id="__codelineno-53-42" name="__codelineno-53-42" href="#__codelineno-53-42"></a>                    <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-53-43" name="__codelineno-53-43" href="#__codelineno-53-43"></a>                    <span class="s2">&quot;response_size&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">)</span>
<a id="__codelineno-53-44" name="__codelineno-53-44" href="#__codelineno-53-44"></a>                <span class="p">}</span>
<a id="__codelineno-53-45" name="__codelineno-53-45" href="#__codelineno-53-45"></a>            <span class="p">)</span>
<a id="__codelineno-53-46" name="__codelineno-53-46" href="#__codelineno-53-46"></a>
<a id="__codelineno-53-47" name="__codelineno-53-47" href="#__codelineno-53-47"></a>            <span class="c1"># Add correlation ID to response headers</span>
<a id="__codelineno-53-48" name="__codelineno-53-48" href="#__codelineno-53-48"></a>            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Correlation-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">correlation_id</span>
<a id="__codelineno-53-49" name="__codelineno-53-49" href="#__codelineno-53-49"></a>            <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-53-50" name="__codelineno-53-50" href="#__codelineno-53-50"></a>
<a id="__codelineno-53-51" name="__codelineno-53-51" href="#__codelineno-53-51"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-53-52" name="__codelineno-53-52" href="#__codelineno-53-52"></a>            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-53-53" name="__codelineno-53-53" href="#__codelineno-53-53"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-53-54" name="__codelineno-53-54" href="#__codelineno-53-54"></a>                <span class="s2">&quot;Request failed&quot;</span><span class="p">,</span>
<a id="__codelineno-53-55" name="__codelineno-53-55" href="#__codelineno-53-55"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-56" name="__codelineno-53-56" href="#__codelineno-53-56"></a>                    <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-53-57" name="__codelineno-53-57" href="#__codelineno-53-57"></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-53-58" name="__codelineno-53-58" href="#__codelineno-53-58"></a>                    <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-53-59" name="__codelineno-53-59" href="#__codelineno-53-59"></a>                    <span class="s2">&quot;duration_ms&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-53-60" name="__codelineno-53-60" href="#__codelineno-53-60"></a>                <span class="p">},</span>
<a id="__codelineno-53-61" name="__codelineno-53-61" href="#__codelineno-53-61"></a>                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-53-62" name="__codelineno-53-62" href="#__codelineno-53-62"></a>            <span class="p">)</span>
<a id="__codelineno-53-63" name="__codelineno-53-63" href="#__codelineno-53-63"></a>            <span class="k">raise</span>
<a id="__codelineno-53-64" name="__codelineno-53-64" href="#__codelineno-53-64"></a>
<a id="__codelineno-53-65" name="__codelineno-53-65" href="#__codelineno-53-65"></a><span class="c1"># src/presentation/middleware/exception_handlers.py</span>
<a id="__codelineno-53-66" name="__codelineno-53-66" href="#__codelineno-53-66"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span>
<a id="__codelineno-53-67" name="__codelineno-53-67" href="#__codelineno-53-67"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<a id="__codelineno-53-68" name="__codelineno-53-68" href="#__codelineno-53-68"></a><span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<a id="__codelineno-53-69" name="__codelineno-53-69" href="#__codelineno-53-69"></a>
<a id="__codelineno-53-70" name="__codelineno-53-70" href="#__codelineno-53-70"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...domain.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-53-71" name="__codelineno-53-71" href="#__codelineno-53-71"></a>    <span class="n">DomainException</span><span class="p">,</span>
<a id="__codelineno-53-72" name="__codelineno-53-72" href="#__codelineno-53-72"></a>    <span class="n">OrderNotFoundError</span><span class="p">,</span>
<a id="__codelineno-53-73" name="__codelineno-53-73" href="#__codelineno-53-73"></a>    <span class="n">InsufficientInventoryError</span><span class="p">,</span>
<a id="__codelineno-53-74" name="__codelineno-53-74" href="#__codelineno-53-74"></a>    <span class="n">PaymentProcessingError</span>
<a id="__codelineno-53-75" name="__codelineno-53-75" href="#__codelineno-53-75"></a><span class="p">)</span>
<a id="__codelineno-53-76" name="__codelineno-53-76" href="#__codelineno-53-76"></a><span class="kn">from</span><span class="w"> </span><span class="nn">...infrastructure.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<a id="__codelineno-53-77" name="__codelineno-53-77" href="#__codelineno-53-77"></a>
<a id="__codelineno-53-78" name="__codelineno-53-78" href="#__codelineno-53-78"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-53-79" name="__codelineno-53-79" href="#__codelineno-53-79"></a>
<a id="__codelineno-53-80" name="__codelineno-53-80" href="#__codelineno-53-80"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">domain_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">DomainException</span><span class="p">):</span>
<a id="__codelineno-53-81" name="__codelineno-53-81" href="#__codelineno-53-81"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle domain-specific exceptions&quot;&quot;&quot;</span>
<a id="__codelineno-53-82" name="__codelineno-53-82" href="#__codelineno-53-82"></a>    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;correlation_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<a id="__codelineno-53-83" name="__codelineno-53-83" href="#__codelineno-53-83"></a>
<a id="__codelineno-53-84" name="__codelineno-53-84" href="#__codelineno-53-84"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-53-85" name="__codelineno-53-85" href="#__codelineno-53-85"></a>        <span class="s2">&quot;Domain exception occurred&quot;</span><span class="p">,</span>
<a id="__codelineno-53-86" name="__codelineno-53-86" href="#__codelineno-53-86"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-87" name="__codelineno-53-87" href="#__codelineno-53-87"></a>            <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-53-88" name="__codelineno-53-88" href="#__codelineno-53-88"></a>            <span class="s2">&quot;exception_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-53-89" name="__codelineno-53-89" href="#__codelineno-53-89"></a>            <span class="s2">&quot;exception_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
<a id="__codelineno-53-90" name="__codelineno-53-90" href="#__codelineno-53-90"></a>            <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
<a id="__codelineno-53-91" name="__codelineno-53-91" href="#__codelineno-53-91"></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span>
<a id="__codelineno-53-92" name="__codelineno-53-92" href="#__codelineno-53-92"></a>        <span class="p">}</span>
<a id="__codelineno-53-93" name="__codelineno-53-93" href="#__codelineno-53-93"></a>    <span class="p">)</span>
<a id="__codelineno-53-94" name="__codelineno-53-94" href="#__codelineno-53-94"></a>
<a id="__codelineno-53-95" name="__codelineno-53-95" href="#__codelineno-53-95"></a>    <span class="c1"># Map domain exceptions to HTTP status codes</span>
<a id="__codelineno-53-96" name="__codelineno-53-96" href="#__codelineno-53-96"></a>    <span class="n">status_code_mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-53-97" name="__codelineno-53-97" href="#__codelineno-53-97"></a>        <span class="n">OrderNotFoundError</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span>
<a id="__codelineno-53-98" name="__codelineno-53-98" href="#__codelineno-53-98"></a>        <span class="n">InsufficientInventoryError</span><span class="p">:</span> <span class="mi">409</span><span class="p">,</span>
<a id="__codelineno-53-99" name="__codelineno-53-99" href="#__codelineno-53-99"></a>        <span class="n">PaymentProcessingError</span><span class="p">:</span> <span class="mi">402</span><span class="p">,</span>
<a id="__codelineno-53-100" name="__codelineno-53-100" href="#__codelineno-53-100"></a>    <span class="p">}</span>
<a id="__codelineno-53-101" name="__codelineno-53-101" href="#__codelineno-53-101"></a>
<a id="__codelineno-53-102" name="__codelineno-53-102" href="#__codelineno-53-102"></a>    <span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>
<a id="__codelineno-53-103" name="__codelineno-53-103" href="#__codelineno-53-103"></a>
<a id="__codelineno-53-104" name="__codelineno-53-104" href="#__codelineno-53-104"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
<a id="__codelineno-53-105" name="__codelineno-53-105" href="#__codelineno-53-105"></a>        <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span>
<a id="__codelineno-53-106" name="__codelineno-53-106" href="#__codelineno-53-106"></a>        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-107" name="__codelineno-53-107" href="#__codelineno-53-107"></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-53-108" name="__codelineno-53-108" href="#__codelineno-53-108"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-53-109" name="__codelineno-53-109" href="#__codelineno-53-109"></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
<a id="__codelineno-53-110" name="__codelineno-53-110" href="#__codelineno-53-110"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span>
<a id="__codelineno-53-111" name="__codelineno-53-111" href="#__codelineno-53-111"></a>            <span class="p">}</span>
<a id="__codelineno-53-112" name="__codelineno-53-112" href="#__codelineno-53-112"></a>        <span class="p">}</span>
<a id="__codelineno-53-113" name="__codelineno-53-113" href="#__codelineno-53-113"></a>    <span class="p">)</span>
<a id="__codelineno-53-114" name="__codelineno-53-114" href="#__codelineno-53-114"></a>
<a id="__codelineno-53-115" name="__codelineno-53-115" href="#__codelineno-53-115"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validation_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">ValidationError</span><span class="p">):</span>
<a id="__codelineno-53-116" name="__codelineno-53-116" href="#__codelineno-53-116"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle validation errors from Pydantic&quot;&quot;&quot;</span>
<a id="__codelineno-53-117" name="__codelineno-53-117" href="#__codelineno-53-117"></a>    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;correlation_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<a id="__codelineno-53-118" name="__codelineno-53-118" href="#__codelineno-53-118"></a>
<a id="__codelineno-53-119" name="__codelineno-53-119" href="#__codelineno-53-119"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-53-120" name="__codelineno-53-120" href="#__codelineno-53-120"></a>        <span class="s2">&quot;Validation error occurred&quot;</span><span class="p">,</span>
<a id="__codelineno-53-121" name="__codelineno-53-121" href="#__codelineno-53-121"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-122" name="__codelineno-53-122" href="#__codelineno-53-122"></a>            <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-53-123" name="__codelineno-53-123" href="#__codelineno-53-123"></a>            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">(),</span>
<a id="__codelineno-53-124" name="__codelineno-53-124" href="#__codelineno-53-124"></a>            <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
<a id="__codelineno-53-125" name="__codelineno-53-125" href="#__codelineno-53-125"></a>        <span class="p">}</span>
<a id="__codelineno-53-126" name="__codelineno-53-126" href="#__codelineno-53-126"></a>    <span class="p">)</span>
<a id="__codelineno-53-127" name="__codelineno-53-127" href="#__codelineno-53-127"></a>
<a id="__codelineno-53-128" name="__codelineno-53-128" href="#__codelineno-53-128"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
<a id="__codelineno-53-129" name="__codelineno-53-129" href="#__codelineno-53-129"></a>        <span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span>
<a id="__codelineno-53-130" name="__codelineno-53-130" href="#__codelineno-53-130"></a>        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-131" name="__codelineno-53-131" href="#__codelineno-53-131"></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-53-132" name="__codelineno-53-132" href="#__codelineno-53-132"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ValidationError&quot;</span><span class="p">,</span>
<a id="__codelineno-53-133" name="__codelineno-53-133" href="#__codelineno-53-133"></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Request validation failed&quot;</span><span class="p">,</span>
<a id="__codelineno-53-134" name="__codelineno-53-134" href="#__codelineno-53-134"></a>                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">(),</span>
<a id="__codelineno-53-135" name="__codelineno-53-135" href="#__codelineno-53-135"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span>
<a id="__codelineno-53-136" name="__codelineno-53-136" href="#__codelineno-53-136"></a>            <span class="p">}</span>
<a id="__codelineno-53-137" name="__codelineno-53-137" href="#__codelineno-53-137"></a>        <span class="p">}</span>
<a id="__codelineno-53-138" name="__codelineno-53-138" href="#__codelineno-53-138"></a>    <span class="p">)</span>
<a id="__codelineno-53-139" name="__codelineno-53-139" href="#__codelineno-53-139"></a>
<a id="__codelineno-53-140" name="__codelineno-53-140" href="#__codelineno-53-140"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">http_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">HTTPException</span><span class="p">):</span>
<a id="__codelineno-53-141" name="__codelineno-53-141" href="#__codelineno-53-141"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle FastAPI HTTP exceptions&quot;&quot;&quot;</span>
<a id="__codelineno-53-142" name="__codelineno-53-142" href="#__codelineno-53-142"></a>    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;correlation_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<a id="__codelineno-53-143" name="__codelineno-53-143" href="#__codelineno-53-143"></a>
<a id="__codelineno-53-144" name="__codelineno-53-144" href="#__codelineno-53-144"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
<a id="__codelineno-53-145" name="__codelineno-53-145" href="#__codelineno-53-145"></a>        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
<a id="__codelineno-53-146" name="__codelineno-53-146" href="#__codelineno-53-146"></a>        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-147" name="__codelineno-53-147" href="#__codelineno-53-147"></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-53-148" name="__codelineno-53-148" href="#__codelineno-53-148"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTPException&quot;</span><span class="p">,</span>
<a id="__codelineno-53-149" name="__codelineno-53-149" href="#__codelineno-53-149"></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span>
<a id="__codelineno-53-150" name="__codelineno-53-150" href="#__codelineno-53-150"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span>
<a id="__codelineno-53-151" name="__codelineno-53-151" href="#__codelineno-53-151"></a>            <span class="p">}</span>
<a id="__codelineno-53-152" name="__codelineno-53-152" href="#__codelineno-53-152"></a>        <span class="p">}</span>
<a id="__codelineno-53-153" name="__codelineno-53-153" href="#__codelineno-53-153"></a>    <span class="p">)</span>
<a id="__codelineno-53-154" name="__codelineno-53-154" href="#__codelineno-53-154"></a>
<a id="__codelineno-53-155" name="__codelineno-53-155" href="#__codelineno-53-155"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">internal_server_error_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<a id="__codelineno-53-156" name="__codelineno-53-156" href="#__codelineno-53-156"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle unexpected server errors&quot;&quot;&quot;</span>
<a id="__codelineno-53-157" name="__codelineno-53-157" href="#__codelineno-53-157"></a>    <span class="n">correlation_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;correlation_id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<a id="__codelineno-53-158" name="__codelineno-53-158" href="#__codelineno-53-158"></a>
<a id="__codelineno-53-159" name="__codelineno-53-159" href="#__codelineno-53-159"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-53-160" name="__codelineno-53-160" href="#__codelineno-53-160"></a>        <span class="s2">&quot;Unexpected server error&quot;</span><span class="p">,</span>
<a id="__codelineno-53-161" name="__codelineno-53-161" href="#__codelineno-53-161"></a>        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-162" name="__codelineno-53-162" href="#__codelineno-53-162"></a>            <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">,</span>
<a id="__codelineno-53-163" name="__codelineno-53-163" href="#__codelineno-53-163"></a>            <span class="s2">&quot;exception_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-53-164" name="__codelineno-53-164" href="#__codelineno-53-164"></a>            <span class="s2">&quot;exception_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
<a id="__codelineno-53-165" name="__codelineno-53-165" href="#__codelineno-53-165"></a>            <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
<a id="__codelineno-53-166" name="__codelineno-53-166" href="#__codelineno-53-166"></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
<a id="__codelineno-53-167" name="__codelineno-53-167" href="#__codelineno-53-167"></a>            <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
<a id="__codelineno-53-168" name="__codelineno-53-168" href="#__codelineno-53-168"></a>        <span class="p">}</span>
<a id="__codelineno-53-169" name="__codelineno-53-169" href="#__codelineno-53-169"></a>    <span class="p">)</span>
<a id="__codelineno-53-170" name="__codelineno-53-170" href="#__codelineno-53-170"></a>
<a id="__codelineno-53-171" name="__codelineno-53-171" href="#__codelineno-53-171"></a>    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
<a id="__codelineno-53-172" name="__codelineno-53-172" href="#__codelineno-53-172"></a>        <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
<a id="__codelineno-53-173" name="__codelineno-53-173" href="#__codelineno-53-173"></a>        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-53-174" name="__codelineno-53-174" href="#__codelineno-53-174"></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-53-175" name="__codelineno-53-175" href="#__codelineno-53-175"></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InternalServerError&quot;</span><span class="p">,</span>
<a id="__codelineno-53-176" name="__codelineno-53-176" href="#__codelineno-53-176"></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;An unexpected error occurred&quot;</span><span class="p">,</span>
<a id="__codelineno-53-177" name="__codelineno-53-177" href="#__codelineno-53-177"></a>                <span class="s2">&quot;correlation_id&quot;</span><span class="p">:</span> <span class="n">correlation_id</span>
<a id="__codelineno-53-178" name="__codelineno-53-178" href="#__codelineno-53-178"></a>            <span class="p">}</span>
<a id="__codelineno-53-179" name="__codelineno-53-179" href="#__codelineno-53-179"></a>        <span class="p">}</span>
<a id="__codelineno-53-180" name="__codelineno-53-180" href="#__codelineno-53-180"></a>    <span class="p">)</span>
</code></pre></div>
<h3 id="application-factory-pattern"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#application-factory-pattern">Application Factory Pattern</a></h3>
<p>The application factory pattern provides clean initialization:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1"># src/presentation/main.py</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.routers</span><span class="w"> </span><span class="kn">import</span> <span class="n">orders</span><span class="p">,</span> <span class="n">products</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">auth</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.middleware.logging_middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestLoggingMiddleware</span>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.middleware.exception_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>    <span class="n">domain_exception_handler</span><span class="p">,</span>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>    <span class="n">validation_exception_handler</span><span class="p">,</span>
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a>    <span class="n">http_exception_handler</span><span class="p">,</span>
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>    <span class="n">internal_server_error_handler</span>
<a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="p">)</span>
<a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..domain.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DomainException</span>
<a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..infrastructure.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">configure_logging</span>
<a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..infrastructure.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_database</span>
<a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a>
<a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a><span class="nd">@asynccontextmanager</span>
<a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Application lifespan manager&quot;&quot;&quot;</span>
<a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a>    <span class="c1"># Startup</span>
<a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a>    <span class="n">configure_logging</span><span class="p">()</span>
<a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a>    <span class="k">await</span> <span class="n">initialize_database</span><span class="p">()</span>
<a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a>
<a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a>    <span class="k">yield</span>
<a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a>
<a id="__codelineno-54-28" name="__codelineno-54-28" href="#__codelineno-54-28"></a>    <span class="c1"># Shutdown</span>
<a id="__codelineno-54-29" name="__codelineno-54-29" href="#__codelineno-54-29"></a>    <span class="k">await</span> <span class="n">cleanup_resources</span><span class="p">()</span>
<a id="__codelineno-54-30" name="__codelineno-54-30" href="#__codelineno-54-30"></a>
<a id="__codelineno-54-31" name="__codelineno-54-31" href="#__codelineno-54-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_application</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FastAPI</span><span class="p">:</span>
<a id="__codelineno-54-32" name="__codelineno-54-32" href="#__codelineno-54-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Application factory function&quot;&quot;&quot;</span>
<a id="__codelineno-54-33" name="__codelineno-54-33" href="#__codelineno-54-33"></a>
<a id="__codelineno-54-34" name="__codelineno-54-34" href="#__codelineno-54-34"></a>    <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
<a id="__codelineno-54-35" name="__codelineno-54-35" href="#__codelineno-54-35"></a>        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Clean Architecture E-commerce API&quot;</span><span class="p">,</span>
<a id="__codelineno-54-36" name="__codelineno-54-36" href="#__codelineno-54-36"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Production-ready e-commerce API built with Clean Architecture principles&quot;</span><span class="p">,</span>
<a id="__codelineno-54-37" name="__codelineno-54-37" href="#__codelineno-54-37"></a>        <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<a id="__codelineno-54-38" name="__codelineno-54-38" href="#__codelineno-54-38"></a>        <span class="n">docs_url</span><span class="o">=</span><span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
<a id="__codelineno-54-39" name="__codelineno-54-39" href="#__codelineno-54-39"></a>        <span class="n">redoc_url</span><span class="o">=</span><span class="s2">&quot;/redoc&quot;</span><span class="p">,</span>
<a id="__codelineno-54-40" name="__codelineno-54-40" href="#__codelineno-54-40"></a>        <span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span>
<a id="__codelineno-54-41" name="__codelineno-54-41" href="#__codelineno-54-41"></a>    <span class="p">)</span>
<a id="__codelineno-54-42" name="__codelineno-54-42" href="#__codelineno-54-42"></a>
<a id="__codelineno-54-43" name="__codelineno-54-43" href="#__codelineno-54-43"></a>    <span class="c1"># Add CORS middleware</span>
<a id="__codelineno-54-44" name="__codelineno-54-44" href="#__codelineno-54-44"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
<a id="__codelineno-54-45" name="__codelineno-54-45" href="#__codelineno-54-45"></a>        <span class="n">CORSMiddleware</span><span class="p">,</span>
<a id="__codelineno-54-46" name="__codelineno-54-46" href="#__codelineno-54-46"></a>        <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;https://yourapp.com&quot;</span><span class="p">,</span> <span class="s2">&quot;https://admin.yourapp.com&quot;</span><span class="p">],</span>
<a id="__codelineno-54-47" name="__codelineno-54-47" href="#__codelineno-54-47"></a>        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-54-48" name="__codelineno-54-48" href="#__codelineno-54-48"></a>        <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">],</span>
<a id="__codelineno-54-49" name="__codelineno-54-49" href="#__codelineno-54-49"></a>        <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<a id="__codelineno-54-50" name="__codelineno-54-50" href="#__codelineno-54-50"></a>    <span class="p">)</span>
<a id="__codelineno-54-51" name="__codelineno-54-51" href="#__codelineno-54-51"></a>
<a id="__codelineno-54-52" name="__codelineno-54-52" href="#__codelineno-54-52"></a>    <span class="c1"># Add custom middleware</span>
<a id="__codelineno-54-53" name="__codelineno-54-53" href="#__codelineno-54-53"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">RequestLoggingMiddleware</span><span class="p">)</span>
<a id="__codelineno-54-54" name="__codelineno-54-54" href="#__codelineno-54-54"></a>
<a id="__codelineno-54-55" name="__codelineno-54-55" href="#__codelineno-54-55"></a>    <span class="c1"># Register exception handlers</span>
<a id="__codelineno-54-56" name="__codelineno-54-56" href="#__codelineno-54-56"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">DomainException</span><span class="p">,</span> <span class="n">domain_exception_handler</span><span class="p">)</span>
<a id="__codelineno-54-57" name="__codelineno-54-57" href="#__codelineno-54-57"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="n">validation_exception_handler</span><span class="p">)</span>
<a id="__codelineno-54-58" name="__codelineno-54-58" href="#__codelineno-54-58"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">,</span> <span class="n">http_exception_handler</span><span class="p">)</span>
<a id="__codelineno-54-59" name="__codelineno-54-59" href="#__codelineno-54-59"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">internal_server_error_handler</span><span class="p">)</span>
<a id="__codelineno-54-60" name="__codelineno-54-60" href="#__codelineno-54-60"></a>
<a id="__codelineno-54-61" name="__codelineno-54-61" href="#__codelineno-54-61"></a>    <span class="c1"># Include routers</span>
<a id="__codelineno-54-62" name="__codelineno-54-62" href="#__codelineno-54-62"></a>    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
<a id="__codelineno-54-63" name="__codelineno-54-63" href="#__codelineno-54-63"></a>    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
<a id="__codelineno-54-64" name="__codelineno-54-64" href="#__codelineno-54-64"></a>    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">products</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
<a id="__codelineno-54-65" name="__codelineno-54-65" href="#__codelineno-54-65"></a>    <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
<a id="__codelineno-54-66" name="__codelineno-54-66" href="#__codelineno-54-66"></a>
<a id="__codelineno-54-67" name="__codelineno-54-67" href="#__codelineno-54-67"></a>    <span class="c1"># Health check endpoint</span>
<a id="__codelineno-54-68" name="__codelineno-54-68" href="#__codelineno-54-68"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
<a id="__codelineno-54-69" name="__codelineno-54-69" href="#__codelineno-54-69"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<a id="__codelineno-54-70" name="__codelineno-54-70" href="#__codelineno-54-70"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">}</span>
<a id="__codelineno-54-71" name="__codelineno-54-71" href="#__codelineno-54-71"></a>
<a id="__codelineno-54-72" name="__codelineno-54-72" href="#__codelineno-54-72"></a>    <span class="k">return</span> <span class="n">app</span>
<a id="__codelineno-54-73" name="__codelineno-54-73" href="#__codelineno-54-73"></a>
<a id="__codelineno-54-74" name="__codelineno-54-74" href="#__codelineno-54-74"></a><span class="c1"># Create application instance</span>
<a id="__codelineno-54-75" name="__codelineno-54-75" href="#__codelineno-54-75"></a><span class="n">app</span> <span class="o">=</span> <span class="n">create_application</span><span class="p">()</span>
<a id="__codelineno-54-76" name="__codelineno-54-76" href="#__codelineno-54-76"></a>
<a id="__codelineno-54-77" name="__codelineno-54-77" href="#__codelineno-54-77"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-54-78" name="__codelineno-54-78" href="#__codelineno-54-78"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-54-79" name="__codelineno-54-79" href="#__codelineno-54-79"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
</code></pre></div>
<h3 id="testing-fastapi-with-clean-architecture"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#testing-fastapi-with-clean-architecture">Testing FastAPI with Clean Architecture</a></h3>
<p>The combination enables comprehensive testing at all levels:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># tests/presentation/test_orders_api.py</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">AsyncMock</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.presentation.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.user</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.application.use_cases.orders.create_order</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateOrderUseCase</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a>    <span class="k">return</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">mock_create_order_use_case</span><span class="p">():</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>    <span class="k">return</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">CreateOrderUseCase</span><span class="p">)</span>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a>
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">mock_user</span><span class="p">():</span>
<a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a>    <span class="k">return</span> <span class="n">User</span><span class="p">(</span>
<a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a>        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
<a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a>        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a>        <span class="n">first_name</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span>
<a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a>        <span class="n">last_name</span><span class="o">=</span><span class="s2">&quot;User&quot;</span><span class="p">,</span>
<a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a>        <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-55-27" name="__codelineno-55-27" href="#__codelineno-55-27"></a>    <span class="p">)</span>
<a id="__codelineno-55-28" name="__codelineno-55-28" href="#__codelineno-55-28"></a>
<a id="__codelineno-55-29" name="__codelineno-55-29" href="#__codelineno-55-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestOrdersAPI</span><span class="p">:</span>
<a id="__codelineno-55-30" name="__codelineno-55-30" href="#__codelineno-55-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_order_success</span><span class="p">(</span>
<a id="__codelineno-55-31" name="__codelineno-55-31" href="#__codelineno-55-31"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-55-32" name="__codelineno-55-32" href="#__codelineno-55-32"></a>        <span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">,</span> 
<a id="__codelineno-55-33" name="__codelineno-55-33" href="#__codelineno-55-33"></a>        <span class="n">mock_create_order_use_case</span><span class="p">:</span> <span class="n">Mock</span><span class="p">,</span>
<a id="__codelineno-55-34" name="__codelineno-55-34" href="#__codelineno-55-34"></a>        <span class="n">mock_user</span><span class="p">:</span> <span class="n">User</span>
<a id="__codelineno-55-35" name="__codelineno-55-35" href="#__codelineno-55-35"></a>    <span class="p">):</span>
<a id="__codelineno-55-36" name="__codelineno-55-36" href="#__codelineno-55-36"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test successful order creation&quot;&quot;&quot;</span>
<a id="__codelineno-55-37" name="__codelineno-55-37" href="#__codelineno-55-37"></a>
<a id="__codelineno-55-38" name="__codelineno-55-38" href="#__codelineno-55-38"></a>        <span class="c1"># Mock dependencies</span>
<a id="__codelineno-55-39" name="__codelineno-55-39" href="#__codelineno-55-39"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_create_order_use_case</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_create_order_use_case</span>
<a id="__codelineno-55-40" name="__codelineno-55-40" href="#__codelineno-55-40"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_current_user</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_user</span>
<a id="__codelineno-55-41" name="__codelineno-55-41" href="#__codelineno-55-41"></a>
<a id="__codelineno-55-42" name="__codelineno-55-42" href="#__codelineno-55-42"></a>        <span class="c1"># Mock use case response</span>
<a id="__codelineno-55-43" name="__codelineno-55-43" href="#__codelineno-55-43"></a>        <span class="n">expected_order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-55-44" name="__codelineno-55-44" href="#__codelineno-55-44"></a>            <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
<a id="__codelineno-55-45" name="__codelineno-55-45" href="#__codelineno-55-45"></a>            <span class="n">items_data</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod123&quot;</span><span class="p">,</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
<a id="__codelineno-55-46" name="__codelineno-55-46" href="#__codelineno-55-46"></a>            <span class="n">products</span><span class="o">=</span><span class="p">[],</span>
<a id="__codelineno-55-47" name="__codelineno-55-47" href="#__codelineno-55-47"></a>            <span class="n">shipping_address</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;street&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Main St&quot;</span><span class="p">},</span>
<a id="__codelineno-55-48" name="__codelineno-55-48" href="#__codelineno-55-48"></a>            <span class="n">payment_method_id</span><span class="o">=</span><span class="s2">&quot;pm123&quot;</span>
<a id="__codelineno-55-49" name="__codelineno-55-49" href="#__codelineno-55-49"></a>        <span class="p">)</span>
<a id="__codelineno-55-50" name="__codelineno-55-50" href="#__codelineno-55-50"></a>        <span class="n">mock_create_order_use_case</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">expected_order</span><span class="p">)</span>
<a id="__codelineno-55-51" name="__codelineno-55-51" href="#__codelineno-55-51"></a>
<a id="__codelineno-55-52" name="__codelineno-55-52" href="#__codelineno-55-52"></a>        <span class="c1"># Make request</span>
<a id="__codelineno-55-53" name="__codelineno-55-53" href="#__codelineno-55-53"></a>        <span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-55-54" name="__codelineno-55-54" href="#__codelineno-55-54"></a>            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod123&quot;</span><span class="p">,</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
<a id="__codelineno-55-55" name="__codelineno-55-55" href="#__codelineno-55-55"></a>            <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-55-56" name="__codelineno-55-56" href="#__codelineno-55-56"></a>                <span class="s2">&quot;street_address&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-55-57" name="__codelineno-55-57" href="#__codelineno-55-57"></a>                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Seattle&quot;</span><span class="p">,</span>
<a id="__codelineno-55-58" name="__codelineno-55-58" href="#__codelineno-55-58"></a>                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;WA&quot;</span><span class="p">,</span>
<a id="__codelineno-55-59" name="__codelineno-55-59" href="#__codelineno-55-59"></a>                <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;98101&quot;</span><span class="p">,</span>
<a id="__codelineno-55-60" name="__codelineno-55-60" href="#__codelineno-55-60"></a>                <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span>
<a id="__codelineno-55-61" name="__codelineno-55-61" href="#__codelineno-55-61"></a>            <span class="p">},</span>
<a id="__codelineno-55-62" name="__codelineno-55-62" href="#__codelineno-55-62"></a>            <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm123&quot;</span>
<a id="__codelineno-55-63" name="__codelineno-55-63" href="#__codelineno-55-63"></a>        <span class="p">}</span>
<a id="__codelineno-55-64" name="__codelineno-55-64" href="#__codelineno-55-64"></a>
<a id="__codelineno-55-65" name="__codelineno-55-65" href="#__codelineno-55-65"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/orders/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">request_data</span><span class="p">)</span>
<a id="__codelineno-55-66" name="__codelineno-55-66" href="#__codelineno-55-66"></a>
<a id="__codelineno-55-67" name="__codelineno-55-67" href="#__codelineno-55-67"></a>        <span class="c1"># Assertions</span>
<a id="__codelineno-55-68" name="__codelineno-55-68" href="#__codelineno-55-68"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<a id="__codelineno-55-69" name="__codelineno-55-69" href="#__codelineno-55-69"></a>        <span class="n">response_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-55-70" name="__codelineno-55-70" href="#__codelineno-55-70"></a>        <span class="k">assert</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">expected_order</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-55-71" name="__codelineno-55-71" href="#__codelineno-55-71"></a>        <span class="k">assert</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span>
<a id="__codelineno-55-72" name="__codelineno-55-72" href="#__codelineno-55-72"></a>
<a id="__codelineno-55-73" name="__codelineno-55-73" href="#__codelineno-55-73"></a>        <span class="c1"># Verify use case was called correctly</span>
<a id="__codelineno-55-74" name="__codelineno-55-74" href="#__codelineno-55-74"></a>        <span class="n">mock_create_order_use_case</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-55-75" name="__codelineno-55-75" href="#__codelineno-55-75"></a>
<a id="__codelineno-55-76" name="__codelineno-55-76" href="#__codelineno-55-76"></a>        <span class="c1"># Clean up</span>
<a id="__codelineno-55-77" name="__codelineno-55-77" href="#__codelineno-55-77"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-55-78" name="__codelineno-55-78" href="#__codelineno-55-78"></a>
<a id="__codelineno-55-79" name="__codelineno-55-79" href="#__codelineno-55-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_order_validation_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">,</span> <span class="n">mock_user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span>
<a id="__codelineno-55-80" name="__codelineno-55-80" href="#__codelineno-55-80"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test order creation with validation errors&quot;&quot;&quot;</span>
<a id="__codelineno-55-81" name="__codelineno-55-81" href="#__codelineno-55-81"></a>
<a id="__codelineno-55-82" name="__codelineno-55-82" href="#__codelineno-55-82"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_current_user</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_user</span>
<a id="__codelineno-55-83" name="__codelineno-55-83" href="#__codelineno-55-83"></a>
<a id="__codelineno-55-84" name="__codelineno-55-84" href="#__codelineno-55-84"></a>        <span class="c1"># Invalid request data (missing required fields)</span>
<a id="__codelineno-55-85" name="__codelineno-55-85" href="#__codelineno-55-85"></a>        <span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-55-86" name="__codelineno-55-86" href="#__codelineno-55-86"></a>            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Empty items should fail validation</span>
<a id="__codelineno-55-87" name="__codelineno-55-87" href="#__codelineno-55-87"></a>            <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm123&quot;</span>
<a id="__codelineno-55-88" name="__codelineno-55-88" href="#__codelineno-55-88"></a>        <span class="p">}</span>
<a id="__codelineno-55-89" name="__codelineno-55-89" href="#__codelineno-55-89"></a>
<a id="__codelineno-55-90" name="__codelineno-55-90" href="#__codelineno-55-90"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/orders/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">request_data</span><span class="p">)</span>
<a id="__codelineno-55-91" name="__codelineno-55-91" href="#__codelineno-55-91"></a>
<a id="__codelineno-55-92" name="__codelineno-55-92" href="#__codelineno-55-92"></a>        <span class="c1"># Assertions</span>
<a id="__codelineno-55-93" name="__codelineno-55-93" href="#__codelineno-55-93"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
<a id="__codelineno-55-94" name="__codelineno-55-94" href="#__codelineno-55-94"></a>        <span class="n">response_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-55-95" name="__codelineno-55-95" href="#__codelineno-55-95"></a>        <span class="k">assert</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response_data</span>
<a id="__codelineno-55-96" name="__codelineno-55-96" href="#__codelineno-55-96"></a>        <span class="k">assert</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ValidationError&quot;</span>
<a id="__codelineno-55-97" name="__codelineno-55-97" href="#__codelineno-55-97"></a>
<a id="__codelineno-55-98" name="__codelineno-55-98" href="#__codelineno-55-98"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-55-99" name="__codelineno-55-99" href="#__codelineno-55-99"></a>
<a id="__codelineno-55-100" name="__codelineno-55-100" href="#__codelineno-55-100"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_order_domain_exception</span><span class="p">(</span>
<a id="__codelineno-55-101" name="__codelineno-55-101" href="#__codelineno-55-101"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-55-102" name="__codelineno-55-102" href="#__codelineno-55-102"></a>        <span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">,</span> 
<a id="__codelineno-55-103" name="__codelineno-55-103" href="#__codelineno-55-103"></a>        <span class="n">mock_create_order_use_case</span><span class="p">:</span> <span class="n">Mock</span><span class="p">,</span>
<a id="__codelineno-55-104" name="__codelineno-55-104" href="#__codelineno-55-104"></a>        <span class="n">mock_user</span><span class="p">:</span> <span class="n">User</span>
<a id="__codelineno-55-105" name="__codelineno-55-105" href="#__codelineno-55-105"></a>    <span class="p">):</span>
<a id="__codelineno-55-106" name="__codelineno-55-106" href="#__codelineno-55-106"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test order creation with domain exception&quot;&quot;&quot;</span>
<a id="__codelineno-55-107" name="__codelineno-55-107" href="#__codelineno-55-107"></a>
<a id="__codelineno-55-108" name="__codelineno-55-108" href="#__codelineno-55-108"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_create_order_use_case</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_create_order_use_case</span>
<a id="__codelineno-55-109" name="__codelineno-55-109" href="#__codelineno-55-109"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_current_user</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">mock_user</span>
<a id="__codelineno-55-110" name="__codelineno-55-110" href="#__codelineno-55-110"></a>
<a id="__codelineno-55-111" name="__codelineno-55-111" href="#__codelineno-55-111"></a>        <span class="c1"># Mock use case to raise domain exception</span>
<a id="__codelineno-55-112" name="__codelineno-55-112" href="#__codelineno-55-112"></a>        <span class="n">mock_create_order_use_case</span><span class="o">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">(</span>
<a id="__codelineno-55-113" name="__codelineno-55-113" href="#__codelineno-55-113"></a>            <span class="n">side_effect</span><span class="o">=</span><span class="n">InsufficientInventoryError</span><span class="p">(</span><span class="s2">&quot;Product out of stock&quot;</span><span class="p">)</span>
<a id="__codelineno-55-114" name="__codelineno-55-114" href="#__codelineno-55-114"></a>        <span class="p">)</span>
<a id="__codelineno-55-115" name="__codelineno-55-115" href="#__codelineno-55-115"></a>
<a id="__codelineno-55-116" name="__codelineno-55-116" href="#__codelineno-55-116"></a>        <span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-55-117" name="__codelineno-55-117" href="#__codelineno-55-117"></a>            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="s2">&quot;prod123&quot;</span><span class="p">,</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span>
<a id="__codelineno-55-118" name="__codelineno-55-118" href="#__codelineno-55-118"></a>            <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-55-119" name="__codelineno-55-119" href="#__codelineno-55-119"></a>                <span class="s2">&quot;street_address&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-55-120" name="__codelineno-55-120" href="#__codelineno-55-120"></a>                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Seattle&quot;</span><span class="p">,</span>
<a id="__codelineno-55-121" name="__codelineno-55-121" href="#__codelineno-55-121"></a>                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;WA&quot;</span><span class="p">,</span>
<a id="__codelineno-55-122" name="__codelineno-55-122" href="#__codelineno-55-122"></a>                <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;98101&quot;</span><span class="p">,</span>
<a id="__codelineno-55-123" name="__codelineno-55-123" href="#__codelineno-55-123"></a>                <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span>
<a id="__codelineno-55-124" name="__codelineno-55-124" href="#__codelineno-55-124"></a>            <span class="p">},</span>
<a id="__codelineno-55-125" name="__codelineno-55-125" href="#__codelineno-55-125"></a>            <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm123&quot;</span>
<a id="__codelineno-55-126" name="__codelineno-55-126" href="#__codelineno-55-126"></a>        <span class="p">}</span>
<a id="__codelineno-55-127" name="__codelineno-55-127" href="#__codelineno-55-127"></a>
<a id="__codelineno-55-128" name="__codelineno-55-128" href="#__codelineno-55-128"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/orders/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">request_data</span><span class="p">)</span>
<a id="__codelineno-55-129" name="__codelineno-55-129" href="#__codelineno-55-129"></a>
<a id="__codelineno-55-130" name="__codelineno-55-130" href="#__codelineno-55-130"></a>        <span class="c1"># Assertions</span>
<a id="__codelineno-55-131" name="__codelineno-55-131" href="#__codelineno-55-131"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span>  <span class="c1"># Conflict for insufficient inventory</span>
<a id="__codelineno-55-132" name="__codelineno-55-132" href="#__codelineno-55-132"></a>        <span class="n">response_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-55-133" name="__codelineno-55-133" href="#__codelineno-55-133"></a>        <span class="k">assert</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;InsufficientInventoryError&quot;</span>
<a id="__codelineno-55-134" name="__codelineno-55-134" href="#__codelineno-55-134"></a>        <span class="k">assert</span> <span class="s2">&quot;Product out of stock&quot;</span> <span class="ow">in</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
<a id="__codelineno-55-135" name="__codelineno-55-135" href="#__codelineno-55-135"></a>
<a id="__codelineno-55-136" name="__codelineno-55-136" href="#__codelineno-55-136"></a>        <span class="n">app</span><span class="o">.</span><span class="n">dependency_overrides</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-55-137" name="__codelineno-55-137" href="#__codelineno-55-137"></a>
<a id="__codelineno-55-138" name="__codelineno-55-138" href="#__codelineno-55-138"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_order_unauthorized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">):</span>
<a id="__codelineno-55-139" name="__codelineno-55-139" href="#__codelineno-55-139"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test getting order without authentication&quot;&quot;&quot;</span>
<a id="__codelineno-55-140" name="__codelineno-55-140" href="#__codelineno-55-140"></a>
<a id="__codelineno-55-141" name="__codelineno-55-141" href="#__codelineno-55-141"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/orders/order123&quot;</span><span class="p">)</span>
<a id="__codelineno-55-142" name="__codelineno-55-142" href="#__codelineno-55-142"></a>
<a id="__codelineno-55-143" name="__codelineno-55-143" href="#__codelineno-55-143"></a>        <span class="c1"># Should return 401 Unauthorized</span>
<a id="__codelineno-55-144" name="__codelineno-55-144" href="#__codelineno-55-144"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
<a id="__codelineno-55-145" name="__codelineno-55-145" href="#__codelineno-55-145"></a>
<a id="__codelineno-55-146" name="__codelineno-55-146" href="#__codelineno-55-146"></a><span class="c1"># tests/integration/test_order_flow.py</span>
<a id="__codelineno-55-147" name="__codelineno-55-147" href="#__codelineno-55-147"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-55-148" name="__codelineno-55-148" href="#__codelineno-55-148"></a><span class="kn">from</span><span class="w"> </span><span class="nn">httpx</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span>
<a id="__codelineno-55-149" name="__codelineno-55-149" href="#__codelineno-55-149"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<a id="__codelineno-55-150" name="__codelineno-55-150" href="#__codelineno-55-150"></a>
<a id="__codelineno-55-151" name="__codelineno-55-151" href="#__codelineno-55-151"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tests.fixtures.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">test_database</span>
<a id="__codelineno-55-152" name="__codelineno-55-152" href="#__codelineno-55-152"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tests.fixtures.test_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_test_user</span><span class="p">,</span> <span class="n">create_test_products</span>
<a id="__codelineno-55-153" name="__codelineno-55-153" href="#__codelineno-55-153"></a>
<a id="__codelineno-55-154" name="__codelineno-55-154" href="#__codelineno-55-154"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-55-155" name="__codelineno-55-155" href="#__codelineno-55-155"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestOrderFlowIntegration</span><span class="p">:</span>
<a id="__codelineno-55-156" name="__codelineno-55-156" href="#__codelineno-55-156"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_complete_order_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">test_database</span><span class="p">):</span>
<a id="__codelineno-55-157" name="__codelineno-55-157" href="#__codelineno-55-157"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test complete order creation flow with real database&quot;&quot;&quot;</span>
<a id="__codelineno-55-158" name="__codelineno-55-158" href="#__codelineno-55-158"></a>
<a id="__codelineno-55-159" name="__codelineno-55-159" href="#__codelineno-55-159"></a>        <span class="c1"># Setup test data</span>
<a id="__codelineno-55-160" name="__codelineno-55-160" href="#__codelineno-55-160"></a>        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_test_user</span><span class="p">()</span>
<a id="__codelineno-55-161" name="__codelineno-55-161" href="#__codelineno-55-161"></a>        <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_test_products</span><span class="p">()</span>
<a id="__codelineno-55-162" name="__codelineno-55-162" href="#__codelineno-55-162"></a>
<a id="__codelineno-55-163" name="__codelineno-55-163" href="#__codelineno-55-163"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncClient</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://test&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-55-164" name="__codelineno-55-164" href="#__codelineno-55-164"></a>            <span class="c1"># Login to get token</span>
<a id="__codelineno-55-165" name="__codelineno-55-165" href="#__codelineno-55-165"></a>            <span class="n">login_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-55-166" name="__codelineno-55-166" href="#__codelineno-55-166"></a>                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-55-167" name="__codelineno-55-167" href="#__codelineno-55-167"></a>                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;testpassword&quot;</span>
<a id="__codelineno-55-168" name="__codelineno-55-168" href="#__codelineno-55-168"></a>            <span class="p">})</span>
<a id="__codelineno-55-169" name="__codelineno-55-169" href="#__codelineno-55-169"></a>            <span class="k">assert</span> <span class="n">login_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-55-170" name="__codelineno-55-170" href="#__codelineno-55-170"></a>            <span class="n">token</span> <span class="o">=</span> <span class="n">login_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
<a id="__codelineno-55-171" name="__codelineno-55-171" href="#__codelineno-55-171"></a>
<a id="__codelineno-55-172" name="__codelineno-55-172" href="#__codelineno-55-172"></a>            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
<a id="__codelineno-55-173" name="__codelineno-55-173" href="#__codelineno-55-173"></a>
<a id="__codelineno-55-174" name="__codelineno-55-174" href="#__codelineno-55-174"></a>            <span class="c1"># Create order</span>
<a id="__codelineno-55-175" name="__codelineno-55-175" href="#__codelineno-55-175"></a>            <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-55-176" name="__codelineno-55-176" href="#__codelineno-55-176"></a>                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-55-177" name="__codelineno-55-177" href="#__codelineno-55-177"></a>                    <span class="p">{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">products</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
<a id="__codelineno-55-178" name="__codelineno-55-178" href="#__codelineno-55-178"></a>                    <span class="p">{</span><span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">products</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<a id="__codelineno-55-179" name="__codelineno-55-179" href="#__codelineno-55-179"></a>                <span class="p">],</span>
<a id="__codelineno-55-180" name="__codelineno-55-180" href="#__codelineno-55-180"></a>                <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-55-181" name="__codelineno-55-181" href="#__codelineno-55-181"></a>                    <span class="s2">&quot;street_address&quot;</span><span class="p">:</span> <span class="s2">&quot;123 Test St&quot;</span><span class="p">,</span>
<a id="__codelineno-55-182" name="__codelineno-55-182" href="#__codelineno-55-182"></a>                    <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Test City&quot;</span><span class="p">,</span>
<a id="__codelineno-55-183" name="__codelineno-55-183" href="#__codelineno-55-183"></a>                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;TS&quot;</span><span class="p">,</span>
<a id="__codelineno-55-184" name="__codelineno-55-184" href="#__codelineno-55-184"></a>                    <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<a id="__codelineno-55-185" name="__codelineno-55-185" href="#__codelineno-55-185"></a>                    <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span>
<a id="__codelineno-55-186" name="__codelineno-55-186" href="#__codelineno-55-186"></a>                <span class="p">},</span>
<a id="__codelineno-55-187" name="__codelineno-55-187" href="#__codelineno-55-187"></a>                <span class="s2">&quot;payment_method_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pm_test123&quot;</span>
<a id="__codelineno-55-188" name="__codelineno-55-188" href="#__codelineno-55-188"></a>            <span class="p">}</span>
<a id="__codelineno-55-189" name="__codelineno-55-189" href="#__codelineno-55-189"></a>
<a id="__codelineno-55-190" name="__codelineno-55-190" href="#__codelineno-55-190"></a>            <span class="n">create_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-55-191" name="__codelineno-55-191" href="#__codelineno-55-191"></a>                <span class="s2">&quot;/api/v1/orders/&quot;</span><span class="p">,</span>
<a id="__codelineno-55-192" name="__codelineno-55-192" href="#__codelineno-55-192"></a>                <span class="n">json</span><span class="o">=</span><span class="n">order_data</span><span class="p">,</span>
<a id="__codelineno-55-193" name="__codelineno-55-193" href="#__codelineno-55-193"></a>                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
<a id="__codelineno-55-194" name="__codelineno-55-194" href="#__codelineno-55-194"></a>            <span class="p">)</span>
<a id="__codelineno-55-195" name="__codelineno-55-195" href="#__codelineno-55-195"></a>
<a id="__codelineno-55-196" name="__codelineno-55-196" href="#__codelineno-55-196"></a>            <span class="k">assert</span> <span class="n">create_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<a id="__codelineno-55-197" name="__codelineno-55-197" href="#__codelineno-55-197"></a>            <span class="n">order</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-55-198" name="__codelineno-55-198" href="#__codelineno-55-198"></a>            <span class="k">assert</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pending&quot;</span>
<a id="__codelineno-55-199" name="__codelineno-55-199" href="#__codelineno-55-199"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
<a id="__codelineno-55-200" name="__codelineno-55-200" href="#__codelineno-55-200"></a>
<a id="__codelineno-55-201" name="__codelineno-55-201" href="#__codelineno-55-201"></a>            <span class="c1"># Get order</span>
<a id="__codelineno-55-202" name="__codelineno-55-202" href="#__codelineno-55-202"></a>            <span class="n">get_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-55-203" name="__codelineno-55-203" href="#__codelineno-55-203"></a>                <span class="sa">f</span><span class="s2">&quot;/api/v1/orders/</span><span class="si">{</span><span class="n">order</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-55-204" name="__codelineno-55-204" href="#__codelineno-55-204"></a>                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
<a id="__codelineno-55-205" name="__codelineno-55-205" href="#__codelineno-55-205"></a>            <span class="p">)</span>
<a id="__codelineno-55-206" name="__codelineno-55-206" href="#__codelineno-55-206"></a>
<a id="__codelineno-55-207" name="__codelineno-55-207" href="#__codelineno-55-207"></a>            <span class="k">assert</span> <span class="n">get_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-55-208" name="__codelineno-55-208" href="#__codelineno-55-208"></a>            <span class="n">retrieved_order</span> <span class="o">=</span> <span class="n">get_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-55-209" name="__codelineno-55-209" href="#__codelineno-55-209"></a>            <span class="k">assert</span> <span class="n">retrieved_order</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<a id="__codelineno-55-210" name="__codelineno-55-210" href="#__codelineno-55-210"></a>            <span class="k">assert</span> <span class="n">retrieved_order</span><span class="p">[</span><span class="s2">&quot;total_amount&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>
<h3 id="performance-optimization"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#performance-optimization">Performance Optimization</a></h3>
<p>FastAPI and Clean Architecture together enable several performance optimizations:</p>
<h4 id="asyncawait-throughout-the-stack"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#asyncawait-throughout-the-stack">Async/Await Throughout the Stack</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c1"># All layers support async operations</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">AsyncOrderRepository</span><span class="p">:</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>            <span class="c1"># Database operations</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>            <span class="k">pass</span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>        <span class="c1"># Async database query</span>
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>        <span class="k">pass</span>
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>
<a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateOrderUseCase</span><span class="p">:</span>
<a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">CreateOrderCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>        <span class="c1"># All operations are async</span>
<a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>        <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_repository</span><span class="o">.</span><span class="n">get_by_ids</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">product_ids</span><span class="p">)</span>
<a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a>        <span class="n">inventory_check</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_service</span><span class="o">.</span><span class="n">check_availability</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
<a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a>        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">OrderCreatedEvent</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a>
<a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/orders&quot;</span><span class="p">)</span>
<a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span>
<a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">CreateOrderRequest</span><span class="p">,</span>
<a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a>    <span class="n">use_case</span><span class="p">:</span> <span class="n">CreateOrderUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()</span>
<a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a><span class="p">):</span>
<a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a>    <span class="c1"># End-to-end async</span>
<a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h4 id="dependency-injection-optimization"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#dependency-injection-optimization">Dependency Injection Optimization</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1"># Singleton services for performance</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="nd">@lru_cache</span><span class="p">()</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_payment_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PaymentService</span><span class="p">:</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Cached singleton payment service&quot;&quot;&quot;</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>    <span class="k">return</span> <span class="n">StripePaymentService</span><span class="p">()</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="c1"># Connection pooling</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_database</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Database</span><span class="p">:</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get database with connection pooling&quot;&quot;&quot;</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>    <span class="k">return</span> <span class="n">Database</span><span class="o">.</span><span class="n">get_pool</span><span class="p">()</span>
</code></pre></div>
<h3 id="production-deployment-patterns"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#production-deployment-patterns">Production Deployment Patterns</a></h3>
<h4 id="health-checks-and-monitoring"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#health-checks-and-monitoring">Health Checks and Monitoring</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">(</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>    <span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">),</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>    <span class="n">redis</span><span class="p">:</span> <span class="n">Redis</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_redis</span><span class="p">)</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="p">):</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Comprehensive health check&quot;&quot;&quot;</span>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>    <span class="n">health_status</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;checks&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>    <span class="c1"># Database check</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT 1&quot;</span><span class="p">)</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">][</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">][</span><span class="s2">&quot;database&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;unhealthy: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unhealthy&quot;</span>
<a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a>
<a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a>    <span class="c1"># Redis check</span>
<a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a>        <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
<a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">][</span><span class="s2">&quot;redis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;healthy&quot;</span>
<a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;checks&quot;</span><span class="p">][</span><span class="s2">&quot;redis&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;unhealthy: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a>        <span class="n">health_status</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unhealthy&quot;</span>
<a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a>
<a id="__codelineno-58-25" name="__codelineno-58-25" href="#__codelineno-58-25"></a>    <span class="k">return</span> <span class="n">health_status</span>
<a id="__codelineno-58-26" name="__codelineno-58-26" href="#__codelineno-58-26"></a>
<a id="__codelineno-58-27" name="__codelineno-58-27" href="#__codelineno-58-27"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/metrics&quot;</span><span class="p">)</span>
<a id="__codelineno-58-28" name="__codelineno-58-28" href="#__codelineno-58-28"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">metrics</span><span class="p">():</span>
<a id="__codelineno-58-29" name="__codelineno-58-29" href="#__codelineno-58-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Application metrics for monitoring&quot;&quot;&quot;</span>
<a id="__codelineno-58-30" name="__codelineno-58-30" href="#__codelineno-58-30"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-58-31" name="__codelineno-58-31" href="#__codelineno-58-31"></a>        <span class="s2">&quot;orders_created_total&quot;</span><span class="p">:</span> <span class="n">order_metrics</span><span class="o">.</span><span class="n">created_total</span><span class="p">,</span>
<a id="__codelineno-58-32" name="__codelineno-58-32" href="#__codelineno-58-32"></a>        <span class="s2">&quot;orders_failed_total&quot;</span><span class="p">:</span> <span class="n">order_metrics</span><span class="o">.</span><span class="n">failed_total</span><span class="p">,</span>
<a id="__codelineno-58-33" name="__codelineno-58-33" href="#__codelineno-58-33"></a>        <span class="s2">&quot;active_connections&quot;</span><span class="p">:</span> <span class="n">db_pool</span><span class="o">.</span><span class="n">active_connections</span><span class="p">,</span>
<a id="__codelineno-58-34" name="__codelineno-58-34" href="#__codelineno-58-34"></a>        <span class="s2">&quot;memory_usage&quot;</span><span class="p">:</span> <span class="n">get_memory_usage</span><span class="p">()</span>
<a id="__codelineno-58-35" name="__codelineno-58-35" href="#__codelineno-58-35"></a>    <span class="p">}</span>
</code></pre></div>
<h4 id="graceful-shutdown"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#graceful-shutdown">Graceful Shutdown</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="nd">@asynccontextmanager</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>    <span class="c1"># Startup</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting application&quot;</span><span class="p">)</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>    <span class="k">await</span> <span class="n">initialize_database</span><span class="p">()</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>    <span class="k">await</span> <span class="n">initialize_redis</span><span class="p">()</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>    <span class="k">yield</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a>    <span class="c1"># Shutdown</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shutting down application&quot;</span><span class="p">)</span>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a>    <span class="k">await</span> <span class="n">cleanup_database</span><span class="p">()</span>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a>    <span class="k">await</span> <span class="n">cleanup_redis</span><span class="p">()</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Application shutdown complete&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#conclusion">Conclusion</a></h3>
<p>FastAPI and Clean Architecture form a powerful combination that leverages the strengths of both approaches. FastAPI's type safety, dependency injection, and automatic validation reinforce Clean Architecture's separation of concerns and dependency inversion principles.</p>
<p>The key benefits of this combination:</p>
<ol>
<li><strong>Type Safety</strong>: Python type hints provide compile-time verification of architectural boundaries</li>
<li><strong>Dependency Injection</strong>: Natural implementation of dependency inversion principle</li>
<li><strong>Automatic Validation</strong>: Pydantic handles presentation layer validation, keeping domain logic pure</li>
<li><strong>Performance</strong>: ASGI foundation provides production-ready performance</li>
<li><strong>Documentation</strong>: OpenAPI generation stays synchronized with implementation</li>
<li><strong>Testing</strong>: Dependency injection enables comprehensive testing at all levels</li>
</ol>
<p>The clean-py repository demonstrates these patterns in production-ready code. The result is a system that's both architecturally sound and performant, with clear separation of concerns and comprehensive testing capabilities.</p>
<h3 id="references"><a class="toclink" href="../../2025/07/16/fastapi--clean-architecture---a-match-made-in-heaven/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - FastAPI with Clean Architecture</li>
<li><a href="https://fastapi.tiangolo.com/">FastAPI Documentation</a> - Official FastAPI guide</li>
<li><a href="https://docs.pydantic.dev/">Pydantic Documentation</a> - Data validation library</li>
<li><a href="https://fastapi.tiangolo.com/tutorial/dependencies/">Dependency Injection in FastAPI</a> - Official dependency guide</li>
</ul>
<p>Start with Clean Architecture principles, leverage FastAPI's unique features to reinforce those boundaries, and build systems that scale both in performance and maintainability. The combination of these approaches creates applications that are truly built to last.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-06-16 21:25:00-04:00">Jun 16, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../design-patterns/" class="md-meta__link">Design Patterns</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="./" class="md-meta__link">Clean Architecture</a></li>
        
        
          
          <li class="md-meta__item">
            
              12 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="factory-pattern-in-python-building-complex-objects-right"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/">Factory Pattern in Python: Building Complex Objects Right</a></h2>
<p>Object creation seems straightforward until it isn't. You start with simple constructors, then business rules creep in. Validation becomes complex. Initialization requires multiple steps. Dependencies need coordination. Before you know it, your codebase is littered with half-initialized objects, scattered validation logic, and creation code that breaks business rules.</p>
<p>I've debugged too many production issues caused by objects in invalid states—customers without required fields, orders with negative totals, aggregates missing domain events. The Factory Pattern solves these problems by centralizing object creation, ensuring consistency, and maintaining business invariants from the moment objects come into existence.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates factory patterns in Python that go beyond simple object construction. These patterns ensure your domain entities are born valid and remain consistent throughout their lifecycle.</p>
<h3 id="the-problem-with-direct-construction"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#the-problem-with-direct-construction">The Problem with Direct Construction</a></h3>
<p>Consider a typical Customer entity. At first glance, direct construction seems natural:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Direct construction - seems simple</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="nb">id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">email</span><span class="o">=</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">preferences</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="p">)</span>
</code></pre></div>
<p>This approach breaks down quickly:</p>
<ol>
<li><strong>Validation scattered</strong>: Email format checking happens elsewhere</li>
<li><strong>Missing invariants</strong>: No business rule ensures required fields</li>
<li><strong>No domain events</strong>: Important business events aren't raised</li>
<li><strong>Inconsistent creation</strong>: Different parts of code create objects differently</li>
<li><strong>Complex initialization</strong>: Multi-step setup requirements aren't enforced</li>
</ol>
<p>Real-world creation gets messy:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Real-world direct construction - error-prone</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_customer_endpoint</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="c1"># Validation scattered throughout the code</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name required&quot;</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid email&quot;</span><span class="p">)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="k">if</span> <span class="n">Customer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email already exists&quot;</span><span class="p">)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="c1"># Easy to forget steps</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>        <span class="nb">id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>  <span class="c1"># What if we forget this?</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>        <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="n">updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>  <span class="c1"># Duplicate logic</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>        <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># What if business rules change?</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>        <span class="n">preferences</span><span class="o">=</span><span class="p">{},</span>  <span class="c1"># What if we need defaults?</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    <span class="p">)</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="c1"># Domain events forgotten</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>    <span class="c1"># Audit logging missing</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>    <span class="c1"># Notification logic scattered</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>    <span class="k">return</span> <span class="n">customer</span>
</code></pre></div>
<h3 id="factory-methods-domain-centric-creation"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#factory-methods-domain-centric-creation">Factory Methods: Domain-Centric Creation</a></h3>
<p>Factory methods centralize creation logic within the domain entity. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates this pattern:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># src/domain/entities/customer.py</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nd">@dataclass</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Customer aggregate root with enhanced value objects and domain events.&quot;&quot;&quot;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Email</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="n">address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="n">phone</span><span class="p">:</span> <span class="n">PhoneNumber</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="bp">cls</span><span class="p">,</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>        <span class="n">address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>        <span class="n">phone</span><span class="p">:</span> <span class="n">PhoneNumber</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>        <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Customer&quot;</span><span class="p">:</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Factory method to create a new customer with domain event.&quot;&quot;&quot;</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>            <span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="p">)</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>        <span class="c1"># Raise domain event</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="n">customer</span><span class="o">.</span><span class="n">add_domain_event</span><span class="p">(</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>            <span class="n">CustomerCreated</span><span class="p">(</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>                <span class="n">event_id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>                <span class="n">occurred_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>                <span class="n">customer_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>                <span class="n">customer_email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>            <span class="p">)</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>        <span class="p">)</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>        <span class="k">return</span> <span class="n">customer</span>
</code></pre></div>
<p>The factory method provides several benefits:</p>
<ol>
<li><strong>Centralized validation</strong>: Business rules in one place</li>
<li><strong>Consistent domain events</strong>: Events raised automatically</li>
<li><strong>Immutable creation</strong>: Objects are born valid</li>
<li><strong>Clear intent</strong>: The method name expresses purpose</li>
<li><strong>Type safety</strong>: Value objects ensure parameter correctness</li>
</ol>
<p>Usage becomes clean and safe:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Clean factory method usage</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_customer_use_case</span><span class="p">(</span><span class="n">command</span><span class="p">:</span> <span class="n">CreateCustomerCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="c1"># Value objects handle validation</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>  <span class="c1"># Validates format</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="c1"># Business rule validation</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="n">customer_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Customer with email </span><span class="si">{</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="c1"># Factory ensures consistency</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        <span class="n">name</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="n">preferences</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="p">)</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="c1"># Object is guaranteed valid with events raised</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">customer_repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
</code></pre></div>
<h3 id="order-factory-complex-business-logic"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#order-factory-complex-business-logic">Order Factory: Complex Business Logic</a></h3>
<p>Orders demonstrate more complex factory requirements. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> shows how to handle validation, business rules, and domain events:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># src/domain/entities/order.py</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nd">@dataclass</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">(</span><span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Order aggregate root with enhanced value objects and domain events.&quot;&quot;&quot;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="n">total_amount</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="n">status</span><span class="p">:</span> <span class="n">OrderStatus</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="n">details</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_business_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate order business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">):</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>            <span class="k">raise</span> <span class="n">BusinessRuleViolationError</span><span class="p">(</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>                <span class="s2">&quot;Order total amount must be greater than zero&quot;</span><span class="p">,</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>                <span class="n">rule_name</span><span class="o">=</span><span class="s2">&quot;MinimumOrderAmount&quot;</span><span class="p">,</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>            <span class="p">)</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>        <span class="bp">cls</span><span class="p">,</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">,</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="n">total_amount</span><span class="p">:</span> <span class="n">Money</span><span class="p">,</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="n">details</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Order&quot;</span><span class="p">:</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Factory method to create a new order with domain event.&quot;&quot;&quot;</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>        <span class="n">order</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">order_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">total_amount</span><span class="p">,</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>            <span class="n">details</span><span class="o">=</span><span class="n">details</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="p">)</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>        <span class="c1"># Raise domain event</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="n">order</span><span class="o">.</span><span class="n">add_domain_event</span><span class="p">(</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>            <span class="n">OrderCreated</span><span class="p">(</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>                <span class="n">event_id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>                <span class="n">occurred_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>                <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>                <span class="n">total_amount</span><span class="o">=</span><span class="n">total_amount</span><span class="p">,</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>            <span class="p">)</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="p">)</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>        <span class="k">return</span> <span class="n">order</span>
</code></pre></div>
<p>The Order factory demonstrates advanced patterns:</p>
<ul>
<li><strong>Automatic validation</strong>: <code>_validate_business_rules</code> runs on initialization</li>
<li><strong>Domain events</strong>: Important business events raised automatically</li>
<li><strong>Business rule enforcement</strong>: Minimum order amount validated</li>
<li><strong>Consistent state</strong>: Orders are always created in valid state</li>
</ul>
<h3 id="builder-pattern-for-complex-construction"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#builder-pattern-for-complex-construction">Builder Pattern for Complex Construction</a></h3>
<p>When object creation involves many optional parameters or complex setup, the Builder pattern provides a fluent interface:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderBuilder</span><span class="p">:</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Builder for creating complex orders with validation.&quot;&quot;&quot;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OrderId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CustomerId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_billing_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_payment_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PaymentMethod</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_special_instructions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the order ID.&quot;&quot;&quot;</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span> <span class="o">=</span> <span class="n">order_id</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">for_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the customer ID.&quot;&quot;&quot;</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span> <span class="o">=</span> <span class="n">customer_id</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="n">ProductId</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an item to the order.&quot;&quot;&quot;</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="k">if</span> <span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Quantity must be positive&quot;</span><span class="p">)</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">(</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>            <span class="n">product_id</span><span class="o">=</span><span class="n">product_id</span><span class="p">,</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>            <span class="n">unit_price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>        <span class="p">)</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_shipping_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the shipping address.&quot;&quot;&quot;</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span> <span class="o">=</span> <span class="n">address</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_billing_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the billing address.&quot;&quot;&quot;</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_billing_address</span> <span class="o">=</span> <span class="n">address</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_payment_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_method</span><span class="p">:</span> <span class="n">PaymentMethod</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the payment method.&quot;&quot;&quot;</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_payment_method</span> <span class="o">=</span> <span class="n">payment_method</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_discount_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a discount code.&quot;&quot;&quot;</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>        <span class="k">if</span> <span class="n">code</span> <span class="ow">and</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="p">:</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_special_instructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instructions</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;OrderBuilder&quot;</span><span class="p">:</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add special instructions.&quot;&quot;&quot;</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_special_instructions</span> <span class="o">=</span> <span class="n">instructions</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the order with validation.&quot;&quot;&quot;</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>        <span class="c1"># Validate required fields</span>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span><span class="p">:</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Order ID is required&quot;</span><span class="p">)</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span><span class="p">:</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Customer ID is required&quot;</span><span class="p">)</span>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">:</span>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Order must have at least one item&quot;</span><span class="p">)</span>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="p">:</span>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shipping address is required&quot;</span><span class="p">)</span>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_payment_method</span><span class="p">:</span>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Payment method is required&quot;</span><span class="p">)</span>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>        <span class="c1"># Calculate total</span>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>        <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">)</span>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>        <span class="c1"># Apply discounts (simplified)</span>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>        <span class="n">discount</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="p">:</span>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a>            <span class="n">discount</span> <span class="o">=</span> <span class="n">discount</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calculate_discount</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">subtotal</span><span class="p">))</span>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>        <span class="c1"># Calculate taxes and shipping</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>        <span class="n">tax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_tax</span><span class="p">(</span><span class="n">subtotal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="p">)</span>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a>        <span class="n">shipping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_shipping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="p">)</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">discount</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tax</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">shipping</span><span class="p">)</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a>        <span class="c1"># Build order details</span>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a>        <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="p">],</span>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>            <span class="s2">&quot;shipping_address&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shipping_address</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
<a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a>            <span class="s2">&quot;billing_address&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_billing_address</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_billing_address</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>            <span class="s2">&quot;payment_method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_payment_method</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
<a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a>            <span class="s2">&quot;discount_codes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discount_codes</span><span class="p">,</span>
<a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>            <span class="s2">&quot;special_instructions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_special_instructions</span><span class="p">,</span>
<a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a>            <span class="s2">&quot;subtotal&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">subtotal</span><span class="p">),</span>
<a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>            <span class="s2">&quot;discount&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">discount</span><span class="p">),</span>
<a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a>            <span class="s2">&quot;tax&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">tax</span><span class="p">),</span>
<a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a>            <span class="s2">&quot;shipping&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">shipping</span><span class="p">),</span>
<a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>        <span class="p">}</span>
<a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a>
<a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a>        <span class="c1"># Create order using factory method</span>
<a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a>            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_order_id</span><span class="p">,</span>
<a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span><span class="p">,</span>
<a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a>            <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
<a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a>        <span class="p">)</span>
<a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a>
<a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_discount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subtotal</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate discount for a code (simplified implementation).&quot;&quot;&quot;</span>
<a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a>        <span class="c1"># In real implementation, this would query discount service</span>
<a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a>        <span class="n">discount_rates</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a>            <span class="s2">&quot;SAVE10&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.10&quot;</span><span class="p">),</span>
<a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a>            <span class="s2">&quot;WELCOME&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.15&quot;</span><span class="p">),</span>
<a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a>            <span class="s2">&quot;LOYALTY&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.05&quot;</span><span class="p">),</span>
<a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>        <span class="p">}</span>
<a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a>
<a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a>        <span class="n">rate</span> <span class="o">=</span> <span class="n">discount_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">))</span>
<a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a>        <span class="k">return</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
<a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a>
<a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_tax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtotal</span><span class="p">:</span> <span class="n">Money</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate tax based on shipping address.&quot;&quot;&quot;</span>
<a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a>        <span class="c1"># Simplified tax calculation</span>
<a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a>        <span class="n">tax_rates</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a>            <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0875&quot;</span><span class="p">),</span>  <span class="c1"># California</span>
<a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a>            <span class="s2">&quot;NY&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.08&quot;</span><span class="p">),</span>    <span class="c1"># New York</span>
<a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a>            <span class="s2">&quot;TX&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.0625&quot;</span><span class="p">),</span>  <span class="c1"># Texas</span>
<a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a>        <span class="p">}</span>
<a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>
<a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a>        <span class="n">rate</span> <span class="o">=</span> <span class="n">tax_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.05&quot;</span><span class="p">))</span>  <span class="c1"># Default 5%</span>
<a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a>        <span class="k">return</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
<a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a>
<a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_shipping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">],</span> <span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate shipping cost.&quot;&quot;&quot;</span>
<a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a>        <span class="c1"># Simplified shipping calculation</span>
<a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a>        <span class="n">base_shipping</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;9.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a>
<a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a>        <span class="c1"># Free shipping for orders over $100</span>
<a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a>        <span class="n">subtotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
<a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a>        <span class="k">if</span> <span class="n">subtotal</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
<a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a>            <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a>
<a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a>        <span class="c1"># International shipping</span>
<a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="o">.</span><span class="n">is_us_address</span><span class="p">():</span>
<a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a>            <span class="k">return</span> <span class="n">base_shipping</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a>
<a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a>        <span class="k">return</span> <span class="n">base_shipping</span>
<a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a>
<a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderItem</span><span class="p">:</span>
<a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Individual order item.&quot;&quot;&quot;</span>
<a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a>
<a id="__codelineno-5-165" name="__codelineno-5-165" href="#__codelineno-5-165"></a>    <span class="n">product_id</span><span class="p">:</span> <span class="n">ProductId</span>
<a id="__codelineno-5-166" name="__codelineno-5-166" href="#__codelineno-5-166"></a>    <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-5-167" name="__codelineno-5-167" href="#__codelineno-5-167"></a>    <span class="n">unit_price</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-5-168" name="__codelineno-5-168" href="#__codelineno-5-168"></a>
<a id="__codelineno-5-169" name="__codelineno-5-169" href="#__codelineno-5-169"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-5-170" name="__codelineno-5-170" href="#__codelineno-5-170"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate total price for this item.&quot;&quot;&quot;</span>
<a id="__codelineno-5-171" name="__codelineno-5-171" href="#__codelineno-5-171"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_price</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
<a id="__codelineno-5-172" name="__codelineno-5-172" href="#__codelineno-5-172"></a>
<a id="__codelineno-5-173" name="__codelineno-5-173" href="#__codelineno-5-173"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-5-174" name="__codelineno-5-174" href="#__codelineno-5-174"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to dictionary for serialization.&quot;&quot;&quot;</span>
<a id="__codelineno-5-175" name="__codelineno-5-175" href="#__codelineno-5-175"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-5-176" name="__codelineno-5-176" href="#__codelineno-5-176"></a>            <span class="s2">&quot;product_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">product_id</span><span class="p">),</span>
<a id="__codelineno-5-177" name="__codelineno-5-177" href="#__codelineno-5-177"></a>            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
<a id="__codelineno-5-178" name="__codelineno-5-178" href="#__codelineno-5-178"></a>            <span class="s2">&quot;unit_price&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit_price</span><span class="p">),</span>
<a id="__codelineno-5-179" name="__codelineno-5-179" href="#__codelineno-5-179"></a>            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_total</span><span class="p">()),</span>
<a id="__codelineno-5-180" name="__codelineno-5-180" href="#__codelineno-5-180"></a>        <span class="p">}</span>
</code></pre></div>
<p>The Builder pattern excels for complex creation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Fluent order creation</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">order</span> <span class="o">=</span> <span class="p">(</span><span class="n">OrderBuilder</span><span class="p">()</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="o">.</span><span class="n">with_id</span><span class="p">(</span><span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="o">.</span><span class="n">for_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    <span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;29.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">))</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;49.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">))</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="o">.</span><span class="n">with_shipping_address</span><span class="p">(</span><span class="n">shipping_address</span><span class="p">)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    <span class="o">.</span><span class="n">with_billing_address</span><span class="p">(</span><span class="n">billing_address</span><span class="p">)</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="o">.</span><span class="n">with_payment_method</span><span class="p">(</span><span class="n">credit_card</span><span class="p">)</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    <span class="o">.</span><span class="n">add_discount_code</span><span class="p">(</span><span class="s2">&quot;SAVE10&quot;</span><span class="p">)</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    <span class="o">.</span><span class="n">with_special_instructions</span><span class="p">(</span><span class="s2">&quot;Leave at front door&quot;</span><span class="p">)</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="o">.</span><span class="n">build</span><span class="p">())</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="c1"># Order is guaranteed valid with all business rules applied</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PENDING</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">get_domain_events</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># OrderCreated event</span>
</code></pre></div>
<h3 id="abstract-factory-for-families-of-objects"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#abstract-factory-for-families-of-objects">Abstract Factory for Families of Objects</a></h3>
<p>When you need to create related objects consistently, Abstract Factory provides a solution:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="n">INDIVIDUAL</span> <span class="o">=</span> <span class="s2">&quot;individual&quot;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="n">BUSINESS</span> <span class="o">=</span> <span class="s2">&quot;business&quot;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="n">PREMIUM</span> <span class="o">=</span> <span class="s2">&quot;premium&quot;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract factory for customer creation.&quot;&quot;&quot;</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> 
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a customer of the appropriate type.&quot;&quot;&quot;</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>        <span class="k">pass</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_account_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccountSettings</span><span class="p">:</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create account settings for the customer type.&quot;&quot;&quot;</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>        <span class="k">pass</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_notification_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotificationPreferences</span><span class="p">:</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create notification preferences for the customer type.&quot;&quot;&quot;</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>        <span class="k">pass</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="k">class</span><span class="w"> </span><span class="nc">IndividualCustomerFactory</span><span class="p">(</span><span class="n">CustomerFactory</span><span class="p">):</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for individual customers.&quot;&quot;&quot;</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> 
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an individual customer.&quot;&quot;&quot;</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>        <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>            <span class="s2">&quot;customer_type&quot;</span><span class="p">:</span> <span class="s2">&quot;individual&quot;</span><span class="p">,</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>            <span class="s2">&quot;marketing_emails&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>            <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>            <span class="s2">&quot;account_limit&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5000&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>        <span class="p">}</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>        <span class="n">preferences</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>        <span class="p">)</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_account_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccountSettings</span><span class="p">:</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create individual account settings.&quot;&quot;&quot;</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>        <span class="k">return</span> <span class="n">AccountSettings</span><span class="p">(</span>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>            <span class="n">two_factor_required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>            <span class="n">session_timeout_minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>            <span class="n">password_expiry_days</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>        <span class="p">)</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_notification_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotificationPreferences</span><span class="p">:</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create individual notification preferences.&quot;&quot;&quot;</span>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>        <span class="k">return</span> <span class="n">NotificationPreferences</span><span class="p">(</span>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>            <span class="n">email_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>            <span class="n">sms_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>            <span class="n">push_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>            <span class="n">marketing_emails</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>        <span class="p">)</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a><span class="k">class</span><span class="w"> </span><span class="nc">BusinessCustomerFactory</span><span class="p">(</span><span class="n">CustomerFactory</span><span class="p">):</span>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for business customers.&quot;&quot;&quot;</span>
<a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a>
<a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> 
<a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a business customer.&quot;&quot;&quot;</span>
<a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>        <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a>            <span class="s2">&quot;customer_type&quot;</span><span class="p">:</span> <span class="s2">&quot;business&quot;</span><span class="p">,</span>
<a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a>            <span class="s2">&quot;marketing_emails&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a>            <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a>            <span class="s2">&quot;account_limit&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50000&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a>            <span class="s2">&quot;tax_exempt&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tax_exempt&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
<a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a>            <span class="s2">&quot;net_payment_terms&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payment_terms&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
<a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a>        <span class="p">}</span>
<a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a>        <span class="n">preferences</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a>
<a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a>        <span class="p">)</span>
<a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a>
<a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_account_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccountSettings</span><span class="p">:</span>
<a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create business account settings.&quot;&quot;&quot;</span>
<a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a>        <span class="k">return</span> <span class="n">AccountSettings</span><span class="p">(</span>
<a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a>            <span class="n">two_factor_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a>            <span class="n">session_timeout_minutes</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a>            <span class="n">password_expiry_days</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a>            <span class="n">ip_restrictions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a>        <span class="p">)</span>
<a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a>
<a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_notification_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotificationPreferences</span><span class="p">:</span>
<a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create business notification preferences.&quot;&quot;&quot;</span>
<a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a>        <span class="k">return</span> <span class="n">NotificationPreferences</span><span class="p">(</span>
<a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a>            <span class="n">email_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a>            <span class="n">sms_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a>            <span class="n">push_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a>            <span class="n">marketing_emails</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a>            <span class="n">billing_alerts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a>            <span class="n">order_confirmations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a>        <span class="p">)</span>
<a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a>
<a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a><span class="k">class</span><span class="w"> </span><span class="nc">PremiumCustomerFactory</span><span class="p">(</span><span class="n">CustomerFactory</span><span class="p">):</span>
<a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for premium customers.&quot;&quot;&quot;</span>
<a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a>
<a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> 
<a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-7-136" name="__codelineno-7-136" href="#__codelineno-7-136"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-7-137" name="__codelineno-7-137" href="#__codelineno-7-137"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-7-138" name="__codelineno-7-138" href="#__codelineno-7-138"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a premium customer.&quot;&quot;&quot;</span>
<a id="__codelineno-7-139" name="__codelineno-7-139" href="#__codelineno-7-139"></a>        <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-140" name="__codelineno-7-140" href="#__codelineno-7-140"></a>            <span class="s2">&quot;customer_type&quot;</span><span class="p">:</span> <span class="s2">&quot;premium&quot;</span><span class="p">,</span>
<a id="__codelineno-7-141" name="__codelineno-7-141" href="#__codelineno-7-141"></a>            <span class="s2">&quot;marketing_emails&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-142" name="__codelineno-7-142" href="#__codelineno-7-142"></a>            <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-143" name="__codelineno-7-143" href="#__codelineno-7-143"></a>            <span class="s2">&quot;account_limit&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100000&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-7-144" name="__codelineno-7-144" href="#__codelineno-7-144"></a>            <span class="s2">&quot;concierge_service&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-145" name="__codelineno-7-145" href="#__codelineno-7-145"></a>            <span class="s2">&quot;priority_support&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-146" name="__codelineno-7-146" href="#__codelineno-7-146"></a>            <span class="s2">&quot;free_shipping&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-147" name="__codelineno-7-147" href="#__codelineno-7-147"></a>        <span class="p">}</span>
<a id="__codelineno-7-148" name="__codelineno-7-148" href="#__codelineno-7-148"></a>        <span class="n">preferences</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="p">{}))</span>
<a id="__codelineno-7-149" name="__codelineno-7-149" href="#__codelineno-7-149"></a>
<a id="__codelineno-7-150" name="__codelineno-7-150" href="#__codelineno-7-150"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-7-151" name="__codelineno-7-151" href="#__codelineno-7-151"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-152" name="__codelineno-7-152" href="#__codelineno-7-152"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-7-153" name="__codelineno-7-153" href="#__codelineno-7-153"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-7-154" name="__codelineno-7-154" href="#__codelineno-7-154"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-7-155" name="__codelineno-7-155" href="#__codelineno-7-155"></a>        <span class="p">)</span>
<a id="__codelineno-7-156" name="__codelineno-7-156" href="#__codelineno-7-156"></a>
<a id="__codelineno-7-157" name="__codelineno-7-157" href="#__codelineno-7-157"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_account_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccountSettings</span><span class="p">:</span>
<a id="__codelineno-7-158" name="__codelineno-7-158" href="#__codelineno-7-158"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create premium account settings.&quot;&quot;&quot;</span>
<a id="__codelineno-7-159" name="__codelineno-7-159" href="#__codelineno-7-159"></a>        <span class="k">return</span> <span class="n">AccountSettings</span><span class="p">(</span>
<a id="__codelineno-7-160" name="__codelineno-7-160" href="#__codelineno-7-160"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-161" name="__codelineno-7-161" href="#__codelineno-7-161"></a>            <span class="n">two_factor_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-162" name="__codelineno-7-162" href="#__codelineno-7-162"></a>            <span class="n">session_timeout_minutes</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
<a id="__codelineno-7-163" name="__codelineno-7-163" href="#__codelineno-7-163"></a>            <span class="n">password_expiry_days</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-7-164" name="__codelineno-7-164" href="#__codelineno-7-164"></a>            <span class="n">dedicated_support</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-165" name="__codelineno-7-165" href="#__codelineno-7-165"></a>        <span class="p">)</span>
<a id="__codelineno-7-166" name="__codelineno-7-166" href="#__codelineno-7-166"></a>
<a id="__codelineno-7-167" name="__codelineno-7-167" href="#__codelineno-7-167"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_notification_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NotificationPreferences</span><span class="p">:</span>
<a id="__codelineno-7-168" name="__codelineno-7-168" href="#__codelineno-7-168"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create premium notification preferences.&quot;&quot;&quot;</span>
<a id="__codelineno-7-169" name="__codelineno-7-169" href="#__codelineno-7-169"></a>        <span class="k">return</span> <span class="n">NotificationPreferences</span><span class="p">(</span>
<a id="__codelineno-7-170" name="__codelineno-7-170" href="#__codelineno-7-170"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-7-171" name="__codelineno-7-171" href="#__codelineno-7-171"></a>            <span class="n">email_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-172" name="__codelineno-7-172" href="#__codelineno-7-172"></a>            <span class="n">sms_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-173" name="__codelineno-7-173" href="#__codelineno-7-173"></a>            <span class="n">push_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-174" name="__codelineno-7-174" href="#__codelineno-7-174"></a>            <span class="n">marketing_emails</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-175" name="__codelineno-7-175" href="#__codelineno-7-175"></a>            <span class="n">vip_offers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-176" name="__codelineno-7-176" href="#__codelineno-7-176"></a>            <span class="n">personal_shopper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-177" name="__codelineno-7-177" href="#__codelineno-7-177"></a>        <span class="p">)</span>
<a id="__codelineno-7-178" name="__codelineno-7-178" href="#__codelineno-7-178"></a>
<a id="__codelineno-7-179" name="__codelineno-7-179" href="#__codelineno-7-179"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_customer_factory</span><span class="p">(</span><span class="n">customer_type</span><span class="p">:</span> <span class="n">CustomerType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-7-180" name="__codelineno-7-180" href="#__codelineno-7-180"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the appropriate factory for customer type.&quot;&quot;&quot;</span>
<a id="__codelineno-7-181" name="__codelineno-7-181" href="#__codelineno-7-181"></a>    <span class="n">factories</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-182" name="__codelineno-7-182" href="#__codelineno-7-182"></a>        <span class="n">CustomerType</span><span class="o">.</span><span class="n">INDIVIDUAL</span><span class="p">:</span> <span class="n">IndividualCustomerFactory</span><span class="p">(),</span>
<a id="__codelineno-7-183" name="__codelineno-7-183" href="#__codelineno-7-183"></a>        <span class="n">CustomerType</span><span class="o">.</span><span class="n">BUSINESS</span><span class="p">:</span> <span class="n">BusinessCustomerFactory</span><span class="p">(),</span>
<a id="__codelineno-7-184" name="__codelineno-7-184" href="#__codelineno-7-184"></a>        <span class="n">CustomerType</span><span class="o">.</span><span class="n">PREMIUM</span><span class="p">:</span> <span class="n">PremiumCustomerFactory</span><span class="p">(),</span>
<a id="__codelineno-7-185" name="__codelineno-7-185" href="#__codelineno-7-185"></a>    <span class="p">}</span>
<a id="__codelineno-7-186" name="__codelineno-7-186" href="#__codelineno-7-186"></a>    <span class="k">return</span> <span class="n">factories</span><span class="p">[</span><span class="n">customer_type</span><span class="p">]</span>
</code></pre></div>
<p>Usage ensures consistency across related objects:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Consistent object family creation</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">onboard_new_customer</span><span class="p">(</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">customer_type</span><span class="p">:</span> <span class="n">CustomerType</span><span class="p">,</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="n">email_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Customer</span><span class="p">,</span> <span class="n">AccountSettings</span><span class="p">,</span> <span class="n">NotificationPreferences</span><span class="p">]:</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Onboard a new customer with all related objects.&quot;&quot;&quot;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="n">factory</span> <span class="o">=</span> <span class="n">get_customer_factory</span><span class="p">(</span><span class="n">customer_type</span><span class="p">)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">email_str</span><span class="p">)</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="c1"># Create related objects consistently</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    <span class="n">account_settings</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_account_settings</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="n">notifications</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_notification_preferences</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>    <span class="k">return</span> <span class="n">customer</span><span class="p">,</span> <span class="n">account_settings</span><span class="p">,</span> <span class="n">notifications</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="c1"># All related objects have consistent configuration for the customer type</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="n">individual_customer</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">preferences</span> <span class="o">=</span> <span class="n">onboard_new_customer</span><span class="p">(</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>    <span class="n">CustomerType</span><span class="o">.</span><span class="n">INDIVIDUAL</span><span class="p">,</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>    <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>    <span class="s2">&quot;john@example.com&quot;</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="p">)</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="n">business_customer</span><span class="p">,</span> <span class="n">biz_settings</span><span class="p">,</span> <span class="n">biz_preferences</span> <span class="o">=</span> <span class="n">onboard_new_customer</span><span class="p">(</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>    <span class="n">CustomerType</span><span class="o">.</span><span class="n">BUSINESS</span><span class="p">,</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>    <span class="s2">&quot;Acme Corp&quot;</span><span class="p">,</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>    <span class="s2">&quot;admin@acme.com&quot;</span><span class="p">,</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>    <span class="n">tax_exempt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>    <span class="n">payment_terms</span><span class="o">=</span><span class="mi">60</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a><span class="p">)</span>
</code></pre></div>
<h3 id="testing-factory-patterns"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#testing-factory-patterns">Testing Factory Patterns</a></h3>
<p>Factory patterns make testing easier by centralizing creation logic:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># tests/unit/domain/test_customer.py</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomer</span><span class="p">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_customer_creation_with_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating a customer using the factory method.&quot;&quot;&quot;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>            <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">},</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>        <span class="p">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>        <span class="c1"># Check domain events</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">collect_domain_events</span><span class="p">()</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">CustomerCreated</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">customer_name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomerFactory</span><span class="p">:</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_individual_customer_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test individual customer factory creates correct objects.&quot;&quot;&quot;</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>        <span class="n">factory</span> <span class="o">=</span> <span class="n">IndividualCustomerFactory</span><span class="p">()</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_account_settings</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>        <span class="n">preferences</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_notification_preferences</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>        <span class="c1"># Verify customer type-specific configuration</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s2">&quot;customer_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;individual&quot;</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s2">&quot;marketing_emails&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>        <span class="k">assert</span> <span class="n">settings</span><span class="o">.</span><span class="n">two_factor_required</span> <span class="o">==</span> <span class="kc">False</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>        <span class="k">assert</span> <span class="n">preferences</span><span class="o">.</span><span class="n">marketing_emails</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_business_customer_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test business customer factory creates correct objects.&quot;&quot;&quot;</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>        <span class="n">factory</span> <span class="o">=</span> <span class="n">BusinessCustomerFactory</span><span class="p">()</span>
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;admin@business.com&quot;</span><span class="p">)</span>
<a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>
<a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_customer</span><span class="p">(</span>
<a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>            <span class="n">customer_id</span><span class="p">,</span> 
<a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>            <span class="s2">&quot;Business Corp&quot;</span><span class="p">,</span> 
<a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>            <span class="n">email</span><span class="p">,</span>
<a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>            <span class="n">tax_exempt</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>        <span class="p">)</span>
<a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_account_settings</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>
<a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>        <span class="c1"># Verify business-specific configuration</span>
<a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s2">&quot;customer_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;business&quot;</span>
<a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s2">&quot;tax_exempt&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a>        <span class="k">assert</span> <span class="n">settings</span><span class="o">.</span><span class="n">two_factor_required</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a>        <span class="k">assert</span> <span class="n">settings</span><span class="o">.</span><span class="n">ip_restrictions</span> <span class="o">==</span> <span class="kc">True</span>
<a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>
<a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestOrderBuilder</span><span class="p">:</span>
<a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_order_builder_complete_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test building a complete order.&quot;&quot;&quot;</span>
<a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a>        <span class="n">order_id</span> <span class="o">=</span> <span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>        <span class="n">product_id</span> <span class="o">=</span> <span class="n">ProductId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a>
<a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a>        <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span>
<a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>            <span class="n">street</span><span class="o">=</span><span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a>            <span class="n">city</span><span class="o">=</span><span class="s2">&quot;Anytown&quot;</span><span class="p">,</span> 
<a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a>            <span class="n">state</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span>
<a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a>            <span class="n">postal_code</span><span class="o">=</span><span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a>            <span class="n">country</span><span class="o">=</span><span class="s2">&quot;USA&quot;</span>
<a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>        <span class="p">)</span>
<a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a>
<a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a>        <span class="n">payment_method</span> <span class="o">=</span> <span class="n">PaymentMethod</span><span class="o">.</span><span class="n">credit_card</span><span class="p">(</span><span class="s2">&quot;4111111111111111&quot;</span><span class="p">)</span>
<a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a>
<a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a>        <span class="n">order</span> <span class="o">=</span> <span class="p">(</span><span class="n">OrderBuilder</span><span class="p">()</span>
<a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a>            <span class="o">.</span><span class="n">with_id</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
<a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a>            <span class="o">.</span><span class="n">for_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>            <span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">product_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;29.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">))</span>
<a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a>            <span class="o">.</span><span class="n">with_shipping_address</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<a id="__codelineno-9-87" name="__codelineno-9-87" href="#__codelineno-9-87"></a>            <span class="o">.</span><span class="n">with_payment_method</span><span class="p">(</span><span class="n">payment_method</span><span class="p">)</span>
<a id="__codelineno-9-88" name="__codelineno-9-88" href="#__codelineno-9-88"></a>            <span class="o">.</span><span class="n">add_discount_code</span><span class="p">(</span><span class="s2">&quot;SAVE10&quot;</span><span class="p">)</span>
<a id="__codelineno-9-89" name="__codelineno-9-89" href="#__codelineno-9-89"></a>            <span class="o">.</span><span class="n">build</span><span class="p">())</span>
<a id="__codelineno-9-90" name="__codelineno-9-90" href="#__codelineno-9-90"></a>
<a id="__codelineno-9-91" name="__codelineno-9-91" href="#__codelineno-9-91"></a>        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_id</span>
<a id="__codelineno-9-92" name="__codelineno-9-92" href="#__codelineno-9-92"></a>        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-9-93" name="__codelineno-9-93" href="#__codelineno-9-93"></a>        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">total_amount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># Tax and shipping calculated</span>
<a id="__codelineno-9-94" name="__codelineno-9-94" href="#__codelineno-9-94"></a>        <span class="k">assert</span> <span class="s2">&quot;SAVE10&quot;</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;discount_codes&quot;</span><span class="p">]</span>
<a id="__codelineno-9-95" name="__codelineno-9-95" href="#__codelineno-9-95"></a>
<a id="__codelineno-9-96" name="__codelineno-9-96" href="#__codelineno-9-96"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_order_builder_validation_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-97" name="__codelineno-9-97" href="#__codelineno-9-97"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test builder validation catches errors.&quot;&quot;&quot;</span>
<a id="__codelineno-9-98" name="__codelineno-9-98" href="#__codelineno-9-98"></a>        <span class="n">builder</span> <span class="o">=</span> <span class="n">OrderBuilder</span><span class="p">()</span>
<a id="__codelineno-9-99" name="__codelineno-9-99" href="#__codelineno-9-99"></a>
<a id="__codelineno-9-100" name="__codelineno-9-100" href="#__codelineno-9-100"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Order ID is required&quot;</span><span class="p">):</span>
<a id="__codelineno-9-101" name="__codelineno-9-101" href="#__codelineno-9-101"></a>            <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<a id="__codelineno-9-102" name="__codelineno-9-102" href="#__codelineno-9-102"></a>
<a id="__codelineno-9-103" name="__codelineno-9-103" href="#__codelineno-9-103"></a>        <span class="n">builder</span><span class="o">.</span><span class="n">with_id</span><span class="p">(</span><span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
<a id="__codelineno-9-104" name="__codelineno-9-104" href="#__codelineno-9-104"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Customer ID is required&quot;</span><span class="p">):</span>
<a id="__codelineno-9-105" name="__codelineno-9-105" href="#__codelineno-9-105"></a>            <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</code></pre></div>
<h3 id="factory-patterns-and-dependency-injection"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#factory-patterns-and-dependency-injection">Factory Patterns and Dependency Injection</a></h3>
<p>Factories work well with dependency injection for more complex scenarios:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerCreationService</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Service that coordinates customer creation with external dependencies.&quot;&quot;&quot;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="n">customer_repo</span><span class="p">:</span> <span class="n">CustomerRepository</span><span class="p">,</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        <span class="n">email_service</span><span class="p">:</span> <span class="n">EmailService</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>        <span class="n">audit_service</span><span class="p">:</span> <span class="n">AuditService</span><span class="p">,</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="n">notification_service</span><span class="p">:</span> <span class="n">NotificationService</span><span class="p">,</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="p">):</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span> <span class="o">=</span> <span class="n">customer_repo</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_email_service</span> <span class="o">=</span> <span class="n">email_service</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_audit_service</span> <span class="o">=</span> <span class="n">audit_service</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_notification_service</span> <span class="o">=</span> <span class="n">notification_service</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="bp">self</span><span class="p">,</span> 
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>        <span class="n">customer_type</span><span class="p">:</span> <span class="n">CustomerType</span><span class="p">,</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>        <span class="n">email_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>        <span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create customer with all side effects.&quot;&quot;&quot;</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>        <span class="c1"># Validate email doesn&#39;t exist</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>        <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email_str</span><span class="p">)</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Customer with email </span><span class="si">{</span><span class="n">email_str</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>        <span class="c1"># Create customer using factory</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>        <span class="n">factory</span> <span class="o">=</span> <span class="n">get_customer_factory</span><span class="p">(</span><span class="n">customer_type</span><span class="p">)</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">email_str</span><span class="p">)</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>        <span class="c1"># Save to repository</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>        <span class="n">saved_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>        <span class="c1"># Side effects</span>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_audit_service</span><span class="o">.</span><span class="n">log_customer_creation</span><span class="p">(</span><span class="n">saved_customer</span><span class="p">)</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_email_service</span><span class="o">.</span><span class="n">send_welcome_email</span><span class="p">(</span><span class="n">saved_customer</span><span class="p">)</span>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notification_service</span><span class="o">.</span><span class="n">notify_customer_created</span><span class="p">(</span><span class="n">saved_customer</span><span class="p">)</span>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>        <span class="c1"># Process domain events</span>
<a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">saved_customer</span><span class="o">.</span><span class="n">collect_domain_events</span><span class="p">():</span>
<a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notification_service</span><span class="o">.</span><span class="n">publish_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>
<a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>        <span class="k">return</span> <span class="n">saved_customer</span>
</code></pre></div>
<h3 id="common-factory-pattern-pitfalls"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#common-factory-pattern-pitfalls">Common Factory Pattern Pitfalls</a></h3>
<h4 id="1-factories-that-do-too-much"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#1-factories-that-do-too-much">1. Factories That Do Too Much</a></h4>
<p>Keep factories focused on object creation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># Bad - factory doing too much</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>  <span class="c1"># ❌ Side effect</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_analytics</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>  <span class="c1"># ❌ Not creation</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>        <span class="k">return</span> <span class="n">customer</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="c1"># Good - factory focused on creation</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># ✅ Pure creation</span>
</code></pre></div>
<h4 id="2-inconsistent-validation"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#2-inconsistent-validation">2. Inconsistent Validation</a></h4>
<p>Ensure all factory methods apply the same validation rules:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Bad - inconsistent validation</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderFactory</span><span class="p">:</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_online_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>        <span class="c1"># Different validation logic</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>        <span class="k">pass</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_phone_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        <span class="c1"># Different validation logic</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>        <span class="k">pass</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="c1"># Good - consistent validation</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderFactory</span><span class="p">:</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_order_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>        <span class="c1"># Shared validation logic</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>        <span class="k">pass</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_online_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_order_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_phone_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_order_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Same validation</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h4 id="3-tight-coupling-to-infrastructure"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#3-tight-coupling-to-infrastructure">3. Tight Coupling to Infrastructure</a></h4>
<p>Keep factories in the domain layer:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># Bad - factory coupled to infrastructure</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>        <span class="c1"># Direct database access</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>        <span class="k">if</span> <span class="n">database</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>  <span class="c1"># ❌ Infrastructure coupling</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email exists&quot;</span><span class="p">)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="c1"># Good - factory uses domain services</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">:</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_repo</span><span class="p">:</span> <span class="n">CustomerRepository</span><span class="p">):</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span> <span class="o">=</span> <span class="n">customer_repo</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="c1"># Repository abstraction</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email exists&quot;</span><span class="p">)</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h3 id="advanced-factory-patterns"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#advanced-factory-patterns">Advanced Factory Patterns</a></h3>
<h4 id="factory-with-caching"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#factory-with-caching">Factory with Caching</a></h4>
<p>For expensive-to-create objects:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CachedCustomerFactory</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory with caching for expensive customer creation.&quot;&quot;&quot;</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Customer</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_or_get_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create customer or return cached instance.&quot;&quot;&quot;</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>        <span class="k">if</span> <span class="n">email</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">email</span><span class="p">]</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>            <span class="n">name</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>            <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferences&quot;</span><span class="p">,</span> <span class="p">{}),</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>        <span class="p">)</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">email</span><span class="p">]</span> <span class="o">=</span> <span class="n">customer</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>        <span class="k">return</span> <span class="n">customer</span>
</code></pre></div>
<h4 id="factory-with-strategy-pattern"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#factory-with-strategy-pattern">Factory with Strategy Pattern</a></h4>
<p>For different creation strategies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderCreationStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategy for order creation.&quot;&quot;&quot;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">OrderData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create order using this strategy.&quot;&quot;&quot;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="k">pass</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">StandardOrderStrategy</span><span class="p">(</span><span class="n">OrderCreationStrategy</span><span class="p">):</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Standard order creation strategy.&quot;&quot;&quot;</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">OrderData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>        <span class="p">)</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExpressOrderStrategy</span><span class="p">(</span><span class="n">OrderCreationStrategy</span><span class="p">):</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Express order creation with expedited processing.&quot;&quot;&quot;</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">OrderData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>        <span class="n">details</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;processing_priority&quot;</span><span class="p">:</span> <span class="s2">&quot;express&quot;</span><span class="p">,</span> <span class="s2">&quot;estimated_delivery&quot;</span><span class="p">:</span> <span class="s2">&quot;next_day&quot;</span><span class="p">}</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>        <span class="k">return</span> <span class="n">Order</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>            <span class="n">order_id</span><span class="o">=</span><span class="n">OrderId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>            <span class="n">total_amount</span><span class="o">=</span><span class="n">order_data</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;15.00&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)),</span>  <span class="c1"># Express fee</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>            <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>        <span class="p">)</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderFactory</span><span class="p">:</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory using strategy pattern.&quot;&quot;&quot;</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="n">OrderCreationStrategy</span><span class="p">):</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="n">OrderData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span><span class="p">:</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create order using current strategy.&quot;&quot;&quot;</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#conclusion">Conclusion</a></h3>
<p>Factory patterns solve the fundamental problem of object creation in domain-rich applications. By centralizing creation logic, enforcing business rules, and ensuring consistency, factories prevent the bugs and maintenance headaches that come from scattered construction code.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates that Python's flexibility makes factory patterns both powerful and elegant. From simple factory methods on domain entities to complex abstract factories that create object families, these patterns ensure your objects are born valid and remain consistent throughout their lifecycle.</p>
<p>Key takeaways:</p>
<ul>
<li><strong>Factory Methods</strong>: Perfect for single entity creation with domain events</li>
<li><strong>Builder Pattern</strong>: Ideal for complex objects with many optional parameters</li>
<li><strong>Abstract Factory</strong>: Essential for creating families of related objects</li>
<li><strong>Domain Focus</strong>: Keep factories in the domain layer, not infrastructure</li>
<li><strong>Validation</strong>: Centralize business rules in factory methods</li>
<li><strong>Consistency</strong>: Ensure all creation paths follow the same rules</li>
</ul>
<p>In the next post, we'll explore Python Type Hints as your first line of defense against bugs, showing how modern Python's type system can catch errors at development time rather than in production.</p>
<h3 id="references"><a class="toclink" href="../../2025/06/16/factory-pattern-in-python---building-complex-objects-right/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Factory pattern implementations</li>
<li><a href="https://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612">Gang of Four Design Patterns</a> - Original factory pattern concepts</li>
<li><a href="https://realpython.com/factory-method-python/">Python Factory Pattern Guide</a> - Practical Python factory examples</li>
<li><a href="https://martinfowler.com/bliki/DomainDrivenDesign.html">Domain-Driven Design</a> - Context for factory patterns in DDD</li>
</ul>
<p>Remember: Good factories don't just create objects—they create valid, consistent, and properly initialized objects that are ready to participate in your business domain from the moment they exist.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-06-12 20:10:00-04:00">Jun 12, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Clean Architecture</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="../domain-driven-design/" class="md-meta__link">Domain-Driven Design</a></li>
        
        
          
          <li class="md-meta__item">
            
              13 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="value-objects-in-python-small-classes-big-impact"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/">Value Objects in Python: Small Classes, Big Impact</a></h2>
<p>String-typed everything. It's the bane of every Python developer's existence. You've seen it before:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="c1"># What happens if someone passes email as user_id?</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="c1"># What if amount isn&#39;t a valid number?</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="c1"># What if currency is &quot;banana&quot;?</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">pass</span>
</code></pre></div>
<p>This is primitive obsession—using built-in types for domain concepts that deserve their own representation. It leads to bugs that slip past code review, runtime errors that should be compile-time errors, and business logic scattered throughout your codebase.</p>
<p>Value Objects solve this problem elegantly. They're small, immutable classes that represent domain concepts and encapsulate their validation and behavior. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates how Value Objects transform Python code from error-prone string manipulation into type-safe, expressive domain modeling.</p>
<h3 id="what-are-value-objects"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#what-are-value-objects">What Are Value Objects?</a></h3>
<p>Value Objects are objects without identity—they're defined entirely by their attributes. Two Email objects with the same email address are considered equal, unlike entities where two Customer objects with the same name might be different people.</p>
<p>Eric Evans, in Domain-Driven Design, describes Value Objects as having these characteristics:</p>
<ul>
<li><strong>No identity</strong>: They're equal if their attributes are equal</li>
<li><strong>Immutable</strong>: Once created, they cannot be changed</li>
<li><strong>Side-effect free</strong>: Operations return new instances rather than modifying existing ones</li>
<li><strong>Replaceable</strong>: You can substitute one instance for another with the same value</li>
</ul>
<p>Here's a simple example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Primitive obsession - error-prone</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">send_email</span><span class="p">(</span><span class="n">recipient_email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sender_email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="c1"># No validation, easy to mix up parameters</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">recipient_email</span><span class="p">:</span>  <span class="c1"># Basic validation scattered everywhere</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid email&quot;</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="c1"># ... more code</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="c1"># Value Object approach - type-safe and self-validating</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">send_email</span><span class="p">(</span><span class="n">recipient</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span> <span class="n">sender</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Money</span><span class="p">):</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="c1"># Parameters are guaranteed valid by their types</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="c1"># Impossible to mix up recipient and sender</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="c1"># Business logic is centralized in the value objects</span>
</code></pre></div>
<h3 id="building-value-objects-in-python"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#building-value-objects-in-python">Building Value Objects in Python</a></h3>
<p>Python's <code>dataclass</code> decorator provides an excellent foundation for Value Objects. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> shows the pattern:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># src/shared_kernel/base/value_object.py</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ValueObject</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for value objects.&quot;&quot;&quot;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate after initialization.&quot;&quot;&quot;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Override in subclasses to add validation logic.&quot;&quot;&quot;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="o">...</span>
</code></pre></div>
<p>The <code>frozen=True</code> parameter makes the dataclass immutable. The <code>__post_init__</code> hook ensures validation runs after object creation. The abstract <code>validate</code> method forces subclasses to implement their business rules.</p>
<h3 id="email-beyond-string-validation"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#email-beyond-string-validation">Email: Beyond String Validation</a></h3>
<p>Email addresses appear everywhere in modern applications, but they're almost always represented as strings. This leads to validation code scattered throughout your application and bugs when invalid emails slip through:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># src/shared_kernel/value_objects/email.py</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..base.value_object</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValueObject</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Email</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Email address value object with validation.&quot;&quot;&quot;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate email format.&quot;&quot;&quot;</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Email cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="c1"># Basic email validation regex</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="n">email_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&quot;</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">email_pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid email format: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>    <span class="nd">@property</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the domain part of the email.&quot;&quot;&quot;</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>    <span class="nd">@property</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">local_part</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the local part of the email.&quot;&quot;&quot;</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_corporate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corporate_domains</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this is a corporate email address.&quot;&quot;&quot;</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="ow">in</span> <span class="n">corporate_domains</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>
<p>Now email handling becomes type-safe and expressive:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Before - error-prone</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span><span class="p">:</span>  <span class="c1"># Duplicate validation everywhere</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid email&quot;</span><span class="p">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Business logic scattered</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">CORPORATE_DOMAINS</span><span class="p">:</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="n">apply_corporate_settings</span><span class="p">()</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="c1"># After - type-safe and expressive</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">):</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="c1"># Email is guaranteed valid by its type</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="k">if</span> <span class="n">email</span><span class="o">.</span><span class="n">is_corporate_email</span><span class="p">(</span><span class="n">CORPORATE_DOMAINS</span><span class="p">):</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="n">apply_corporate_settings</span><span class="p">()</span>
</code></pre></div>
<h3 id="money-getting-financial-math-right"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#money-getting-financial-math-right">Money: Getting Financial Math Right</a></h3>
<p>Money is notorious for causing bugs in software systems. Floating-point arithmetic is unsuitable for financial calculations, currency mismatches cause errors, and negative amounts often aren't caught until production.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># src/shared_kernel/value_objects/money.py</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..base.value_object</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValueObject</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Money</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Money value object with currency and amount.&quot;&quot;&quot;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate money constraints.&quot;&quot;&quot;</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Amount cannot be negative&quot;</span><span class="p">)</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Currency cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="c1"># Basic currency code validation (3 uppercase letters)</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid currency code: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Money&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Money&quot;</span><span class="p">:</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add two money amounts (must have same currency).&quot;&quot;&quot;</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>                <span class="sa">f</span><span class="s2">&quot;Cannot add different currencies: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>            <span class="p">)</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Money&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Money&quot;</span><span class="p">:</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtract two money amounts (must have same currency).&quot;&quot;&quot;</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>                <span class="sa">f</span><span class="s2">&quot;Cannot subtract different currencies: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>            <span class="p">)</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>        <span class="n">result_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">amount</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>        <span class="k">if</span> <span class="n">result_amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Subtraction would result in negative amount&quot;</span><span class="p">)</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="n">result_amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Money&quot;</span><span class="p">:</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiply money by a factor.&quot;&quot;&quot;</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>        <span class="k">if</span> <span class="n">factor</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Factor cannot be negative&quot;</span><span class="p">)</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>        <span class="k">return</span> <span class="n">Money</span><span class="p">(</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>            <span class="n">amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">factor</span><span class="p">)),</span> 
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>            <span class="n">currency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>        <span class="p">)</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the amount is zero.&quot;&quot;&quot;</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_positive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the amount is positive.&quot;&quot;&quot;</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_display</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format money for display.&quot;&quot;&quot;</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>        <span class="n">currency_symbols</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>            <span class="s2">&quot;USD&quot;</span><span class="p">:</span> <span class="s2">&quot;$&quot;</span><span class="p">,</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>            <span class="s2">&quot;EUR&quot;</span><span class="p">:</span> <span class="s2">&quot;€&quot;</span><span class="p">,</span> 
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>            <span class="s2">&quot;GBP&quot;</span><span class="p">:</span> <span class="s2">&quot;£&quot;</span><span class="p">,</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>            <span class="s2">&quot;JPY&quot;</span><span class="p">:</span> <span class="s2">&quot;¥&quot;</span><span class="p">,</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>        <span class="p">}</span>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>        <span class="n">symbol</span> <span class="o">=</span> <span class="n">currency_symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">currency</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p>Money becomes much safer to work with:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Before - floating point disasters waiting to happen</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Float precision issues</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>        <span class="n">price</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">])</span>  <span class="c1"># String conversion can fail</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>        <span class="n">total</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="k">if</span> <span class="s2">&quot;USD&quot;</span> <span class="o">!=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]:</span>  <span class="c1"># Currency mismatch caught too late</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Currency mismatch&quot;</span><span class="p">)</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="k">return</span> <span class="n">total</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="c1"># After - precise and type-safe</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="n">total</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>        <span class="n">line_total</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">price</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">total</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_total</span><span class="p">)</span>  <span class="c1"># Currency validation automatic</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>    <span class="k">return</span> <span class="n">total</span>
</code></pre></div>
<h3 id="address-complex-data-with-business-logic"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#address-complex-data-with-business-logic">Address: Complex Data with Business Logic</a></h3>
<p>Addresses seem simple until you encounter international variations, validation requirements, and formatting needs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># src/shared_kernel/value_objects/address.py</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..base.value_object</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValueObject</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Physical address value object.&quot;&quot;&quot;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="n">street</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="n">postal_code</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="n">apartment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate address fields.&quot;&quot;&quot;</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">street</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Street cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;City cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;State cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Postal code cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Country cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>        <span class="c1"># Basic postal code validation (flexible format)</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Postal code too short&quot;</span><span class="p">)</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>    <span class="nd">@property</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">full_address</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get formatted full address.&quot;&quot;&quot;</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>        <span class="n">address_parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">street</span><span class="p">]</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apartment</span><span class="p">:</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>            <span class="n">address_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Apt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">apartment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>        <span class="n">address_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">country</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>        <span class="p">])</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address_parts</span><span class="p">)</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_us_address</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this is a US address.&quot;&quot;&quot;</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="s2">&quot;USA&quot;</span><span class="p">,</span> <span class="s2">&quot;UNITED STATES&quot;</span><span class="p">]</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_shipping_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine shipping zone based on address.&quot;&quot;&quot;</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_us_address</span><span class="p">():</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>            <span class="k">return</span> <span class="s2">&quot;domestic&quot;</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;CANADA&quot;</span><span class="p">]:</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>            <span class="k">return</span> <span class="s2">&quot;north_america&quot;</span>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GB&quot;</span><span class="p">,</span> <span class="s2">&quot;FR&quot;</span><span class="p">,</span> <span class="s2">&quot;DE&quot;</span><span class="p">,</span> <span class="s2">&quot;IT&quot;</span><span class="p">,</span> <span class="s2">&quot;ES&quot;</span><span class="p">]:</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>            <span class="k">return</span> <span class="s2">&quot;europe&quot;</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>            <span class="k">return</span> <span class="s2">&quot;international&quot;</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to dictionary for JSON serialization.&quot;&quot;&quot;</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>            <span class="s2">&quot;street&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">street</span><span class="p">,</span>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>            <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="p">,</span>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>            <span class="s2">&quot;postal_code&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">postal_code</span><span class="p">,</span>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>            <span class="s2">&quot;country&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="p">,</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>            <span class="s2">&quot;apartment&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">apartment</span><span class="p">,</span>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>        <span class="p">}</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Address&quot;</span><span class="p">:</span>
<a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create address from dictionary.&quot;&quot;&quot;</span>
<a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>            <span class="n">street</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;street&quot;</span><span class="p">],</span>
<a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a>            <span class="n">city</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">],</span>
<a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a>            <span class="n">state</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">],</span>
<a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>            <span class="n">postal_code</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;postal_code&quot;</span><span class="p">],</span>
<a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>            <span class="n">country</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">],</span>
<a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a>            <span class="n">apartment</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;apartment&quot;</span><span class="p">),</span>
<a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a>        <span class="p">)</span>
<a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>
<a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_address</span>
</code></pre></div>
<p>Address becomes a first-class citizen with business logic:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Before - address handling scattered everywhere</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_shipping_cost</span><span class="p">(</span><span class="n">address_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="k">if</span> <span class="n">address_dict</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;US&quot;</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        <span class="k">return</span> <span class="mf">5.99</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="k">elif</span> <span class="n">address_dict</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;CANADA&quot;</span><span class="p">]:</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>        <span class="k">return</span> <span class="mf">12.99</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>        <span class="k">return</span> <span class="mf">24.99</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="c1"># After - address knows its own business rules</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">calculate_shipping_cost</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="n">base_costs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>        <span class="s2">&quot;domestic&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>        <span class="s2">&quot;north_america&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;12.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>        <span class="s2">&quot;europe&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;19.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>        <span class="s2">&quot;international&quot;</span><span class="p">:</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;24.99&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">),</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>    <span class="p">}</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>    <span class="n">zone</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>    <span class="k">return</span> <span class="n">base_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">base_costs</span><span class="p">[</span><span class="s2">&quot;international&quot;</span><span class="p">])</span>
</code></pre></div>
<h3 id="strongly-typed-identifiers"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#strongly-typed-identifiers">Strongly Typed Identifiers</a></h3>
<p>One of the most powerful applications of Value Objects is creating strongly typed identifiers. Instead of passing UUIDs as strings everywhere, create specific types:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># src/shared_kernel/types/identifiers.py</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">..base.value_object</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValueObject</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerId</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Strongly typed customer identifier.&quot;&quot;&quot;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="n">value</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate customer ID.&quot;&quot;&quot;</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>        <span class="c1"># Type is guaranteed by annotation, no validation needed</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>        <span class="k">pass</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderId</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Strongly typed order identifier.&quot;&quot;&quot;</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="n">value</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate order ID.&quot;&quot;&quot;</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>        <span class="k">pass</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProductId</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Strongly typed product identifier.&quot;&quot;&quot;</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>    <span class="n">value</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate product ID.&quot;&quot;&quot;</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>        <span class="k">pass</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
<p>Strongly typed identifiers prevent a class of bugs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Before - easy to mix up parameters</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer_order</span><span class="p">(</span><span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="c1"># What happens if someone passes order_id as customer_id?</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="k">pass</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="c1"># After - impossible to mix up parameters</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">transfer_order</span><span class="p">(</span><span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="n">ProductId</span><span class="p">):</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="c1"># Type system catches parameter mismatches at development time</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="k">pass</span>
</code></pre></div>
<h3 id="complex-value-objects-date-ranges"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#complex-value-objects-date-ranges">Complex Value Objects: Date Ranges</a></h3>
<p>Value Objects can represent complex concepts that combine multiple primitives:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterator</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">DateRange</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Value object representing a date range.&quot;&quot;&quot;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="n">start_date</span><span class="p">:</span> <span class="n">date</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="n">end_date</span><span class="p">:</span> <span class="n">date</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate date range constraints.&quot;&quot;&quot;</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Start date cannot be after end date&quot;</span><span class="p">)</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>    <span class="nd">@property</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">timedelta</span><span class="p">:</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the duration of the date range.&quot;&quot;&quot;</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    <span class="nd">@property</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">duration_days</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get duration in days.&quot;&quot;&quot;</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">days</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_date</span><span class="p">:</span> <span class="n">date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a date falls within this range.&quot;&quot;&quot;</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">check_date</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;DateRange&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this range overlaps with another.&quot;&quot;&quot;</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">and</span> 
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">&gt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_weekend_only</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if range contains only weekend days.&quot;&quot;&quot;</span>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>        <span class="k">for</span> <span class="n">single_date</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_range</span><span class="p">():</span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>            <span class="k">if</span> <span class="n">single_date</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Monday is 0, Friday is 4</span>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>                <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">date_range</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">date</span><span class="p">]:</span>
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all dates in the range.&quot;&quot;&quot;</span>
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>        <span class="n">current_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>        <span class="k">while</span> <span class="n">current_date</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>            <span class="k">yield</span> <span class="n">current_date</span>
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>            <span class="n">current_date</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>
<a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">extend_by_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DateRange&quot;</span><span class="p">:</span>
<a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new date range extended by the specified days.&quot;&quot;&quot;</span>
<a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>        <span class="k">return</span> <span class="n">DateRange</span><span class="p">(</span>
<a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>            <span class="n">start_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span>
<a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>            <span class="n">end_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
<a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>        <span class="p">)</span>
<a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>
<a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">for_month</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DateRange&quot;</span><span class="p">:</span>
<a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a date range for an entire month.&quot;&quot;&quot;</span>
<a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>        <span class="n">start_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>        <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
<a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>            <span class="n">end_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>            <span class="n">end_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a>
<a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-11-67" name="__codelineno-11-67" href="#__codelineno-11-67"></a>
<a id="__codelineno-11-68" name="__codelineno-11-68" href="#__codelineno-11-68"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-11-69" name="__codelineno-11-69" href="#__codelineno-11-69"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<h3 id="value-objects-in-business-logic"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#value-objects-in-business-logic">Value Objects in Business Logic</a></h3>
<p>Value Objects shine when they encapsulate business rules. Consider a discount system:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Discount</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Discount value object with business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>    <span class="n">percentage</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">min_amount</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">max_discount</span><span class="p">:</span> <span class="n">Money</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate discount constraints.&quot;&quot;&quot;</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Discount percentage must be between 0 and 100&quot;</span><span class="p">)</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Minimum amount cannot be negative&quot;</span><span class="p">)</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Maximum discount must be positive&quot;</span><span class="p">)</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">applies_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_total</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if discount applies to an order total.&quot;&quot;&quot;</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="k">if</span> <span class="n">order_total</span><span class="o">.</span><span class="n">currency</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="o">.</span><span class="n">currency</span><span class="p">:</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>        <span class="k">return</span> <span class="n">order_total</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_amount</span><span class="o">.</span><span class="n">amount</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_discount_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_total</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the discount amount for an order.&quot;&quot;&quot;</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">applies_to</span><span class="p">(</span><span class="n">order_total</span><span class="p">):</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>            <span class="k">return</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="n">order_total</span><span class="o">.</span><span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>        <span class="n">discount_amount</span> <span class="o">=</span> <span class="n">order_total</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">percentage</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span> <span class="ow">and</span> <span class="n">discount_amount</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span><span class="o">.</span><span class="n">amount</span><span class="p">:</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_discount</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>        <span class="k">return</span> <span class="n">discount_amount</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_to_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_total</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply discount to an order total.&quot;&quot;&quot;</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>        <span class="n">discount_amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_discount_amount</span><span class="p">(</span><span class="n">order_total</span><span class="p">)</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>        <span class="k">return</span> <span class="n">order_total</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">discount_amount</span><span class="p">)</span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">percentage_discount</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">percentage</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">min_amount</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Discount&quot;</span><span class="p">:</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a percentage discount.&quot;&quot;&quot;</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>            <span class="n">percentage</span><span class="o">=</span><span class="n">percentage</span><span class="p">,</span>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>            <span class="n">min_amount</span><span class="o">=</span><span class="n">min_amount</span><span class="p">,</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>            <span class="n">max_discount</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>        <span class="p">)</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">capped_discount</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">percentage</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">min_amount</span><span class="p">:</span> <span class="n">Money</span><span class="p">,</span> <span class="n">max_discount</span><span class="p">:</span> <span class="n">Money</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Discount&quot;</span><span class="p">:</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a capped percentage discount.&quot;&quot;&quot;</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>            <span class="n">percentage</span><span class="o">=</span><span class="n">percentage</span><span class="p">,</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>            <span class="n">min_amount</span><span class="o">=</span><span class="n">min_amount</span><span class="p">,</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>            <span class="n">max_discount</span><span class="o">=</span><span class="n">max_discount</span>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="testing-value-objects"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#testing-value-objects">Testing Value Objects</a></h3>
<p>Value Objects are inherently easy to test because they have no dependencies and are purely functional:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># tests/unit/shared_kernel/test_value_objects.py</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel.value_objects</span><span class="w"> </span><span class="kn">import</span> <span class="n">Money</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">Address</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestMoney</span><span class="p">:</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_valid_money</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating valid money object.&quot;&quot;&quot;</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>        <span class="n">money</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>        <span class="k">assert</span> <span class="n">money</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">)</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>        <span class="k">assert</span> <span class="n">money</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;USD&quot;</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_negative_amount_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that negative amounts raise validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Amount cannot be negative&quot;</span><span class="p">):</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>            <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_currency_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that invalid currency codes raise validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid currency code&quot;</span><span class="p">):</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>            <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;usd&quot;</span><span class="p">)</span>  <span class="c1"># lowercase</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid currency code&quot;</span><span class="p">):</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>            <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USDD&quot;</span><span class="p">)</span>  <span class="c1"># too long</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_add_same_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test adding money with same currency.&quot;&quot;&quot;</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>        <span class="n">money1</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>        <span class="n">money2</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.25&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">money1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">money2</span><span class="p">)</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;15.75&quot;</span><span class="p">)</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;USD&quot;</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_add_different_currencies_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that adding different currencies raises error.&quot;&quot;&quot;</span>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>        <span class="n">usd_money</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;10.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>        <span class="n">eur_money</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;5.25&quot;</span><span class="p">),</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span>
<a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>
<a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Cannot add different currencies&quot;</span><span class="p">):</span>
<a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>            <span class="n">usd_money</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eur_money</span><span class="p">)</span>
<a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>
<a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestEmail</span><span class="p">:</span>
<a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_valid_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating valid email object.&quot;&quot;&quot;</span>
<a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;test@example.com&quot;</span>
<a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;example.com&quot;</span>
<a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">local_part</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span>
<a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>
<a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_email_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that invalid email formats raise validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">):</span>
<a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;invalid-email&quot;</span><span class="p">)</span>
<a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a>
<a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">):</span>
<a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a>
<a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_empty_email_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-61" name="__codelineno-13-61" href="#__codelineno-13-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that empty email raises validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-13-62" name="__codelineno-13-62" href="#__codelineno-13-62"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Email cannot be empty&quot;</span><span class="p">):</span>
<a id="__codelineno-13-63" name="__codelineno-13-63" href="#__codelineno-13-63"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-13-64" name="__codelineno-13-64" href="#__codelineno-13-64"></a>
<a id="__codelineno-13-65" name="__codelineno-13-65" href="#__codelineno-13-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_is_corporate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-66" name="__codelineno-13-66" href="#__codelineno-13-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test corporate email detection.&quot;&quot;&quot;</span>
<a id="__codelineno-13-67" name="__codelineno-13-67" href="#__codelineno-13-67"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@company.com&quot;</span><span class="p">)</span>
<a id="__codelineno-13-68" name="__codelineno-13-68" href="#__codelineno-13-68"></a>        <span class="n">corporate_domains</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;company.com&quot;</span><span class="p">,</span> <span class="s2">&quot;corporation.org&quot;</span><span class="p">}</span>
<a id="__codelineno-13-69" name="__codelineno-13-69" href="#__codelineno-13-69"></a>
<a id="__codelineno-13-70" name="__codelineno-13-70" href="#__codelineno-13-70"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">is_corporate_email</span><span class="p">(</span><span class="n">corporate_domains</span><span class="p">)</span>
<a id="__codelineno-13-71" name="__codelineno-13-71" href="#__codelineno-13-71"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="n">email</span><span class="o">.</span><span class="n">is_corporate_email</span><span class="p">({</span><span class="s2">&quot;other.com&quot;</span><span class="p">})</span>
<a id="__codelineno-13-72" name="__codelineno-13-72" href="#__codelineno-13-72"></a>
<a id="__codelineno-13-73" name="__codelineno-13-73" href="#__codelineno-13-73"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestAddress</span><span class="p">:</span>
<a id="__codelineno-13-74" name="__codelineno-13-74" href="#__codelineno-13-74"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_valid_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-75" name="__codelineno-13-75" href="#__codelineno-13-75"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating valid address object.&quot;&quot;&quot;</span>
<a id="__codelineno-13-76" name="__codelineno-13-76" href="#__codelineno-13-76"></a>        <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span>
<a id="__codelineno-13-77" name="__codelineno-13-77" href="#__codelineno-13-77"></a>            <span class="n">street</span><span class="o">=</span><span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-13-78" name="__codelineno-13-78" href="#__codelineno-13-78"></a>            <span class="n">city</span><span class="o">=</span><span class="s2">&quot;Anytown&quot;</span><span class="p">,</span>
<a id="__codelineno-13-79" name="__codelineno-13-79" href="#__codelineno-13-79"></a>            <span class="n">state</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span>
<a id="__codelineno-13-80" name="__codelineno-13-80" href="#__codelineno-13-80"></a>            <span class="n">postal_code</span><span class="o">=</span><span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<a id="__codelineno-13-81" name="__codelineno-13-81" href="#__codelineno-13-81"></a>            <span class="n">country</span><span class="o">=</span><span class="s2">&quot;USA&quot;</span>
<a id="__codelineno-13-82" name="__codelineno-13-82" href="#__codelineno-13-82"></a>        <span class="p">)</span>
<a id="__codelineno-13-83" name="__codelineno-13-83" href="#__codelineno-13-83"></a>
<a id="__codelineno-13-84" name="__codelineno-13-84" href="#__codelineno-13-84"></a>        <span class="k">assert</span> <span class="s2">&quot;123 Main St&quot;</span> <span class="ow">in</span> <span class="n">address</span><span class="o">.</span><span class="n">full_address</span>
<a id="__codelineno-13-85" name="__codelineno-13-85" href="#__codelineno-13-85"></a>        <span class="k">assert</span> <span class="n">address</span><span class="o">.</span><span class="n">is_us_address</span><span class="p">()</span>
<a id="__codelineno-13-86" name="__codelineno-13-86" href="#__codelineno-13-86"></a>        <span class="k">assert</span> <span class="n">address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;domestic&quot;</span>
<a id="__codelineno-13-87" name="__codelineno-13-87" href="#__codelineno-13-87"></a>
<a id="__codelineno-13-88" name="__codelineno-13-88" href="#__codelineno-13-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_empty_street_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-89" name="__codelineno-13-89" href="#__codelineno-13-89"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that empty street raises validation error.&quot;&quot;&quot;</span>
<a id="__codelineno-13-90" name="__codelineno-13-90" href="#__codelineno-13-90"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Street cannot be empty&quot;</span><span class="p">):</span>
<a id="__codelineno-13-91" name="__codelineno-13-91" href="#__codelineno-13-91"></a>            <span class="n">Address</span><span class="p">(</span>
<a id="__codelineno-13-92" name="__codelineno-13-92" href="#__codelineno-13-92"></a>                <span class="n">street</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-13-93" name="__codelineno-13-93" href="#__codelineno-13-93"></a>                <span class="n">city</span><span class="o">=</span><span class="s2">&quot;Anytown&quot;</span><span class="p">,</span>
<a id="__codelineno-13-94" name="__codelineno-13-94" href="#__codelineno-13-94"></a>                <span class="n">state</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span>
<a id="__codelineno-13-95" name="__codelineno-13-95" href="#__codelineno-13-95"></a>                <span class="n">postal_code</span><span class="o">=</span><span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<a id="__codelineno-13-96" name="__codelineno-13-96" href="#__codelineno-13-96"></a>                <span class="n">country</span><span class="o">=</span><span class="s2">&quot;USA&quot;</span>
<a id="__codelineno-13-97" name="__codelineno-13-97" href="#__codelineno-13-97"></a>            <span class="p">)</span>
<a id="__codelineno-13-98" name="__codelineno-13-98" href="#__codelineno-13-98"></a>
<a id="__codelineno-13-99" name="__codelineno-13-99" href="#__codelineno-13-99"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_shipping_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-13-100" name="__codelineno-13-100" href="#__codelineno-13-100"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test shipping zone determination.&quot;&quot;&quot;</span>
<a id="__codelineno-13-101" name="__codelineno-13-101" href="#__codelineno-13-101"></a>        <span class="n">us_address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span> <span class="s2">&quot;Anytown&quot;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;12345&quot;</span><span class="p">,</span> <span class="s2">&quot;USA&quot;</span><span class="p">)</span>
<a id="__codelineno-13-102" name="__codelineno-13-102" href="#__codelineno-13-102"></a>        <span class="n">ca_address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;456 Maple Ave&quot;</span><span class="p">,</span> <span class="s2">&quot;Toronto&quot;</span><span class="p">,</span> <span class="s2">&quot;ON&quot;</span><span class="p">,</span> <span class="s2">&quot;M1M1M1&quot;</span><span class="p">,</span> <span class="s2">&quot;CANADA&quot;</span><span class="p">)</span>
<a id="__codelineno-13-103" name="__codelineno-13-103" href="#__codelineno-13-103"></a>        <span class="n">uk_address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;789 High St&quot;</span><span class="p">,</span> <span class="s2">&quot;London&quot;</span><span class="p">,</span> <span class="s2">&quot;ENG&quot;</span><span class="p">,</span> <span class="s2">&quot;SW1A 1AA&quot;</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">)</span>
<a id="__codelineno-13-104" name="__codelineno-13-104" href="#__codelineno-13-104"></a>
<a id="__codelineno-13-105" name="__codelineno-13-105" href="#__codelineno-13-105"></a>        <span class="k">assert</span> <span class="n">us_address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;domestic&quot;</span>
<a id="__codelineno-13-106" name="__codelineno-13-106" href="#__codelineno-13-106"></a>        <span class="k">assert</span> <span class="n">ca_address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;north_america&quot;</span>
<a id="__codelineno-13-107" name="__codelineno-13-107" href="#__codelineno-13-107"></a>        <span class="k">assert</span> <span class="n">uk_address</span><span class="o">.</span><span class="n">get_shipping_zone</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;europe&quot;</span>
</code></pre></div>
<h3 id="value-objects-and-persistence"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#value-objects-and-persistence">Value Objects and Persistence</a></h3>
<p>Value Objects need special handling when persisting to databases. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> shows how to handle this with SQLAlchemy:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># src/infrastructure/database/models/customer_model.py</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">DateTime</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Address</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">Money</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;SQLAlchemy model for customer persistence.&quot;&quot;&quot;</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customers&quot;</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>    <span class="n">address_data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>        <span class="n">JSON</span><span class="p">,</span> 
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;address&quot;</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>    <span class="p">)</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CustomerModel&quot;</span><span class="p">:</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert domain entity to database model.&quot;&quot;&quot;</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>            <span class="n">name</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>            <span class="n">email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>  <span class="c1"># Convert Email to string</span>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>            <span class="n">address_data</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">customer</span><span class="o">.</span><span class="n">address</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>            <span class="c1"># ... other fields</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>        <span class="p">)</span>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert database model to domain entity.&quot;&quot;&quot;</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>        <span class="n">address</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_data</span><span class="p">:</span>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>            <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_data</span><span class="p">)</span>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a>            <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>  <span class="c1"># Convert string back to Email</span>
<a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a>            <span class="c1"># ... other fields</span>
<a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a>        <span class="p">)</span>
</code></pre></div>
<p>For JSON APIs, you need similar conversion:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># src/presentation/schemas/customer_schemas.py</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">validator</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request model for creating a customer.&quot;&quot;&quot;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>  <span class="c1"># Pydantic validates email format</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_domain_command</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CreateCustomerCommand</span><span class="p">:</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert API request to domain command.&quot;&quot;&quot;</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>        <span class="k">return</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>            <span class="n">email</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>  <span class="c1"># Will be converted to Email value object in use case</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>            <span class="n">address_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="common-pitfalls-and-solutions"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#common-pitfalls-and-solutions">Common Pitfalls and Solutions</a></h3>
<h4 id="1-overuse-of-value-objects"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#1-overuse-of-value-objects">1. Overuse of Value Objects</a></h4>
<p>Not every concept needs a Value Object. Use them when:
- The concept has validation rules
- The concept has behavior
- You want type safety
- The concept appears frequently in your domain</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Probably overkill</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">FirstName</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="c1"># Better - just use str if there&#39;s no special behavior</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>
<h4 id="2-mutable-value-objects"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#2-mutable-value-objects">2. Mutable Value Objects</a></h4>
<p>Value Objects must be immutable. Use <code>frozen=True</code> in dataclasses:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># Bad - mutable value object</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="nd">@dataclass</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Money</span><span class="p">:</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="c1"># Good - immutable value object</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Money</span><span class="p">:</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>
<h4 id="3-value-objects-with-identity"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#3-value-objects-with-identity">3. Value Objects with Identity</a></h4>
<p>If it has identity, it's not a Value Object—it's an Entity:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># Bad - UserAccount is an entity, not a value object</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserAccount</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="n">account_id</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># This gives it identity!</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    <span class="n">balance</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="c1"># Good - separate entity from value objects</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="nd">@dataclass</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserAccount</span><span class="p">(</span><span class="n">Entity</span><span class="p">):</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>    <span class="n">account_id</span><span class="p">:</span> <span class="n">AccountId</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>    <span class="n">balance</span><span class="p">:</span> <span class="n">Money</span>  <span class="c1"># Money is the value object</span>
</code></pre></div>
<h4 id="4-side-effects-in-value-objects"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#4-side-effects-in-value-objects">4. Side Effects in Value Objects</a></h4>
<p>Value Objects should be side-effect free:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># Bad - side effects in value object</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Email</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">send_welcome_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># ❌ Side effect!</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>        <span class="n">email_service</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="c1"># Good - pure value object</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">Email</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_valid_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  <span class="c1"># ✅ Pure function</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>        <span class="k">return</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>
<h3 id="value-objects-in-domain-events"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#value-objects-in-domain-events">Value Objects in Domain Events</a></h3>
<p>Value Objects work excellently in domain events:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderPlaced</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Domain event when an order is placed.&quot;&quot;&quot;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>    <span class="n">order_total</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">Address</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    <span class="n">billing_address</span><span class="p">:</span> <span class="n">Address</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    <span class="n">order_date</span><span class="p">:</span> <span class="n">date</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>    <span class="c1"># All properties are value objects or primitives</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>    <span class="c1"># Event is immutable and self-contained</span>
</code></pre></div>
<h3 id="performance-considerations"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#performance-considerations">Performance Considerations</a></h3>
<p>Value Objects are generally lightweight, but consider these patterns for high-performance scenarios:</p>
<h4 id="flyweight-pattern-for-common-values"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#flyweight-pattern-for-common-values">Flyweight Pattern for Common Values</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># For frequently used values, consider flyweight pattern</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Money</span><span class="p">:</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="n">_instances</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">:</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>            <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="c1"># Common values are shared</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="n">zero_usd</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="n">another_zero</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="k">assert</span> <span class="n">zero_usd</span> <span class="ow">is</span> <span class="n">another_zero</span>  <span class="c1"># Same instance</span>
</code></pre></div>
<h4 id="lazy-validation"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#lazy-validation">Lazy Validation</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Email</span><span class="p">(</span><span class="n">ValueObject</span><span class="p">):</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="n">_validated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validated</span><span class="p">:</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>            <span class="k">return</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>        <span class="c1"># Expensive validation logic here</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_validated&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#conclusion">Conclusion</a></h3>
<p>Value Objects are small classes that make a big impact on code quality. They eliminate primitive obsession, centralize validation logic, and make your domain model more expressive. By representing domain concepts as first-class objects rather than primitive types, you create code that is:</p>
<ul>
<li><strong>Type-safe</strong>: The compiler catches parameter mix-ups</li>
<li><strong>Self-validating</strong>: Invalid states are impossible</li>
<li><strong>Expressive</strong>: Code reads like business language</li>
<li><strong>Testable</strong>: Pure functions with no dependencies</li>
<li><strong>Maintainable</strong>: Business logic is centralized</li>
</ul>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates these patterns in production-ready code. Start with the most problematic primitives in your codebase—usually strings that represent emails, identifiers, or money amounts. Replace them with Value Objects and watch your bugs disappear.</p>
<p>In the next post, we'll explore the Factory Pattern in Python, showing how to create complex objects and aggregates while maintaining business invariants and handling validation elegantly.</p>
<h3 id="references"><a class="toclink" href="../../2025/06/12/value-objects-in-python---small-classes-big-impact/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete Value Object implementations</li>
<li><a href="https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215">Domain-Driven Design Book</a> - Eric Evans' original DDD concepts</li>
<li><a href="https://docs.python.org/3/library/dataclasses.html">Python Dataclasses</a> - Official dataclasses documentation</li>
<li><a href="https://pydantic.dev/">Pydantic Documentation</a> - Validation and serialization library</li>
</ul>
<p>Remember: Value Objects are about expressing intent. When you see a string that represents something specific in your domain, that's a Value Object waiting to be born.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-06-08 19:20:00-04:00">Jun 8, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Clean Architecture</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="../software-architecture/" class="md-meta__link">Software Architecture</a></li>
        
        
          
          <li class="md-meta__item">
            
              13 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="clean-architecture-in-python-keeping-your-business-logic-pure"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/">Clean Architecture in Python: Keeping Your Business Logic Pure</a></h2>
<p>Software architecture is like city planning. Without proper zoning, you end up with industrial waste flowing into residential areas and traffic jams everywhere. Clean Architecture provides that zoning system for your codebase, creating clear boundaries between business logic and technical infrastructure.</p>
<p>I've spent years untangling codebases where database queries were mixed with HTTP handling, business rules were scattered across controllers, and changing a database table required touching dozens of files. Clean Architecture changed how I think about software design—not as technical layers, but as concentric circles with business logic at the center.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates Clean Architecture principles in Python, showing how to structure applications that are testable, maintainable, and independent of frameworks. This isn't about academic purity; it's about practical patterns that make your code easier to understand, change, and scale.</p>
<h3 id="understanding-clean-architecture"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#understanding-clean-architecture">Understanding Clean Architecture</a></h3>
<p>Robert Martin introduced Clean Architecture as a way to create software that is:</p>
<ul>
<li><strong>Independent of frameworks</strong>: Your business logic doesn't depend on FastAPI, Django, or any other framework</li>
<li><strong>Testable</strong>: Business rules can be tested without UI, database, or external services</li>
<li><strong>Independent of UI</strong>: The same business logic works with web APIs, command-line interfaces, or desktop applications</li>
<li><strong>Independent of database</strong>: Your business logic doesn't care whether you use PostgreSQL, MongoDB, or in-memory storage</li>
<li><strong>Independent of external agencies</strong>: Business rules don't know about third-party services</li>
</ul>
<p>The key insight is <strong>dependency inversion</strong>. Instead of high-level business logic depending on low-level technical details, both depend on abstractions. The result is software where the most important code—your business logic—has no external dependencies.</p>
<h3 id="the-concentric-circles"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#the-concentric-circles">The Concentric Circles</a></h3>
<p>Clean Architecture organizes code into concentric circles:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>┌─────────────────────────────────────┐
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>│           Infrastructure            │  ← Frameworks, databases, web servers
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>│  ┌─────────────────────────────┐    │
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>│  │        Presentation         │    │  ← Controllers, REST APIs, CLI
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>│  │  ┌─────────────────────┐    │    │
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>│  │  │     Application     │    │    │  ← Use cases, application services
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>│  │  │  ┌─────────────┐    │    │    │
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>│  │  │  │   Domain    │    │    │    │  ← Entities, value objects, business rules
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>│  │  │  └─────────────┘    │    │    │
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>│  │  └─────────────────────┘    │    │
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>│  └─────────────────────────────┘    │
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>└─────────────────────────────────────┘
</code></pre></div>
<p>Dependencies point inward. The domain layer has no dependencies. The application layer depends only on the domain. The presentation layer can depend on application and domain, but not infrastructure. Infrastructure can depend on everything but is injected through interfaces.</p>
<h3 id="domain-layer-pure-business-logic"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#domain-layer-pure-business-logic">Domain Layer: Pure Business Logic</a></h3>
<p>The domain layer contains your business entities, value objects, and rules. It has zero dependencies on external libraries or frameworks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># src/domain/entities/customer.py</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTC</span><span class="p">,</span> <span class="n">datetime</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">uuid4</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="n">Address</span><span class="p">,</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="n">AggregateRoot</span><span class="p">,</span> 
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="n">CustomerId</span><span class="p">,</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="n">DomainEvent</span><span class="p">,</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="n">PhoneNumber</span><span class="p">,</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="p">)</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerCreated</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Domain event raised when a customer is created.&quot;&quot;&quot;</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    <span class="n">event_id</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="n">occurred_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>    <span class="n">customer_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="n">customer_email</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="nd">@dataclass</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">AggregateRoot</span><span class="p">):</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Customer aggregate root with enhanced value objects and domain events.&quot;&quot;&quot;</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Email</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>    <span class="n">address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>    <span class="n">phone</span><span class="p">:</span> <span class="n">PhoneNumber</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">))</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the aggregate and validate business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>        <span class="c1"># Set the entity ID from customer_id for base Entity class</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_business_rules</span><span class="p">()</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_business_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate customer business rules.&quot;&quot;&quot;</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Customer name cannot be empty&quot;</span><span class="p">)</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>        <span class="c1"># Email validation is handled by the Email value object</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>        <span class="bp">cls</span><span class="p">,</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>        <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">,</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>        <span class="n">email</span><span class="p">:</span> <span class="n">Email</span><span class="p">,</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>        <span class="n">address</span><span class="p">:</span> <span class="n">Address</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>        <span class="n">phone</span><span class="p">:</span> <span class="n">PhoneNumber</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>        <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Customer&quot;</span><span class="p">:</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Factory method to create a new customer with domain event.&quot;&quot;&quot;</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>            <span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">preferences</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>        <span class="p">)</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>        <span class="c1"># Raise domain event</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>        <span class="n">customer</span><span class="o">.</span><span class="n">add_domain_event</span><span class="p">(</span>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>            <span class="n">CustomerCreated</span><span class="p">(</span>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>                <span class="n">event_id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>                <span class="n">occurred_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a>                <span class="n">customer_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>                <span class="n">customer_email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>            <span class="p">)</span>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>        <span class="p">)</span>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>        <span class="k">return</span> <span class="n">customer</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Manual deactivation&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Customer&quot;</span><span class="p">:</span>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Deactivate the customer and raise domain event.&quot;&quot;&quot;</span>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Customer is already deactivated&quot;</span><span class="p">)</span>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>        <span class="n">deactivated_customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a>            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>            <span class="n">email</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a>            <span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>            <span class="n">phone</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>            <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>            <span class="n">preferences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>            <span class="n">created_at</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>        <span class="p">)</span>
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>        <span class="c1"># Copy domain events and add deactivation event</span>
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a>        <span class="n">deactivated_customer</span><span class="o">.</span><span class="n">_domain_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_events</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a>        <span class="n">deactivated_customer</span><span class="o">.</span><span class="n">add_domain_event</span><span class="p">(</span>
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a>            <span class="n">CustomerDeactivated</span><span class="p">(</span>
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a>                <span class="n">event_id</span><span class="o">=</span><span class="n">uuid4</span><span class="p">(),</span>
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a>                <span class="n">occurred_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">),</span>
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a>                <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>            <span class="p">)</span>
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>        <span class="p">)</span>
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>
<a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a>        <span class="k">return</span> <span class="n">deactivated_customer</span>
</code></pre></div>
<p>Notice several key characteristics:</p>
<ol>
<li><strong>Pure business logic</strong>: No imports from FastAPI, SQLAlchemy, or other frameworks</li>
<li><strong>Rich domain model</strong>: The entity contains behavior, not just data</li>
<li><strong>Value objects</strong>: Email, Address, and CustomerId provide type safety and validation</li>
<li><strong>Domain events</strong>: Business events are raised when important things happen</li>
<li><strong>Immutability</strong>: Operations return new instances rather than modifying state</li>
</ol>
<p>The domain also defines repository interfaces:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># src/domain/repositories/customer_repository.py</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerRepository</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract repository for customer persistence.&quot;&quot;&quot;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a customer and return the saved instance.&quot;&quot;&quot;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="k">pass</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a customer by their ID.&quot;&quot;&quot;</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>        <span class="k">pass</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_by_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a customer by their email address.&quot;&quot;&quot;</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>        <span class="k">pass</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_all_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all active customers.&quot;&quot;&quot;</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>        <span class="k">pass</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a customer by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="k">pass</span>
</code></pre></div>
<p>These interfaces define what the domain needs from the outside world without coupling to specific implementations. The domain layer declares its needs; other layers fulfill them.</p>
<h3 id="application-layer-orchestrating-business-logic"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#application-layer-orchestrating-business-logic">Application Layer: Orchestrating Business Logic</a></h3>
<p>The application layer contains use cases—the workflows your application supports. It depends on the domain layer but remains independent of infrastructure:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># src/application/use_cases/commands/create_customer.py</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.repositories.customer_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerRepository</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="nd">@dataclass</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerCommand</span><span class="p">:</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerUseCase</span><span class="p">:</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_repository</span><span class="p">:</span> <span class="n">CustomerRepository</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span> <span class="o">=</span> <span class="n">customer_repository</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">CreateCustomerCommand</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>        <span class="c1"># Check if customer with email already exists</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>        <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Customer with email </span><span class="si">{</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>        <span class="c1"># Create new customer using factory method</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>            <span class="n">name</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">preferences</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>        <span class="p">)</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
</code></pre></div>
<p>The use case:</p>
<ol>
<li><strong>Validates business rules</strong>: Checks for duplicate emails</li>
<li><strong>Orchestrates domain operations</strong>: Uses the Customer factory method</li>
<li><strong>Depends on abstractions</strong>: Uses the CustomerRepository interface</li>
<li><strong>Remains pure</strong>: No HTTP, database, or framework concerns</li>
</ol>
<p>Query use cases follow similar patterns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># src/application/use_cases/queries/search_customers.py</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.repositories.customer_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerRepository</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="nd">@dataclass</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">SearchCustomersQuery</span><span class="p">:</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="n">name_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="n">email_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="n">active_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">SearchCustomersUseCase</span><span class="p">:</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_repository</span><span class="p">:</span> <span class="n">CustomerRepository</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span> <span class="o">=</span> <span class="n">customer_repository</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">SearchCustomersQuery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="c1"># This is simplified - in a real app, you&#39;d have more sophisticated</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="c1"># search capabilities in your repository</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">active_only</span><span class="p">:</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>            <span class="n">customers</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_all_active</span><span class="p">()</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>            <span class="n">customers</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_repo</span><span class="o">.</span><span class="n">find_all</span><span class="p">()</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="c1"># Apply filters</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="n">filtered_customers</span> <span class="o">=</span> <span class="n">customers</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">name_filter</span><span class="p">:</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>            <span class="n">filtered_customers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">filtered_customers</span> 
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>                <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">name_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>            <span class="p">]</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">email_filter</span><span class="p">:</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>            <span class="n">filtered_customers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">filtered_customers</span> 
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>                <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">email_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>            <span class="p">]</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="k">return</span> <span class="n">filtered_customers</span>
</code></pre></div>
<h3 id="infrastructure-layer-technical-implementation-details"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#infrastructure-layer-technical-implementation-details">Infrastructure Layer: Technical Implementation Details</a></h3>
<p>The infrastructure layer implements the interfaces defined by inner layers. It handles databases, external APIs, file systems, and other technical concerns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># src/infrastructure/database/repositories/customer_repository_impl.py</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.repositories.customer_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerRepository</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.models.customer_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerModel</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerRepositoryImpl</span><span class="p">(</span><span class="n">CustomerRepository</span><span class="p">):</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;SQLAlchemy implementation of CustomerRepository.&quot;&quot;&quot;</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a customer to the database.&quot;&quot;&quot;</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="c1"># Convert domain entity to database model</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="n">customer_model</span> <span class="o">=</span> <span class="n">CustomerModel</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="c1"># Check if this is an existing customer</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        <span class="n">existing</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">,</span> <span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>            <span class="c1"># Update existing model</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">customer_model</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>                    <span class="nb">setattr</span><span class="p">(</span><span class="n">existing</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>            <span class="c1"># Add new model</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">customer_model</span><span class="p">)</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">customer_model</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span> <span class="k">else</span> <span class="n">existing</span><span class="p">)</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>        <span class="c1"># Convert back to domain entity</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">customer_model</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span> <span class="k">else</span> <span class="n">existing</span><span class="p">)</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find customer by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_by_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find customer by email.&quot;&quot;&quot;</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">CustomerModel</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>        <span class="n">customer_model</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>        <span class="k">return</span> <span class="n">customer_model</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span> <span class="k">if</span> <span class="n">customer_model</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">find_all_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Customer</span><span class="p">]:</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find all active customers.&quot;&quot;&quot;</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">CustomerModel</span><span class="o">.</span><span class="n">is_active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()]</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete customer by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>        <span class="n">customer_model</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CustomerModel</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>        <span class="k">if</span> <span class="n">customer_model</span><span class="p">:</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">customer_model</span><span class="p">)</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p>The database model handles the mapping between domain entities and database tables:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># src/infrastructure/database/models/customer_model.py</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Text</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects.postgresql</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span> <span class="k">as</span> <span class="n">PostgresUUID</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.models.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Address</span><span class="p">,</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">PhoneNumber</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;SQLAlchemy model for customer persistence.&quot;&quot;&quot;</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customers&quot;</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="nb">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>        <span class="n">PostgresUUID</span><span class="p">(</span><span class="n">as_uuid</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> 
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>        <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>    <span class="p">)</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span class="n">address_data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>        <span class="n">JSON</span><span class="p">,</span> 
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;address&quot;</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>    <span class="p">)</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>    <span class="n">phone_data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>        <span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> 
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;phone&quot;</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>    <span class="p">)</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>        <span class="n">JSON</span><span class="p">,</span> 
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>        <span class="n">default</span><span class="o">=</span><span class="nb">dict</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>    <span class="p">)</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CustomerModel&quot;</span><span class="p">:</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert domain entity to database model.&quot;&quot;&quot;</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>            <span class="n">name</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>            <span class="n">email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>            <span class="n">address_data</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">customer</span><span class="o">.</span><span class="n">address</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>            <span class="n">phone_data</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">phone</span><span class="p">)</span> <span class="k">if</span> <span class="n">customer</span><span class="o">.</span><span class="n">phone</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>            <span class="n">is_active</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>            <span class="n">created_at</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>        <span class="p">)</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert database model to domain entity.&quot;&quot;&quot;</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>        <span class="n">address</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_data</span><span class="p">:</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>            <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_data</span><span class="p">)</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>        <span class="n">phone</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phone_data</span><span class="p">:</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>            <span class="n">phone</span> <span class="o">=</span> <span class="n">PhoneNumber</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phone_data</span><span class="p">)</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="p">(</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>            <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>            <span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">,</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>            <span class="n">is_active</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>            <span class="n">preferences</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>            <span class="n">created_at</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="presentation-layer-external-interface"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#presentation-layer-external-interface">Presentation Layer: External Interface</a></h3>
<p>The presentation layer handles external communication—HTTP APIs, command-line interfaces, message queues. It depends on inner layers but remains focused on protocol concerns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># src/presentation/api/v1/customers.py</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.application.use_cases.commands.create_customer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="n">CreateCustomerCommand</span><span class="p">,</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>    <span class="n">CreateCustomerUseCase</span><span class="p">,</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="p">)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.application.use_cases.queries.search_customers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="n">SearchCustomersQuery</span><span class="p">,</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="n">SearchCustomersUseCase</span><span class="p">,</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="p">)</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.presentation.schemas.customer_schemas</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="n">CreateCustomerRequest</span><span class="p">,</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>    <span class="n">CustomerResponse</span><span class="p">,</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="p">)</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.presentation.repositories</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_customer_repository</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1/customers&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customers&quot;</span><span class="p">])</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">CustomerResponse</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">CreateCustomerRequest</span><span class="p">,</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>    <span class="n">customer_repo</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">),</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="p">):</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new customer.&quot;&quot;&quot;</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">customer_repo</span><span class="p">)</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>    <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>        <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>        <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>        <span class="n">preferences</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>    <span class="p">)</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>        <span class="k">return</span> <span class="n">CustomerResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>            <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>        <span class="p">)</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">CustomerResponse</span><span class="p">])</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_customers</span><span class="p">(</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>    <span class="n">active_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>    <span class="n">customer_repo</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">),</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a><span class="p">):</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Search customers.&quot;&quot;&quot;</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">SearchCustomersUseCase</span><span class="p">(</span><span class="n">customer_repo</span><span class="p">)</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>    <span class="n">query</span> <span class="o">=</span> <span class="n">SearchCustomersQuery</span><span class="p">(</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>        <span class="n">name_filter</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>        <span class="n">email_filter</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>        <span class="n">active_only</span><span class="o">=</span><span class="n">active_only</span><span class="p">,</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>    <span class="p">)</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>    <span class="n">customers</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">CustomerResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">customers</span><span class="p">]</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">{customer_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">CustomerResponse</span><span class="p">)</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_customer</span><span class="p">(</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>    <span class="n">customer_id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>    <span class="n">customer_repo</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">),</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a><span class="p">):</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get customer by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">customer_repo</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">CustomerId</span><span class="p">(</span><span class="n">customer_id</span><span class="p">))</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">customer</span><span class="p">:</span>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Customer not found&quot;</span><span class="p">,</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>        <span class="p">)</span>
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a>    <span class="k">return</span> <span class="n">CustomerResponse</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
</code></pre></div>
<p>The presentation layer uses DTOs (Data Transfer Objects) to handle external data representation:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># src/presentation/schemas/customer_schemas.py</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request model for creating a customer.&quot;&quot;&quot;</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Customer name&quot;</span><span class="p">)</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Customer email address&quot;</span><span class="p">)</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Customer preferences as key-value pairs&quot;</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="p">)</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Response model for customer data.&quot;&quot;&quot;</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>    <span class="nb">id</span><span class="p">:</span> <span class="n">UUID</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>    <span class="n">preferences</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CustomerResponse&quot;</span><span class="p">:</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert domain entity to response model.&quot;&quot;&quot;</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>            <span class="nb">id</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>            <span class="n">name</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>            <span class="n">email</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>            <span class="n">is_active</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>            <span class="n">preferences</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>            <span class="n">created_at</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>            <span class="n">updated_at</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="dependency-injection-and-wiring"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#dependency-injection-and-wiring">Dependency Injection and Wiring</a></h3>
<p>Clean Architecture requires careful dependency injection. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> shows how to wire dependencies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># src/presentation/repositories.py</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.repositories.customer_repository</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerRepository</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.repositories.customer_repository_impl</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">CustomerRepositoryImpl</span><span class="p">,</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="p">)</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_async_session</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="nd">@lru_cache</span><span class="p">()</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_customer_repository</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">CustomerRepository</span><span class="p">:</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get customer repository instance.&quot;&quot;&quot;</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">get_async_session</span><span class="p">()</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="k">return</span> <span class="n">CustomerRepositoryImpl</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</code></pre></div>
<p>In production systems, you'd use a proper dependency injection container like <code>dependency-injector</code> or <code>punq</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Example with dependency-injector</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dependency_injector</span><span class="w"> </span><span class="kn">import</span> <span class="n">containers</span><span class="p">,</span> <span class="n">providers</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dependency_injector.wiring</span><span class="w"> </span><span class="kn">import</span> <span class="n">Provide</span><span class="p">,</span> <span class="n">inject</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Container</span><span class="p">(</span><span class="n">containers</span><span class="o">.</span><span class="n">DeclarativeContainer</span><span class="p">):</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="c1"># Configuration</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="n">config</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Configuration</span><span class="p">()</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="c1"># Database</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="n">database</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Singleton</span><span class="p">(</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        <span class="n">Database</span><span class="p">,</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="n">db_url</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    <span class="p">)</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>    <span class="c1"># Repositories</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    <span class="n">customer_repository</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="n">CustomerRepositoryImpl</span><span class="p">,</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>        <span class="n">session</span><span class="o">=</span><span class="n">database</span><span class="o">.</span><span class="n">provided</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>    <span class="p">)</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>    <span class="c1"># Use cases</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>    <span class="n">create_customer_use_case</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>        <span class="n">CreateCustomerUseCase</span><span class="p">,</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>        <span class="n">customer_repository</span><span class="o">=</span><span class="n">customer_repository</span><span class="p">,</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>    <span class="p">)</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="nd">@inject</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_customer_endpoint</span><span class="p">(</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>    <span class="n">request</span><span class="p">:</span> <span class="n">CreateCustomerRequest</span><span class="p">,</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>    <span class="n">use_case</span><span class="p">:</span> <span class="n">CreateCustomerUseCase</span> <span class="o">=</span> <span class="n">Provide</span><span class="p">[</span><span class="n">Container</span><span class="o">.</span><span class="n">create_customer_use_case</span><span class="p">],</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="p">):</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create customer endpoint with injected dependencies.&quot;&quot;&quot;</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>    <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>        <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>        <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>        <span class="n">preferences</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">preferences</span><span class="p">,</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>    <span class="p">)</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>    <span class="k">return</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</code></pre></div>
<h3 id="testing-clean-architecture"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#testing-clean-architecture">Testing Clean Architecture</a></h3>
<p>The beauty of Clean Architecture reveals itself in testing. Each layer can be tested independently:</p>
<h4 id="domain-layer-testing"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#domain-layer-testing">Domain Layer Testing</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># tests/unit/domain/test_customer.py</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_customer_creation</span><span class="p">():</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test customer creation with domain events.&quot;&quot;&quot;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">()</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">},</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="p">)</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">is_active</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">get_domain_events</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>    <span class="n">event</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">get_domain_events</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    <span class="k">assert</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_customer_deactivation</span><span class="p">():</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test customer deactivation business rule.&quot;&quot;&quot;</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span> 
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    <span class="p">)</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>    <span class="n">deactivated</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">deactivate</span><span class="p">(</span><span class="s2">&quot;Account closed&quot;</span><span class="p">)</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">deactivated</span><span class="o">.</span><span class="n">is_active</span>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">deactivated</span><span class="o">.</span><span class="n">get_domain_events</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># Created + Deactivated</span>
</code></pre></div>
<h4 id="application-layer-testing"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#application-layer-testing">Application Layer Testing</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># tests/unit/application/test_create_customer.py</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncMock</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.application.use_cases.commands.create_customer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">CreateCustomerCommand</span><span class="p">,</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">CreateCustomerUseCase</span><span class="p">,</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="p">)</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">mock_customer_repository</span><span class="p">():</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="k">return</span> <span class="n">AsyncMock</span><span class="p">()</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer_success</span><span class="p">(</span><span class="n">mock_customer_repository</span><span class="p">):</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test successful customer creation.&quot;&quot;&quot;</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    <span class="c1"># Arrange</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>    <span class="p">)</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">mock_customer_repository</span><span class="p">)</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>    <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>        <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">},</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>    <span class="p">)</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>    <span class="c1"># Act</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>    <span class="c1"># Assert</span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer_duplicate_email</span><span class="p">(</span><span class="n">mock_customer_repository</span><span class="p">):</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test creating customer with duplicate email raises error.&quot;&quot;&quot;</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>    <span class="c1"># Arrange</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>    <span class="n">existing_customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Existing&quot;</span><span class="p">,</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>    <span class="p">)</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>    <span class="n">mock_customer_repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">existing_customer</span>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">mock_customer_repository</span><span class="p">)</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>    <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>        <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>    <span class="p">)</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>    <span class="c1"># Act &amp; Assert</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Customer with email .* already exists&quot;</span><span class="p">):</span>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>        <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</code></pre></div>
<h4 id="integration-testing"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#integration-testing">Integration Testing</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># tests/integration/test_customer_repository.py</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_async_engine</span><span class="p">,</span> <span class="n">async_sessionmaker</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.repositories.customer_repository_impl</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="n">CustomerRepositoryImpl</span><span class="p">,</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="p">)</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">repository</span><span class="p">():</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create repository with in-memory database.&quot;&quot;&quot;</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="s2">&quot;sqlite+aiosqlite:///:memory:&quot;</span><span class="p">)</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">BaseModel</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>    <span class="n">async_session</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>    <span class="n">session</span> <span class="o">=</span> <span class="n">async_session</span><span class="p">()</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>    <span class="k">yield</span> <span class="n">CustomerRepositoryImpl</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>    <span class="k">await</span> <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_save_and_find_customer</span><span class="p">(</span><span class="n">repository</span><span class="p">):</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test saving and finding a customer.&quot;&quot;&quot;</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>    <span class="c1"># Arrange</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>    <span class="p">)</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>    <span class="c1"># Act</span>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>    <span class="n">saved_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>    <span class="n">found_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>
<a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>    <span class="c1"># Assert</span>
<a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>    <span class="k">assert</span> <span class="n">saved_customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>    <span class="k">assert</span> <span class="n">found_customer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>    <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>    <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="benefits-of-clean-architecture"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#benefits-of-clean-architecture">Benefits of Clean Architecture</a></h3>
<p>The investment in Clean Architecture pays dividends:</p>
<h4 id="1-framework-independence"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#1-framework-independence">1. Framework Independence</a></h4>
<p>Your business logic isn't tied to FastAPI, Django, or any framework. Switching from FastAPI to Django only requires changes in the presentation layer:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># Django views using the same use cases</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">JsonResponse</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">django.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">View</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">CreateCustomerView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>        <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">())</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>        <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>            <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>            <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        <span class="p">)</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">CustomerSerializer</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<h4 id="2-database-independence"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#2-database-independence">2. Database Independence</a></h4>
<p>Switching from PostgreSQL to MongoDB only requires implementing new repositories:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># MongoDB repository implementation</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">MongoCustomerRepository</span><span class="p">(</span><span class="n">CustomerRepository</span><span class="p">):</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">):</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="n">document</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>            <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">),</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>            <span class="c1"># ... other fields</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        <span class="p">}</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">replace_one</span><span class="p">(</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>            <span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">id</span><span class="p">)},</span> 
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>            <span class="n">document</span><span class="p">,</span> 
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>            <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>        <span class="p">)</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="k">return</span> <span class="n">customer</span>
</code></pre></div>
<h4 id="3-testability"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#3-testability">3. Testability</a></h4>
<p>Business logic can be tested without external dependencies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_complex_business_rule</span><span class="p">():</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test complex business logic in isolation.&quot;&quot;&quot;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="c1"># No database, no HTTP, no external services required</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>        <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(),</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>        <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    <span class="p">)</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="c1"># Test business rules directly</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">can_place_order</span><span class="p">()</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">calculate_loyalty_discount</span><span class="p">()</span> <span class="o">==</span> <span class="n">Money</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<h4 id="4-multiple-interfaces"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#4-multiple-interfaces">4. Multiple Interfaces</a></h4>
<p>The same business logic can support multiple interfaces:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># REST API</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/customers&quot;</span><span class="p">)</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer_rest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">CreateCustomerRequest</span><span class="p">):</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">())</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CreateCustomerCommand</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="c1"># GraphQL API  </span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer_graphql</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">())</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CreateCustomerCommand</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="c1"># CLI Command</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--name&#39;</span><span class="p">)</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--email&#39;</span><span class="p">)</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_customer_cli</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>    <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">get_customer_repository</span><span class="p">())</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CreateCustomerCommand</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">))</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created customer: </span><span class="si">{</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="common-pitfalls-and-solutions"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#common-pitfalls-and-solutions">Common Pitfalls and Solutions</a></h3>
<h4 id="1-over-engineering-simple-applications"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#1-over-engineering-simple-applications">1. Over-Engineering Simple Applications</a></h4>
<p>Not every application needs Clean Architecture. For simple CRUD applications, it might be overkill. Use it when:</p>
<ul>
<li>Business logic is complex</li>
<li>Multiple teams work on the codebase</li>
<li>You need to support multiple interfaces</li>
<li>The application will evolve significantly over time</li>
</ul>
<h4 id="2-leaky-abstractions"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#2-leaky-abstractions">2. Leaky Abstractions</a></h4>
<p>Domain entities shouldn't know about infrastructure concerns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># Bad - domain entity knowing about HTTP</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">:</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># ❌ HTTP concern in domain</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="c1"># Good - infrastructure handles serialization</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerResponse</span><span class="p">:</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_domain</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">customer</span><span class="p">:</span> <span class="n">Customer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CustomerResponse&quot;</span><span class="p">:</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<h4 id="3-anemic-domain-models"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#3-anemic-domain-models">3. Anemic Domain Models</a></h4>
<p>Don't create entities that are just data containers:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># Bad - anemic model</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">:</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerService</span><span class="p">:</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">):</span>  <span class="c1"># ❌ Logic outside entity</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name required&quot;</span><span class="p">)</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="c1"># Good - rich domain model</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">:</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>  <span class="c1"># ✅ Validation in entity</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name required&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#conclusion">Conclusion</a></h3>
<p>Clean Architecture isn't about following rules blindly—it's about creating software that reflects your business domain clearly and remains adaptable to change. By organizing code into concentric circles with dependencies pointing inward, you create applications that are testable, maintainable, and independent of technical details.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates these principles in practice, showing how Python's features support Clean Architecture naturally. The key is starting with your business logic and building outward, not starting with the database or framework and working in.</p>
<p>In the next post, we'll dive deep into Value Objects—those small but powerful classes that make your domain model more expressive and your code more reliable. We'll see how they eliminate primitive obsession and create type-safe domain boundaries.</p>
<h3 id="references"><a class="toclink" href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/#references">References</a></h3>
<ul>
<li><a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Clean Architecture Book</a> - Uncle Bob's original Clean Architecture concept</li>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete Clean Architecture implementation</li>
<li><a href="https://martinfowler.com/bliki/DomainDrivenDesign.html">Domain-Driven Design</a> - Martin Fowler's DDD overview</li>
<li><a href="https://alistair.cockburn.us/hexagonal-architecture/">Hexagonal Architecture</a> - Alistair Cockburn's original concept</li>
</ul>
<p>Remember: Clean Architecture isn't about complexity—it's about managing complexity in the right places.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-05-22 19:15:00-04:00">May 22, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Clean Architecture</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="../software-design/" class="md-meta__link">Software Design</a></li>
        
        
          
          <li class="md-meta__item">
            
              6 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="from-script-to-architecture-why-your-python-project-needs-structure"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/">From Script to Architecture: Why Your Python Project Needs Structure</a></h2>
<p>Every Python developer has been there. You start with a simple script to solve a problem. Maybe it's processing some data, automating a task, or building a quick API endpoint. The script grows. Features get added. Before you know it, you're staring at a 2,000-line file that nobody wants to touch, let alone understand.</p>
<p>I've witnessed this organic growth countless times in production systems. What starts as <code>app.py</code> becomes a tangled web of functions, global variables, and copy-pasted code blocks. The cost of adding new features skyrockets. Bugs become harder to track. Testing? Nearly impossible without running the entire application.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates how to avoid this trap from day one. It's not about over-engineering; it's about sustainable development practices that scale with your needs.</p>
<h3 id="the-real-cost-of-unstructured-code"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#the-real-cost-of-unstructured-code">The Real Cost of Unstructured Code</a></h3>
<p>Let me share a story from a recent consulting engagement. A startup had built their entire e-commerce platform in three Python files: <code>main.py</code>, <code>database.py</code>, and <code>utils.py</code>. The <code>main.py</code> alone was over 5,000 lines. Every developer on the team had a different understanding of how the system worked. Deployment was a prayer. Testing was manual.</p>
<p>When they needed to add a new payment provider, what should have been a two-day task turned into a three-week nightmare. The payment logic was scattered across all three files. Database transactions weren't properly managed. Error handling was inconsistent. The team eventually had to freeze feature development for two months to refactor the codebase.</p>
<p>This scenario plays out in companies every day. The hidden costs include:</p>
<ul>
<li><strong>Developer velocity decline</strong>: New features take exponentially longer to implement</li>
<li><strong>Knowledge silos</strong>: Only certain developers understand certain parts of the code</li>
<li><strong>Bug multiplication</strong>: Fixes in one area break functionality elsewhere</li>
<li><strong>Onboarding nightmare</strong>: New team members take months to become productive</li>
<li><strong>Testing impossibility</strong>: Automated testing becomes a pipe dream</li>
</ul>
<h3 id="recognizing-the-warning-signs"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#recognizing-the-warning-signs">Recognizing the Warning Signs</a></h3>
<p>Your Python project needs architectural attention when you notice these symptoms:</p>
<p><strong>Code Smells:</strong>
- Functions with more than 50 lines becoming common
- Global variables used for configuration and state
- Circular imports forcing creative import strategies
- Business logic mixed with database queries and API handlers
- Copy-pasted code blocks with slight variations
- Comments like "Don't touch this - it works somehow"</p>
<p><strong>Development Pain Points:</strong>
- Fear of refactoring because you might break something
- Merge conflicts on every pull request
- Inability to work on features in parallel
- Testing requires the entire application environment
- Debugging involves print statements throughout the code</p>
<p><strong>Operational Issues:</strong>
- Deployments require careful coordination
- Rolling back changes is risky or impossible
- Performance problems are hard to isolate
- Monitoring and logging are afterthoughts</p>
<h3 id="the-journey-from-script-to-architecture"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#the-journey-from-script-to-architecture">The Journey from Script to Architecture</a></h3>
<p>The transformation doesn't happen overnight, but it follows a predictable path. Here's how a typical Python project evolves, using our e-commerce platform as an example:</p>
<h4 id="stage-1-the-monolithic-script"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#stage-1-the-monolithic-script">Stage 1: The Monolithic Script</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># app.py - Everything in one place</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;shop.db&#39;</span><span class="p">)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">)</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">():</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM products WHERE active = 1&quot;</span><span class="p">)</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="n">products</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/order&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">():</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="c1"># 200 lines of order processing logic here</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="c1"># Including payment processing, inventory updates, emails...</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>This works for a prototype, but it's already showing problems. Database connections aren't managed properly. Business logic is mixed with HTTP handling. There's no separation of concerns.</p>
<h4 id="stage-2-basic-separation"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#stage-2-basic-separation">Stage 2: Basic Separation</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># models.py</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="c1"># database.py</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">Database</span><span class="p">:</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;shop.db&#39;</span><span class="p">)</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM products WHERE active = 1&quot;</span><span class="p">)</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="c1"># app.py</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Product</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">()</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/products&#39;</span><span class="p">)</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">():</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>    <span class="n">products</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_products</span><span class="p">()</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>
</code></pre></div>
<p>Better, but still problematic. The database layer knows about SQL. The models are anemic. The application layer is tightly coupled to Flask.</p>
<h4 id="stage-3-clean-architecture-introduction"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#stage-3-clean-architecture-introduction">Stage 3: Clean Architecture Introduction</a></h4>
<p>This is where the real transformation begins. Look at how the <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> structures the same functionality:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># src/domain/entities/product.py</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nd">@dataclass</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">:</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="n">price</span><span class="p">:</span> <span class="n">Money</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="n">inventory_count</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">can_purchase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Business rule: Can we purchase this quantity?&quot;&quot;&quot;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_count</span> <span class="o">&gt;=</span> <span class="n">quantity</span> <span class="ow">and</span> <span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Money</span><span class="p">:</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Business logic for price calculation&quot;&quot;&quot;</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_purchase</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot purchase </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> items&quot;</span><span class="p">)</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">quantity</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="c1"># src/domain/repositories/product_repository.py</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProductRepository</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>        <span class="k">pass</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_products</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="k">pass</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="c1"># src/application/use_cases/get_products.py</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a><span class="k">class</span><span class="w"> </span><span class="nc">GetProductsUseCase</span><span class="p">:</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product_repo</span><span class="p">:</span> <span class="n">ProductRepository</span><span class="p">):</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">product_repo</span> <span class="o">=</span> <span class="n">product_repo</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ProductDTO</span><span class="p">]:</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>        <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">product_repo</span><span class="o">.</span><span class="n">get_active_products</span><span class="p">()</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">ProductDTO</span><span class="o">.</span><span class="n">from_domain</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">]</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a><span class="c1"># src/infrastructure/database/product_repository_impl.py</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a><span class="k">class</span><span class="w"> </span><span class="nc">ProductRepositoryImpl</span><span class="p">(</span><span class="n">ProductRepository</span><span class="p">):</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">):</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_active_products</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>            <span class="n">select</span><span class="p">(</span><span class="n">ProductModel</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ProductModel</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>        <span class="p">)</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">to_domain</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()]</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a><span class="c1"># src/presentation/api/products.py</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a><span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/products&quot;</span><span class="p">)</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_products</span><span class="p">(</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>    <span class="n">use_case</span><span class="p">:</span> <span class="n">GetProductsUseCase</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_products_use_case</span><span class="p">)</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a><span class="p">):</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>    <span class="n">products</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>    <span class="k">return</span> <span class="n">products</span>
</code></pre></div>
<p>Notice the dramatic differences:
- <strong>Domain layer</strong> contains business rules and entities
- <strong>Application layer</strong> orchestrates use cases
- <strong>Infrastructure layer</strong> handles technical details
- <strong>Presentation layer</strong> manages HTTP concerns
- Each layer has clear responsibilities and boundaries</p>
<h3 id="benefits-of-structured-architecture"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#benefits-of-structured-architecture">Benefits of Structured Architecture</a></h3>
<p>The investment in architecture pays dividends immediately:</p>
<h4 id="1-testability"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#1-testability">1. Testability</a></h4>
<p>Each layer can be tested in isolation. Domain logic doesn't need a database. Use cases can be tested with mock repositories. This leads to fast, reliable test suites.</p>
<h4 id="2-maintainability"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#2-maintainability">2. Maintainability</a></h4>
<p>When a bug report comes in, you know exactly where to look. Payment issue? Check the payment use case. Database problem? It's isolated to the repository layer.</p>
<h4 id="3-flexibility"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#3-flexibility">3. Flexibility</a></h4>
<p>Need to switch from PostgreSQL to MongoDB? Only the infrastructure layer changes. Want to add a GraphQL API alongside REST? Add it to the presentation layer without touching business logic.</p>
<h4 id="4-team-scalability"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#4-team-scalability">4. Team Scalability</a></h4>
<p>New developers can work on specific layers without understanding the entire system. Frontend developers focus on the presentation layer. Database experts optimize the infrastructure layer. Domain experts refine business rules.</p>
<h4 id="5-performance-optimization"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#5-performance-optimization">5. Performance Optimization</a></h4>
<p>With clear boundaries, performance bottlenecks are easier to identify and fix. You can cache at the appropriate layer, optimize database queries without touching business logic, and add async processing where it makes sense.</p>
<h3 id="the-path-forward"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#the-path-forward">The Path Forward</a></h3>
<p>Transitioning from script to architecture doesn't mean throwing away your existing code. It's about gradually introducing structure:</p>
<ol>
<li><strong>Start with the domain</strong>: Identify your core business entities and rules</li>
<li><strong>Extract use cases</strong>: Move business workflows into dedicated classes</li>
<li><strong>Abstract infrastructure</strong>: Hide database and external service details behind interfaces</li>
<li><strong>Separate presentation</strong>: Keep HTTP/API concerns in their own layer</li>
<li><strong>Add tests</strong>: Each refactoring step should be backed by tests</li>
</ol>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> provides a complete example of this architecture in action. It demonstrates patterns that work in production, from simple CRUD operations to complex business workflows.</p>
<h3 id="conclusion"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#conclusion">Conclusion</a></h3>
<p>The evolution from script to architecture is a journey every successful Python project must take. The question isn't whether you need structure, but when you'll introduce it. Starting with good architecture from day one isn't over-engineering; it's professional software development.</p>
<p>In the next post, we'll dive deep into setting up a Python project with modern tooling, going beyond simple requirements.txt files to create a professional development environment that supports your architectural goals.</p>
<p>Remember: Architecture isn't about complexity. It's about managing complexity. Your future self, your team, and your users will thank you for the investment.</p>
<h3 id="references-and-further-reading"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#references-and-further-reading">References and Further Reading</a></h3>
<h4 id="project-repository"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#project-repository">Project Repository</a></h4>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete implementation of Clean Architecture in Python</li>
<li><a href="https://github.com/buildshift-dev/clean-py/tree/main/docs">Project Documentation</a> - Detailed patterns and guides</li>
</ul>
<h4 id="books-and-articles"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#books-and-articles">Books and Articles</a></h4>
<ul>
<li><a href="https://www.amazon.com/Clean-Architecture-Craftsmans-Software-Structure/dp/0134494164">Clean Architecture by Robert C. Martin</a> - The definitive guide to Clean Architecture</li>
<li><a href="https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215">Domain-Driven Design by Eric Evans</a> - Essential reading for understanding domain modeling</li>
<li><a href="https://www.cosmicpython.com/">Architecture Patterns with Python</a> - Free online book on Python architecture patterns</li>
</ul>
<h4 id="python-resources"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#python-resources">Python Resources</a></h4>
<ul>
<li><a href="https://peps.python.org/pep-0008/">PEP 8 - Style Guide for Python Code</a> - Python coding conventions</li>
<li><a href="https://realpython.com/python-application-layouts/">Real Python - Application Layouts</a> - Guide to Python project structures</li>
<li><a href="https://packaging.python.org/">Python Packaging Guide</a> - Official Python packaging documentation</li>
</ul>
<h4 id="related-blog-posts-in-this-series"><a class="toclink" href="../../2025/05/22/from-script-to-architecture---why-your-python-project-needs-structure/#related-blog-posts-in-this-series">Related Blog Posts in This Series</a></h4>
<ul>
<li><a href="../../2025/05/25/setting-up-a-python-project-like-a-pro---beyond-requirementstxt/">Setting Up a Python Project Like a Pro</a> - Modern Python project setup</li>
<li><a href="../../2025/06/02/domain-driven-design-in-python---more-than-just-folders/">Domain-Driven Design in Python</a> - DDD patterns in Python</li>
<li><a href="../../2025/06/08/clean-architecture-in-python---keeping-your-business-logic-pure/">Clean Architecture in Python</a> - Implementing Clean Architecture</li>
</ul>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 buildshift.dev
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/buildshift-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/your-profile" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/your-handle" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:contact@buildshift.dev" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l208 156a48 48 0 0 0 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 196v188c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V196L313.6 344.8c-34.1 25.6-81.1 25.6-115.2 0z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.path", "navigation.top", "search.highlight", "search.share", "search.suggest", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../assets/js/buildshift.js"></script>
      
    
  </body>
</html>