
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Full Stack Developer specializing in AWS Serverless, Python, and modern development workflows">
      
      
        <meta name="author" content="buildshift.dev">
      
      
        <link rel="canonical" href="https://buildshift.dev/blog/category/testing/">
      
      
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/images/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Testing - buildshift.dev</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/css/buildshift.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-4SV8ZKYLT1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-4SV8ZKYLT1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-4SV8ZKYLT1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Fixed banner styling -->
  <style>
    body { padding-top: 40px !important; }
    .md-header { top: 40px !important; }
    .md-tabs { top: 40px !important; }
  </style>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
  <!-- Under Construction Announcement -->
  <div style="background: #000000; text-align: center; padding: 8px 0; position: fixed; top: 0; left: 0; right: 0; z-index: 9999; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 14px; font-weight: 500; color: #ffa500;">
      <i class="fas fa-hard-hat"></i>
      <span>...Under Construction...</span>
    </div>
  </div>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="buildshift.dev" class="md-header__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            buildshift.dev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Testing
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link">
        
  
  
    
  
  buildshift.dev Blog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="buildshift.dev" class="md-nav__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    buildshift.dev
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    buildshift.dev Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="testing">Testing</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-06-26 19:40:00-04:00">Jun 26, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Testing</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="../microservices/" class="md-meta__link">Microservices</a></li>
        
        
          
          <li class="md-meta__item">
            
              16 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="testing-strategy-for-python-microservices-building-confidence-through-systematic-testing"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/">Testing Strategy for Python Microservices: Building Confidence Through Systematic Testing</a></h2>
<p>Testing microservices isn't just about writing tests—it's about building systems you can trust. I've debugged too many production incidents that could have been prevented by the right testing strategy. A missing edge case in a payment processor. A race condition in an order system. An integration failure that brought down the entire checkout flow.</p>
<p>The difference between brittle and robust microservices isn't the absence of bugs—it's having the confidence to catch them before they reach production. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates a comprehensive testing strategy that builds this confidence through systematic testing at multiple levels.</p>
<h3 id="the-testing-pyramid-for-microservices"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#the-testing-pyramid-for-microservices">The Testing Pyramid for Microservices</a></h3>
<p>Traditional testing pyramids don't fully capture the complexity of microservices. You need a strategy that addresses the unique challenges: distributed systems, eventual consistency, external dependencies, and deployment complexity.</p>
<p>Here's a refined pyramid for microservices:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>                    ▲
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>                 E2E Tests
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>               (Expensive, Slow)
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>              ┌─────────────────┐
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>             │  Contract Tests  │
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>            ┌─────────────────────┐
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>           │ Integration Tests    │
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>          ┌───────────────────────────┐
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>         │     Component Tests       │
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>        ┌─────────────────────────────────┐
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>       │        Unit Tests               │
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>      └─────────────────────────────────────┘
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>           (Cheap, Fast, Many)
</code></pre></div>
<p>Each level serves a distinct purpose and catches different classes of errors.</p>
<h3 id="unit-tests-domain-logic-verification"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#unit-tests-domain-logic-verification">Unit Tests: Domain Logic Verification</a></h3>
<p>Unit tests verify your business logic in isolation. With Clean Architecture, your domain layer has no external dependencies, making it naturally testable.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates comprehensive unit testing:</p>
<h4 id="testing-value-objects"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#testing-value-objects">Testing Value Objects</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c1"># tests/unit/shared_kernel/test_value_objects.py</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestEmail</span><span class="p">:</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test cases for Email value object.&quot;&quot;&quot;</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_valid_email_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating a valid email.&quot;&quot;&quot;</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;test@example.com&quot;</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">domain</span> <span class="o">==</span> <span class="s2">&quot;example.com&quot;</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>        <span class="k">assert</span> <span class="n">email</span><span class="o">.</span><span class="n">local_part</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;test@example.com&quot;</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_email_format_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that invalid email format raises ValueError.&quot;&quot;&quot;</span>
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">):</span>
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;invalid-email&quot;</span><span class="p">)</span>
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">):</span>
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@&quot;</span><span class="p">)</span>
<a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>
<a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid email format&quot;</span><span class="p">):</span>
<a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a>
<a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_empty_email_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that empty email raises ValueError.&quot;&quot;&quot;</span>
<a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Email cannot be empty&quot;</span><span class="p">):</span>
<a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a>            <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a>
<a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestMoney</span><span class="p">:</span>
<a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test cases for Money value object.&quot;&quot;&quot;</span>
<a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a>
<a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_valid_money_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating valid money.&quot;&quot;&quot;</span>
<a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a>        <span class="n">money</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.50&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a>        <span class="k">assert</span> <span class="n">money</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.50&quot;</span><span class="p">)</span>
<a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a>        <span class="k">assert</span> <span class="n">money</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;USD&quot;</span>
<a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a>        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">money</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;100.50 USD&quot;</span>
<a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a>
<a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_negative_amount_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that negative amount raises ValueError.&quot;&quot;&quot;</span>
<a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Amount cannot be negative&quot;</span><span class="p">):</span>
<a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a>            <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;-10.00&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a>
<a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_money_addition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test adding money with same currency.&quot;&quot;&quot;</span>
<a id="__codelineno-43-46" name="__codelineno-43-46" href="#__codelineno-43-46"></a>        <span class="n">money1</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-43-47" name="__codelineno-43-47" href="#__codelineno-43-47"></a>        <span class="n">money2</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-43-48" name="__codelineno-43-48" href="#__codelineno-43-48"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">money1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">money2</span><span class="p">)</span>
<a id="__codelineno-43-49" name="__codelineno-43-49" href="#__codelineno-43-49"></a>
<a id="__codelineno-43-50" name="__codelineno-43-50" href="#__codelineno-43-50"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">amount</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;150.00&quot;</span><span class="p">)</span>
<a id="__codelineno-43-51" name="__codelineno-43-51" href="#__codelineno-43-51"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="s2">&quot;USD&quot;</span>
<a id="__codelineno-43-52" name="__codelineno-43-52" href="#__codelineno-43-52"></a>
<a id="__codelineno-43-53" name="__codelineno-43-53" href="#__codelineno-43-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_money_addition_different_currency_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-43-54" name="__codelineno-43-54" href="#__codelineno-43-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that adding different currencies raises ValueError.&quot;&quot;&quot;</span>
<a id="__codelineno-43-55" name="__codelineno-43-55" href="#__codelineno-43-55"></a>        <span class="n">money1</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;100.00&quot;</span><span class="p">),</span> <span class="s2">&quot;USD&quot;</span><span class="p">)</span>
<a id="__codelineno-43-56" name="__codelineno-43-56" href="#__codelineno-43-56"></a>        <span class="n">money2</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;50.00&quot;</span><span class="p">),</span> <span class="s2">&quot;EUR&quot;</span><span class="p">)</span>
<a id="__codelineno-43-57" name="__codelineno-43-57" href="#__codelineno-43-57"></a>
<a id="__codelineno-43-58" name="__codelineno-43-58" href="#__codelineno-43-58"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Cannot add different currencies&quot;</span><span class="p">):</span>
<a id="__codelineno-43-59" name="__codelineno-43-59" href="#__codelineno-43-59"></a>            <span class="n">money1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">money2</span><span class="p">)</span>
</code></pre></div>
<h4 id="testing-domain-entities"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#testing-domain-entities">Testing Domain Entities</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c1"># tests/unit/domain/test_customer.py</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomer</span><span class="p">:</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_customer_creation_with_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating a customer using the factory method.&quot;&quot;&quot;</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>            <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">},</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>        <span class="p">)</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>        <span class="c1"># Check domain events</span>
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">collect_domain_events</span><span class="p">()</span>
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">CustomerCreated</span><span class="p">)</span>
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">customer_name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a>
<a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_customer_deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test customer deactivation business rule.&quot;&quot;&quot;</span>
<a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a>
<a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a>
<a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a>        <span class="c1"># Clear the creation event for cleaner testing</span>
<a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a>        <span class="n">customer</span><span class="o">.</span><span class="n">collect_domain_events</span><span class="p">()</span>
<a id="__codelineno-44-37" name="__codelineno-44-37" href="#__codelineno-44-37"></a>
<a id="__codelineno-44-38" name="__codelineno-44-38" href="#__codelineno-44-38"></a>        <span class="n">deactivated</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">deactivate</span><span class="p">(</span><span class="s2">&quot;Business closure&quot;</span><span class="p">)</span>
<a id="__codelineno-44-39" name="__codelineno-44-39" href="#__codelineno-44-39"></a>
<a id="__codelineno-44-40" name="__codelineno-44-40" href="#__codelineno-44-40"></a>        <span class="c1"># Original customer unchanged (immutable)</span>
<a id="__codelineno-44-41" name="__codelineno-44-41" href="#__codelineno-44-41"></a>        <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-44-42" name="__codelineno-44-42" href="#__codelineno-44-42"></a>
<a id="__codelineno-44-43" name="__codelineno-44-43" href="#__codelineno-44-43"></a>        <span class="c1"># New customer is deactivated</span>
<a id="__codelineno-44-44" name="__codelineno-44-44" href="#__codelineno-44-44"></a>        <span class="k">assert</span> <span class="n">deactivated</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">False</span>
<a id="__codelineno-44-45" name="__codelineno-44-45" href="#__codelineno-44-45"></a>        <span class="k">assert</span> <span class="n">deactivated</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-44-46" name="__codelineno-44-46" href="#__codelineno-44-46"></a>        <span class="k">assert</span> <span class="n">deactivated</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">customer</span><span class="o">.</span><span class="n">email</span>
<a id="__codelineno-44-47" name="__codelineno-44-47" href="#__codelineno-44-47"></a>        <span class="k">assert</span> <span class="n">deactivated</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">&gt;</span> <span class="n">customer</span><span class="o">.</span><span class="n">updated_at</span>
<a id="__codelineno-44-48" name="__codelineno-44-48" href="#__codelineno-44-48"></a>
<a id="__codelineno-44-49" name="__codelineno-44-49" href="#__codelineno-44-49"></a>        <span class="c1"># Check domain events</span>
<a id="__codelineno-44-50" name="__codelineno-44-50" href="#__codelineno-44-50"></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">deactivated</span><span class="o">.</span><span class="n">collect_domain_events</span><span class="p">()</span>
<a id="__codelineno-44-51" name="__codelineno-44-51" href="#__codelineno-44-51"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<a id="__codelineno-44-52" name="__codelineno-44-52" href="#__codelineno-44-52"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">CustomerDeactivated</span><span class="p">)</span>
<a id="__codelineno-44-53" name="__codelineno-44-53" href="#__codelineno-44-53"></a>        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-44-54" name="__codelineno-44-54" href="#__codelineno-44-54"></a>        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;Business closure&quot;</span>
<a id="__codelineno-44-55" name="__codelineno-44-55" href="#__codelineno-44-55"></a>
<a id="__codelineno-44-56" name="__codelineno-44-56" href="#__codelineno-44-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_customer_deactivate_already_inactive_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-44-57" name="__codelineno-44-57" href="#__codelineno-44-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that deactivating an inactive customer raises error.&quot;&quot;&quot;</span>
<a id="__codelineno-44-58" name="__codelineno-44-58" href="#__codelineno-44-58"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-44-59" name="__codelineno-44-59" href="#__codelineno-44-59"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-44-60" name="__codelineno-44-60" href="#__codelineno-44-60"></a>
<a id="__codelineno-44-61" name="__codelineno-44-61" href="#__codelineno-44-61"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-44-62" name="__codelineno-44-62" href="#__codelineno-44-62"></a>        <span class="n">deactivated</span> <span class="o">=</span> <span class="n">customer</span><span class="o">.</span><span class="n">deactivate</span><span class="p">(</span><span class="s2">&quot;Manual deactivation&quot;</span><span class="p">)</span>
<a id="__codelineno-44-63" name="__codelineno-44-63" href="#__codelineno-44-63"></a>
<a id="__codelineno-44-64" name="__codelineno-44-64" href="#__codelineno-44-64"></a>        <span class="c1"># Try to deactivate again should raise error</span>
<a id="__codelineno-44-65" name="__codelineno-44-65" href="#__codelineno-44-65"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;already deactivated&quot;</span><span class="p">):</span>
<a id="__codelineno-44-66" name="__codelineno-44-66" href="#__codelineno-44-66"></a>            <span class="n">deactivated</span><span class="o">.</span><span class="n">deactivate</span><span class="p">(</span><span class="s2">&quot;Test reason&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="testing-use-cases-with-mocks"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#testing-use-cases-with-mocks">Testing Use Cases with Mocks</a></h4>
<p>Application layer tests verify orchestration logic without external dependencies:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1"># tests/unit/application/commands/test_create_customer.py</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCreateCustomerUseCase</span><span class="p">:</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test successful customer creation.&quot;&quot;&quot;</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>        <span class="c1"># Mock repository</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>        <span class="n">mock_repo</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">()</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No existing customer</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span>  <span class="c1"># Return saved customer</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a>        <span class="c1"># Create use case</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a>        <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">mock_repo</span><span class="p">)</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>        <span class="c1"># Execute command</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a>        <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span> 
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a>            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span> 
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a>            <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a>        <span class="p">)</span>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a>
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a>
<a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a>        <span class="c1"># Assertions</span>
<a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a>        <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;john@example.com&quot;</span>
<a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">preferences</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a>
<a id="__codelineno-45-29" name="__codelineno-45-29" href="#__codelineno-45-29"></a>        <span class="c1"># Verify repository interactions</span>
<a id="__codelineno-45-30" name="__codelineno-45-30" href="#__codelineno-45-30"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-45-31" name="__codelineno-45-31" href="#__codelineno-45-31"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-45-32" name="__codelineno-45-32" href="#__codelineno-45-32"></a>
<a id="__codelineno-45-33" name="__codelineno-45-33" href="#__codelineno-45-33"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-45-34" name="__codelineno-45-34" href="#__codelineno-45-34"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test customer creation with duplicate email.&quot;&quot;&quot;</span>
<a id="__codelineno-45-35" name="__codelineno-45-35" href="#__codelineno-45-35"></a>        <span class="c1"># Mock repository with existing customer</span>
<a id="__codelineno-45-36" name="__codelineno-45-36" href="#__codelineno-45-36"></a>        <span class="n">existing_customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-45-37" name="__codelineno-45-37" href="#__codelineno-45-37"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-45-38" name="__codelineno-45-38" href="#__codelineno-45-38"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Existing User&quot;</span><span class="p">,</span>
<a id="__codelineno-45-39" name="__codelineno-45-39" href="#__codelineno-45-39"></a>            <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-45-40" name="__codelineno-45-40" href="#__codelineno-45-40"></a>            <span class="n">preferences</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-45-41" name="__codelineno-45-41" href="#__codelineno-45-41"></a>        <span class="p">)</span>
<a id="__codelineno-45-42" name="__codelineno-45-42" href="#__codelineno-45-42"></a>
<a id="__codelineno-45-43" name="__codelineno-45-43" href="#__codelineno-45-43"></a>        <span class="n">mock_repo</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">()</span>
<a id="__codelineno-45-44" name="__codelineno-45-44" href="#__codelineno-45-44"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">existing_customer</span>
<a id="__codelineno-45-45" name="__codelineno-45-45" href="#__codelineno-45-45"></a>
<a id="__codelineno-45-46" name="__codelineno-45-46" href="#__codelineno-45-46"></a>        <span class="c1"># Create use case</span>
<a id="__codelineno-45-47" name="__codelineno-45-47" href="#__codelineno-45-47"></a>        <span class="n">use_case</span> <span class="o">=</span> <span class="n">CreateCustomerUseCase</span><span class="p">(</span><span class="n">mock_repo</span><span class="p">)</span>
<a id="__codelineno-45-48" name="__codelineno-45-48" href="#__codelineno-45-48"></a>
<a id="__codelineno-45-49" name="__codelineno-45-49" href="#__codelineno-45-49"></a>        <span class="c1"># Execute command and expect error</span>
<a id="__codelineno-45-50" name="__codelineno-45-50" href="#__codelineno-45-50"></a>        <span class="n">command</span> <span class="o">=</span> <span class="n">CreateCustomerCommand</span><span class="p">(</span>
<a id="__codelineno-45-51" name="__codelineno-45-51" href="#__codelineno-45-51"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span> 
<a id="__codelineno-45-52" name="__codelineno-45-52" href="#__codelineno-45-52"></a>            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span> 
<a id="__codelineno-45-53" name="__codelineno-45-53" href="#__codelineno-45-53"></a>            <span class="n">preferences</span><span class="o">=</span><span class="p">{}</span>
<a id="__codelineno-45-54" name="__codelineno-45-54" href="#__codelineno-45-54"></a>        <span class="p">)</span>
<a id="__codelineno-45-55" name="__codelineno-45-55" href="#__codelineno-45-55"></a>
<a id="__codelineno-45-56" name="__codelineno-45-56" href="#__codelineno-45-56"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;already exists&quot;</span><span class="p">):</span>
<a id="__codelineno-45-57" name="__codelineno-45-57" href="#__codelineno-45-57"></a>            <span class="k">await</span> <span class="n">use_case</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<a id="__codelineno-45-58" name="__codelineno-45-58" href="#__codelineno-45-58"></a>
<a id="__codelineno-45-59" name="__codelineno-45-59" href="#__codelineno-45-59"></a>        <span class="c1"># Verify repository called but save was not</span>
<a id="__codelineno-45-60" name="__codelineno-45-60" href="#__codelineno-45-60"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-45-61" name="__codelineno-45-61" href="#__codelineno-45-61"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>
<h3 id="component-tests-service-level-integration"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#component-tests-service-level-integration">Component Tests: Service-Level Integration</a></h3>
<p>Component tests verify that your service works as a whole, but with external dependencies mocked or stubbed. They test the integration between layers within your service.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1"># tests/component/test_customer_service_component.py</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncMock</span><span class="p">,</span> <span class="n">patch</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.presentation.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomerServiceComponent</span><span class="p">:</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Component tests for customer service functionality.&quot;&quot;&quot;</span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up test client and mocks.&quot;&quot;&quot;</span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a>    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.presentation.repositories.get_customer_repository&#39;</span><span class="p">)</span>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer_endpoint_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_repo_factory</span><span class="p">):</span>
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test customer creation through HTTP endpoint.&quot;&quot;&quot;</span>
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a>        <span class="c1"># Mock repository</span>
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a>        <span class="n">mock_repo</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">()</span>
<a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span>
<a id="__codelineno-46-24" name="__codelineno-46-24" href="#__codelineno-46-24"></a>        <span class="n">mock_repo_factory</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_repo</span>
<a id="__codelineno-46-25" name="__codelineno-46-25" href="#__codelineno-46-25"></a>
<a id="__codelineno-46-26" name="__codelineno-46-26" href="#__codelineno-46-26"></a>        <span class="c1"># Make request</span>
<a id="__codelineno-46-27" name="__codelineno-46-27" href="#__codelineno-46-27"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-46-28" name="__codelineno-46-28" href="#__codelineno-46-28"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-46-29" name="__codelineno-46-29" href="#__codelineno-46-29"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-46-30" name="__codelineno-46-30" href="#__codelineno-46-30"></a>            <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-46-31" name="__codelineno-46-31" href="#__codelineno-46-31"></a>        <span class="p">})</span>
<a id="__codelineno-46-32" name="__codelineno-46-32" href="#__codelineno-46-32"></a>
<a id="__codelineno-46-33" name="__codelineno-46-33" href="#__codelineno-46-33"></a>        <span class="c1"># Verify response</span>
<a id="__codelineno-46-34" name="__codelineno-46-34" href="#__codelineno-46-34"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<a id="__codelineno-46-35" name="__codelineno-46-35" href="#__codelineno-46-35"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-46-36" name="__codelineno-46-36" href="#__codelineno-46-36"></a>        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-46-37" name="__codelineno-46-37" href="#__codelineno-46-37"></a>        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;john@example.com&quot;</span>
<a id="__codelineno-46-38" name="__codelineno-46-38" href="#__codelineno-46-38"></a>        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_active&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-46-39" name="__codelineno-46-39" href="#__codelineno-46-39"></a>        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-46-40" name="__codelineno-46-40" href="#__codelineno-46-40"></a>
<a id="__codelineno-46-41" name="__codelineno-46-41" href="#__codelineno-46-41"></a>        <span class="c1"># Verify repository interaction</span>
<a id="__codelineno-46-42" name="__codelineno-46-42" href="#__codelineno-46-42"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-46-43" name="__codelineno-46-43" href="#__codelineno-46-43"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<a id="__codelineno-46-44" name="__codelineno-46-44" href="#__codelineno-46-44"></a>
<a id="__codelineno-46-45" name="__codelineno-46-45" href="#__codelineno-46-45"></a>    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.presentation.repositories.get_customer_repository&#39;</span><span class="p">)</span>
<a id="__codelineno-46-46" name="__codelineno-46-46" href="#__codelineno-46-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer_duplicate_email_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_repo_factory</span><span class="p">):</span>
<a id="__codelineno-46-47" name="__codelineno-46-47" href="#__codelineno-46-47"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test customer creation with duplicate email returns error.&quot;&quot;&quot;</span>
<a id="__codelineno-46-48" name="__codelineno-46-48" href="#__codelineno-46-48"></a>        <span class="c1"># Mock repository with existing customer</span>
<a id="__codelineno-46-49" name="__codelineno-46-49" href="#__codelineno-46-49"></a>        <span class="n">existing_customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-46-50" name="__codelineno-46-50" href="#__codelineno-46-50"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-46-51" name="__codelineno-46-51" href="#__codelineno-46-51"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Existing&quot;</span><span class="p">,</span>
<a id="__codelineno-46-52" name="__codelineno-46-52" href="#__codelineno-46-52"></a>            <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-46-53" name="__codelineno-46-53" href="#__codelineno-46-53"></a>        <span class="p">)</span>
<a id="__codelineno-46-54" name="__codelineno-46-54" href="#__codelineno-46-54"></a>
<a id="__codelineno-46-55" name="__codelineno-46-55" href="#__codelineno-46-55"></a>        <span class="n">mock_repo</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">()</span>
<a id="__codelineno-46-56" name="__codelineno-46-56" href="#__codelineno-46-56"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">find_by_email</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">existing_customer</span>
<a id="__codelineno-46-57" name="__codelineno-46-57" href="#__codelineno-46-57"></a>        <span class="n">mock_repo_factory</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_repo</span>
<a id="__codelineno-46-58" name="__codelineno-46-58" href="#__codelineno-46-58"></a>
<a id="__codelineno-46-59" name="__codelineno-46-59" href="#__codelineno-46-59"></a>        <span class="c1"># Make request</span>
<a id="__codelineno-46-60" name="__codelineno-46-60" href="#__codelineno-46-60"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-46-61" name="__codelineno-46-61" href="#__codelineno-46-61"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-46-62" name="__codelineno-46-62" href="#__codelineno-46-62"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john@example.com&quot;</span>
<a id="__codelineno-46-63" name="__codelineno-46-63" href="#__codelineno-46-63"></a>        <span class="p">})</span>
<a id="__codelineno-46-64" name="__codelineno-46-64" href="#__codelineno-46-64"></a>
<a id="__codelineno-46-65" name="__codelineno-46-65" href="#__codelineno-46-65"></a>        <span class="c1"># Verify error response</span>
<a id="__codelineno-46-66" name="__codelineno-46-66" href="#__codelineno-46-66"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
<a id="__codelineno-46-67" name="__codelineno-46-67" href="#__codelineno-46-67"></a>        <span class="k">assert</span> <span class="s2">&quot;already exists&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>
<a id="__codelineno-46-68" name="__codelineno-46-68" href="#__codelineno-46-68"></a>
<a id="__codelineno-46-69" name="__codelineno-46-69" href="#__codelineno-46-69"></a>    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.presentation.repositories.get_customer_repository&#39;</span><span class="p">)</span>
<a id="__codelineno-46-70" name="__codelineno-46-70" href="#__codelineno-46-70"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_customer_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_repo_factory</span><span class="p">):</span>
<a id="__codelineno-46-71" name="__codelineno-46-71" href="#__codelineno-46-71"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test getting customer by ID.&quot;&quot;&quot;</span>
<a id="__codelineno-46-72" name="__codelineno-46-72" href="#__codelineno-46-72"></a>        <span class="c1"># Mock customer</span>
<a id="__codelineno-46-73" name="__codelineno-46-73" href="#__codelineno-46-73"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-46-74" name="__codelineno-46-74" href="#__codelineno-46-74"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-46-75" name="__codelineno-46-75" href="#__codelineno-46-75"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-46-76" name="__codelineno-46-76" href="#__codelineno-46-76"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-46-77" name="__codelineno-46-77" href="#__codelineno-46-77"></a>            <span class="n">email</span><span class="o">=</span><span class="n">Email</span><span class="p">(</span><span class="s2">&quot;john@example.com&quot;</span><span class="p">),</span>
<a id="__codelineno-46-78" name="__codelineno-46-78" href="#__codelineno-46-78"></a>        <span class="p">)</span>
<a id="__codelineno-46-79" name="__codelineno-46-79" href="#__codelineno-46-79"></a>
<a id="__codelineno-46-80" name="__codelineno-46-80" href="#__codelineno-46-80"></a>        <span class="n">mock_repo</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">()</span>
<a id="__codelineno-46-81" name="__codelineno-46-81" href="#__codelineno-46-81"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">find_by_id</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">customer</span>
<a id="__codelineno-46-82" name="__codelineno-46-82" href="#__codelineno-46-82"></a>        <span class="n">mock_repo_factory</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_repo</span>
<a id="__codelineno-46-83" name="__codelineno-46-83" href="#__codelineno-46-83"></a>
<a id="__codelineno-46-84" name="__codelineno-46-84" href="#__codelineno-46-84"></a>        <span class="c1"># Make request</span>
<a id="__codelineno-46-85" name="__codelineno-46-85" href="#__codelineno-46-85"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/api/v1/customers/</span><span class="si">{</span><span class="n">customer_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-46-86" name="__codelineno-46-86" href="#__codelineno-46-86"></a>
<a id="__codelineno-46-87" name="__codelineno-46-87" href="#__codelineno-46-87"></a>        <span class="c1"># Verify response</span>
<a id="__codelineno-46-88" name="__codelineno-46-88" href="#__codelineno-46-88"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-46-89" name="__codelineno-46-89" href="#__codelineno-46-89"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-46-90" name="__codelineno-46-90" href="#__codelineno-46-90"></a>        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-46-91" name="__codelineno-46-91" href="#__codelineno-46-91"></a>        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;john@example.com&quot;</span>
<a id="__codelineno-46-92" name="__codelineno-46-92" href="#__codelineno-46-92"></a>
<a id="__codelineno-46-93" name="__codelineno-46-93" href="#__codelineno-46-93"></a>    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;src.presentation.repositories.get_customer_repository&#39;</span><span class="p">)</span>
<a id="__codelineno-46-94" name="__codelineno-46-94" href="#__codelineno-46-94"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_customer_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_repo_factory</span><span class="p">):</span>
<a id="__codelineno-46-95" name="__codelineno-46-95" href="#__codelineno-46-95"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test getting non-existent customer returns 404.&quot;&quot;&quot;</span>
<a id="__codelineno-46-96" name="__codelineno-46-96" href="#__codelineno-46-96"></a>        <span class="n">mock_repo</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">()</span>
<a id="__codelineno-46-97" name="__codelineno-46-97" href="#__codelineno-46-97"></a>        <span class="n">mock_repo</span><span class="o">.</span><span class="n">find_by_id</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-46-98" name="__codelineno-46-98" href="#__codelineno-46-98"></a>        <span class="n">mock_repo_factory</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_repo</span>
<a id="__codelineno-46-99" name="__codelineno-46-99" href="#__codelineno-46-99"></a>
<a id="__codelineno-46-100" name="__codelineno-46-100" href="#__codelineno-46-100"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span>
<a id="__codelineno-46-101" name="__codelineno-46-101" href="#__codelineno-46-101"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/api/v1/customers/</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-46-102" name="__codelineno-46-102" href="#__codelineno-46-102"></a>
<a id="__codelineno-46-103" name="__codelineno-46-103" href="#__codelineno-46-103"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
<a id="__codelineno-46-104" name="__codelineno-46-104" href="#__codelineno-46-104"></a>        <span class="k">assert</span> <span class="s2">&quot;not found&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>
<a id="__codelineno-46-105" name="__codelineno-46-105" href="#__codelineno-46-105"></a>
<a id="__codelineno-46-106" name="__codelineno-46-106" href="#__codelineno-46-106"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_invalid_request_data_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-46-107" name="__codelineno-46-107" href="#__codelineno-46-107"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test request validation for invalid data.&quot;&quot;&quot;</span>
<a id="__codelineno-46-108" name="__codelineno-46-108" href="#__codelineno-46-108"></a>        <span class="c1"># Missing required fields</span>
<a id="__codelineno-46-109" name="__codelineno-46-109" href="#__codelineno-46-109"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-46-110" name="__codelineno-46-110" href="#__codelineno-46-110"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john@example.com&quot;</span>
<a id="__codelineno-46-111" name="__codelineno-46-111" href="#__codelineno-46-111"></a>            <span class="c1"># Missing name</span>
<a id="__codelineno-46-112" name="__codelineno-46-112" href="#__codelineno-46-112"></a>        <span class="p">})</span>
<a id="__codelineno-46-113" name="__codelineno-46-113" href="#__codelineno-46-113"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
<a id="__codelineno-46-114" name="__codelineno-46-114" href="#__codelineno-46-114"></a>
<a id="__codelineno-46-115" name="__codelineno-46-115" href="#__codelineno-46-115"></a>        <span class="c1"># Invalid email format</span>
<a id="__codelineno-46-116" name="__codelineno-46-116" href="#__codelineno-46-116"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-46-117" name="__codelineno-46-117" href="#__codelineno-46-117"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-46-118" name="__codelineno-46-118" href="#__codelineno-46-118"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid-email&quot;</span>
<a id="__codelineno-46-119" name="__codelineno-46-119" href="#__codelineno-46-119"></a>        <span class="p">})</span>
<a id="__codelineno-46-120" name="__codelineno-46-120" href="#__codelineno-46-120"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
<a id="__codelineno-46-121" name="__codelineno-46-121" href="#__codelineno-46-121"></a>
<a id="__codelineno-46-122" name="__codelineno-46-122" href="#__codelineno-46-122"></a>        <span class="c1"># Empty name</span>
<a id="__codelineno-46-123" name="__codelineno-46-123" href="#__codelineno-46-123"></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-46-124" name="__codelineno-46-124" href="#__codelineno-46-124"></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-46-125" name="__codelineno-46-125" href="#__codelineno-46-125"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john@example.com&quot;</span>
<a id="__codelineno-46-126" name="__codelineno-46-126" href="#__codelineno-46-126"></a>        <span class="p">})</span>
<a id="__codelineno-46-127" name="__codelineno-46-127" href="#__codelineno-46-127"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
</code></pre></div>
<h3 id="integration-tests-real-infrastructure"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#integration-tests-real-infrastructure">Integration Tests: Real Infrastructure</a></h3>
<p>Integration tests verify that your service works with real infrastructure components like databases, message queues, and external services. They're slower and more complex but catch issues that mocks can't.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c1"># tests/integration/test_customer_repository_integration.py</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_async_engine</span><span class="p">,</span> <span class="n">async_sessionmaker</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">testcontainers.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostgresContainer</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.repositories.customer_repository_impl</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>    <span class="n">CustomerRepositoryImpl</span><span class="p">,</span>
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="p">)</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.database.models.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">Address</span>
<a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>
<a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomerRepositoryIntegration</span><span class="p">:</span>
<a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Integration tests for customer repository with real database.&quot;&quot;&quot;</span>
<a id="__codelineno-47-16" name="__codelineno-47-16" href="#__codelineno-47-16"></a>
<a id="__codelineno-47-17" name="__codelineno-47-17" href="#__codelineno-47-17"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<a id="__codelineno-47-18" name="__codelineno-47-18" href="#__codelineno-47-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">postgres_container</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-47-19" name="__codelineno-47-19" href="#__codelineno-47-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create and manage PostgreSQL test container.&quot;&quot;&quot;</span>
<a id="__codelineno-47-20" name="__codelineno-47-20" href="#__codelineno-47-20"></a>        <span class="k">with</span> <span class="n">PostgresContainer</span><span class="p">(</span><span class="s2">&quot;postgres:15&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">postgres</span><span class="p">:</span>
<a id="__codelineno-47-21" name="__codelineno-47-21" href="#__codelineno-47-21"></a>            <span class="k">yield</span> <span class="n">postgres</span>
<a id="__codelineno-47-22" name="__codelineno-47-22" href="#__codelineno-47-22"></a>
<a id="__codelineno-47-23" name="__codelineno-47-23" href="#__codelineno-47-23"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<a id="__codelineno-47-24" name="__codelineno-47-24" href="#__codelineno-47-24"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">db_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">postgres_container</span><span class="p">):</span>
<a id="__codelineno-47-25" name="__codelineno-47-25" href="#__codelineno-47-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create database engine for testing.&quot;&quot;&quot;</span>
<a id="__codelineno-47-26" name="__codelineno-47-26" href="#__codelineno-47-26"></a>        <span class="n">connection_url</span> <span class="o">=</span> <span class="n">postgres_container</span><span class="o">.</span><span class="n">get_connection_url</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
<a id="__codelineno-47-27" name="__codelineno-47-27" href="#__codelineno-47-27"></a>            <span class="s2">&quot;postgresql://&quot;</span><span class="p">,</span> <span class="s2">&quot;postgresql+asyncpg://&quot;</span>
<a id="__codelineno-47-28" name="__codelineno-47-28" href="#__codelineno-47-28"></a>        <span class="p">)</span>
<a id="__codelineno-47-29" name="__codelineno-47-29" href="#__codelineno-47-29"></a>
<a id="__codelineno-47-30" name="__codelineno-47-30" href="#__codelineno-47-30"></a>        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="n">connection_url</span><span class="p">)</span>
<a id="__codelineno-47-31" name="__codelineno-47-31" href="#__codelineno-47-31"></a>
<a id="__codelineno-47-32" name="__codelineno-47-32" href="#__codelineno-47-32"></a>        <span class="c1"># Create tables</span>
<a id="__codelineno-47-33" name="__codelineno-47-33" href="#__codelineno-47-33"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-47-34" name="__codelineno-47-34" href="#__codelineno-47-34"></a>            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">BaseModel</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>
<a id="__codelineno-47-35" name="__codelineno-47-35" href="#__codelineno-47-35"></a>
<a id="__codelineno-47-36" name="__codelineno-47-36" href="#__codelineno-47-36"></a>        <span class="k">yield</span> <span class="n">engine</span>
<a id="__codelineno-47-37" name="__codelineno-47-37" href="#__codelineno-47-37"></a>
<a id="__codelineno-47-38" name="__codelineno-47-38" href="#__codelineno-47-38"></a>        <span class="k">await</span> <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
<a id="__codelineno-47-39" name="__codelineno-47-39" href="#__codelineno-47-39"></a>
<a id="__codelineno-47-40" name="__codelineno-47-40" href="#__codelineno-47-40"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-47-41" name="__codelineno-47-41" href="#__codelineno-47-41"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">db_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_engine</span><span class="p">):</span>
<a id="__codelineno-47-42" name="__codelineno-47-42" href="#__codelineno-47-42"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create database session for each test.&quot;&quot;&quot;</span>
<a id="__codelineno-47-43" name="__codelineno-47-43" href="#__codelineno-47-43"></a>        <span class="n">async_session</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="n">db_engine</span><span class="p">)</span>
<a id="__codelineno-47-44" name="__codelineno-47-44" href="#__codelineno-47-44"></a>        <span class="n">session</span> <span class="o">=</span> <span class="n">async_session</span><span class="p">()</span>
<a id="__codelineno-47-45" name="__codelineno-47-45" href="#__codelineno-47-45"></a>
<a id="__codelineno-47-46" name="__codelineno-47-46" href="#__codelineno-47-46"></a>        <span class="k">yield</span> <span class="n">session</span>
<a id="__codelineno-47-47" name="__codelineno-47-47" href="#__codelineno-47-47"></a>
<a id="__codelineno-47-48" name="__codelineno-47-48" href="#__codelineno-47-48"></a>        <span class="c1"># Cleanup</span>
<a id="__codelineno-47-49" name="__codelineno-47-49" href="#__codelineno-47-49"></a>        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-47-50" name="__codelineno-47-50" href="#__codelineno-47-50"></a>        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-47-51" name="__codelineno-47-51" href="#__codelineno-47-51"></a>
<a id="__codelineno-47-52" name="__codelineno-47-52" href="#__codelineno-47-52"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-47-53" name="__codelineno-47-53" href="#__codelineno-47-53"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">repository</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
<a id="__codelineno-47-54" name="__codelineno-47-54" href="#__codelineno-47-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create repository instance.&quot;&quot;&quot;</span>
<a id="__codelineno-47-55" name="__codelineno-47-55" href="#__codelineno-47-55"></a>        <span class="k">return</span> <span class="n">CustomerRepositoryImpl</span><span class="p">(</span><span class="n">db_session</span><span class="p">)</span>
<a id="__codelineno-47-56" name="__codelineno-47-56" href="#__codelineno-47-56"></a>
<a id="__codelineno-47-57" name="__codelineno-47-57" href="#__codelineno-47-57"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-47-58" name="__codelineno-47-58" href="#__codelineno-47-58"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_save_and_find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">):</span>
<a id="__codelineno-47-59" name="__codelineno-47-59" href="#__codelineno-47-59"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test saving and finding a customer.&quot;&quot;&quot;</span>
<a id="__codelineno-47-60" name="__codelineno-47-60" href="#__codelineno-47-60"></a>        <span class="c1"># Create customer</span>
<a id="__codelineno-47-61" name="__codelineno-47-61" href="#__codelineno-47-61"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-47-62" name="__codelineno-47-62" href="#__codelineno-47-62"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-47-63" name="__codelineno-47-63" href="#__codelineno-47-63"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-47-64" name="__codelineno-47-64" href="#__codelineno-47-64"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-47-65" name="__codelineno-47-65" href="#__codelineno-47-65"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-47-66" name="__codelineno-47-66" href="#__codelineno-47-66"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-47-67" name="__codelineno-47-67" href="#__codelineno-47-67"></a>            <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">},</span>
<a id="__codelineno-47-68" name="__codelineno-47-68" href="#__codelineno-47-68"></a>        <span class="p">)</span>
<a id="__codelineno-47-69" name="__codelineno-47-69" href="#__codelineno-47-69"></a>
<a id="__codelineno-47-70" name="__codelineno-47-70" href="#__codelineno-47-70"></a>        <span class="c1"># Save customer</span>
<a id="__codelineno-47-71" name="__codelineno-47-71" href="#__codelineno-47-71"></a>        <span class="n">saved_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-47-72" name="__codelineno-47-72" href="#__codelineno-47-72"></a>
<a id="__codelineno-47-73" name="__codelineno-47-73" href="#__codelineno-47-73"></a>        <span class="c1"># Verify save worked</span>
<a id="__codelineno-47-74" name="__codelineno-47-74" href="#__codelineno-47-74"></a>        <span class="k">assert</span> <span class="n">saved_customer</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-47-75" name="__codelineno-47-75" href="#__codelineno-47-75"></a>        <span class="k">assert</span> <span class="n">saved_customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-47-76" name="__codelineno-47-76" href="#__codelineno-47-76"></a>        <span class="k">assert</span> <span class="n">saved_customer</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span>
<a id="__codelineno-47-77" name="__codelineno-47-77" href="#__codelineno-47-77"></a>        <span class="k">assert</span> <span class="n">saved_customer</span><span class="o">.</span><span class="n">preferences</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-47-78" name="__codelineno-47-78" href="#__codelineno-47-78"></a>
<a id="__codelineno-47-79" name="__codelineno-47-79" href="#__codelineno-47-79"></a>        <span class="c1"># Find customer by ID</span>
<a id="__codelineno-47-80" name="__codelineno-47-80" href="#__codelineno-47-80"></a>        <span class="n">found_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-47-81" name="__codelineno-47-81" href="#__codelineno-47-81"></a>
<a id="__codelineno-47-82" name="__codelineno-47-82" href="#__codelineno-47-82"></a>        <span class="c1"># Verify find worked</span>
<a id="__codelineno-47-83" name="__codelineno-47-83" href="#__codelineno-47-83"></a>        <span class="k">assert</span> <span class="n">found_customer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-47-84" name="__codelineno-47-84" href="#__codelineno-47-84"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-47-85" name="__codelineno-47-85" href="#__codelineno-47-85"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-47-86" name="__codelineno-47-86" href="#__codelineno-47-86"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span>
<a id="__codelineno-47-87" name="__codelineno-47-87" href="#__codelineno-47-87"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">preferences</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-47-88" name="__codelineno-47-88" href="#__codelineno-47-88"></a>
<a id="__codelineno-47-89" name="__codelineno-47-89" href="#__codelineno-47-89"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-47-90" name="__codelineno-47-90" href="#__codelineno-47-90"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_find_by_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">):</span>
<a id="__codelineno-47-91" name="__codelineno-47-91" href="#__codelineno-47-91"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test finding customer by email.&quot;&quot;&quot;</span>
<a id="__codelineno-47-92" name="__codelineno-47-92" href="#__codelineno-47-92"></a>        <span class="c1"># Create and save customer</span>
<a id="__codelineno-47-93" name="__codelineno-47-93" href="#__codelineno-47-93"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-47-94" name="__codelineno-47-94" href="#__codelineno-47-94"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;email-test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-47-95" name="__codelineno-47-95" href="#__codelineno-47-95"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-47-96" name="__codelineno-47-96" href="#__codelineno-47-96"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-47-97" name="__codelineno-47-97" href="#__codelineno-47-97"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Email Test&quot;</span><span class="p">,</span>
<a id="__codelineno-47-98" name="__codelineno-47-98" href="#__codelineno-47-98"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-47-99" name="__codelineno-47-99" href="#__codelineno-47-99"></a>        <span class="p">)</span>
<a id="__codelineno-47-100" name="__codelineno-47-100" href="#__codelineno-47-100"></a>
<a id="__codelineno-47-101" name="__codelineno-47-101" href="#__codelineno-47-101"></a>        <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-47-102" name="__codelineno-47-102" href="#__codelineno-47-102"></a>
<a id="__codelineno-47-103" name="__codelineno-47-103" href="#__codelineno-47-103"></a>        <span class="c1"># Find by email</span>
<a id="__codelineno-47-104" name="__codelineno-47-104" href="#__codelineno-47-104"></a>        <span class="n">found_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;email-test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-47-105" name="__codelineno-47-105" href="#__codelineno-47-105"></a>
<a id="__codelineno-47-106" name="__codelineno-47-106" href="#__codelineno-47-106"></a>        <span class="k">assert</span> <span class="n">found_customer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-47-107" name="__codelineno-47-107" href="#__codelineno-47-107"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-47-108" name="__codelineno-47-108" href="#__codelineno-47-108"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Email Test&quot;</span>
<a id="__codelineno-47-109" name="__codelineno-47-109" href="#__codelineno-47-109"></a>
<a id="__codelineno-47-110" name="__codelineno-47-110" href="#__codelineno-47-110"></a>        <span class="c1"># Test non-existent email</span>
<a id="__codelineno-47-111" name="__codelineno-47-111" href="#__codelineno-47-111"></a>        <span class="n">not_found</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;nonexistent@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-47-112" name="__codelineno-47-112" href="#__codelineno-47-112"></a>        <span class="k">assert</span> <span class="n">not_found</span> <span class="ow">is</span> <span class="kc">None</span>
<a id="__codelineno-47-113" name="__codelineno-47-113" href="#__codelineno-47-113"></a>
<a id="__codelineno-47-114" name="__codelineno-47-114" href="#__codelineno-47-114"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-47-115" name="__codelineno-47-115" href="#__codelineno-47-115"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_find_all_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">):</span>
<a id="__codelineno-47-116" name="__codelineno-47-116" href="#__codelineno-47-116"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test finding all active customers.&quot;&quot;&quot;</span>
<a id="__codelineno-47-117" name="__codelineno-47-117" href="#__codelineno-47-117"></a>        <span class="c1"># Create multiple customers</span>
<a id="__codelineno-47-118" name="__codelineno-47-118" href="#__codelineno-47-118"></a>        <span class="n">customers</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-47-119" name="__codelineno-47-119" href="#__codelineno-47-119"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-47-120" name="__codelineno-47-120" href="#__codelineno-47-120"></a>            <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-47-121" name="__codelineno-47-121" href="#__codelineno-47-121"></a>            <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;active-test-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-47-122" name="__codelineno-47-122" href="#__codelineno-47-122"></a>            <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-47-123" name="__codelineno-47-123" href="#__codelineno-47-123"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-47-124" name="__codelineno-47-124" href="#__codelineno-47-124"></a>                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Active Customer </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-47-125" name="__codelineno-47-125" href="#__codelineno-47-125"></a>                <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-47-126" name="__codelineno-47-126" href="#__codelineno-47-126"></a>            <span class="p">)</span>
<a id="__codelineno-47-127" name="__codelineno-47-127" href="#__codelineno-47-127"></a>            <span class="n">customers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-47-128" name="__codelineno-47-128" href="#__codelineno-47-128"></a>            <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-47-129" name="__codelineno-47-129" href="#__codelineno-47-129"></a>
<a id="__codelineno-47-130" name="__codelineno-47-130" href="#__codelineno-47-130"></a>        <span class="c1"># Deactivate one customer</span>
<a id="__codelineno-47-131" name="__codelineno-47-131" href="#__codelineno-47-131"></a>        <span class="n">deactivated</span> <span class="o">=</span> <span class="n">customers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deactivate</span><span class="p">(</span><span class="s2">&quot;Test deactivation&quot;</span><span class="p">)</span>
<a id="__codelineno-47-132" name="__codelineno-47-132" href="#__codelineno-47-132"></a>        <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">deactivated</span><span class="p">)</span>
<a id="__codelineno-47-133" name="__codelineno-47-133" href="#__codelineno-47-133"></a>
<a id="__codelineno-47-134" name="__codelineno-47-134" href="#__codelineno-47-134"></a>        <span class="c1"># Find all active customers</span>
<a id="__codelineno-47-135" name="__codelineno-47-135" href="#__codelineno-47-135"></a>        <span class="n">active_customers</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_all_active</span><span class="p">()</span>
<a id="__codelineno-47-136" name="__codelineno-47-136" href="#__codelineno-47-136"></a>
<a id="__codelineno-47-137" name="__codelineno-47-137" href="#__codelineno-47-137"></a>        <span class="c1"># Should have 2 active customers (3 created, 1 deactivated)</span>
<a id="__codelineno-47-138" name="__codelineno-47-138" href="#__codelineno-47-138"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_customers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<a id="__codelineno-47-139" name="__codelineno-47-139" href="#__codelineno-47-139"></a>
<a id="__codelineno-47-140" name="__codelineno-47-140" href="#__codelineno-47-140"></a>        <span class="c1"># Verify only active customers returned</span>
<a id="__codelineno-47-141" name="__codelineno-47-141" href="#__codelineno-47-141"></a>        <span class="k">for</span> <span class="n">customer</span> <span class="ow">in</span> <span class="n">active_customers</span><span class="p">:</span>
<a id="__codelineno-47-142" name="__codelineno-47-142" href="#__codelineno-47-142"></a>            <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-47-143" name="__codelineno-47-143" href="#__codelineno-47-143"></a>
<a id="__codelineno-47-144" name="__codelineno-47-144" href="#__codelineno-47-144"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-47-145" name="__codelineno-47-145" href="#__codelineno-47-145"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_customer_with_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">):</span>
<a id="__codelineno-47-146" name="__codelineno-47-146" href="#__codelineno-47-146"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test saving and retrieving customer with address.&quot;&quot;&quot;</span>
<a id="__codelineno-47-147" name="__codelineno-47-147" href="#__codelineno-47-147"></a>        <span class="c1"># Create customer with address</span>
<a id="__codelineno-47-148" name="__codelineno-47-148" href="#__codelineno-47-148"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-47-149" name="__codelineno-47-149" href="#__codelineno-47-149"></a>        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="s2">&quot;address-test@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-47-150" name="__codelineno-47-150" href="#__codelineno-47-150"></a>        <span class="n">address</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span>
<a id="__codelineno-47-151" name="__codelineno-47-151" href="#__codelineno-47-151"></a>            <span class="n">street</span><span class="o">=</span><span class="s2">&quot;123 Test St&quot;</span><span class="p">,</span>
<a id="__codelineno-47-152" name="__codelineno-47-152" href="#__codelineno-47-152"></a>            <span class="n">city</span><span class="o">=</span><span class="s2">&quot;Test City&quot;</span><span class="p">,</span>
<a id="__codelineno-47-153" name="__codelineno-47-153" href="#__codelineno-47-153"></a>            <span class="n">state</span><span class="o">=</span><span class="s2">&quot;TS&quot;</span><span class="p">,</span>
<a id="__codelineno-47-154" name="__codelineno-47-154" href="#__codelineno-47-154"></a>            <span class="n">postal_code</span><span class="o">=</span><span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<a id="__codelineno-47-155" name="__codelineno-47-155" href="#__codelineno-47-155"></a>            <span class="n">country</span><span class="o">=</span><span class="s2">&quot;Test Country&quot;</span><span class="p">,</span>
<a id="__codelineno-47-156" name="__codelineno-47-156" href="#__codelineno-47-156"></a>        <span class="p">)</span>
<a id="__codelineno-47-157" name="__codelineno-47-157" href="#__codelineno-47-157"></a>
<a id="__codelineno-47-158" name="__codelineno-47-158" href="#__codelineno-47-158"></a>        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-47-159" name="__codelineno-47-159" href="#__codelineno-47-159"></a>            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-47-160" name="__codelineno-47-160" href="#__codelineno-47-160"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Address Test&quot;</span><span class="p">,</span>
<a id="__codelineno-47-161" name="__codelineno-47-161" href="#__codelineno-47-161"></a>            <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-47-162" name="__codelineno-47-162" href="#__codelineno-47-162"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
<a id="__codelineno-47-163" name="__codelineno-47-163" href="#__codelineno-47-163"></a>        <span class="p">)</span>
<a id="__codelineno-47-164" name="__codelineno-47-164" href="#__codelineno-47-164"></a>
<a id="__codelineno-47-165" name="__codelineno-47-165" href="#__codelineno-47-165"></a>        <span class="c1"># Save and retrieve</span>
<a id="__codelineno-47-166" name="__codelineno-47-166" href="#__codelineno-47-166"></a>        <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-47-167" name="__codelineno-47-167" href="#__codelineno-47-167"></a>        <span class="n">found_customer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-47-168" name="__codelineno-47-168" href="#__codelineno-47-168"></a>
<a id="__codelineno-47-169" name="__codelineno-47-169" href="#__codelineno-47-169"></a>        <span class="c1"># Verify address preserved</span>
<a id="__codelineno-47-170" name="__codelineno-47-170" href="#__codelineno-47-170"></a>        <span class="k">assert</span> <span class="n">found_customer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-47-171" name="__codelineno-47-171" href="#__codelineno-47-171"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-47-172" name="__codelineno-47-172" href="#__codelineno-47-172"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">street</span> <span class="o">==</span> <span class="s2">&quot;123 Test St&quot;</span>
<a id="__codelineno-47-173" name="__codelineno-47-173" href="#__codelineno-47-173"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">city</span> <span class="o">==</span> <span class="s2">&quot;Test City&quot;</span>
<a id="__codelineno-47-174" name="__codelineno-47-174" href="#__codelineno-47-174"></a>        <span class="k">assert</span> <span class="n">found_customer</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">country</span> <span class="o">==</span> <span class="s2">&quot;Test Country&quot;</span>
<a id="__codelineno-47-175" name="__codelineno-47-175" href="#__codelineno-47-175"></a>
<a id="__codelineno-47-176" name="__codelineno-47-176" href="#__codelineno-47-176"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-47-177" name="__codelineno-47-177" href="#__codelineno-47-177"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_concurrent_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">):</span>
<a id="__codelineno-47-178" name="__codelineno-47-178" href="#__codelineno-47-178"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test concurrent repository operations.&quot;&quot;&quot;</span>
<a id="__codelineno-47-179" name="__codelineno-47-179" href="#__codelineno-47-179"></a>        <span class="c1"># Create customers concurrently</span>
<a id="__codelineno-47-180" name="__codelineno-47-180" href="#__codelineno-47-180"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
<a id="__codelineno-47-181" name="__codelineno-47-181" href="#__codelineno-47-181"></a>            <span class="n">customer_id</span> <span class="o">=</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-47-182" name="__codelineno-47-182" href="#__codelineno-47-182"></a>            <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;concurrent-</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-47-183" name="__codelineno-47-183" href="#__codelineno-47-183"></a>            <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<a id="__codelineno-47-184" name="__codelineno-47-184" href="#__codelineno-47-184"></a>                <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-47-185" name="__codelineno-47-185" href="#__codelineno-47-185"></a>                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Concurrent Customer </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-47-186" name="__codelineno-47-186" href="#__codelineno-47-186"></a>                <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-47-187" name="__codelineno-47-187" href="#__codelineno-47-187"></a>            <span class="p">)</span>
<a id="__codelineno-47-188" name="__codelineno-47-188" href="#__codelineno-47-188"></a>            <span class="k">return</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-47-189" name="__codelineno-47-189" href="#__codelineno-47-189"></a>
<a id="__codelineno-47-190" name="__codelineno-47-190" href="#__codelineno-47-190"></a>        <span class="c1"># Create 10 customers concurrently</span>
<a id="__codelineno-47-191" name="__codelineno-47-191" href="#__codelineno-47-191"></a>        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_customer</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<a id="__codelineno-47-192" name="__codelineno-47-192" href="#__codelineno-47-192"></a>        <span class="n">created_customers</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
<a id="__codelineno-47-193" name="__codelineno-47-193" href="#__codelineno-47-193"></a>
<a id="__codelineno-47-194" name="__codelineno-47-194" href="#__codelineno-47-194"></a>        <span class="c1"># Verify all customers created</span>
<a id="__codelineno-47-195" name="__codelineno-47-195" href="#__codelineno-47-195"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">created_customers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span>
<a id="__codelineno-47-196" name="__codelineno-47-196" href="#__codelineno-47-196"></a>
<a id="__codelineno-47-197" name="__codelineno-47-197" href="#__codelineno-47-197"></a>        <span class="c1"># Verify all customers can be found</span>
<a id="__codelineno-47-198" name="__codelineno-47-198" href="#__codelineno-47-198"></a>        <span class="k">for</span> <span class="n">customer</span> <span class="ow">in</span> <span class="n">created_customers</span><span class="p">:</span>
<a id="__codelineno-47-199" name="__codelineno-47-199" href="#__codelineno-47-199"></a>            <span class="n">found</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repository</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<a id="__codelineno-47-200" name="__codelineno-47-200" href="#__codelineno-47-200"></a>            <span class="k">assert</span> <span class="n">found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-47-201" name="__codelineno-47-201" href="#__codelineno-47-201"></a>            <span class="k">assert</span> <span class="n">found</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span>
</code></pre></div>
<h3 id="contract-tests-service-boundary-verification"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#contract-tests-service-boundary-verification">Contract Tests: Service Boundary Verification</a></h3>
<p>Contract tests ensure that the interfaces between services remain compatible. They're particularly important in microservices architectures where services are developed by different teams.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1"># tests/contract/test_customer_api_contract.py</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pact</span><span class="w"> </span><span class="kn">import</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">Provider</span><span class="p">,</span> <span class="n">Like</span><span class="p">,</span> <span class="n">Format</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.presentation.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomerAPIContract</span><span class="p">:</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Contract tests for Customer API.&quot;&quot;&quot;</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">pact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up Pact consumer.&quot;&quot;&quot;</span>
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a>        <span class="k">return</span> <span class="n">Consumer</span><span class="p">(</span><span class="s2">&quot;customer-service&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">has_pact_with</span><span class="p">(</span>
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a>            <span class="n">Provider</span><span class="p">(</span><span class="s2">&quot;customer-api&quot;</span><span class="p">),</span>
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>            <span class="n">host_name</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>            <span class="n">port</span><span class="o">=</span><span class="mi">1234</span>
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a>        <span class="p">)</span>
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_customer_contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pact</span><span class="p">):</span>
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test customer creation API contract.&quot;&quot;&quot;</span>
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a>        <span class="c1"># Define expected interaction</span>
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a>        <span class="p">(</span><span class="n">pact</span>
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a>         <span class="o">.</span><span class="n">given</span><span class="p">(</span><span class="s2">&quot;customer service is available&quot;</span><span class="p">)</span>
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a>         <span class="o">.</span><span class="n">upon_receiving</span><span class="p">(</span><span class="s2">&quot;a request to create a customer&quot;</span><span class="p">)</span>
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a>         <span class="o">.</span><span class="n">with_request</span><span class="p">(</span>
<a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a>             <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a>             <span class="n">path</span><span class="o">=</span><span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span>
<a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a>             <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
<a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a>             <span class="n">body</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a>                 <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a>                 <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">Format</span><span class="p">()</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-48-33" name="__codelineno-48-33" href="#__codelineno-48-33"></a>                 <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="n">Like</span><span class="p">({</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">})</span>
<a id="__codelineno-48-34" name="__codelineno-48-34" href="#__codelineno-48-34"></a>             <span class="p">}</span>
<a id="__codelineno-48-35" name="__codelineno-48-35" href="#__codelineno-48-35"></a>         <span class="p">)</span>
<a id="__codelineno-48-36" name="__codelineno-48-36" href="#__codelineno-48-36"></a>         <span class="o">.</span><span class="n">will_respond_with</span><span class="p">(</span>
<a id="__codelineno-48-37" name="__codelineno-48-37" href="#__codelineno-48-37"></a>             <span class="n">status</span><span class="o">=</span><span class="mi">201</span><span class="p">,</span>
<a id="__codelineno-48-38" name="__codelineno-48-38" href="#__codelineno-48-38"></a>             <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
<a id="__codelineno-48-39" name="__codelineno-48-39" href="#__codelineno-48-39"></a>             <span class="n">body</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-48-40" name="__codelineno-48-40" href="#__codelineno-48-40"></a>                 <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">Format</span><span class="p">()</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
<a id="__codelineno-48-41" name="__codelineno-48-41" href="#__codelineno-48-41"></a>                 <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-48-42" name="__codelineno-48-42" href="#__codelineno-48-42"></a>                 <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">Format</span><span class="p">()</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-48-43" name="__codelineno-48-43" href="#__codelineno-48-43"></a>                 <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-48-44" name="__codelineno-48-44" href="#__codelineno-48-44"></a>                 <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="n">Like</span><span class="p">({</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}),</span>
<a id="__codelineno-48-45" name="__codelineno-48-45" href="#__codelineno-48-45"></a>                 <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">Format</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-48-46" name="__codelineno-48-46" href="#__codelineno-48-46"></a>                 <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">Format</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span>
<a id="__codelineno-48-47" name="__codelineno-48-47" href="#__codelineno-48-47"></a>             <span class="p">}</span>
<a id="__codelineno-48-48" name="__codelineno-48-48" href="#__codelineno-48-48"></a>         <span class="p">))</span>
<a id="__codelineno-48-49" name="__codelineno-48-49" href="#__codelineno-48-49"></a>
<a id="__codelineno-48-50" name="__codelineno-48-50" href="#__codelineno-48-50"></a>        <span class="c1"># Execute test</span>
<a id="__codelineno-48-51" name="__codelineno-48-51" href="#__codelineno-48-51"></a>        <span class="k">with</span> <span class="n">pact</span><span class="p">:</span>
<a id="__codelineno-48-52" name="__codelineno-48-52" href="#__codelineno-48-52"></a>            <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-48-53" name="__codelineno-48-53" href="#__codelineno-48-53"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-48-54" name="__codelineno-48-54" href="#__codelineno-48-54"></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-48-55" name="__codelineno-48-55" href="#__codelineno-48-55"></a>                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;john@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-48-56" name="__codelineno-48-56" href="#__codelineno-48-56"></a>                <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-48-57" name="__codelineno-48-57" href="#__codelineno-48-57"></a>            <span class="p">})</span>
<a id="__codelineno-48-58" name="__codelineno-48-58" href="#__codelineno-48-58"></a>
<a id="__codelineno-48-59" name="__codelineno-48-59" href="#__codelineno-48-59"></a>            <span class="c1"># Verify contract fulfilled</span>
<a id="__codelineno-48-60" name="__codelineno-48-60" href="#__codelineno-48-60"></a>            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<a id="__codelineno-48-61" name="__codelineno-48-61" href="#__codelineno-48-61"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-48-62" name="__codelineno-48-62" href="#__codelineno-48-62"></a>            <span class="k">assert</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">data</span>
<a id="__codelineno-48-63" name="__codelineno-48-63" href="#__codelineno-48-63"></a>            <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;John Doe&quot;</span>
<a id="__codelineno-48-64" name="__codelineno-48-64" href="#__codelineno-48-64"></a>            <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;is_active&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-48-65" name="__codelineno-48-65" href="#__codelineno-48-65"></a>
<a id="__codelineno-48-66" name="__codelineno-48-66" href="#__codelineno-48-66"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_customer_contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pact</span><span class="p">):</span>
<a id="__codelineno-48-67" name="__codelineno-48-67" href="#__codelineno-48-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test get customer API contract.&quot;&quot;&quot;</span>
<a id="__codelineno-48-68" name="__codelineno-48-68" href="#__codelineno-48-68"></a>        <span class="n">customer_id</span> <span class="o">=</span> <span class="s2">&quot;550e8400-e29b-41d4-a716-446655440000&quot;</span>
<a id="__codelineno-48-69" name="__codelineno-48-69" href="#__codelineno-48-69"></a>
<a id="__codelineno-48-70" name="__codelineno-48-70" href="#__codelineno-48-70"></a>        <span class="p">(</span><span class="n">pact</span>
<a id="__codelineno-48-71" name="__codelineno-48-71" href="#__codelineno-48-71"></a>         <span class="o">.</span><span class="n">given</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;customer </span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2"> exists&quot;</span><span class="p">)</span>
<a id="__codelineno-48-72" name="__codelineno-48-72" href="#__codelineno-48-72"></a>         <span class="o">.</span><span class="n">upon_receiving</span><span class="p">(</span><span class="s2">&quot;a request to get a customer&quot;</span><span class="p">)</span>
<a id="__codelineno-48-73" name="__codelineno-48-73" href="#__codelineno-48-73"></a>         <span class="o">.</span><span class="n">with_request</span><span class="p">(</span>
<a id="__codelineno-48-74" name="__codelineno-48-74" href="#__codelineno-48-74"></a>             <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<a id="__codelineno-48-75" name="__codelineno-48-75" href="#__codelineno-48-75"></a>             <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/api/v1/customers/</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-48-76" name="__codelineno-48-76" href="#__codelineno-48-76"></a>         <span class="p">)</span>
<a id="__codelineno-48-77" name="__codelineno-48-77" href="#__codelineno-48-77"></a>         <span class="o">.</span><span class="n">will_respond_with</span><span class="p">(</span>
<a id="__codelineno-48-78" name="__codelineno-48-78" href="#__codelineno-48-78"></a>             <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<a id="__codelineno-48-79" name="__codelineno-48-79" href="#__codelineno-48-79"></a>             <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
<a id="__codelineno-48-80" name="__codelineno-48-80" href="#__codelineno-48-80"></a>             <span class="n">body</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-48-81" name="__codelineno-48-81" href="#__codelineno-48-81"></a>                 <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">Format</span><span class="p">()</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
<a id="__codelineno-48-82" name="__codelineno-48-82" href="#__codelineno-48-82"></a>                 <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">Like</span><span class="p">(</span><span class="s2">&quot;John Doe&quot;</span><span class="p">),</span>
<a id="__codelineno-48-83" name="__codelineno-48-83" href="#__codelineno-48-83"></a>                 <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">Format</span><span class="p">()</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-48-84" name="__codelineno-48-84" href="#__codelineno-48-84"></a>                 <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-48-85" name="__codelineno-48-85" href="#__codelineno-48-85"></a>                 <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="n">Like</span><span class="p">({}),</span>
<a id="__codelineno-48-86" name="__codelineno-48-86" href="#__codelineno-48-86"></a>                 <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">Format</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-48-87" name="__codelineno-48-87" href="#__codelineno-48-87"></a>                 <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">Format</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span>
<a id="__codelineno-48-88" name="__codelineno-48-88" href="#__codelineno-48-88"></a>             <span class="p">}</span>
<a id="__codelineno-48-89" name="__codelineno-48-89" href="#__codelineno-48-89"></a>         <span class="p">))</span>
<a id="__codelineno-48-90" name="__codelineno-48-90" href="#__codelineno-48-90"></a>
<a id="__codelineno-48-91" name="__codelineno-48-91" href="#__codelineno-48-91"></a>        <span class="c1"># Execute test</span>
<a id="__codelineno-48-92" name="__codelineno-48-92" href="#__codelineno-48-92"></a>        <span class="k">with</span> <span class="n">pact</span><span class="p">:</span>
<a id="__codelineno-48-93" name="__codelineno-48-93" href="#__codelineno-48-93"></a>            <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-48-94" name="__codelineno-48-94" href="#__codelineno-48-94"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/api/v1/customers/</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-48-95" name="__codelineno-48-95" href="#__codelineno-48-95"></a>
<a id="__codelineno-48-96" name="__codelineno-48-96" href="#__codelineno-48-96"></a>            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-48-97" name="__codelineno-48-97" href="#__codelineno-48-97"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-48-98" name="__codelineno-48-98" href="#__codelineno-48-98"></a>            <span class="k">assert</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">data</span>
<a id="__codelineno-48-99" name="__codelineno-48-99" href="#__codelineno-48-99"></a>            <span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">data</span>
<a id="__codelineno-48-100" name="__codelineno-48-100" href="#__codelineno-48-100"></a>            <span class="k">assert</span> <span class="s2">&quot;email&quot;</span> <span class="ow">in</span> <span class="n">data</span>
</code></pre></div>
<h3 id="infrastructure-testing-external-dependencies"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#infrastructure-testing-external-dependencies">Infrastructure Testing: External Dependencies</a></h3>
<p>Test your infrastructure components and external integrations:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1"># tests/infrastructure/test_logging_integration.py</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestLoggingInfrastructure</span><span class="p">:</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test logging infrastructure functionality.&quot;&quot;&quot;</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.infrastructure.logging.config._is_running_locally&quot;</span><span class="p">)</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_logger_default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_is_local</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test getting logger with default configuration.&quot;&quot;&quot;</span>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>        <span class="c1"># Force AWS environment detection for consistent test behavior</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>        <span class="n">mock_is_local</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;test.module&quot;</span><span class="p">)</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">)</span>
<a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a>        <span class="k">assert</span> <span class="n">logger</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;test.module&quot;</span>
<a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a>        <span class="k">assert</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>  <span class="c1"># Default level</span>
<a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a>
<a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_logger_custom_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test getting logger with custom configuration.&quot;&quot;&quot;</span>
<a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a>        <span class="n">config</span> <span class="o">=</span> <span class="n">LogConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">service_name</span><span class="o">=</span><span class="s2">&quot;custom-service&quot;</span><span class="p">)</span>
<a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a>
<a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;test.module&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a>
<a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a>        <span class="k">assert</span> <span class="n">logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
<a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a>
<a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_correlation_id_in_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that correlation IDs appear in formatted logs.&quot;&quot;&quot;</span>
<a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.logging.correlation</span><span class="w"> </span><span class="kn">import</span> <span class="n">CorrelationContext</span>
<a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a>
<a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a>        <span class="c1"># Configure logging</span>
<a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a>        <span class="n">configure_logging</span><span class="p">()</span>
<a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">get_application_logger</span><span class="p">(</span><span class="s2">&quot;correlation.test&quot;</span><span class="p">)</span>
<a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a>
<a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a>        <span class="c1"># Set correlation ID</span>
<a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a>        <span class="n">test_correlation_id</span> <span class="o">=</span> <span class="s2">&quot;integration-correlation-123&quot;</span>
<a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a>        <span class="n">CorrelationContext</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">test_correlation_id</span><span class="p">)</span>
<a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a>
<a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a>        <span class="c1"># Capture log output</span>
<a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a>        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;sys.stdout&quot;</span><span class="p">):</span>
<a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Test message with correlation&quot;</span><span class="p">)</span>
<a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a>
<a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a>        <span class="c1"># Verify correlation ID is included</span>
<a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a>        <span class="k">assert</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a>
<a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a>        <span class="c1"># Clean up</span>
<a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a>        <span class="n">CorrelationContext</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a>
<a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a>    <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.infrastructure.logging.logger.get_cloudwatch_handler&quot;</span><span class="p">)</span>
<a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_configure_logging_with_cloudwatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_cloudwatch_handler</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test logging configuration with CloudWatch enabled.&quot;&quot;&quot;</span>
<a id="__codelineno-49-50" name="__codelineno-49-50" href="#__codelineno-49-50"></a>        <span class="c1"># Mock CloudWatch handler</span>
<a id="__codelineno-49-51" name="__codelineno-49-51" href="#__codelineno-49-51"></a>        <span class="n">mock_handler</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span>
<a id="__codelineno-49-52" name="__codelineno-49-52" href="#__codelineno-49-52"></a>        <span class="n">mock_handler</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
<a id="__codelineno-49-53" name="__codelineno-49-53" href="#__codelineno-49-53"></a>        <span class="n">mock_cloudwatch_handler</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_handler</span>
<a id="__codelineno-49-54" name="__codelineno-49-54" href="#__codelineno-49-54"></a>
<a id="__codelineno-49-55" name="__codelineno-49-55" href="#__codelineno-49-55"></a>        <span class="n">config</span> <span class="o">=</span> <span class="n">LogConfig</span><span class="p">(</span>
<a id="__codelineno-49-56" name="__codelineno-49-56" href="#__codelineno-49-56"></a>            <span class="n">environment</span><span class="o">=</span><span class="n">Environment</span><span class="o">.</span><span class="n">PRODUCTION</span><span class="p">,</span>
<a id="__codelineno-49-57" name="__codelineno-49-57" href="#__codelineno-49-57"></a>            <span class="n">cloudwatch_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-49-58" name="__codelineno-49-58" href="#__codelineno-49-58"></a>            <span class="n">cloudwatch_log_group</span><span class="o">=</span><span class="s2">&quot;/test/logs&quot;</span><span class="p">,</span>
<a id="__codelineno-49-59" name="__codelineno-49-59" href="#__codelineno-49-59"></a>        <span class="p">)</span>
<a id="__codelineno-49-60" name="__codelineno-49-60" href="#__codelineno-49-60"></a>
<a id="__codelineno-49-61" name="__codelineno-49-61" href="#__codelineno-49-61"></a>        <span class="n">configure_logging</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-49-62" name="__codelineno-49-62" href="#__codelineno-49-62"></a>
<a id="__codelineno-49-63" name="__codelineno-49-63" href="#__codelineno-49-63"></a>        <span class="c1"># CloudWatch handler should have been requested</span>
<a id="__codelineno-49-64" name="__codelineno-49-64" href="#__codelineno-49-64"></a>        <span class="k">assert</span> <span class="n">mock_cloudwatch_handler</span><span class="o">.</span><span class="n">call_count</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<a id="__codelineno-49-65" name="__codelineno-49-65" href="#__codelineno-49-65"></a>
<a id="__codelineno-49-66" name="__codelineno-49-66" href="#__codelineno-49-66"></a>        <span class="c1"># Root logger should have both console and CloudWatch handlers</span>
<a id="__codelineno-49-67" name="__codelineno-49-67" href="#__codelineno-49-67"></a>        <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<a id="__codelineno-49-68" name="__codelineno-49-68" href="#__codelineno-49-68"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
</code></pre></div>
<h3 id="end-to-end-tests-full-system-verification"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#end-to-end-tests-full-system-verification">End-to-End Tests: Full System Verification</a></h3>
<p>E2E tests verify complete user workflows across all services:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1"># tests/e2e/test_customer_workflow.py</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">httpx</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncClient</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">testcontainers.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">DockerCompose</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomerWorkflowE2E</span><span class="p">:</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;End-to-end tests for customer workflows.&quot;&quot;&quot;</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up complete test environment with Docker Compose.&quot;&quot;&quot;</span>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>        <span class="n">compose</span> <span class="o">=</span> <span class="n">DockerCompose</span><span class="p">(</span>
<a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a>            <span class="n">filepath</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> 
<a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a>            <span class="n">compose_file_name</span><span class="o">=</span><span class="s2">&quot;docker-compose.test.yml&quot;</span>
<a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a>        <span class="p">)</span>
<a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a>
<a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a>        <span class="k">with</span> <span class="n">compose</span><span class="p">:</span>
<a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a>            <span class="c1"># Wait for services to be ready</span>
<a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a>
<a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a>            <span class="c1"># Get service URLs</span>
<a id="__codelineno-50-23" name="__codelineno-50-23" href="#__codelineno-50-23"></a>            <span class="n">customer_service_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://localhost:</span><span class="si">{</span><span class="n">compose</span><span class="o">.</span><span class="n">get_service_port</span><span class="p">(</span><span class="s1">&#39;customer-service&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">8000</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-50-24" name="__codelineno-50-24" href="#__codelineno-50-24"></a>
<a id="__codelineno-50-25" name="__codelineno-50-25" href="#__codelineno-50-25"></a>            <span class="k">yield</span> <span class="p">{</span>
<a id="__codelineno-50-26" name="__codelineno-50-26" href="#__codelineno-50-26"></a>                <span class="s2">&quot;customer_service&quot;</span><span class="p">:</span> <span class="n">customer_service_url</span>
<a id="__codelineno-50-27" name="__codelineno-50-27" href="#__codelineno-50-27"></a>            <span class="p">}</span>
<a id="__codelineno-50-28" name="__codelineno-50-28" href="#__codelineno-50-28"></a>
<a id="__codelineno-50-29" name="__codelineno-50-29" href="#__codelineno-50-29"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-50-30" name="__codelineno-50-30" href="#__codelineno-50-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_complete_customer_lifecycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_environment</span><span class="p">):</span>
<a id="__codelineno-50-31" name="__codelineno-50-31" href="#__codelineno-50-31"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test complete customer lifecycle end-to-end.&quot;&quot;&quot;</span>
<a id="__codelineno-50-32" name="__codelineno-50-32" href="#__codelineno-50-32"></a>        <span class="n">base_url</span> <span class="o">=</span> <span class="n">test_environment</span><span class="p">[</span><span class="s2">&quot;customer_service&quot;</span><span class="p">]</span>
<a id="__codelineno-50-33" name="__codelineno-50-33" href="#__codelineno-50-33"></a>
<a id="__codelineno-50-34" name="__codelineno-50-34" href="#__codelineno-50-34"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-50-35" name="__codelineno-50-35" href="#__codelineno-50-35"></a>            <span class="c1"># 1. Create customer</span>
<a id="__codelineno-50-36" name="__codelineno-50-36" href="#__codelineno-50-36"></a>            <span class="n">create_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-50-37" name="__codelineno-50-37" href="#__codelineno-50-37"></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;E2E Test Customer&quot;</span><span class="p">,</span>
<a id="__codelineno-50-38" name="__codelineno-50-38" href="#__codelineno-50-38"></a>                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;e2e-test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-50-39" name="__codelineno-50-39" href="#__codelineno-50-39"></a>                <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">,</span> <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-50-40" name="__codelineno-50-40" href="#__codelineno-50-40"></a>            <span class="p">})</span>
<a id="__codelineno-50-41" name="__codelineno-50-41" href="#__codelineno-50-41"></a>
<a id="__codelineno-50-42" name="__codelineno-50-42" href="#__codelineno-50-42"></a>            <span class="k">assert</span> <span class="n">create_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<a id="__codelineno-50-43" name="__codelineno-50-43" href="#__codelineno-50-43"></a>            <span class="n">customer_data</span> <span class="o">=</span> <span class="n">create_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-50-44" name="__codelineno-50-44" href="#__codelineno-50-44"></a>            <span class="n">customer_id</span> <span class="o">=</span> <span class="n">customer_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<a id="__codelineno-50-45" name="__codelineno-50-45" href="#__codelineno-50-45"></a>
<a id="__codelineno-50-46" name="__codelineno-50-46" href="#__codelineno-50-46"></a>            <span class="c1"># Verify customer created correctly</span>
<a id="__codelineno-50-47" name="__codelineno-50-47" href="#__codelineno-50-47"></a>            <span class="k">assert</span> <span class="n">customer_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;E2E Test Customer&quot;</span>
<a id="__codelineno-50-48" name="__codelineno-50-48" href="#__codelineno-50-48"></a>            <span class="k">assert</span> <span class="n">customer_data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;e2e-test@example.com&quot;</span>
<a id="__codelineno-50-49" name="__codelineno-50-49" href="#__codelineno-50-49"></a>            <span class="k">assert</span> <span class="n">customer_data</span><span class="p">[</span><span class="s2">&quot;is_active&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-50-50" name="__codelineno-50-50" href="#__codelineno-50-50"></a>            <span class="k">assert</span> <span class="n">customer_data</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">][</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dark&quot;</span>
<a id="__codelineno-50-51" name="__codelineno-50-51" href="#__codelineno-50-51"></a>
<a id="__codelineno-50-52" name="__codelineno-50-52" href="#__codelineno-50-52"></a>            <span class="c1"># 2. Retrieve customer</span>
<a id="__codelineno-50-53" name="__codelineno-50-53" href="#__codelineno-50-53"></a>            <span class="n">get_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/api/v1/customers/</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-50-54" name="__codelineno-50-54" href="#__codelineno-50-54"></a>
<a id="__codelineno-50-55" name="__codelineno-50-55" href="#__codelineno-50-55"></a>            <span class="k">assert</span> <span class="n">get_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-50-56" name="__codelineno-50-56" href="#__codelineno-50-56"></a>            <span class="n">retrieved_customer</span> <span class="o">=</span> <span class="n">get_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-50-57" name="__codelineno-50-57" href="#__codelineno-50-57"></a>            <span class="k">assert</span> <span class="n">retrieved_customer</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">customer_id</span>
<a id="__codelineno-50-58" name="__codelineno-50-58" href="#__codelineno-50-58"></a>            <span class="k">assert</span> <span class="n">retrieved_customer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;E2E Test Customer&quot;</span>
<a id="__codelineno-50-59" name="__codelineno-50-59" href="#__codelineno-50-59"></a>
<a id="__codelineno-50-60" name="__codelineno-50-60" href="#__codelineno-50-60"></a>            <span class="c1"># 3. Search for customer</span>
<a id="__codelineno-50-61" name="__codelineno-50-61" href="#__codelineno-50-61"></a>            <span class="n">search_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-50-62" name="__codelineno-50-62" href="#__codelineno-50-62"></a>                <span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span> 
<a id="__codelineno-50-63" name="__codelineno-50-63" href="#__codelineno-50-63"></a>                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;e2e-test&quot;</span><span class="p">}</span>
<a id="__codelineno-50-64" name="__codelineno-50-64" href="#__codelineno-50-64"></a>            <span class="p">)</span>
<a id="__codelineno-50-65" name="__codelineno-50-65" href="#__codelineno-50-65"></a>
<a id="__codelineno-50-66" name="__codelineno-50-66" href="#__codelineno-50-66"></a>            <span class="k">assert</span> <span class="n">search_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-50-67" name="__codelineno-50-67" href="#__codelineno-50-67"></a>            <span class="n">search_results</span> <span class="o">=</span> <span class="n">search_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-50-68" name="__codelineno-50-68" href="#__codelineno-50-68"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">search_results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<a id="__codelineno-50-69" name="__codelineno-50-69" href="#__codelineno-50-69"></a>
<a id="__codelineno-50-70" name="__codelineno-50-70" href="#__codelineno-50-70"></a>            <span class="c1"># Find our customer in results</span>
<a id="__codelineno-50-71" name="__codelineno-50-71" href="#__codelineno-50-71"></a>            <span class="n">found_customer</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
<a id="__codelineno-50-72" name="__codelineno-50-72" href="#__codelineno-50-72"></a>                <span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">search_results</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">customer_id</span><span class="p">),</span> 
<a id="__codelineno-50-73" name="__codelineno-50-73" href="#__codelineno-50-73"></a>                <span class="kc">None</span>
<a id="__codelineno-50-74" name="__codelineno-50-74" href="#__codelineno-50-74"></a>            <span class="p">)</span>
<a id="__codelineno-50-75" name="__codelineno-50-75" href="#__codelineno-50-75"></a>            <span class="k">assert</span> <span class="n">found_customer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-50-76" name="__codelineno-50-76" href="#__codelineno-50-76"></a>
<a id="__codelineno-50-77" name="__codelineno-50-77" href="#__codelineno-50-77"></a>            <span class="c1"># 4. Update customer preferences</span>
<a id="__codelineno-50-78" name="__codelineno-50-78" href="#__codelineno-50-78"></a>            <span class="n">update_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
<a id="__codelineno-50-79" name="__codelineno-50-79" href="#__codelineno-50-79"></a>                <span class="sa">f</span><span class="s2">&quot;/api/v1/customers/</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
<a id="__codelineno-50-80" name="__codelineno-50-80" href="#__codelineno-50-80"></a>                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-50-81" name="__codelineno-50-81" href="#__codelineno-50-81"></a>                    <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;light&quot;</span><span class="p">,</span> <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<a id="__codelineno-50-82" name="__codelineno-50-82" href="#__codelineno-50-82"></a>                <span class="p">}</span>
<a id="__codelineno-50-83" name="__codelineno-50-83" href="#__codelineno-50-83"></a>            <span class="p">)</span>
<a id="__codelineno-50-84" name="__codelineno-50-84" href="#__codelineno-50-84"></a>
<a id="__codelineno-50-85" name="__codelineno-50-85" href="#__codelineno-50-85"></a>            <span class="k">assert</span> <span class="n">update_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-50-86" name="__codelineno-50-86" href="#__codelineno-50-86"></a>            <span class="n">updated_customer</span> <span class="o">=</span> <span class="n">update_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-50-87" name="__codelineno-50-87" href="#__codelineno-50-87"></a>            <span class="k">assert</span> <span class="n">updated_customer</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">][</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;light&quot;</span>
<a id="__codelineno-50-88" name="__codelineno-50-88" href="#__codelineno-50-88"></a>            <span class="k">assert</span> <span class="n">updated_customer</span><span class="p">[</span><span class="s2">&quot;preferences&quot;</span><span class="p">][</span><span class="s2">&quot;newsletter&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
<a id="__codelineno-50-89" name="__codelineno-50-89" href="#__codelineno-50-89"></a>
<a id="__codelineno-50-90" name="__codelineno-50-90" href="#__codelineno-50-90"></a>            <span class="c1"># 5. Deactivate customer</span>
<a id="__codelineno-50-91" name="__codelineno-50-91" href="#__codelineno-50-91"></a>            <span class="n">deactivate_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-50-92" name="__codelineno-50-92" href="#__codelineno-50-92"></a>                <span class="sa">f</span><span class="s2">&quot;/api/v1/customers/</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">/deactivate&quot;</span><span class="p">,</span>
<a id="__codelineno-50-93" name="__codelineno-50-93" href="#__codelineno-50-93"></a>                <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;E2E test cleanup&quot;</span><span class="p">}</span>
<a id="__codelineno-50-94" name="__codelineno-50-94" href="#__codelineno-50-94"></a>            <span class="p">)</span>
<a id="__codelineno-50-95" name="__codelineno-50-95" href="#__codelineno-50-95"></a>
<a id="__codelineno-50-96" name="__codelineno-50-96" href="#__codelineno-50-96"></a>            <span class="k">assert</span> <span class="n">deactivate_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-50-97" name="__codelineno-50-97" href="#__codelineno-50-97"></a>            <span class="n">deactivated_customer</span> <span class="o">=</span> <span class="n">deactivate_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-50-98" name="__codelineno-50-98" href="#__codelineno-50-98"></a>            <span class="k">assert</span> <span class="n">deactivated_customer</span><span class="p">[</span><span class="s2">&quot;is_active&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
<a id="__codelineno-50-99" name="__codelineno-50-99" href="#__codelineno-50-99"></a>
<a id="__codelineno-50-100" name="__codelineno-50-100" href="#__codelineno-50-100"></a>            <span class="c1"># 6. Verify deactivated customer not in active search</span>
<a id="__codelineno-50-101" name="__codelineno-50-101" href="#__codelineno-50-101"></a>            <span class="n">active_search_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-50-102" name="__codelineno-50-102" href="#__codelineno-50-102"></a>                <span class="s2">&quot;/api/v1/customers/&quot;</span><span class="p">,</span>
<a id="__codelineno-50-103" name="__codelineno-50-103" href="#__codelineno-50-103"></a>                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;active_only&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-50-104" name="__codelineno-50-104" href="#__codelineno-50-104"></a>            <span class="p">)</span>
<a id="__codelineno-50-105" name="__codelineno-50-105" href="#__codelineno-50-105"></a>
<a id="__codelineno-50-106" name="__codelineno-50-106" href="#__codelineno-50-106"></a>            <span class="k">assert</span> <span class="n">active_search_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-50-107" name="__codelineno-50-107" href="#__codelineno-50-107"></a>            <span class="n">active_customers</span> <span class="o">=</span> <span class="n">active_search_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-50-108" name="__codelineno-50-108" href="#__codelineno-50-108"></a>
<a id="__codelineno-50-109" name="__codelineno-50-109" href="#__codelineno-50-109"></a>            <span class="c1"># Our deactivated customer should not be in active results</span>
<a id="__codelineno-50-110" name="__codelineno-50-110" href="#__codelineno-50-110"></a>            <span class="n">deactivated_found</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
<a id="__codelineno-50-111" name="__codelineno-50-111" href="#__codelineno-50-111"></a>                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">customer_id</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">active_customers</span>
<a id="__codelineno-50-112" name="__codelineno-50-112" href="#__codelineno-50-112"></a>            <span class="p">)</span>
<a id="__codelineno-50-113" name="__codelineno-50-113" href="#__codelineno-50-113"></a>            <span class="k">assert</span> <span class="n">deactivated_found</span> <span class="ow">is</span> <span class="kc">False</span>
<a id="__codelineno-50-114" name="__codelineno-50-114" href="#__codelineno-50-114"></a>
<a id="__codelineno-50-115" name="__codelineno-50-115" href="#__codelineno-50-115"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<a id="__codelineno-50-116" name="__codelineno-50-116" href="#__codelineno-50-116"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_customer_order_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_environment</span><span class="p">):</span>
<a id="__codelineno-50-117" name="__codelineno-50-117" href="#__codelineno-50-117"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test customer and order service integration.&quot;&quot;&quot;</span>
<a id="__codelineno-50-118" name="__codelineno-50-118" href="#__codelineno-50-118"></a>        <span class="n">customer_base_url</span> <span class="o">=</span> <span class="n">test_environment</span><span class="p">[</span><span class="s2">&quot;customer_service&quot;</span><span class="p">]</span>
<a id="__codelineno-50-119" name="__codelineno-50-119" href="#__codelineno-50-119"></a>        <span class="n">order_base_url</span> <span class="o">=</span> <span class="n">test_environment</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order_service&quot;</span><span class="p">,</span> <span class="n">customer_base_url</span><span class="p">)</span>
<a id="__codelineno-50-120" name="__codelineno-50-120" href="#__codelineno-50-120"></a>
<a id="__codelineno-50-121" name="__codelineno-50-121" href="#__codelineno-50-121"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-50-122" name="__codelineno-50-122" href="#__codelineno-50-122"></a>            <span class="c1"># 1. Create customer</span>
<a id="__codelineno-50-123" name="__codelineno-50-123" href="#__codelineno-50-123"></a>            <span class="n">customer_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-50-124" name="__codelineno-50-124" href="#__codelineno-50-124"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">customer_base_url</span><span class="si">}</span><span class="s2">/api/v1/customers/&quot;</span><span class="p">,</span>
<a id="__codelineno-50-125" name="__codelineno-50-125" href="#__codelineno-50-125"></a>                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-50-126" name="__codelineno-50-126" href="#__codelineno-50-126"></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Order Test Customer&quot;</span><span class="p">,</span>
<a id="__codelineno-50-127" name="__codelineno-50-127" href="#__codelineno-50-127"></a>                    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;order-test@example.com&quot;</span>
<a id="__codelineno-50-128" name="__codelineno-50-128" href="#__codelineno-50-128"></a>                <span class="p">}</span>
<a id="__codelineno-50-129" name="__codelineno-50-129" href="#__codelineno-50-129"></a>            <span class="p">)</span>
<a id="__codelineno-50-130" name="__codelineno-50-130" href="#__codelineno-50-130"></a>
<a id="__codelineno-50-131" name="__codelineno-50-131" href="#__codelineno-50-131"></a>            <span class="k">assert</span> <span class="n">customer_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<a id="__codelineno-50-132" name="__codelineno-50-132" href="#__codelineno-50-132"></a>            <span class="n">customer_id</span> <span class="o">=</span> <span class="n">customer_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<a id="__codelineno-50-133" name="__codelineno-50-133" href="#__codelineno-50-133"></a>
<a id="__codelineno-50-134" name="__codelineno-50-134" href="#__codelineno-50-134"></a>            <span class="c1"># 2. Create order for customer</span>
<a id="__codelineno-50-135" name="__codelineno-50-135" href="#__codelineno-50-135"></a>            <span class="n">order_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-50-136" name="__codelineno-50-136" href="#__codelineno-50-136"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">order_base_url</span><span class="si">}</span><span class="s2">/api/v1/orders/&quot;</span><span class="p">,</span>
<a id="__codelineno-50-137" name="__codelineno-50-137" href="#__codelineno-50-137"></a>                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-50-138" name="__codelineno-50-138" href="#__codelineno-50-138"></a>                    <span class="s2">&quot;customer_id&quot;</span><span class="p">:</span> <span class="n">customer_id</span><span class="p">,</span>
<a id="__codelineno-50-139" name="__codelineno-50-139" href="#__codelineno-50-139"></a>                    <span class="s2">&quot;total_amount&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="s2">&quot;99.99&quot;</span><span class="p">,</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="s2">&quot;USD&quot;</span><span class="p">},</span>
<a id="__codelineno-50-140" name="__codelineno-50-140" href="#__codelineno-50-140"></a>                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-50-141" name="__codelineno-50-141" href="#__codelineno-50-141"></a>                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-50-142" name="__codelineno-50-142" href="#__codelineno-50-142"></a>                            <span class="p">{</span><span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="s2">&quot;Test Product&quot;</span><span class="p">,</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="s2">&quot;99.99&quot;</span><span class="p">}</span>
<a id="__codelineno-50-143" name="__codelineno-50-143" href="#__codelineno-50-143"></a>                        <span class="p">]</span>
<a id="__codelineno-50-144" name="__codelineno-50-144" href="#__codelineno-50-144"></a>                    <span class="p">}</span>
<a id="__codelineno-50-145" name="__codelineno-50-145" href="#__codelineno-50-145"></a>                <span class="p">}</span>
<a id="__codelineno-50-146" name="__codelineno-50-146" href="#__codelineno-50-146"></a>            <span class="p">)</span>
<a id="__codelineno-50-147" name="__codelineno-50-147" href="#__codelineno-50-147"></a>
<a id="__codelineno-50-148" name="__codelineno-50-148" href="#__codelineno-50-148"></a>            <span class="k">assert</span> <span class="n">order_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
<a id="__codelineno-50-149" name="__codelineno-50-149" href="#__codelineno-50-149"></a>            <span class="n">order_data</span> <span class="o">=</span> <span class="n">order_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-50-150" name="__codelineno-50-150" href="#__codelineno-50-150"></a>            <span class="n">order_id</span> <span class="o">=</span> <span class="n">order_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<a id="__codelineno-50-151" name="__codelineno-50-151" href="#__codelineno-50-151"></a>
<a id="__codelineno-50-152" name="__codelineno-50-152" href="#__codelineno-50-152"></a>            <span class="c1"># 3. Get customer orders</span>
<a id="__codelineno-50-153" name="__codelineno-50-153" href="#__codelineno-50-153"></a>            <span class="n">customer_orders_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-50-154" name="__codelineno-50-154" href="#__codelineno-50-154"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">order_base_url</span><span class="si">}</span><span class="s2">/api/v1/customers/</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">/orders&quot;</span>
<a id="__codelineno-50-155" name="__codelineno-50-155" href="#__codelineno-50-155"></a>            <span class="p">)</span>
<a id="__codelineno-50-156" name="__codelineno-50-156" href="#__codelineno-50-156"></a>
<a id="__codelineno-50-157" name="__codelineno-50-157" href="#__codelineno-50-157"></a>            <span class="k">assert</span> <span class="n">customer_orders_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-50-158" name="__codelineno-50-158" href="#__codelineno-50-158"></a>            <span class="n">customer_orders</span> <span class="o">=</span> <span class="n">customer_orders_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-50-159" name="__codelineno-50-159" href="#__codelineno-50-159"></a>            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">customer_orders</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<a id="__codelineno-50-160" name="__codelineno-50-160" href="#__codelineno-50-160"></a>
<a id="__codelineno-50-161" name="__codelineno-50-161" href="#__codelineno-50-161"></a>            <span class="c1"># Find our order</span>
<a id="__codelineno-50-162" name="__codelineno-50-162" href="#__codelineno-50-162"></a>            <span class="n">found_order</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
<a id="__codelineno-50-163" name="__codelineno-50-163" href="#__codelineno-50-163"></a>                <span class="p">(</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">customer_orders</span> <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order_id</span><span class="p">),</span>
<a id="__codelineno-50-164" name="__codelineno-50-164" href="#__codelineno-50-164"></a>                <span class="kc">None</span>
<a id="__codelineno-50-165" name="__codelineno-50-165" href="#__codelineno-50-165"></a>            <span class="p">)</span>
<a id="__codelineno-50-166" name="__codelineno-50-166" href="#__codelineno-50-166"></a>            <span class="k">assert</span> <span class="n">found_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-50-167" name="__codelineno-50-167" href="#__codelineno-50-167"></a>            <span class="k">assert</span> <span class="n">found_order</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">customer_id</span>
</code></pre></div>
<h3 id="test-data-management"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#test-data-management">Test Data Management</a></h3>
<p>Effective testing requires proper test data management:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1"># tests/factories/customer_factory.py</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">Factory</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">SubFactory</span><span class="p">,</span> <span class="n">LazyFunction</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">factory.fuzzy</span><span class="w"> </span><span class="kn">import</span> <span class="n">FuzzyChoice</span><span class="p">,</span> <span class="n">FuzzyDecimal</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.domain.entities.customer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Customer</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.shared_kernel</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="n">Money</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">AddressFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating test addresses.&quot;&quot;&quot;</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">Address</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>    <span class="n">street</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> Test Street&quot;</span><span class="p">)</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>    <span class="n">city</span> <span class="o">=</span> <span class="n">FuzzyChoice</span><span class="p">([</span><span class="s2">&quot;New York&quot;</span><span class="p">,</span> <span class="s2">&quot;Los Angeles&quot;</span><span class="p">,</span> <span class="s2">&quot;Chicago&quot;</span><span class="p">,</span> <span class="s2">&quot;Houston&quot;</span><span class="p">])</span>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">FuzzyChoice</span><span class="p">([</span><span class="s2">&quot;NY&quot;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;IL&quot;</span><span class="p">,</span> <span class="s2">&quot;TX&quot;</span><span class="p">])</span>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a>    <span class="n">postal_code</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a>    <span class="n">country</span> <span class="o">=</span> <span class="s2">&quot;USA&quot;</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>    <span class="n">apartment</span> <span class="o">=</span> <span class="n">FuzzyChoice</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;1A&quot;</span><span class="p">,</span> <span class="s2">&quot;2B&quot;</span><span class="p">,</span> <span class="s2">&quot;3C&quot;</span><span class="p">])</span>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">EmailFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating test emails.&quot;&quot;&quot;</span>
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a>
<a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
<a id="__codelineno-51-27" name="__codelineno-51-27" href="#__codelineno-51-27"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">Email</span>
<a id="__codelineno-51-28" name="__codelineno-51-28" href="#__codelineno-51-28"></a>
<a id="__codelineno-51-29" name="__codelineno-51-29" href="#__codelineno-51-29"></a>    <span class="n">value</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;test-user-</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">)</span>
<a id="__codelineno-51-30" name="__codelineno-51-30" href="#__codelineno-51-30"></a>
<a id="__codelineno-51-31" name="__codelineno-51-31" href="#__codelineno-51-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">MoneyFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
<a id="__codelineno-51-32" name="__codelineno-51-32" href="#__codelineno-51-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating test money values.&quot;&quot;&quot;</span>
<a id="__codelineno-51-33" name="__codelineno-51-33" href="#__codelineno-51-33"></a>
<a id="__codelineno-51-34" name="__codelineno-51-34" href="#__codelineno-51-34"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
<a id="__codelineno-51-35" name="__codelineno-51-35" href="#__codelineno-51-35"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">Money</span>
<a id="__codelineno-51-36" name="__codelineno-51-36" href="#__codelineno-51-36"></a>
<a id="__codelineno-51-37" name="__codelineno-51-37" href="#__codelineno-51-37"></a>    <span class="n">amount</span> <span class="o">=</span> <span class="n">FuzzyDecimal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-51-38" name="__codelineno-51-38" href="#__codelineno-51-38"></a>    <span class="n">currency</span> <span class="o">=</span> <span class="n">FuzzyChoice</span><span class="p">([</span><span class="s2">&quot;USD&quot;</span><span class="p">,</span> <span class="s2">&quot;EUR&quot;</span><span class="p">,</span> <span class="s2">&quot;GBP&quot;</span><span class="p">])</span>
<a id="__codelineno-51-39" name="__codelineno-51-39" href="#__codelineno-51-39"></a>
<a id="__codelineno-51-40" name="__codelineno-51-40" href="#__codelineno-51-40"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerFactory</span><span class="p">(</span><span class="n">Factory</span><span class="p">):</span>
<a id="__codelineno-51-41" name="__codelineno-51-41" href="#__codelineno-51-41"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating test customers.&quot;&quot;&quot;</span>
<a id="__codelineno-51-42" name="__codelineno-51-42" href="#__codelineno-51-42"></a>
<a id="__codelineno-51-43" name="__codelineno-51-43" href="#__codelineno-51-43"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
<a id="__codelineno-51-44" name="__codelineno-51-44" href="#__codelineno-51-44"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">Customer</span>
<a id="__codelineno-51-45" name="__codelineno-51-45" href="#__codelineno-51-45"></a>
<a id="__codelineno-51-46" name="__codelineno-51-46" href="#__codelineno-51-46"></a>    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">LazyFunction</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">CustomerId</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
<a id="__codelineno-51-47" name="__codelineno-51-47" href="#__codelineno-51-47"></a>    <span class="n">name</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Test Customer </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-51-48" name="__codelineno-51-48" href="#__codelineno-51-48"></a>    <span class="n">email</span> <span class="o">=</span> <span class="n">SubFactory</span><span class="p">(</span><span class="n">EmailFactory</span><span class="p">)</span>
<a id="__codelineno-51-49" name="__codelineno-51-49" href="#__codelineno-51-49"></a>    <span class="n">address</span> <span class="o">=</span> <span class="n">SubFactory</span><span class="p">(</span><span class="n">AddressFactory</span><span class="p">)</span>
<a id="__codelineno-51-50" name="__codelineno-51-50" href="#__codelineno-51-50"></a>    <span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-51-51" name="__codelineno-51-51" href="#__codelineno-51-51"></a>    <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;light&quot;</span><span class="p">,</span> <span class="s2">&quot;newsletter&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
<a id="__codelineno-51-52" name="__codelineno-51-52" href="#__codelineno-51-52"></a>
<a id="__codelineno-51-53" name="__codelineno-51-53" href="#__codelineno-51-53"></a><span class="c1"># Usage in tests</span>
<a id="__codelineno-51-54" name="__codelineno-51-54" href="#__codelineno-51-54"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_customer_with_factory</span><span class="p">():</span>
<a id="__codelineno-51-55" name="__codelineno-51-55" href="#__codelineno-51-55"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test using factory-created customer.&quot;&quot;&quot;</span>
<a id="__codelineno-51-56" name="__codelineno-51-56" href="#__codelineno-51-56"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">CustomerFactory</span><span class="p">()</span>
<a id="__codelineno-51-57" name="__codelineno-51-57" href="#__codelineno-51-57"></a>
<a id="__codelineno-51-58" name="__codelineno-51-58" href="#__codelineno-51-58"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Test Customer&quot;</span><span class="p">)</span>
<a id="__codelineno-51-59" name="__codelineno-51-59" href="#__codelineno-51-59"></a>    <span class="k">assert</span> <span class="s2">&quot;@example.com&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<a id="__codelineno-51-60" name="__codelineno-51-60" href="#__codelineno-51-60"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">is</span> <span class="kc">True</span>
<a id="__codelineno-51-61" name="__codelineno-51-61" href="#__codelineno-51-61"></a>
<a id="__codelineno-51-62" name="__codelineno-51-62" href="#__codelineno-51-62"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_customer_with_custom_attributes</span><span class="p">():</span>
<a id="__codelineno-51-63" name="__codelineno-51-63" href="#__codelineno-51-63"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test factory with custom attributes.&quot;&quot;&quot;</span>
<a id="__codelineno-51-64" name="__codelineno-51-64" href="#__codelineno-51-64"></a>    <span class="n">customer</span> <span class="o">=</span> <span class="n">CustomerFactory</span><span class="p">(</span>
<a id="__codelineno-51-65" name="__codelineno-51-65" href="#__codelineno-51-65"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Custom Customer&quot;</span><span class="p">,</span>
<a id="__codelineno-51-66" name="__codelineno-51-66" href="#__codelineno-51-66"></a>        <span class="n">preferences</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;dark&quot;</span><span class="p">}</span>
<a id="__codelineno-51-67" name="__codelineno-51-67" href="#__codelineno-51-67"></a>    <span class="p">)</span>
<a id="__codelineno-51-68" name="__codelineno-51-68" href="#__codelineno-51-68"></a>
<a id="__codelineno-51-69" name="__codelineno-51-69" href="#__codelineno-51-69"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Custom Customer&quot;</span>
<a id="__codelineno-51-70" name="__codelineno-51-70" href="#__codelineno-51-70"></a>    <span class="k">assert</span> <span class="n">customer</span><span class="o">.</span><span class="n">preferences</span><span class="p">[</span><span class="s2">&quot;theme&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dark&quot;</span>
<a id="__codelineno-51-71" name="__codelineno-51-71" href="#__codelineno-51-71"></a>
<a id="__codelineno-51-72" name="__codelineno-51-72" href="#__codelineno-51-72"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_customers</span><span class="p">():</span>
<a id="__codelineno-51-73" name="__codelineno-51-73" href="#__codelineno-51-73"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Test creating multiple customers.&quot;&quot;&quot;</span>
<a id="__codelineno-51-74" name="__codelineno-51-74" href="#__codelineno-51-74"></a>    <span class="n">customers</span> <span class="o">=</span> <span class="n">CustomerFactory</span><span class="o">.</span><span class="n">create_batch</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-51-75" name="__codelineno-51-75" href="#__codelineno-51-75"></a>
<a id="__codelineno-51-76" name="__codelineno-51-76" href="#__codelineno-51-76"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">customers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
<a id="__codelineno-51-77" name="__codelineno-51-77" href="#__codelineno-51-77"></a>    <span class="c1"># All should have unique emails</span>
<a id="__codelineno-51-78" name="__codelineno-51-78" href="#__codelineno-51-78"></a>    <span class="n">emails</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">customers</span><span class="p">]</span>
<a id="__codelineno-51-79" name="__codelineno-51-79" href="#__codelineno-51-79"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">emails</span><span class="p">))</span> <span class="o">==</span> <span class="mi">5</span>
</code></pre></div>
<h3 id="testing-configuration-and-best-practices"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#testing-configuration-and-best-practices">Testing Configuration and Best Practices</a></h3>
<h4 id="pytest-configuration"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#pytest-configuration">Pytest Configuration</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1"># pytest.ini</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="k">[tool:pytest]</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="na">minversion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">6.0</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="na">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="w">    </span><span class="na">-v</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">    </span><span class="na">--strict-markers</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">    </span><span class="na">--strict-config</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">    </span><span class="na">--cov</span><span class="o">=</span><span class="s">src</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="w">    </span><span class="na">--cov-report</span><span class="o">=</span><span class="s">term-missing</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">    </span><span class="na">--cov-report</span><span class="o">=</span><span class="s">html</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">    </span><span class="na">--cov-fail-under</span><span class="o">=</span><span class="s">80</span>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="na">testpaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">tests</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="na">markers</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="w">    </span><span class="na">unit</span><span class="o">:</span><span class="w"> </span><span class="s">Unit tests</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="w">    </span><span class="na">integration</span><span class="o">:</span><span class="w"> </span><span class="s">Integration tests</span><span class="w">  </span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="w">    </span><span class="na">component</span><span class="o">:</span><span class="w"> </span><span class="s">Component tests</span>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="w">    </span><span class="na">e2e</span><span class="o">:</span><span class="w"> </span><span class="s">End-to-end tests</span>
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a><span class="w">    </span><span class="na">slow</span><span class="o">:</span><span class="w"> </span><span class="s">Slow running tests</span>
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a><span class="w">    </span><span class="na">contract</span><span class="o">:</span><span class="w"> </span><span class="s">Contract tests</span>
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a><span class="na">asyncio_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">auto</span>
</code></pre></div>
<h4 id="test-organization"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#test-organization">Test Organization</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1"># conftest.py - Shared test configuration</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncGenerator</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">event_loop</span><span class="p">():</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create event loop for async tests.&quot;&quot;&quot;</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop_policy</span><span class="p">()</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>    <span class="k">yield</span> <span class="n">loop</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">clean_database</span><span class="p">():</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure clean database state for each test.&quot;&quot;&quot;</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>    <span class="c1"># Setup</span>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>    <span class="k">await</span> <span class="n">cleanup_test_data</span><span class="p">()</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>    <span class="k">yield</span>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a>    <span class="c1"># Teardown</span>
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>    <span class="k">await</span> <span class="n">cleanup_test_data</span><span class="p">()</span>
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a>
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">mock_external_services</span><span class="p">():</span>
<a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mock all external service dependencies.&quot;&quot;&quot;</span>
<a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.infrastructure.services.payment_service&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">payment_mock</span><span class="p">,</span> \
<a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a>         <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;src.infrastructure.services.email_service&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">email_mock</span><span class="p">:</span>
<a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a>
<a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a>        <span class="n">payment_mock</span><span class="o">.</span><span class="n">charge</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_123&quot;</span><span class="p">}</span>
<a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a>        <span class="n">email_mock</span><span class="o">.</span><span class="n">send_email</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a>
<a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a>        <span class="k">yield</span> <span class="p">{</span>
<a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a>            <span class="s2">&quot;payment&quot;</span><span class="p">:</span> <span class="n">payment_mock</span><span class="p">,</span>
<a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email_mock</span>
<a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a>        <span class="p">}</span>
</code></pre></div>
<h4 id="performance-testing"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#performance-testing">Performance Testing</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="c1"># tests/performance/test_customer_performance.py</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestCustomerPerformance</span><span class="p">:</span>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Performance tests for customer operations.&quot;&quot;&quot;</span>
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_customer_creation_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">):</span>
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test customer creation performance under load.&quot;&quot;&quot;</span>
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a>
<a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a>        <span class="c1"># Create 100 customers concurrently</span>
<a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a>        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
<a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a>            <span class="n">customer</span> <span class="o">=</span> <span class="n">CustomerFactory</span><span class="p">()</span>
<a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a>            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">))</span>
<a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a>
<a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a>        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a>
<a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a>
<a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a>        <span class="c1"># Verify performance</span>
<a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a>        <span class="k">assert</span> <span class="n">duration</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Customer creation took </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2">s, expected &lt; 5s&quot;</span>
<a id="__codelineno-54-28" name="__codelineno-54-28" href="#__codelineno-54-28"></a>
<a id="__codelineno-54-29" name="__codelineno-54-29" href="#__codelineno-54-29"></a>        <span class="c1"># Verify all succeeded</span>
<a id="__codelineno-54-30" name="__codelineno-54-30" href="#__codelineno-54-30"></a>        <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)]</span>
<a id="__codelineno-54-31" name="__codelineno-54-31" href="#__codelineno-54-31"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Had </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2"> errors during creation&quot;</span>
<a id="__codelineno-54-32" name="__codelineno-54-32" href="#__codelineno-54-32"></a>
<a id="__codelineno-54-33" name="__codelineno-54-33" href="#__codelineno-54-33"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<a id="__codelineno-54-34" name="__codelineno-54-34" href="#__codelineno-54-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_customer_search_performance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository</span><span class="p">):</span>
<a id="__codelineno-54-35" name="__codelineno-54-35" href="#__codelineno-54-35"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test customer search performance.&quot;&quot;&quot;</span>
<a id="__codelineno-54-36" name="__codelineno-54-36" href="#__codelineno-54-36"></a>        <span class="c1"># Setup: Create many customers</span>
<a id="__codelineno-54-37" name="__codelineno-54-37" href="#__codelineno-54-37"></a>        <span class="n">customers</span> <span class="o">=</span> <span class="n">CustomerFactory</span><span class="o">.</span><span class="n">create_batch</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<a id="__codelineno-54-38" name="__codelineno-54-38" href="#__codelineno-54-38"></a>        <span class="k">for</span> <span class="n">customer</span> <span class="ow">in</span> <span class="n">customers</span><span class="p">:</span>
<a id="__codelineno-54-39" name="__codelineno-54-39" href="#__codelineno-54-39"></a>            <span class="n">repository</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
<a id="__codelineno-54-40" name="__codelineno-54-40" href="#__codelineno-54-40"></a>
<a id="__codelineno-54-41" name="__codelineno-54-41" href="#__codelineno-54-41"></a>        <span class="c1"># Test search performance</span>
<a id="__codelineno-54-42" name="__codelineno-54-42" href="#__codelineno-54-42"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-54-43" name="__codelineno-54-43" href="#__codelineno-54-43"></a>
<a id="__codelineno-54-44" name="__codelineno-54-44" href="#__codelineno-54-44"></a>        <span class="c1"># Perform 100 searches</span>
<a id="__codelineno-54-45" name="__codelineno-54-45" href="#__codelineno-54-45"></a>        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
<a id="__codelineno-54-46" name="__codelineno-54-46" href="#__codelineno-54-46"></a>            <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-54-47" name="__codelineno-54-47" href="#__codelineno-54-47"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
<a id="__codelineno-54-48" name="__codelineno-54-48" href="#__codelineno-54-48"></a>                <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">find_all_active</span><span class="p">)</span>
<a id="__codelineno-54-49" name="__codelineno-54-49" href="#__codelineno-54-49"></a>                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<a id="__codelineno-54-50" name="__codelineno-54-50" href="#__codelineno-54-50"></a>
<a id="__codelineno-54-51" name="__codelineno-54-51" href="#__codelineno-54-51"></a>            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
<a id="__codelineno-54-52" name="__codelineno-54-52" href="#__codelineno-54-52"></a>
<a id="__codelineno-54-53" name="__codelineno-54-53" href="#__codelineno-54-53"></a>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-54-54" name="__codelineno-54-54" href="#__codelineno-54-54"></a>        <span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-54-55" name="__codelineno-54-55" href="#__codelineno-54-55"></a>
<a id="__codelineno-54-56" name="__codelineno-54-56" href="#__codelineno-54-56"></a>        <span class="c1"># Verify performance</span>
<a id="__codelineno-54-57" name="__codelineno-54-57" href="#__codelineno-54-57"></a>        <span class="k">assert</span> <span class="n">duration</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Search operations took </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2">s, expected &lt; 10s&quot;</span>
<a id="__codelineno-54-58" name="__codelineno-54-58" href="#__codelineno-54-58"></a>
<a id="__codelineno-54-59" name="__codelineno-54-59" href="#__codelineno-54-59"></a>        <span class="c1"># Verify results</span>
<a id="__codelineno-54-60" name="__codelineno-54-60" href="#__codelineno-54-60"></a>        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1000</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div>
<h3 id="continuous-testing-strategy"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#continuous-testing-strategy">Continuous Testing Strategy</a></h3>
<h4 id="github-actions-workflow"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#github-actions-workflow">GitHub Actions Workflow</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># .github/workflows/test.yml</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Test Suite</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="nt">on</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">push</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">pull_request</span><span class="p p-Indicator">]</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="nt">jobs</span><span class="p">:</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="w">  </span><span class="nt">unit-tests</span><span class="p">:</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="w">          </span><span class="no">pip install -r requirements.txt</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="w">          </span><span class="no">pip install -r requirements-dev.txt</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run unit tests</span>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/unit -m &quot;not slow&quot; --cov=src --cov-report=xml</span>
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upload coverage</span>
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">codecov/codecov-action@v3</span>
<a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a>
<a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a><span class="w">  </span><span class="nt">integration-tests</span><span class="p">:</span>
<a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a><span class="w">    </span><span class="nt">services</span><span class="p">:</span>
<a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a><span class="w">      </span><span class="nt">postgres</span><span class="p">:</span>
<a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15</span>
<a id="__codelineno-55-27" name="__codelineno-55-27" href="#__codelineno-55-27"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-55-28" name="__codelineno-55-28" href="#__codelineno-55-28"></a><span class="w">          </span><span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span>
<a id="__codelineno-55-29" name="__codelineno-55-29" href="#__codelineno-55-29"></a><span class="w">        </span><span class="nt">options</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
<a id="__codelineno-55-30" name="__codelineno-55-30" href="#__codelineno-55-30"></a><span class="w">          </span><span class="no">--health-cmd pg_isready</span>
<a id="__codelineno-55-31" name="__codelineno-55-31" href="#__codelineno-55-31"></a><span class="w">          </span><span class="no">--health-interval 10s</span>
<a id="__codelineno-55-32" name="__codelineno-55-32" href="#__codelineno-55-32"></a><span class="w">          </span><span class="no">--health-timeout 5s</span>
<a id="__codelineno-55-33" name="__codelineno-55-33" href="#__codelineno-55-33"></a><span class="w">          </span><span class="no">--health-retries 5</span>
<a id="__codelineno-55-34" name="__codelineno-55-34" href="#__codelineno-55-34"></a><span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<a id="__codelineno-55-35" name="__codelineno-55-35" href="#__codelineno-55-35"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>
<a id="__codelineno-55-36" name="__codelineno-55-36" href="#__codelineno-55-36"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<a id="__codelineno-55-37" name="__codelineno-55-37" href="#__codelineno-55-37"></a><span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<a id="__codelineno-55-38" name="__codelineno-55-38" href="#__codelineno-55-38"></a><span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span>
<a id="__codelineno-55-39" name="__codelineno-55-39" href="#__codelineno-55-39"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<a id="__codelineno-55-40" name="__codelineno-55-40" href="#__codelineno-55-40"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-55-41" name="__codelineno-55-41" href="#__codelineno-55-41"></a><span class="w">          </span><span class="no">pip install -r requirements.txt</span>
<a id="__codelineno-55-42" name="__codelineno-55-42" href="#__codelineno-55-42"></a><span class="w">          </span><span class="no">pip install -r requirements-dev.txt</span>
<a id="__codelineno-55-43" name="__codelineno-55-43" href="#__codelineno-55-43"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run integration tests</span>
<a id="__codelineno-55-44" name="__codelineno-55-44" href="#__codelineno-55-44"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/integration</span>
<a id="__codelineno-55-45" name="__codelineno-55-45" href="#__codelineno-55-45"></a><span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-55-46" name="__codelineno-55-46" href="#__codelineno-55-46"></a><span class="w">          </span><span class="nt">DATABASE_URL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql://postgres:test@localhost:5432/test</span>
<a id="__codelineno-55-47" name="__codelineno-55-47" href="#__codelineno-55-47"></a>
<a id="__codelineno-55-48" name="__codelineno-55-48" href="#__codelineno-55-48"></a><span class="w">  </span><span class="nt">component-tests</span><span class="p">:</span>
<a id="__codelineno-55-49" name="__codelineno-55-49" href="#__codelineno-55-49"></a><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a id="__codelineno-55-50" name="__codelineno-55-50" href="#__codelineno-55-50"></a><span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<a id="__codelineno-55-51" name="__codelineno-55-51" href="#__codelineno-55-51"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>
<a id="__codelineno-55-52" name="__codelineno-55-52" href="#__codelineno-55-52"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v4</span>
<a id="__codelineno-55-53" name="__codelineno-55-53" href="#__codelineno-55-53"></a><span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<a id="__codelineno-55-54" name="__codelineno-55-54" href="#__codelineno-55-54"></a><span class="w">          </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.11&#39;</span>
<a id="__codelineno-55-55" name="__codelineno-55-55" href="#__codelineno-55-55"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
<a id="__codelineno-55-56" name="__codelineno-55-56" href="#__codelineno-55-56"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-55-57" name="__codelineno-55-57" href="#__codelineno-55-57"></a><span class="w">          </span><span class="no">pip install -r requirements.txt</span>
<a id="__codelineno-55-58" name="__codelineno-55-58" href="#__codelineno-55-58"></a><span class="w">          </span><span class="no">pip install -r requirements-dev.txt</span>
<a id="__codelineno-55-59" name="__codelineno-55-59" href="#__codelineno-55-59"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run component tests</span>
<a id="__codelineno-55-60" name="__codelineno-55-60" href="#__codelineno-55-60"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pytest tests/component</span>
<a id="__codelineno-55-61" name="__codelineno-55-61" href="#__codelineno-55-61"></a>
<a id="__codelineno-55-62" name="__codelineno-55-62" href="#__codelineno-55-62"></a><span class="w">  </span><span class="nt">e2e-tests</span><span class="p">:</span>
<a id="__codelineno-55-63" name="__codelineno-55-63" href="#__codelineno-55-63"></a><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<a id="__codelineno-55-64" name="__codelineno-55-64" href="#__codelineno-55-64"></a><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.event_name == &#39;push&#39; &amp;&amp; github.ref == &#39;refs/heads/main&#39;</span>
<a id="__codelineno-55-65" name="__codelineno-55-65" href="#__codelineno-55-65"></a><span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<a id="__codelineno-55-66" name="__codelineno-55-66" href="#__codelineno-55-66"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v3</span>
<a id="__codelineno-55-67" name="__codelineno-55-67" href="#__codelineno-55-67"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Docker Buildx</span>
<a id="__codelineno-55-68" name="__codelineno-55-68" href="#__codelineno-55-68"></a><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker/setup-buildx-action@v2</span>
<a id="__codelineno-55-69" name="__codelineno-55-69" href="#__codelineno-55-69"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run E2E tests</span>
<a id="__codelineno-55-70" name="__codelineno-55-70" href="#__codelineno-55-70"></a><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-55-71" name="__codelineno-55-71" href="#__codelineno-55-71"></a><span class="w">          </span><span class="no">docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit</span>
<a id="__codelineno-55-72" name="__codelineno-55-72" href="#__codelineno-55-72"></a><span class="w">          </span><span class="no">docker-compose -f docker-compose.test.yml down</span>
</code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#conclusion">Conclusion</a></h3>
<p>A comprehensive testing strategy for microservices isn't just about writing tests—it's about building confidence in your system at every level. The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates how Clean Architecture naturally supports testing by creating clear boundaries and minimizing dependencies.</p>
<p>Key principles for effective microservice testing:</p>
<ul>
<li><strong>Fast Feedback</strong>: Unit tests provide immediate feedback during development</li>
<li><strong>Isolated Testing</strong>: Each layer can be tested independently with appropriate mocks</li>
<li><strong>Real Integration</strong>: Integration tests catch issues mocks can't reveal</li>
<li><strong>Contract Verification</strong>: Contract tests ensure service compatibility</li>
<li><strong>End-to-End Validation</strong>: E2E tests verify complete user workflows</li>
<li><strong>Performance Monitoring</strong>: Performance tests catch degradation early</li>
<li><strong>Continuous Validation</strong>: Automated testing in CI/CD pipelines</li>
</ul>
<p>The testing pyramid for microservices emphasizes having many fast, cheap unit tests at the base, with fewer expensive integration and E2E tests at the top. This approach maximizes confidence while minimizing execution time and maintenance overhead.</p>
<p>In the next post, we'll explore Code Quality Automation, showing how to automate code quality checks, formatting, and static analysis to maintain high standards across your Python microservices.</p>
<h3 id="references"><a class="toclink" href="../../2025/06/26/testing-strategy-for-python-microservices---building-confidence-through-systematic-testing/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete testing strategy implementation</li>
<li><a href="https://docs.pytest.org/">PyTest Documentation</a> - Python testing framework</li>
<li><a href="https://martinfowler.com/articles/practical-test-pyramid.html">Testing Pyramid</a> - Martin Fowler's testing guide</li>
<li><a href="https://github.com/testcontainers/testcontainers-python">Testcontainers Python</a> - Integration testing with Docker</li>
</ul>
<p>Remember: Tests aren't just about finding bugs—they're about building confidence to change and deploy your code safely.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 buildshift.dev
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/buildshift-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/your-profile" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/your-handle" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:contact@buildshift.dev" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l208 156a48 48 0 0 0 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 196v188c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V196L313.6 344.8c-34.1 25.6-81.1 25.6-115.2 0z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.path", "navigation.top", "search.highlight", "search.share", "search.suggest", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../assets/js/buildshift.js"></script>
      
    
  </body>
</html>