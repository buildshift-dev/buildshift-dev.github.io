
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Full Stack Developer specializing in AWS Serverless, Python, and modern development workflows">
      
      
        <meta name="author" content="buildshift.dev">
      
      
        <link rel="canonical" href="https://buildshift.dev/blog/category/security/">
      
      
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/images/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Security - buildshift.dev</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/css/buildshift.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-4SV8ZKYLT1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-4SV8ZKYLT1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-4SV8ZKYLT1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Fixed banner styling -->
  <style>
    body { padding-top: 40px !important; }
    .md-header { top: 40px !important; }
    .md-tabs { top: 40px !important; }
  </style>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#security" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
  <!-- Under Construction Announcement -->
  <div style="background: #000000; text-align: center; padding: 8px 0; position: fixed; top: 0; left: 0; right: 0; z-index: 9999; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 14px; font-weight: 500; color: #ffa500;">
      <i class="fas fa-hard-hat"></i>
      <span>...Under Construction...</span>
    </div>
  </div>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="buildshift.dev" class="md-header__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            buildshift.dev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Security
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link">
        
  
  
    
  
  buildshift.dev Blog

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="buildshift.dev" class="md-nav__button md-logo" aria-label="buildshift.dev" data-md-component="logo">
      
  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" alt="logo">

    </a>
    buildshift.dev
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/buildshift-dev" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    buildshift-dev
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    buildshift.dev Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="security">Security</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-07-12 20:50:00-04:00">Jul 12, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="../authentication/" class="md-meta__link">Authentication</a>, 
              <a href="../aws/" class="md-meta__link">AWS</a>, 
              <a href="./" class="md-meta__link">Security</a>, 
              <a href="../python/" class="md-meta__link">Python</a></li>
        
        
          
          <li class="md-meta__item">
            
              12 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="jwt-authentication-in-aws-from-development-to-production"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/">JWT Authentication in AWS: From Development to Production</a></h2>
<p>Authentication is the foundation of application security, but implementing JWT tokens correctly in AWS environments presents unique challenges. You need to handle token lifecycle, key rotation, validation performance, and AWS service integration while maintaining security best practices across development, staging, and production environments.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates a production-ready JWT authentication system designed specifically for AWS deployments. This isn't just about generating tokens—it's about building a comprehensive authentication infrastructure that scales from local development to enterprise production environments.</p>
<h3 id="the-jwt-authentication-journey"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#the-jwt-authentication-journey">The JWT Authentication Journey</a></h3>
<p>I've seen too many applications implement JWT authentication as an afterthought. They generate tokens with HS256 and a hardcoded secret, validate them with a simple middleware, and assume they're secure. Then production hits:</p>
<ul>
<li>Tokens can't be revoked when users are compromised</li>
<li>Key rotation brings down the entire system</li>
<li>Performance degrades under load due to expensive validation</li>
<li>Integration with AWS services becomes a nightmare</li>
<li>Compliance audits reveal security gaps</li>
</ul>
<p>A recent consulting client had exactly this problem. Their JWT implementation worked fine with 100 users, but when they scaled to 10,000 users, token validation became a bottleneck. Every request required expensive cryptographic operations, and they had no way to invalidate compromised tokens without changing the global secret key.</p>
<p>The solution required rebuilding their entire authentication system with production-grade patterns.</p>
<h3 id="jwt-architecture-for-aws"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#jwt-architecture-for-aws">JWT Architecture for AWS</a></h3>
<p>A robust JWT system in AWS requires several components working together:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>│   Client App    │    │  API Gateway    │    │  ECS/Lambda     │
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>│                 │    │                 │    │  Services       │
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>│ • Token storage │───▶│ • JWT validation│───▶│ • Claims extraction│
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>│ • Auto refresh  │    │ • Rate limiting │    │ • Authorization  │
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>│ • Secure trans  │    │ • Custom auth   │    │ • Business logic│
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>└─────────────────┘    └─────────────────┘    └─────────────────┘
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>         │                       │                       │
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a>         │                       ▼                       │
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>         │              ┌─────────────────┐              │
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a>         │              │  AWS Cognito    │              │
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a>         │              │                 │              │
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a>         └──────────────│ • User pools    │◀─────────────┘
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a>                        │ • Token issuing │
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a>                        │ • Key rotation  │
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a>                        └─────────────────┘
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>                                 │
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a>                                 ▼
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a>                        ┌─────────────────┐
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a>                        │ AWS Secrets     │
<a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a>                        │ Manager         │
<a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a>                        │                 │
<a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a>                        │ • Signing keys  │
<a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a>                        │ • Certificates  │
<a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a>                        │ • Auto rotation │
<a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a>                        └─────────────────┘
</code></pre></div>
<p>This architecture provides several advantages:
- Centralized key management with automatic rotation
- High-performance token validation
- Integration with AWS services
- Scalable to millions of users
- Compliance-ready audit trails</p>
<h3 id="jwt-token-design"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#jwt-token-design">JWT Token Design</a></h3>
<h4 id="token-structure-and-claims"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#token-structure-and-claims">Token Structure and Claims</a></h4>
<p>The clean-py JWT implementation uses RS256 signing with carefully designed claims:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">JWTTokenManager</span><span class="p">:</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key_pem</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">public_key_pem</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>            <span class="n">private_key_pem</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>            <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>        <span class="p">)</span>
<a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span>
<a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>            <span class="n">public_key_pem</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>        <span class="p">)</span>
<a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;RS256&quot;</span>
<a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a>
<a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span>
<a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a>        <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a>        <span class="n">roles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a>        <span class="n">permissions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a>        <span class="n">tenant_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-56-25" name="__codelineno-56-25" href="#__codelineno-56-25"></a>        <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-56-26" name="__codelineno-56-26" href="#__codelineno-56-26"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-56-27" name="__codelineno-56-27" href="#__codelineno-56-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a comprehensive access token with all necessary claims&quot;&quot;&quot;</span>
<a id="__codelineno-56-28" name="__codelineno-56-28" href="#__codelineno-56-28"></a>
<a id="__codelineno-56-29" name="__codelineno-56-29" href="#__codelineno-56-29"></a>        <span class="k">if</span> <span class="n">expires_delta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-56-30" name="__codelineno-56-30" href="#__codelineno-56-30"></a>            <span class="n">expires_delta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># Short-lived for security</span>
<a id="__codelineno-56-31" name="__codelineno-56-31" href="#__codelineno-56-31"></a>
<a id="__codelineno-56-32" name="__codelineno-56-32" href="#__codelineno-56-32"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-56-33" name="__codelineno-56-33" href="#__codelineno-56-33"></a>        <span class="n">jti</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>  <span class="c1"># Unique token ID for revocation</span>
<a id="__codelineno-56-34" name="__codelineno-56-34" href="#__codelineno-56-34"></a>
<a id="__codelineno-56-35" name="__codelineno-56-35" href="#__codelineno-56-35"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-56-36" name="__codelineno-56-36" href="#__codelineno-56-36"></a>            <span class="c1"># Standard claims</span>
<a id="__codelineno-56-37" name="__codelineno-56-37" href="#__codelineno-56-37"></a>            <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;https://auth.yourapp.com&quot;</span><span class="p">,</span>       <span class="c1"># Issuer</span>
<a id="__codelineno-56-38" name="__codelineno-56-38" href="#__codelineno-56-38"></a>            <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>                          <span class="c1"># Subject (user ID)</span>
<a id="__codelineno-56-39" name="__codelineno-56-39" href="#__codelineno-56-39"></a>            <span class="s2">&quot;aud&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;https://api.yourapp.com&quot;</span><span class="p">],</span>      <span class="c1"># Audience</span>
<a id="__codelineno-56-40" name="__codelineno-56-40" href="#__codelineno-56-40"></a>            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">expires_delta</span><span class="p">,</span>              <span class="c1"># Expiration</span>
<a id="__codelineno-56-41" name="__codelineno-56-41" href="#__codelineno-56-41"></a>            <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>                              <span class="c1"># Issued at</span>
<a id="__codelineno-56-42" name="__codelineno-56-42" href="#__codelineno-56-42"></a>            <span class="s2">&quot;nbf&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>                              <span class="c1"># Not before</span>
<a id="__codelineno-56-43" name="__codelineno-56-43" href="#__codelineno-56-43"></a>            <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="n">jti</span><span class="p">,</span>                              <span class="c1"># JWT ID for revocation</span>
<a id="__codelineno-56-44" name="__codelineno-56-44" href="#__codelineno-56-44"></a>
<a id="__codelineno-56-45" name="__codelineno-56-45" href="#__codelineno-56-45"></a>            <span class="c1"># Custom claims</span>
<a id="__codelineno-56-46" name="__codelineno-56-46" href="#__codelineno-56-46"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
<a id="__codelineno-56-47" name="__codelineno-56-47" href="#__codelineno-56-47"></a>            <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">roles</span><span class="p">,</span>
<a id="__codelineno-56-48" name="__codelineno-56-48" href="#__codelineno-56-48"></a>            <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="n">permissions</span><span class="p">,</span>
<a id="__codelineno-56-49" name="__codelineno-56-49" href="#__codelineno-56-49"></a>            <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span><span class="p">,</span>
<a id="__codelineno-56-50" name="__codelineno-56-50" href="#__codelineno-56-50"></a>            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span>
<a id="__codelineno-56-51" name="__codelineno-56-51" href="#__codelineno-56-51"></a>        <span class="p">}</span>
<a id="__codelineno-56-52" name="__codelineno-56-52" href="#__codelineno-56-52"></a>
<a id="__codelineno-56-53" name="__codelineno-56-53" href="#__codelineno-56-53"></a>        <span class="c1"># Add tenant context for multi-tenant applications</span>
<a id="__codelineno-56-54" name="__codelineno-56-54" href="#__codelineno-56-54"></a>        <span class="k">if</span> <span class="n">tenant_id</span><span class="p">:</span>
<a id="__codelineno-56-55" name="__codelineno-56-55" href="#__codelineno-56-55"></a>            <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;tenant_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tenant_id</span>
<a id="__codelineno-56-56" name="__codelineno-56-56" href="#__codelineno-56-56"></a>            <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;aud&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://api.</span><span class="si">{</span><span class="n">tenant_id</span><span class="si">}</span><span class="s2">.yourapp.com&quot;</span><span class="p">)</span>
<a id="__codelineno-56-57" name="__codelineno-56-57" href="#__codelineno-56-57"></a>
<a id="__codelineno-56-58" name="__codelineno-56-58" href="#__codelineno-56-58"></a>        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
<a id="__codelineno-56-59" name="__codelineno-56-59" href="#__codelineno-56-59"></a>
<a id="__codelineno-56-60" name="__codelineno-56-60" href="#__codelineno-56-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_refresh_token</span><span class="p">(</span>
<a id="__codelineno-56-61" name="__codelineno-56-61" href="#__codelineno-56-61"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-56-62" name="__codelineno-56-62" href="#__codelineno-56-62"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-56-63" name="__codelineno-56-63" href="#__codelineno-56-63"></a>        <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-56-64" name="__codelineno-56-64" href="#__codelineno-56-64"></a>        <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-56-65" name="__codelineno-56-65" href="#__codelineno-56-65"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-56-66" name="__codelineno-56-66" href="#__codelineno-56-66"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a refresh token for token renewal&quot;&quot;&quot;</span>
<a id="__codelineno-56-67" name="__codelineno-56-67" href="#__codelineno-56-67"></a>
<a id="__codelineno-56-68" name="__codelineno-56-68" href="#__codelineno-56-68"></a>        <span class="k">if</span> <span class="n">expires_delta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-56-69" name="__codelineno-56-69" href="#__codelineno-56-69"></a>            <span class="n">expires_delta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># Longer-lived</span>
<a id="__codelineno-56-70" name="__codelineno-56-70" href="#__codelineno-56-70"></a>
<a id="__codelineno-56-71" name="__codelineno-56-71" href="#__codelineno-56-71"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-56-72" name="__codelineno-56-72" href="#__codelineno-56-72"></a>
<a id="__codelineno-56-73" name="__codelineno-56-73" href="#__codelineno-56-73"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-56-74" name="__codelineno-56-74" href="#__codelineno-56-74"></a>            <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;https://auth.yourapp.com&quot;</span><span class="p">,</span>
<a id="__codelineno-56-75" name="__codelineno-56-75" href="#__codelineno-56-75"></a>            <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-56-76" name="__codelineno-56-76" href="#__codelineno-56-76"></a>            <span class="s2">&quot;aud&quot;</span><span class="p">:</span> <span class="s2">&quot;https://auth.yourapp.com&quot;</span><span class="p">,</span>  <span class="c1"># Only for auth service</span>
<a id="__codelineno-56-77" name="__codelineno-56-77" href="#__codelineno-56-77"></a>            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">expires_delta</span><span class="p">,</span>
<a id="__codelineno-56-78" name="__codelineno-56-78" href="#__codelineno-56-78"></a>            <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
<a id="__codelineno-56-79" name="__codelineno-56-79" href="#__codelineno-56-79"></a>            <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-56-80" name="__codelineno-56-80" href="#__codelineno-56-80"></a>            <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">,</span>
<a id="__codelineno-56-81" name="__codelineno-56-81" href="#__codelineno-56-81"></a>            <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
<a id="__codelineno-56-82" name="__codelineno-56-82" href="#__codelineno-56-82"></a>            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span>
<a id="__codelineno-56-83" name="__codelineno-56-83" href="#__codelineno-56-83"></a>        <span class="p">}</span>
<a id="__codelineno-56-84" name="__codelineno-56-84" href="#__codelineno-56-84"></a>
<a id="__codelineno-56-85" name="__codelineno-56-85" href="#__codelineno-56-85"></a>        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
</code></pre></div>
<h4 id="token-validation-with-performance-optimization"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#token-validation-with-performance-optimization">Token Validation with Performance Optimization</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">aioredis</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">JWTValidator</span><span class="p">:</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>        <span class="n">public_key_pem</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>        <span class="n">redis_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a>    <span class="p">):</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a>            <span class="n">public_key_pem</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a>        <span class="p">)</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;RS256&quot;</span>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
<a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a>
<a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a>        <span class="c1"># In-memory cache for high-frequency validation</span>
<a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_cache</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a>
<a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate JWT token with caching for performance&quot;&quot;&quot;</span>
<a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a>
<a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a>        <span class="c1"># Check revocation list first (fastest check)</span>
<a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a>        <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_token_revoked</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
<a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Token has been revoked&quot;</span><span class="p">)</span>
<a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a>
<a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a>        <span class="c1"># Check in-memory cache</span>
<a id="__codelineno-57-30" name="__codelineno-57-30" href="#__codelineno-57-30"></a>        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_cache</span><span class="p">:</span>
<a id="__codelineno-57-31" name="__codelineno-57-31" href="#__codelineno-57-31"></a>            <span class="n">cached_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
<a id="__codelineno-57-32" name="__codelineno-57-32" href="#__codelineno-57-32"></a>            <span class="k">if</span> <span class="n">cached_result</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">():</span>
<a id="__codelineno-57-33" name="__codelineno-57-33" href="#__codelineno-57-33"></a>                <span class="k">return</span> <span class="n">cached_result</span>
<a id="__codelineno-57-34" name="__codelineno-57-34" href="#__codelineno-57-34"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-57-35" name="__codelineno-57-35" href="#__codelineno-57-35"></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
<a id="__codelineno-57-36" name="__codelineno-57-36" href="#__codelineno-57-36"></a>
<a id="__codelineno-57-37" name="__codelineno-57-37" href="#__codelineno-57-37"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-57-38" name="__codelineno-57-38" href="#__codelineno-57-38"></a>            <span class="c1"># Decode and validate token</span>
<a id="__codelineno-57-39" name="__codelineno-57-39" href="#__codelineno-57-39"></a>            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
<a id="__codelineno-57-40" name="__codelineno-57-40" href="#__codelineno-57-40"></a>                <span class="n">token</span><span class="p">,</span>
<a id="__codelineno-57-41" name="__codelineno-57-41" href="#__codelineno-57-41"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span>
<a id="__codelineno-57-42" name="__codelineno-57-42" href="#__codelineno-57-42"></a>                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">],</span>
<a id="__codelineno-57-43" name="__codelineno-57-43" href="#__codelineno-57-43"></a>                <span class="n">audience</span><span class="o">=</span><span class="s2">&quot;https://api.yourapp.com&quot;</span><span class="p">,</span>
<a id="__codelineno-57-44" name="__codelineno-57-44" href="#__codelineno-57-44"></a>                <span class="n">issuer</span><span class="o">=</span><span class="s2">&quot;https://auth.yourapp.com&quot;</span><span class="p">,</span>
<a id="__codelineno-57-45" name="__codelineno-57-45" href="#__codelineno-57-45"></a>                <span class="n">options</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-57-46" name="__codelineno-57-46" href="#__codelineno-57-46"></a>                    <span class="s2">&quot;verify_exp&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-57-47" name="__codelineno-57-47" href="#__codelineno-57-47"></a>                    <span class="s2">&quot;verify_nbf&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-57-48" name="__codelineno-57-48" href="#__codelineno-57-48"></a>                    <span class="s2">&quot;verify_iat&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-57-49" name="__codelineno-57-49" href="#__codelineno-57-49"></a>                    <span class="s2">&quot;verify_aud&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-57-50" name="__codelineno-57-50" href="#__codelineno-57-50"></a>                    <span class="s2">&quot;verify_iss&quot;</span><span class="p">:</span> <span class="kc">True</span>
<a id="__codelineno-57-51" name="__codelineno-57-51" href="#__codelineno-57-51"></a>                <span class="p">}</span>
<a id="__codelineno-57-52" name="__codelineno-57-52" href="#__codelineno-57-52"></a>            <span class="p">)</span>
<a id="__codelineno-57-53" name="__codelineno-57-53" href="#__codelineno-57-53"></a>
<a id="__codelineno-57-54" name="__codelineno-57-54" href="#__codelineno-57-54"></a>            <span class="c1"># Additional business logic validation</span>
<a id="__codelineno-57-55" name="__codelineno-57-55" href="#__codelineno-57-55"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_business_rules</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<a id="__codelineno-57-56" name="__codelineno-57-56" href="#__codelineno-57-56"></a>
<a id="__codelineno-57-57" name="__codelineno-57-57" href="#__codelineno-57-57"></a>            <span class="c1"># Cache valid token (manage cache size)</span>
<a id="__codelineno-57-58" name="__codelineno-57-58" href="#__codelineno-57-58"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_validation_cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_size</span><span class="p">:</span>
<a id="__codelineno-57-59" name="__codelineno-57-59" href="#__codelineno-57-59"></a>                <span class="c1"># Remove oldest entries</span>
<a id="__codelineno-57-60" name="__codelineno-57-60" href="#__codelineno-57-60"></a>                <span class="n">oldest_key</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
<a id="__codelineno-57-61" name="__codelineno-57-61" href="#__codelineno-57-61"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_validation_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
<a id="__codelineno-57-62" name="__codelineno-57-62" href="#__codelineno-57-62"></a>                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iat&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-57-63" name="__codelineno-57-63" href="#__codelineno-57-63"></a>                <span class="p">)</span>
<a id="__codelineno-57-64" name="__codelineno-57-64" href="#__codelineno-57-64"></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_cache</span><span class="p">[</span><span class="n">oldest_key</span><span class="p">]</span>
<a id="__codelineno-57-65" name="__codelineno-57-65" href="#__codelineno-57-65"></a>
<a id="__codelineno-57-66" name="__codelineno-57-66" href="#__codelineno-57-66"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_validation_cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
<a id="__codelineno-57-67" name="__codelineno-57-67" href="#__codelineno-57-67"></a>            <span class="k">return</span> <span class="n">payload</span>
<a id="__codelineno-57-68" name="__codelineno-57-68" href="#__codelineno-57-68"></a>
<a id="__codelineno-57-69" name="__codelineno-57-69" href="#__codelineno-57-69"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
<a id="__codelineno-57-70" name="__codelineno-57-70" href="#__codelineno-57-70"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Token has expired&quot;</span><span class="p">)</span>
<a id="__codelineno-57-71" name="__codelineno-57-71" href="#__codelineno-57-71"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidAudienceError</span><span class="p">:</span>
<a id="__codelineno-57-72" name="__codelineno-57-72" href="#__codelineno-57-72"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Invalid token audience&quot;</span><span class="p">)</span>
<a id="__codelineno-57-73" name="__codelineno-57-73" href="#__codelineno-57-73"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidIssuerError</span><span class="p">:</span>
<a id="__codelineno-57-74" name="__codelineno-57-74" href="#__codelineno-57-74"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Invalid token issuer&quot;</span><span class="p">)</span>
<a id="__codelineno-57-75" name="__codelineno-57-75" href="#__codelineno-57-75"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-57-76" name="__codelineno-57-76" href="#__codelineno-57-76"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid token: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-77" name="__codelineno-57-77" href="#__codelineno-57-77"></a>
<a id="__codelineno-57-78" name="__codelineno-57-78" href="#__codelineno-57-78"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_is_token_revoked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-57-79" name="__codelineno-57-79" href="#__codelineno-57-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if token is in revocation list&quot;&quot;&quot;</span>
<a id="__codelineno-57-80" name="__codelineno-57-80" href="#__codelineno-57-80"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="p">:</span>
<a id="__codelineno-57-81" name="__codelineno-57-81" href="#__codelineno-57-81"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-57-82" name="__codelineno-57-82" href="#__codelineno-57-82"></a>
<a id="__codelineno-57-83" name="__codelineno-57-83" href="#__codelineno-57-83"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-57-84" name="__codelineno-57-84" href="#__codelineno-57-84"></a>            <span class="c1"># Extract JTI from token without validation</span>
<a id="__codelineno-57-85" name="__codelineno-57-85" href="#__codelineno-57-85"></a>            <span class="n">unverified_payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
<a id="__codelineno-57-86" name="__codelineno-57-86" href="#__codelineno-57-86"></a>                <span class="n">token</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verify_signature&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<a id="__codelineno-57-87" name="__codelineno-57-87" href="#__codelineno-57-87"></a>            <span class="p">)</span>
<a id="__codelineno-57-88" name="__codelineno-57-88" href="#__codelineno-57-88"></a>            <span class="n">jti</span> <span class="o">=</span> <span class="n">unverified_payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jti&quot;</span><span class="p">)</span>
<a id="__codelineno-57-89" name="__codelineno-57-89" href="#__codelineno-57-89"></a>
<a id="__codelineno-57-90" name="__codelineno-57-90" href="#__codelineno-57-90"></a>            <span class="k">if</span> <span class="n">jti</span><span class="p">:</span>
<a id="__codelineno-57-91" name="__codelineno-57-91" href="#__codelineno-57-91"></a>                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;revoked:</span><span class="si">{</span><span class="n">jti</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-92" name="__codelineno-57-92" href="#__codelineno-57-92"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-57-93" name="__codelineno-57-93" href="#__codelineno-57-93"></a>
<a id="__codelineno-57-94" name="__codelineno-57-94" href="#__codelineno-57-94"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-57-95" name="__codelineno-57-95" href="#__codelineno-57-95"></a>            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># If we can&#39;t extract JTI, let full validation handle it</span>
<a id="__codelineno-57-96" name="__codelineno-57-96" href="#__codelineno-57-96"></a>
<a id="__codelineno-57-97" name="__codelineno-57-97" href="#__codelineno-57-97"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_validate_business_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-57-98" name="__codelineno-57-98" href="#__codelineno-57-98"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Additional business logic validation&quot;&quot;&quot;</span>
<a id="__codelineno-57-99" name="__codelineno-57-99" href="#__codelineno-57-99"></a>
<a id="__codelineno-57-100" name="__codelineno-57-100" href="#__codelineno-57-100"></a>        <span class="c1"># Check user is still active</span>
<a id="__codelineno-57-101" name="__codelineno-57-101" href="#__codelineno-57-101"></a>        <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
<a id="__codelineno-57-102" name="__codelineno-57-102" href="#__codelineno-57-102"></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="p">:</span>
<a id="__codelineno-57-103" name="__codelineno-57-103" href="#__codelineno-57-103"></a>            <span class="n">is_active</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;user:active:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-104" name="__codelineno-57-104" href="#__codelineno-57-104"></a>            <span class="k">if</span> <span class="n">is_active</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;false&quot;</span><span class="p">:</span>
<a id="__codelineno-57-105" name="__codelineno-57-105" href="#__codelineno-57-105"></a>                <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;User account is deactivated&quot;</span><span class="p">)</span>
<a id="__codelineno-57-106" name="__codelineno-57-106" href="#__codelineno-57-106"></a>
<a id="__codelineno-57-107" name="__codelineno-57-107" href="#__codelineno-57-107"></a>        <span class="c1"># Validate tenant access for multi-tenant applications</span>
<a id="__codelineno-57-108" name="__codelineno-57-108" href="#__codelineno-57-108"></a>        <span class="n">tenant_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tenant_id&quot;</span><span class="p">)</span>
<a id="__codelineno-57-109" name="__codelineno-57-109" href="#__codelineno-57-109"></a>        <span class="k">if</span> <span class="n">tenant_id</span><span class="p">:</span>
<a id="__codelineno-57-110" name="__codelineno-57-110" href="#__codelineno-57-110"></a>            <span class="c1"># Check if user still has access to this tenant</span>
<a id="__codelineno-57-111" name="__codelineno-57-111" href="#__codelineno-57-111"></a>            <span class="n">has_access</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_tenant_access</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">tenant_id</span><span class="p">)</span>
<a id="__codelineno-57-112" name="__codelineno-57-112" href="#__codelineno-57-112"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_access</span><span class="p">:</span>
<a id="__codelineno-57-113" name="__codelineno-57-113" href="#__codelineno-57-113"></a>                <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Access to tenant revoked&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="aws-integration-patterns"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#aws-integration-patterns">AWS Integration Patterns</a></h3>
<h4 id="aws-secrets-manager-for-key-management"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#aws-secrets-manager-for-key-management">AWS Secrets Manager for Key Management</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">AWSJWTKeyManager</span><span class="p">:</span>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;us-west-2&quot;</span><span class="p">):</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">secrets_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;secretsmanager&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">)</span>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_key_version</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_current_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current JWT signing keys from AWS Secrets Manager&quot;&quot;&quot;</span>
<a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets_client</span><span class="o">.</span><span class="n">get_secret_value</span><span class="p">(</span>
<a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a>                <span class="n">SecretId</span><span class="o">=</span><span class="s2">&quot;clean-py/jwt/current-keys&quot;</span>
<a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a>            <span class="p">)</span>
<a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a>            <span class="n">keys</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;SecretString&#39;</span><span class="p">])</span>
<a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a>                <span class="s2">&quot;private_key&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">[</span><span class="s2">&quot;private_key&quot;</span><span class="p">],</span>
<a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a>                <span class="s2">&quot;public_key&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">[</span><span class="s2">&quot;public_key&quot;</span><span class="p">],</span>
<a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a>                <span class="s2">&quot;key_id&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">[</span><span class="s2">&quot;key_id&quot;</span><span class="p">],</span>
<a id="__codelineno-58-23" name="__codelineno-58-23" href="#__codelineno-58-23"></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">]</span>
<a id="__codelineno-58-24" name="__codelineno-58-24" href="#__codelineno-58-24"></a>            <span class="p">}</span>
<a id="__codelineno-58-25" name="__codelineno-58-25" href="#__codelineno-58-25"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-58-26" name="__codelineno-58-26" href="#__codelineno-58-26"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to retrieve JWT keys: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-58-27" name="__codelineno-58-27" href="#__codelineno-58-27"></a>
<a id="__codelineno-58-28" name="__codelineno-58-28" href="#__codelineno-58-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_public_keys_jwks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a id="__codelineno-58-29" name="__codelineno-58-29" href="#__codelineno-58-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get public keys in JWKS format for token validation&quot;&quot;&quot;</span>
<a id="__codelineno-58-30" name="__codelineno-58-30" href="#__codelineno-58-30"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_keys</span><span class="p">()</span>
<a id="__codelineno-58-31" name="__codelineno-58-31" href="#__codelineno-58-31"></a>
<a id="__codelineno-58-32" name="__codelineno-58-32" href="#__codelineno-58-32"></a>        <span class="c1"># In production, you&#39;d have multiple keys for rotation</span>
<a id="__codelineno-58-33" name="__codelineno-58-33" href="#__codelineno-58-33"></a>        <span class="n">jwks</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-58-34" name="__codelineno-58-34" href="#__codelineno-58-34"></a>            <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-58-35" name="__codelineno-58-35" href="#__codelineno-58-35"></a>                <span class="p">{</span>
<a id="__codelineno-58-36" name="__codelineno-58-36" href="#__codelineno-58-36"></a>                    <span class="s2">&quot;kty&quot;</span><span class="p">:</span> <span class="s2">&quot;RSA&quot;</span><span class="p">,</span>
<a id="__codelineno-58-37" name="__codelineno-58-37" href="#__codelineno-58-37"></a>                    <span class="s2">&quot;kid&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">[</span><span class="s2">&quot;key_id&quot;</span><span class="p">],</span>
<a id="__codelineno-58-38" name="__codelineno-58-38" href="#__codelineno-58-38"></a>                    <span class="s2">&quot;use&quot;</span><span class="p">:</span> <span class="s2">&quot;sig&quot;</span><span class="p">,</span>
<a id="__codelineno-58-39" name="__codelineno-58-39" href="#__codelineno-58-39"></a>                    <span class="s2">&quot;alg&quot;</span><span class="p">:</span> <span class="s2">&quot;RS256&quot;</span><span class="p">,</span>
<a id="__codelineno-58-40" name="__codelineno-58-40" href="#__codelineno-58-40"></a>                    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_modulus</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="s2">&quot;public_key&quot;</span><span class="p">]),</span>
<a id="__codelineno-58-41" name="__codelineno-58-41" href="#__codelineno-58-41"></a>                    <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="s2">&quot;AQAB&quot;</span>  <span class="c1"># Standard RSA exponent</span>
<a id="__codelineno-58-42" name="__codelineno-58-42" href="#__codelineno-58-42"></a>                <span class="p">}</span>
<a id="__codelineno-58-43" name="__codelineno-58-43" href="#__codelineno-58-43"></a>            <span class="p">]</span>
<a id="__codelineno-58-44" name="__codelineno-58-44" href="#__codelineno-58-44"></a>        <span class="p">}</span>
<a id="__codelineno-58-45" name="__codelineno-58-45" href="#__codelineno-58-45"></a>        <span class="k">return</span> <span class="n">jwks</span>
<a id="__codelineno-58-46" name="__codelineno-58-46" href="#__codelineno-58-46"></a>
<a id="__codelineno-58-47" name="__codelineno-58-47" href="#__codelineno-58-47"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rotate_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-58-48" name="__codelineno-58-48" href="#__codelineno-58-48"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Rotate JWT signing keys&quot;&quot;&quot;</span>
<a id="__codelineno-58-49" name="__codelineno-58-49" href="#__codelineno-58-49"></a>        <span class="c1"># Generate new key pair</span>
<a id="__codelineno-58-50" name="__codelineno-58-50" href="#__codelineno-58-50"></a>        <span class="n">new_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_key_pair</span><span class="p">()</span>
<a id="__codelineno-58-51" name="__codelineno-58-51" href="#__codelineno-58-51"></a>
<a id="__codelineno-58-52" name="__codelineno-58-52" href="#__codelineno-58-52"></a>        <span class="c1"># Store old keys as previous version</span>
<a id="__codelineno-58-53" name="__codelineno-58-53" href="#__codelineno-58-53"></a>        <span class="n">current_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_keys</span><span class="p">()</span>
<a id="__codelineno-58-54" name="__codelineno-58-54" href="#__codelineno-58-54"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_previous_keys</span><span class="p">(</span><span class="n">current_keys</span><span class="p">)</span>
<a id="__codelineno-58-55" name="__codelineno-58-55" href="#__codelineno-58-55"></a>
<a id="__codelineno-58-56" name="__codelineno-58-56" href="#__codelineno-58-56"></a>        <span class="c1"># Store new keys as current</span>
<a id="__codelineno-58-57" name="__codelineno-58-57" href="#__codelineno-58-57"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_current_keys</span><span class="p">(</span><span class="n">new_keys</span><span class="p">)</span>
<a id="__codelineno-58-58" name="__codelineno-58-58" href="#__codelineno-58-58"></a>
<a id="__codelineno-58-59" name="__codelineno-58-59" href="#__codelineno-58-59"></a>        <span class="c1"># Clear cache to force reload</span>
<a id="__codelineno-58-60" name="__codelineno-58-60" href="#__codelineno-58-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_current_keys</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
<a id="__codelineno-58-61" name="__codelineno-58-61" href="#__codelineno-58-61"></a>
<a id="__codelineno-58-62" name="__codelineno-58-62" href="#__codelineno-58-62"></a>        <span class="k">return</span> <span class="n">new_keys</span><span class="p">[</span><span class="s2">&quot;key_id&quot;</span><span class="p">]</span>
</code></pre></div>
<h4 id="api-gateway-custom-authorizer"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#api-gateway-custom-authorizer">API Gateway Custom Authorizer</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="c1"># lambda/jwt_authorizer.py</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;AWS API Gateway custom authorizer for JWT validation&quot;&quot;&quot;</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a>        <span class="c1"># Extract token from Authorization header</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">extract_token_from_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;No token provided&quot;</span><span class="p">)</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a>        <span class="c1"># Validate token</span>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a>        <span class="n">key_manager</span> <span class="o">=</span> <span class="n">AWSJWTKeyManager</span><span class="p">()</span>
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a>        <span class="n">validator</span> <span class="o">=</span> <span class="n">JWTValidator</span><span class="p">(</span><span class="n">key_manager</span><span class="o">.</span><span class="n">get_current_keys</span><span class="p">()[</span><span class="s2">&quot;public_key&quot;</span><span class="p">])</span>
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a>
<a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a>        <span class="c1"># Generate IAM policy</span>
<a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a>        <span class="n">policy</span> <span class="o">=</span> <span class="n">generate_iam_policy</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;methodArn&quot;</span><span class="p">])</span>
<a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a>
<a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a>            <span class="s2">&quot;principalId&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">],</span>
<a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a>            <span class="s2">&quot;policyDocument&quot;</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span>
<a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a>            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a>                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">],</span>
<a id="__codelineno-59-28" name="__codelineno-59-28" href="#__codelineno-59-28"></a>                <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-59-29" name="__codelineno-59-29" href="#__codelineno-59-29"></a>                <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roles&quot;</span><span class="p">,</span> <span class="p">[])),</span>
<a id="__codelineno-59-30" name="__codelineno-59-30" href="#__codelineno-59-30"></a>                <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="p">[])),</span>
<a id="__codelineno-59-31" name="__codelineno-59-31" href="#__codelineno-59-31"></a>                <span class="s2">&quot;tenant_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tenant_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-59-32" name="__codelineno-59-32" href="#__codelineno-59-32"></a>            <span class="p">}</span>
<a id="__codelineno-59-33" name="__codelineno-59-33" href="#__codelineno-59-33"></a>        <span class="p">}</span>
<a id="__codelineno-59-34" name="__codelineno-59-34" href="#__codelineno-59-34"></a>
<a id="__codelineno-59-35" name="__codelineno-59-35" href="#__codelineno-59-35"></a>    <span class="k">except</span> <span class="n">AuthenticationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-59-36" name="__codelineno-59-36" href="#__codelineno-59-36"></a>        <span class="c1"># Return 401 Unauthorized</span>
<a id="__codelineno-59-37" name="__codelineno-59-37" href="#__codelineno-59-37"></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">)</span>
<a id="__codelineno-59-38" name="__codelineno-59-38" href="#__codelineno-59-38"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-59-39" name="__codelineno-59-39" href="#__codelineno-59-39"></a>        <span class="c1"># Return 500 Internal Server Error</span>
<a id="__codelineno-59-40" name="__codelineno-59-40" href="#__codelineno-59-40"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authorizer error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-59-41" name="__codelineno-59-41" href="#__codelineno-59-41"></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">)</span>
<a id="__codelineno-59-42" name="__codelineno-59-42" href="#__codelineno-59-42"></a>
<a id="__codelineno-59-43" name="__codelineno-59-43" href="#__codelineno-59-43"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_iam_policy</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">method_arn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-59-44" name="__codelineno-59-44" href="#__codelineno-59-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate IAM policy based on JWT claims&quot;&quot;&quot;</span>
<a id="__codelineno-59-45" name="__codelineno-59-45" href="#__codelineno-59-45"></a>
<a id="__codelineno-59-46" name="__codelineno-59-46" href="#__codelineno-59-46"></a>    <span class="n">user_permissions</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-59-47" name="__codelineno-59-47" href="#__codelineno-59-47"></a>
<a id="__codelineno-59-48" name="__codelineno-59-48" href="#__codelineno-59-48"></a>    <span class="c1"># Extract resource and method from ARN</span>
<a id="__codelineno-59-49" name="__codelineno-59-49" href="#__codelineno-59-49"></a>    <span class="c1"># arn:aws:execute-api:region:account:api-id/stage/METHOD/resource-path</span>
<a id="__codelineno-59-50" name="__codelineno-59-50" href="#__codelineno-59-50"></a>    <span class="n">arn_parts</span> <span class="o">=</span> <span class="n">method_arn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<a id="__codelineno-59-51" name="__codelineno-59-51" href="#__codelineno-59-51"></a>    <span class="n">api_gateway_arn</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arn_parts</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<a id="__codelineno-59-52" name="__codelineno-59-52" href="#__codelineno-59-52"></a>
<a id="__codelineno-59-53" name="__codelineno-59-53" href="#__codelineno-59-53"></a>    <span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-59-54" name="__codelineno-59-54" href="#__codelineno-59-54"></a>
<a id="__codelineno-59-55" name="__codelineno-59-55" href="#__codelineno-59-55"></a>    <span class="c1"># Check permissions and generate appropriate policy</span>
<a id="__codelineno-59-56" name="__codelineno-59-56" href="#__codelineno-59-56"></a>    <span class="k">if</span> <span class="s2">&quot;orders:read&quot;</span> <span class="ow">in</span> <span class="n">user_permissions</span><span class="p">:</span>
<a id="__codelineno-59-57" name="__codelineno-59-57" href="#__codelineno-59-57"></a>        <span class="n">statements</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-59-58" name="__codelineno-59-58" href="#__codelineno-59-58"></a>            <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;execute-api:Invoke&quot;</span><span class="p">,</span>
<a id="__codelineno-59-59" name="__codelineno-59-59" href="#__codelineno-59-59"></a>            <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<a id="__codelineno-59-60" name="__codelineno-59-60" href="#__codelineno-59-60"></a>            <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_gateway_arn</span><span class="si">}</span><span class="s2">/*/GET/orders*&quot;</span>
<a id="__codelineno-59-61" name="__codelineno-59-61" href="#__codelineno-59-61"></a>        <span class="p">})</span>
<a id="__codelineno-59-62" name="__codelineno-59-62" href="#__codelineno-59-62"></a>
<a id="__codelineno-59-63" name="__codelineno-59-63" href="#__codelineno-59-63"></a>    <span class="k">if</span> <span class="s2">&quot;orders:write&quot;</span> <span class="ow">in</span> <span class="n">user_permissions</span><span class="p">:</span>
<a id="__codelineno-59-64" name="__codelineno-59-64" href="#__codelineno-59-64"></a>        <span class="n">statements</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-59-65" name="__codelineno-59-65" href="#__codelineno-59-65"></a>            <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;execute-api:Invoke&quot;</span><span class="p">,</span>
<a id="__codelineno-59-66" name="__codelineno-59-66" href="#__codelineno-59-66"></a>            <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<a id="__codelineno-59-67" name="__codelineno-59-67" href="#__codelineno-59-67"></a>            <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_gateway_arn</span><span class="si">}</span><span class="s2">/*/POST/orders*&quot;</span>
<a id="__codelineno-59-68" name="__codelineno-59-68" href="#__codelineno-59-68"></a>        <span class="p">})</span>
<a id="__codelineno-59-69" name="__codelineno-59-69" href="#__codelineno-59-69"></a>
<a id="__codelineno-59-70" name="__codelineno-59-70" href="#__codelineno-59-70"></a>    <span class="c1"># Default deny for unmatched resources</span>
<a id="__codelineno-59-71" name="__codelineno-59-71" href="#__codelineno-59-71"></a>    <span class="n">statements</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-59-72" name="__codelineno-59-72" href="#__codelineno-59-72"></a>        <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;execute-api:Invoke&quot;</span><span class="p">,</span>
<a id="__codelineno-59-73" name="__codelineno-59-73" href="#__codelineno-59-73"></a>        <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Deny&quot;</span><span class="p">,</span>
<a id="__codelineno-59-74" name="__codelineno-59-74" href="#__codelineno-59-74"></a>        <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
<a id="__codelineno-59-75" name="__codelineno-59-75" href="#__codelineno-59-75"></a>    <span class="p">})</span>
<a id="__codelineno-59-76" name="__codelineno-59-76" href="#__codelineno-59-76"></a>
<a id="__codelineno-59-77" name="__codelineno-59-77" href="#__codelineno-59-77"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-59-78" name="__codelineno-59-78" href="#__codelineno-59-78"></a>        <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<a id="__codelineno-59-79" name="__codelineno-59-79" href="#__codelineno-59-79"></a>        <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="n">statements</span>
<a id="__codelineno-59-80" name="__codelineno-59-80" href="#__codelineno-59-80"></a>    <span class="p">}</span>
</code></pre></div>
<h4 id="ecsfargate-jwt-middleware"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#ecsfargate-jwt-middleware">ECS/Fargate JWT Middleware</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBearer</span><span class="p">,</span> <span class="n">HTTPAuthorizationCredentials</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="n">security</span> <span class="o">=</span> <span class="n">HTTPBearer</span><span class="p">()</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">JWTAuthenticationMiddleware</span><span class="p">:</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">key_manager</span> <span class="o">=</span> <span class="n">AWSJWTKeyManager</span><span class="p">()</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_validator</span><span class="p">()</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize JWT validator with current keys&quot;&quot;&quot;</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_manager</span><span class="o">.</span><span class="n">get_current_keys</span><span class="p">()</span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">JWTValidator</span><span class="p">(</span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a>            <span class="n">keys</span><span class="p">[</span><span class="s2">&quot;public_key&quot;</span><span class="p">],</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a>            <span class="n">redis_client</span><span class="o">=</span><span class="n">get_redis_client</span><span class="p">()</span>
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a>        <span class="p">)</span>
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a>
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Middleware to validate JWT tokens&quot;&quot;&quot;</span>
<a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a>
<a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a>        <span class="c1"># Skip authentication for public endpoints</span>
<a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_public_endpoint</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a>            <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a>
<a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a>        <span class="c1"># Extract token</span>
<a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a>        <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">)</span>
<a id="__codelineno-60-31" name="__codelineno-60-31" href="#__codelineno-60-31"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Bearer &quot;</span><span class="p">):</span>
<a id="__codelineno-60-32" name="__codelineno-60-32" href="#__codelineno-60-32"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Authentication required&quot;</span><span class="p">)</span>
<a id="__codelineno-60-33" name="__codelineno-60-33" href="#__codelineno-60-33"></a>
<a id="__codelineno-60-34" name="__codelineno-60-34" href="#__codelineno-60-34"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-60-35" name="__codelineno-60-35" href="#__codelineno-60-35"></a>
<a id="__codelineno-60-36" name="__codelineno-60-36" href="#__codelineno-60-36"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-60-37" name="__codelineno-60-37" href="#__codelineno-60-37"></a>            <span class="c1"># Validate token</span>
<a id="__codelineno-60-38" name="__codelineno-60-38" href="#__codelineno-60-38"></a>            <span class="n">payload</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-60-39" name="__codelineno-60-39" href="#__codelineno-60-39"></a>
<a id="__codelineno-60-40" name="__codelineno-60-40" href="#__codelineno-60-40"></a>            <span class="c1"># Add user context to request</span>
<a id="__codelineno-60-41" name="__codelineno-60-41" href="#__codelineno-60-41"></a>            <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
<a id="__codelineno-60-42" name="__codelineno-60-42" href="#__codelineno-60-42"></a>            <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">user_email</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)</span>
<a id="__codelineno-60-43" name="__codelineno-60-43" href="#__codelineno-60-43"></a>            <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">user_roles</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roles&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-60-44" name="__codelineno-60-44" href="#__codelineno-60-44"></a>            <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">user_permissions</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-60-45" name="__codelineno-60-45" href="#__codelineno-60-45"></a>            <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">tenant_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tenant_id&quot;</span><span class="p">)</span>
<a id="__codelineno-60-46" name="__codelineno-60-46" href="#__codelineno-60-46"></a>
<a id="__codelineno-60-47" name="__codelineno-60-47" href="#__codelineno-60-47"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-60-48" name="__codelineno-60-48" href="#__codelineno-60-48"></a>            <span class="k">return</span> <span class="n">response</span>
<a id="__codelineno-60-49" name="__codelineno-60-49" href="#__codelineno-60-49"></a>
<a id="__codelineno-60-50" name="__codelineno-60-50" href="#__codelineno-60-50"></a>        <span class="k">except</span> <span class="n">AuthenticationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-60-51" name="__codelineno-60-51" href="#__codelineno-60-51"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-60-52" name="__codelineno-60-52" href="#__codelineno-60-52"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-60-53" name="__codelineno-60-53" href="#__codelineno-60-53"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Authentication service error&quot;</span><span class="p">)</span>
<a id="__codelineno-60-54" name="__codelineno-60-54" href="#__codelineno-60-54"></a>
<a id="__codelineno-60-55" name="__codelineno-60-55" href="#__codelineno-60-55"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_public_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-60-56" name="__codelineno-60-56" href="#__codelineno-60-56"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if endpoint is public and doesn&#39;t require authentication&quot;&quot;&quot;</span>
<a id="__codelineno-60-57" name="__codelineno-60-57" href="#__codelineno-60-57"></a>        <span class="n">public_paths</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-60-58" name="__codelineno-60-58" href="#__codelineno-60-58"></a>            <span class="s2">&quot;/health&quot;</span><span class="p">,</span>
<a id="__codelineno-60-59" name="__codelineno-60-59" href="#__codelineno-60-59"></a>            <span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
<a id="__codelineno-60-60" name="__codelineno-60-60" href="#__codelineno-60-60"></a>            <span class="s2">&quot;/openapi.json&quot;</span><span class="p">,</span>
<a id="__codelineno-60-61" name="__codelineno-60-61" href="#__codelineno-60-61"></a>            <span class="s2">&quot;/auth/login&quot;</span><span class="p">,</span>
<a id="__codelineno-60-62" name="__codelineno-60-62" href="#__codelineno-60-62"></a>            <span class="s2">&quot;/auth/register&quot;</span><span class="p">,</span>
<a id="__codelineno-60-63" name="__codelineno-60-63" href="#__codelineno-60-63"></a>            <span class="s2">&quot;/auth/refresh&quot;</span>
<a id="__codelineno-60-64" name="__codelineno-60-64" href="#__codelineno-60-64"></a>        <span class="p">]</span>
<a id="__codelineno-60-65" name="__codelineno-60-65" href="#__codelineno-60-65"></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">public_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">public_path</span> <span class="ow">in</span> <span class="n">public_paths</span><span class="p">)</span>
<a id="__codelineno-60-66" name="__codelineno-60-66" href="#__codelineno-60-66"></a>
<a id="__codelineno-60-67" name="__codelineno-60-67" href="#__codelineno-60-67"></a><span class="c1"># Dependency for endpoint-level authentication</span>
<a id="__codelineno-60-68" name="__codelineno-60-68" href="#__codelineno-60-68"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
<a id="__codelineno-60-69" name="__codelineno-60-69" href="#__codelineno-60-69"></a>    <span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">security</span><span class="p">)</span>
<a id="__codelineno-60-70" name="__codelineno-60-70" href="#__codelineno-60-70"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-60-71" name="__codelineno-60-71" href="#__codelineno-60-71"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;FastAPI dependency for getting current authenticated user&quot;&quot;&quot;</span>
<a id="__codelineno-60-72" name="__codelineno-60-72" href="#__codelineno-60-72"></a>
<a id="__codelineno-60-73" name="__codelineno-60-73" href="#__codelineno-60-73"></a>    <span class="n">key_manager</span> <span class="o">=</span> <span class="n">AWSJWTKeyManager</span><span class="p">()</span>
<a id="__codelineno-60-74" name="__codelineno-60-74" href="#__codelineno-60-74"></a>    <span class="n">validator</span> <span class="o">=</span> <span class="n">JWTValidator</span><span class="p">(</span><span class="n">key_manager</span><span class="o">.</span><span class="n">get_current_keys</span><span class="p">()[</span><span class="s2">&quot;public_key&quot;</span><span class="p">])</span>
<a id="__codelineno-60-75" name="__codelineno-60-75" href="#__codelineno-60-75"></a>
<a id="__codelineno-60-76" name="__codelineno-60-76" href="#__codelineno-60-76"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-60-77" name="__codelineno-60-77" href="#__codelineno-60-77"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span><span class="p">)</span>
<a id="__codelineno-60-78" name="__codelineno-60-78" href="#__codelineno-60-78"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-60-79" name="__codelineno-60-79" href="#__codelineno-60-79"></a>            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">],</span>
<a id="__codelineno-60-80" name="__codelineno-60-80" href="#__codelineno-60-80"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">),</span>
<a id="__codelineno-60-81" name="__codelineno-60-81" href="#__codelineno-60-81"></a>            <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roles&quot;</span><span class="p">,</span> <span class="p">[]),</span>
<a id="__codelineno-60-82" name="__codelineno-60-82" href="#__codelineno-60-82"></a>            <span class="s2">&quot;permissions&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permissions&quot;</span><span class="p">,</span> <span class="p">[]),</span>
<a id="__codelineno-60-83" name="__codelineno-60-83" href="#__codelineno-60-83"></a>            <span class="s2">&quot;tenant_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tenant_id&quot;</span><span class="p">)</span>
<a id="__codelineno-60-84" name="__codelineno-60-84" href="#__codelineno-60-84"></a>        <span class="p">}</span>
<a id="__codelineno-60-85" name="__codelineno-60-85" href="#__codelineno-60-85"></a>    <span class="k">except</span> <span class="n">AuthenticationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-60-86" name="__codelineno-60-86" href="#__codelineno-60-86"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</code></pre></div>
<h3 id="token-lifecycle-management"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#token-lifecycle-management">Token Lifecycle Management</a></h3>
<h4 id="token-refresh-pattern"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#token-refresh-pattern">Token Refresh Pattern</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TokenRefreshService</span><span class="p">:</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_manager</span><span class="p">:</span> <span class="n">JWTTokenManager</span><span class="p">,</span> <span class="n">user_service</span><span class="p">):</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_manager</span> <span class="o">=</span> <span class="n">token_manager</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_service</span> <span class="o">=</span> <span class="n">user_service</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">get_redis_client</span><span class="p">()</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_access_token</span><span class="p">(</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>        <span class="n">refresh_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>        <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Refresh access token using refresh token&quot;&quot;&quot;</span>
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>            <span class="c1"># Validate refresh token</span>
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
<a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>                <span class="n">refresh_token</span><span class="p">,</span>
<a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">token_manager</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span>
<a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RS256&quot;</span><span class="p">],</span>
<a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a>                <span class="n">audience</span><span class="o">=</span><span class="s2">&quot;https://auth.yourapp.com&quot;</span>
<a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>            <span class="p">)</span>
<a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>
<a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a>            <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;refresh&quot;</span><span class="p">:</span>
<a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a>                <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Invalid token type&quot;</span><span class="p">)</span>
<a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a>
<a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
<a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a>            <span class="n">session_id</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;session_id&quot;</span><span class="p">]</span>
<a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a>
<a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a>            <span class="c1"># Check if session is still valid</span>
<a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a>            <span class="n">session_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;session:</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_key</span><span class="p">):</span>
<a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a>                <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Session expired&quot;</span><span class="p">)</span>
<a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a>
<a id="__codelineno-61-34" name="__codelineno-61-34" href="#__codelineno-61-34"></a>            <span class="c1"># Get current user data</span>
<a id="__codelineno-61-35" name="__codelineno-61-35" href="#__codelineno-61-35"></a>            <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_service</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-61-36" name="__codelineno-61-36" href="#__codelineno-61-36"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
<a id="__codelineno-61-37" name="__codelineno-61-37" href="#__codelineno-61-37"></a>                <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;User not found or inactive&quot;</span><span class="p">)</span>
<a id="__codelineno-61-38" name="__codelineno-61-38" href="#__codelineno-61-38"></a>
<a id="__codelineno-61-39" name="__codelineno-61-39" href="#__codelineno-61-39"></a>            <span class="c1"># Generate new access token</span>
<a id="__codelineno-61-40" name="__codelineno-61-40" href="#__codelineno-61-40"></a>            <span class="n">new_access_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_manager</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
<a id="__codelineno-61-41" name="__codelineno-61-41" href="#__codelineno-61-41"></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-61-42" name="__codelineno-61-42" href="#__codelineno-61-42"></a>                <span class="n">email</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
<a id="__codelineno-61-43" name="__codelineno-61-43" href="#__codelineno-61-43"></a>                <span class="n">roles</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">roles</span><span class="p">,</span>
<a id="__codelineno-61-44" name="__codelineno-61-44" href="#__codelineno-61-44"></a>                <span class="n">permissions</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">permissions</span><span class="p">,</span>
<a id="__codelineno-61-45" name="__codelineno-61-45" href="#__codelineno-61-45"></a>                <span class="n">tenant_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">tenant_id</span>
<a id="__codelineno-61-46" name="__codelineno-61-46" href="#__codelineno-61-46"></a>            <span class="p">)</span>
<a id="__codelineno-61-47" name="__codelineno-61-47" href="#__codelineno-61-47"></a>
<a id="__codelineno-61-48" name="__codelineno-61-48" href="#__codelineno-61-48"></a>            <span class="c1"># Update session timestamp</span>
<a id="__codelineno-61-49" name="__codelineno-61-49" href="#__codelineno-61-49"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">session_key</span><span class="p">,</span> <span class="mi">2592000</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>  <span class="c1"># 30 days</span>
<a id="__codelineno-61-50" name="__codelineno-61-50" href="#__codelineno-61-50"></a>
<a id="__codelineno-61-51" name="__codelineno-61-51" href="#__codelineno-61-51"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-61-52" name="__codelineno-61-52" href="#__codelineno-61-52"></a>                <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">new_access_token</span><span class="p">,</span>
<a id="__codelineno-61-53" name="__codelineno-61-53" href="#__codelineno-61-53"></a>                <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
<a id="__codelineno-61-54" name="__codelineno-61-54" href="#__codelineno-61-54"></a>                <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="mi">900</span>  <span class="c1"># 15 minutes</span>
<a id="__codelineno-61-55" name="__codelineno-61-55" href="#__codelineno-61-55"></a>            <span class="p">}</span>
<a id="__codelineno-61-56" name="__codelineno-61-56" href="#__codelineno-61-56"></a>
<a id="__codelineno-61-57" name="__codelineno-61-57" href="#__codelineno-61-57"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
<a id="__codelineno-61-58" name="__codelineno-61-58" href="#__codelineno-61-58"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Refresh token expired&quot;</span><span class="p">)</span>
<a id="__codelineno-61-59" name="__codelineno-61-59" href="#__codelineno-61-59"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-61-60" name="__codelineno-61-60" href="#__codelineno-61-60"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid refresh token: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="token-revocation"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#token-revocation">Token Revocation</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TokenRevocationService</span><span class="p">:</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">get_redis_client</span><span class="p">()</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">revoke_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;user_logout&quot;</span><span class="p">):</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke a specific token&quot;&quot;&quot;</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>            <span class="c1"># Extract JTI without validation</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;verify_signature&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>            <span class="n">jti</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jti&quot;</span><span class="p">)</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>            <span class="n">exp</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exp&quot;</span><span class="p">)</span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>            <span class="k">if</span> <span class="n">jti</span> <span class="ow">and</span> <span class="n">exp</span><span class="p">:</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>                <span class="c1"># Calculate TTL based on expiration</span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>                <span class="n">ttl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">exp</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
<a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>
<a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a>                <span class="c1"># Add to revocation list</span>
<a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
<a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a>                    <span class="sa">f</span><span class="s2">&quot;revoked:</span><span class="si">{</span><span class="n">jti</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a>                    <span class="nb">int</span><span class="p">(</span><span class="n">ttl</span><span class="p">),</span>
<a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a>                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a>                        <span class="s2">&quot;revoked_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a>                        <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
<a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a>                        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="n">jti</span>
<a id="__codelineno-62-25" name="__codelineno-62-25" href="#__codelineno-62-25"></a>                    <span class="p">})</span>
<a id="__codelineno-62-26" name="__codelineno-62-26" href="#__codelineno-62-26"></a>                <span class="p">)</span>
<a id="__codelineno-62-27" name="__codelineno-62-27" href="#__codelineno-62-27"></a>
<a id="__codelineno-62-28" name="__codelineno-62-28" href="#__codelineno-62-28"></a>                <span class="c1"># Log revocation for audit</span>
<a id="__codelineno-62-29" name="__codelineno-62-29" href="#__codelineno-62-29"></a>                <span class="n">audit_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-62-30" name="__codelineno-62-30" href="#__codelineno-62-30"></a>                    <span class="s2">&quot;Token revoked&quot;</span><span class="p">,</span>
<a id="__codelineno-62-31" name="__codelineno-62-31" href="#__codelineno-62-31"></a>                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-62-32" name="__codelineno-62-32" href="#__codelineno-62-32"></a>                        <span class="s2">&quot;jti&quot;</span><span class="p">:</span> <span class="n">jti</span><span class="p">,</span>
<a id="__codelineno-62-33" name="__codelineno-62-33" href="#__codelineno-62-33"></a>                        <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
<a id="__codelineno-62-34" name="__codelineno-62-34" href="#__codelineno-62-34"></a>                        <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="n">exp</span>
<a id="__codelineno-62-35" name="__codelineno-62-35" href="#__codelineno-62-35"></a>                    <span class="p">}</span>
<a id="__codelineno-62-36" name="__codelineno-62-36" href="#__codelineno-62-36"></a>                <span class="p">)</span>
<a id="__codelineno-62-37" name="__codelineno-62-37" href="#__codelineno-62-37"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-62-38" name="__codelineno-62-38" href="#__codelineno-62-38"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error revoking token: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-62-39" name="__codelineno-62-39" href="#__codelineno-62-39"></a>
<a id="__codelineno-62-40" name="__codelineno-62-40" href="#__codelineno-62-40"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">revoke_user_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;security_incident&quot;</span><span class="p">):</span>
<a id="__codelineno-62-41" name="__codelineno-62-41" href="#__codelineno-62-41"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Revoke all tokens for a specific user&quot;&quot;&quot;</span>
<a id="__codelineno-62-42" name="__codelineno-62-42" href="#__codelineno-62-42"></a>
<a id="__codelineno-62-43" name="__codelineno-62-43" href="#__codelineno-62-43"></a>        <span class="c1"># In a production system, you&#39;d need to track active tokens per user</span>
<a id="__codelineno-62-44" name="__codelineno-62-44" href="#__codelineno-62-44"></a>        <span class="c1"># This could be done by storing JTIs in Redis sets per user</span>
<a id="__codelineno-62-45" name="__codelineno-62-45" href="#__codelineno-62-45"></a>
<a id="__codelineno-62-46" name="__codelineno-62-46" href="#__codelineno-62-46"></a>        <span class="n">user_tokens_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user_tokens:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-62-47" name="__codelineno-62-47" href="#__codelineno-62-47"></a>        <span class="n">token_jtis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">user_tokens_key</span><span class="p">)</span>
<a id="__codelineno-62-48" name="__codelineno-62-48" href="#__codelineno-62-48"></a>
<a id="__codelineno-62-49" name="__codelineno-62-49" href="#__codelineno-62-49"></a>        <span class="k">for</span> <span class="n">jti</span> <span class="ow">in</span> <span class="n">token_jtis</span><span class="p">:</span>
<a id="__codelineno-62-50" name="__codelineno-62-50" href="#__codelineno-62-50"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
<a id="__codelineno-62-51" name="__codelineno-62-51" href="#__codelineno-62-51"></a>                <span class="sa">f</span><span class="s2">&quot;revoked:</span><span class="si">{</span><span class="n">jti</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-62-52" name="__codelineno-62-52" href="#__codelineno-62-52"></a>                <span class="mi">86400</span><span class="p">,</span>  <span class="c1"># 24 hours</span>
<a id="__codelineno-62-53" name="__codelineno-62-53" href="#__codelineno-62-53"></a>                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a id="__codelineno-62-54" name="__codelineno-62-54" href="#__codelineno-62-54"></a>                    <span class="s2">&quot;revoked_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-62-55" name="__codelineno-62-55" href="#__codelineno-62-55"></a>                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
<a id="__codelineno-62-56" name="__codelineno-62-56" href="#__codelineno-62-56"></a>                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span>
<a id="__codelineno-62-57" name="__codelineno-62-57" href="#__codelineno-62-57"></a>                <span class="p">})</span>
<a id="__codelineno-62-58" name="__codelineno-62-58" href="#__codelineno-62-58"></a>            <span class="p">)</span>
<a id="__codelineno-62-59" name="__codelineno-62-59" href="#__codelineno-62-59"></a>
<a id="__codelineno-62-60" name="__codelineno-62-60" href="#__codelineno-62-60"></a>        <span class="c1"># Clear user token tracking</span>
<a id="__codelineno-62-61" name="__codelineno-62-61" href="#__codelineno-62-61"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user_tokens_key</span><span class="p">)</span>
<a id="__codelineno-62-62" name="__codelineno-62-62" href="#__codelineno-62-62"></a>
<a id="__codelineno-62-63" name="__codelineno-62-63" href="#__codelineno-62-63"></a>        <span class="c1"># Log bulk revocation</span>
<a id="__codelineno-62-64" name="__codelineno-62-64" href="#__codelineno-62-64"></a>        <span class="n">audit_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-62-65" name="__codelineno-62-65" href="#__codelineno-62-65"></a>            <span class="s2">&quot;All user tokens revoked&quot;</span><span class="p">,</span>
<a id="__codelineno-62-66" name="__codelineno-62-66" href="#__codelineno-62-66"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-62-67" name="__codelineno-62-67" href="#__codelineno-62-67"></a>                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-62-68" name="__codelineno-62-68" href="#__codelineno-62-68"></a>                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
<a id="__codelineno-62-69" name="__codelineno-62-69" href="#__codelineno-62-69"></a>                <span class="s2">&quot;token_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_jtis</span><span class="p">)</span>
<a id="__codelineno-62-70" name="__codelineno-62-70" href="#__codelineno-62-70"></a>            <span class="p">}</span>
<a id="__codelineno-62-71" name="__codelineno-62-71" href="#__codelineno-62-71"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="performance-optimization"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#performance-optimization">Performance Optimization</a></h3>
<h4 id="caching-strategy"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#caching-strategy">Caching Strategy</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">JWTPerformanceOptimizer</span><span class="p">:</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">get_redis_client</span><span class="p">()</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_stats</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;misses&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cached_validation</span><span class="p">(</span>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>        <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a>        <span class="n">validator</span><span class="p">:</span> <span class="n">JWTValidator</span>
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Multi-level caching for JWT validation&quot;&quot;&quot;</span>
<a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>
<a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a>        <span class="c1"># Level 1: In-memory cache (fastest)</span>
<a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;jwt:</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a>
<a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a>        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">:</span>
<a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a>            <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
<a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a>            <span class="k">if</span> <span class="n">cached_data</span><span class="p">[</span><span class="s2">&quot;expires&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">():</span>
<a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a>                <span class="k">return</span> <span class="n">cached_data</span><span class="p">[</span><span class="s2">&quot;payload&quot;</span><span class="p">]</span>
<a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-63-26" name="__codelineno-63-26" href="#__codelineno-63-26"></a>                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
<a id="__codelineno-63-27" name="__codelineno-63-27" href="#__codelineno-63-27"></a>
<a id="__codelineno-63-28" name="__codelineno-63-28" href="#__codelineno-63-28"></a>        <span class="c1"># Level 2: Redis cache (shared across instances)</span>
<a id="__codelineno-63-29" name="__codelineno-63-29" href="#__codelineno-63-29"></a>        <span class="n">redis_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;jwt_cache:</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-63-30" name="__codelineno-63-30" href="#__codelineno-63-30"></a>        <span class="n">cached_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
<a id="__codelineno-63-31" name="__codelineno-63-31" href="#__codelineno-63-31"></a>
<a id="__codelineno-63-32" name="__codelineno-63-32" href="#__codelineno-63-32"></a>        <span class="k">if</span> <span class="n">cached_payload</span><span class="p">:</span>
<a id="__codelineno-63-33" name="__codelineno-63-33" href="#__codelineno-63-33"></a>            <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cached_payload</span><span class="p">)</span>
<a id="__codelineno-63-34" name="__codelineno-63-34" href="#__codelineno-63-34"></a>
<a id="__codelineno-63-35" name="__codelineno-63-35" href="#__codelineno-63-35"></a>            <span class="c1"># Store in local cache</span>
<a id="__codelineno-63-36" name="__codelineno-63-36" href="#__codelineno-63-36"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-63-37" name="__codelineno-63-37" href="#__codelineno-63-37"></a>                <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
<a id="__codelineno-63-38" name="__codelineno-63-38" href="#__codelineno-63-38"></a>                <span class="s2">&quot;expires&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span>
<a id="__codelineno-63-39" name="__codelineno-63-39" href="#__codelineno-63-39"></a>            <span class="p">}</span>
<a id="__codelineno-63-40" name="__codelineno-63-40" href="#__codelineno-63-40"></a>
<a id="__codelineno-63-41" name="__codelineno-63-41" href="#__codelineno-63-41"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-63-42" name="__codelineno-63-42" href="#__codelineno-63-42"></a>            <span class="k">return</span> <span class="n">payload</span>
<a id="__codelineno-63-43" name="__codelineno-63-43" href="#__codelineno-63-43"></a>
<a id="__codelineno-63-44" name="__codelineno-63-44" href="#__codelineno-63-44"></a>        <span class="c1"># Level 3: Full validation (slowest)</span>
<a id="__codelineno-63-45" name="__codelineno-63-45" href="#__codelineno-63-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">[</span><span class="s2">&quot;misses&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-63-46" name="__codelineno-63-46" href="#__codelineno-63-46"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validator</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-63-47" name="__codelineno-63-47" href="#__codelineno-63-47"></a>
<a id="__codelineno-63-48" name="__codelineno-63-48" href="#__codelineno-63-48"></a>        <span class="c1"># Cache the result</span>
<a id="__codelineno-63-49" name="__codelineno-63-49" href="#__codelineno-63-49"></a>        <span class="n">ttl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
<a id="__codelineno-63-50" name="__codelineno-63-50" href="#__codelineno-63-50"></a>
<a id="__codelineno-63-51" name="__codelineno-63-51" href="#__codelineno-63-51"></a>        <span class="c1"># Redis cache (shared)</span>
<a id="__codelineno-63-52" name="__codelineno-63-52" href="#__codelineno-63-52"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span>
<a id="__codelineno-63-53" name="__codelineno-63-53" href="#__codelineno-63-53"></a>            <span class="n">redis_key</span><span class="p">,</span>
<a id="__codelineno-63-54" name="__codelineno-63-54" href="#__codelineno-63-54"></a>            <span class="nb">int</span><span class="p">(</span><span class="n">ttl</span><span class="p">),</span>
<a id="__codelineno-63-55" name="__codelineno-63-55" href="#__codelineno-63-55"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<a id="__codelineno-63-56" name="__codelineno-63-56" href="#__codelineno-63-56"></a>        <span class="p">)</span>
<a id="__codelineno-63-57" name="__codelineno-63-57" href="#__codelineno-63-57"></a>
<a id="__codelineno-63-58" name="__codelineno-63-58" href="#__codelineno-63-58"></a>        <span class="c1"># Local cache (instance-specific)</span>
<a id="__codelineno-63-59" name="__codelineno-63-59" href="#__codelineno-63-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-63-60" name="__codelineno-63-60" href="#__codelineno-63-60"></a>            <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
<a id="__codelineno-63-61" name="__codelineno-63-61" href="#__codelineno-63-61"></a>            <span class="s2">&quot;expires&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span>
<a id="__codelineno-63-62" name="__codelineno-63-62" href="#__codelineno-63-62"></a>        <span class="p">}</span>
<a id="__codelineno-63-63" name="__codelineno-63-63" href="#__codelineno-63-63"></a>
<a id="__codelineno-63-64" name="__codelineno-63-64" href="#__codelineno-63-64"></a>        <span class="k">return</span> <span class="n">payload</span>
<a id="__codelineno-63-65" name="__codelineno-63-65" href="#__codelineno-63-65"></a>
<a id="__codelineno-63-66" name="__codelineno-63-66" href="#__codelineno-63-66"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cache_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-63-67" name="__codelineno-63-67" href="#__codelineno-63-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get cache performance statistics&quot;&quot;&quot;</span>
<a id="__codelineno-63-68" name="__codelineno-63-68" href="#__codelineno-63-68"></a>        <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">[</span><span class="s2">&quot;misses&quot;</span><span class="p">]</span>
<a id="__codelineno-63-69" name="__codelineno-63-69" href="#__codelineno-63-69"></a>        <span class="n">hit_rate</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-63-70" name="__codelineno-63-70" href="#__codelineno-63-70"></a>
<a id="__codelineno-63-71" name="__codelineno-63-71" href="#__codelineno-63-71"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-63-72" name="__codelineno-63-72" href="#__codelineno-63-72"></a>            <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">],</span>
<a id="__codelineno-63-73" name="__codelineno-63-73" href="#__codelineno-63-73"></a>            <span class="s2">&quot;misses&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_stats</span><span class="p">[</span><span class="s2">&quot;misses&quot;</span><span class="p">],</span>
<a id="__codelineno-63-74" name="__codelineno-63-74" href="#__codelineno-63-74"></a>            <span class="s2">&quot;hit_rate&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hit_rate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
<a id="__codelineno-63-75" name="__codelineno-63-75" href="#__codelineno-63-75"></a>            <span class="s2">&quot;local_cache_size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_cache</span><span class="p">)</span>
<a id="__codelineno-63-76" name="__codelineno-63-76" href="#__codelineno-63-76"></a>        <span class="p">}</span>
</code></pre></div>
<h3 id="security-monitoring"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#security-monitoring">Security Monitoring</a></h3>
<h4 id="jwt-security-events"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#jwt-security-events">JWT Security Events</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">JWTSecurityMonitor</span><span class="p">:</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">audit_logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;jwt.security&quot;</span><span class="p">)</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_token_validation_attempt</span><span class="p">(</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>        <span class="n">token_hash</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a>        <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a>        <span class="n">error_reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a>    <span class="p">):</span>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Log token validation attempts for security monitoring&quot;&quot;&quot;</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">audit_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a>            <span class="s2">&quot;JWT validation attempt&quot;</span><span class="p">,</span>
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a>                <span class="s2">&quot;token_hash&quot;</span><span class="p">:</span> <span class="n">token_hash</span><span class="p">,</span>
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a>                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a>                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a>                <span class="s2">&quot;error_reason&quot;</span><span class="p">:</span> <span class="n">error_reason</span><span class="p">,</span>
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a>            <span class="p">}</span>
<a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a>        <span class="p">)</span>
<a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a>
<a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a>        <span class="c1"># Track metrics</span>
<a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a>        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="s2">&quot;failure&quot;</span>
<a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;validation_</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;validation_</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-64-29" name="__codelineno-64-29" href="#__codelineno-64-29"></a>
<a id="__codelineno-64-30" name="__codelineno-64-30" href="#__codelineno-64-30"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">detect_suspicious_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">activity_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<a id="__codelineno-64-31" name="__codelineno-64-31" href="#__codelineno-64-31"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect suspicious JWT-related activity&quot;&quot;&quot;</span>
<a id="__codelineno-64-32" name="__codelineno-64-32" href="#__codelineno-64-32"></a>
<a id="__codelineno-64-33" name="__codelineno-64-33" href="#__codelineno-64-33"></a>        <span class="c1"># Multiple failed validations</span>
<a id="__codelineno-64-34" name="__codelineno-64-34" href="#__codelineno-64-34"></a>        <span class="k">if</span> <span class="n">activity_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;failed_validations&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
<a id="__codelineno-64-35" name="__codelineno-64-35" href="#__codelineno-64-35"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">audit_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-64-36" name="__codelineno-64-36" href="#__codelineno-64-36"></a>                <span class="s2">&quot;Suspicious JWT activity: multiple failed validations&quot;</span><span class="p">,</span>
<a id="__codelineno-64-37" name="__codelineno-64-37" href="#__codelineno-64-37"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-64-38" name="__codelineno-64-38" href="#__codelineno-64-38"></a>                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-64-39" name="__codelineno-64-39" href="#__codelineno-64-39"></a>                    <span class="s2">&quot;failed_count&quot;</span><span class="p">:</span> <span class="n">activity_data</span><span class="p">[</span><span class="s2">&quot;failed_validations&quot;</span><span class="p">],</span>
<a id="__codelineno-64-40" name="__codelineno-64-40" href="#__codelineno-64-40"></a>                    <span class="s2">&quot;time_window&quot;</span><span class="p">:</span> <span class="s2">&quot;5_minutes&quot;</span>
<a id="__codelineno-64-41" name="__codelineno-64-41" href="#__codelineno-64-41"></a>                <span class="p">}</span>
<a id="__codelineno-64-42" name="__codelineno-64-42" href="#__codelineno-64-42"></a>            <span class="p">)</span>
<a id="__codelineno-64-43" name="__codelineno-64-43" href="#__codelineno-64-43"></a>
<a id="__codelineno-64-44" name="__codelineno-64-44" href="#__codelineno-64-44"></a>        <span class="c1"># Token reuse attempts</span>
<a id="__codelineno-64-45" name="__codelineno-64-45" href="#__codelineno-64-45"></a>        <span class="k">if</span> <span class="n">activity_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_reuse_attempts&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-64-46" name="__codelineno-64-46" href="#__codelineno-64-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">audit_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-64-47" name="__codelineno-64-47" href="#__codelineno-64-47"></a>                <span class="s2">&quot;Suspicious JWT activity: token reuse attempts&quot;</span><span class="p">,</span>
<a id="__codelineno-64-48" name="__codelineno-64-48" href="#__codelineno-64-48"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-64-49" name="__codelineno-64-49" href="#__codelineno-64-49"></a>                    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-64-50" name="__codelineno-64-50" href="#__codelineno-64-50"></a>                    <span class="s2">&quot;reuse_attempts&quot;</span><span class="p">:</span> <span class="n">activity_data</span><span class="p">[</span><span class="s2">&quot;token_reuse_attempts&quot;</span><span class="p">]</span>
<a id="__codelineno-64-51" name="__codelineno-64-51" href="#__codelineno-64-51"></a>                <span class="p">}</span>
<a id="__codelineno-64-52" name="__codelineno-64-52" href="#__codelineno-64-52"></a>            <span class="p">)</span>
</code></pre></div>
<h3 id="testing-jwt-implementation"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#testing-jwt-implementation">Testing JWT Implementation</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="c1"># tests/test_jwt_authentication.py</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.security.jwt_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTTokenManager</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.security.jwt_validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTValidator</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestJWTAuthentication</span><span class="p">:</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">jwt_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>        <span class="c1"># Use test keys</span>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a>        <span class="n">private_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;-----BEGIN PRIVATE KEY-----</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="s2">        [Test private key content]</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a><span class="s2">        -----END PRIVATE KEY-----&quot;&quot;&quot;</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>        <span class="n">public_key</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;-----BEGIN PUBLIC KEY-----</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a><span class="s2">        [Test public key content]</span>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a><span class="s2">        -----END PUBLIC KEY-----&quot;&quot;&quot;</span>
<a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a>
<a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a>        <span class="k">return</span> <span class="n">JWTTokenManager</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">public_key</span><span class="p">)</span>
<a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a>
<a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a>    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<a id="__codelineno-65-22" name="__codelineno-65-22" href="#__codelineno-65-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">jwt_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="p">):</span>
<a id="__codelineno-65-23" name="__codelineno-65-23" href="#__codelineno-65-23"></a>        <span class="k">return</span> <span class="n">JWTValidator</span><span class="p">(</span><span class="n">jwt_manager</span><span class="o">.</span><span class="n">public_key</span><span class="p">)</span>
<a id="__codelineno-65-24" name="__codelineno-65-24" href="#__codelineno-65-24"></a>
<a id="__codelineno-65-25" name="__codelineno-65-25" href="#__codelineno-65-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_valid_access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="p">):</span>
<a id="__codelineno-65-26" name="__codelineno-65-26" href="#__codelineno-65-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test creating a valid access token&quot;&quot;&quot;</span>
<a id="__codelineno-65-27" name="__codelineno-65-27" href="#__codelineno-65-27"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
<a id="__codelineno-65-28" name="__codelineno-65-28" href="#__codelineno-65-28"></a>            <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
<a id="__codelineno-65-29" name="__codelineno-65-29" href="#__codelineno-65-29"></a>            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-65-30" name="__codelineno-65-30" href="#__codelineno-65-30"></a>            <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">],</span>
<a id="__codelineno-65-31" name="__codelineno-65-31" href="#__codelineno-65-31"></a>            <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;orders:read&quot;</span><span class="p">,</span> <span class="s2">&quot;profile:update&quot;</span><span class="p">]</span>
<a id="__codelineno-65-32" name="__codelineno-65-32" href="#__codelineno-65-32"></a>        <span class="p">)</span>
<a id="__codelineno-65-33" name="__codelineno-65-33" href="#__codelineno-65-33"></a>
<a id="__codelineno-65-34" name="__codelineno-65-34" href="#__codelineno-65-34"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-65-35" name="__codelineno-65-35" href="#__codelineno-65-35"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># JWT has 3 parts</span>
<a id="__codelineno-65-36" name="__codelineno-65-36" href="#__codelineno-65-36"></a>
<a id="__codelineno-65-37" name="__codelineno-65-37" href="#__codelineno-65-37"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_validate_valid_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="p">,</span> <span class="n">jwt_validator</span><span class="p">):</span>
<a id="__codelineno-65-38" name="__codelineno-65-38" href="#__codelineno-65-38"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test validating a valid token&quot;&quot;&quot;</span>
<a id="__codelineno-65-39" name="__codelineno-65-39" href="#__codelineno-65-39"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
<a id="__codelineno-65-40" name="__codelineno-65-40" href="#__codelineno-65-40"></a>            <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
<a id="__codelineno-65-41" name="__codelineno-65-41" href="#__codelineno-65-41"></a>            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-65-42" name="__codelineno-65-42" href="#__codelineno-65-42"></a>            <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">],</span>
<a id="__codelineno-65-43" name="__codelineno-65-43" href="#__codelineno-65-43"></a>            <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;orders:read&quot;</span><span class="p">]</span>
<a id="__codelineno-65-44" name="__codelineno-65-44" href="#__codelineno-65-44"></a>        <span class="p">)</span>
<a id="__codelineno-65-45" name="__codelineno-65-45" href="#__codelineno-65-45"></a>
<a id="__codelineno-65-46" name="__codelineno-65-46" href="#__codelineno-65-46"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="k">await</span> <span class="n">jwt_validator</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-65-47" name="__codelineno-65-47" href="#__codelineno-65-47"></a>
<a id="__codelineno-65-48" name="__codelineno-65-48" href="#__codelineno-65-48"></a>        <span class="k">assert</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;user123&quot;</span>
<a id="__codelineno-65-49" name="__codelineno-65-49" href="#__codelineno-65-49"></a>        <span class="k">assert</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;test@example.com&quot;</span>
<a id="__codelineno-65-50" name="__codelineno-65-50" href="#__codelineno-65-50"></a>        <span class="k">assert</span> <span class="s2">&quot;customer&quot;</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;roles&quot;</span><span class="p">]</span>
<a id="__codelineno-65-51" name="__codelineno-65-51" href="#__codelineno-65-51"></a>        <span class="k">assert</span> <span class="s2">&quot;orders:read&quot;</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;permissions&quot;</span><span class="p">]</span>
<a id="__codelineno-65-52" name="__codelineno-65-52" href="#__codelineno-65-52"></a>
<a id="__codelineno-65-53" name="__codelineno-65-53" href="#__codelineno-65-53"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_reject_expired_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="p">,</span> <span class="n">jwt_validator</span><span class="p">):</span>
<a id="__codelineno-65-54" name="__codelineno-65-54" href="#__codelineno-65-54"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that expired tokens are rejected&quot;&quot;&quot;</span>
<a id="__codelineno-65-55" name="__codelineno-65-55" href="#__codelineno-65-55"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
<a id="__codelineno-65-56" name="__codelineno-65-56" href="#__codelineno-65-56"></a>            <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
<a id="__codelineno-65-57" name="__codelineno-65-57" href="#__codelineno-65-57"></a>            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-65-58" name="__codelineno-65-58" href="#__codelineno-65-58"></a>            <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">],</span>
<a id="__codelineno-65-59" name="__codelineno-65-59" href="#__codelineno-65-59"></a>            <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;orders:read&quot;</span><span class="p">],</span>
<a id="__codelineno-65-60" name="__codelineno-65-60" href="#__codelineno-65-60"></a>            <span class="n">expires_delta</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Already expired</span>
<a id="__codelineno-65-61" name="__codelineno-65-61" href="#__codelineno-65-61"></a>        <span class="p">)</span>
<a id="__codelineno-65-62" name="__codelineno-65-62" href="#__codelineno-65-62"></a>
<a id="__codelineno-65-63" name="__codelineno-65-63" href="#__codelineno-65-63"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">AuthenticationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Token has expired&quot;</span><span class="p">):</span>
<a id="__codelineno-65-64" name="__codelineno-65-64" href="#__codelineno-65-64"></a>            <span class="k">await</span> <span class="n">jwt_validator</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-65-65" name="__codelineno-65-65" href="#__codelineno-65-65"></a>
<a id="__codelineno-65-66" name="__codelineno-65-66" href="#__codelineno-65-66"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_reject_invalid_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_validator</span><span class="p">):</span>
<a id="__codelineno-65-67" name="__codelineno-65-67" href="#__codelineno-65-67"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that tokens with invalid signatures are rejected&quot;&quot;&quot;</span>
<a id="__codelineno-65-68" name="__codelineno-65-68" href="#__codelineno-65-68"></a>        <span class="c1"># Token with wrong signature</span>
<a id="__codelineno-65-69" name="__codelineno-65-69" href="#__codelineno-65-69"></a>        <span class="n">invalid_token</span> <span class="o">=</span> <span class="s2">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJ1c2VyMTIzIn0.invalid_signature&quot;</span>
<a id="__codelineno-65-70" name="__codelineno-65-70" href="#__codelineno-65-70"></a>
<a id="__codelineno-65-71" name="__codelineno-65-71" href="#__codelineno-65-71"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">AuthenticationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid token&quot;</span><span class="p">):</span>
<a id="__codelineno-65-72" name="__codelineno-65-72" href="#__codelineno-65-72"></a>            <span class="k">await</span> <span class="n">jwt_validator</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">invalid_token</span><span class="p">)</span>
<a id="__codelineno-65-73" name="__codelineno-65-73" href="#__codelineno-65-73"></a>
<a id="__codelineno-65-74" name="__codelineno-65-74" href="#__codelineno-65-74"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_token_revocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jwt_manager</span><span class="p">,</span> <span class="n">jwt_validator</span><span class="p">):</span>
<a id="__codelineno-65-75" name="__codelineno-65-75" href="#__codelineno-65-75"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test token revocation functionality&quot;&quot;&quot;</span>
<a id="__codelineno-65-76" name="__codelineno-65-76" href="#__codelineno-65-76"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">jwt_manager</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
<a id="__codelineno-65-77" name="__codelineno-65-77" href="#__codelineno-65-77"></a>            <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user123&quot;</span><span class="p">,</span>
<a id="__codelineno-65-78" name="__codelineno-65-78" href="#__codelineno-65-78"></a>            <span class="n">email</span><span class="o">=</span><span class="s2">&quot;test@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-65-79" name="__codelineno-65-79" href="#__codelineno-65-79"></a>            <span class="n">roles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;customer&quot;</span><span class="p">],</span>
<a id="__codelineno-65-80" name="__codelineno-65-80" href="#__codelineno-65-80"></a>            <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;orders:read&quot;</span><span class="p">]</span>
<a id="__codelineno-65-81" name="__codelineno-65-81" href="#__codelineno-65-81"></a>        <span class="p">)</span>
<a id="__codelineno-65-82" name="__codelineno-65-82" href="#__codelineno-65-82"></a>
<a id="__codelineno-65-83" name="__codelineno-65-83" href="#__codelineno-65-83"></a>        <span class="c1"># Token should be valid initially</span>
<a id="__codelineno-65-84" name="__codelineno-65-84" href="#__codelineno-65-84"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="k">await</span> <span class="n">jwt_validator</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-65-85" name="__codelineno-65-85" href="#__codelineno-65-85"></a>        <span class="k">assert</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;user123&quot;</span>
<a id="__codelineno-65-86" name="__codelineno-65-86" href="#__codelineno-65-86"></a>
<a id="__codelineno-65-87" name="__codelineno-65-87" href="#__codelineno-65-87"></a>        <span class="c1"># Revoke token</span>
<a id="__codelineno-65-88" name="__codelineno-65-88" href="#__codelineno-65-88"></a>        <span class="n">revocation_service</span> <span class="o">=</span> <span class="n">TokenRevocationService</span><span class="p">()</span>
<a id="__codelineno-65-89" name="__codelineno-65-89" href="#__codelineno-65-89"></a>        <span class="k">await</span> <span class="n">revocation_service</span><span class="o">.</span><span class="n">revoke_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;test_revocation&quot;</span><span class="p">)</span>
<a id="__codelineno-65-90" name="__codelineno-65-90" href="#__codelineno-65-90"></a>
<a id="__codelineno-65-91" name="__codelineno-65-91" href="#__codelineno-65-91"></a>        <span class="c1"># Token should now be rejected</span>
<a id="__codelineno-65-92" name="__codelineno-65-92" href="#__codelineno-65-92"></a>        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">AuthenticationError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Token has been revoked&quot;</span><span class="p">):</span>
<a id="__codelineno-65-93" name="__codelineno-65-93" href="#__codelineno-65-93"></a>            <span class="k">await</span> <span class="n">jwt_validator</span><span class="o">.</span><span class="n">validate_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</code></pre></div>
<h3 id="production-deployment-checklist"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#production-deployment-checklist">Production Deployment Checklist</a></h3>
<p>Before deploying JWT authentication to production:</p>
<h4 id="security-configuration"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#security-configuration">Security Configuration</a></h4>
<ul>
<li>[ ] Use RS256 algorithm with proper key pairs</li>
<li>[ ] Store private keys in AWS Secrets Manager</li>
<li>[ ] Configure automatic key rotation</li>
<li>[ ] Implement token revocation system</li>
<li>[ ] Set appropriate token expiration times</li>
<li>[ ] Enable comprehensive audit logging</li>
</ul>
<h4 id="performance-optimization_1"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#performance-optimization_1">Performance Optimization</a></h4>
<ul>
<li>[ ] Implement multi-level caching</li>
<li>[ ] Configure Redis for shared cache</li>
<li>[ ] Monitor validation performance</li>
<li>[ ] Set up cache metrics and alerts</li>
<li>[ ] Optimize token payload size</li>
</ul>
<h4 id="aws-integration"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#aws-integration">AWS Integration</a></h4>
<ul>
<li>[ ] Configure API Gateway custom authorizer</li>
<li>[ ] Set up ECS/Lambda middleware</li>
<li>[ ] Integrate with AWS Cognito if needed</li>
<li>[ ] Configure CloudWatch monitoring</li>
<li>[ ] Set up security alerts</li>
</ul>
<h4 id="monitoring-and-maintenance"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#monitoring-and-maintenance">Monitoring and Maintenance</a></h4>
<ul>
<li>[ ] Track token validation metrics</li>
<li>[ ] Monitor for suspicious activity</li>
<li>[ ] Set up key rotation alerts</li>
<li>[ ] Configure performance monitoring</li>
<li>[ ] Plan incident response procedures</li>
</ul>
<h3 id="conclusion"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#conclusion">Conclusion</a></h3>
<p>JWT authentication in AWS environments requires careful attention to security, performance, and operational concerns. The clean-py repository provides a production-ready foundation that handles the complexities of key management, token validation, caching, and AWS integration.</p>
<p>Key takeaways for production JWT implementation:</p>
<ol>
<li><strong>Security First</strong>: Use RS256, proper key management, and comprehensive validation</li>
<li><strong>Performance Matters</strong>: Implement caching and optimize validation paths</li>
<li><strong>AWS Integration</strong>: Leverage AWS services for scalability and security</li>
<li><strong>Monitoring Essential</strong>: Track security events and performance metrics</li>
<li><strong>Operational Excellence</strong>: Plan for key rotation, incident response, and maintenance</li>
</ol>
<p>The difference between a basic JWT implementation and a production-ready system lies in the details—proper error handling, performance optimization, security monitoring, and operational procedures. The clean-py patterns provide these details, giving you a solid foundation for enterprise authentication systems.</p>
<h3 id="references"><a class="toclink" href="../../2025/07/12/jwt-authentication-in-aws---from-development-to-production/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Production JWT implementation</li>
<li><a href="https://tools.ietf.org/html/rfc7519">RFC 7519</a> - JSON Web Token specification</li>
<li><a href="https://docs.aws.amazon.com/cognito/">AWS Cognito Documentation</a> - AWS authentication service</li>
<li><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-jwt-bcp">JWT Best Practices</a> - Security considerations</li>
</ul>
<p>Start with security, optimize for performance, integrate with AWS services, and build comprehensive monitoring from day one. Your users depend on secure authentication, and your operations team will thank you for building a system that's observable, maintainable, and secure.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
      <nav class="md-post__authors md-typeset">
        
          <span class="md-author">
            <img src="https://github.com/buildshift-dev.png" alt="BuildShift Developer">
          </span>
        
      </nav>
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2025-07-09 19:35:00-04:00">Jul 9, 2025</time></li>
        
          <li class="md-meta__item">
            in
            
              <a href="./" class="md-meta__link">Security</a>, 
              <a href="../python/" class="md-meta__link">Python</a>, 
              <a href="../aws/" class="md-meta__link">AWS</a></li>
        
        
          
          <li class="md-meta__item">
            
              10 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="securing-python-applications-beyond-owasp"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/">Securing Python Applications: Beyond OWASP</a></h2>
<p>Security isn't a feature you add at the end of development—it's a foundation you build from the beginning. Too many Python applications treat security as an afterthought, implementing basic input validation and calling it done. But modern application security requires defense in depth, from secure coding practices to infrastructure hardening, from data protection to monitoring and incident response.</p>
<p>The <a href="https://github.com/buildshift-dev/clean-py">clean-py repository</a> demonstrates a comprehensive security framework that goes beyond the OWASP Top 10, implementing production-ready security patterns for Python applications deployed on AWS. This isn't just about preventing common vulnerabilities—it's about building security into the DNA of your application architecture.</p>
<h3 id="the-modern-threat-landscape"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#the-modern-threat-landscape">The Modern Threat Landscape</a></h3>
<p>Application security has evolved far beyond SQL injection and cross-site scripting. Modern attackers target:</p>
<ul>
<li><strong>Supply chain vulnerabilities</strong> through compromised dependencies</li>
<li><strong>Infrastructure misconfigurations</strong> in cloud deployments  </li>
<li><strong>Data exfiltration</strong> through API abuse and privilege escalation</li>
<li><strong>Business logic flaws</strong> that bypass technical controls</li>
<li><strong>Social engineering</strong> targeting developers and operations teams</li>
</ul>
<p>I recently worked with a company that had "secured" their application according to OWASP guidelines—input validation, parameterized queries, secure headers. They felt confident until an attacker discovered they could manipulate business logic to transfer money between accounts by sending negative amounts, effectively reversing transactions. No SQL injection required.</p>
<p>This incident reinforced a critical lesson: comprehensive security requires securing the entire stack, not just the web layer.</p>
<h3 id="security-by-design-the-clean-architecture-advantage"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#security-by-design-the-clean-architecture-advantage">Security by Design: The Clean Architecture Advantage</a></h3>
<p>Clean Architecture provides natural security boundaries through its layered approach. Security concerns are isolated and can be implemented systematically:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>│                    Presentation Layer                       │
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>│  • Input validation • Rate limiting • Authentication       │
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>│  • CORS policies   • Security headers • Request sanitization│
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>                                │
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>│                    Application Layer                        │
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>│  • Authorization  • Audit logging • Business rule validation│
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>│  • Command/Query separation • Input sanitization           │
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>                                │
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a>│                     Domain Layer                            │
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a>│  • Business invariants • Domain validation • Entity integrity│
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>│  • Pure business logic • No external dependencies          │
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a>└─────────────────────────────────────────────────────────────┘
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a>                                │
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a>┌─────────────────────────────────────────────────────────────┐
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a>│                  Infrastructure Layer                       │
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a>│  • Data encryption • Secure storage • Network security     │
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a>│  • Key management • Secrets handling • Monitoring          │
<a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a>└─────────────────────────────────────────────────────────────┘
</code></pre></div>
<p>Each layer has specific security responsibilities that work together to create defense in depth.</p>
<h3 id="input-validation-and-sanitization"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#input-validation-and-sanitization">Input Validation and Sanitization</a></h3>
<p>The first line of defense is comprehensive input validation. The clean-py repository uses Pydantic for both validation and sanitization:</p>
<h4 id="secure-input-models"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#secure-input-models">Secure Input Models</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span><span class="p">,</span> <span class="n">EmailStr</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureUserRegistration</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>        <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>        <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>        <span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_-]+$&#39;</span>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>    <span class="p">)</span>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a>    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a>    <span class="n">last_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>    <span class="n">phone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^\+?1?[0-9]{10,15}$&#39;</span><span class="p">)</span>
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>
<a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">)</span>
<a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_names</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a>        <span class="c1"># Remove potential script injection</span>
<a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a>        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[&lt;&gt;&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<a id="__codelineno-61-21" name="__codelineno-61-21" href="#__codelineno-61-21"></a>        <span class="k">return</span> <span class="n">sanitized</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-61-22" name="__codelineno-61-22" href="#__codelineno-61-22"></a>
<a id="__codelineno-61-23" name="__codelineno-61-23" href="#__codelineno-61-23"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
<a id="__codelineno-61-24" name="__codelineno-61-24" href="#__codelineno-61-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_password_strength</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-61-25" name="__codelineno-61-25" href="#__codelineno-61-25"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z]&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-61-26" name="__codelineno-61-26" href="#__codelineno-61-26"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Password must contain uppercase letter&#39;</span><span class="p">)</span>
<a id="__codelineno-61-27" name="__codelineno-61-27" href="#__codelineno-61-27"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-z]&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-61-28" name="__codelineno-61-28" href="#__codelineno-61-28"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Password must contain lowercase letter&#39;</span><span class="p">)</span>
<a id="__codelineno-61-29" name="__codelineno-61-29" href="#__codelineno-61-29"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-61-30" name="__codelineno-61-30" href="#__codelineno-61-30"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Password must contain digit&#39;</span><span class="p">)</span>
<a id="__codelineno-61-31" name="__codelineno-61-31" href="#__codelineno-61-31"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[!@#$%^&amp;*(),.?&quot;:</span><span class="si">{}</span><span class="s1">|&lt;&gt;]&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-61-32" name="__codelineno-61-32" href="#__codelineno-61-32"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Password must contain special character&#39;</span><span class="p">)</span>
<a id="__codelineno-61-33" name="__codelineno-61-33" href="#__codelineno-61-33"></a>        <span class="k">return</span> <span class="n">v</span>
</code></pre></div>
<h4 id="advanced-validation-patterns"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#advanced-validation-patterns">Advanced Validation Patterns</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">InvalidOperation</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecureOrderRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>    <span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">OrderItem</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_items</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>    <span class="n">shipping_address</span><span class="p">:</span> <span class="n">Address</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>    <span class="n">payment_method</span><span class="p">:</span> <span class="n">PaymentMethod</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>    <span class="n">discount_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">)</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_order_items</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>        <span class="c1"># Business logic validation</span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>        <span class="n">total_quantity</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">quantity</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>        <span class="k">if</span> <span class="n">total_quantity</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Order exceeds maximum quantity limit&#39;</span><span class="p">)</span>
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>
<a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>        <span class="c1"># Check for suspicious patterns</span>
<a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a>        <span class="n">unique_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">product_id</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
<a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_items</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
<a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Duplicate items detected&#39;</span><span class="p">)</span>
<a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a>
<a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a>        <span class="k">return</span> <span class="n">items</span>
<a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a>
<a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a>    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;discount_code&#39;</span><span class="p">)</span>
<a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_discount_code</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a id="__codelineno-62-25" name="__codelineno-62-25" href="#__codelineno-62-25"></a>        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-62-26" name="__codelineno-62-26" href="#__codelineno-62-26"></a>            <span class="k">return</span> <span class="n">v</span>
<a id="__codelineno-62-27" name="__codelineno-62-27" href="#__codelineno-62-27"></a>        <span class="c1"># Allow only alphanumeric and common symbols</span>
<a id="__codelineno-62-28" name="__codelineno-62-28" href="#__codelineno-62-28"></a>        <span class="n">sanitized</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9\-_]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<a id="__codelineno-62-29" name="__codelineno-62-29" href="#__codelineno-62-29"></a>        <span class="k">return</span> <span class="n">sanitized</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</code></pre></div>
<h3 id="authentication-and-authorization"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#authentication-and-authorization">Authentication and Authorization</a></h3>
<p>The clean-py repository implements a comprehensive authentication and authorization system with JWT tokens and role-based access control.</p>
<h4 id="jwt-token-security"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#jwt-token-security">JWT Token Security</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.hazmat.primitives</span><span class="w"> </span><span class="kn">import</span> <span class="n">serialization</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">JWTSecurityManager</span><span class="p">:</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">public_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RS256&quot;</span><span class="p">):</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>            <span class="n">private_key</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>            <span class="n">password</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>        <span class="p">)</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a>            <span class="n">public_key</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a>        <span class="p">)</span>
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
<a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>
<a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span>
<a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a>        <span class="n">roles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a>        <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a>        <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a>        <span class="k">if</span> <span class="n">expires_delta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a>            <span class="n">expires_delta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># Short-lived access tokens</span>
<a id="__codelineno-63-26" name="__codelineno-63-26" href="#__codelineno-63-26"></a>
<a id="__codelineno-63-27" name="__codelineno-63-27" href="#__codelineno-63-27"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-63-28" name="__codelineno-63-28" href="#__codelineno-63-28"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-63-29" name="__codelineno-63-29" href="#__codelineno-63-29"></a>            <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-63-30" name="__codelineno-63-30" href="#__codelineno-63-30"></a>            <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
<a id="__codelineno-63-31" name="__codelineno-63-31" href="#__codelineno-63-31"></a>            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">expires_delta</span><span class="p">,</span>
<a id="__codelineno-63-32" name="__codelineno-63-32" href="#__codelineno-63-32"></a>            <span class="s2">&quot;iss&quot;</span><span class="p">:</span> <span class="s2">&quot;https://auth.yourapp.com&quot;</span><span class="p">,</span>
<a id="__codelineno-63-33" name="__codelineno-63-33" href="#__codelineno-63-33"></a>            <span class="s2">&quot;aud&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.yourapp.com&quot;</span><span class="p">,</span>
<a id="__codelineno-63-34" name="__codelineno-63-34" href="#__codelineno-63-34"></a>            <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">roles</span><span class="p">,</span>
<a id="__codelineno-63-35" name="__codelineno-63-35" href="#__codelineno-63-35"></a>            <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="n">scopes</span><span class="p">,</span>
<a id="__codelineno-63-36" name="__codelineno-63-36" href="#__codelineno-63-36"></a>            <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span>
<a id="__codelineno-63-37" name="__codelineno-63-37" href="#__codelineno-63-37"></a>        <span class="p">}</span>
<a id="__codelineno-63-38" name="__codelineno-63-38" href="#__codelineno-63-38"></a>
<a id="__codelineno-63-39" name="__codelineno-63-39" href="#__codelineno-63-39"></a>        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
<a id="__codelineno-63-40" name="__codelineno-63-40" href="#__codelineno-63-40"></a>
<a id="__codelineno-63-41" name="__codelineno-63-41" href="#__codelineno-63-41"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-63-42" name="__codelineno-63-42" href="#__codelineno-63-42"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-63-43" name="__codelineno-63-43" href="#__codelineno-63-43"></a>            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
<a id="__codelineno-63-44" name="__codelineno-63-44" href="#__codelineno-63-44"></a>                <span class="n">token</span><span class="p">,</span>
<a id="__codelineno-63-45" name="__codelineno-63-45" href="#__codelineno-63-45"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="p">,</span>
<a id="__codelineno-63-46" name="__codelineno-63-46" href="#__codelineno-63-46"></a>                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">],</span>
<a id="__codelineno-63-47" name="__codelineno-63-47" href="#__codelineno-63-47"></a>                <span class="n">audience</span><span class="o">=</span><span class="s2">&quot;https://api.yourapp.com&quot;</span><span class="p">,</span>
<a id="__codelineno-63-48" name="__codelineno-63-48" href="#__codelineno-63-48"></a>                <span class="n">issuer</span><span class="o">=</span><span class="s2">&quot;https://auth.yourapp.com&quot;</span>
<a id="__codelineno-63-49" name="__codelineno-63-49" href="#__codelineno-63-49"></a>            <span class="p">)</span>
<a id="__codelineno-63-50" name="__codelineno-63-50" href="#__codelineno-63-50"></a>            <span class="k">return</span> <span class="n">payload</span>
<a id="__codelineno-63-51" name="__codelineno-63-51" href="#__codelineno-63-51"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
<a id="__codelineno-63-52" name="__codelineno-63-52" href="#__codelineno-63-52"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Token has expired&quot;</span><span class="p">)</span>
<a id="__codelineno-63-53" name="__codelineno-63-53" href="#__codelineno-63-53"></a>        <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">InvalidTokenError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-63-54" name="__codelineno-63-54" href="#__codelineno-63-54"></a>            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid token: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="role-based-authorization"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#role-based-authorization">Role-Based Authorization</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">require_permissions</span><span class="p">(</span><span class="n">required_permissions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>            <span class="c1"># Extract current user context from request</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a>            <span class="n">current_user</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;current_user&#39;</span><span class="p">)</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="p">:</span>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a>                <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s2">&quot;Authentication required&quot;</span><span class="p">)</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a>            <span class="c1"># Check permissions</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a>            <span class="n">user_permissions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">permissions</span><span class="p">)</span>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a>            <span class="n">required_perms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_permissions</span><span class="p">)</span>
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a>
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">required_perms</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">user_permissions</span><span class="p">):</span>
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a>                <span class="n">missing_perms</span> <span class="o">=</span> <span class="n">required_perms</span> <span class="o">-</span> <span class="n">user_permissions</span>
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a>                <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span>
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a>                    <span class="sa">f</span><span class="s2">&quot;Missing permissions: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_perms</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a>                <span class="p">)</span>
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a>
<a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a>            <span class="k">return</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a>        <span class="k">return</span> <span class="n">wrapper</span>
<a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a>    <span class="k">return</span> <span class="n">decorator</span>
<a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a>
<a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a><span class="c1"># Usage in use cases</span>
<a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a><span class="k">class</span><span class="w"> </span><span class="nc">OrderService</span><span class="p">:</span>
<a id="__codelineno-64-29" name="__codelineno-64-29" href="#__codelineno-64-29"></a>    <span class="nd">@require_permissions</span><span class="p">([</span><span class="s2">&quot;orders:create&quot;</span><span class="p">,</span> <span class="s2">&quot;payments:process&quot;</span><span class="p">])</span>
<a id="__codelineno-64-30" name="__codelineno-64-30" href="#__codelineno-64-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span>
<a id="__codelineno-64-31" name="__codelineno-64-31" href="#__codelineno-64-31"></a>        <span class="c1"># Implementation with guaranteed authorization</span>
<a id="__codelineno-64-32" name="__codelineno-64-32" href="#__codelineno-64-32"></a>        <span class="k">pass</span>
</code></pre></div>
<h3 id="data-protection-and-encryption"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#data-protection-and-encryption">Data Protection and Encryption</a></h3>
<p>Protecting sensitive data requires encryption at multiple levels:</p>
<h4 id="field-level-encryption"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#field-level-encryption">Field-Level Encryption</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.fernet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fernet</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">FieldEncryption</span><span class="p">:</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encryption_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">encryption_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Encrypt sensitive field data&quot;&quot;&quot;</span>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a>            <span class="k">return</span> <span class="n">value</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a>        <span class="n">encrypted_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">encrypted_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decrypt_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encrypted_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decrypt sensitive field data&quot;&quot;&quot;</span>
<a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">encrypted_value</span><span class="p">:</span>
<a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a>            <span class="k">return</span> <span class="n">encrypted_value</span>
<a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a>
<a id="__codelineno-65-22" name="__codelineno-65-22" href="#__codelineno-65-22"></a>        <span class="n">encrypted_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encrypted_value</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<a id="__codelineno-65-23" name="__codelineno-65-23" href="#__codelineno-65-23"></a>        <span class="n">decrypted_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_bytes</span><span class="p">)</span>
<a id="__codelineno-65-24" name="__codelineno-65-24" href="#__codelineno-65-24"></a>        <span class="k">return</span> <span class="n">decrypted_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-65-25" name="__codelineno-65-25" href="#__codelineno-65-25"></a>
<a id="__codelineno-65-26" name="__codelineno-65-26" href="#__codelineno-65-26"></a><span class="c1"># Use in domain entities</span>
<a id="__codelineno-65-27" name="__codelineno-65-27" href="#__codelineno-65-27"></a><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">:</span>
<a id="__codelineno-65-28" name="__codelineno-65-28" href="#__codelineno-65-28"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">phone</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">encryption_service</span><span class="p">:</span> <span class="n">FieldEncryption</span><span class="p">):</span>
<a id="__codelineno-65-29" name="__codelineno-65-29" href="#__codelineno-65-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>  <span class="c1"># Store in plain text for queries</span>
<a id="__codelineno-65-30" name="__codelineno-65-30" href="#__codelineno-65-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encrypted_phone</span> <span class="o">=</span> <span class="n">encryption_service</span><span class="o">.</span><span class="n">encrypt_field</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span>
<a id="__codelineno-65-31" name="__codelineno-65-31" href="#__codelineno-65-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encryption_service</span> <span class="o">=</span> <span class="n">encryption_service</span>
<a id="__codelineno-65-32" name="__codelineno-65-32" href="#__codelineno-65-32"></a>
<a id="__codelineno-65-33" name="__codelineno-65-33" href="#__codelineno-65-33"></a>    <span class="nd">@property</span>
<a id="__codelineno-65-34" name="__codelineno-65-34" href="#__codelineno-65-34"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">phone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-65-35" name="__codelineno-65-35" href="#__codelineno-65-35"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encryption_service</span><span class="o">.</span><span class="n">decrypt_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encrypted_phone</span><span class="p">)</span>
</code></pre></div>
<h4 id="database-encryption"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#database-encryption">Database Encryption</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="c1"># Hybrid approach: searchable fields + encrypted sensitive data</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">CustomerRepository</span><span class="p">:</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Customer</span><span class="p">:</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>        <span class="c1"># Encrypt PII before storage</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>        <span class="n">encrypted_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">customer_data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>  <span class="c1"># Searchable</span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>            <span class="s2">&quot;email_hash&quot;</span><span class="p">:</span> <span class="n">hash_for_search</span><span class="p">(</span><span class="n">customer_data</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]),</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>            <span class="s2">&quot;encrypted_phone&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_field</span><span class="p">(</span><span class="n">customer_data</span><span class="p">[</span><span class="s2">&quot;phone&quot;</span><span class="p">]),</span>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>            <span class="s2">&quot;encrypted_address&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">encrypt_field</span><span class="p">(</span><span class="n">customer_data</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">]),</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>        <span class="p">}</span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a>            <span class="s2">&quot;INSERT INTO customers (...) VALUES (...)&quot;</span><span class="p">,</span>
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>            <span class="n">encrypted_data</span>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>        <span class="p">)</span>
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a>        <span class="k">return</span> <span class="n">Customer</span><span class="o">.</span><span class="n">from_db</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<h3 id="api-security-patterns"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#api-security-patterns">API Security Patterns</a></h3>
<h4 id="rate-limiting-and-throttling"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#rate-limiting-and-throttling">Rate Limiting and Throttling</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPException</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">RateLimiter</span><span class="p">:</span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_old_requests</span><span class="p">())</span>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_rate_limit</span><span class="p">(</span>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a>        <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a>        <span class="n">max_requests</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a>        <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a>        <span class="n">window_start</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">window_seconds</span>
<a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a>
<a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a>        <span class="c1"># Clean old requests</span>
<a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a>        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
<a id="__codelineno-67-22" name="__codelineno-67-22" href="#__codelineno-67-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-67-23" name="__codelineno-67-23" href="#__codelineno-67-23"></a>                <span class="n">req_time</span> <span class="k">for</span> <span class="n">req_time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
<a id="__codelineno-67-24" name="__codelineno-67-24" href="#__codelineno-67-24"></a>                <span class="k">if</span> <span class="n">req_time</span> <span class="o">&gt;</span> <span class="n">window_start</span>
<a id="__codelineno-67-25" name="__codelineno-67-25" href="#__codelineno-67-25"></a>            <span class="p">]</span>
<a id="__codelineno-67-26" name="__codelineno-67-26" href="#__codelineno-67-26"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-67-27" name="__codelineno-67-27" href="#__codelineno-67-27"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-67-28" name="__codelineno-67-28" href="#__codelineno-67-28"></a>
<a id="__codelineno-67-29" name="__codelineno-67-29" href="#__codelineno-67-29"></a>        <span class="c1"># Check if limit exceeded</span>
<a id="__codelineno-67-30" name="__codelineno-67-30" href="#__codelineno-67-30"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">identifier</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">max_requests</span><span class="p">:</span>
<a id="__codelineno-67-31" name="__codelineno-67-31" href="#__codelineno-67-31"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-67-32" name="__codelineno-67-32" href="#__codelineno-67-32"></a>
<a id="__codelineno-67-33" name="__codelineno-67-33" href="#__codelineno-67-33"></a>        <span class="c1"># Record this request</span>
<a id="__codelineno-67-34" name="__codelineno-67-34" href="#__codelineno-67-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
<a id="__codelineno-67-35" name="__codelineno-67-35" href="#__codelineno-67-35"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-67-36" name="__codelineno-67-36" href="#__codelineno-67-36"></a>
<a id="__codelineno-67-37" name="__codelineno-67-37" href="#__codelineno-67-37"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_old_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-67-38" name="__codelineno-67-38" href="#__codelineno-67-38"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-67-39" name="__codelineno-67-39" href="#__codelineno-67-39"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>  <span class="c1"># Cleanup every 5 minutes</span>
<a id="__codelineno-67-40" name="__codelineno-67-40" href="#__codelineno-67-40"></a>            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-67-41" name="__codelineno-67-41" href="#__codelineno-67-41"></a>            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<a id="__codelineno-67-42" name="__codelineno-67-42" href="#__codelineno-67-42"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-67-43" name="__codelineno-67-43" href="#__codelineno-67-43"></a>                    <span class="n">req_time</span> <span class="k">for</span> <span class="n">req_time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
<a id="__codelineno-67-44" name="__codelineno-67-44" href="#__codelineno-67-44"></a>                    <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">req_time</span> <span class="o">&lt;</span> <span class="mi">3600</span>  <span class="c1"># Keep last hour</span>
<a id="__codelineno-67-45" name="__codelineno-67-45" href="#__codelineno-67-45"></a>                <span class="p">]</span>
<a id="__codelineno-67-46" name="__codelineno-67-46" href="#__codelineno-67-46"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">identifier</span><span class="p">]:</span>
<a id="__codelineno-67-47" name="__codelineno-67-47" href="#__codelineno-67-47"></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
<a id="__codelineno-67-48" name="__codelineno-67-48" href="#__codelineno-67-48"></a>
<a id="__codelineno-67-49" name="__codelineno-67-49" href="#__codelineno-67-49"></a><span class="c1"># Middleware implementation</span>
<a id="__codelineno-67-50" name="__codelineno-67-50" href="#__codelineno-67-50"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rate_limiting_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<a id="__codelineno-67-51" name="__codelineno-67-51" href="#__codelineno-67-51"></a>    <span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">rate_limiter</span>
<a id="__codelineno-67-52" name="__codelineno-67-52" href="#__codelineno-67-52"></a>
<a id="__codelineno-67-53" name="__codelineno-67-53" href="#__codelineno-67-53"></a>    <span class="c1"># Use IP + user ID for identification</span>
<a id="__codelineno-67-54" name="__codelineno-67-54" href="#__codelineno-67-54"></a>    <span class="n">user_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;anonymous&#39;</span><span class="p">)</span>
<a id="__codelineno-67-55" name="__codelineno-67-55" href="#__codelineno-67-55"></a>    <span class="n">identifier</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-67-56" name="__codelineno-67-56" href="#__codelineno-67-56"></a>
<a id="__codelineno-67-57" name="__codelineno-67-57" href="#__codelineno-67-57"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">rate_limiter</span><span class="o">.</span><span class="n">check_rate_limit</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
<a id="__codelineno-67-58" name="__codelineno-67-58" href="#__codelineno-67-58"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
<a id="__codelineno-67-59" name="__codelineno-67-59" href="#__codelineno-67-59"></a>            <span class="n">status_code</span><span class="o">=</span><span class="mi">429</span><span class="p">,</span>
<a id="__codelineno-67-60" name="__codelineno-67-60" href="#__codelineno-67-60"></a>            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Rate limit exceeded&quot;</span>
<a id="__codelineno-67-61" name="__codelineno-67-61" href="#__codelineno-67-61"></a>        <span class="p">)</span>
<a id="__codelineno-67-62" name="__codelineno-67-62" href="#__codelineno-67-62"></a>
<a id="__codelineno-67-63" name="__codelineno-67-63" href="#__codelineno-67-63"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-67-64" name="__codelineno-67-64" href="#__codelineno-67-64"></a>    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>
<h4 id="requestresponse-security"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#requestresponse-security">Request/Response Security</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="c1"># Secure CORS configuration</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>    <span class="n">CORSMiddleware</span><span class="p">,</span>
<a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;https://yourapp.com&quot;</span><span class="p">,</span> <span class="s2">&quot;https://admin.yourapp.com&quot;</span><span class="p">],</span>
<a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">],</span>
<a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;X-Correlation-ID&quot;</span><span class="p">],</span>
<a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>    <span class="n">expose_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X-Correlation-ID&quot;</span><span class="p">]</span>
<a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a><span class="p">)</span>
<a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>
<a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a><span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">security_headers_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a>    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>
<a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>    <span class="c1"># Security headers</span>
<a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Content-Type-Options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nosniff&quot;</span>
<a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Frame-Options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DENY&quot;</span>
<a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-XSS-Protection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1; mode=block&quot;</span>
<a id="__codelineno-68-24" name="__codelineno-68-24" href="#__codelineno-68-24"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Strict-Transport-Security&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;max-age=31536000; includeSubDomains&quot;</span>
<a id="__codelineno-68-25" name="__codelineno-68-25" href="#__codelineno-68-25"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Security-Policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default-src &#39;self&#39;&quot;</span>
<a id="__codelineno-68-26" name="__codelineno-68-26" href="#__codelineno-68-26"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Referrer-Policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;strict-origin-when-cross-origin&quot;</span>
<a id="__codelineno-68-27" name="__codelineno-68-27" href="#__codelineno-68-27"></a>
<a id="__codelineno-68-28" name="__codelineno-68-28" href="#__codelineno-68-28"></a>    <span class="c1"># Remove server information</span>
<a id="__codelineno-68-29" name="__codelineno-68-29" href="#__codelineno-68-29"></a>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;Server&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-68-30" name="__codelineno-68-30" href="#__codelineno-68-30"></a>
<a id="__codelineno-68-31" name="__codelineno-68-31" href="#__codelineno-68-31"></a>    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>
<h3 id="aws-security-integration"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#aws-security-integration">AWS Security Integration</a></h3>
<h4 id="secrets-management"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#secrets-management">Secrets Management</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">boto3</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">AWSSecretsManager</span><span class="p">:</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;us-west-2&quot;</span><span class="p">):</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;secretsmanager&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">)</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_secret_value</span><span class="p">(</span><span class="n">SecretId</span><span class="o">=</span><span class="n">secret_name</span><span class="p">)</span>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a>            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;SecretString&#39;</span><span class="p">])</span>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to retrieve secret </span><span class="si">{</span><span class="n">secret_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_database_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s2">&quot;clean-py/database/credentials&quot;</span><span class="p">)</span>
<a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a>
<a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_jwt_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s2">&quot;clean-py/jwt/keys&quot;</span><span class="p">)</span>
<a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a>
<a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_encryption_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s2">&quot;clean-py/encryption/keys&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="iam-and-resource-based-security"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#iam-and-resource-based-security">IAM and Resource-Based Security</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1"># Environment-specific security configuration</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecurityConfig</span><span class="p">:</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">secrets_manager</span> <span class="o">=</span> <span class="n">AWSSecretsManager</span><span class="p">()</span>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>    <span class="nd">@property</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">jwt_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">secrets_manager</span><span class="o">.</span><span class="n">get_jwt_keys</span><span class="p">()</span>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>            <span class="s2">&quot;private_key&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">[</span><span class="s2">&quot;private_key&quot;</span><span class="p">],</span>
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>            <span class="s2">&quot;public_key&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">[</span><span class="s2">&quot;public_key&quot;</span><span class="p">],</span>
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>            <span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;RS256&quot;</span><span class="p">,</span>
<a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a>            <span class="s2">&quot;access_token_expire_minutes&quot;</span><span class="p">:</span> <span class="mi">15</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span> <span class="k">else</span> <span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a>            <span class="s2">&quot;refresh_token_expire_days&quot;</span><span class="p">:</span> <span class="mi">30</span>
<a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a>        <span class="p">}</span>
<a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a>
<a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a>    <span class="nd">@property</span>
<a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cors_origins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span><span class="p">:</span>
<a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a>            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;https://yourapp.com&quot;</span><span class="p">,</span> <span class="s2">&quot;https://admin.yourapp.com&quot;</span><span class="p">]</span>
<a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="s2">&quot;staging&quot;</span><span class="p">:</span>
<a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a>            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;https://staging.yourapp.com&quot;</span><span class="p">]</span>
<a id="__codelineno-70-24" name="__codelineno-70-24" href="#__codelineno-70-24"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-70-25" name="__codelineno-70-25" href="#__codelineno-70-25"></a>            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;http://localhost:3000&quot;</span><span class="p">,</span> <span class="s2">&quot;http://localhost:8080&quot;</span><span class="p">]</span>
</code></pre></div>
<h3 id="security-monitoring-and-incident-response"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#security-monitoring-and-incident-response">Security Monitoring and Incident Response</a></h3>
<h4 id="audit-logging"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#audit-logging">Audit Logging</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.infrastructure.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecurityEventType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>    <span class="n">LOGIN_SUCCESS</span> <span class="o">=</span> <span class="s2">&quot;login_success&quot;</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>    <span class="n">LOGIN_FAILURE</span> <span class="o">=</span> <span class="s2">&quot;login_failure&quot;</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>    <span class="n">PERMISSION_DENIED</span> <span class="o">=</span> <span class="s2">&quot;permission_denied&quot;</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>    <span class="n">DATA_ACCESS</span> <span class="o">=</span> <span class="s2">&quot;data_access&quot;</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>    <span class="n">DATA_MODIFICATION</span> <span class="o">=</span> <span class="s2">&quot;data_modification&quot;</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>    <span class="n">SUSPICIOUS_ACTIVITY</span> <span class="o">=</span> <span class="s2">&quot;suspicious_activity&quot;</span>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a>
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecurityAuditLogger</span><span class="p">:</span>
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-71-14" name="__codelineno-71-14" href="#__codelineno-71-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;security.audit&quot;</span><span class="p">)</span>
<a id="__codelineno-71-15" name="__codelineno-71-15" href="#__codelineno-71-15"></a>
<a id="__codelineno-71-16" name="__codelineno-71-16" href="#__codelineno-71-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_security_event</span><span class="p">(</span>
<a id="__codelineno-71-17" name="__codelineno-71-17" href="#__codelineno-71-17"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-71-18" name="__codelineno-71-18" href="#__codelineno-71-18"></a>        <span class="n">event_type</span><span class="p">:</span> <span class="n">SecurityEventType</span><span class="p">,</span>
<a id="__codelineno-71-19" name="__codelineno-71-19" href="#__codelineno-71-19"></a>        <span class="n">user_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-71-20" name="__codelineno-71-20" href="#__codelineno-71-20"></a>        <span class="n">resource</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-71-21" name="__codelineno-71-21" href="#__codelineno-71-21"></a>        <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-71-22" name="__codelineno-71-22" href="#__codelineno-71-22"></a>        <span class="n">risk_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;LOW&quot;</span>
<a id="__codelineno-71-23" name="__codelineno-71-23" href="#__codelineno-71-23"></a>    <span class="p">):</span>
<a id="__codelineno-71-24" name="__codelineno-71-24" href="#__codelineno-71-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-71-25" name="__codelineno-71-25" href="#__codelineno-71-25"></a>            <span class="sa">f</span><span class="s2">&quot;Security event: </span><span class="si">{</span><span class="n">event_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-71-26" name="__codelineno-71-26" href="#__codelineno-71-26"></a>            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-71-27" name="__codelineno-71-27" href="#__codelineno-71-27"></a>                <span class="s2">&quot;event_type&quot;</span><span class="p">:</span> <span class="n">event_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-71-28" name="__codelineno-71-28" href="#__codelineno-71-28"></a>                <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-71-29" name="__codelineno-71-29" href="#__codelineno-71-29"></a>                <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="n">resource</span><span class="p">,</span>
<a id="__codelineno-71-30" name="__codelineno-71-30" href="#__codelineno-71-30"></a>                <span class="s2">&quot;risk_level&quot;</span><span class="p">:</span> <span class="n">risk_level</span><span class="p">,</span>
<a id="__codelineno-71-31" name="__codelineno-71-31" href="#__codelineno-71-31"></a>                <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">details</span> <span class="ow">or</span> <span class="p">{},</span>
<a id="__codelineno-71-32" name="__codelineno-71-32" href="#__codelineno-71-32"></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-71-33" name="__codelineno-71-33" href="#__codelineno-71-33"></a>                <span class="s2">&quot;source_ip&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_client_ip</span><span class="p">(),</span>
<a id="__codelineno-71-34" name="__codelineno-71-34" href="#__codelineno-71-34"></a>                <span class="s2">&quot;user_agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_agent</span><span class="p">()</span>
<a id="__codelineno-71-35" name="__codelineno-71-35" href="#__codelineno-71-35"></a>            <span class="p">}</span>
<a id="__codelineno-71-36" name="__codelineno-71-36" href="#__codelineno-71-36"></a>        <span class="p">)</span>
<a id="__codelineno-71-37" name="__codelineno-71-37" href="#__codelineno-71-37"></a>
<a id="__codelineno-71-38" name="__codelineno-71-38" href="#__codelineno-71-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_data_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-71-39" name="__codelineno-71-39" href="#__codelineno-71-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_security_event</span><span class="p">(</span>
<a id="__codelineno-71-40" name="__codelineno-71-40" href="#__codelineno-71-40"></a>            <span class="n">SecurityEventType</span><span class="o">.</span><span class="n">DATA_ACCESS</span><span class="p">,</span>
<a id="__codelineno-71-41" name="__codelineno-71-41" href="#__codelineno-71-41"></a>            <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-71-42" name="__codelineno-71-42" href="#__codelineno-71-42"></a>            <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
<a id="__codelineno-71-43" name="__codelineno-71-43" href="#__codelineno-71-43"></a>            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="n">operation</span><span class="p">},</span>
<a id="__codelineno-71-44" name="__codelineno-71-44" href="#__codelineno-71-44"></a>            <span class="n">risk_level</span><span class="o">=</span><span class="s2">&quot;MEDIUM&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;UPDATE&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;LOW&quot;</span>
<a id="__codelineno-71-45" name="__codelineno-71-45" href="#__codelineno-71-45"></a>        <span class="p">)</span>
</code></pre></div>
<h4 id="anomaly-detection"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#anomaly-detection">Anomaly Detection</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecurityMonitor</span><span class="p">:</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">audit_logger</span> <span class="o">=</span> <span class="n">SecurityAuditLogger</span><span class="p">()</span>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_activity</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">track_user_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">activity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>        <span class="c1"># Track activity patterns</span>
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_activity</span><span class="p">:</span>
<a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">user_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>
<a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>            <span class="s2">&quot;activity&quot;</span><span class="p">:</span> <span class="n">activity</span><span class="p">,</span>
<a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
<a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a>            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span>
<a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a>        <span class="p">})</span>
<a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a>
<a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a>        <span class="c1"># Check for suspicious patterns</span>
<a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_anomalies</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a>
<a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_for_anomalies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a>        <span class="n">recent_activities</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-72-24" name="__codelineno-72-24" href="#__codelineno-72-24"></a>            <span class="n">activity</span> <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_activity</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>
<a id="__codelineno-72-25" name="__codelineno-72-25" href="#__codelineno-72-25"></a>            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">activity</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-72-26" name="__codelineno-72-26" href="#__codelineno-72-26"></a>        <span class="p">]</span>
<a id="__codelineno-72-27" name="__codelineno-72-27" href="#__codelineno-72-27"></a>
<a id="__codelineno-72-28" name="__codelineno-72-28" href="#__codelineno-72-28"></a>        <span class="c1"># Multiple failed logins</span>
<a id="__codelineno-72-29" name="__codelineno-72-29" href="#__codelineno-72-29"></a>        <span class="n">failed_logins</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">recent_activities</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;activity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;login_failure&quot;</span><span class="p">]</span>
<a id="__codelineno-72-30" name="__codelineno-72-30" href="#__codelineno-72-30"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_logins</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
<a id="__codelineno-72-31" name="__codelineno-72-31" href="#__codelineno-72-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">audit_logger</span><span class="o">.</span><span class="n">log_security_event</span><span class="p">(</span>
<a id="__codelineno-72-32" name="__codelineno-72-32" href="#__codelineno-72-32"></a>                <span class="n">SecurityEventType</span><span class="o">.</span><span class="n">SUSPICIOUS_ACTIVITY</span><span class="p">,</span>
<a id="__codelineno-72-33" name="__codelineno-72-33" href="#__codelineno-72-33"></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-72-34" name="__codelineno-72-34" href="#__codelineno-72-34"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;anomaly_type&quot;</span><span class="p">:</span> <span class="s2">&quot;multiple_failed_logins&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_logins</span><span class="p">)},</span>
<a id="__codelineno-72-35" name="__codelineno-72-35" href="#__codelineno-72-35"></a>                <span class="n">risk_level</span><span class="o">=</span><span class="s2">&quot;HIGH&quot;</span>
<a id="__codelineno-72-36" name="__codelineno-72-36" href="#__codelineno-72-36"></a>            <span class="p">)</span>
<a id="__codelineno-72-37" name="__codelineno-72-37" href="#__codelineno-72-37"></a>
<a id="__codelineno-72-38" name="__codelineno-72-38" href="#__codelineno-72-38"></a>        <span class="c1"># Unusual data access patterns</span>
<a id="__codelineno-72-39" name="__codelineno-72-39" href="#__codelineno-72-39"></a>        <span class="n">data_access</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">recent_activities</span> <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;activity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;data_access&quot;</span><span class="p">]</span>
<a id="__codelineno-72-40" name="__codelineno-72-40" href="#__codelineno-72-40"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_access</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># Too many data accesses in 5 minutes</span>
<a id="__codelineno-72-41" name="__codelineno-72-41" href="#__codelineno-72-41"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">audit_logger</span><span class="o">.</span><span class="n">log_security_event</span><span class="p">(</span>
<a id="__codelineno-72-42" name="__codelineno-72-42" href="#__codelineno-72-42"></a>                <span class="n">SecurityEventType</span><span class="o">.</span><span class="n">SUSPICIOUS_ACTIVITY</span><span class="p">,</span>
<a id="__codelineno-72-43" name="__codelineno-72-43" href="#__codelineno-72-43"></a>                <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
<a id="__codelineno-72-44" name="__codelineno-72-44" href="#__codelineno-72-44"></a>                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;anomaly_type&quot;</span><span class="p">:</span> <span class="s2">&quot;excessive_data_access&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_access</span><span class="p">)},</span>
<a id="__codelineno-72-45" name="__codelineno-72-45" href="#__codelineno-72-45"></a>                <span class="n">risk_level</span><span class="o">=</span><span class="s2">&quot;HIGH&quot;</span>
<a id="__codelineno-72-46" name="__codelineno-72-46" href="#__codelineno-72-46"></a>            <span class="p">)</span>
</code></pre></div>
<h3 id="dependency-security"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#dependency-security">Dependency Security</a></h3>
<h4 id="supply-chain-security"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#supply-chain-security">Supply Chain Security</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c1"># security/dependency_scanner.py</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">DependencySecurityScanner</span><span class="p">:</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">scan_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Scan for known vulnerabilities in dependencies&quot;&quot;&quot;</span>
<a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>            <span class="c1"># Use pip-audit or safety</span>
<a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<a id="__codelineno-73-12" name="__codelineno-73-12" href="#__codelineno-73-12"></a>                <span class="p">[</span><span class="s2">&quot;pip-audit&quot;</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">],</span>
<a id="__codelineno-73-13" name="__codelineno-73-13" href="#__codelineno-73-13"></a>                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-73-14" name="__codelineno-73-14" href="#__codelineno-73-14"></a>                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-73-15" name="__codelineno-73-15" href="#__codelineno-73-15"></a>                <span class="n">check</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-73-16" name="__codelineno-73-16" href="#__codelineno-73-16"></a>            <span class="p">)</span>
<a id="__codelineno-73-17" name="__codelineno-73-17" href="#__codelineno-73-17"></a>
<a id="__codelineno-73-18" name="__codelineno-73-18" href="#__codelineno-73-18"></a>            <span class="n">vulnerabilities</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<a id="__codelineno-73-19" name="__codelineno-73-19" href="#__codelineno-73-19"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_vulnerabilities</span><span class="p">(</span><span class="n">vulnerabilities</span><span class="p">)</span>
<a id="__codelineno-73-20" name="__codelineno-73-20" href="#__codelineno-73-20"></a>
<a id="__codelineno-73-21" name="__codelineno-73-21" href="#__codelineno-73-21"></a>        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-73-22" name="__codelineno-73-22" href="#__codelineno-73-22"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Security scan failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-73-23" name="__codelineno-73-23" href="#__codelineno-73-23"></a>            <span class="k">return</span> <span class="p">{}</span>
<a id="__codelineno-73-24" name="__codelineno-73-24" href="#__codelineno-73-24"></a>
<a id="__codelineno-73-25" name="__codelineno-73-25" href="#__codelineno-73-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_vulnerabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vulns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-73-26" name="__codelineno-73-26" href="#__codelineno-73-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process vulnerability data into actionable format&quot;&quot;&quot;</span>
<a id="__codelineno-73-27" name="__codelineno-73-27" href="#__codelineno-73-27"></a>        <span class="n">issues</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-73-28" name="__codelineno-73-28" href="#__codelineno-73-28"></a>        <span class="k">for</span> <span class="n">vuln</span> <span class="ow">in</span> <span class="n">vulns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vulnerabilities&quot;</span><span class="p">,</span> <span class="p">[]):</span>
<a id="__codelineno-73-29" name="__codelineno-73-29" href="#__codelineno-73-29"></a>            <span class="n">package</span> <span class="o">=</span> <span class="n">vuln</span><span class="p">[</span><span class="s2">&quot;package&quot;</span><span class="p">]</span>
<a id="__codelineno-73-30" name="__codelineno-73-30" href="#__codelineno-73-30"></a>            <span class="k">if</span> <span class="n">package</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">issues</span><span class="p">:</span>
<a id="__codelineno-73-31" name="__codelineno-73-31" href="#__codelineno-73-31"></a>                <span class="n">issues</span><span class="p">[</span><span class="n">package</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-73-32" name="__codelineno-73-32" href="#__codelineno-73-32"></a>            <span class="n">issues</span><span class="p">[</span><span class="n">package</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-73-33" name="__codelineno-73-33" href="#__codelineno-73-33"></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">vuln</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
<a id="__codelineno-73-34" name="__codelineno-73-34" href="#__codelineno-73-34"></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">vuln</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
<a id="__codelineno-73-35" name="__codelineno-73-35" href="#__codelineno-73-35"></a>                <span class="s2">&quot;fixed_version&quot;</span><span class="p">:</span> <span class="n">vuln</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fixed_version&quot;</span><span class="p">),</span>
<a id="__codelineno-73-36" name="__codelineno-73-36" href="#__codelineno-73-36"></a>                <span class="s2">&quot;severity&quot;</span><span class="p">:</span> <span class="n">vuln</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;severity&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
<a id="__codelineno-73-37" name="__codelineno-73-37" href="#__codelineno-73-37"></a>            <span class="p">})</span>
<a id="__codelineno-73-38" name="__codelineno-73-38" href="#__codelineno-73-38"></a>        <span class="k">return</span> <span class="n">issues</span>
</code></pre></div>
<h3 id="security-testing-integration"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#security-testing-integration">Security Testing Integration</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># tests/security/test_security_patterns.py</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">src.presentation.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestSecurityPatterns</span><span class="p">:</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_sql_injection_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test SQL injection prevention&quot;&quot;&quot;</span>
<a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-74-10" name="__codelineno-74-10" href="#__codelineno-74-10"></a>
<a id="__codelineno-74-11" name="__codelineno-74-11" href="#__codelineno-74-11"></a>        <span class="c1"># Attempt SQL injection</span>
<a id="__codelineno-74-12" name="__codelineno-74-12" href="#__codelineno-74-12"></a>        <span class="n">malicious_payload</span> <span class="o">=</span> <span class="s2">&quot;&#39;; DROP TABLE users; --&quot;</span>
<a id="__codelineno-74-13" name="__codelineno-74-13" href="#__codelineno-74-13"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-74-14" name="__codelineno-74-14" href="#__codelineno-74-14"></a>            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">malicious_payload</span><span class="p">,</span>
<a id="__codelineno-74-15" name="__codelineno-74-15" href="#__codelineno-74-15"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span>
<a id="__codelineno-74-16" name="__codelineno-74-16" href="#__codelineno-74-16"></a>        <span class="p">})</span>
<a id="__codelineno-74-17" name="__codelineno-74-17" href="#__codelineno-74-17"></a>
<a id="__codelineno-74-18" name="__codelineno-74-18" href="#__codelineno-74-18"></a>        <span class="c1"># Should be rejected by validation</span>
<a id="__codelineno-74-19" name="__codelineno-74-19" href="#__codelineno-74-19"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
<a id="__codelineno-74-20" name="__codelineno-74-20" href="#__codelineno-74-20"></a>
<a id="__codelineno-74-21" name="__codelineno-74-21" href="#__codelineno-74-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_xss_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-74-22" name="__codelineno-74-22" href="#__codelineno-74-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test XSS prevention&quot;&quot;&quot;</span>
<a id="__codelineno-74-23" name="__codelineno-74-23" href="#__codelineno-74-23"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-74-24" name="__codelineno-74-24" href="#__codelineno-74-24"></a>
<a id="__codelineno-74-25" name="__codelineno-74-25" href="#__codelineno-74-25"></a>        <span class="n">malicious_script</span> <span class="o">=</span> <span class="s2">&quot;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&quot;</span>
<a id="__codelineno-74-26" name="__codelineno-74-26" href="#__codelineno-74-26"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-74-27" name="__codelineno-74-27" href="#__codelineno-74-27"></a>            <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="n">malicious_script</span><span class="p">,</span>
<a id="__codelineno-74-28" name="__codelineno-74-28" href="#__codelineno-74-28"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;test@example.com&quot;</span>
<a id="__codelineno-74-29" name="__codelineno-74-29" href="#__codelineno-74-29"></a>        <span class="p">})</span>
<a id="__codelineno-74-30" name="__codelineno-74-30" href="#__codelineno-74-30"></a>
<a id="__codelineno-74-31" name="__codelineno-74-31" href="#__codelineno-74-31"></a>        <span class="c1"># Should sanitize or reject</span>
<a id="__codelineno-74-32" name="__codelineno-74-32" href="#__codelineno-74-32"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-74-33" name="__codelineno-74-33" href="#__codelineno-74-33"></a>            <span class="n">user_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-74-34" name="__codelineno-74-34" href="#__codelineno-74-34"></a>            <span class="k">assert</span> <span class="s2">&quot;&lt;script&gt;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_data</span><span class="p">[</span><span class="s2">&quot;first_name&quot;</span><span class="p">]</span>
<a id="__codelineno-74-35" name="__codelineno-74-35" href="#__codelineno-74-35"></a>
<a id="__codelineno-74-36" name="__codelineno-74-36" href="#__codelineno-74-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_rate_limiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-74-37" name="__codelineno-74-37" href="#__codelineno-74-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test rate limiting functionality&quot;&quot;&quot;</span>
<a id="__codelineno-74-38" name="__codelineno-74-38" href="#__codelineno-74-38"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-74-39" name="__codelineno-74-39" href="#__codelineno-74-39"></a>
<a id="__codelineno-74-40" name="__codelineno-74-40" href="#__codelineno-74-40"></a>        <span class="c1"># Make multiple rapid requests</span>
<a id="__codelineno-74-41" name="__codelineno-74-41" href="#__codelineno-74-41"></a>        <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-74-42" name="__codelineno-74-42" href="#__codelineno-74-42"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">110</span><span class="p">):</span>  <span class="c1"># Exceed rate limit</span>
<a id="__codelineno-74-43" name="__codelineno-74-43" href="#__codelineno-74-43"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/public&quot;</span><span class="p">)</span>
<a id="__codelineno-74-44" name="__codelineno-74-44" href="#__codelineno-74-44"></a>            <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<a id="__codelineno-74-45" name="__codelineno-74-45" href="#__codelineno-74-45"></a>
<a id="__codelineno-74-46" name="__codelineno-74-46" href="#__codelineno-74-46"></a>        <span class="c1"># Should eventually return 429</span>
<a id="__codelineno-74-47" name="__codelineno-74-47" href="#__codelineno-74-47"></a>        <span class="k">assert</span> <span class="mi">429</span> <span class="ow">in</span> <span class="n">responses</span>
<a id="__codelineno-74-48" name="__codelineno-74-48" href="#__codelineno-74-48"></a>
<a id="__codelineno-74-49" name="__codelineno-74-49" href="#__codelineno-74-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_authentication_required</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-74-50" name="__codelineno-74-50" href="#__codelineno-74-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that protected endpoints require authentication&quot;&quot;&quot;</span>
<a id="__codelineno-74-51" name="__codelineno-74-51" href="#__codelineno-74-51"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-74-52" name="__codelineno-74-52" href="#__codelineno-74-52"></a>
<a id="__codelineno-74-53" name="__codelineno-74-53" href="#__codelineno-74-53"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/orders&quot;</span><span class="p">)</span>
<a id="__codelineno-74-54" name="__codelineno-74-54" href="#__codelineno-74-54"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span>
<a id="__codelineno-74-55" name="__codelineno-74-55" href="#__codelineno-74-55"></a>
<a id="__codelineno-74-56" name="__codelineno-74-56" href="#__codelineno-74-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_authorization_enforcement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-74-57" name="__codelineno-74-57" href="#__codelineno-74-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that authorization is properly enforced&quot;&quot;&quot;</span>
<a id="__codelineno-74-58" name="__codelineno-74-58" href="#__codelineno-74-58"></a>        <span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a id="__codelineno-74-59" name="__codelineno-74-59" href="#__codelineno-74-59"></a>
<a id="__codelineno-74-60" name="__codelineno-74-60" href="#__codelineno-74-60"></a>        <span class="c1"># Login as regular user</span>
<a id="__codelineno-74-61" name="__codelineno-74-61" href="#__codelineno-74-61"></a>        <span class="n">login_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/auth/login&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-74-62" name="__codelineno-74-62" href="#__codelineno-74-62"></a>            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-74-63" name="__codelineno-74-63" href="#__codelineno-74-63"></a>            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password123&quot;</span>
<a id="__codelineno-74-64" name="__codelineno-74-64" href="#__codelineno-74-64"></a>        <span class="p">})</span>
<a id="__codelineno-74-65" name="__codelineno-74-65" href="#__codelineno-74-65"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">login_response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
<a id="__codelineno-74-66" name="__codelineno-74-66" href="#__codelineno-74-66"></a>
<a id="__codelineno-74-67" name="__codelineno-74-67" href="#__codelineno-74-67"></a>        <span class="c1"># Try to access admin endpoint</span>
<a id="__codelineno-74-68" name="__codelineno-74-68" href="#__codelineno-74-68"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/admin/users&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-74-69" name="__codelineno-74-69" href="#__codelineno-74-69"></a>            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-74-70" name="__codelineno-74-70" href="#__codelineno-74-70"></a>        <span class="p">})</span>
<a id="__codelineno-74-71" name="__codelineno-74-71" href="#__codelineno-74-71"></a>        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span>
</code></pre></div>
<h3 id="security-checklist-for-production"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#security-checklist-for-production">Security Checklist for Production</a></h3>
<p>Before deploying to production, ensure you've implemented:</p>
<h4 id="application-security"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#application-security">Application Security</a></h4>
<ul>
<li>[ ] Input validation and sanitization on all endpoints</li>
<li>[ ] Parameterized queries for database operations</li>
<li>[ ] JWT token validation with proper expiration</li>
<li>[ ] Role-based authorization on all protected resources</li>
<li>[ ] Rate limiting and request throttling</li>
<li>[ ] Security headers in all responses</li>
<li>[ ] Error handling that doesn't leak sensitive information</li>
</ul>
<h4 id="data-protection"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#data-protection">Data Protection</a></h4>
<ul>
<li>[ ] Encryption at rest for sensitive data</li>
<li>[ ] Field-level encryption for PII</li>
<li>[ ] Secure key management with AWS Secrets Manager</li>
<li>[ ] Data retention and deletion policies</li>
<li>[ ] Audit logging for all data access</li>
</ul>
<h4 id="infrastructure-security"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#infrastructure-security">Infrastructure Security</a></h4>
<ul>
<li>[ ] TLS 1.2+ for all communications</li>
<li>[ ] WAF rules configured for common attacks</li>
<li>[ ] VPC isolation and security groups</li>
<li>[ ] IAM roles with least-privilege access</li>
<li>[ ] Regular security updates and patches</li>
</ul>
<h4 id="monitoring-and-response"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#monitoring-and-response">Monitoring and Response</a></h4>
<ul>
<li>[ ] Security event logging and alerting</li>
<li>[ ] Anomaly detection for user behavior</li>
<li>[ ] Incident response procedures</li>
<li>[ ] Regular security assessments</li>
<li>[ ] Dependency vulnerability scanning</li>
</ul>
<h3 id="conclusion"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#conclusion">Conclusion</a></h3>
<p>Security is not a destination—it's a continuous journey. The clean-py repository provides a solid foundation with defense-in-depth security patterns, but security must be maintained and evolved as your application grows.</p>
<p>The key principles to remember:</p>
<ol>
<li><strong>Security by Design</strong>: Build security into your architecture from day one</li>
<li><strong>Defense in Depth</strong>: Multiple layers of protection, not single points of failure</li>
<li><strong>Least Privilege</strong>: Grant only the minimum access required</li>
<li><strong>Continuous Monitoring</strong>: Watch for threats and respond quickly</li>
<li><strong>Regular Updates</strong>: Keep dependencies and infrastructure current</li>
</ol>
<p>Modern applications face sophisticated threats that go far beyond the OWASP Top 10. By implementing comprehensive security patterns throughout your stack—from input validation to infrastructure hardening—you create a robust defense that can adapt to emerging threats.</p>
<p>The investment in security infrastructure pays dividends when you're not the company in the headlines for a data breach. Start with the patterns in clean-py, adapt them to your specific needs, and build security into your development culture from day one.</p>
<h3 id="references"><a class="toclink" href="../../2025/07/09/securing-python-applications---beyond-owasp/#references">References</a></h3>
<ul>
<li><a href="https://github.com/buildshift-dev/clean-py">Clean-Py Repository</a> - Complete security implementation</li>
<li><a href="https://owasp.org/www-project-top-ten/">OWASP Top 10</a> - Web application security risks</li>
<li><a href="https://www.nist.gov/cybersecurity">NIST Cybersecurity Framework</a> - Comprehensive security guidance</li>
<li><a href="https://docs.aws.amazon.com/security/">AWS Security Best Practices</a> - Cloud security patterns</li>
</ul>
<p>Your users trust you with their data. Honor that trust with security that goes beyond compliance to true protection.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 buildshift.dev
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/buildshift-dev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/in/your-profile" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/your-handle" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:contact@buildshift.dev" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l208 156a48 48 0 0 0 57.6 0l208-156c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 196v188c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V196L313.6 344.8c-34.1 25.6-81.1 25.6-115.2 0z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.path", "navigation.top", "search.highlight", "search.share", "search.suggest", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../../assets/js/buildshift.js"></script>
      
    
  </body>
</html>